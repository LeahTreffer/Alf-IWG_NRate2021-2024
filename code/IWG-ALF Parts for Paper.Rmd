---
title: "IWG-ALF Parts for Paper"
author: "Leah Treffer"
date: "2025-07-18"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# just loading these in, unsure which exactly are still used
```{r}
library(dplyr)
library(tidyr)
library(ggplot2)
library(gridExtra)
library(reshape2)
library(ggthemes)
library(gapminder)
library(multcomp)
library(emmeans)
library(multcompView)
library(lmerTest)
library(scales)
library(tidyverse)
library(readxl)
library(lme4)
library(gvlma)
library(rstatix)
library(sjPlot)
library(gt)
library(car)
library(Rmisc)
library(nlme)
library(pgirmess)
library(MuMIn)
library(sjPlot)
library(grateful)
library(cowplot)
library(kableExtra)
library(MuMIn)
library(ggpmisc)
library(bestNormalize)
```

# making emmeans functions 
```{r}
# Define a 3 WAY function for year 1 summer
compute_emmeansNXS <- function(model_name) {
  N_levels <- c(0, 40, 80, 120, 160)
  # Get the model object using the provided name
  mod <- get(model_name)
  # Compute estimated marginal means
  emm <- emmeans(mod, specs = ~ N*P*CROP, at = list(N = N_levels))
  emm <- update(emm, type = "response")
  # Summarize the results
  summary_emm <- summary(emm)
  # Convert to data frame
  emm_df <- as.data.frame(summary_emm)
  # Add additional columns
  emm_df <- emm_df %>%
    mutate(Year = "1", Harvest = "Summer")
  
  return(emm_df)}

# Define a 3 WAY  function for year 1 fall
compute_emmeansNXF <- function(model_name) {
  N_levels <- c(0, 40, 80, 120, 160)
  # Get the model object using the provided name
  mod <- get(model_name)
  # Compute estimated marginal means
  emm <- emmeans(mod, specs = ~ N*P*CROP, at = list(N = N_levels))
  emm <- update(emm, type = "response")
  # Summarize the results
  summary_emm <- summary(emm)
  # Convert to data frame
  emm_df <- as.data.frame(summary_emm)
  # Add additional columns
  emm_df <- emm_df %>%
    mutate(Year = "1", Harvest = "Fall")
  return(emm_df)}

# Define a 3 WAY  function for year 2 Summer
compute_emmeansNYS <- function(model_name) {
  N_levels <- c(0, 40, 80, 120, 160)
  # Get the model object using the provided name
  mod <- get(model_name)
  # Compute estimated marginal means
  emm <- emmeans(mod, specs = ~ N*P*CROP, at = list(N = N_levels))
  emm <- update(emm, type = "response")
  # Summarize the results
  summary_emm <- summary(emm)
  # Convert to data frame
  emm_df <- as.data.frame(summary_emm)
  # Add additional columns
  emm_df <- emm_df %>%
    mutate(Year = "2", Harvest = "Summer")
  return(emm_df)}

# Define a 3 WAY function for year 2 Fall
compute_emmeansNYF <- function(model_name) {
  N_levels <- c(0, 40, 80, 120, 160)
  # Get the model object using the provided name
  mod <- get(model_name)
  # Compute estimated marginal means
  emm <- emmeans(mod, specs = ~ N*P*CROP, at = list(N = N_levels))
  emm <- update(emm, type = "response")
  # Summarize the results
  summary_emm <- summary(emm)
  # Convert to data frame
  emm_df <- as.data.frame(summary_emm)
  # Add additional columns
  emm_df <- emm_df %>%
    mutate(Year = "2", Harvest = "Fall")
  return(emm_df)}

# Define a 3 WAY function for year 3 summer
compute_emmeansNZS <- function(model_name) {
  N_levels <- c(0, 40, 80, 120, 160)
  # Get the model object using the provided name
  mod <- get(model_name)
  # Compute estimated marginal means
  emm <- emmeans(mod, specs = ~ N*P*CROP, at = list(N = N_levels))
  emm <- update(emm, type = "response")
  # Summarize the results
  summary_emm <- summary(emm)
  # Convert to data frame
  emm_df <- as.data.frame(summary_emm)
  # Add additional columns
  emm_df <- emm_df %>%
    mutate(Year = "3", Harvest = "Summer")
  
  return(emm_df)}

# Define a 3 WAY  function for year 3 fall
compute_emmeansNZF <- function(model_name) {
  N_levels <- c(0, 40, 80, 120, 160)
  # Get the model object using the provided name
  mod <- get(model_name)
  # Compute estimated marginal means
  emm <- emmeans(mod, specs = ~ N*P*CROP, at = list(N = N_levels))
  emm <- update(emm, type = "response")
  # Summarize the results
  summary_emm <- summary(emm)
  # Convert to data frame
  emm_df <- as.data.frame(summary_emm)
  # Add additional columns
  emm_df <- emm_df %>%
    mutate(Year = "3", Harvest = "Fall")
  return(emm_df)}



# Define a NP function for year 1 summer
compute_emmeansNXS2 <- function(model_name) {
  N_levels <- c(0, 40, 80, 120, 160)
  # Get the model object using the provided name
  mod <- get(model_name)
  # Compute estimated marginal means
  emm <- emmeans(mod, specs = ~ N*P, at = list(N = N_levels))
  emm <- update(emm, type = "response")
  # Summarize the results
  summary_emm <- summary(emm)
  # Convert to data frame
  emm_df <- as.data.frame(summary_emm)
  # Add additional columns
  emm_df <- emm_df %>%
    mutate(Year = "1", Harvest = "Summer")
  return(emm_df)}

# Define a NP  function for year 1 fall
compute_emmeansNXF2 <- function(model_name) {
  N_levels <- c(0, 40, 80, 120, 160)
  # Get the model object using the provided name
  mod <- get(model_name)
  # Compute estimated marginal means
  emm <- emmeans(mod, specs = ~ N*P, at = list(N = N_levels))
  emm <- update(emm, type = "response")
  # Summarize the results
  summary_emm <- summary(emm)
  # Convert to data frame
  emm_df <- as.data.frame(summary_emm)
  # Add additional columns
  emm_df <- emm_df %>%
    mutate(Year = "1", Harvest = "Fall")
  return(emm_df)}

# Define a NP  function for year 2 Summer
compute_emmeansNYS2 <- function(model_name) {
  N_levels <- c(0, 40, 80, 120, 160)
  # Get the model object using the provided name
  mod <- get(model_name)
  # Compute estimated marginal means
  emm <- emmeans(mod, specs = ~ N*P, at = list(N = N_levels))
  emm <- update(emm, type = "response")
  # Summarize the results
  summary_emm <- summary(emm)
  # Convert to data frame
  emm_df <- as.data.frame(summary_emm)
  # Add additional columns
  emm_df <- emm_df %>%
    mutate(Year = "2", Harvest = "Summer")
  return(emm_df)}

# Define a NP function for year 2 Fall
compute_emmeansNYF2 <- function(model_name) {
  N_levels <- c(0, 40, 80, 120, 160)
  # Get the model object using the provided name
  mod <- get(model_name)
  # Compute estimated marginal means
  emm <- emmeans(mod, specs = ~ N*P, at = list(N = N_levels))
  emm <- update(emm, type = "response")
  # Summarize the results
  summary_emm <- summary(emm)
  # Convert to data frame
  emm_df <- as.data.frame(summary_emm)
  # Add additional columns
  emm_df <- emm_df %>%
    mutate(Year = "2", Harvest = "Fall")
  return(emm_df)}

# Define a NP function for year 3 summer
compute_emmeansNZS2 <- function(model_name) {
  N_levels <- c(0, 40, 80, 120, 160)
  # Get the model object using the provided name
  mod <- get(model_name)
  # Compute estimated marginal means
  emm <- emmeans(mod, specs = ~ N*P, at = list(N = N_levels))
  emm <- update(emm, type = "response")
  # Summarize the results
  summary_emm <- summary(emm)
  # Convert to data frame
  emm_df <- as.data.frame(summary_emm)
  # Add additional columns
  emm_df <- emm_df %>%
    mutate(Year = "3", Harvest = "Summer")
  return(emm_df)}

# Define a NP  function for year 3 fall
compute_emmeansNZF2 <- function(model_name) {
  N_levels <- c(0, 40, 80, 120, 160)
  # Get the model object using the provided name
  mod <- get(model_name)
  # Compute estimated marginal means
  emm <- emmeans(mod, specs = ~ N*P, at = list(N = N_levels))
  emm <- update(emm, type = "response")
  # Summarize the results
  summary_emm <- summary(emm)
  # Convert to data frame
  emm_df <- as.data.frame(summary_emm)
  # Add additional columns
  emm_df <- emm_df %>%
    mutate(Year = "3", Harvest = "Fall")
  return(emm_df)}
```

### Estimation of Dehulled Grain Yield

The IWG grain threshability visibly varied by site, and not all grains were fully dehulled, so it was deemed necessary to estimate the true mass of dehulled grain in order to prevent poorly threshed plots from being incorrectly represented as higher yielding. To correct for this, 3-gram samples were taken from each plot’s grain yield. These samples were weighed and imaged, and the images were analyzed using the software ilastik, which visually estimated the proportion of grain still in the hull, naked grain, grain still in the spikelet, and empty hulls and spikelets. The resulting proportions were used to create an estimated dehulled grain weight for the sample, which was then extrapolated to derive an adjusted dehulled grain yield for each experimental plot (Altendorf et al., 2021)

Adjusted plot grain yield= (estimated dehulled sample weight/ sample weight)*(plot grain yield weight) 

### Land Equivalent Ratio (LER)

Land Equivalent Ratio (LER) was calculated to compare the performance of intercrops to that of monocultures... Indicates a relative total forage yield advantage for intercropped plots if the TLER is greater than 1(Mead & Willey, 1980). 

Total LER: TLER= LA+LB= YA/SA + YB/SB
where LA and LB are the partial land equivalent ratio (PLER) for the individual crops. YA and YB are the yields of an individual crop within the intercropped plot, and SA and SB are the yields of an individual crop within a monoculture plot (Mead & Willey, 1980). 

Proportional LER (PrLER) was calculated for each species’ biomass yield to determine each species’ relative contribution to the total LER (Oyejola & Mead, 1982). PLERs can be compared to determine competitive effects between the species in intercrop... A PLER greater than 0.5 indicates a relative yield advantage for a single crop in intercrop compared to its yield at the same seeding rate in monoculture. The proportional partial land equivalent ratio (PrPLER) is the proportion of component crop A to the TLER and can be used to understand how much each intercropped crop contributes to the TLER. 

Proportional LER: PrPLER= LA/TLER
where LA is the partial land equivalent ratio (PLER) for an individual crops and TLER is the total land equivalent ratio for an intercropped plot. 


TLER, PLER, and PrLER were calculated using plots of the same N rate to allow for comparison in the performance of the intercropped system at different N rates (Oyejola & Mead, 1982). TLER and PrLER could not be calculated for grain yields, as IWG only represented one grain-bearing crop in the intercrop, but PLER was calculated for grain yield to allow for comparison between N rates

### Effects and interactions of N rate (N), cropping system (CROP), and environment (E)

Log-linear mixed-effects models with replication as a random effect (ϵ) 
log(Response variable) ~ N*E*C + ϵ
Models for each year-harvest ( Year 1 Summer, Year 1 Fall, Year 2 Summer, Year 2 Fall, Year 3 Summer, Year 3 Fall) as Summer and Fall harvests were expected to have large differences in yield, and so that the change in response variables between years could be easily captured and compared.

Response variables: Yields
- Grain yield
- Total forage yield 
- IWG forage yield
- Alfalfa forage yield 
Response variables: LER
- TLER
- PLER of grain 
- PLER of IWG
- PLER of alfalfa 
- PrPLER of IWG 
- PrPLER of alfalfa 
Cropping system (C) was not included as a fixed effect for LER, as LER values are calculated as a ratio of yield in intercropping to yield in monoculture.
Response variables: Forage quality
- Total forage CP and RFV 
- IWG forage CP and RFV
- Alfalfa CP and RFV
Forage quality only on year 1 and year 2 harvests

Analysis of covariance (ANCOVA) was used to determine significant differences (P<0.05) between independent variables and their interactions. Estimated marginal means (EMMs) were calculated and pairwise comparisons were used to understand and rank results between independent variables. 

### Data prep for analysis 

```{r}
data<-read.csv('data/MasterDataSpreadsheet.csv')
```
# Rows to remove due to missing data
NY 208 s22 missing alfalfa 
MN 1122 s23 missing grain 
```{r}
# 2022 Summer NY 208 is the first row in the data table
data <- data[-1, ] # 2022 Summer NY 208
# then the new row 1 becomes the next row needing to be taken out
data <- data[-1, ] # 2023 Summer MN 1122
```
# Rename variables to match models 
```{r}
data2 <- data |> 
  separate_wider_delim(Crop, delim = " + ", 
                       names = c("first_value", "second_value"), 
                       too_few = "align_start") |> 
  mutate(C = if_else(is.na(second_value), "monoculture", "intercrop")) |> 
  mutate(CROP = case_when(
    Intercropped == "y" ~ "Intercropped",  # If intercrop is "y", set CROP to intercrop
    Monocrop == "y" & ALF == "y" ~ "Mono_ALF",  # If monoculture is "y" and alfalfa is "y", set CROP to alfalfa
    Monocrop == "y" & IWG == "y" ~ "Mono_IWG",  # If monoculture is "y" and iwg is "y", set CROP to iwg
    Monocrop == "y" ~ "NA",  # If monoculture is "y" and neither alfalfa nor iwg is "y", set CROP to NA
    TRUE ~ NA_character_  # If no condition matches, assign NA
  ))

V<-data2$first_value #Variety (IWG, Shockwave, Higest, WL)
data2$V<-as.factor(V)
N<-data2$NRate # Nitrogen Rate (0, 40, 80, 120, 160)
data2$N<-as.numeric(N)
P<-data2$Location # Location ("MN", "NY", "WI", "KS")
data2$P<-as.factor(P)
data2$Rep<-as.factor(data2$Rep) # (1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16)
data2$C<-as.factor(data2$C) # Crop (intercrop, monoculture)
data2$CROP <- as.factor(data2$CROP) # Crop (intercrop, monoculture_IWG, monoculture_Alfalfa)
```
# Making things numeric as needed 
```{r}
#data2$G<-as.numeric(data2$G)
data2$PlotIWGDryKgHa<-as.numeric(data2$PlotIWGDryKgHa)
data2$PlotAlfDryKgHa<-as.numeric(data2$PlotAlfDryKgHa)
data2$PlotTotForageKgHa<-as.numeric(data2$PlotTotForageKgHa)
data2$IWGCP<-as.numeric(data2$IWGCP)
data2$IWGdNDF48<-as.numeric(data2$IWGdNDF48)
data2$IWGLignin<-as.numeric(data2$IWGLignin)
data2$ALFCP<-as.numeric(data2$ALFCP)
data2$ALFdNDF48<-as.numeric(data2$ALFdNDF48)
data2$ALFLignin<-as.numeric(data2$ALFLignin)
data2$ALFADF<-as.numeric(data2$ALFADF)
data2$IWGADF<-as.numeric(data2$IWGADF)
data2$ALFaNDF<-as.numeric(data2$ALFaNDF)
custom_letters <- c("a", "b", "c", "d", "e", "f", "g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z")  # Customize the letters as needed
```
# Nrate data isolation
```{r}
#Just shockwave 
Nd<-data2[data2$first_value != "WL" & data2$first_value != "Higest" ,]

Nd <- Nd %>%
  mutate(CROP = case_when(
    `Crop1` == "Shockwave" ~ "monoA",
    `Crop1` == "IWG" ~ "monoI",
    `Crop1` == "Shockwave + IWG" ~ "inter",
    TRUE ~ NA_character_  # Handle other cases if any
  ))

# MN 2024 has some Filler plots which get the NA character, but code later in this script dosn't like it. 
# So removing these here
Nd <- Nd %>%
  filter(!is.na(CROP))
```

```{r}
#Year
NdX<-Nd[Nd$YearCode == "X",]
NdY<-Nd[Nd$YearCode == "Y",]
NdZ<-Nd[Nd$YearCode == "Z",]

#REMOVE this once you get the corrected year 2 grain values in 
NdY$G<-NdY$PlotThreshedGrainKgHa

#Harvest 
NdXS<-NdX[NdX$Harvest == "Summer",]
NdXF<-NdX[NdX$Harvest == "Fall",]

NdYS<-NdY[NdY$Harvest == "Summer",]
NdYF<-NdY[NdY$Harvest == "Fall",]

NdZS<-NdZ[NdZ$Harvest == "Summer",]
NdZF<-NdZ[NdZ$Harvest == "Fall",]

#IWG vs ALF 
NdXSI<-NdXS[NdXS$Crop1 != "Shockwave",]
NdXSA<-NdXS[NdXS$Crop1 != "IWG",]

NdXFI<-NdXF[NdXF$Crop1 != "Shockwave",]
NdXFA<-NdXF[NdXF$Crop1 != "IWG",]

NdYSI<-NdYS[NdYS$Crop1 != "Shockwave" ,]
NdYSA<-NdYS[NdYS$Crop1 != "IWG",]

NdYFI<-NdYF[NdYF$Crop1 != "Shockwave",]
NdYFA<-NdYF[NdYF$Crop1 != "IWG",]

NdZSI<-NdZS[NdZS$Crop1 != "Shockwave" ,]
NdZSA<-NdZS[NdZS$Crop1 != "IWG",]

NdZFI<-NdZF[NdZF$Crop1 != "Shockwave",]
NdZFA<-NdZF[NdZF$Crop1 != "IWG",]
```

### Analysis for the paper

## Grain Yield 

* Table (Grain yield significance of variables and interactions for each model): Grain anovas 

* Figure (Grain yield response to nitrogen rate (N-Rate) and site by harvest) : Grain Figures Redo N:E

* Figure (Grain yield response to cropping system and site by harvest) : combined grain year 1 and 2 plots E:C

# Grain anovas 
```{r}
my_modelsNG <- c(modNXG1, modNYG1, modNYGadj1)
anovasNG <- purrr::map(my_modelsNG, ~anova(.))
names(anovasNG) <- c("Year 1", "Year 2 (unadjusted)",  "Year 2 (adjusted with year 1 data)")


# Function to format p-values as stars
format_p_value <- function(p_val) {
  stars <- ifelse(p_val < 0.001, "***", ifelse(p_val < 0.01, "**", ifelse(p_val < 0.05, "*", "")))
  return(stars)
}

# Apply the function to your ANOVA results
NG_stars_tibble <- map(anovasNG, as_tibble, rownames="term") %>%
  bind_rows(.id = "model") %>%
  mutate(stars = map_chr(`Pr(>F)`, format_p_value))

NG_stars_tibble <- NG_stars_tibble %>%
  mutate(term = ifelse(term == "P", "E", term)) %>%
  mutate(term = ifelse(term == "N:P", "N:E", term))%>%
  mutate(term = ifelse(term == "P:C", "E:C", term))%>%
  mutate(term = ifelse(term == "N:P:C", "N:E:C", term))

# Print the tibble
print(NG_stars_tibble)

NG_stars <-NG_stars_tibble |> 
  select(model, term, stars) |>
  pivot_wider(names_from = term, values_from = stars)

gt_NG <- gt(NG_stars)

gt_NG |> gtsave("gt_NG.png", expand = 10)
```

# grain figures redo N:E
```{r}
#N:E
# Layer all the plots together!
colors <- c("Year 1 Summer Harvest" = "red", 
            "Year 1 Fall Harvest" = "green", 
            "Year 2 Summer Harvest" = "blue", 
            "Year 2 Fall Harvest" = "purple")
legend_order2 <- c("Year 1 Summer Harvest", 
                  "Year 2 Summer Harvest")
# Define the desired order of 'P'
desired_order <- c("MN", "NY", "KS", "WI")
NdXSIG$P <- factor(NdXSIG$P, levels = desired_order)

GraincomboplotNE <- ggplot(data=NdXSIG) +
  geom_point(data = NdXSIG, aes(x = N, y = G, color = "Year 1 Summer Harvest", shape = C)) +
  geom_point(data = DATA32, aes(x = N, y = GAdjY, color = "Year 2 Summer Harvest", shape = C)) +
  labs(x = "N-Rate (Kg ha-1)", y = "Grain Yield", linetype = "Cropping System", shape = "Cropping System", color = "Harvest")+
  scale_x_continuous(breaks = c(0, 40, 80, 120, 160)) +
  ylim(0, 1550) +
  facet_wrap(~P, scales = "free_y", ncol = 2) +
  scale_shape_manual(values = c(4, 25),labels = c("Intercropped","Monoculture IWG"))+
    scale_color_manual(values = colors, limits = legend_order2)+
  geom_function(data=subset(NdXSIG, P== "MN"), fun=~179.38*exp(0.0021*.x),color='red')+
  geom_function(data=subset(NdXSIG, P== "NY"), fun=~408.24*exp(0.0047*.x),color='red')+
  geom_function(data=subset(NdXSIG, P== "KS"), fun=~407.18*exp(-0.0002*.x),color='red')+
  geom_function(data=subset(NdXSIG, P== "WI"), fun=~736.77*exp(-0.0001*.x),color='red')+
  geom_function(data=subset(DATA32, P== "NY"), fun=~222.27*exp(0.0009*.x),color='blue')+
  geom_function(data=subset(DATA32, P== "KS"), fun=~99.20*exp(0.0005*.x),color='blue')+
  geom_function(data=subset(DATA32, P== "WI"), fun=~278.01*exp(0.0065*.x),color='blue')
print(GraincomboplotNE)

ggsave("GraincomboplotNE.jpg", plot = GraincomboplotNE, width = 8, height = 6, dpi = 300)


```

# grain figure E:C (X)
```{r}

NXGemmsPC <- emmeans(modNXG1, ~ P*C, type = "response") # Obtain estimated marginal means (excluding N)
emms_df <- as.data.frame(NXGemmsPC)
cld_dataNXGPC <- cld(NXGemmsPC, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataNXGPC)
merged_df <- merge(emms_df, cld_df,by = c("P", "C"))
custom_labels <- c("Intercrop", "Monoculture IWG")
custom_colors <- c("darkmagenta", "cyan") 
GXPC<-ggplot(NdXSIG, aes(x = P, y = exp(predicted), color = C)) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7) +
  labs(x = "Environment", y = "Grain Yield") +
  geom_point(data = emms_df, aes(x = P, y = response), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 1.8)+
  scale_color_manual(name = "Cropping System", labels = custom_labels,values = custom_colors)+
    guides(color = "none")+
     ggtitle("Year 1")+
  theme(plot.title = element_text(hjust = 0.5))
print(GXPC)
ggsave("GXPC.jpg", plot = GXPC, width = 8, height = 6, dpi = 300)
```

# grain figure E:C (Y)
```{r}

NYGemmsPC <- emmeans(modNYGadj1, ~ P*C, type = "response") # Obtain estimated marginal means (excluding N)
emms_df <- as.data.frame(NYGemmsPC)
cld_dataNYGPC <- cld(NYGemmsPC, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataNYGPC)
merged_df <- merge(emms_df, cld_df,by = c("P", "C"))
custom_labels <- c("Intercrop", "Monoculture IWG")
custom_colors <- c("darkmagenta", "cyan") 
GYPC<-ggplot(DATA32, aes(x = P, y = exp(predicted), color = C)) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7) +
  labs(x = "Environment", y = "Grain Yield") +
  geom_point(data = emms_df, aes(x = P, y = response), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 3)+
  scale_color_manual(name = "Cropping System", labels = custom_labels,values = custom_colors)+
     ggtitle("Year 2")+
  theme(plot.title = element_text(hjust = 0.5))+
    scale_y_continuous(breaks = c(250, 500, 750, 1000, 1250), limits = c(0, 1260))


print(GYPC)
ggsave("GYPC.jpg", plot = GYPC, width = 8, height = 6, dpi = 300)
```

# combined grain year 1 and 2 plots E:C
# Probably need to add in yr 3 ! 
```{r}
GEC<-grid.arrange(GXPC, GYPC, ncol = 2)
ggsave("GEC.jpg", plot = GEC, width =12, height = 6, dpi = 350)
```

## Total Forage Yield 

* Table (Estimated effect of nitrogen rate on total forage yield for each environment (Site) and cropping system across harvests) : combine the "sorted_df" that is created at the end of the chunk for each forage model

* Figure (Total forage yield response to environment and cropping system for Year 2 Fall) : total forage figure E:C (YF)

# Total forage year 1 summer
```{r}
#linear
modNXST<-lmer(PlotTotForageKgHa~N*P*CROP + (1|Rep), data=NdXS)
anova(modNXST)
#Check Assumptions
NXST_resid<-resid(modNXST)
qqnorm(NXST_resid)
qqline(NXST_resid)
plot(modNXST)
#Logtransform
modNXST1<-lmer(log(PlotTotForageKgHa)~N*P*CROP + (1|Rep), data=NdXS)
anova(modNXST1)
summary(modNXST1)
#check assumptions logtransform
NXST_resid1<-resid(modNXST1)
qqnorm(NXST_resid1)
qqline(NXST_resid1)
plot(modNXST1)


modNXST1_summary <- summary(modNXST1)
modNXST1_coeff <- as.data.frame(modNXST1_summary$coefficients)%>%
  filter(`Pr(>|t|)` < 0.05)
colnames(modNXST1_coeff)[5]<-"Pr(>t)"
# Create custom table using kable and kableExtra
save_kable(
   knitr::kable(modNXST1_coeff, 
                caption = "Y1 Summer Mixed-Effects Model: log(PlotTotForageKgHa) ~ Nrate * Location * CROPsystem + (1 | Rep)") %>%
       kable_styling(full_width = TRUE, 
                     position = "center", 
                     bootstrap_options = c("striped", "hover", "condensed")),
   file = "figures/table_significant_coeff_yr1S.html")

desired_order_P <- c("MN", "NY", "KS", "WI")
N_levels <- c(0, 40, 80, 120, 160)

#plot log-linear by location (log)
NdXS$predicted <- predict(modNXST1, newdata = NdXS, re.form = NA)
ggplot(NdXS, aes(x = N, y = PlotTotForageKgHa , color = CROP, group = CROP)) +
    geom_point() + 
  geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Grain Yield (log scale)") +
  ggtitle("Yr 1 S Relationship between Total Forage Yield and Nrate") +
  scale_x_continuous(breaks = c(0, 40, 80, 120, 160)) +
  ylim(0,15000)+
  facet_wrap(~P, scales = "free_y", ncol = 2) +
  scale_color_discrete(name = "Cropping System")
# save figures/total_forage_Nrate_yr1S.jpeg

#Three way means
NXST1emm <- compute_emmeansNXS("modNXST1")
#write.csv(NXST1emm, 'data/NXST1emm.csv')

#Pairwise N:P:C
emmsNPC <- emmeans(modNXST1, ~ N*P*CROP,at= list(N = N_levels), type= "response") 
cld_dataNXSTNPC <- cld(emmsNPC, Letters=custom_letters) # Create compact letter display
cld_dataNXSTNPC$response <- format(cld_dataNXSTNPC$response, digits = 5)
rownames(cld_dataNXSTNPC) <- NULL
cld_dataNXSTNPC<- cld_dataNXSTNPC %>%
  select(N, P, CROP, response, .group)
colnames(cld_dataNXSTNPC) <- c("N", "Site", "Cropping System", "Total Forage (kg ha-1)", "Group")
cld_dataNXSTNPC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

#This gives us the slope for each interactions as well as a P value indicating significance level for that slope
emtrends(modNXST1,~ P*CROP, var= "N", infer=TRUE)
  summary(modNXST1)
emtrends(modNXST1,~ P, var= "N", infer=TRUE)
emtrends(modNXST1,~ CROP, var= "N", infer=TRUE)

#emmeans for intercepts! via erika
emtrends_result<-emtrends(modNXST1,~ P*CROP, var= "N", infer=TRUE)
emtrends_df <- as.data.frame(emtrends_result)
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
emmeans_results<-emmeans(modNXST1, ~P*CROP, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
merged_df <- emtrends_df %>%
  inner_join(emmeans_df, by = c("P", "CROP")) %>%
  select(P, CROP, emmean, N.trend, SE.x)
#view(merged_df)
merged_df$P <- factor(merged_df$P, levels = c("MN", "NY", "KS", "WI"))  # Preferred order for P
merged_df$CROP <- factor(merged_df$CROP, levels = c("inter", "monoI","monoA"))  # Preferred order for CROP
# Create a new data frame with the calculated column
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
sorted_df <- new_df %>%
  arrange(P, CROP)
#View(sorted_df)
#write.csv(sorted_df, "data/Nrate_esteff_total_forage_yr1S.csv")
```

# Total forage year 1 fall 
```{r}
#linear
NdXF$PlotTotForageKgHa<-as.numeric(NdXF$PlotTotForageKgHa)
modNXFT<-lmer(PlotTotForageKgHa~N*P*CROP + (1|Rep), data=NdXF)
anova(modNXFT)
summary(modNXFT)
#Check Assumptions
NXFT_resid<-resid(modNXFT)
qqnorm(NXFT_resid)
qqline(NXFT_resid)
plot(modNXFT)
#Check Assumptions Linear logtrans
modNXFT1<-lmer(log(PlotTotForageKgHa)~N*P*CROP + (1|Rep), data=NdXF)
anova(modNXFT1)
NXFT1_resid<-resid(modNXFT1)
qqnorm(NXFT1_resid)
qqline(NXFT1_resid)
plot(modNXFT1)

modNXFT1_summary <- summary(modNXFT1)
modNXFT1_coeff <- as.data.frame(modNXFT1_summary$coefficients)%>%
  filter(`Pr(>|t|)` < 0.05)
colnames(modNXFT1_coeff)[5]<-"Pr(>t)"
 #Create custom table using kable and kableExtra
save_kable(
   knitr::kable(modNXFT1_coeff, 
                caption = "Y1 Fall Mixed-Effects Model: log(PlotTotForageKgHa) ~ Nrate * Location * CROPsystem + (1 | Rep)") %>%
       kable_styling(full_width = TRUE, 
                     position = "center", 
                     bootstrap_options = c("striped", "hover", "condensed")),
   file = "figures/table_significant_coeff_yr1F.html")
# save table_significant_coeff_yr1F

#plots
NdXF$predicted <- predict(modNXFT1, newdata = NdXF, re.form = NA)
ggplot(NdXF, aes(x = N, y = PlotTotForageKgHa, color = CROP, group= CROP)) +
    geom_point() + 
  geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Total Forage Yield (Kg/ha)") +  # Label the axes
  ggtitle("Yr 1 F Relationship between Total Forage Yield and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(0, 3300) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors
# save total_forage_Nrate_yr1F.jpeg

#Threeway means
NXFT1emm <- compute_emmeansNXF("modNXFT1")
#write.csv(NXFT1emm, 'data/NXFT1emm.csv')

#Pairwise N:P:C
emmsNPC <- emmeans(modNXFT1, ~ N*P*CROP,at= list(N = N_levels), type= "response") 
cld_dataNXFTNPC <- cld(emmsNPC, Letters=custom_letters) # Create compact letter display
cld_dataNXFTNPC$response <- format(cld_dataNXFTNPC$response, digits = 5)
rownames(cld_dataNXFTNPC) <- NULL
cld_dataNXFTNPC<- cld_dataNXFTNPC %>%
  select(N, P, CROP, response, .group)
colnames(cld_dataNXFTNPC) <- c("N", "Site", "Cropping System", "Total Forage (kg ha-1)", "Group")
cld_dataNXFTNPC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

#This gives us the slope for each interactions as well as a P value indicating significance level for that slope
emtrends_result<-emtrends(modNXFT1,~ P*CROP, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  desired_order_P <- c("MN", "NY", "KS", "WI")
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
  #view(emtrends_df)
emtrends(modNXFT1,~ P, var= "N", infer=TRUE)
emtrends(modNXFT1,~ CROP, var= "N", infer=TRUE)

#equations table
emtrends_result<-emtrends(modNXFT1,~ P*CROP, var= "N", infer=TRUE)
emtrends_df <- as.data.frame(emtrends_result)
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
emmeans_results<-emmeans(modNXFT1, ~P*CROP, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
merged_df <- emtrends_df %>%
  inner_join(emmeans_df, by = c("P", "CROP")) %>%
  select(P, CROP, emmean, N.trend, SE.x)
#view(merged_df)
merged_df$P <- factor(merged_df$P, levels = c("MN", "NY", "KS", "WI"))  # Preferred order for P
merged_df$CROP <- factor(merged_df$CROP, levels = c("inter", "monoI","monoA"))  # Preferred order for CROP
# Create a new data frame with the calculated column
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
sorted_df <- new_df %>%
  arrange(P, CROP)
#View(sorted_df)
#write.csv(sorted_df, "data/Nrate_esteff_total_forage_yr1F.csv")
```

# Total forage year 2 summer
```{r}
#linear
modNYST<-lmer(PlotTotForageKgHa~N*P*CROP + (1|Rep), data=NdYS)
anova(modNYST)
#Check Assumptions
NYST_resid<-resid(modNYST)
qqnorm(NYST_resid)
qqline(NYST_resid)
plot(modNYST)
#Logtransform
modNYST1<-lmer(log(PlotTotForageKgHa+0.0001)~N*P*CROP + (1|Rep), data=NdYS)
anova(modNYST1)
summary(modNYST1)
#check assumptions logtransform
NYST_resid1<-resid(modNYST1)
qqnorm(NYST_resid1)
qqline(NYST_resid1)
plot(modNYST1)
# normal looks better than log transformed 

modNYST_summary <- summary(modNYST)
modNYST_coeff <- as.data.frame(modNYST_summary$coefficients)%>%
  filter(`Pr(>|t|)` < 0.05)
colnames(modNYST_coeff)[5]<-"Pr(>t)"
# Create custom table using kable and kableExtra
save_kable(
   knitr::kable(modNYST_coeff, 
                caption = "Y2 Summer Mixed-Effects Model: log(PlotTotForageKgHa) ~ Nrate * Location * CROPsystem + (1 | Rep)") %>%
       kable_styling(full_width = TRUE, 
                     position = "center", 
                     bootstrap_options = c("striped", "hover", "condensed")),
   file = "figures/table_significant_coeff_yr2S.html")
# save table_significant_coeff_yr2S


max(NdYS$PlotTotForageKgHa)
#linear plots
NdYS$predicted <- predict(modNYST1, newdata = NdYS, re.form = NA)
ggplot(NdYS, aes(x = N, y = PlotTotForageKgHa, color = CROP, group= CROP)) +
  geom_point() +
  geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Total Forage Yield (Kg/ha)") +  # Label the axes
  ggtitle("Yr 2 S Relationship between Total Forage Yield and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(0, 9000) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors
# save total_forage_Nrate_yr2S.jpeg

#Threeway means
NYST1emm <- compute_emmeansNYS("modNYST1")
#write.csv(NYST1emm, 'data/NYST1emm.csv')

#Pairwise N:P:C
emmsNPC <- emmeans(modNYST1, ~ N*P*CROP,at= list(N = N_levels), type= "response") 
cld_dataNYSTNPC <- cld(emmsNPC, Letters=custom_letters) # Create compact letter display
cld_dataNYSTNPC$response <- format(cld_dataNYSTNPC$response, digits = 5)
rownames(cld_dataNYSTNPC) <- NULL
cld_dataNYSTNPC<- cld_dataNYSTNPC %>%
  select(N, P, CROP, response, .group)
colnames(cld_dataNYSTNPC) <- c("N", "Site", "Cropping System", "Total Forage (kg ha-1)", "Group")
cld_dataNYSTNPC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)


#This gives us the slope for each interactions as well as a P value indicating significance level for that slope
emtrends_result<-emtrends(modNYST1,~ P*CROP, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  desired_order_P <- c("MN", "NY", "KS", "WI")
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
  #view(emtrends_df)
emtrends(modNYST1,~ P, var= "N", infer=TRUE)
emtrends(modNYST1,~ CROP, var= "N", infer=TRUE)

#equations table
emtrends_result<-emtrends(modNYST1,~ P*CROP, var= "N", infer=TRUE)
emtrends_df <- as.data.frame(emtrends_result)
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
emmeans_results<-emmeans(modNYST1, ~P*CROP, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
merged_df <- emtrends_df %>%
  inner_join(emmeans_df, by = c("P", "CROP")) %>%
  select(P, CROP, emmean, N.trend, SE.x)
#view(merged_df)
merged_df$P <- factor(merged_df$P, levels = c("MN", "NY", "KS", "WI"))  # Preferred order for P
merged_df$CROP <- factor(merged_df$CROP, levels = c("inter", "monoI","monoA"))  # Preferred order for CROP
# Create a new data frame with the calculated column
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
sorted_df <- new_df %>%
  arrange(P, CROP)
#View(sorted_df)
#write.csv(sorted_df, "data/Nrate_esteff_total_forage_yr2S.csv")
```

# Total forage year 2 fall
```{r}
#linear
NdYF$PlotTotForageKgHa<-as.numeric(NdYF$PlotTotForageKgHa)
NdYF$N<-as.numeric(NdYF$N)
modNYFT<-lmer(PlotTotForageKgHa~N*P*CROP + (1|Rep), data=NdYF) #linear 
anova(modNYFT)
summary(modNYFT)
#Check Assumptions
NYFT_resid<-resid(modNYFT)
qqnorm(NYFT_resid)
qqline(NYFT_resid)
plot(modNYFT)
abline(h = 0, col="red")
#Logtransform
modNYFT1<-lmer(log(PlotTotForageKgHa)~N*P*CROP + (1|Rep), data=NdYF)
NYFT_resid1<-resid(modNYFT1)
qqnorm(NYFT_resid1)
qqline(NYFT_resid1)
plot(modNYFT1)
anova(modNYFT1)

modNYFT1_summary <- summary(modNYFT1)
modNYFT1_coeff <- as.data.frame(modNYFT1_summary$coefficients)%>%
  filter(`Pr(>|t|)` < 0.05)
colnames(modNYFT1_coeff)[5]<-"Pr(>t)"
# Create custom table using kable and kableExtra
save_kable(
   knitr::kable(modNYFT1_coeff, 
                caption = "Y2 Fall Mixed-Effects Model: log(PlotTotForageKgHa) ~ Nrate * Location * CROPsystem + (1 | Rep)") %>%
       kable_styling(full_width = TRUE, 
                     position = "center", 
                     bootstrap_options = c("striped", "hover", "condensed")),
   file = "figures/table_significant_coeff_yr2F.html")
# save table_significant_coeff_yr2F

#linear plots
NdYF$predicted <- predict(modNYFT1, newdata = NdYF, re.form = NA)
ggplot(NdYF, aes(x = N, y = PlotTotForageKgHa, color = CROP, group= CROP)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Total Forage Yield (Kg/ha)") +  # Label the axes
  ggtitle("Yr 2 F Relationship between Total Forage Yield and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(0, 3500) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors
# save total_forage_Nrate_yr2F.jpeg

#Threeway means
NYFT1emm <- compute_emmeansNYF("modNYFT1")
#write.csv(NYFT1emm, 'data/NYFT1emm.csv')

#Pairwise NPC
N_levels <- c(0, 40, 80, 120, 160)
emmsNPC <- emmeans(modNYFT1, specs = ~ N*P*CROP, at = list(N = N_levels), type = "response") # Obtain estimated marginal means (excluding N)
cld_dataNYFTNPC <- cld(emmsNPC, Letters=custom_letters )
#Pairwise C
emmsC <- emmeans(modNYFT1, ~ CROP, type = "response") # Obtain estimated marginal means (excluding N)
cld_dataNYFTC <- cld(emmsC, Letters=custom_letters) # Create compact letter display
cld_dataNYFTC$response <- format(cld_dataNYFTC$response, digits = 5)
cld_dataNYFTC<- cld_dataNYFTC %>%
  select(CROP, response, .group)
rownames(cld_dataNYFTC) <- NULL
colnames(cld_dataNYFTC) <- c("Cropping System", "Total Forage (kg ha-1)", "Group")
cld_dataNYFTC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise N:C
N_levels <- c(0, 40, 80, 120, 160)
emmsNYFT <- emmeans(modNYFT1, specs = ~ N*CROP, at = list(N = N_levels), type = "response")
cld_dataNYFTNC <- cld(emmsNYFT, Letters=custom_letters) # Create compact letter display
cld_dataNYFTNC$response <- format(cld_dataNYFTNC$response, digits = 5)
cld_dataNYFTNC<- cld_dataNYFTNC %>%
  select(N, CROP, response, .group)
rownames(cld_dataNYFTNC) <- NULL
colnames(cld_dataNYFTNC) <- c("N", "Cropping System", "Total Forage (kg ha-1)", "Group")
cld_dataNYFTNC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise P:C
emmsNYFTPC <- emmeans(modNYFT1, specs = ~ P*CROP, type = "response")
cld_dataNYFTPC <- cld(emmsNYFTPC, Letters=custom_letters) # Create compact letter display
cld_dataNYFTPC$response <- format(cld_dataNYFTPC$response, digits = 5)
cld_dataNYFTPC<- cld_dataNYFTPC %>%
  select(P, CROP, response, .group)
rownames(cld_dataNYFTPC) <- NULL
colnames(cld_dataNYFTPC) <- c("Location", "Cropping System", "Total Forage (kg ha-1)", "Group")
cld_dataNYFTPC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)


#This gives us the slope for each interactions as well as a P value indicating significance level for that slope
emtrends(modNYFT1,~ P*CROP, var= "N", infer=TRUE)
emtrends(modNYFT1,~ P, var= "N", infer=TRUE)
emtrends(modNYFT1,~ CROP, var= "N", infer=TRUE)

#equations table
emtrends_result<-emtrends(modNYFT1,~ CROP, var= "N", infer=TRUE)
emtrends_df <- as.data.frame(emtrends_result)
emmeans_results<-emmeans(modNYFT1, ~CROP, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
merged_df <- emtrends_df %>%
  inner_join(emmeans_df, by = c( "CROP")) %>%
  select(CROP, emmean, N.trend, SE.x)
#view(merged_df)
merged_df$CROP <- factor(merged_df$CROP, levels = c("inter", "monoI","monoA"))  # Preferred order for CROP
# Create a new data frame with the calculated column
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
sorted_df <- new_df %>%
  arrange( CROP)
#view(sorted_df)
#write.csv(sorted_df, "data/Nrate_esteff_total_forage_yr2F.csv")
```

# Total forage year 3 summer
```{r}
NdZS_2 <- NdZS[NdZS$PlotTotForageKgHa != 0, ] # remove rows where the total forage was 0

#linear
modNZST<-lmer(PlotTotForageKgHa~N*P*CROP + (1|Rep), data=NdZS_2)
anova(modNZST)
#Check Assumptions
NZST_resid<-resid(modNZST)
qqnorm(NZST_resid)
qqline(NZST_resid)
plot(modNZST)
#Logtransform
modNZST1<-lmer(log(PlotTotForageKgHa)~N*P*CROP + (1|Rep), data=NdZS_2) 
anova(modNZST1)
summary(modNZST1)
#check assumptions logtransform
NZST_resid1<-resid(modNZST1)
qqnorm(NZST_resid1)
qqline(NZST_resid1)
plot(modNZST1)

modNZST1_summary <- summary(modNZST1)
modNZST1_coeff <- as.data.frame(modNZST1_summary$coefficients)%>%
  filter(`Pr(>|t|)` < 0.05)
colnames(modNZST1_coeff)[5]<-"Pr(>t)"
# Create custom table using kable and kableExtra
save_kable(
   knitr::kable(modNZST1_coeff, 
                caption = "Y3 Summer Mixed-Effects Model: log(PlotTotForageKgHa) ~ Nrate * Location * CROPsystem + (1 | Rep)") %>%
       kable_styling(full_width = TRUE, 
                     position = "center", 
                     bootstrap_options = c("striped", "hover", "condensed")),
   file = "figures/table_significant_coeff_yr3S.html")
# save table_significant_coeff_yr3S

#linear plots
NdZS_2$predicted <- predict(modNZST1, newdata = NdZS_2, re.form = NA)
ggplot(NdZS_2, aes(x = N, y = PlotTotForageKgHa, color = CROP, group= CROP)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Total Forage Yield (Kg/ha)") +  # Label the axes
  ggtitle("Yr 3 S Relationship between Total Forage Yield and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(0, 3500) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors
# save total_forage_Nrate_yr2F.jpeg

#Threeway means
#NYST1emm <- compute_emmeansNYS("modNYST1")

#Pairwise N:P:C
emmsNPC <- emmeans(modNZST1, ~ N*P*CROP,at= list(N = N_levels), type= "response") 
cld_dataNZSTNPC <- cld(emmsNPC, Letters=custom_letters) # Create compact letter display
cld_dataNZSTNPC$response <- format(cld_dataNZSTNPC$response, digits = 5)
rownames(cld_dataNZSTNPC) <- NULL
cld_dataNZSTNPC<- cld_dataNZSTNPC %>%
  select(N, P, CROP, response, .group)
colnames(cld_dataNZSTNPC) <- c("N", "Site", "Cropping System", "Total Forage (kg ha-1)", "Group")
cld_dataNZSTNPC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)


#This gives us the slope for each interactions as well as a P value indicating significance level for that slope
emtrends_result<-emtrends(modNZST1,~ P*CROP, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  desired_order_P <- c("MN", "NY", "KS", "WI")
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
  #view(emtrends_df)
emtrends(modNZST1,~ P, var= "N", infer=TRUE)
emtrends(modNZST1,~ CROP, var= "N", infer=TRUE)

#equations table
emtrends_result<-emtrends(modNZST1,~ P*CROP, var= "N", infer=TRUE)
emtrends_df <- as.data.frame(emtrends_result)
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
emmeans_results<-emmeans(modNZST1, ~P*CROP, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
merged_df <- emtrends_df %>%
  inner_join(emmeans_df, by = c("P", "CROP")) %>%
  select(P, CROP, emmean, N.trend, SE.x)
#view(merged_df)
merged_df$P <- factor(merged_df$P, levels = c("MN", "NY", "KS", "WI"))  # Preferred order for P
merged_df$CROP <- factor(merged_df$CROP, levels = c("inter", "monoI","monoA"))  # Preferred order for CROP
# Create a new data frame with the calculated column
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
sorted_df <- new_df %>%
  arrange(P, CROP)
#view(sorted_df)
```


# Total forage year 3 fall
```{r}
NdZF_2 <- NdZF[NdZF$PlotTotForageKgHa != 0, ] # remove rows where the total forage was 0

#linear
NdZF_2$PlotTotForageKgHa<-as.numeric(NdZF_2$PlotTotForageKgHa)
NdZF_2$N<-as.numeric(NdZF_2$N)
#modNZFT<-lmer(PlotTotForageKgHa~N*P*CROP + (1|Rep), data=NdZF_2) #linear 
# Error: boundary (singular) fit: see help('isSingular')
modNZFT<-lmer(PlotTotForageKgHa~N*P*CROP + (1|P:Rep), data=NdZF_2) #linear 
anova(modNYFT)
summary(modNZFT)
#Check Assumptions
NZFT_resid<-resid(modNZFT)
qqnorm(NZFT_resid)
qqline(NZFT_resid)
plot(modNZFT)
abline(h = 0, col="red")
#Logtransform
#modNZFT1<-lmer(log(PlotTotForageKgHa)~N*P*CROP + (1|Rep), data=NdZF_2)
# boundary (singular) fit: see help('isSingular')
modNZFT1<-lmer(log(PlotTotForageKgHa)~N*P*CROP + (1|P:Rep), data=NdZF_2)
NZFT_resid1<-resid(modNZFT1)
qqnorm(NZFT_resid1)
qqline(NZFT_resid1)
plot(modNZFT1)
anova(modNZFT1)


#modNZFT1_summary <- summary(modNZFT1)
#modNZFT1_coeff <- as.data.frame(modNZFT1_summary$coefficients)%>%
#  filter(`Pr(>|t|)` < 0.05)
#rownames(modNYFT1_coeff)[2]<-"monoA"
#rownames(modNYFT1_coeff)[3]<-"monoI"
#rownames(modNYFT1_coeff)[4]<-"WI:monoI"
#colnames(modNYFT1_coeff)[5]<-"Pr(>t)"
# Create custom table using kable and kableExtra
#knitr::kable(modNYFT1_coeff, caption = "Fall 2024 Mixed-Effects Model: PlotTotForageKgHa ~ Nrate * Location * #CROPsystem + (1 | Rep)") %>%
#  kable_styling(full_width = TRUE, position = "center", bootstrap_options = c("striped", "hover", "condensed"))

#linear plots
NdZF_2$predicted <- predict(modNZFT1, newdata = NdZF_2, re.form = NA)
ggplot(NdZF_2, aes(x = N, y = PlotTotForageKgHa, color = CROP, group= CROP)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Total Forage Yield (Kg/ha)") +  # Label the axes
  ggtitle("Yr 3 F Relationship between Total Forage Yield and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(0, 3500) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors

#Threeway means
#NYFT1emm <- compute_emmeansNYF("modNYFT1")

#Pairwise NPC
N_levels <- c(0, 40, 80, 120, 160)
emmsNPC <- emmeans(modNYFT1, specs = ~ N*P*CROP, at = list(N = N_levels), type = "response") # Obtain estimated marginal means (excluding N)
cld_dataNYFTNPC <- cld(emmsNPC, Letters=custom_letters )
#Pairwise C
emmsC <- emmeans(modNYFT1, ~ CROP, type = "response") # Obtain estimated marginal means (excluding N)
cld_dataNYFTC <- cld(emmsC, Letters=custom_letters) # Create compact letter display
cld_dataNYFTC$response <- format(cld_dataNYFTC$response, digits = 5)
cld_dataNYFTC<- cld_dataNYFTC %>%
  select(CROP, response, .group)
rownames(cld_dataNYFTC) <- NULL
colnames(cld_dataNYFTC) <- c("Cropping System", "Total Forage (kg ha-1)", "Group")
cld_dataNYFTC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise N:C
N_levels <- c(0, 40, 80, 120, 160)
emmsNYFT <- emmeans(modNYFT1, specs = ~ N*CROP, at = list(N = N_levels), type = "response")
cld_dataNYFTNC <- cld(emmsNYFT, Letters=custom_letters) # Create compact letter display
cld_dataNYFTNC$response <- format(cld_dataNYFTNC$response, digits = 5)
cld_dataNYFTNC<- cld_dataNYFTNC %>%
  select(N, CROP, response, .group)
rownames(cld_dataNYFTNC) <- NULL
colnames(cld_dataNYFTNC) <- c("N", "Cropping System", "Total Forage (kg ha-1)", "Group")
cld_dataNYFTNC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise P:C
emmsNYFTPC <- emmeans(modNYFT1, specs = ~ P*CROP, type = "response")
cld_dataNYFTPC <- cld(emmsNYFTPC, Letters=custom_letters) # Create compact letter display
cld_dataNYFTPC$response <- format(cld_dataNYFTPC$response, digits = 5)
cld_dataNYFTPC<- cld_dataNYFTPC %>%
  select(P, CROP, response, .group)
rownames(cld_dataNYFTPC) <- NULL
colnames(cld_dataNYFTPC) <- c("Location", "Cropping System", "Total Forage (kg ha-1)", "Group")
cld_dataNYFTPC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)


#This gives us the slope for each interactions as well as a P value indicating significance level for that slope
emtrends(modNYFT1,~ P*CROP, var= "N", infer=TRUE)
emtrends(modNYFT1,~ P, var= "N", infer=TRUE)
emtrends(modNYFT1,~ CROP, var= "N", infer=TRUE)

#equations table
emtrends_result<-emtrends(modNYFT1,~ CROP, var= "N", infer=TRUE)
emtrends_df <- as.data.frame(emtrends_result)
emmeans_results<-emmeans(modNYFT1, ~CROP, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
merged_df <- emtrends_df %>%
  inner_join(emmeans_df, by = c( "CROP")) %>%
  select(CROP, emmean, N.trend, SE.x)
#view(merged_df)
merged_df$CROP <- factor(merged_df$CROP, levels = c("inter", "monoI","monoA"))  # Preferred order for CROP
# Create a new data frame with the calculated column
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
sorted_df <- new_df %>%
  arrange( CROP)
#view(sorted_df)
```

# total forage figure E:C (YF)
```{r}
max(NdYF$predicted)
exp(7.828112)
YFTFemmsPC <- emmeans(modNYFT1, ~ P*CROP, type = "response") # Obtain estimated marginal means (excluding N)
emms_df <- as.data.frame(YFTFemmsPC)
cld_dataYFTFPC <- cld(YFTFemmsPC, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataYFTFPC)
merged_df <- merge(emms_df, cld_df,by = c("P", "CROP"))
custom_labels <- c("Intercrop", "Monoculture Alfalfa","Monoculture IWG")
custom_colors <- c("darkmagenta","coral1", "cyan") 
TFYFPC<-ggplot(NdYF, aes(x = P, y = exp(predicted), color = CROP)) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7) +
  labs(x = "Environment", y = "Total Forage Yield") +
  geom_point(data = emms_df, aes(x = P, y = response), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 2.5)+
  scale_color_manual(name = "Cropping System", labels = custom_labels,values = custom_colors)+
  theme(plot.title = element_text(hjust = 0.5))

print(TFYFPC)
ggsave("TFYFPC.jpg", plot = TFYFPC, width = 8, height = 6, dpi = 300)
```

## IWG Forage Yield 



