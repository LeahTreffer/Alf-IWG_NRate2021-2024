---
title: "IWG-ALF Data Analysis COPY"
output: pdf_document
date: "2023-08-09"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

rm(list = ls(all.names = TRUE))

***REMOVE AND REPLACE***

```{r}
#data<-read.csv('MasterDataSpreadsheet  - All locations All years combined.csv')
data<-read.csv('MasterDataSpreadsheet.csv')
```

#just loading these in, unsure if I need to again but might as well
```{r}
library(dplyr)
library(tidyr)
library(ggplot2)
library(gridExtra)
library(reshape2)
library(ggthemes)
library(gapminder)
library(multcomp)
library(emmeans)
library(multcompView)
library(lmerTest)
library(scales)
library(tidyverse)
library(readxl)
library(lme4)
library(gvlma)
library(rstatix)
library(sjPlot)
library(gt)
library(car)
library(Rmisc)
library(nlme)
library(pgirmess)
library(MuMIn)
library(sjPlot)
library(grateful)
library(cowplot)
library(kableExtra)
library(MuMIn)
library(ggpmisc)
```

#Rows to remove due to missing data
NY 208 s22 missing alfalfa 
MN 1122 s23 missing grain 
```{r}
# 2022 Summer NY 208 is the first row in the data table
data <- data[-1, ] # 2022 Summer NY 208
# then the new row 1 becomes the next row needing to be taken out
data <- data[-1, ] # 2023 Summer MN 1122
```

#rename variables to match models 
```{r}
data2 <- data |> 
  separate_wider_delim(Crop, delim = " + ", 
                       names = c("first_value", "second_value"), 
                       too_few = "align_start") |> 
  mutate(C = if_else(is.na(second_value), "monoculture", "intercrop")) |> 
  mutate(CROP = case_when(
    Intercropped == "y" ~ "Intercropped",  # If intercrop is "y", set CROP to intercrop
    Monocrop == "y" & ALF == "y" ~ "Mono_ALF",  # If monoculture is "y" and alfalfa is "y", set CROP to alfalfa
    Monocrop == "y" & IWG == "y" ~ "Mono_IWG",  # If monoculture is "y" and iwg is "y", set CROP to iwg
    Monocrop == "y" ~ "NA",  # If monoculture is "y" and neither alfalfa nor iwg is "y", set CROP to NA
    TRUE ~ NA_character_  # If no condition matches, assign NA
  ))

V<-data2$first_value #Variety (IWG, Shockwave, Higest, WL)
data2$V<-as.factor(V)
N<-data2$NRate # Nitrogen Rate (0, 40, 80, 120, 160)
data2$N<-as.numeric(N)
P<-data2$Location # Location ("MN", "NY", "WI", "KS")
data2$P<-as.factor(P)
data2$Rep<-as.factor(data2$Rep) # (1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16)
data2$C<-as.factor(data2$C) # Crop (intercrop, monoculture)
data2$CROP <- as.factor(data2$CROP) # Crop (intercrop, monoculture_IWG, monoculture_Alfalfa)
```

****
Grain conversion work 



#Grain data conversion NEED TO CHECK that 2023 doesn't have any NaN values!!!

options: 
1) don't do any conversion on grain data, just use raw grain data from all years (or just year 3) ; MN yr 2 is our yr 3 though so this would be messy
2) assuming that same proportion of grain:chaff is occuring in yr 3, we could use the same correction on yr 3 raw; would need the average conversion rate for the plot in yr 1 and 2 to be able to run on yr 3
  - average of yr 1 and 2 converstion to converted weight, then use that converstion factor to calculate yr 3 
  - average of yr 1 and 2 converstion for each proportion, find conversation factor, then apply to year 3 to get those 'predicted' proportions, then run Lee's equation to get a predicted converted weight
  
try both of these and show Ginny

```{r}
#need to calculate the fractions 
# data points from imaging giving proportionss
# for yr 1 and 2 there are columns with plot individual info for this
#hull fraction 
data2$hullNHd<-data2$hull_N/(data2$hull_N+data2$nkd_N+data2$spklt_N)
#naked seed fraction 
data2$NdkNHd<-data2$nkd_N/(data2$hull_N+data2$nkd_N+data2$spklt_N)
#spiklet fraction 
data2$SpkltNHd <- ifelse(data2$spklt_N == 0, 0, data2$spklt_N / (data2$hull_N + data2$nkd_N + data2$spklt_N))

#IGNORE (Lee's equation)
# converted grain wieght using proportion information and his calibration values
#then can just plug and chug into this equation 
#data2$YldHdDH <- (1.26975580047546E-03) + (0.897057684933234 * data2$image_sample_wt_g) - ((1.07961789616701E-05) * data2$hullNHd * data2$hull_A) + ((4.61501772182347E-06) * data2$NdkNHd * data2$nkd_A) - ((2.00025159218368E-05) * ifelse(is.nan(data2$SpkltNHd), 0, data2$SpkltNHd) * ifelse(is.nan(data2$spklt_A), 0, data2$spklt_A))

#new equation from Lee
# converted grain wieghts 
data2$WhSamDH = (0.905045351733363*data2$image_sample_wt_g)-((1.10627799960595E-05)*data2$hullNHd*data2$hull_A)+((4.10249606987368E-06)*data2$NdkNHd*data2$nkd_A)-((2.01262650442053E-05)* ifelse(is.nan(data2$SpkltNHd), 0, data2$SpkltNHd) * ifelse(is.nan(data2$spklt_A), 0, data2$spklt_A)) 


#fix below to create the right proportion and save it  
#samples sent for imaging were a subset, so have to apply the converstion factor to the subsample, need to calculate up to the whole plot samples
data2$G<-((data2$WhSamDH)/(data2$image_sample_wt_g))*(data2$PlotThreshedGrainKgHa)

#apply the adjustment above to the year 2 grain data
data2$GXAdj<-((data2$WhSamDH)/(data2$image_sample_wt_g))
data2GXAdj<-data2[data2$YearCode == "X",]
data2GXAdj<-data2GXAdj[data2GXAdj$Harvest == "Summer",]
data2GXAdj<-data2GXAdj[data2GXAdj$P != "MN",]
data2Y<-data2[data2$YearCode=="Y",]
data2Y<-data2Y[data2Y$Harvest == "Summer",]
DATA<-data2GXAdj%>%select(GXAdj, P, Plot, N, C)
DATA2<-left_join(data2GXAdj%>%select(-GXAdj),DATA)
DATA3<-left_join(data2Y%>%select(-GXAdj),DATA)
#data2Y <- merge(data2Y, data2GXAdj$GXAdj, by = c("Location", "Plot"), all.x = TRUE)
DATA3$GAdjY<-(DATA3$GXAdj)*(DATA3$PlotThreshedGrainKgHa)
```

Matching 2024 grain to 2022 and 2023 grain
  - average of yr 1 and 2 converstion to converted weight, then use that converstion factor to calculate yr 3 
  - average of yr 1 and 2 converstion for each proportion, find conversation factor, then apply to year 3 to get those 'predicted' proportions, then run Lee's equation to get a predicted converted weight
  
```{r}
# Leah's practice code 
library(data.table)
# make an unique identifier for each plot (Location_Plot)
# Fast way: average WhSamDH
# Granular way: hull_N, nkd_N, spklt_N, nkd_N, image_sample_wt_g, hull_A, nkd_A, spklt_A

d <- tibble(
  Location = c("MN", "MN", "MN", "MN", "MN", "MN", "MN", "MN", "MN", "NY", "NY", "NY", "NY", "NY", "NY"),
  Plot = c("1", "2", "3", "1", "2", "3", "1", "2", "3", "1", "2", "3", "1", "2", "3"),
  Year = c("2022", "2022", "2022", "2023", "2023", "2023", "2024", "2024", "2024", "2023", "2023", "2023", "2024", "2024", "2024"),
  rawG = c("5", "10", "1", "3", "14", "2", "", "", "", "3", "6", "2", "", "", ""),
  WhSamDH = c("0.3", "0.7", "0.04", "", "", "", "", "", "", "0.2", "0.4", "0.3", "", "", ""),
  hull_N = c("0.2", "0.5", "0.02", "0.22", "0.7", "0.3", "", "", "", "0.1", "0.4", "0.07", "", "", ""),
  nope = c("10", "14", "4", "9", "11", "3", "", "", "", "6", "3", "9", "", "", ""),
  hull_A = c("0.25", "0.55", "0.025", "0.27", "0.57", "0.027", "", "", "", "0.1", "0.8", "0.69", "", "", ""),
  real_sample_wt_g = c("0.25", "0.55", "0.025", "0.27", "0.57", "0.027", "0.8", "0.2", "0.4", "0.1", "0.8", "0.69", "0.6", "0.15", "0.9"))
d$ID <- paste0(d$Location, "_", d$Plot)
# Convert the columns that need averaging into numeric
d <- d %>%
  mutate(
    rawG = as.numeric(rawG),
    WhSamDH = as.numeric(WhSamDH),
    hull_N = as.numeric(hull_N),
    nope = as.numeric(nope),
    hull_A = as.numeric(hull_A),
    real_sample_wt_g = as.numeric(real_sample_wt_g)
  )

# now loop through to group plots, average, and fill missing values with the mean of the other observations of the same plot

updated_data_list <- list()

for (id in unique(d$ID)) {
  group_data <- d %>% filter(ID == id)
  
  mean_rawG <- mean(group_data$rawG, na.rm = TRUE)
  mean_WhSamDH <- mean(group_data$WhSamDH, na.rm = TRUE)
  mean_hull_N <- mean(group_data$hull_N, na.rm = TRUE)
  mean_nope <- mean(group_data$nope, na.rm = TRUE)
  mean_hull_A <- mean(group_data$hull_A, na.rm = TRUE)

  # Fill missing values in column 'A' with the calculated mean
  group_data$rawG[is.na(group_data$rawG)] <- mean_rawG
  group_data$WhSamDH[is.na(group_data$WhSamDH)] <- mean_WhSamDH
  group_data$hull_N[is.na(group_data$hull_N)] <- mean_hull_N
  group_data$nope[is.na(group_data$nope)] <- mean_nope
  group_data$hull_A[is.na(group_data$hull_A)] <- mean_hull_A
  
  # build new table
  updated_data_list[[length(updated_data_list) + 1]] <- group_data

}
final_data <- bind_rows(updated_data_list)

# instead of filling with the mean, get the conversion factor between real_sample_wt_g and the ratios
# testing using 
conversion_factors <- d[,c(1:3,9,10)]  # table
condensed_df <- conversion_factors %>%
  group_by(ID) %>%
  summarise(
    ID = first(ID) ) # unique IDs


trait_list <- colnames(d[,c(4:8)])
for (trait in trait_list){
  # initial vecotor to store quotients for each ID
  column <- numeric(nrow(condensed_df))
  
  for(i in 1:nrow(condensed_df)){
    id = as.character(condensed_df[i,"ID"])
    group_data <- d %>% filter(ID == id)
    
    mt = mean(group_data[[trait]], na.rm = TRUE)
    ms = mean(group_data$real_sample_wt_g, na.rm = TRUE)
    
    # add conversion to id's row
    column[i] <- ms / mt
  }    
    # add column to table
    col_name <- (paste("conversion", trait, sep = "_"))
    condensed_df[[col_name]] <- column
}




```

#converstion table for real

```{r}
# converstion table for real
data2$ID <- paste0(data2$Location, "_", data2$Plot)

conversion_factors <- data2[,c('Year', 'YearCode', 'Location', 'Plot', 'ID', 'QThreshedGrainDryG')]  # table
condensed_df <- conversion_factors %>%
  group_by(ID) %>%
  dplyr::summarise(ID = first(ID)) # unique IDs

trait_list <- colnames(data2[,c('hull_N', 'nkd_N', 'spklt_N', 'image_sample_wt_g', 'hull_A', 'nkd_A', 'spklt_A', 'WhSamDH')])
for (trait in trait_list){
  # initial vecotor to store quotients for each ID
  column <- numeric(nrow(condensed_df))
  
  for(i in 1:nrow(condensed_df)){
    id = as.character(condensed_df[i,"ID"])
    group_data <- data2 %>% filter(ID == id)
    
    mt = mean(as.numeric(group_data[[trait]]), na.rm = TRUE)
    ms = mean(as.numeric(group_data$QThreshedGrainDryG), na.rm = TRUE)
    
    # Check if mt (mean of trait) is NA, if so assign NA to the result for this ID
    if (is.na(mt)) {
      column[i] <- NA
    } else {
      column[i] <- ms / mt
    }
  }    
    # add column to table
    col_name <- (paste("conversion", trait, sep = "_"))
    condensed_df[[col_name]] <- column
}

# works? need to make sure the values make sense
# is QThreshedGrainDryG the right column to use? 
```

Long way 
```{r}
data2$ID <- paste0(data2$Location, "_", data2$Plot)

updated_data_list <- list()

for (id in unique(data2$ID)) {
  group_data <- data2 %>% filter(ID == id) #, Harvest == "Summer", IWG == "y")
  
  mean_hull_N <- mean(group_data$hull_N, na.rm = TRUE)
  mean_nkd_N <- mean(group_data$nkd_N, na.rm = TRUE)
  mean_spklt_N <- mean(group_data$spklt_N, na.rm = TRUE)
  mean_image_sample_wt_g <- mean(group_data$image_sample_wt_g, na.rm = TRUE)
  mean_hull_A <- mean(group_data$hull_A, na.rm = TRUE)
  mean_nkd_A <- mean(group_data$nkd_A, na.rm = TRUE)
  mean_spklt_A <- mean(group_data$spklt_A, na.rm = TRUE)

  # Fill missing values in column 'A' with the calculated mean
  group_data$hull_N[is.na(group_data$hull_N)] <- mean_hull_N
  group_data$nkd_N[is.na(group_data$nkd_N)] <- mean_nkd_N
  group_data$spklt_N[is.na(group_data$spklt_N)] <- mean_spklt_N
  group_data$image_sample_wt_g[is.na(group_data$image_sample_wt_g)] <- mean_image_sample_wt_g
  group_data$hull_A[is.na(group_data$hull_A)] <- mean_hull_A
  group_data$nkd_A[is.na(group_data$nkd_A)] <- mean_nkd_A
  group_data$spklt_A[is.na(group_data$spklt_A)] <- mean_spklt_A

  # build new table
  updated_data_list[[length(updated_data_list) + 1]] <- group_data

}
final_data <- bind_rows(updated_data_list)

#need to calculate the fractions 
#hull fraction 
final_data$hullNHd<-final_data$hull_N/(final_data$hull_N+final_data$nkd_N+final_data$spklt_N)
#naked seed fraction 
final_data$NdkNHd<-final_data$nkd_N/(final_data$hull_N+final_data$nkd_N+final_data$spklt_N)
#spiklet fraction 
final_data$SpkltNHd <- ifelse(final_data$spklt_N == 0, 0, final_data$spklt_N / (final_data$hull_N + final_data$nkd_N + final_data$spklt_N))

#new equation from Lee
# converted grain wieghts 
final_data$WhSamDH = (0.905045351733363*final_data$image_sample_wt_g)-((1.10627799960595E-05)*final_data$hullNHd*final_data$hull_A)+((4.10249606987368E-06)*final_data$NdkNHd*final_data$nkd_A)-((2.01262650442053E-05)* ifelse(is.nan(final_data$SpkltNHd), 0, final_data$SpkltNHd) * ifelse(is.nan(final_data$spklt_A), 0, final_data$spklt_A)) 


#fix below to create the right proportion and save it  
#samples sent for imaging were a subset, so have to apply the converstion factor to the subsample, need to calculate up to the whole plot samples
final_data$G<-((final_data$WhSamDH)/(final_data$image_sample_wt_g))*(final_data$PlotThreshedGrainKgHa)

```

Short way 
```{r}

updated_data_list2 <- list()

for (id in unique(data2$ID)) {
  group_data <- data2 %>% filter(ID == id)
  
  mean_WhSamDH <- mean(group_data$WhSamDH, na.rm = TRUE)
  
  # Fill missing values in column 'A' with the calculated mean
  group_data$WhSamDH[is.na(group_data$WhSamDH)] <- mean_WhSamDH
  
  # build new table
  updated_data_list2[[length(updated_data_list2) + 1]] <- group_data

}
final_data2 <- bind_rows(updated_data_list2)

#fix below to create the right proportion and save it  
#samples sent for imaging were a subset, so have to apply the converstion factor to the subsample, need to calculate up to the whole plot samples
final_data$G<-((final_data$WhSamDH)/(final_data$image_sample_wt_g))*(final_data$PlotThreshedGrainKgHa)

```


****
#HERE
#Making things numeric as needed 
```{r}
data2$G<-as.numeric(data2$G)
data2$PlotIWGDryKgHa<-as.numeric(data2$PlotIWGDryKgHa)
data2$PlotAlfDryKgHa<-as.numeric(data2$PlotAlfDryKgHa)
data2$PlotTotForageKgHa<-as.numeric(data2$PlotTotForageKgHa)
data2$IWGCP<-as.numeric(data2$IWGCP)
data2$IWGdNDF48<-as.numeric(data2$IWGdNDF48)
data2$IWGLignin<-as.numeric(data2$IWGLignin)
data2$ALFCP<-as.numeric(data2$ALFCP)
data2$ALFdNDF48<-as.numeric(data2$ALFdNDF48)
data2$ALFLignin<-as.numeric(data2$ALFLignin)
data2$ALFADF<-as.numeric(data2$ALFADF)
data2$IWGADF<-as.numeric(data2$IWGADF)
data2$ALFaNDF<-as.numeric(data2$ALFaNDF)
custom_letters <- c("a", "b", "c", "d", "e", "f", "g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z")  # Customize the letters as needed



```

#Nrate data isolation
```{r}

#Just shockwave 
Nd<-data2[data2$first_value != "WL" & data2$first_value != "Higest" ,]

Nd <- Nd %>%
  mutate(CROP = case_when(
    `Crop1` == "Shockwave" ~ "monoA",
    `Crop1` == "IWG" ~ "monoI",
    `Crop1` == "Shockwave + IWG" ~ "inter",
    TRUE ~ NA_character_  # Handle other cases if any
  ))

# MN 2024 has some Filler plots which get the NA character, but code later in this script dosn't like it. 
# So removing these here
Nd <- Nd %>%
  filter(!is.na(CROP))
```


```{r}
#Year
NdX<-Nd[Nd$YearCode == "X",]
NdY<-Nd[Nd$YearCode == "Y",]
NdZ<-Nd[Nd$YearCode == "Z",]

#REMOVE this once you get the corrected year 2 grain values in 
NdY$G<-NdY$PlotThreshedGrainKgHa

#Harvest 
NdXS<-NdX[NdX$Harvest == "Summer",]
NdXF<-NdX[NdX$Harvest == "Fall",]

NdYS<-NdY[NdY$Harvest == "Summer",]
NdYF<-NdY[NdY$Harvest == "Fall",]

NdZS<-NdZ[NdZ$Harvest == "Summer",]
NdZF<-NdZ[NdZ$Harvest == "Fall",]

#IWG vs ALF 
NdXSI<-NdXS[NdXS$Crop1 != "Shockwave",]
NdXSA<-NdXS[NdXS$Crop1 != "IWG",]

NdXFI<-NdXF[NdXF$Crop1 != "Shockwave",]
NdXFA<-NdXF[NdXF$Crop1 != "IWG",]

NdYSI<-NdYS[NdYS$Crop1 != "Shockwave" ,]
NdYSA<-NdYS[NdYS$Crop1 != "IWG",]

NdYFI<-NdYF[NdYF$Crop1 != "Shockwave",]
NdYFA<-NdYF[NdYF$Crop1 != "IWG",]

NdZSI<-NdZS[NdZS$Crop1 != "Shockwave" ,]
NdZSA<-NdZS[NdZS$Crop1 != "IWG",]

NdZFI<-NdZF[NdZF$Crop1 != "Shockwave",]
NdZFA<-NdZF[NdZF$Crop1 != "IWG",]

```

#Variety data isolation: for checking V*N interaction (variety x N rate)
```{r}
#just 0 and 80 Nrate
Vd1<-data2[data2$NRate != "40" & data2$NRate != "120" & data2$NRate != "160",]

#remove monoculture plots
Vd<-Vd1[Vd1$C == "intercrop",]

#Year isolation
VdX<-Vd[Vd$YearCode == "X",]
VdY<-Vd[Vd$YearCode == "Y",]
VdZ<-Vd[Vd$YearCode == "Z",]

#REMOVE this once you get the corrected year 2 grain values in 
VdY$G<-VdY$PlotThreshedGrainKgHa

#Harvest isolation
VdXS<-VdX[VdX$Harvest == "Summer",]
VdXF<-VdX[VdX$Harvest == "Fall",]

VdYS<-VdY[VdY$Harvest == "Summer",]
VdYF<-VdY[VdY$Harvest == "Fall",]

VdZS<-VdZ[VdZ$Harvest == "Summer",]
VdZF<-VdZ[VdZ$Harvest == "Fall",]

#IWG vs ALF isolation
VdXSI<-VdXS[VdXS$Crop1 != "Shockwave" & VdXS$Crop1 != "WL" & VdXS$Crop1 != "Higest" ,] 
VdXSA<-VdXS[VdXS$Crop1 != "IWG",]

VdXFI<-VdXF[VdXF$Crop1 != "Shockwave" & VdXF$Crop1 != "WL" & VdXF$Crop1 != "Higest" ,]
VdXFA<-VdXF[VdXF$Crop1 != "IWG",]

VdYSI<-VdYS[VdYS$Crop1 != "Shockwave" & VdYS$Crop1 != "WL" & VdYS$Crop1 != "Higest" ,]
VdYSA<-VdYS[VdYS$Crop1 != "IWG",]

VdYFI<-VdYF[VdYF$Crop1 != "Shockwave" & VdYF$Crop1 != "WL" & VdYF$Crop1 != "Higest" ,]
VdYFA<-VdYF[VdYF$Crop1 != "IWG",]

VdZSI<-VdZS[VdZS$Crop1 != "Shockwave" & VdZS$Crop1 != "WL" & VdZS$Crop1 != "Higest" ,]
VdZSA<-VdZS[VdZS$Crop1 != "IWG",]

VdZFI<-VdZF[VdZF$Crop1 != "Shockwave" & VdZF$Crop1 != "WL" & VdZF$Crop1 != "Higest" ,]
VdZFA<-VdZF[VdZF$Crop1 != "IWG",]
```


*******

Nrate paper

#making emmeans functions 
```{r}
# Define a 3 WAY function for year 1 summer
compute_emmeansNXS <- function(model_name) {
  N_levels <- c(0, 40, 80, 120, 160)
  # Get the model object using the provided name
  mod <- get(model_name)
  # Compute estimated marginal means
  emm <- emmeans(mod, specs = ~ N*P*CROP, at = list(N = N_levels))
  emm <- update(emm, type = "response")
  # Summarize the results
  summary_emm <- summary(emm)
  # Convert to data frame
  emm_df <- as.data.frame(summary_emm)
  # Add additional columns
  emm_df <- emm_df %>%
    mutate(Year = "1", Harvest = "Summer")
  
  return(emm_df)}

# Define a 3 WAY  function for year 1 fall
compute_emmeansNXF <- function(model_name) {
  N_levels <- c(0, 40, 80, 120, 160)
  # Get the model object using the provided name
  mod <- get(model_name)
  # Compute estimated marginal means
  emm <- emmeans(mod, specs = ~ N*P*CROP, at = list(N = N_levels))
  emm <- update(emm, type = "response")
  # Summarize the results
  summary_emm <- summary(emm)
  # Convert to data frame
  emm_df <- as.data.frame(summary_emm)
  # Add additional columns
  emm_df <- emm_df %>%
    mutate(Year = "1", Harvest = "Fall")
  return(emm_df)}

# Define a 3 WAY  function for year 2 Summer
compute_emmeansNYS <- function(model_name) {
  N_levels <- c(0, 40, 80, 120, 160)
  # Get the model object using the provided name
  mod <- get(model_name)
  # Compute estimated marginal means
  emm <- emmeans(mod, specs = ~ N*P*CROP, at = list(N = N_levels))
  emm <- update(emm, type = "response")
  # Summarize the results
  summary_emm <- summary(emm)
  # Convert to data frame
  emm_df <- as.data.frame(summary_emm)
  # Add additional columns
  emm_df <- emm_df %>%
    mutate(Year = "2", Harvest = "Summer")
  return(emm_df)}

# Define a 3 WAY function for year 2 Fall
compute_emmeansNYF <- function(model_name) {
  N_levels <- c(0, 40, 80, 120, 160)
  # Get the model object using the provided name
  mod <- get(model_name)
  # Compute estimated marginal means
  emm <- emmeans(mod, specs = ~ N*P*CROP, at = list(N = N_levels))
  emm <- update(emm, type = "response")
  # Summarize the results
  summary_emm <- summary(emm)
  # Convert to data frame
  emm_df <- as.data.frame(summary_emm)
  # Add additional columns
  emm_df <- emm_df %>%
    mutate(Year = "2", Harvest = "Fall")
  return(emm_df)}

# Define a 3 WAY function for year 3 summer
compute_emmeansNZS <- function(model_name) {
  N_levels <- c(0, 40, 80, 120, 160)
  # Get the model object using the provided name
  mod <- get(model_name)
  # Compute estimated marginal means
  emm <- emmeans(mod, specs = ~ N*P*CROP, at = list(N = N_levels))
  emm <- update(emm, type = "response")
  # Summarize the results
  summary_emm <- summary(emm)
  # Convert to data frame
  emm_df <- as.data.frame(summary_emm)
  # Add additional columns
  emm_df <- emm_df %>%
    mutate(Year = "3", Harvest = "Summer")
  
  return(emm_df)}

# Define a 3 WAY  function for year 3 fall
compute_emmeansNZF <- function(model_name) {
  N_levels <- c(0, 40, 80, 120, 160)
  # Get the model object using the provided name
  mod <- get(model_name)
  # Compute estimated marginal means
  emm <- emmeans(mod, specs = ~ N*P*CROP, at = list(N = N_levels))
  emm <- update(emm, type = "response")
  # Summarize the results
  summary_emm <- summary(emm)
  # Convert to data frame
  emm_df <- as.data.frame(summary_emm)
  # Add additional columns
  emm_df <- emm_df %>%
    mutate(Year = "3", Harvest = "Fall")
  return(emm_df)}



# Define a NP function for year 1 summer
compute_emmeansNXS2 <- function(model_name) {
  N_levels <- c(0, 40, 80, 120, 160)
  # Get the model object using the provided name
  mod <- get(model_name)
  # Compute estimated marginal means
  emm <- emmeans(mod, specs = ~ N*P, at = list(N = N_levels))
  emm <- update(emm, type = "response")
  # Summarize the results
  summary_emm <- summary(emm)
  # Convert to data frame
  emm_df <- as.data.frame(summary_emm)
  # Add additional columns
  emm_df <- emm_df %>%
    mutate(Year = "1", Harvest = "Summer")
  return(emm_df)}

# Define a NP  function for year 1 fall
compute_emmeansNXF2 <- function(model_name) {
  N_levels <- c(0, 40, 80, 120, 160)
  # Get the model object using the provided name
  mod <- get(model_name)
  # Compute estimated marginal means
  emm <- emmeans(mod, specs = ~ N*P, at = list(N = N_levels))
  emm <- update(emm, type = "response")
  # Summarize the results
  summary_emm <- summary(emm)
  # Convert to data frame
  emm_df <- as.data.frame(summary_emm)
  # Add additional columns
  emm_df <- emm_df %>%
    mutate(Year = "1", Harvest = "Fall")
  return(emm_df)}

# Define a NP  function for year 2 Summer
compute_emmeansNYS2 <- function(model_name) {
  N_levels <- c(0, 40, 80, 120, 160)
  # Get the model object using the provided name
  mod <- get(model_name)
  # Compute estimated marginal means
  emm <- emmeans(mod, specs = ~ N*P, at = list(N = N_levels))
  emm <- update(emm, type = "response")
  # Summarize the results
  summary_emm <- summary(emm)
  # Convert to data frame
  emm_df <- as.data.frame(summary_emm)
  # Add additional columns
  emm_df <- emm_df %>%
    mutate(Year = "2", Harvest = "Summer")
  return(emm_df)}

# Define a NP function for year 2 Fall
compute_emmeansNYF2 <- function(model_name) {
  N_levels <- c(0, 40, 80, 120, 160)
  # Get the model object using the provided name
  mod <- get(model_name)
  # Compute estimated marginal means
  emm <- emmeans(mod, specs = ~ N*P, at = list(N = N_levels))
  emm <- update(emm, type = "response")
  # Summarize the results
  summary_emm <- summary(emm)
  # Convert to data frame
  emm_df <- as.data.frame(summary_emm)
  # Add additional columns
  emm_df <- emm_df %>%
    mutate(Year = "2", Harvest = "Fall")
  return(emm_df)}

# Define a NP function for year 3 summer
compute_emmeansNZS2 <- function(model_name) {
  N_levels <- c(0, 40, 80, 120, 160)
  # Get the model object using the provided name
  mod <- get(model_name)
  # Compute estimated marginal means
  emm <- emmeans(mod, specs = ~ N*P, at = list(N = N_levels))
  emm <- update(emm, type = "response")
  # Summarize the results
  summary_emm <- summary(emm)
  # Convert to data frame
  emm_df <- as.data.frame(summary_emm)
  # Add additional columns
  emm_df <- emm_df %>%
    mutate(Year = "3", Harvest = "Summer")
  return(emm_df)}

# Define a NP  function for year 3 fall
compute_emmeansNZF2 <- function(model_name) {
  N_levels <- c(0, 40, 80, 120, 160)
  # Get the model object using the provided name
  mod <- get(model_name)
  # Compute estimated marginal means
  emm <- emmeans(mod, specs = ~ N*P, at = list(N = N_levels))
  emm <- update(emm, type = "response")
  # Summarize the results
  summary_emm <- summary(emm)
  # Convert to data frame
  emm_df <- as.data.frame(summary_emm)
  # Add additional columns
  emm_df <- emm_df %>%
    mutate(Year = "3", Harvest = "Fall")
  return(emm_df)}
```

#adding year 1 mn grain to the G column because they were actually dehulled instead of imaged for using the equation 
```{r}
NdXSInoMN<-NdXSI[NdXSI$Location != "MN",]
NdXSIMN<-NdXSI[NdXSI$Location == "MN",]
NdXSIMN$G<-NdXSIMN$X2023MNGrainDeHulledKgHa
NdXSIG<-rbind(NdXSInoMN, NdXSIMN)
```

#Grain year 1 (all locations)
```{r}
#REMOVE PLOT MIA MNXS plot 1122 is removed because of missing grain
#NdXSIG<-NdXSIG[-117,]
modNXG<-lmer(G~N*P*C + (1|Rep), data=NdXSIG)
anova(modNXG)
#Check Assumptions
NXG_resid<-resid(modNXG)
qqnorm(NXG_resid)
qqline(NXG_resid)
plot(modNXG)
#check assumptions logtransform
modNXG1<-lmer(log(G)~N*P*C + (1|Rep), data=NdXSIG)
summary(modNXG1)
anova(modNXG1)
NXG_resid1<-resid(modNXG1)
qqnorm(NXG_resid1)
qqline(NXG_resid1)
plot(modNXG1)
#check assumptions box cox
library(bestNormalize)
bn <- bestNormalize(NdXSIG$G)
bn$chosen_transform
NdXSIG$G_trans <- bn$x.t

modNXG1<-lmer(G_trans~N*P*C + (1|Rep), data=NdXSIG)
summary(modNXG1)
anova(modNXG1)
NXG_resid1<-resid(modNXG1)
qqnorm(NXG_resid1)
qqline(NXG_resid1)
plot(modNXG1)

monoIformean<-NdXSIG[NdXSIG$C == 'monoculture',]
mean(monoIformean$G)
Iformean<-NdXSIG[NdXSIG$C == '',]
mean(Iformean$G)

#Plot raw data with predicted values regression line
NdXSIG$predicted <- predict(modNXG1, newdata = NdXSIG, re.form = NA)
plotty<-ggplot(NdXSIG, aes(x = N, y = G, color = C, group = C)) +
geom_point()+
facet_wrap(~P, scales = "free_y", ncol = 2)+ #make it by location 
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
labs(x = "N-Rate (Kg/ha)", y = "Grain Yield (Kg/ha)") +  # Label the axes
geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values 
ylim(0, 1700)+ #set y axis scale 
scale_color_discrete(name = "Cropping System")  #legend for colors

#try plot again


#Threeway means
NXG1emm <- compute_emmeansNXS("modNXG1")
# Perform pairwise comparisons
pairwise_results <- pairwise.t.test(NdXSIG$G, NdXSIG$P, 
                                    p.adjust.method = "bonferroni")

#Pairwise P:C
NXGemmsPC <- emmeans(modNXG1, ~ P*C, type = "response") # Obtain estimated marginal means (excluding N)
cld_dataNXGPC <- cld(NXGemmsPC, Letters=custom_letters) # Create compact letter display
cld_dataNXGPC$response <- format(cld_dataNXGPC$response, digits = 5)
cld_dataNXGPC<- cld_dataNXGPC %>%
  select(P, C, response, .group)
colnames(cld_dataNXGPC) <- c("Site","Cropping System","Grain Yield (kg ha-1)", "Group")
cld_dataNXGPC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise P
emmsP <- emmeans(modNXG1, ~ P, type = "response") # Obtain estimated marginal means (excluding N)
pairwise_comparisons <- cld(emmsP, Letters=custom_letters) #pairwise comparison
#Pairwise C
emmsCXG <- emmeans(modNXG1, ~ C, type = "response") # Obtain estimated marginal means (excluding N)
cld_dataNXGC <- cld(emmsCXG, Letters=custom_letters) # Create compact letter display
#Pairwise N (I could theoreticlaly delete all pairwise N because its all incorrect apparently after defense...)
N_levels <- c(0, 40, 80, 120, 160)
emmsN <- emmeans(modNXG1, specs = ~ N, at = list(N = N_levels), type = "response")
cld_dataNXGN <- cld(emmsN, Letters=custom_letters) # Create compact letter display
#Pairwise N:P
N_levels <- c(0, 40, 80, 120, 160)
emmsNP <- emmeans(modNXG1, specs = ~ N*P, at = list(N = N_levels), type = "response")
cld_dataNXGNP <- cld(emmsNP, Letters=custom_letters) # Create compact letter display
cld_dataNXGNP$response <- format(cld_dataNXGNP$response, digits = 5)
rownames(cld_dataNXGNP) <- NULL
cld_dataNXGNP<- cld_dataNXGNP %>%
  select(N,P, response, .group)
colnames(cld_dataNXGNP) <- c("N","Site","Grain Yield (kg ha-1)", "Group")
cld_dataNXGNP  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)


#This gives us the slope for each interactions as well as a P value indicating significance level for that slope
emtrends(modNXG1,~ P*C, var= "N", infer=TRUE)
emtrends(modNXG1,~ P, var= "N", infer=TRUE)
emtrends(modNXG1,~ C, var= "N", infer=TRUE)
summary(modNXG1)


#try to get R2 for the model (not helpful for individual interactions..?)
r2 <- r.squaredGLMM(modNXG1)
r2_interaction <- r.squaredGLMM(modNXG1, which = "conditional", type = "marginal", subset = "interaction")

#try to add R2 and CI to plots (more helpful for individual interactions? or just Threeway?)
NdXSIG$predicted <- predict(modNXG1, newdata = NdXSIG, re.form = NA)
# Predict values and calculate standard errors
pred_ci <- predict(modNXG1, newdata = NdXSIG, re.form = NA, type = "response", se.fit = TRUE)
# Calculate lower and upper confidence interval bounds for fixed effects
lower_ci <- pred_ci$fit - 1.96 * pred_ci$se.fit  # Assuming a 95% confidence interval
upper_ci <- pred_ci$fit + 1.96 * pred_ci$se.fit
# Add confidence interval bounds for fixed effects to the dataframe
NdXSIG$lower_ci_fixed <- lower_ci
NdXSIG$upper_ci_fixed <- upper_ci
ggplot(NdXSIG, aes(x = N, y = G, color = C, group = C)) +
geom_point()+
geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
geom_line(aes(N, exp(lower_ci_fixed)))+
geom_line(aes(N, exp(upper_ci_fixed)))+
geom_ribbon(aes(ymin = exp(lower_ci_fixed), ymax = exp(upper_ci_fixed), fill = C), alpha = 0.2) +  # Confidence interval shading
facet_wrap(~P, scales = "free_y", ncol = 2)+ #make it by location 
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
labs(x = "N-Rate (Kg/ha)", y = "Grain Yield (Kg/ha)") +  # Label the axes
ylim(0, 1700)+ #set y axis scale 
scale_color_discrete(name = "Cropping System")+  #legend for colors
stat_poly_eq(use_label(c("eq", "R2"))) #add equation and R2 to plot



#what if i just take out P and N (example for when no N:P or N:C or N:P:C)
modXGnoNP<-lmer(log(G)~N + (1|Rep), data=NdXSIG)
modXGplusNP<-lmer(log(G)~N+P+C + (1|Rep), data=NdXSIG)
NdXSIG$B<-as.numeric(NdXSIG$P)
NdXSIG$K<-as.numeric(NdXSIG$C)
modXGcontNP<-lmer(log(G)~N+B+K+N:B+N:K + (1|Rep), data=NdXSIG)
summary(modXGplusNP)
summary(modXGnoNP)
summary(modXGcontNP)
```
#grain equations table attempt
```{r}
emtrends_result<-emtrends(modNXG1,~ P, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  desired_order_P <- c("MN", "NY", "KS", "WI")
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
emmeans_results<-emmeans(modNXG1, ~P, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
merged_df <- emtrends_df %>%
  inner_join(emmeans_df, by = c("P")) %>%
  select(P, emmean, N.trend, SE.x)
view(merged_df)
merged_df$P <- factor(merged_df$P, levels = c("MN", "NY", "KS", "WI"))  # Preferred order for P
# Create a new data frame with the calculated column
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
sorted_df <- new_df %>%
  arrange(P)
view(sorted_df)
```
#grain figures redo N:E
```{r}
#N:E
# Layer all the plots together!
colors <- c("Year 1 Summer Harvest" = "red", 
            "Year 1 Fall Harvest" = "green", 
            "Year 2 Summer Harvest" = "blue", 
            "Year 2 Fall Harvest" = "purple")
legend_order2 <- c("Year 1 Summer Harvest", 
                  "Year 2 Summer Harvest")
# Define the desired order of 'P'
desired_order <- c("MN", "NY", "KS", "WI")
NdXSIG$P <- factor(NdXSIG$P, levels = desired_order)

GraincomboplotNE <- ggplot(data=NdXSIG) +
  geom_point(data = NdXSIG, aes(x = N, y = G, color = "Year 1 Summer Harvest", shape = C)) +
  geom_point(data = DATA32, aes(x = N, y = GAdjY, color = "Year 2 Summer Harvest", shape = C)) +
  labs(x = "N-Rate (Kg ha-1)", y = "Grain Yield", linetype = "Cropping System", shape = "Cropping System", color = "Harvest")+
  scale_x_continuous(breaks = c(0, 40, 80, 120, 160)) +
  ylim(0, 1550) +
  facet_wrap(~P, scales = "free_y", ncol = 2) +
  scale_shape_manual(values = c(4, 25),labels = c("Intercropped","Monoculture IWG"))+
    scale_color_manual(values = colors, limits = legend_order2)+
  geom_function(data=subset(NdXSIG, P== "MN"), fun=~179.38*exp(0.0021*.x),color='red')+
  geom_function(data=subset(NdXSIG, P== "NY"), fun=~408.24*exp(0.0047*.x),color='red')+
  geom_function(data=subset(NdXSIG, P== "KS"), fun=~407.18*exp(-0.0002*.x),color='red')+
  geom_function(data=subset(NdXSIG, P== "WI"), fun=~736.77*exp(-0.0001*.x),color='red')+
  geom_function(data=subset(DATA32, P== "NY"), fun=~222.27*exp(0.0009*.x),color='blue')+
  geom_function(data=subset(DATA32, P== "KS"), fun=~99.20*exp(0.0005*.x),color='blue')+
  geom_function(data=subset(DATA32, P== "WI"), fun=~278.01*exp(0.0065*.x),color='blue')
print(GraincomboplotNE)

ggsave("GraincomboplotNE.jpg", plot = GraincomboplotNE, width = 8, height = 6, dpi = 300)


```
#grain figure E:C (X)
```{r}

NXGemmsPC <- emmeans(modNXG1, ~ P*C, type = "response") # Obtain estimated marginal means (excluding N)
emms_df <- as.data.frame(NXGemmsPC)
cld_dataNXGPC <- cld(NXGemmsPC, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataNXGPC)
merged_df <- merge(emms_df, cld_df,by = c("P", "C"))
custom_labels <- c("Intercrop", "Monoculture IWG")
custom_colors <- c("darkmagenta", "cyan") 
GXPC<-ggplot(NdXSIG, aes(x = P, y = exp(predicted), color = C)) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7) +
  labs(x = "Environment", y = "Grain Yield") +
  geom_point(data = emms_df, aes(x = P, y = response), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 1.8)+
  scale_color_manual(name = "Cropping System", labels = custom_labels,values = custom_colors)+
    guides(color = "none")+
     ggtitle("Year 1")+
  theme(plot.title = element_text(hjust = 0.5))
print(GXPC)
ggsave("GXPC.jpg", plot = GXPC, width = 8, height = 6, dpi = 300)
```
#grain figure E example
```{r}
NXGemmsP <- emmeans(modNXG1, ~ P, type = "response") 
emms_df <- as.data.frame(NXGemmsP)
cld_dataNXGP <- cld(NXGemmsP, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataNXGP)
merged_df <- merge(emms_df, cld_df,by = c("P"))
Pplot<-ggplot(NdXSIG, aes(x = P, y = exp(predicted))) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7, color="cyan") +
  labs(x = "Environment", y = "Grain Yield") +
  theme_minimal()+
  geom_point(data = emms_df, aes(x = P, y = response), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 1.8)

print(Pplot)
```
#grain figure C example
```{r}
custom_labels <- c("Intercrop", "Monoculture IWG")
custom_colors <- c("darkmagenta", "cyan") 
NXGemmsC <- emmeans(modNXG1, ~ C, type = "response") 
emms_df <- as.data.frame(NXGemmsC)
cld_dataNXGC <- cld(NXGemmsC, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataNXGC)
merged_df <- merge(emms_df, cld_df,by = c("C"))
Cplot<-ggplot(NdXSIG, aes(x = C, y = exp(predicted), color= C)) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7) +
  labs(x = "Cropping System", y = "Grain Yield") +
  theme_minimal()+
  geom_point(data = emms_df, aes(x = C, y = response), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = C, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = C, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 1.8)+
  scale_color_manual(name = "Cropping System", labels = custom_labels,values = custom_colors)

print(Cplot)
```



#GLM stuff for matt.....
```{r}
#Grain Q vs L vs log-lin
JmodGXLog<-lme(log(G)~N*C*P, random=~1|Rep, data=NdXSIG)
JmodGXL<-lme(G~N*C*P, random=~1|Rep, data=NdXSIG)
JmodGXQ<-lme(G~N+(I(N^2))*C*P, random=~1|Rep, data=NdXSIG)
AICc(JmodGXL)
AICc(JmodGXLog)
AICc(JmodGXQ)

#Total forage Q vs L vs log-lin
JmodTFXLog<-lmer(log(PlotTotForageKgHa)~N*P*CROP + (1|Rep), data=NdXF)
JmodTFXL<-lmer(PlotTotForageKgHa~N*P*CROP + (1|Rep), data=NdXF)
AICc(JmodTFXL)
AICc(JmodTFXLog)

#IWG forage Q vs L vs log-lin 
JmodIXLog<-lmer(log(PlotIWGDryKgHa)~N*P*C + (1|Rep), data=NdXSI)
JmodIXL<-lmer(PlotIWGDryKgHa~N*P*C + (1|Rep), data=NdXSI)
AICc(JmodIXL)
AICc(JmodIXLog)
```

#Grain year 2
```{r}
#paring down to just the necessary data from the dataset where we did the year 2 G adjusments based on the year 1 ajdustment values 
DATA31<-DATA3[DATA3$Crop1 != "WL" & DATA3$Crop1 != "Shockwave" & DATA3$Crop1 != "Higest",]
DATA31<- DATA31[complete.cases(DATA31$GAdjY), ]
DATA32<-DATA31[DATA31$first_value != "WL" & DATA31$first_value != "Higest",]
#linear (based on year 1 adjustments)
modNYGadj<-lmer(GAdjY~N*P*C + (1|Rep), data=DATA32)
anova(modNYGadj)
#Check Assumptions
NYGadj_resid<-resid(modNYGadj)
qqnorm(NYGadj_resid)
qqline(NYGadj_resid)
plot(modNYGadj)
abline(h = 0, col="red")
#check assumptions log-transform
modNYGadj1<-lmer(log(GAdjY)~N*P*C + (1|Rep), data=DATA32)
anova(modNYGadj1)
summary(modNYGadj1)
NYGadj_resid1<-resid(modNYGadj1)
qqnorm(NYGadj_resid1)
qqline(NYGadj_resid1)
plot(modNYGadj1)

monoIformean2<-DATA32[DATA32$C == 'monoculture',]
mean(monoIformean2$GAdjY)
Iformean2<-DATA32[DATA32$C == 'intercrop',]
mean(Iformean2$GAdjY)

#linear (year 2, unadjusted)
modNYG<-lmer(G~N*P*C + (1|Rep), data=NdYSI)
anova(modNYG)
#Check Assumptions
NYG_resid<-resid(modNYG)
qqnorm(NYG_resid)
qqline(NYG_resid)
plot(modNYG)
abline(h = 0, col="red")
#check assumptions log-transform
modNYG1<-lmer(log(G)~N*P*C + (1|Rep), data=NdYSI)
anova(modNYG1)
NYG_resid1<-resid(modNYG1)
qqnorm(NYG_resid1)
qqline(NYG_resid1)
plot(modNYG1)


#plot year 2 adjusted
DATA32$predicted <- predict(modNYGadj1, newdata = DATA32, re.form = NA)
ggplot(DATA32, aes(x = N, y = G, color = C, group= C)) +
    geom_point() + 
  geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Grain Yield (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between Grain Yield and Nrate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(0, 1200) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors

#three way emmeans to compare ranks of adjusted and unadjusted
N_levels <- c(0, 40, 80, 120, 160)
emmsNGNPC <- emmeans(modNYG1, specs= ~ N*P*C, at= list(N = N_levels), type= "response")
cld_dataNYGNPC <- cld(emmsNGNPC, Letters=custom_letters)
emmsNGadjNPC <- emmeans(modNYGadj1, specs= ~ N*P*C, at= list(N = N_levels), type= "response")
cld_dataNYGadjNPC <- cld(emmsNGadjNPC, Letters=custom_letters)
cld_dataNYGNPC
cld_dataNYGadjNPC
library(multcomp)
#Pairwise done based on adjusted year 2 values!!!
#Pairwise P:C
emmsPC <- emmeans(modNYGadj1, ~ P*C, type= "response") # Obtain estimated marginal means (excluding N)
cld_dataNYGadjPC <- cld(emmsPC, Letters=custom_letters) # Create compact letter display
print(cld_dataNYGadjPC) # Print or view the compact letter display table
cld_dataNYGadjPC$response <- format(cld_dataNYGadjPC$response, digits = 5)
rownames(cld_dataNYGadjPC) <- NULL
cld_dataNYGadjPC<- cld_dataNYGadjPC %>%
  select(P, C, response, .group)
colnames(cld_dataNYGadjPC) <- c("Site","Cropping System","Grain Yield (kg ha-1)", "Group")
cld_dataNYGadjPC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise N:P
N_levels <- c(0, 40, 80, 120, 160)
emmsNP <- emmeans(modNYGadj1, ~ N*P,at= list(N = N_levels), type= "response") # Obtain estimated marginal means (excluding N)
cld_dataNYGadjNP <- cld(emmsNP, Letters=custom_letters) # Create compact letter display
print(cld_dataNYGadjNP) # Print or view the compact letter display table
cld_dataNYGadjNP$response <- format(cld_dataNYGadjNP$response, digits = 5)
rownames(cld_dataNYGadjNP) <- NULL
cld_dataNYGadjNP<- cld_dataNYGadjNP %>%
  select(N,P, response, .group)
colnames(cld_dataNYGadjNP) <- c("N","Site","Grain Yield (kg ha-1)", "Group")
cld_dataNYGadjNP  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise P
emmsP <- emmeans(modNYGadj1, ~ P,type= "response") # Obtain estimated marginal means (excluding N)
cld_dataNYGadjP <- cld(emmsP, Letters=custom_letters) # Create compact letter display
print(cld_dataNYGadjP) # Print or view the compact letter display table
#Pairwise N
N_levels <- c(0, 40, 80, 120, 160)
emmsCYGadj <- emmeans(modNYGadj1, specs= ~ N, at= list(N = N_levels), type= "response" ) # Obtain estimated marginal means (excluding N)
cld_dataNYGadjC <- cld(emmsCYGadj, Letters=custom_letters) # Create compact letter display
print(cld_dataNYGadjC) # Print or view the compact letter display table


#This gives us the slope for each interactions as well as a P value indicating significance level for that slope
#emtrends(modNYGadj1,~ P*C, var= "N", infer=TRUE)
emtrends(modNYGadj1,~ P, var= "N", infer=TRUE)
#emtrends(modNYGadj1,~ C, var= "N", infer=TRUE)
summary(modNYGadj1)

emtrends_result<-emtrends(modNYGadj1,~ P, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  desired_order_P <- c("MN", "NY", "KS", "WI")
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
emmeans_results<-emmeans(modNYGadj1, ~P, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
merged_df <- emtrends_df %>%
  inner_join(emmeans_df, by = c("P")) %>%
  select(P, emmean, N.trend, SE.x)
view(merged_df)
merged_df$P <- factor(merged_df$P, levels = c("MN", "NY", "KS", "WI"))  # Preferred order for P
# Create a new data frame with the calculated column
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
sorted_df <- new_df %>%
  arrange(P)
view(sorted_df)
```
#grain figure E:C (Y)
```{r}

NYGemmsPC <- emmeans(modNYGadj1, ~ P*C, type = "response") # Obtain estimated marginal means (excluding N)
emms_df <- as.data.frame(NYGemmsPC)
cld_dataNYGPC <- cld(NYGemmsPC, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataNYGPC)
merged_df <- merge(emms_df, cld_df,by = c("P", "C"))
custom_labels <- c("Intercrop", "Monoculture IWG")
custom_colors <- c("darkmagenta", "cyan") 
GYPC<-ggplot(DATA32, aes(x = P, y = exp(predicted), color = C)) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7) +
  labs(x = "Environment", y = "Grain Yield") +
  geom_point(data = emms_df, aes(x = P, y = response), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 3)+
  scale_color_manual(name = "Cropping System", labels = custom_labels,values = custom_colors)+
     ggtitle("Year 2")+
  theme(plot.title = element_text(hjust = 0.5))+
    scale_y_continuous(breaks = c(250, 500, 750, 1000, 1250), limits = c(0, 1260))


print(GYPC)
ggsave("GYPC.jpg", plot = GYPC, width = 8, height = 6, dpi = 300)
```
#combined grain year 1 and 2 plots N:E:C
```{r}
# Layer all the plots together!
colors <- c("Year 1 Summer Harvest" = "red", 
            "Year 1 Fall Harvest" = "green", 
            "Year 2 Summer Harvest" = "blue", 
            "Year 2 Fall Harvest" = "purple")
legend_order2 <- c("Year 1 Summer Harvest", 
                  "Year 2 Summer Harvest")
# Define the desired order of 'P'
desired_order <- c("MN", "NY", "KS", "WI")
NdXSIG$P <- factor(NdXSIG$P, levels = desired_order)

Graincomboplot <- ggplot() +
  geom_line(data = NdXSIG, aes(N, exp(predicted), color = "Year 1 Summer Harvest", linetype = C)) +
  geom_point(data = NdXSIG, aes(x = N, y = G, color = "Year 1 Summer Harvest", shape = C)) +
  geom_line(data = DATA32, aes(N, exp(predicted), color = "Year 2 Summer Harvest", linetype = C)) +
  geom_point(data = DATA32, aes(x = N, y = GAdjY, color = "Year 2 Summer Harvest", shape = C)) +
  labs(x = "N-Rate (Kg/ha)", y = "Grain Yield (Kg/ha)", linetype = "Cropping System", shape = "Cropping System", color = "Harvest") +
  ggtitle("Relationship between Grain Yield and N-rate") +
  scale_x_continuous(breaks = c(0, 40, 80, 120, 160)) +
  ylim(0, 1550) +
  facet_wrap(~P, scales = "free_y", ncol = 2) +
  scale_color_manual(values = colors, limits = legend_order2)+
  scale_shape_manual(values = c(4, 20))

print(Graincomboplot)

ggsave("Graincomboplot.jpg", plot = Graincomboplot, width = 8, height = 6, dpi = 300)
```
#combined grain year 1 and 2 plots E:C
```{r}
GEC<-grid.arrange(GXPC, GYPC, ncol = 2)
ggsave("GEC.jpg", plot = GEC, width =12, height = 6, dpi = 350)
```


#working example for making nice tables!!!! only works for ~N*P*C spec emmeans
```{r}
library(tidyverse)
library(kableExtra)
#added together emmeans results data from GX and GY into one table!!!
#combinedGemms <- rbind(BTGXemmsNPC, BTGYemmsNPC)
#combinedGemms |> 
  #data.frame() |> 
  # reorder columns via select()
  #select(Year, Harvest, P,C, N, response, lower.CL, upper.CL) |> 
  #kbl(align = "c") |> 
  #kable_paper(full_width = F) |> 
  #column_spec(1, bold = T) |> 
  #collapse_rows(columns = 1:5, valign = "top")
```



#Total forage year 1 summer
```{r}
#linear
#modNXST<-lmer(PlotTotForageKgHa~N*P*CROP + (1|Rep), data=NdXS) # NOT this one
modNXST<-lmer(PlotTotForageKgHa~N*P*CROP + (1|P:Rep), data=NdXS)
anova(modNXST)
#Check Assumptions
NXST_resid<-resid(modNXST)
qqnorm(NXST_resid)
qqline(NXST_resid)
plot(modNXST)
#Logtransform
modNXST1<-lmer(log(PlotTotForageKgHa)~N*P*CROP + (1|P:Rep), data=NdXS)
anova(modNXST1)
summary(modNXST1)
#check assumptions logtransform (makes it BETTER)
NXST_resid1<-resid(modNXST1)
qqnorm(NXST_resid1)
qqline(NXST_resid1)
plot(modNXST1)

library(bestNormalize)
bn <- bestNormalize(NdXS$PlotTotForageKgHa)
bn$chosen_transform
NdXS$PlotTotForageKgHa_trans <- bn$x.t
modNXST2<-lmer(PlotTotForageKgHa_trans~N*P*CROP + (1|P:Rep), data=NdXS)
anova(modNXST2)
summary(modNXST2)
NXST_resid2<-resid(modNXST2)
qqnorm(NXST_resid2)
qqline(NXST_resid2)
plot(modNXST2)


modNXST1_summary <- summary(modNXST1)
modNXST1_coeff <- as.data.frame(modNXST1_summary$coefficients)%>%
  filter(`Pr(>|t|)` < 0.05)
rownames(modNXST1_coeff)[2]<-"NY"
rownames(modNXST1_coeff)[3]<-"KS"
rownames(modNXST1_coeff)[4]<-"WI"
rownames(modNXST1_coeff)[5]<-"monoI"
rownames(modNXST1_coeff)[6]<-"Nrate:monoI"
rownames(modNXST1_coeff)[7]<-"WI:monoA"
rownames(modNXST1_coeff)[8]<-"KS:monoI"
rownames(modNXST1_coeff)[9]<-"WI:monoI"
colnames(modNXST1_coeff)[5]<-"Pr(>t)"
# Create custom table using kable and kableExtra
knitr::kable(modNXST1_coeff, caption = "Summer 2022 Mixed-Effects Model: PlotTotForageKgHa ~ Nrate * Location * CROPsystem + (1 | Rep)") %>%
  kable_styling(full_width = TRUE, position = "center", bootstrap_options = c("striped", "hover", "condensed"))

desired_order_P <- c("MN", "NY", "KS", "WI")
N_levels <- c(0, 40, 80, 120, 160)

#plot log-linear by location (log)
NdXS$predicted <- predict(modNXST1, newdata = NdXS, re.form = NA)
ggplot(NdXS, aes(x = N, y = PlotTotForageKgHa , color = CROP, group = CROP)) +
    geom_point() + 
  geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Grain Yield (log scale)") +
  ggtitle("Yr 1 S Relationship between Total Forage Yield and Nrate") +
  scale_x_continuous(breaks = c(0, 40, 80, 120, 160)) +
  ylim(0,15000)+
  facet_wrap(~P, scales = "free_y", ncol = 2) +
  scale_color_discrete(name = "Cropping System")

#Three way means
#NXST1emm <- compute_emmeansNXS("modNXST1")

#Pairwise N:P:C
emmsNPC <- emmeans(modNXST1, ~ N*P*CROP,at= list(N = N_levels), type= "response") 
cld_dataNXSTNPC <- cld(emmsNPC, Letters=custom_letters) # Create compact letter display
cld_dataNXSTNPC$response <- format(cld_dataNXSTNPC$response, digits = 5)
rownames(cld_dataNXSTNPC) <- NULL
cld_dataNXSTNPC<- cld_dataNXSTNPC %>%
  select(N, P, CROP, response, .group)
colnames(cld_dataNXSTNPC) <- c("N", "Site", "Cropping System", "Total Forage (kg ha-1)", "Group")
cld_dataNXSTNPC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

#This gives us the slope for each interactions as well as a P value indicating significance level for that slope
emtrends(modNXST1,~ P*CROP, var= "N", infer=TRUE)
  summary(modNXST1)
emtrends(modNXST1,~ P, var= "N", infer=TRUE)
emtrends(modNXST1,~ CROP, var= "N", infer=TRUE)

#emmeans for intercepts! via erika
emtrends_result<-emtrends(modNXST1,~ P*CROP, var= "N", infer=TRUE)
emtrends_df <- as.data.frame(emtrends_result)
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
emmeans_results<-emmeans(modNXST1, ~P*CROP, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
merged_df <- emtrends_df %>%
  inner_join(emmeans_df, by = c("P", "CROP")) %>%
  select(P, CROP, emmean, N.trend, SE.x)
#view(merged_df)
merged_df$P <- factor(merged_df$P, levels = c("MN", "NY", "KS", "WI"))  # Preferred order for P
merged_df$CROP <- factor(merged_df$CROP, levels = c("inter", "monoI","monoA"))  # Preferred order for CROP
# Create a new data frame with the calculated column
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
sorted_df <- new_df %>%
  arrange(P, CROP)
#view(sorted_df)
```

#Total forage year 1 fall 
#assumptions BAD!!
```{r}
#linear
NdXF$PlotTotForageKgHa<-as.numeric(NdXF$PlotTotForageKgHa)
modNXFT<-lmer(PlotTotForageKgHa~N*P*CROP + (1|P:Rep), data=NdXF)
anova(modNXFT)
summary(modNXFT)
#Check Assumptions
NXFT_resid<-resid(modNXFT)
qqnorm(NXFT_resid)
qqline(NXFT_resid)
plot(modNXFT)
#Check Assumptions Linear logtrans
modNXFT1<-lmer(log(PlotTotForageKgHa)~N*P*CROP + (1|P:Rep), data=NdXF)
anova(modNXFT1)
NXFT1_resid<-resid(modNXFT1)
qqnorm(NXFT1_resid)
qqline(NXFT1_resid)
plot(modNXFT1)

#modNXFT1_summary <- summary(modNXFT1)
#modNXFT1_coeff <- as.data.frame(modNXFT1_summary$coefficients)%>%
#  filter(`Pr(>|t|)` < 0.05)
#rownames(modNXFT1_coeff)[2]<-"WI"
#rownames(modNXFT1_coeff)[3]<-"monoI"
#rownames(modNXFT1_coeff)[4]<-"Nrate:monoI"
#rownames(modNXFT1_coeff)[5]<-"WI:monoA"
#rownames(modNXFT1_coeff)[6]<-"NY:monoI"
#colnames(modNXFT1_coeff)[5]<-"Pr(>t)"
# Create custom table using kable and kableExtra
#knitr::kable(modNXFT1_coeff, caption = "Fall 2022 Mixed-Effects Model: PlotTotForageKgHa ~ Nrate * Location * #CROPsystem + (1 | Rep)") %>%
#  kable_styling(full_width = TRUE, position = "center", bootstrap_options = c("striped", "hover", "condensed"))


#plots
NdXF$predicted <- predict(modNXFT1, newdata = NdXF, re.form = NA)
ggplot(NdXF, aes(x = N, y = PlotTotForageKgHa, color = CROP, group= CROP)) +
    geom_point() + 
  geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Total Forage Yield (Kg/ha)") +  # Label the axes
  ggtitle("Yr 1 F Relationship between Total Forage Yield and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(0, 3300) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors

#Threeway means
#NXFT1emm <- compute_emmeansNXF("modNXFT1")

#Pairwise N:P:C
emmsNPC <- emmeans(modNXFT1, ~ N*P*CROP,at= list(N = N_levels), type= "response") 
cld_dataNXFTNPC <- cld(emmsNPC, Letters=custom_letters) # Create compact letter display
cld_dataNXFTNPC$response <- format(cld_dataNXFTNPC$response, digits = 5)
rownames(cld_dataNXFTNPC) <- NULL
cld_dataNXFTNPC<- cld_dataNXFTNPC %>%
  select(N, P, CROP, response, .group)
colnames(cld_dataNXFTNPC) <- c("N", "Site", "Cropping System", "Total Forage (kg ha-1)", "Group")
cld_dataNXFTNPC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

#This gives us the slope for each interactions as well as a P value indicating significance level for that slope
emtrends_result<-emtrends(modNXFT1,~ P*CROP, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  desired_order_P <- c("MN", "NY", "KS", "WI")
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
  #view(emtrends_df)
emtrends(modNXFT1,~ P, var= "N", infer=TRUE)
emtrends(modNXFT1,~ CROP, var= "N", infer=TRUE)

#equations table
emtrends_result<-emtrends(modNXFT1,~ P*CROP, var= "N", infer=TRUE)
emtrends_df <- as.data.frame(emtrends_result)
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
emmeans_results<-emmeans(modNXFT1, ~P*CROP, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
merged_df <- emtrends_df %>%
  inner_join(emmeans_df, by = c("P", "CROP")) %>%
  select(P, CROP, emmean, N.trend, SE.x)
#view(merged_df)
merged_df$P <- factor(merged_df$P, levels = c("MN", "NY", "KS", "WI"))  # Preferred order for P
merged_df$CROP <- factor(merged_df$CROP, levels = c("inter", "monoI","monoA"))  # Preferred order for CROP
# Create a new data frame with the calculated column
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
sorted_df <- new_df %>%
  arrange(P, CROP)
#view(sorted_df)
```

#Total forage year 2 summer
```{r}
#linear
modNYST<-lmer(PlotTotForageKgHa~N*P*CROP + (1|P:Rep), data=NdYS)
anova(modNYST)
#Check Assumptions
NYST_resid<-resid(modNYST)
qqnorm(NYST_resid)
qqline(NYST_resid)
plot(modNYST)
#Logtransform
modNYST1<-lmer(log(PlotTotForageKgHa+0.0001)~N*P*CROP + (1|P:Rep), data=NdYS)
anova(modNYST1)
summary(modNYST1)
#check assumptions logtransform (makes it BETTERISH)
NYST_resid1<-resid(modNYST1)
qqnorm(NYST_resid1)
qqline(NYST_resid1)
plot(modNYST1)

modNYST_summary <- summary(modNYST)
#modNYST_coeff <- as.data.frame(modNYST_summary$coefficients)%>%
#  filter(`Pr(>|t|)` < 0.05)
#rownames(modNYST1_coeff)[2]<-"KS"
#rownames(modNYST1_coeff)[3]<-"monoA"
#rownames(modNYST1_coeff)[4]<-"monoI"
#rownames(modNYST1_coeff)[5]<-"Nrate:monoI"
#rownames(modNYST1_coeff)[6]<-"KS:monoI"
#rownames(modNYST1_coeff)[7]<-"Nrate:KS:monoA"
#colnames(modNYST1_coeff)[5]<-"Pr(>t)"
# Create custom table using kable and kableExtra
#knitr::kable(modNYST1_coeff, caption = "Summer 2023 Mixed-Effects Model: PlotTotForageKgHa ~ Nrate * Location * CROPsystem + (1 | Rep)") %>%
#  kable_styling(full_width = TRUE, position = "center", bootstrap_options = c("striped", "hover", "condensed"))


max(NdYS$PlotTotForageKgHa)
#linear plots
NdYS$predicted <- predict(modNYST1, newdata = NdYS, re.form = NA)
ggplot(NdYS, aes(x = N, y = PlotTotForageKgHa, color = CROP, group= CROP)) +
  geom_point() +
  geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Total Forage Yield (Kg/ha)") +  # Label the axes
  ggtitle("Yr 2 S Relationship between Total Forage Yield and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(0, 9000) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors

#Threeway means
#NYST1emm <- compute_emmeansNYS("modNYST1")

#Pairwise N:P:C
emmsNPC <- emmeans(modNYST1, ~ N*P*CROP,at= list(N = N_levels), type= "response") 
cld_dataNYSTNPC <- cld(emmsNPC, Letters=custom_letters) # Create compact letter display
cld_dataNYSTNPC$response <- format(cld_dataNYSTNPC$response, digits = 5)
rownames(cld_dataNYSTNPC) <- NULL
cld_dataNYSTNPC<- cld_dataNYSTNPC %>%
  select(N, P, CROP, response, .group)
colnames(cld_dataNYSTNPC) <- c("N", "Site", "Cropping System", "Total Forage (kg ha-1)", "Group")
cld_dataNYSTNPC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)


#This gives us the slope for each interactions as well as a P value indicating significance level for that slope
emtrends_result<-emtrends(modNYST1,~ P*CROP, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  desired_order_P <- c("MN", "NY", "KS", "WI")
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
  #view(emtrends_df)
emtrends(modNYST1,~ P, var= "N", infer=TRUE)
emtrends(modNYST1,~ CROP, var= "N", infer=TRUE)

#equations table
emtrends_result<-emtrends(modNYST1,~ P*CROP, var= "N", infer=TRUE)
emtrends_df <- as.data.frame(emtrends_result)
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
emmeans_results<-emmeans(modNYST1, ~P*CROP, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
merged_df <- emtrends_df %>%
  inner_join(emmeans_df, by = c("P", "CROP")) %>%
  select(P, CROP, emmean, N.trend, SE.x)
#view(merged_df)
merged_df$P <- factor(merged_df$P, levels = c("MN", "NY", "KS", "WI"))  # Preferred order for P
merged_df$CROP <- factor(merged_df$CROP, levels = c("inter", "monoI","monoA"))  # Preferred order for CROP
# Create a new data frame with the calculated column
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
sorted_df <- new_df %>%
  arrange(P, CROP)
#view(sorted_df)
```

#Total forage year 2 fall
```{r}
#linear
NdYF$PlotTotForageKgHa<-as.numeric(NdYF$PlotTotForageKgHa)
NdYF$N<-as.numeric(NdYF$N)
modNYFT<-lmer(PlotTotForageKgHa~N*P*CROP + (1|P:Rep), data=NdYF) #linear 
anova(modNYFT)
summary(modNYFT)
#Check Assumptions
NYFT_resid<-resid(modNYFT)
qqnorm(NYFT_resid)
qqline(NYFT_resid)
plot(modNYFT)
abline(h = 0, col="red")
#Logtransform
modNYFT1<-lmer(log(PlotTotForageKgHa)~N*P*CROP + (1|P:Rep), data=NdYF)
NYFT_resid1<-resid(modNYFT1)
qqnorm(NYFT_resid1)
qqline(NYFT_resid1)
plot(modNYFT1)
anova(modNYFT1)

#modNYFT1_summary <- summary(modNYFT1)
#modNYFT1_coeff <- as.data.frame(modNYFT1_summary$coefficients)%>%
#  filter(`Pr(>|t|)` < 0.05)
#rownames(modNYFT1_coeff)[2]<-"monoA"
#rownames(modNYFT1_coeff)[3]<-"monoI"
#rownames(modNYFT1_coeff)[4]<-"WI:monoI"
#colnames(modNYFT1_coeff)[5]<-"Pr(>t)"
# Create custom table using kable and kableExtra
#knitr::kable(modNYST1_coeff, caption = "Fall 2023 Mixed-Effects Model: PlotTotForageKgHa ~ Nrate * Location * #CROPsystem + (1 | Rep)") %>%
#  kable_styling(full_width = TRUE, position = "center", bootstrap_options = c("striped", "hover", "condensed"))


#linear plots
NdYF$predicted <- predict(modNYFT1, newdata = NdYF, re.form = NA)
ggplot(NdYF, aes(x = N, y = PlotTotForageKgHa, color = CROP, group= CROP)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Total Forage Yield (Kg/ha)") +  # Label the axes
  ggtitle("Yr 2 F Relationship between Total Forage Yield and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(0, 3500) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors

#Threeway means
#NYFT1emm <- compute_emmeansNYF("modNYFT1")

#Pairwise NPC
N_levels <- c(0, 40, 80, 120, 160)
emmsNPC <- emmeans(modNYFT1, specs = ~ N*P*CROP, at = list(N = N_levels), type = "response") # Obtain estimated marginal means (excluding N)
cld_dataNYFTNPC <- cld(emmsNPC, Letters=custom_letters )
#Pairwise C
emmsC <- emmeans(modNYFT1, ~ CROP, type = "response") # Obtain estimated marginal means (excluding N)
cld_dataNYFTC <- cld(emmsC, Letters=custom_letters) # Create compact letter display
cld_dataNYFTC$response <- format(cld_dataNYFTC$response, digits = 5)
cld_dataNYFTC<- cld_dataNYFTC %>%
  select(CROP, response, .group)
rownames(cld_dataNYFTC) <- NULL
colnames(cld_dataNYFTC) <- c("Cropping System", "Total Forage (kg ha-1)", "Group")
cld_dataNYFTC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise N:C
N_levels <- c(0, 40, 80, 120, 160)
emmsNYFT <- emmeans(modNYFT1, specs = ~ N*CROP, at = list(N = N_levels), type = "response")
cld_dataNYFTNC <- cld(emmsNYFT, Letters=custom_letters) # Create compact letter display
cld_dataNYFTNC$response <- format(cld_dataNYFTNC$response, digits = 5)
cld_dataNYFTNC<- cld_dataNYFTNC %>%
  select(N, CROP, response, .group)
rownames(cld_dataNYFTNC) <- NULL
colnames(cld_dataNYFTNC) <- c("N", "Cropping System", "Total Forage (kg ha-1)", "Group")
cld_dataNYFTNC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise P:C
emmsNYFTPC <- emmeans(modNYFT1, specs = ~ P*CROP, type = "response")
cld_dataNYFTPC <- cld(emmsNYFTPC, Letters=custom_letters) # Create compact letter display
cld_dataNYFTPC$response <- format(cld_dataNYFTPC$response, digits = 5)
cld_dataNYFTPC<- cld_dataNYFTPC %>%
  select(P, CROP, response, .group)
rownames(cld_dataNYFTPC) <- NULL
colnames(cld_dataNYFTPC) <- c("Location", "Cropping System", "Total Forage (kg ha-1)", "Group")
cld_dataNYFTPC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)


#This gives us the slope for each interactions as well as a P value indicating significance level for that slope
emtrends(modNYFT1,~ P*CROP, var= "N", infer=TRUE)
emtrends(modNYFT1,~ P, var= "N", infer=TRUE)
emtrends(modNYFT1,~ CROP, var= "N", infer=TRUE)

#equations table
emtrends_result<-emtrends(modNYFT1,~ CROP, var= "N", infer=TRUE)
emtrends_df <- as.data.frame(emtrends_result)
emmeans_results<-emmeans(modNYFT1, ~CROP, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
merged_df <- emtrends_df %>%
  inner_join(emmeans_df, by = c( "CROP")) %>%
  select(CROP, emmean, N.trend, SE.x)
#view(merged_df)
merged_df$CROP <- factor(merged_df$CROP, levels = c("inter", "monoI","monoA"))  # Preferred order for CROP
# Create a new data frame with the calculated column
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
sorted_df <- new_df %>%
  arrange( CROP)
#view(sorted_df)
```


#Total forage year 3 summer
# Assumptions not great
```{r}
NdZS_2 <- NdZS[NdZS$PlotTotForageKgHa != 0, ] # remove rows where the total forage was 0

#linear
modNZST<-lmer(PlotTotForageKgHa~N*P*CROP + (1|P:Rep), data=NdZS_2)
anova(modNZST)
#Check Assumptions
NZST_resid<-resid(modNZST)
qqnorm(NZST_resid)
qqline(NZST_resid)
plot(modNZST)
#Logtransform
modNZST1<-lmer(log(PlotTotForageKgHa+0.01)~N*P*CROP + (1|P:Rep), data=NdZS_2) 
anova(modNZST1)
summary(modNZST1)
#check assumptions logtransform (makes it BETTERISH)
NZST_resid1<-resid(modNZST1)
qqnorm(NZST_resid1)
qqline(NZST_resid1)
plot(modNZST1)
#Sqrttransform
modNZST2<-lmer(sqrt(PlotTotForageKgHa)~N*P*CROP + (1|Rep), data=NdZS) 
anova(modNZST2)
summary(modNZST2)
#check assumptions Sqrttransform (makes it BETTERISH)
NZST_resid2<-resid(modNZST2)
qqnorm(NZST_resid2)
qqline(NZST_resid2)
plot(NZST_resid2)

library(bestNormalize)
bn <- bestNormalize(NdZS$PlotTotForageKgHa)
bn$chosen_transform
NdZS$PlotTotForageKgHa_trans <- bn$x.t
modNZST3<-lmer(PlotTotForageKgHa_trans~N*P*CROP + (1|P:Rep), data=NdZS)
summary(modNZST3)
anova(modNZST3)
NZST_resid3<-resid(modNZST3)
qqnorm(NZST_resid3)
qqline(NZST_resid3)
plot(modNZST3)

#modNZST1_summary <- summary(modNZST1)
#modNZST1_coeff <- as.data.frame(modNZST1_summary$coefficients)%>%
#  filter(`Pr(>|t|)` < 0.05)
#rownames(modNZST1_coeff)[2]<-"NY"
#rownames(modNZST1_coeff)[3]<-"WI"
#colnames(modNZST1_coeff)[5]<-"Pr(>t)"
# Create custom table using kable and kableExtra
#knitr::kable(modNZST1_coeff, caption = "Summer 2024 Mixed-Effects Model: PlotTotForageKgHa ~ Nrate * Location * #CROPsystem + (1 | Rep)") %>%
#  kable_styling(full_width = TRUE, position = "center", bootstrap_options = c("striped", "hover", "condensed"))


#max(NdZS$PlotTotForageKgHa)

#linear plots
NdZS_2$predicted <- predict(modNZST1, newdata = NdZS_2, re.form = NA)
ggplot(NdZS_2, aes(x = N, y = PlotTotForageKgHa, color = CROP, group= CROP)) +
  geom_point() +
  geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Total Forage Yield (Kg/ha)") +  # Label the axes
  ggtitle("Yr 3 S Relationship between Total Forage Yield and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(0, 9000) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors

ggplot(NdZS_2, aes(x = N, y = PlotTotForageKgHa, color = CROP, group= CROP)) +
  geom_point() +
  geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Total Forage Yield (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between Total Forage Yield and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(0, 3500) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors

# removed y lim so the y axis is free; WI was extremly compact so this allows each line for WI to be visable
ggplot(NdZS_2, aes(x = N, y = PlotTotForageKgHa, color = CROP, group= CROP)) +
  geom_point() +
  geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Total Forage Yield (Kg/ha)") +  # Label the axes
  ggtitle("Yr 3 S Relationship between Total Forage Yield and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors

#Threeway means
#NYST1emm <- compute_emmeansNYS("modNYST1")

#Pairwise N:P:C
emmsNPC <- emmeans(modNZST1, ~ N*P*CROP,at= list(N = N_levels), type= "response") 
cld_dataNZSTNPC <- cld(emmsNPC, Letters=custom_letters) # Create compact letter display
cld_dataNZSTNPC$response <- format(cld_dataNZSTNPC$response, digits = 5)
rownames(cld_dataNZSTNPC) <- NULL
cld_dataNZSTNPC<- cld_dataNZSTNPC %>%
  select(N, P, CROP, response, .group)
colnames(cld_dataNZSTNPC) <- c("N", "Site", "Cropping System", "Total Forage (kg ha-1)", "Group")
cld_dataNZSTNPC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)


#This gives us the slope for each interactions as well as a P value indicating significance level for that slope
emtrends_result<-emtrends(modNZST1,~ P*CROP, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  desired_order_P <- c("MN", "NY", "KS", "WI")
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
  #view(emtrends_df)
emtrends(modNZST1,~ P, var= "N", infer=TRUE)
emtrends(modNZST1,~ CROP, var= "N", infer=TRUE)

#equations table
emtrends_result<-emtrends(modNZST1,~ P*CROP, var= "N", infer=TRUE)
emtrends_df <- as.data.frame(emtrends_result)
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
emmeans_results<-emmeans(modNZST1, ~P*CROP, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
merged_df <- emtrends_df %>%
  inner_join(emmeans_df, by = c("P", "CROP")) %>%
  select(P, CROP, emmean, N.trend, SE.x)
#view(merged_df)
merged_df$P <- factor(merged_df$P, levels = c("MN", "NY", "KS", "WI"))  # Preferred order for P
merged_df$CROP <- factor(merged_df$CROP, levels = c("inter", "monoI","monoA"))  # Preferred order for CROP
# Create a new data frame with the calculated column
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
sorted_df <- new_df %>%
  arrange(P, CROP)
#view(sorted_df)
```


#Total forage year 3 fall
```{r}
NdZF_2 <- NdZF[NdZF$PlotTotForageKgHa != 0, ] # remove rows where the total forage was 0

#linear
NdZF_2$PlotTotForageKgHa<-as.numeric(NdZF_2$PlotTotForageKgHa)
NdZF_2$N<-as.numeric(NdZF_2$N)
#modNZFT<-lmer(PlotTotForageKgHa~N*P*CROP + (1|Rep), data=NdZF_2) #linear 
# Error: boundary (singular) fit: see help('isSingular')
modNZFT<-lmer(PlotTotForageKgHa~N*P*CROP + (1|P:Rep), data=NdZF_2) #linear 
anova(modNYFT)
summary(modNZFT)
#Check Assumptions
NZFT_resid<-resid(modNZFT)
qqnorm(NZFT_resid)
qqline(NZFT_resid)
plot(modNZFT)
abline(h = 0, col="red")
#Logtransform
#modNZFT1<-lmer(log(PlotTotForageKgHa)~N*P*CROP + (1|Rep), data=NdZF_2)
# boundary (singular) fit: see help('isSingular')
modNZFT1<-lmer(log(PlotTotForageKgHa)~N*P*CROP + (1|P:Rep), data=NdZF_2)
NZFT_resid1<-resid(modNZFT1)
qqnorm(NZFT_resid1)
qqline(NZFT_resid1)
plot(modNZFT1)
anova(modNZFT1)


#modNZFT1_summary <- summary(modNZFT1)
#modNZFT1_coeff <- as.data.frame(modNZFT1_summary$coefficients)%>%
#  filter(`Pr(>|t|)` < 0.05)
#rownames(modNYFT1_coeff)[2]<-"monoA"
#rownames(modNYFT1_coeff)[3]<-"monoI"
#rownames(modNYFT1_coeff)[4]<-"WI:monoI"
#colnames(modNYFT1_coeff)[5]<-"Pr(>t)"
# Create custom table using kable and kableExtra
#knitr::kable(modNYFT1_coeff, caption = "Fall 2024 Mixed-Effects Model: PlotTotForageKgHa ~ Nrate * Location * #CROPsystem + (1 | Rep)") %>%
#  kable_styling(full_width = TRUE, position = "center", bootstrap_options = c("striped", "hover", "condensed"))

#linear plots
NdZF_2$predicted <- predict(modNZFT1, newdata = NdZF_2, re.form = NA)
ggplot(NdZF_2, aes(x = N, y = PlotTotForageKgHa, color = CROP, group= CROP)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Total Forage Yield (Kg/ha)") +  # Label the axes
  ggtitle("Yr 3 F Relationship between Total Forage Yield and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(0, 3500) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors

#Threeway means
#NYFT1emm <- compute_emmeansNYF("modNYFT1")

#Pairwise NPC
N_levels <- c(0, 40, 80, 120, 160)
emmsNPC <- emmeans(modNYFT1, specs = ~ N*P*CROP, at = list(N = N_levels), type = "response") # Obtain estimated marginal means (excluding N)
cld_dataNYFTNPC <- cld(emmsNPC, Letters=custom_letters )
#Pairwise C
emmsC <- emmeans(modNYFT1, ~ CROP, type = "response") # Obtain estimated marginal means (excluding N)
cld_dataNYFTC <- cld(emmsC, Letters=custom_letters) # Create compact letter display
cld_dataNYFTC$response <- format(cld_dataNYFTC$response, digits = 5)
cld_dataNYFTC<- cld_dataNYFTC %>%
  select(CROP, response, .group)
rownames(cld_dataNYFTC) <- NULL
colnames(cld_dataNYFTC) <- c("Cropping System", "Total Forage (kg ha-1)", "Group")
cld_dataNYFTC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise N:C
N_levels <- c(0, 40, 80, 120, 160)
emmsNYFT <- emmeans(modNYFT1, specs = ~ N*CROP, at = list(N = N_levels), type = "response")
cld_dataNYFTNC <- cld(emmsNYFT, Letters=custom_letters) # Create compact letter display
cld_dataNYFTNC$response <- format(cld_dataNYFTNC$response, digits = 5)
cld_dataNYFTNC<- cld_dataNYFTNC %>%
  select(N, CROP, response, .group)
rownames(cld_dataNYFTNC) <- NULL
colnames(cld_dataNYFTNC) <- c("N", "Cropping System", "Total Forage (kg ha-1)", "Group")
cld_dataNYFTNC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise P:C
emmsNYFTPC <- emmeans(modNYFT1, specs = ~ P*CROP, type = "response")
cld_dataNYFTPC <- cld(emmsNYFTPC, Letters=custom_letters) # Create compact letter display
cld_dataNYFTPC$response <- format(cld_dataNYFTPC$response, digits = 5)
cld_dataNYFTPC<- cld_dataNYFTPC %>%
  select(P, CROP, response, .group)
rownames(cld_dataNYFTPC) <- NULL
colnames(cld_dataNYFTPC) <- c("Location", "Cropping System", "Total Forage (kg ha-1)", "Group")
cld_dataNYFTPC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)


#This gives us the slope for each interactions as well as a P value indicating significance level for that slope
emtrends(modNYFT1,~ P*CROP, var= "N", infer=TRUE)
emtrends(modNYFT1,~ P, var= "N", infer=TRUE)
emtrends(modNYFT1,~ CROP, var= "N", infer=TRUE)

#equations table
emtrends_result<-emtrends(modNYFT1,~ CROP, var= "N", infer=TRUE)
emtrends_df <- as.data.frame(emtrends_result)
emmeans_results<-emmeans(modNYFT1, ~CROP, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
merged_df <- emtrends_df %>%
  inner_join(emmeans_df, by = c( "CROP")) %>%
  select(CROP, emmean, N.trend, SE.x)
#view(merged_df)
merged_df$CROP <- factor(merged_df$CROP, levels = c("inter", "monoI","monoA"))  # Preferred order for CROP
# Create a new data frame with the calculated column
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
sorted_df <- new_df %>%
  arrange( CROP)
#view(sorted_df)
```


#total forage combined plots N:E:C
```{r}
# Layer all the plots together!
colors <- c("Year 1 Summer Harvest" = "red", 
            "Year 1 Fall Harvest" = "pink", 
            "Year 2 Summer Harvest" = "blue", 
            "Year 2 Fall Harvest" = "lightblue", 
            "Year 3 Summer Harvest" = "darkgreen",
            "Year 3 Fall Harvest" = "green")

legend_order <- c("Year 1 Summer Harvest", "Year 1 Fall Harvest", 
                  "Year 2 Summer Harvest", "Year 2 Fall Harvest", "Year 3 Summer Harvest", "Year 3 Fall Harvest")
desired_order <- c("MN", "NY", "KS", "WI")
NdXS$P <- factor(NdXS$P, levels = desired_order)
NdXF$P <- factor(NdXF$P, levels = desired_order)
NdYS$P <- factor(NdYS$P, levels = desired_order)
NdYF$P <- factor(NdYF$P, levels = desired_order)
NdZS_2$P <- factor(NdZS_2$P, levels = desired_order)
NdZF_2$P <- factor(NdZF_2$P, levels = desired_order)


max(NdXS$PlotTotForageKgHa)
TFcomboplot <- ggplot() +
  geom_line(data = NdXS, aes(N, exp(predicted), color = "Year 1 Summer Harvest", linetype= CROP)) +
  geom_point(data = NdXS, aes(x = N, y = PlotTotForageKgHa, color = "Year 1 Summer Harvest", shape= CROP)) +
  geom_line(data = NdXF, aes(N, exp(predicted), color = "Year 1 Fall Harvest", linetype= CROP)) +
  geom_point(data = NdXF, aes(x = N, y = PlotTotForageKgHa, color = "Year 1 Fall Harvest", shape= CROP)) +
  geom_line(data = NdYS, aes(N, exp(predicted), color = "Year 2 Summer Harvest", linetype= CROP)) +
  geom_point(data = NdYS, aes(x = N, y = PlotTotForageKgHa, color = "Year 2 Summer Harvest", shape= CROP)) +
  geom_line(data = NdYF, aes(N, exp(predicted), color = "Year 2 Fall Harvest", linetype= CROP)) +
  geom_point(data = NdYF, aes(x = N, y = PlotTotForageKgHa, color = "Year 2 Fall Harvest", shape= CROP)) +
  geom_line(data = NdZS_2, aes(N, exp(predicted), color = "Year 3 Summer Harvest", linetype= CROP)) +
  geom_point(data = NdZS_2, aes(x = N, y = PlotTotForageKgHa, color = "Year 3 Summer Harvest", shape= CROP)) +
  geom_line(data = NdZF_2, aes(N, exp(predicted), color = "Year 3 Fall Harvest", linetype= CROP)) +
  geom_point(data = NdZF_2, aes(x = N, y = PlotTotForageKgHa, color = "Year 3 Fall Harvest", shape= CROP)) +
  labs(x = "N-Rate (kg ha-1)", y = "Total Forage Yield",
    color = "Harvest", 
    linetype = "Cropping System", shape = "Cropping System") +
  ggtitle("Relationship Between Total Forage Yield and N-rate") +
  scale_x_continuous(breaks = c(0, 40, 80, 120, 160)) +
  ylim(0, 14800) +
  facet_wrap(~P, scales = "free", ncol = 2) +
  scale_color_manual(values = colors, limits = legend_order)+
  scale_shape_manual(values = c(4, 20, 25),labels = c("Intercropped", "Monoculture Alfalfa", "Monoculture IWG") )+
  scale_linetype_manual(values = c("inter" = "solid", "monoA" = "dotted", "monoI" = "dashed"),labels = c("Intercropped", "Monoculture Alfalfa", "Monoculture IWG"))


print(TFcomboplot)

ggsave("TFcomboplot.jpg", plot = TFcomboplot, width = 8, height = 6, dpi = 300)
```

#total forage N:C plot
```{r}
# Layer all the plots together!
colors <- c("Year 1 Summer Harvest" = "red", 
            "Year 1 Fall Harvest" = "green", 
            "Year 2 Summer Harvest" = "blue", 
            "Year 2 Fall Harvest" = "purple")
legend_order <- c("Year 1 Summer Harvest", "Year 1 Fall Harvest", 
                  "Year 2 Summer Harvest", "Year 2 Fall Harvest")
NdXS$P <- factor(NdXS$P, levels = desired_order)
NdXF$P <- factor(NdXF$P, levels = desired_order)
NdYS$P <- factor(NdYS$P, levels = desired_order)
NdYF$P <- factor(NdYF$P, levels = desired_order)
NdZS_2$P <- factor(NdZS_2$P, levels = desired_order)
NdZF_2$P <- factor(NdZF_2$P, levels = desired_order)


TFcomboplotNC <- ggplot() +
  geom_point(data = NdYF, aes(x = N, y = PlotTotForageKgHa, color = "Year 2 Fall Harvest", shape= CROP)) +
  labs(x = "N-Rate (kg ha-1)", y = "Total Forage Yield (kg ha-1)",
    color = "Harvest", shape = "Cropping System") +
  ggtitle("Relationship Between Total Forage Yield and N-rate") +
  scale_x_continuous(breaks = c(0, 40, 80, 120, 160)) +
  ylim(0, 3500) +
  scale_color_manual(values = colors, limits = legend_order)+
  scale_shape_manual(values = c(4, 20, 25),labels = c("Intercropped", "Monoculture Alfalfa", "Monoculture IWG"))+
     geom_function(data=subset(NdYF, CROP== "inter"), fun=~2294.59*exp(-0.0010*.x),color='purple', linetype = "solid")+
   geom_function(data=subset(NdYF, CROP== "monoI"), fun=~404.27*exp(0.0012*.x),color='purple', linetype = "dashed")+
  geom_function(data=subset(NdYF, CROP== "monoA"), fun=~1509.32*exp(-0.0002*.x),color='purple', linetype = "dotted")+
  # Dummy geom_line for linetype legend
  geom_line(aes(x = c(0, 0), y = c(0, 0), linetype = "Intercropped"), color = 'purple') +
     geom_line(aes(x = c(0, 0), y = c(0, 0), linetype = "Monoculture Alfalfa"), color = 'purple') +
  geom_line(aes(x = c(0, 0), y = c(0, 0), linetype = "Monoculture IWG"), color = 'purple') +
  guides(linetype = guide_legend(override.aes = list(color = "black"), title = "Line Type",))


print(TFcomboplotNC)


ggsave("TFcomboplotNC.jpg", plot = TFcomboplotNC, width = 8, height = 6, dpi = 300)
```
#total forage E plot (YF)
```{r}
NYFTFemmsP <- emmeans(modNYFT1, ~ P, type = "response") 
emms_df <- as.data.frame(NYFTFemmsP)
cld_dataNYFTFP <- cld(NYFTFemmsP, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataNYFTFP)
merged_df <- merge(emms_df, cld_df,by = c("P"))
TFE<-ggplot(NdYF, aes(x = P, y = exp(predicted))) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7, color="darkgreen") +
  labs(x = "Environment", y = "Total Forage Yield") +
  geom_point(data = emms_df, aes(x = P, y = response), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 1.8)
print(TFE)
ggsave("TFE.jpg", plot = TFE, width = 8, height = 6, dpi = 300)
```
#total forage figure E:C (YF)
```{r}
max(NdYF$predicted)
exp(7.828112)
YFTFemmsPC <- emmeans(modNYFT1, ~ P*CROP, type = "response") # Obtain estimated marginal means (excluding N)
emms_df <- as.data.frame(YFTFemmsPC)
cld_dataYFTFPC <- cld(YFTFemmsPC, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataYFTFPC)
merged_df <- merge(emms_df, cld_df,by = c("P", "CROP"))
custom_labels <- c("Intercrop", "Monoculture Alfalfa","Monoculture IWG")
custom_colors <- c("darkmagenta","coral1", "cyan") 
TFYFPC<-ggplot(NdYF, aes(x = P, y = exp(predicted), color = CROP)) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7) +
  labs(x = "Environment", y = "Total Forage Yield") +
  geom_point(data = emms_df, aes(x = P, y = response), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 2.5)+
  scale_color_manual(name = "Cropping System", labels = custom_labels,values = custom_colors)+
  theme(plot.title = element_text(hjust = 0.5))

print(TFYFPC)
ggsave("TFYFPC.jpg", plot = TFYFPC, width = 8, height = 6, dpi = 300)
```


Total Foraage All years together
```{r}
library(sjPlot) # table functions
library(sjmisc) # sample data
library(lme4) # fitting models

#REMOVE this once you get the corrected year 2 grain values in 
Nd$G<-Nd$PlotThreshedGrainKgHa

#Harvest 
NdS<-Nd[Nd$Harvest == "Summer",]
NdF<-Nd[Nd$Harvest == "Fall",]

#IWG vs ALF 
NdSI<-NdS[NdS$Crop1 != "Shockwave",]
NdSA<-NdS[NdS$Crop1 != "IWG",]

NdFI<-NdF[NdF$Crop1 != "Shockwave",]
NdFA<-NdF[NdF$Crop1 != "IWG",]

#Variety data isolation: for checking V*N interaction (variety x N rate)

#just 0 and 80 Nrate
Vd1_2<-data2[data2$NRate != "40" & data2$NRate != "120" & data2$NRate != "160",]

#remove monoculture plots
Vd_2<-Vd1_2[Vd1_2$C == "intercrop",]

#REMOVE this once you get the corrected year 2 grain values in 
Vd_2$G<-Vd_2$PlotThreshedGrainKgHa

#Harvest isolation
Vd_2S<-Vd_2[Vd_2$Harvest == "Summer",]
Vd_2F<-Vd_2[Vd_2$Harvest == "Fall",]

#IWG vs ALF isolation
Vd_2SI<-Vd_2S[Vd_2S$Crop1 != "Shockwave" & Vd_2S$Crop1 != "WL" & Vd_2S$Crop1 != "Higest" ,] 
Vd_2SA<-Vd_2S[Vd_2S$Crop1 != "IWG",]

Vd_2FI<-Vd_2F[Vd_2F$Crop1 != "Shockwave" & Vd_2F$Crop1 != "WL" & Vd_2F$Crop1 != "Higest" ,]
Vd_2FA<-Vd_2F[Vd_2F$Crop1 != "IWG",]




modN<-lmer(PlotTotForageKgHa~N*P*CROP + (1|YearCode) + (1|P:Rep), data=NdS)
modN_resid<-resid(modN)
qqnorm(modN_resid)
qqline(modN_resid)
plot(modN_resid)
# assumptions not good
#modN<-lmer(log(PlotTotForageKgHa+0.0001)~N*P*CROP + (1|YearCode) + (1|P:Rep), data=NdS)
#modN_resid<-resid(modN)
#qqnorm(modN_resid)
#qqline(modN_resid)
#plot(modN_resid)


anova(modN)
anova_results <- anova(modN)
# Filter out only significant predictors (e.g., p-value < 0.05)
#significant_terms <- rownames(anova_results)[anova_results$`Pr(>F)` < 0.05]
# Create a new formula with only significant predictors
#significant_formula <- as.formula(paste("PlotTotForageKgHa ~", paste(significant_terms, collapse = " + "), "+ #(1 | YearCode) + (1 | Rep)"))
# Fit the new model with only significant predictors
#modN_significant <- lmer(significant_formula, data = NdS)
# Create the table of only significant predictors
#tab_model(modN_significant, 
#          title = "Significant Predictors: PlotTotForageKgHa ~ Significant Terms")

#tab_model(modN, title = "Mixed-Effects Model: PlotTotForageKgHa ~ N * P * CROP + (1 | YearCode) + (1 | Rep)",
                   # css = list('table' = 'width: 100%;'))  # Adjust width to fit title

plot_model(modN)

mod_summary <- summary(modN)
#mod_coeff <- as.data.frame(mod_summary$coefficients)%>%
#  filter(`Pr(>|t|)` < 0.05)
#rownames(mod_coeff)[1]<-"Location(MN)"
#rownames(mod_coeff)[2]<-"Alfalfa_Monoculture"
#rownames(mod_coeff)[3]<-"Location(MN) : IWG_Monoculture"
#rownames(mod_coeff)[4]<-"Location(NY) : IWG_Monoculture"
#colnames(mod_coeff)[5]<-"Pr(>t)"
# Create custom table using kable and kableExtra
#knitr::kable(mod_coeff, caption = "Mixed-Effects Model: PlotTotForageKgHa ~ N * P * CROP + (1 | YearCode) + (1 #| Rep)") %>%
#  kable_styling(full_width = TRUE, position = "center", bootstrap_options = c("striped", "hover", "condensed"))


#Threeway means
#NYFT1emm <- compute_emmeansNYF("modNYFT1")

#Pairwise NPC
N_levels <- c(0, 40, 80, 120, 160)
emmsNPC <- emmeans(modN, specs = ~ N*P*CROP, at = list(N = N_levels), type = "response") # Obtain estimated marginal means (excluding N)
cld_dataNTNPC <- cld(emmsNPC, Letters=custom_letters )
#Pairwise C
emmsC <- emmeans(modN, ~ CROP, type = "response") # Obtain estimated marginal means (excluding N)
cld_dataNTC <- cld(emmsC, Letters=custom_letters) # Create compact letter display
cld_dataNTC$response <- format(cld_dataNTC$response, digits = 5)
cld_dataNTC<- cld_dataNTC %>%
  select(CROP, response, .group)
rownames(cld_dataNTC) <- NULL
colnames(cld_dataNTC) <- c("Cropping System", "Total Forage (kg ha-1)", "Group")
cld_dataNTC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise N:C
N_levels <- c(0, 40, 80, 120, 160)
emmsNT <- emmeans(modN, specs = ~ N*CROP, at = list(N = N_levels), type = "response")
cld_dataNTNC <- cld(emmsNT, Letters=custom_letters) # Create compact letter display
cld_dataNTNC$response <- format(cld_dataNTNC$response, digits = 5)
cld_dataNTNC<- cld_dataNTNC %>%
  select(N, CROP, response, .group)
rownames(cld_dataNTNC) <- NULL
colnames(cld_dataNTNC) <- c("N", "Cropping System", "Total Forage (kg ha-1)", "Group")
cld_dataNTNC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise P:C
emmsNTPC <- emmeans(modN, specs = ~ P*CROP, type = "response")
cld_dataNTPC <- cld(emmsNTPC, Letters=custom_letters) # Create compact letter display
cld_dataNTPC$response <- format(cld_dataNTPC$response, digits = 5)
cld_dataNTPC<- cld_dataNTPC %>%
  select(P, CROP, response, .group)
rownames(cld_dataNTPC) <- NULL
colnames(cld_dataNTPC) <- c("Location", "Cropping System", "Total Forage (kg ha-1)", "Group")
cld_dataNTPC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)


#This gives us the slope for each interactions as well as a P value indicating significance level for that slope
emtrends(modN,~ P*CROP, var= "N", infer=TRUE)
emtrends(modN,~ P, var= "N", infer=TRUE)
emtrends(modN,~ CROP, var= "N", infer=TRUE)

#equations table
emtrends_result<-emtrends(modN,~ CROP, var= "N", infer=TRUE)
emtrends_df <- as.data.frame(emtrends_result)
emmeans_results<-emmeans(modN, ~CROP, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
merged_df <- emtrends_df %>%
  inner_join(emmeans_df, by = c( "CROP")) %>%
  select(CROP, emmean, N.trend, SE.x)
view(merged_df)
merged_df$CROP <- factor(merged_df$CROP, levels = c("inter", "monoI","monoA"))  # Preferred order for CROP
# Create a new data frame with the calculated column
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
sorted_df <- new_df %>%
  arrange( CROP)
view(sorted_df)

# there's something wrong with this

```








#IWG forage year 1 summer
```{r}
#Linear
modNXSI<-lmer(PlotIWGDryKgHa~N*P*C + (1|Rep), data=NdXSI)
anova(modNXSI)
#Check Assumptions
NXSI_resid<-resid(modNXSI)
qqnorm(NXSI_resid)
qqline(NXSI_resid)
plot(modNXSI)
#log transform 
modNXSI1<-lmer(log(PlotIWGDryKgHa)~N*P*C + (1|Rep), data=NdXSI)
anova(modNXSI1)
#Check Assumptions
NXSI1_resid<-resid(modNXSI1)
qqnorm(NXSI1_resid)
qqline(NXSI1_resid)
plot(modNXSI1)

modNXSI1_summary <- summary(modNXSI1)
modNXSI1_coeff <- as.data.frame(modNXSI1_summary$coefficients)%>%
  filter(`Pr(>|t|)` < 0.05)
rownames(modNXSI1_coeff)[2]<-"MN"
rownames(modNXSI1_coeff)[3]<-"NY"
rownames(modNXSI1_coeff)[4]<-"monoculture"
rownames(modNXSI1_coeff)[5]<-"Nrate:NY"
rownames(modNXSI1_coeff)[6]<-"MN:monoculture"
rownames(modNXSI1_coeff)[7]<-"WI:monoculture"
colnames(modNXSI1_coeff)[5]<-"Pr(>t)"
# Create custom table using kable and kableExtra
knitr::kable(modNXSI1_coeff, caption = "Mixed-Effects Model: IWGForageKgHa ~ Nrate * Location * CROPsystem + (1 | Rep)") %>%
  kable_styling(full_width = TRUE, position = "center", bootstrap_options = c("striped", "hover", "condensed"))


max(NdXSI$PlotIWGDryKgHa)
#linear plots
NdXSI$predicted <- predict(modNXSI1, newdata = NdXSI, re.form = NA)
ggplot(NdXSI, aes(x = N, y = PlotIWGDryKgHa, color = C, group= C)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "IWG Forage Yield (Kg/ha)") +  # Label the axes
  ggtitle("Yr 1 S Relationship between IWG Forage Yield and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(0, 15000) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors

#Threeway means
NXSI1emm <- compute_emmeansNXS("modNXSI1")

#Pairwise P
emmsP <- emmeans(modNXSI1, ~ P, type = "response") # Obtain estimated marginal means
cld_dataNXSIP <- cld(emmsP, Letters=custom_letters) # Create compact letter display
#Pairwise C
emmsC <- emmeans(modNXSI1, ~ C, type = "response") # Obtain estimated marginal means 
cld_dataNXSIC <- cld(emmsC, Letters=custom_letters) # Create compact letter display
#Pairwise N
N_levels <- c(0, 40, 80, 120, 160)
emmsN <- emmeans(modNXSI1, specs = ~ N, at = list(N = N_levels), type = "response")
cld_dataNXSIN <- cld(emmsN, Letters=custom_letters) # Create compact letter display
#Pairwise P:C
emmsPC <- emmeans(modNXSI1, ~ P*C, type= "response") # Obtain estimated marginal means
cld_dataNXSIPC <- cld(emmsPC, Letters=custom_letters) # Create compact letter display
cld_dataNXSIPC$response <- format(cld_dataNXSIPC$response, digits = 5)
rownames(cld_dataNXSIPC) <- NULL
cld_dataNXSIPC<- cld_dataNXSIPC %>%
  select(P, C, response, .group)
colnames(cld_dataNXSIPC) <- c("Site", "Cropping System", "IWG Forage (kg ha-1)", "Group")
cld_dataNXSIPC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise N:P
emmsNP <- emmeans(modNXSI1, ~ N*P,at = list(N = N_levels), type= "response") # Obtain estimated marginal means
cld_dataNXSINP <- cld(emmsNP, Letters=custom_letters) # Create compact letter display
cld_dataNXSINP$response <- format(cld_dataNXSINP$response, digits = 5)
rownames(cld_dataNXSINP) <- NULL
cld_dataNXSINP<- cld_dataNXSINP %>%
  select(N,P, response, .group)
colnames(cld_dataNXSINP) <- c("N", "Site", "IWG Forage (kg ha-1)", "Group")
cld_dataNXSINP  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

#This gives us the slope for each interactions as well as a P value indicating significance level for that slope
emtrends(modNXSI1,~ P*C, var= "N", infer=TRUE)
emtrends_result<-emtrends(modNXSI1,~ P, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  desired_order_P <- c("MN", "NY", "KS", "WI")
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
  #view(emtrends_df)
emtrends(modNXSI1,~ C, var= "N", infer=TRUE)

#equations table
emtrends_result<-emtrends(modNXSI1,~ P, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  desired_order_P <- c("MN", "NY", "KS", "WI")
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
emmeans_results<-emmeans(modNXSI1, ~P, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
merged_df <- emtrends_df %>%
  inner_join(emmeans_df, by = c("P")) %>%
  select(P, emmean, N.trend, SE.x)
view(merged_df)
merged_df$P <- factor(merged_df$P, levels = c("MN", "NY", "KS", "WI"))  # Preferred order for P
# Create a new data frame with the calculated column
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
sorted_df <- new_df %>%
  arrange(P)
view(sorted_df)
```
#IWG forage figure E:C (XS)
```{r}
max(NdXSI$predicted)
exp(9.390308)
XSIemmsPC <- emmeans(modNXSI1, ~ P*C, type = "response") # Obtain estimated marginal means (excluding N)
emms_df <- as.data.frame(XSIemmsPC)
cld_dataXSIPC <- cld(XSIemmsPC, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataXSIPC)
merged_df <- merge(emms_df, cld_df,by = c("P", "C"))
custom_labels <- c("Intercrop", "Monoculture IWG")
custom_colors <- c("darkmagenta", "cyan") 
IXSPC<-ggplot(NdXSI, aes(x = P, y = exp(predicted), color = C)) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7) +
  labs(x = "Environment", y = "IWG Forage Yield") +
  geom_point(data = emms_df, aes(x = P, y = response), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 2)+
  scale_color_manual(name = "Cropping System", labels = custom_labels,values = custom_colors)+
     ggtitle("Year 1 Summer")+
  theme(plot.title = element_text(hjust = 0.5))+
   guides(color = "none")+
  scale_y_continuous(breaks = c(2000,4000,6000,8000,10000,12000, 14000), limits = c(0, 14000))

print(IXSPC)
```

#IWG forage year 1 fall
```{r}
#linear 
modNXFI<-lmer(PlotIWGDryKgHa~N*P*CROP + (1|Rep), data=NdXFI)
# boundary (singular) fit: see help('isSingular')
modNXFI<-lm(PlotIWGDryKgHa~N*P*CROP, data=NdXFI)
anova(modNXFI)
summary(modNXFI)
#Check Assumptions
NXFI_resid<-resid(modNXFI)
qqnorm(NXFI_resid)
qqline(NXFI_resid)
plot(modNXFI)
#log transform
modNXFI1<-lmer(log(PlotIWGDryKgHa)~N*P*CROP + (1|Rep), data=NdXFI)
# boundary (singular) fit: see help('isSingular')
modNXFI1<-lm(log(PlotIWGDryKgHa)~N*P*CROP, data=NdXFI)
anova(modNXFI1)
NXFI1_resid<-resid(modNXFI1)
qqnorm(NXFI1_resid)
qqline(NXFI1_resid)
plot(modNXFI1)


modNXFI1_summary <- summary(modNXFI1)
modNXFI1_coeff <- as.data.frame(modNXFI1_summary$coefficients)%>%
  filter(`Pr(>|t|)` < 0.05)
rownames(modNXFI1_coeff)[2]<-"WI"
rownames(modNXFI1_coeff)[3]<-"monoculture"
rownames(modNXFI1_coeff)[4]<-"NY:monoculture"
rownames(modNXFI1_coeff)[5]<-"WI:monoculture"
colnames(modNXFI1_coeff)[5]<-"Pr(>t)"
# Create custom table using kable and kableExtra
knitr::kable(modNXFI1_coeff, caption = "Mixed-Effects Model: IWGForageKgHa ~ Nrate * Location * CROPsystem + (1 | Rep)") %>%
  kable_styling(full_width = TRUE, position = "center", bootstrap_options = c("striped", "hover", "condensed"))


max(NdXFI$PlotIWGDryKgHa)
#linear plots
NdXFI$predicted <- predict(modNXFI1, newdata = NdXFI, re.form = NA)
ggplot(NdXFI, aes(x = N, y = PlotIWGDryKgHa, color = CROP, group= CROP)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "IWG Forage Yield (Kg/ha)") +  # Label the axes
  ggtitle("Yr 1 F Relationship between IWG Forage Yield and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(0, 2800) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors

#Threeway means
NXFI1emm <- compute_emmeansNXF("modNXFI1")

#Pairwise P
emmsP <- emmeans(modNXFI1, ~ P, type = "response") # Obtain estimated marginal means
cld_dataNXFIP <- cld(emmsP, Letters=custom_letters) # Create compact letter display
#Pairwise C
emmsC <- emmeans(modNXFI1, ~ CROP, type = "response") # Obtain estimated marginal means 
cld_dataNXFIC <- cld(emmsC, Letters=custom_letters) # Create compact letter display
#Pairwise N
N_levels <- c(0, 40, 80, 120, 160)
emmsN <- emmeans(modNXFI1, specs = ~ N, at = list(N = N_levels), type = "response")
cld_dataNXFIN <- cld(emmsN, Letters=custom_letters) # Create compact letter display
#Pairwise P:C
emmsPC <- emmeans(modNXFI1, ~ P*CROP, type= "response") # Obtain estimated marginal means
cld_dataNXFIPC <- cld(emmsPC, Letters=custom_letters) # Create compact letter display
cld_dataNXFIPC$response <- format(cld_dataNXFIPC$response, digits = 5)
rownames(cld_dataNXFIPC) <- NULL
cld_dataNXFIPC<- cld_dataNXFIPC %>%
  select(P, CROP, response, .group)
colnames(cld_dataNXFIPC) <- c("Site", "Cropping System", "IWG Forage (kg ha-1)", "Group")
cld_dataNXFIPC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise N:P
emmsNP <- emmeans(modNXFI1, ~ N*P,at = list(N = N_levels), type= "response") # Obtain estimated marginal means
cld_dataNXFINP <- cld(emmsNP, Letters=custom_letters) # Create compact letter display
cld_dataNXFINP$response <- format(cld_dataNXFINP$response, digits = 5)
rownames(cld_dataNXFINP) <- NULL
cld_dataNXFINP<- cld_dataNXFINP %>%
  select(N, P, response, .group)
colnames(cld_dataNXFINP) <- c("N", "Site", "IWG Forage (kg ha-1)", "Group")
cld_dataNXFINP  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

#slope stuff
emtrends_result<-emtrends(modNXFI1,~ P, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  desired_order_P <- c("MN", "NY", "KS", "WI")
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
  #view(emtrends_df)
  
  #equations table
  emtrends_result<-emtrends(modNXFI1,~ P, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  desired_order_P <- c("MN", "NY", "KS", "WI")
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
emmeans_results<-emmeans(modNXFI1, ~P, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
merged_df <- emtrends_df %>%
  inner_join(emmeans_df, by = c("P")) %>%
  select(P, emmean, N.trend, SE.x)
view(merged_df)
merged_df$P <- factor(merged_df$P, levels = c("MN", "NY", "KS", "WI"))  # Preferred order for P
# Create a new data frame with the calculated column
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
sorted_df <- new_df %>%
  arrange(P)
view(sorted_df)
```
#IWG forage figure E:C (XF)
```{r}
max(NdXFI$predicted)
exp(7.268011)
XFIemmsPC <- emmeans(modNXFI1, ~ P*CROP, type = "response") # Obtain estimated marginal means (excluding N)
emms_df <- as.data.frame(XFIemmsPC)
cld_dataXFIPC <- cld(XFIemmsPC, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataXFIPC)
merged_df <- merge(emms_df, cld_df,by = c("P", "CROP"))
custom_labels <- c("Intercrop", "Monoculture IWG")
custom_colors <- c("darkmagenta", "cyan") 
IXFPC<-ggplot(NdXFI, aes(x = P, y = exp(predicted), color = CROP)) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7) +
  labs(x = "Environment", y = "IWG Forage Yield") +
  geom_point(data = emms_df, aes(x = P, y = response), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 2)+
  scale_color_manual(name = "Cropping System", labels = custom_labels,values = custom_colors)+
     ggtitle("Year 1 Fall")+
  theme(plot.title = element_text(hjust = 0.5))+
   guides(color = "none")+
  scale_y_continuous(breaks = c(250, 500, 750, 1000, 1250, 1500), limits = c(0, 1500))

print(IXFPC)
```

#IWG forage year 2 summer
```{r}
#LINEAR
modNYSI<-lmer(PlotIWGDryKgHa~N*P*CROP + (1|Rep), data=NdYSI)
# boundary (singular) fit: see help('isSingular')
modNYSI<-lm(PlotIWGDryKgHa~N*P*CROP, data=NdYSI)
anova(modNYSI)
#Check Assumptions
NYSI_resid<-resid(modNYSI)
qqnorm(NYSI_resid)
qqline(NYSI_resid)
plot(modNYSI)
#Logtransform
modNYSI1<-lmer(log(PlotIWGDryKgHa)~N*P*CROP + (1|Rep), data=NdYSI)
# boundary (singular) fit: see help('isSingular')
modNYSI1<-lm(log(PlotIWGDryKgHa)~N*P*CROP, data=NdYSI)
anova(modNYSI1)
#check assumptions logtransform (makes it BETTER)
NYSI_resid1<-resid(modNYSI1)
qqnorm(NYSI_resid1)
qqline(NYSI_resid1)
plot(modNYSI1)

modNYSI1_summary <- summary(modNYSI1)
modNYSI1_coeff <- as.data.frame(modNYSI1_summary$coefficients)%>%
  filter(`Pr(>|t|)` < 0.05)
rownames(modNYSI1_coeff)[2]<-"NY"
rownames(modNYSI1_coeff)[3]<-"WI"
rownames(modNYSI1_coeff)[4]<-"monoculture"
rownames(modNYSI1_coeff)[5]<-"Nrate:NY"
rownames(modNYSI1_coeff)[6]<-"Nrate:WI"
colnames(modNYSI1_coeff)[5]<-"Pr(>t)"
# Create custom table using kable and kableExtra
knitr::kable(modNYSI1_coeff, caption = "Mixed-Effects Model: IWGForageKgHa ~ Nrate * Location * CROPsystem + (1 | Rep)") %>%
  kable_styling(full_width = TRUE, position = "center", bootstrap_options = c("striped", "hover", "condensed"))



max(NdYSI$PlotIWGDryKgHa)
#linear plots
NdYSI$predicted <- predict(modNYSI1, newdata = NdYSI, re.form = NA)
ggplot(NdYSI, aes(x = N, y = PlotIWGDryKgHa, color = CROP, group= CROP)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "IWG Forage Yield (Kg/ha)") +  # Label the axes
  ggtitle("Yr 2 S Relationship between IWG Forage Yield and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(0, 9000) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors

#Threeway means
NYSI1emm <- compute_emmeansNYS("modNYSI1")

#Pairwise P
emmsP <- emmeans(modNYSI1, ~ P, type = "response") # Obtain estimated marginal means (excluding N)
cld_dataNYSIP <- cld(emmsP, Letters=custom_letters) # Create compact letter display
#Pairwise C
emmsC <- emmeans(modNYSI1, ~ CROP, type = "response") # Obtain estimated marginal means (excluding N)
cld_dataNYSIC <- cld(emmsC, Letters=custom_letters) # Create compact letter display
cld_dataNYSIC$response <- format(cld_dataNYSIC$response, digits = 5)
rownames(cld_dataNYSIC) <- NULL
cld_dataNYSIC<- cld_dataNYSIC %>%
  select(CROP, response, .group)
colnames(cld_dataNYSIC) <- c("Cropping System", "IWG Forage (kg ha-1)", "Group")
cld_dataNYSIC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise N
N_levels <- c(0, 40, 80, 120, 160)
emmsN <- emmeans(modNYSI1, specs = ~ N, at = list(N = N_levels), type = "response")
cld_dataNYSIN <- cld(emmsN, Letters=custom_letters) # Create compact letter display
#Pairwise N:P
emmsNP <- emmeans(modNYSI1, ~ N*P,at = list(N = N_levels), type= "response") # Obtain estimated marginal means
cld_dataNYSINP <- cld(emmsNP, Letters=custom_letters) # Create compact letter display
cld_dataNYSINP$response <- format(cld_dataNYSINP$response, digits = 5)
rownames(cld_dataNYSINP) <- NULL
cld_dataNYSINP<- cld_dataNYSINP %>%
  select(N, P, response, .group)
colnames(cld_dataNYSINP) <- c("N", "Site", "IWG Forage (kg ha-1)", "Group")
cld_dataNYSINP  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

#slope stuff
emtrends_result<-emtrends(modNYSI1,~ P, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  desired_order_P <- c("MN", "NY", "KS", "WI")
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
  #view(emtrends_df)
  
    #equations table
  emtrends_result<-emtrends(modNYSI1,~ P, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  desired_order_P <- c("MN", "NY", "KS", "WI")
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
emmeans_results<-emmeans(modNYSI1, ~P, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
merged_df <- emtrends_df %>%
  inner_join(emmeans_df, by = c("P")) %>%
  select(P, emmean, N.trend, SE.x)
view(merged_df)
merged_df$P <- factor(merged_df$P, levels = c("MN", "NY", "KS", "WI"))  # Preferred order for P
# Create a new data frame with the calculated column
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
sorted_df <- new_df %>%
  arrange(P)
view(sorted_df)
```

#IWG forage year 2 fall
```{r}
#LINEAR 
modNYFI<-lmer(PlotIWGDryKgHa~N*P*CROP + (1|Rep), data=NdYFI)
anova(modNYFI)
#Check assumptions
NYFI_resid<-resid(modNYFI)
qqnorm(NYFI_resid)
qqline(NYFI_resid)
plot(modNYFI)
#log
modNYFI1<-lmer(log(PlotIWGDryKgHa)~N*P*CROP + (1|Rep), data=NdYFI)
anova(modNYFI1)
#Check assumptions
NYFI1_resid<-resid(modNYFI1)
qqnorm(NYFI1_resid)
qqline(NYFI1_resid)
plot(modNYFI1)

modNYFI1_summary <- summary(modNYFI1)
modNYFI1_coeff <- as.data.frame(modNYFI1_summary$coefficients)%>%
  filter(`Pr(>|t|)` < 0.05)
rownames(modNYFI1_coeff)[2]<-"Nrate"
rownames(modNYFI1_coeff)[3]<-"WI:monoculture"
colnames(modNYFI1_coeff)[5]<-"Pr(>t)"
# Create custom table using kable and kableExtra
knitr::kable(modNYFI1_coeff, caption = "Mixed-Effects Model: IWGForageKgHa ~ Nrate * Location * CROPsystem + (1 | Rep)") %>%
  kable_styling(full_width = TRUE, position = "center", bootstrap_options = c("striped", "hover", "condensed"))

max(NdYFI$PlotIWGDryKgHa)
#LINEAR plots
NdYFI$predicted <- predict(modNYFI1, newdata = NdYFI, re.form = NA)
ggplot(NdYFI, aes(x = N, y = PlotIWGDryKgHa, color = CROP, group= CROP)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "IWG Forage Yield (Kg/ha)") +  # Label the axes
  ggtitle("Yr 2 F Relationship between IWG Forage Yield and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(0, 1600) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors

#Threeway means
N_levels <- c(0, 40, 80, 120, 160)
emmsNPC <- emmeans(modNYFI1, specs = ~ N*P*CROP, at = list(N = N_levels), type = "response") # Obtain estimated marginal means (excluding N)
cld_dataNYFINPC <- cld(emmsNPC , Letters=custom_letters)

NYFI1emm <- compute_emmeansNYF("modNYFI1")


#Pairwise P
emmsP <- emmeans(modNYFI1, ~ P, type = "response") # Obtain estimated marginal means (excluding N)
cld_dataNYFIP <- cld(emmsP, Letters=custom_letters) # Create compact letter display
#Pairwise C
emmsC <- emmeans(modNYFI1, ~ CROP, type = "response") # Obtain estimated marginal means (excluding N)
cld_dataNYFIC <- cld(emmsC, Letters=custom_letters) # Create compact letter display
#Pairwise N
emmsN <- emmeans(modNYFI1, ~ N,at = list(N = N_levels), type= "response") # Obtain estimated marginal means
cld_dataNYFIN <- cld(emmsN, Letters=custom_letters) # Create compact letter display
#Pairwise N:C
emmsNC <- emmeans(modNYFI1, ~ N*CROP,at = list(N = N_levels), type= "response") # Obtain estimated marginal means
cld_dataNYFINC <- cld(emmsNC, Letters=custom_letters) # Create compact letter display
cld_dataNYFINC$response <- format(cld_dataNYFINC$response, digits = 5)
rownames(cld_dataNYFINC) <- NULL
cld_dataNYFINC<- cld_dataNYFINC %>%
  select(N, CROP, response, .group)
colnames(cld_dataNYFINC) <- c("N", "Cropping System", "IWG Forage (kg ha-1)", "Group")
cld_dataNYFINC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise P:C
emmsPC <- emmeans(modNYFI1, ~ P*CROP,type= "response") # Obtain estimated marginal means
cld_dataNYFIPC <- cld(emmsPC, Letters=custom_letters) # Create compact letter display
cld_dataNYFIPC$response <- format(cld_dataNYFIPC$response, digits = 5)
rownames(cld_dataNYFIPC) <- NULL
cld_dataNYFIPC<- cld_dataNYFIPC %>%
  select(P, CROP, response, .group)
colnames(cld_dataNYFIPC) <- c("Site", "Cropping System", "IWG Forage (kg ha-1)", "Group")
cld_dataNYFIPC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

#slope stuff
emtrends_result<-emtrends(modNYFI1,~ CROP, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  desired_order_C <- c("intercrop", "monoculture")
  emtrends_df$CROP <- factor(emtrends_df$CROP, levels = desired_order_C)
  #view(emtrends_df)
  
#equations table
emtrends_result<-emtrends(modNYFI1,~ CROP, var= "N", infer=TRUE)
emtrends_df <- as.data.frame(emtrends_result)
emmeans_results<-emmeans(modNYFI1, ~CROP, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
merged_df <- emtrends_df %>%
  inner_join(emmeans_df, by = c( "CROP")) %>%
  select(CROP, emmean, N.trend, SE.x)
#view(merged_df)
merged_df$CROP <- factor(merged_df$CROP, levels = c("intercrop", "monoculture"))  # Preferred order for CROP
# Create a new data frame with the calculated column
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
sorted_df <- new_df %>%
  arrange( CROP)
#view(sorted_df)
```
#IWG forage figure E:C (YF)
```{r}
YFIemmsPC <- emmeans(modNYFI1, ~ P*CROP, type = "response") # Obtain estimated marginal means (excluding N)
emms_df <- as.data.frame(YFIemmsPC)
cld_dataYFIPC <- cld(YFIemmsPC, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataYFIPC)
merged_df <- merge(emms_df, cld_df,by = c("P", "CROP"))
custom_labels <- c("Intercrop", "Monoculture IWG")
custom_colors <- c("darkmagenta", "cyan") 
IYFPC<-ggplot(NdYFI, aes(x = P, y = exp(predicted), color = CROP)) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7) +
  labs(x = "Environment", y = "IWG Forage Yield") +
  geom_point(data = emms_df, aes(x = P, y = response), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 2)+
  scale_color_manual(name = "Cropping System", labels = custom_labels,values = custom_colors)+
     ggtitle("Year 2 Fall")+
  theme(plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(breaks = c(250, 500, 750, 1000, 1250, 1500), limits = c(0, 1500))

print(IYFPC)
```

#IWG forage year 3 summer

```{r}
# KS not here
NdZSI <- NdZSI %>%
  filter(!is.na(PlotIWGDryKgHa))

#LINEAR 
modNZSI<-lmer(PlotIWGDryKgHa~N*P*CROP + (1|Rep), data=NdZSI)
anova(modNZSI)
#Check assumptions
NZSI_resid<-resid(modNZSI)
qqnorm(NZSI_resid)
qqline(NZSI_resid)
plot(modNZSI)
#log
modNZSI1<-lmer(log(PlotIWGDryKgHa)~N*P*CROP + (1|Rep), data=NdZSI)
anova(modNZSI1)
#Check assumptions
NZSI1_resid<-resid(modNZSI1)
qqnorm(NZSI1_resid)
qqline(NZSI1_resid)
plot(modNZSI1)

modNZSI1_summary <- summary(modNZSI1)
modNZSI1_coeff <- as.data.frame(modNZSI1_summary$coefficients)%>%
  filter(`Pr(>|t|)` < 0.05)
rownames(modNZSI1_coeff)[2]<-"Nrate"
rownames(modNZSI1_coeff)[3]<-"WI:monoculture"
colnames(modNZSI1_coeff)[5]<-"Pr(>t)"
# Create custom table using kable and kableExtra
knitr::kable(modNZSI1_coeff, caption = "Mixed-Effects Model: IWGForageKgHa ~ Nrate * Location * CROPsystem + (1 | Rep)") %>%
  kable_styling(full_width = TRUE, position = "center", bootstrap_options = c("striped", "hover", "condensed"))

max(NdZSI$PlotIWGDryKgHa)
#LINEAR plots
NdZSI$predicted <- predict(modNZSI1, newdata = NdZSI, re.form = NA)
ggplot(NdZSI, aes(x = N, y = PlotIWGDryKgHa, color = CROP, group= CROP)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "IWG Forage Yield (Kg/ha)") +  # Label the axes
  ggtitle("Yr 3 S Relationship between IWG Forage Yield and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(0, 1600) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors

#Threeway means
N_levels <- c(0, 40, 80, 120, 160)
emmsNPC <- emmeans(modNZSI1, specs = ~ N*P*CROP, at = list(N = N_levels), type = "response") # Obtain estimated marginal means (excluding N)
cld_dataNZSINPC <- cld(emmsNPC , Letters=custom_letters)

NZSI1emm <- compute_emmeansNZS("modNZSI1")


#Pairwise P
emmsP <- emmeans(modNZSI1, ~ P, type = "response") # Obtain estimated marginal means (excluding N)
cld_dataNZSIP <- cld(emmsP, Letters=custom_letters) # Create compact letter display
#Pairwise C
emmsC <- emmeans(modNZSI1, ~ CROP, type = "response") # Obtain estimated marginal means (excluding N)
cld_dataNZSIC <- cld(emmsC, Letters=custom_letters) # Create compact letter display
#Pairwise N
emmsN <- emmeans(modNZSI1, ~ N,at = list(N = N_levels), type= "response") # Obtain estimated marginal means
cld_dataNZSIN <- cld(emmsN, Letters=custom_letters) # Create compact letter display
#Pairwise N:C
emmsNC <- emmeans(modNZSI1, ~ N*CROP,at = list(N = N_levels), type= "response") # Obtain estimated marginal means
cld_dataNZSINC <- cld(emmsNC, Letters=custom_letters) # Create compact letter display
cld_dataNZSINC$response <- format(cld_dataNZSINC$response, digits = 5)
rownames(cld_dataNZSINC) <- NULL
cld_dataNZSINC<- cld_dataNZSINC %>%
  select(N, CROP, response, .group)
colnames(cld_dataNZSINC) <- c("N", "Cropping System", "IWG Forage (kg ha-1)", "Group")
cld_dataNZSINC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise P:C
emmsPC <- emmeans(modNZSI1, ~ P*CROP,type= "response") # Obtain estimated marginal means
cld_dataNZSIPC <- cld(emmsPC, Letters=custom_letters) # Create compact letter display
cld_dataNZSIPC$response <- format(cld_dataNZSIPC$response, digits = 5)
rownames(cld_dataNZSIPC) <- NULL
cld_dataNZSIPC<- cld_dataNZSIPC %>%
  select(P, CROP, response, .group)
colnames(cld_dataNZSIPC) <- c("Site", "Cropping System", "IWG Forage (kg ha-1)", "Group")
cld_dataNZSIPC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

#slope stuff
emtrends_result<-emtrends(modNZSI1,~ CROP, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  desired_order_C <- c("intercrop", "monoculture")
  emtrends_df$CROP <- factor(emtrends_df$CROP, levels = desired_order_C)
  #view(emtrends_df)
  
#equations table
emtrends_result<-emtrends(modNZSI1,~ CROP, var= "N", infer=TRUE)
emtrends_df <- as.data.frame(emtrends_result)
emmeans_results<-emmeans(modNZSI1, ~CROP, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
merged_df <- emtrends_df %>%
  inner_join(emmeans_df, by = c( "CROP")) %>%
  select(CROP, emmean, N.trend, SE.x)
#view(merged_df)
merged_df$CROP <- factor(merged_df$CROP, levels = c("intercrop", "monoculture"))  # Preferred order for CROP
# Create a new data frame with the calculated column
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
sorted_df <- new_df %>%
  arrange( CROP)
#view(sorted_df)
```

#IWG forage year 3 fall

```{r}
#LINEAR 
modNZFI<-lmer(PlotIWGDryKgHa~N*P*CROP + (1|Rep), data=NdZFI)
anova(modNZFI)
#Check assumptions
NZFI_resid<-resid(modNZFI)
qqnorm(NZFI_resid)
qqline(NZFI_resid)
plot(modNZFI)
#log
modNZFI1<-lmer(log(PlotIWGDryKgHa)~N*P*CROP + (1|Rep), data=NdZFI)
anova(modNZFI1)
#Check assumptions
NZFI1_resid<-resid(modNZFI1)
qqnorm(NZFI1_resid)
qqline(NZFI1_resid)
plot(modNZFI1)

modNZFI1_summary <- summary(modNZFI1)
modNZFI1_coeff <- as.data.frame(modNZFI1_summary$coefficients)%>%
  filter(`Pr(>|t|)` < 0.05)
rownames(modNZFI1_coeff)[2]<-"Nrate"
rownames(modNZFI1_coeff)[3]<-"WI:monoculture"
colnames(modNZFI1_coeff)[5]<-"Pr(>t)"
# Create custom table using kable and kableExtra
knitr::kable(modNZFI1_coeff, caption = "Mixed-Effects Model: IWGForageKgHa ~ Nrate * Location * CROPsystem + (1 | Rep)") %>%
  kable_styling(full_width = TRUE, position = "center", bootstrap_options = c("striped", "hover", "condensed"))

max(NdZFI$PlotIWGDryKgHa)
#LINEAR plots
NdZFI$predicted <- predict(modNZFI1, newdata = NdZSI, re.form = NA)
ggplot(NdZFI, aes(x = N, y = PlotIWGDryKgHa, color = CROP, group= CROP)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "IWG Forage Yield (Kg/ha)") +  # Label the axes
  ggtitle("Yr 3 F Relationship between IWG Forage Yield and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(0, 1600) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors

#Threeway means
N_levels <- c(0, 40, 80, 120, 160)
emmsNPC <- emmeans(modNZFI1, specs = ~ N*P*CROP, at = list(N = N_levels), type = "response") # Obtain estimated marginal means (excluding N)
cld_dataNZFINPC <- cld(emmsNPC , Letters=custom_letters)

NZFI1emm <- compute_emmeansNZF("modNZFI1")


#Pairwise P
emmsP <- emmeans(modNZFI1, ~ P, type = "response") # Obtain estimated marginal means (excluding N)
cld_dataNZFIP <- cld(emmsP, Letters=custom_letters) # Create compact letter display
#Pairwise C
emmsC <- emmeans(modNZFI1, ~ CROP, type = "response") # Obtain estimated marginal means (excluding N)
cld_dataNZFIC <- cld(emmsC, Letters=custom_letters) # Create compact letter display
#Pairwise N
emmsN <- emmeans(modNZFI1, ~ N,at = list(N = N_levels), type= "response") # Obtain estimated marginal means
cld_dataNZFIN <- cld(emmsN, Letters=custom_letters) # Create compact letter display
#Pairwise N:C
emmsNC <- emmeans(modNZFI1, ~ N*CROP,at = list(N = N_levels), type= "response") # Obtain estimated marginal means
cld_dataNZFINC <- cld(emmsNC, Letters=custom_letters) # Create compact letter display
cld_dataNZFINC$response <- format(cld_dataNZFINC$response, digits = 5)
rownames(cld_dataNZFINC) <- NULL
cld_dataNZFINC<- cld_dataNZFINC %>%
  select(N, CROP, response, .group)
colnames(cld_dataNZFINC) <- c("N", "Cropping System", "IWG Forage (kg ha-1)", "Group")
cld_dataNZFINC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise P:C
emmsPC <- emmeans(modNZFI1, ~ P*CROP,type= "response") # Obtain estimated marginal means
cld_dataNZFIPC <- cld(emmsPC, Letters=custom_letters) # Create compact letter display
cld_dataNZFIPC$response <- format(cld_dataNZFIPC$response, digits = 5)
rownames(cld_dataNZFIPC) <- NULL
cld_dataNZFIPC<- cld_dataNZFIPC %>%
  select(P, CROP, response, .group)
colnames(cld_dataNZFIPC) <- c("Site", "Cropping System", "IWG Forage (kg ha-1)", "Group")
cld_dataNZFIPC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

#slope stuff
emtrends_result<-emtrends(modNZFI1,~ CROP, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  desired_order_C <- c("intercrop", "monoculture")
  emtrends_df$CROP <- factor(emtrends_df$CROP, levels = desired_order_C)
  #view(emtrends_df)
  
#equations table
emtrends_result<-emtrends(modNZFI1,~ CROP, var= "N", infer=TRUE)
emtrends_df <- as.data.frame(emtrends_result)
emmeans_results<-emmeans(modNZFI1, ~CROP, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
merged_df <- emtrends_df %>%
  inner_join(emmeans_df, by = c( "CROP")) %>%
  select(CROP, emmean, N.trend, SE.x)
#view(merged_df)
merged_df$CROP <- factor(merged_df$CROP, levels = c("intercrop", "monoculture"))  # Preferred order for CROP
# Create a new data frame with the calculated column
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
sorted_df <- new_df %>%
  arrange( CROP)
#view(sorted_df)
```

#IWG forage combo plot E:C
```{r}
IEC<-grid.arrange(IXSPC, IXFPC, IYFPC, ncol = 2)
ggsave("IEC.jpg", plot = IEC, width =12, height = 6, dpi = 350)
```
#IWG forage combo plot N:E
```{r}
# Layer all the plots together!
colors <- c("Year 1 Summer Harvest" = "red", 
            "Year 1 Fall Harvest" = "pink", 
            "Year 2 Summer Harvest" = "blue", 
            "Year 2 Fall Harvest" = "lightblue", 
            "Year 3 Summer Harvest" = "darkgreen",
            "Year 3 Fall Harvest" = "green")
legend_order <- c("Year 1 Summer Harvest", "Year 1 Fall Harvest", 
                  "Year 2 Summer Harvest", "Year 2 Fall Harvest",
                  "Year 3 Summer Harvest", "Year 3 Fall Harvest")
NdXSI$P <- factor(NdXSI$P, levels = desired_order)

max(NdXSI$PlotIWGDryKgHa)
max(NdYSI$PlotIWGDryKgHa)
IFcomboplot <- ggplot() +
  geom_point(data = NdXSI, aes(x = N, y = PlotIWGDryKgHa, color = "Year 1 Summer Harvest", shape= CROP)) +
  geom_point(data = NdXFI, aes(x = N, y = PlotIWGDryKgHa, color = "Year 1 Fall Harvest", shape= CROP)) +
  geom_point(data = NdYSI, aes(x = N, y = PlotIWGDryKgHa, color = "Year 2 Summer Harvest", shape= CROP)) +
  labs(x = "N-Rate (kg ha-1)", y = "IWG Forage Yield",
    color = "Harvest", shape = "Cropping System") +
  scale_x_continuous(breaks = c(0, 40, 80, 120, 160)) +
  ylim(0, 14800) +
  facet_wrap(~P, scales = "free", ncol = 2) +
  scale_color_manual(values = colors, limits = legend_order)+
  scale_shape_manual(values = c(4, 25), labels = c("Intercropped", "Monoculture IWG"))+
  geom_function(data=subset(NdXSI, P== "MN"), fun=~1758.86*exp(0.0026*.x),color='red')+
  geom_function(data=subset(NdXSI, P== "NY"), fun=~2695.58*exp(0.0050*.x),color='red')+
  geom_function(data=subset(NdXSI, P== "KS"), fun=~7357.97*exp(0.0007*.x),color='red')+
  geom_function(data=subset(NdXSI, P== "WI"), fun=~6843.18*exp(0.0009*.x),color='red')+
  geom_function(data=subset(NdXFI, P== "MN"), fun=~651.94*exp(0.0020*.x),color='pink')+
  geom_function(data=subset(NdXFI, P== "NY"), fun=~263.84*exp(0.0044*.x),color='pink')+
  geom_function(data=subset(NdXFI, P== "WI"), fun=~283.04*exp(-0.0010*.x),color='pink')+
  geom_function(data=subset(NdXFI, P== "KS"), fun=~283.04*exp(-0.0010*.x),color='pink')+
  geom_function(data=subset(NdYSI, P== "NY"), fun=~2688.03*exp(0.0049*.x),color='blue')+
  geom_function(data=subset(NdYSI, P== "KS"), fun=~2145.60*exp(0.0008*.x),color='blue')+
  geom_function(data=subset(NdYSI, P== "WI"), fun=~3315.20*exp(0.0042*.x),color='blue')+
  geom_function(data=subset(NdYSI, P== "MN"), fun=~3315.20*exp(0.0042*.x),color='blue')+
  geom_function(data=subset(NdYFI, P== "NY"), fun=~3315.20*exp(0.0042*.x),color='lightblue')+
  geom_function(data=subset(NdYFI, P== "KS"), fun=~2145.60*exp(0.0008*.x),color='lightblue')+
  geom_function(data=subset(NdYFI, P== "WI"), fun=~3315.20*exp(0.0042*.x),color='lightblue')+
  geom_function(data=subset(NdYFI, P== "MN"), fun=~3315.20*exp(0.0042*.x),color='lightblue')+
  geom_function(data=subset(NdZSI, P== "NY"), fun=~2688.03*exp(0.0049*.x),color='darkgreen')+
  geom_function(data=subset(NdZSI, P== "KS"), fun=~2145.60*exp(0.0008*.x),color='darkgreen')+
  geom_function(data=subset(NdZSI, P== "WI"), fun=~3315.20*exp(0.0042*.x),color='darkgreen')+
  geom_function(data=subset(NdZSI, P== "MN"), fun=~3315.20*exp(0.0042*.x),color='darkgreen')+
  geom_function(data=subset(NdZFI, P== "NY"), fun=~3315.20*exp(0.0042*.x),color='green')+
  geom_function(data=subset(NdZFI, P== "KS"), fun=~2145.60*exp(0.0008*.x),color='green')+
  geom_function(data=subset(NdZFI, P== "WI"), fun=~3315.20*exp(0.0042*.x),color='green')+
  geom_function(data=subset(NdZFI, P== "MN"), fun=~3315.20*exp(0.0042*.x),color='green')

print(IFcomboplot)

ggsave("IFcomboplot.jpg", plot = IFcomboplot, width = 8, height = 6, dpi = 300)
```
#IWG forage plot N:C
```{r}
# Layer all the plots together!
colors <- c("Year 1 Summer Harvest" = "red", 
            "Year 1 Fall Harvest" = "green", 
            "Year 2 Summer Harvest" = "blue", 
            "Year 2 Fall Harvest" = "purple")
legend_order <- c( "Year 2 Fall Harvest")
NdYFI$P <- factor(NdYFI$P, levels = desired_order)

max(NdYFI$PlotIWGDryKgHa)
IFcomboplotNC <- ggplot() +
  geom_point(data = NdYFI, aes(x = N, y = PlotIWGDryKgHa, color = "Year 2 Fall Harvest", shape= CROP)) +
  labs(x = "N-Rate (kg ha-1)", y = "IWG Forage Yield",
    color = "Harvest", shape = "Cropping System",linetype = "Cropping System") +
  scale_x_continuous(breaks = c(0, 40, 80, 120, 160)) +
  ylim(0, 1600) +
  scale_color_manual(values = colors, limits = legend_order)+
  scale_shape_manual(values = c(4, 25), labels = c("Intercropped", "Monoculture IWG"))+
    geom_function(data=subset(NdYFI, CROP== "intercrop"), fun=~534.31*exp(0.0034*.x),color='purple', linetype = "solid")+
   geom_function(data=subset(NdYFI, CROP== "monoculture"), fun=~404.27*exp(0.0012*.x),color='purple', linetype = "dashed")+
  geom_line(aes(x = c(0, 0), y = c(0, 0), linetype = "Intercropped"), color = 'purple') +
  geom_line(aes(x = c(0, 0), y = c(0, 0), linetype = "Monoculture IWG"), color = 'purple') +
  scale_linetype_manual(name = "Cropping System", values = c("solid", "dashed"), labels = c("Intercropped", "Monoculture IWG")) +
  guides(linetype = guide_legend(override.aes = list(color = 'purple'), title = "Line Type"))


print(IFcomboplotNC)

ggsave("IFcomboplotNC.jpg", plot = IFcomboplotNC, width = 8, height = 6, dpi = 300)
```
#IWG forage C plot (YS)
```{r}
custom_labels <- c("Intercrop", "Monoculture IWG")
custom_colors <- c("darkmagenta", "cyan") 
NYSIemmsC <- emmeans(modNYSI1, ~ C, type = "response") 
emms_df <- as.data.frame(NYSIemmsC)
cld_dataNYSIC <- cld(NYSIemmsC, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataNYSIC)
merged_df <- merge(emms_df, cld_df,by = c("C"))
IYSC<-ggplot(NdYSI, aes(x = C, y = exp(predicted), color= C)) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7) +
  labs(x = "Cropping System", y = "IWG Forage Yield") +
  ggtitle("Year 2 Summer")+
  geom_point(data = emms_df, aes(x = C, y = response), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = C, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = C, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 1.8)+
  scale_color_manual(name = "Cropping System", labels = custom_labels,values = custom_colors)

print(IYSC)
ggsave("IYSC.jpg", plot = IYSC, width = 8, height = 6, dpi = 300)
```


#Alf forage year 1 summer
```{r}
#LINEAR 
modNXSA<-lmer(PlotAlfDryKgHa~N*P*CROP + (1|P:Rep), data=NdXSA)
anova(modNXSA)
#Check assumptions
NXSA_resid<-resid(modNXSA)
qqnorm(NXSA_resid)
qqline(NXSA_resid)
plot(modNXSA)
#log transform
modNXSA1<-lmer(log(PlotAlfDryKgHa)~N*P*CROP + (1|P:Rep), data=NdXSA)
anova(modNXSA1)
summary(modNXSA1)
# normal is better
emtrends(modNXSA, ~P*CROP, var= "N")
emtrends(modNXSA, ~1, var= "N", infer= TRUE) #(averages 8 slopes across interactions)
emmip(modNXSA, P~N|CROP, at=list(N=c(40, 80, 120)))

modNXSA1_summary <- summary(modNXSA)
modNXSA1_coeff <- as.data.frame(modNXSA1_summary$coefficients)%>%
  filter(`Pr(>|t|)` < 0.05)
rownames(modNXSA1_coeff)[2]<-"MN"
rownames(modNXSA1_coeff)[3]<-"WI"
rownames(modNXSA1_coeff)[4]<-"monoculture"
rownames(modNXSA1_coeff)[5]<-"WI:monoculture"
colnames(modNXSA1_coeff)[5]<-"Pr(>t)"
# Create custom table using kable and kableExtra
knitr::kable(modNXSA1_coeff, caption = "Mixed-Effects Model: AlfalfaForageKgHa ~ Nrate * Location * CROPsystem + (1 | Rep)") %>%
  kable_styling(full_width = TRUE, position = "center", bootstrap_options = c("striped", "hover", "condensed"))



#rec
modNXSA1N<-lmer(log(PlotAlfDryKgHa)~N+P*CROP + (1|P:Rep), data=NdXSA)
emtrends(modNXSA1N, ~1, var= "N", infer= TRUE)
emmip(modNXSA1N, P~N|CROP, at=list(N=c(0, 80, 160)))

#Check assumptions
NXSA1_resid<-resid(modNXSA1)
qqnorm(NXSA1_resid)
qqline(NXSA1_resid)
plot(modNXSA1)


max(NdXSA$PlotAlfDryKgHa)
#linear plots
NdXSA$predicted <- predict(modNXSA, newdata = NdXSA, re.form = NA)
ggplot(NdXSA, aes(x = N, y = PlotAlfDryKgHa, color = C, group= C)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Alf Forage Yield (Kg/ha)") +  # Label the axes
  ggtitle("Yr 1 S Relationship between Alf Forage Yield and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(0, 11000) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors

#Threeway means
NXSA1emm <- compute_emmeansNXS("modNXSA")

#Pairwise P
emmsP <- emmeans(modNXSA, ~ P, type = "response") # Obtain estimated marginal means
cld_dataNXSAP <- cld(emmsP, Letters=custom_letters) # Create compact letter display
#Pairwise C
emmsC <- emmeans(modNXSA, ~ CROP, type = "response") # Obtain estimated marginal means 
cld_dataNXSAC <- cld(emmsC, Letters=custom_letters) # Create compact letter display
#Pairwise N
N_levels <- c(0, 40, 80, 120, 160)
emmsN <- emmeans(modNXSA, specs = ~ N, at = list(N = N_levels), type = "response")
cld_dataNXSAN <- cld(emmsN, Letters=custom_letters) # Create compact letter display
cld_dataNXSAN$response <- format(cld_dataNXSAN$response, digits = 5)
cld_dataNXSAN<- cld_dataNXSAN %>%
  select(N, response, .group)
colnames(cld_dataNXSAN) <- c("N","IWG Forage (kg ha-1)", "Group")
cld_dataNXSAN  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise P:C
emmsPC <- emmeans(modNXSA, ~ P*CROP, type= "response") # Obtain estimated marginal means
cld_dataNXSAPC <- cld(emmsPC, Letters=custom_letters) # Create compact letter display
cld_dataNXSAPC$response <- format(cld_dataNXSAPC$response, digits = 5)
rownames(cld_dataNXSAPC) <- NULL
cld_dataNXSAPC<- cld_dataNXSAPC %>%
  select(P,CROP, response, .group)
colnames(cld_dataNXSAPC) <- c("Site","Cropping System","Alfalfa Forage (kg ha-1)", "Group")
cld_dataNXSAPC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

#This gives us the slope for each interactions as well as a P value indicating significance level for that slope
emtrends(modNXSA,~ P*CROP, var= "N", infer=TRUE)
emtrends(modNXSA,~ P, var= "N", infer=TRUE)
emtrends(modNXSA,~ CROP, var= "N", infer=TRUE)
emtrends(modNXSA,~N, var= "N", infer=TRUE)
summary(modNXSA)
emtrends(modNXSA,~ P, var= "N", infer=TRUE)

summary(modNXSA)

#EQUATION tables JUST N 
emtrends_result<-emtrends(modNXSA,~ 1, var= "N", infer=TRUE)
emtrends_df <- as.data.frame(emtrends_result)
emmeans_results<-emmeans(modNXSA, ~1, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
emtrends_df <- emtrends_df %>% mutate(key = 1)
emmeans_df <- emmeans_df %>% mutate(key = 1)
merged_df <- inner_join(emtrends_df, emmeans_df, by = "key")%>%
  select(emmean, N.trend, SE.x)
#view(merged_df)
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
#view(new_df)
```

#Alf forage figure E:C (XS)
```{r}
max(NdXSA$predicted)
exp(9.08082)
XSAemmsPC <- emmeans(modNXSA1, ~ P*C, type = "response") # Obtain estimated marginal means (excluding N)
emms_df <- as.data.frame(XSAemmsPC)
cld_dataXSAPC <- cld(XSAemmsPC, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataXSAPC)
merged_df <- merge(emms_df, cld_df,by = c("P", "C"))
custom_labels <- c("Intercrop", "Monoculture Alfalfa")
custom_colors <- c("darkmagenta", "coral1") 
AXSPC<-ggplot(NdXSA, aes(x = P, y = exp(predicted), color = C)) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7) +
  labs(x = "Environment", y = "Alfalfa Forage Yield") +
  geom_point(data = emms_df, aes(x = P, y = response), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 2)+
  scale_color_manual(name = "Cropping System", labels = custom_labels,values = custom_colors)+
     ggtitle("Year 1 Summer")+
  theme(plot.title = element_text(hjust = 0.5))+
   guides(color = "none")+
  scale_y_continuous(breaks = c(1000, 3000, 5000, 7000,9000), limits = c(0, 9500))

print(AXSPC)
```

#Alf forage year 1 fall
```{r}
#LINEAR
modNXFA<-lmer(PlotAlfDryKgHa~N*P*CROP + (1|Rep), data=NdXFA)
anova(modNXFA)
#Check assumptions
NXFA_resid<-resid(modNXFA)
qqnorm(NXFA_resid)
qqline(NXFA_resid)
plot(modNXFA)
#log transform
modNXFA1<-lmer(log(PlotAlfDryKgHa)~N*P*CROP + (1|Rep), data=NdXFA)
anova(modNXFA1)
#Check assumptions
NXFA1_resid<-resid(modNXFA1)
qqnorm(NXFA1_resid)
qqline(NXFA1_resid)
plot(modNXFA1)

modNXFA1_summary <- summary(modNXFA1)
modNXFA1_coeff <- as.data.frame(modNXFA1_summary$coefficients)%>%
  filter(`Pr(>|t|)` < 0.05)
rownames(modNXFA1_coeff)[2]<-"NY"
rownames(modNXFA1_coeff)[3]<-"WI"
rownames(modNXFA1_coeff)[4]<-"monoculture"
rownames(modNXFA1_coeff)[5]<-"WI:monoculture"
colnames(modNXFA1_coeff)[5]<-"Pr(>t)"
# Create custom table using kable and kableExtra
knitr::kable(modNXFA1_coeff, caption = "Mixed-Effects Model: AlfalfaForageKgHa ~ Nrate * Location * CROPsystem + (1 | Rep)") %>%
  kable_styling(full_width = TRUE, position = "center", bootstrap_options = c("striped", "hover", "condensed"))



max(NdXFA$PlotAlfDryKgHa)
#linear plots
NdXFA$predicted <- predict(modNXFA1, newdata = NdXFA, re.form = NA)
ggplot(NdXFA, aes(x = N, y = PlotAlfDryKgHa, color = C, group= C)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Alf Forage Yield (Kg/ha)") +  # Label the axes
  ggtitle("Yr 1 F Relationship between Alf Forage Yield and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(0, 3300) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors

#Threeway means
NXFA1emm <- compute_emmeansNXF("modNXFA1")

#Pairwise P
emmsP <- emmeans(modNXFA1, ~ P, type = "response") # Obtain estimated marginal means
cld_dataNXFAP <- cld(emmsP, Letters=custom_letters) # Create compact letter display
#Pairwise P:C
emmsPC <- emmeans(modNXFA1, ~ P*CROP, type= "response") # Obtain estimated marginal means
cld_dataNXFAPC <- cld(emmsPC, Letters=custom_letters) # Create compact letter display
cld_dataNXFAPC$response <- format(cld_dataNXFAPC$response, digits = 5)
rownames(cld_dataNXFAPC) <- NULL
cld_dataNXFAPC<- cld_dataNXFAPC %>%
  select(P,CROP, response, .group)
colnames(cld_dataNXFAPC) <- c("Site","Cropping System","IWG Forage (kg ha-1)", "Group")
cld_dataNXFAPC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

emtrends_result<-emtrends(modNXFA1,~ 1, var= "N", infer=TRUE)
emtrends_df <- as.data.frame(emtrends_result)
emmeans_results<-emmeans(modNXFA1, ~1, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
emtrends_df <- emtrends_df %>% mutate(key = 1)
emmeans_df <- emmeans_df %>% mutate(key = 1)
merged_df <- inner_join(emtrends_df, emmeans_df, by = "key")%>%
  select(emmean, N.trend, SE.x)
view(merged_df)
```
#Alf forage figure E:C (XF)
```{r}
XFAemmsPC <- emmeans(modNXFA1, ~ P*C, type = "response") # Obtain estimated marginal means (excluding N)
emms_df <- as.data.frame(XFAemmsPC)
cld_dataXFAPC <- cld(XFAemmsPC, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataXFAPC)
merged_df <- merge(emms_df, cld_df,by = c("P", "C"))
custom_labels <- c("Intercrop", "Monoculture Alfalfa")
custom_colors <- c("darkmagenta", "coral1") 
AXFPC<-ggplot(NdXFA, aes(x = P, y = exp(predicted), color = C)) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7) +
  labs(x = "Environment", y = "Alfalfa Forage Yield") +
  geom_point(data = emms_df, aes(x = P, y = response), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 2)+
  scale_color_manual(name = "Cropping System", labels = custom_labels,values = custom_colors)+
     ggtitle("Year 1 Fall")+
  theme(plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(breaks = c(1000, 3000, 5000, 7000,9000), limits = c(0, 9500))

print(AXFPC)
```
#Alf forage combo plot E:C
```{r}
AEC<-grid.arrange(AXSPC, AXFPC, ncol = 2)
ggsave("AEC.jpg", plot = AEC, width =12, height = 6, dpi = 350)
```

#Alf forage year 2 summer
```{r}
# remove MN plot 1222, it only has 0 for values
NdYSA <- NdYSA %>%
  filter(Plot != 1222)

#LINEAR 
modNYSA<-lmer(PlotAlfDryKgHa~N*P*CROP + (1|Rep), data=NdYSA)
anova(modNYSA)
#Check assumptions
NYSA_resid<-resid(modNYSA)
qqnorm(NYSA_resid)
qqline(NYSA_resid)
plot(modNYSA)
#Logtransform
modNYSA1<-lmer(log(PlotAlfDryKgHa)~N*P*CROP + (1|Rep), data=NdYSA)
anova(modNYSA1)
#check assumptions logtransform
NYSA_resid1<-resid(modNYSA1)
qqnorm(NYSA_resid1)
qqline(NYSA_resid1)
plot(modNYSA1)

modNYSA1_summary <- summary(modNYSA)
modNYSA1_coeff <- as.data.frame(modNYSA1_summary$coefficients)%>%
  filter(`Pr(>|t|)` < 0.05)
rownames(modNYSA1_coeff)[2]<-"Nrate"
rownames(modNYSA1_coeff)[3]<-"KS"
rownames(modNYSA1_coeff)[4]<-"monoculture"
rownames(modNYSA1_coeff)[5]<-"Nrate:KS"
colnames(modNYSA1_coeff)[5]<-"Pr(>t)"
# Create custom table using kable and kableExtra
knitr::kable(modNYSA1_coeff, caption = "Mixed-Effects Model: AlfalfaForageKgHa ~ Nrate * Location * CROPsystem + (1 | Rep)") %>%
  kable_styling(full_width = TRUE, position = "center", bootstrap_options = c("striped", "hover", "condensed"))

#here
max(NdYSA$PlotAlfDryKgHa)
#LINEAR plots
NdYSA$predicted <- predict(modNYSA1, newdata = NdYSA, re.form = NA)
ggplot(NdYSA, aes(x = N, y = PlotAlfDryKgHa, color = CROP, group= CROP)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Alf Forage Yield (Kg/ha)") +  # Label the axes
  ggtitle("Yr 2 S Relationship between Alf Forage Yield and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(0, 6000) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors

#Threeway means
NYSA1emm <- compute_emmeansNYS("modNYSA")

#Pairwise P
emmsP <- emmeans(modNYSA, ~ P, type = "response") # Obtain estimated marginal means (excluding N)
cld_dataNYSAP <- cld(emmsP, Letters=custom_letters) # Create compact letter display
cld_dataNYSAP$response <- format(cld_dataNYSAP$response, digits = 5)
rownames(cld_dataNYSAP) <- NULL
cld_dataNYSAP<- cld_dataNYSAP %>%
  select(P, response, .group)
colnames(cld_dataNYSAP) <- c("Site","IWG Forage (kg ha-1)", "Group")
cld_dataNYSAP  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise C
emmsC <- emmeans(modNYSA, ~ CROP, type = "response") # Obtain estimated marginal means (excluding N)
cld_dataNYSAC <- cld(emmsC, Letters=custom_letters) # Create compact letter display
#Pairwise N:C
emmsNC <- emmeans(modNYSA, ~ N*CROP,at = list(N = N_levels), type= "response") # Obtain estimated marginal means
cld_dataNYSANC <- cld(emmsNC, Letters=custom_letters) # Create compact letter display
cld_dataNYSANC$response <- format(cld_dataNYSANC$response, digits = 5)
rownames(cld_dataNYSANC) <- NULL
cld_dataNYSANC<- cld_dataNYSANC %>%
  select(N,CROP, response, .group)
colnames(cld_dataNYSANC) <- c("N","Cropping System","Alfalfa Forage (kg ha-1)", "Group")
cld_dataNYSANC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

#slope stuff
emtrends_result<-emtrends(modNYSA,~ CROP, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  desired_order_C <- c("intercrop", "monoculture")
  emtrends_df$C <- factor(emtrends_df$C, levels = desired_order_C)
  #view(emtrends_df)
  
#equations table
emtrends_result<-emtrends(modNYSA,~ CROP, var= "N", infer=TRUE)
emtrends_df <- as.data.frame(emtrends_result)
emmeans_results<-emmeans(modNYSA, ~CROP, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
merged_df <- emtrends_df %>%
  inner_join(emmeans_df, by = c( "CROP")) %>%
  select(CROP, emmean, N.trend, SE.x)
#view(merged_df)
merged_df$CROP <- factor(merged_df$C, levels = c("intercrop", "monoculture"))  # Preferred order for CROP
# Create a new data frame with the calculated column
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
sorted_df <- new_df %>%
  arrange( CROP)
#view(sorted_df)
```

#Alf forage year 2 fall
```{r}
#LINEAR
modNYFA<-lmer(PlotAlfDryKgHa~N*P*CROP + (1|Rep), data=NdYFA)
anova(modNYFA)
#Check assumptions
NYFA_resid<-resid(modNYFA)
qqnorm(NYFA_resid)
qqline(NYFA_resid)
plot(modNYFA)
#log transform 
modNYFA1<-lmer(log(PlotAlfDryKgHa)~N*P*CROP + (1|Rep), data=NdYFA)
anova(modNYFA1)
#Check assumptions
NYFA1_resid<-resid(modNYFA1)
qqnorm(NYFA1_resid)
qqline(NYFA1_resid)
plot(modNYFA1)

modNYFA_summary <- summary(modNYFA)
modNYFA_coeff <- as.data.frame(modNYFA_summary$coefficients)%>%
  filter(`Pr(>|t|)` < 0.05)
rownames(modNYFA_coeff)[2]<-"Nrate"
rownames(modNYFA_coeff)[3]<-"Nrate:monoculture"
colnames(modNYFA_coeff)[5]<-"Pr(>t)"
# Create custom table using kable and kableExtra
knitr::kable(modNYFA_coeff, caption = "Mixed-Effects Model: AlfalfaForageKgHa ~ Nrate * Location * CROPsystem + (1 | Rep)") %>%
  kable_styling(full_width = TRUE, position = "center", bootstrap_options = c("striped", "hover", "condensed"))



max(NdYFA$PlotAlfDryKgHa)
#LINEAR plots
NdYFA$predicted <- predict(modNYFA1, newdata = NdYFA, re.form = NA)
ggplot(NdYFA, aes(x = N, y = PlotAlfDryKgHa, color = C, group= C)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Alf Forage Yield (Kg/ha)") +  # Label the axes
  ggtitle("Yr 2 F Relationship between Alf Forage Yield and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(0, 2700) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors

#Threeway means
NYFA1emm <- compute_emmeansNYF("modNYFA1")

#Pairwise N
emmsN <- emmeans(modNYFA1, ~ N,at = list(N = N_levels), type= "response") # Obtain estimated marginal means
cld_dataNYFAN <- cld(emmsN, Letters=custom_letters) # Create compact letter display
#Pairwise N:C
emmsNC <- emmeans(modNYFA1, ~ N*CROP,at = list(N = N_levels), type= "response") # Obtain estimated marginal means
cld_dataNYFANC <- cld(emmsNC, Letters=custom_letters) # Create compact letter display
cld_dataNYFANC$response <- format(cld_dataNYFANC$response, digits = 5)
rownames(cld_dataNYFANC) <- NULL
cld_dataNYFANC<- cld_dataNYFANC %>%
  select(N,CROP, response, .group)
colnames(cld_dataNYFANC) <- c("N","Cropping System","IWG Forage (kg ha-1)", "Group")
cld_dataNYFANC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

#slope stuff
emtrends_result<-emtrends(modNYFA1,~ CROP, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  desired_order_C <- c("intercrop", "monoculture")
  emtrends_df$C <- factor(emtrends_df$C, levels = desired_order_C)
  #view(emtrends_df)
  
  #equations table
emtrends_result<-emtrends(modNYFA1,~ CROP, var= "N", infer=TRUE)
emtrends_df <- as.data.frame(emtrends_result)
emmeans_results<-emmeans(modNYFA1, ~CROP, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
merged_df <- emtrends_df %>%
  inner_join(emmeans_df, by = c( "CROP")) %>%
  select(CROP, emmean, N.trend, SE.x)
#view(merged_df)
merged_df$C <- factor(merged_df$C, levels = c("intercrop", "monoculture"))  # Preferred order for CROP
# Create a new data frame with the calculated column
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
sorted_df <- new_df %>%
  arrange( C)
#view(sorted_df)
```

#Alf forage year 3 summer
```{r}
#LINEAR
modNZSA<-lmer(PlotAlfDryKgHa~N*P*CROP + (1|Rep), data=NdZSA)
anova(modNZSA)
#Check assumptions
NZSA_resid<-resid(modNZSA)
qqnorm(NZSA_resid)
qqline(NZSA_resid)
plot(NZSA_resid)
#log transform 
modNZSA1<-lmer(log(PlotAlfDryKgHa)~N*P*CROP + (1|Rep), data=NdZSA)
anova(modNZSA1)
#Check assumptions
NZSA1_resid<-resid(modNZSA1)
qqnorm(NZSA1_resid)
qqline(NZSA1_resid)
plot(modNZSA1)

modNZSA1_summary <- summary(modNZSA1)
modNZSA1_coeff <- as.data.frame(modNZSA1_summary$coefficients)%>%
  filter(`Pr(>|t|)` < 0.05)
rownames(modNZSA1_coeff)[2]<-"WI"
colnames(modNZSA1_coeff)[5]<-"Pr(>t)"
# Create custom table using kable and kableExtra
knitr::kable(modNZSA1_coeff, caption = "Mixed-Effects Model: AlfalfaForageKgHa ~ Nrate * Location * CROPsystem + (1 | Rep)") %>%
  kable_styling(full_width = TRUE, position = "center", bootstrap_options = c("striped", "hover", "condensed"))



max(NdZSA$PlotAlfDryKgHa)
#LINEAR plots
NdZSA$predicted <- predict(modNZSA1, newdata = NdZSA, re.form = NA)
ggplot(NdZSA, aes(x = N, y = PlotAlfDryKgHa, color = C, group= C)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Alf Forage Yield (Kg/ha)") +  # Label the axes
  ggtitle("Yr 3 S Relationship between Alf Forage Yield and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  #ylim(0, 2700) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors

#Threeway means
NZSA1emm <- compute_emmeansNZS("modNZSA1")

#Pairwise N
emmsN <- emmeans(modNYFA1, ~ N,at = list(N = N_levels), type= "response") # Obtain estimated marginal means
cld_dataNYFAN <- cld(emmsN, Letters=custom_letters) # Create compact letter display
#Pairwise N:C
emmsNC <- emmeans(modNYFA1, ~ N*CROP,at = list(N = N_levels), type= "response") # Obtain estimated marginal means
cld_dataNYFANC <- cld(emmsNC, Letters=custom_letters) # Create compact letter display
cld_dataNYFANC$response <- format(cld_dataNYFANC$response, digits = 5)
rownames(cld_dataNYFANC) <- NULL
cld_dataNYFANC<- cld_dataNYFANC %>%
  select(N,CROP, response, .group)
colnames(cld_dataNYFANC) <- c("N","Cropping System","IWG Forage (kg ha-1)", "Group")
cld_dataNYFANC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

#slope stuff
emtrends_result<-emtrends(modNYFA1,~ CROP, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  desired_order_C <- c("intercrop", "monoculture")
  emtrends_df$CROP <- factor(emtrends_df$CROP, levels = desired_order_C)
  #view(emtrends_df)
  
  #equations table
emtrends_result<-emtrends(modNYFA1,~ CROP, var= "N", infer=TRUE)
emtrends_df <- as.data.frame(emtrends_result)
emmeans_results<-emmeans(modNYFA1, ~CROP, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
merged_df <- emtrends_df %>%
  inner_join(emmeans_df, by = c( "CROP")) %>%
  select(CROP, emmean, N.trend, SE.x)
#view(merged_df)
merged_df$CROP <- factor(merged_df$CROP, levels = c("intercrop", "monoculture"))  # Preferred order for CROP
# Create a new data frame with the calculated column
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
sorted_df <- new_df %>%
  arrange( CROP)
#view(sorted_df)
```

#Alf forage year 3 fall
```{r}
# what does predict() do? is it working right? What should these values look like? 

class(NdZFA$N) # numeric
class(NdZFA$P) # factor
class(NdZFA$CROP) # character
NdZFA$CROP <- as.factor(NdZFA$CROP) # try as factor

# Trying to troubleshoot
NdZFA_NY <- NdZFA %>% filter(Location == "NY")
hist(NdZFA_NY$PlotAlfDryKgHa)
NdZFA_WI <- NdZFA %>% filter(Location == "WI")
hist(NdZFA_WI$PlotAlfDryKgHa)

# NY has two plots with 0 as the yield, try changing the 0s in NY to 1, when log transforming the 0s get set to NA which would mess up stuff
NdZFA[1,40] <- 1
NdZFA[30,40] <- 1
# didn't fix it

# how correlated values across sites or across treatment (any categorical variable)
# alf biomass in WI cor to alf biomass in NY
aov1 = aov(PlotAlfDryKgHa ~ P, data=NdZFA) # between locatiosn
summary(aov1)
cor(NdZFA_NY$PlotAlfDryKgHa,NdZFA_WI$PlotAlfDryKgHa)

# alf biomass in monoA cor to alf biomass in inter
NdZFA_mA <- NdZFA %>% filter(CROP == "monoA")
NdZFA_I <- NdZFA %>% filter(CROP == "inter")
aov2 = aov(PlotAlfDryKgHa ~ CROP, data=NdZFA) # between crops
summary(aov2)
cor(NdZFA_mA$PlotAlfDryKgHa,NdZFA_I$PlotAlfDryKgHa)

# alf biomass correlation in reps
aov3 = aov(PlotAlfDryKgHa ~ Rep, data=NdZFA) # between reps
summary(aov3)

# low correlation for locations, higher correlation for crop type (CROP) and Rep
# Could that correlation for Reps be the issue? 


#LINEAR
modNZFA<-lmer(PlotAlfDryKgHa~N*P*CROP + (1|Rep), data=NdZFA)
# boundary (singular) fit: see help('isSingular')
modNZFA<-lm(PlotAlfDryKgHa~N*P*CROP, data=NdZFA)
anova(modNZFA)
#Check assumptions
NZFA_resid<-resid(modNZFA)
qqnorm(NZFA_resid)
qqline(NZFA_resid)
plot(NZFA_resid)
#log transform 
modNZFA1<-lmer(log(PlotAlfDryKgHa)~N*P*CROP + (1|Rep), data=NdZFA)
# boundary (singular) fit: see help('isSingular')
modNZFA1<-lm(log(PlotAlfDryKgHa)~N*P*CROP, data=NdZFA)
# Error in lm.fit(x, y, offset = offset, singular.ok = singular.ok, ...) : NA/NaN/Inf in 'y'
modNZFA1<-lm(log(PlotAlfDryKgHa+0.0001)~N*P*CROP, data=NdZFA)

anova(modNZFA1)
#Check assumptions
NZFA1_resid<-resid(modNZFA1)
qqnorm(NZFA1_resid)
qqline(NZFA1_resid)
plot(modNZFA1)

modNZFA1_summary <- summary(modNZFA1)
modNZFA1_coeff <- as.data.frame(modNZFA1_summary$coefficients)%>%
  filter(`Pr(>|t|)` < 0.05)
rownames(modNZFA1_coeff)[2]<-"WI"
colnames(modNZFA1_coeff)[5]<-"Pr(>t)"
# Create custom table using kable and kableExtra
knitr::kable(modNZFA1_coeff, caption = "Mixed-Effects Model: AlfalfaForageKgHa ~ Nrate * Location * CROPsystem + (1 | Rep)") %>%
  kable_styling(full_width = TRUE, position = "center", bootstrap_options = c("striped", "hover", "condensed"))



max(NdZFA$PlotAlfDryKgHa)
#LINEAR plots
NdZFA$predicted <- predict(modNZFA1, newdata = NdZFA, re.form = NA)
ggplot(NdZFA, aes(x = N, y = PlotAlfDryKgHa, color = CROP, group= CROP)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Alf Forage Yield (Kg/ha)") +  # Label the axes
  ggtitle("Yr 3 F Relationship between Alf Forage Yield and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  #ylim(0, 2700) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors

#Threeway means
NZFA1emm <- compute_emmeansNZF("modNZFA1")

#Pairwise N
emmsN <- emmeans(modNZFA1, ~ N,at = list(N = N_levels), type= "response") # Obtain estimated marginal means
cld_dataNZFAN <- cld(emmsN, Letters=custom_letters) # Create compact letter display
#Pairwise N:C
emmsNC <- emmeans(modNZFA1, ~ N*CROP,at = list(N = N_levels), type= "response") # Obtain estimated marginal means
cld_dataNZFANC <- cld(emmsNC, Letters=custom_letters) # Create compact letter display
cld_dataNZFANC$response <- format(cld_dataNZFANC$response, digits = 5)
rownames(cld_dataNZFANC) <- NULL
cld_dataNZFANC<- cld_dataNZFANC %>%
  select(N,CROP, response, .group)
colnames(cld_dataNZFANC) <- c("N","Cropping System","IWG Forage (kg ha-1)", "Group")
cld_dataNZFANC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

#slope stuff
emtrends_result<-emtrends(modNZFA1,~ CROP, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  desired_order_C <- c("intercrop", "monoculture")
  emtrends_df$CROP <- factor(emtrends_df$CROP, levels = desired_order_C)
  #view(emtrends_df)
  
  #equations table
emtrends_result<-emtrends(modNZFA1,~ CROP, var= "N", infer=TRUE)
emtrends_df <- as.data.frame(emtrends_result)
emmeans_results<-emmeans(modNZFA1, ~CROP, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
merged_df <- emtrends_df %>%
  inner_join(emmeans_df, by = c( "CROP")) %>%
  select(CROP, emmean, N.trend, SE.x)
#view(merged_df)
merged_df$CROP <- factor(merged_df$CROP, levels = c("intercrop", "monoculture"))  # Preferred order for CROP
# Create a new data frame with the calculated column
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
sorted_df <- new_df %>%
  arrange( CROP)
#view(sorted_df)
```




#Alf forage plots N:C 
#HERE
```{r}
# Layer all the plots together!
colors <- c("Year 1 Summer Harvest" = "red", 
            "Year 1 Fall Harvest" = "green", 
            "Year 2 Summer Harvest" = "blue", 
            "Year 2 Fall Harvest" = "purple", 
            "Year 3 Summer Harvest" = "orange")
legend_order <- c("Year 1 Summer Harvest", "Year 1 Fall Harvest",
                  "Year 2 Summer Harvest", "Year 2 Fall Harvest",
                  "Year 3 Summer Harvest")
NdXSA$P <- factor(NdXSA$P, levels = desired_order)
NdYSA$P <- factor(NdYSA$P, levels = desired_order)
NdZSA$P <- factor(NdZSA$P, levels = desired_order)

max(NdXSA$PlotAlfDryKgHa)
max(NdXFA$PlotAlfDryKgHa)
max(NdYSA$PlotAlfDryKgHa)
max(NdYFA$PlotAlfDryKgHa)
max(NdZSA$PlotAlfDryKgHa)

AFcomboplot <- ggplot() +
  geom_line(data = NdXSA, aes(N, exp(predicted), color = "Year 1 Summer Harvest", linetype= CROP)) +
  geom_point(data = NdXSA, aes(x = N, y = PlotAlfDryKgHa, color = "Year 1 Summer Harvest", shape= CROP)) +
  geom_line(data = NdXFA, aes(N, exp(predicted), color = "Year 1 Fall Harvest", linetype= CROP)) +
  geom_point(data = NdXFA, aes(x = N, y = PlotAlfDryKgHa, color = "Year 1 Fall Harvest", shape= CROP)) +
  geom_line(data = NdYSA, aes(N, exp(predicted), color = "Year 2 Summer Harvest", linetype= CROP)) +
  geom_point(data = NdYSA, aes(x = N, y = PlotAlfDryKgHa, color = "Year 2 Summer Harvest", shape= CROP)) +
  geom_line(data = NdYFA, aes(N, exp(predicted), color = "Year 2 Fall Harvest", linetype= CROP)) +
  geom_point(data = NdYFA, aes(x = N, y = PlotAlfDryKgHa, color = "Year 2 Fall Harvest", shape= CROP)) +
  geom_line(data = NdZSA, aes(N, exp(predicted), color = "Year 3 Summer Harvest", linetype= CROP)) +
  geom_point(data = NdZSA, aes(x = N, y = PlotAlfDryKgHa, color = "Year 3 Summer Harvest", shape= CROP)) +
  geom_line(data = NdZFA, aes(N, exp(predicted), color = "Year 3 Fall Harvest", linetype= CROP)) +
  geom_point(data = NdZFA, aes(x = N, y = PlotAlfDryKgHa, color = "Year 3 Fall Harvest", shape= CROP)) +
  labs(x = "N-Rate (kg ha-1)", y = "Total Forage Yield",
       color = "Harvest", 
       linetype = "Cropping System", shape = "Cropping System") +
  ggtitle("Relationship Between Alfalfa Forage Yield and N-rate") +
  scale_x_continuous(breaks = c(0, 40, 80, 120, 160)) +
  ylim(0, 10000) +
  facet_wrap(~P, scales = "free", ncol = 2) +
  scale_color_manual(values = colors, limits = legend_order)+
  scale_shape_manual(values = c(4, 20, 25),labels = c("Intercropped", "Monoculture Alfalfa") )+
  scale_linetype_manual(values = c("inter" = "solid", "monoA" = "dotted"),labels = c("Intercropped", "Monoculture Alfalfa"))


print(AFcomboplot)


ggsave("AFcomboplotNC.jpg", plot = AFcomboplotNC, width = 8, height = 6, dpi = 300)
```
#alf forage plot N (XS)
```{r}
# Layer all the plots together!
colors <- c("Year 1 Summer Harvest" = "red", 
            "Year 1 Fall Harvest" = "green", 
            "Year 2 Summer Harvest" = "blue", 
            "Year 2 Fall Harvest" = "purple")
legend_order <- c("Year 1 Summer Harvest")

max(NdXSA$PlotAlfDryKgHa)
AFplotN <- ggplot() +
  geom_point(data = NdXSA, aes(x = N, y = PlotAlfDryKgHa, shape= C), color= "red") +
  labs(x = "N-Rate (kg ha-1)", y = "Alfalfa Forage Yield") +
  scale_x_continuous(breaks = c(0, 40, 80, 120, 160)) +
  ylim(0, 10500) +
  scale_shape_manual(values = c("intercrop" = 4, "monoculture" = 20), labels = c("Intercropped", "Monoculture Alfalfa")) +
  geom_function(data=NdXSA, fun=~4141.15*exp(-0.0009*.x),color='red')+
  guides(
    shape = guide_legend(title = "Cropping System"))
print(AFplotN)


#ggsave("AFplotN.jpg", plot = AFplotN, width = 8, height = 6, dpi = 300)
```
#Alf forage E plot (YS)
```{r}
NYSAemmsP <- emmeans(modNYSA1, ~ P, type = "response") 
emms_df <- as.data.frame(NYSAemmsP)
cld_dataNYSAP <- cld(NYSAemmsP, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataNYSAP)
merged_df <- merge(emms_df, cld_df,by = c("P"))
AE<-ggplot(NdYSA, aes(x = P, y = exp(predicted))) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7, color="darkgreen") +
  labs(x = "Environment", y = "Alfalfa Forage Yield") +
  geom_point(data = emms_df, aes(x = P, y = response), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 1.8)

print(AE)
ggsave("AE.jpg", plot = AE, width = 8, height = 6, dpi = 300)
```
***
forage quality stuff

#N RFV calculations 
```{r}
#IWG 
NdXSI$IWGRFV<-((88.9 - (0.779 * NdXSI$IWGADF)) * (120 / NdXSI$IWGaNDF) ) / 1.29
NdXFI$IWGRFV<-((88.9 - (0.779 * NdXFI$IWGADF)) * (120 / NdXFI$IWGaNDF) ) / 1.29
NdYSI$IWGRFV<-((88.9 - (0.779 * NdYSI$IWGADF)) * (120 / NdYSI$IWGaNDF) ) / 1.29
NdYFI$IWGRFV<-((88.9 - (0.779 * NdYFI$IWGADF)) * (120 / NdYFI$IWGaNDF) ) / 1.29


#REMOVE outliers KSY314I, KSY315I
#NdYSI<-NdYSI[-108,]
#NdYSI<-NdYSI[-108,]

#make big df for deltas 
NdXSIdf <- NdXSI %>%
  select(YearCode, Rep, P, CROP, N, Harvest, IWGRFV)
NdXFIdf <- NdXFI %>%
  select(YearCode, Rep, P, CROP, N, Harvest, IWGRFV)
NdYSIdf <- NdYSI %>%
  select(YearCode, Rep, P, CROP, N, Harvest, IWGRFV)
NdYFIdf <- NdYFI %>%
  select(YearCode, Rep, P, CROP, N, Harvest, IWGRFV)
NRFVIdf<-bind_rows(NdXSIdf, NdXFIdf)
NRFVIdf<-bind_rows(NRFVIdf, NdYSIdf)
NRFVIdf<-bind_rows(NRFVIdf, NdYFIdf)

#Alf
NdXSA$ALFaNDF<-as.numeric(NdXSA$ALFaNDF)
NdXFA$ALFaNDF<-as.numeric(NdXFA$ALFaNDF)
NdYSA$ALFaNDF<-as.numeric(NdYSA$ALFaNDF)
NdYFA$ALFaNDF<-as.numeric(NdYFA$ALFaNDF)

NdXSA$ALFRFV<-((88.9 - (0.779 * NdXSA$ALFADF)) * (120 / NdXSA$ALFaNDF) ) / 1.29
NdXFA$ALFRFV<-((88.9 - (0.779 * NdXFA$ALFADF)) * (120 / NdXFA$ALFaNDF) ) / 1.29
NdYSA$ALFRFV<-((88.9 - (0.779 * NdYSA$ALFADF)) * (120 / NdYSA$ALFaNDF) ) / 1.29
NdYFA$ALFRFV<-((88.9 - (0.779 * NdYFA$ALFADF)) * (120 / NdYFA$ALFaNDF) ) / 1.29

#REMOVE outliers KSX202A missing, KSX209A
#NdXSA<-NdXSA[-89,]
#NdXSA<-NdXSA[-93,]

#REMOVE NYS212A, NYS215A, NYS217A, NYS219A, NYS220A, NYS223A, NYS304A (some already gone... maybe a variety thing)
#NdYSA<-NdYSA[-16,]
#NdYSA<-NdYSA[-17,]
#NdYSA<-NdYSA[-18,]

#make big df for deltas 
NdXSAdf <- NdXSA %>%
  select(YearCode, Rep, P, CROP, N, Harvest, ALFRFV)
NdXFAdf <- NdXFA %>%
  select(YearCode, Rep, P, CROP, N, Harvest, ALFRFV)
NdYSAdf <- NdYSA %>%
  select(YearCode, Rep, P, CROP, N, Harvest, ALFRFV)
NdYFAdf <- NdYFA %>%
  select(YearCode, Rep, P, CROP, N, Harvest, ALFRFV)
NRFVAdf<-bind_rows(NdXSAdf, NdXFAdf)
NRFVAdf<-bind_rows(NRFVAdf, NdYSAdf)
NRFVAdf<-bind_rows(NRFVAdf, NdYFAdf)
```

#making proportion stuff for total FQ CP and RFV 
```{r}
#NEEDS TO JUST BE INTERCROPPED PLOTS BUT LIKE ALSO NEED TO COMPARE INTERCROP TO MONOCULTURE SOO LIKE .... WUT 
#make proportions
NdXSI$propI<-((NdXSI$PlotIWGDryKgHa)/(NdXSI$PlotTotForageKgHa))
NdXFI$propI<-((NdXFI$PlotIWGDryKgHa)/(NdXFI$PlotTotForageKgHa))
NdYSI$propI<-((NdYSI$PlotIWGDryKgHa)/(NdYSI$PlotTotForageKgHa))
NdYFI$propI<-((NdYFI$PlotIWGDryKgHa)/(NdYFI$PlotTotForageKgHa))

NdXSA$propA<-((NdXSA$PlotAlfDryKgHa)/(NdXSA$PlotTotForageKgHa))
NdXFA$propA<-((NdXFA$PlotAlfDryKgHa)/(NdXFA$PlotTotForageKgHa))
NdYSA$propA<-((NdYSA$PlotAlfDryKgHa)/(NdYSA$PlotTotForageKgHa))
NdYFA$propA<-((NdYFA$PlotAlfDryKgHa)/(NdYFA$PlotTotForageKgHa))

#make adjusted CP values 
NdXSI$propCPI<-(NdXSI$IWGCP)*(NdXSI$propI)
NdXFI$propCPI<-(NdXFI$IWGCP)*(NdXFI$propI)
NdYSI$propCPI<-(NdYSI$IWGCP)*(NdYSI$propI)
NdYFI$propCPI<-(NdYFI$IWGCP)*(NdYFI$propI)

NdXSA$propCPA<-(NdXSA$ALFCP)*(NdXSA$propA)
NdXFA$propCPA<-(NdXFA$ALFCP)*(NdXFA$propA)
NdYSA$propCPA<-(NdYSA$ALFCP)*(NdYSA$propA)
NdYFA$propCPA<-(NdYFA$ALFCP)*(NdYFA$propA)

#Somehow make CP totals
  #XS
NdXSj<- NdXSI %>%
  select(propCPI, N, P, CROP, Plot, Harvest, YearCode, Rep)
NdXSk<- NdXSA %>%
  select(propCPA, N, P, CROP, Plot, Harvest, YearCode, Rep)
NdXSf<- merge(NdXSj, NdXSk, by = c("N", "P", "CROP", "Plot", "Harvest", "YearCode", "Rep"), all = TRUE)
NdXSf[is.na(NdXSf)] <- 0
NdXSf$totCP<-((NdXSf$propCPI)+(NdXSf$propCPA))
  #XF
NdXFj<- NdXFI %>%
  select(propCPI, N, P, CROP, Plot, Harvest, YearCode, Rep)
NdXFk<- NdXFA %>%
  select(propCPA, N, P, CROP, Plot, Harvest, YearCode, Rep)
NdXFf<- merge(NdXFj, NdXFk, by = c("N", "P", "CROP", "Plot", "Harvest", "YearCode", "Rep"), all = TRUE)
NdXFf[is.na(NdXFf)] <- 0
NdXFf$totCP<-((NdXFf$propCPI)+(NdXFf$propCPA))
  #YS
NdYSj<- NdYSI %>%
  select(propCPI, N, P, CROP, Plot, Harvest, YearCode, Rep)
NdYSk<- NdYSA %>%
  select(propCPA, N, P, CROP, Plot, Harvest, YearCode, Rep)
NdYSf<- merge(NdYSj, NdYSk, by = c("N", "P", "CROP", "Plot", "Harvest", "YearCode", "Rep"), all = TRUE)
NdYSf[is.na(NdYSf)] <- 0
NdYSf$totCP<-((NdYSf$propCPI)+(NdYSf$propCPA))
  #YF
NdYFj<- NdYFI %>%
  select(propCPI, N, P, CROP, Plot, Harvest, YearCode, Rep)
NdYFk<- NdYFA %>%
  select(propCPA, N, P, CROP, Plot, Harvest, YearCode, Rep)
NdYFf<- merge(NdYFj, NdYFk, by = c("N", "P", "CROP", "Plot", "Harvest", "YearCode", "Rep"), all = TRUE)
NdYFf[is.na(NdYFf)] <- 0
NdYFf$totCP<-((NdYFf$propCPI)+(NdYFf$propCPA))


#make adjusted RFV values 
NdXSI$propRFVI<-(NdXSI$IWGRFV)*(NdXSI$propI)
NdXFI$propRFVI<-(NdXFI$IWGRFV)*(NdXFI$propI)
NdYSI$propRFVI<-(NdYSI$IWGRFV)*(NdYSI$propI)
NdYFI$propRFVI<-(NdYFI$IWGRFV)*(NdYFI$propI)

NdXSA$propRFVA<-(NdXSA$ALFRFV)*(NdXSA$propA)
NdXFA$propRFVA<-(NdXFA$ALFRFV)*(NdXFA$propA)
NdYSA$propRFVA<-(NdYSA$ALFRFV)*(NdYSA$propA)
NdYFA$propRFVA<-(NdYFA$ALFRFV)*(NdYFA$propA)

#Somehow make RFV totals
  #XS
NdXSm<- NdXSI %>%
  select(propRFVI, N, P, CROP, Plot, Harvest, YearCode, Rep)
NdXSn<- NdXSA %>%
  select(propRFVA, N, P, CROP, Plot, Harvest, YearCode, Rep)
NdXSo<- merge(NdXSm, NdXSn, by = c("N", "P", "CROP", "Plot", "Harvest", "YearCode", "Rep"), all = TRUE)
NdXSo[is.na(NdXSo)] <- 0
NdXSo$totRFV<-((NdXSo$propRFVI)+(NdXSo$propRFVA))
  #XF
NdXFm<- NdXFI %>%
  select(propRFVI, N, P, CROP, Plot, Harvest, YearCode, Rep)
NdXFn<- NdXFA %>%
  select(propRFVA, N, P, CROP, Plot, Harvest, YearCode, Rep)
NdXFo<- merge(NdXFm, NdXFn, by = c("N", "P", "CROP", "Plot", "Harvest", "YearCode", "Rep"), all = TRUE)
NdXFo[is.na(NdXFo)] <- 0
NdXFo$totRFV<-((NdXFo$propRFVI)+(NdXFo$propRFVA))
  #YS
NdYSm<- NdYSI %>%
  select(propRFVI, N, P, CROP, Plot, Harvest, YearCode, Rep)
NdYSn<- NdYSA %>%
  select(propRFVA, N, P, CROP, Plot, Harvest, YearCode, Rep)
NdYSo<- merge(NdYSm, NdYSn, by = c("N", "P", "CROP", "Plot", "Harvest", "YearCode", "Rep"), all = TRUE)
NdYSo[is.na(NdYSo)] <- 0
NdYSo$totRFV<-((NdYSo$propRFVI)+(NdYSo$propRFVA))
  #YF
NdYFm<- NdYFI %>%
  select(propRFVI, N, P, CROP, Plot, Harvest, YearCode, Rep)
NdYFn<- NdYFA %>%
  select(propRFVA, N, P, CROP, Plot, Harvest, YearCode, Rep)
NdYFo<- merge(NdYFm, NdYFn, by = c("N", "P", "CROP", "Plot", "Harvest", "YearCode", "Rep"), all = TRUE)
NdYFo[is.na(NdYFo)] <- 0
NdYFo$totRFV<-((NdYFo$propRFVI)+(NdYFo$propRFVA))
```

#IWG CP forage quality year 1 summer 
```{r}
modNICPFQXS<-lmer(IWGCP~ N*P*C + (1|Rep), data=NdXSI)
anova(modNICPFQXS)
#Check Assumptions
NICPFQXS_resid<-resid(modNICPFQXS)
qqnorm(NICPFQXS_resid)
qqline(NICPFQXS_resid)
plot(modNICPFQXS)
#Try log 
#need to REMOVE a row because it has a 0 value and can't run log on that
#NdXSI1 <- NdXSI[-65, ]
modNICPFQXS1<-lmer(log(IWGCP)~ N*P*C + (1|Rep), data=NdXSI1)
anova(modNICPFQXS1)
NICPFQXS_resid1<-resid(modNICPFQXS1)
qqnorm(NICPFQXS_resid1)
qqline(NICPFQXS_resid1)
plot(modNICPFQXS1)

#pairwise
#Pairwise N:P
N_levels <- c(0, 40, 80, 120, 160)
emmsNP <- emmeans(modNICPFQXS1, specs = ~ N*P, at = list(N = N_levels), type = "response")
cld_dataNICPFQXS1NP <- cld(emmsNP, Letters=custom_letters) # Create compact letter display
cld_dataNICPFQXS1NP$response <- format(cld_dataNICPFQXS1NP$response, digits = 5)
rownames(cld_dataNICPFQXS1NP) <- NULL
cld_dataNICPFQXS1NP<- cld_dataNICPFQXS1NP %>%
  select(N, P, response, .group)
colnames(cld_dataNICPFQXS1NP) <- c("N","Site","IWG CP", "Group")
cld_dataNICPFQXS1NP  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise P:C
emmsPC <- emmeans(modNICPFQXS1, specs = ~ P*C, type = "response")
cld_dataNICPFQXS1PC <- cld(emmsPC, Letters=custom_letters) # Create compact letter display
cld_dataNICPFQXS1PC$response <- format(cld_dataNICPFQXS1PC$response, digits = 5)
rownames(cld_dataNICPFQXS1PC) <- NULL
cld_dataNICPFQXS1PC<- cld_dataNICPFQXS1PC %>%
  select(P, C, response, .group)
colnames(cld_dataNICPFQXS1PC) <- c("Site","Cropping System","IWG CP", "Group")
cld_dataNICPFQXS1PC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

#This gives us the slope for each interactions as well as a P value indicating significance level for that slope
emtrends_result<-emtrends(modNICPFQXS1,~ P*C, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  desired_order_P <- c("MN", "NY", "KS", "WI")
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
  #view(emtrends_df)
emtrends_result<-emtrends(modNICPFQXS1,~ P, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  desired_order_P <- c("MN", "NY", "KS", "WI")
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
  #view(emtrends_df)
emtrends_result<-emtrends(modNICPFQXS1,~ C, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  #view(emtrends_df)

  
   #equations table N:P
  emtrends_result<-emtrends(modNICPFQXS1,~ P, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  desired_order_P <- c("MN", "NY", "KS", "WI")
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
emmeans_results<-emmeans(modNICPFQXS1, ~P, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
merged_df <- emtrends_df %>%
  inner_join(emmeans_df, by = c("P")) %>%
  select(P, emmean, N.trend, SE.x)
view(merged_df)
merged_df$P <- factor(merged_df$P, levels = c("MN", "NY", "KS", "WI"))  # Preferred order for P
# Create a new data frame with the calculated column
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
sorted_df <- new_df %>%
  arrange(P)
view(sorted_df)
```
#IWG CP forage quality year 1 fall 
```{r}
modNICPFQXF<-lmer(IWGCP~ N*P*C + (1|Rep), data=NdXFI)
anova(modNICPFQXF)
#Check Assumptions
NICPFQXF_resid<-resid(modNICPFQXF)
qqnorm(NICPFQXF_resid)
qqline(NICPFQXF_resid)
plot(modNICPFQXF)
#Try log 
modNICPFQXF1<-lmer(log(IWGCP)~ N*P*C + (1|Rep), data=NdXFI)
anova(modNICPFQXF1)
NICPFQXF_resid1<-resid(modNICPFQXF1)
qqnorm(NICPFQXF_resid1)
qqline(NICPFQXF_resid1)
plot(modNICPFQXF1)

#pairwise comparisons 
#Pairwise C
emmsC <- emmeans(modNICPFQXF1, specs = ~ C, type = "response")
cld_dataNICPFQXFC <- cld(emmsC, Letters=custom_letters) # Create compact letter display
cld_dataNICPFQXFC$response <- format(cld_dataNICPFQXFC$response, digits = 5)
rownames(cld_dataNICPFQXFC) <- NULL
cld_dataNICPFQXFC<- cld_dataNICPFQXFC %>%
  select(C, response, .group)
colnames(cld_dataNICPFQXFC) <- c("Cropping System","IWG Forage (kg ha-1)", "Group")
cld_dataNICPFQXFC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise N:P
N_levels <- c(0, 40, 80, 120, 160)
emmsNP <- emmeans(modNICPFQXF1, specs = ~ N*P, at = list(N = N_levels), type = "response")
cld_dataNICPFQXF1NP <- cld(emmsNP, Letters=custom_letters) # Create compact letter display
cld_dataNICPFQXF1NP$response <- format(cld_dataNICPFQXF1NP$response, digits = 5)
rownames(cld_dataNICPFQXF1NP) <- NULL
cld_dataNICPFQXF1NP<- cld_dataNICPFQXF1NP %>%
  select(N, P, response, .group)
colnames(cld_dataNICPFQXF1NP) <- c("N","Site","IWG CP", "Group")
cld_dataNICPFQXF1NP  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

#slope stuff
emtrends_result<-emtrends(modNICPFQXF1,~ P, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  desired_order_P <- c("MN", "NY", "KS", "WI")
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
  #view(emtrends_df)
  
    #equations table N:P
  emtrends_result<-emtrends(modNICPFQXF1,~ P, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  desired_order_P <- c("MN", "NY", "KS", "WI")
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
emmeans_results<-emmeans(modNICPFQXF1, ~P, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
merged_df <- emtrends_df %>%
  inner_join(emmeans_df, by = c("P")) %>%
  select(P, emmean, N.trend, SE.x)
view(merged_df)
merged_df$P <- factor(merged_df$P, levels = c("MN", "NY", "KS", "WI"))  # Preferred order for P
# Create a new data frame with the calculated column
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
sorted_df <- new_df %>%
  arrange(P)
view(sorted_df) 
```
#IWG CP forage quality year 2 summer 
```{r}
modNICPFQYS<-lmer(IWGCP~ N*P*C + (1|Rep), data=NdYSI)
anova(modNICPFQYS)
#Check Assumptions
NICPFQYS_resid<-resid(modNICPFQYS)
qqnorm(NICPFQYS_resid)
qqline(NICPFQYS_resid)
plot(modNICPFQYS)
#Try log 
modNICPFQYS1<-lmer(log(IWGCP)~ N*P*C + (1|Rep), data=NdYSI)
anova(modNICPFQYS1)
NICPFQYS_resid1<-resid(modNICPFQYS1)
qqnorm(NICPFQYS_resid1)
qqline(NICPFQYS_resid1)
plot(modNICPFQYS1)

#Pairwise N:P
N_levels <- c(0, 40, 80, 120, 160)
emmsNP <- emmeans(modNICPFQYS1, specs = ~ N*P, at = list(N = N_levels), type = "response")
cld_dataNICPFQYS1NP <- cld(emmsNP, Letters=custom_letters) # Create compact letter display
cld_dataNICPFQYS1NP$response <- format(cld_dataNICPFQYS1NP$response, digits = 5)
rownames(cld_dataNICPFQYS1NP) <- NULL
cld_dataNICPFQYS1NP<- cld_dataNICPFQYS1NP %>%
  select(N,P, response, .group)
colnames(cld_dataNICPFQYS1NP) <- c("N","Site","IWG CP", "Group")
cld_dataNICPFQYS1NP  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise P:C
N_levels <- c(0, 40, 80, 120, 160)
emmsPC <- emmeans(modNICPFQYS1, specs = ~ P*C, at = list(N = N_levels), type = "response")
cld_dataNICPFQYS1PC <- cld(emmsPC, Letters=custom_letters) # Create compact letter display
cld_dataNICPFQYS1PC$response <- format(cld_dataNICPFQYS1PC$response, digits = 5)
rownames(cld_dataNICPFQYS1PC) <- NULL
cld_dataNICPFQYS1PC<- cld_dataNICPFQYS1PC %>%
  select(P, C, response, .group)
colnames(cld_dataNICPFQYS1PC) <- c("Site","Cropping System","IWG CP", "Group")
cld_dataNICPFQYS1PC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

#slope stuff
emtrends_result<-emtrends(modNICPFQYS1,~ P, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  desired_order_P <- c("MN", "NY", "KS", "WI")
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
  #view(emtrends_df)
  
  #equations table N:P
  emtrends_result<-emtrends(modNICPFQYS1,~ P, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  desired_order_P <- c("MN", "NY", "KS", "WI")
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
emmeans_results<-emmeans(modNICPFQYS1, ~P, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
merged_df <- emtrends_df %>%
  inner_join(emmeans_df, by = c("P")) %>%
  select(P, emmean, N.trend, SE.x)
view(merged_df)
merged_df$P <- factor(merged_df$P, levels = c("MN", "NY", "KS", "WI"))  # Preferred order for P
# Create a new data frame with the calculated column
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
sorted_df <- new_df %>%
  arrange(P)
view(sorted_df) 
```
#IWG CP forage quality year 2 fall 
```{r}
modNICPFQYF<-lmer(IWGCP~ N*P*C + (1|Rep), data=NdYFI)
anova(modNICPFQYF)
#Check Assumptions
NICPFQYF_resid<-resid(modNICPFQYF)
qqnorm(NICPFQYF_resid)
qqline(NICPFQYF_resid)
plot(modNICPFQYF)
#Try log 
modNICPFQYF1<-lmer(log(IWGCP)~ N*P*C + (1|Rep), data=NdYFI)
anova(modNICPFQYF1)
NICPFQYF_resid1<-resid(modNICPFQYF1)
qqnorm(NICPFQYF_resid1)
qqline(NICPFQYF_resid1)
plot(modNICPFQYF1)


#Pairwise N:P
N_levels <- c(0, 40, 80, 120, 160)
emmsNP <- emmeans(modNICPFQYF1, specs = ~ N*P, at = list(N = N_levels), type = "response")
cld_dataNICPFQYF1NP <- cld(emmsNP, Letters=custom_letters) # Create compact letter display
cld_dataNICPFQYF1NP$response <- format(cld_dataNICPFQYF1NP$response, digits = 5)
rownames(cld_dataNICPFQYF1NP) <- NULL
cld_dataNICPFQYF1NP<- cld_dataNICPFQYF1NP %>%
  select(N, P, response, .group)
colnames(cld_dataNICPFQYF1NP) <- c("N","Site","IWG CP", "Group")
cld_dataNICPFQYF1NP  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise N:C
N_levels <- c(0, 40, 80, 120, 160)
emmsNC <- emmeans(modNICPFQYF1, specs = ~ N*C, at = list(N = N_levels), type = "response")
cld_dataNICPFQYF1NC <- cld(emmsNC, Letters=custom_letters) # Create compact letter display
cld_dataNICPFQYF1NC$response <- format(cld_dataNICPFQYF1NC$response, digits = 5)
rownames(cld_dataNICPFQYF1NC) <- NULL
cld_dataNICPFQYF1NC<- cld_dataNICPFQYF1NC %>%
  select(N, C, response, .group)
colnames(cld_dataNICPFQYF1NC) <- c("N","Cropping System","IWG CP", "Group")
cld_dataNICPFQYF1NC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise P:C
emmsPC <- emmeans(modNICPFQYF1, specs = ~ P*C, type = "response")
cld_dataNICPFQYF1PC <- cld(emmsPC, Letters=custom_letters) # Create compact letter display

#This gives us the slope for each interactions as well as a P value indicating significance level for that slope
emtrends_result<-emtrends(modNICPFQYF1,~ P*C, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  desired_order_P <- c("MN", "NY", "KS", "WI")
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
  #view(emtrends_df)
emtrends_result<-emtrends(modNICPFQYF1,~ P, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  desired_order_P <- c("MN", "NY", "KS", "WI")
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
  #view(emtrends_df)
emtrends_result<-emtrends(modNICPFQYF1,~ C, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  #view(emtrends_df)
  
 #equations table N:C
emtrends_result<-emtrends(modNICPFQYF1,~ C, var= "N", infer=TRUE)
emtrends_df <- as.data.frame(emtrends_result)
emmeans_results<-emmeans(modNICPFQYF1, ~C, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
merged_df <- emtrends_df %>%
  inner_join(emmeans_df, by = c( "C")) %>%
  select(C, emmean, N.trend, SE.x)
view(merged_df)
merged_df$C <- factor(merged_df$C, levels = c("intercrop", "monoculture"))  # Preferred order for CROP
# Create a new data frame with the calculated column
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
sorted_df <- new_df %>%
  arrange( C)
view(sorted_df)

 #equations table N:P
  emtrends_result<-emtrends(modNTCPYF1,~ P, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  desired_order_P <- c("MN", "NY", "KS", "WI")
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
emmeans_results<-emmeans(modNTCPYF1, ~P, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
merged_df <- emtrends_df %>%
  inner_join(emmeans_df, by = c("P")) %>%
  select(P, emmean, N.trend, SE.x)
view(merged_df)
merged_df$P <- factor(merged_df$P, levels = c("MN", "NY", "KS", "WI"))  # Preferred order for P
# Create a new data frame with the calculated column
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
sorted_df <- new_df %>%
  arrange(P)
view(sorted_df)
```
#IWG CP combo plots N:E
```{r}
NdXSI1$predictedCP <- predict(modNICPFQXS1, newdata = NdXSI1, re.form = NA)
NdXFI$predictedCP <- predict(modNICPFQXF1, newdata = NdXFI, re.form = NA)
NdYSI$predictedCP <- predict(modNICPFQYS1, newdata = NdYSI, re.form = NA)
NdYFI$predictedCP <- predict(modNICPFQYF1, newdata = NdYFI, re.form = NA)

# Layer all the plots together!
colors <- c("Year 1 Summer Harvest" = "red", 
            "Year 1 Fall Harvest" = "green", 
            "Year 2 Summer Harvest" = "blue", 
            "Year 2 Fall Harvest" = "purple")
legend_order <- c("Year 1 Summer Harvest", "Year 1 Fall Harvest", 
                  "Year 2 Summer Harvest", "Year 2 Fall Harvest")
NdXSI1$P <- factor(NdXSI1$P, levels = desired_order)

max(NdXSI1$IWGCP)
max(NdXSI1$predictedCP)
max(NdXFI$IWGCP)
max(NdXFI$predictedCP)
max(NdYSI$IWGCP)
max(NdYSI$predictedCP)
max(NdYFI$IWGCP)
max(NdYFI$predictedCP)
ICPcomboplot <- ggplot() +
  geom_point(data = NdXSI1, aes(x = N, y = IWGCP, color = "Year 1 Summer Harvest", shape= C)) +
  geom_point(data = NdXFI, aes(x = N, y = IWGCP, color = "Year 1 Fall Harvest", shape= C)) +
  geom_point(data = NdYSI, aes(x = N, y = IWGCP, color = "Year 2 Summer Harvest", shape= C)) +
  geom_point(data = NdYFI, aes(x = N, y = IWGCP, color = "Year 2 Fall Harvest", shape= C)) +
  labs(x = "N-Rate (kg ha-1)", y = "IWG CP",
    color = "Harvest", shape = "Cropping System") +
  scale_x_continuous(breaks = c(0, 40, 80, 120, 160)) +
  ylim(0, 23) +
  facet_wrap(~P, scales = "free", ncol = 2) +
  scale_color_manual(values = colors, limits = legend_order)+
  scale_shape_manual(values = c(4, 25), labels = c("Intercropped", "Monoculture IWG"))+
    geom_function(data=subset(NdXSI1, P== "MN"), fun=~8.95*exp(0.0017*.x),color='red')+
  geom_function(data=subset(NdXSI1, P== "NY"), fun=~2.17*exp(0.0029*.x),color='red')+
  geom_function(data=subset(NdXSI1, P== "KS"), fun=~5.37*exp(0.0019*.x),color='red')+
  geom_function(data=subset(NdXSI1, P== "WI"), fun=~1.05*exp(0.0062*.x),color='red')+
  geom_function(data=subset(NdXFI, P== "MN"), fun=~16.99*exp(0.0001*.x),color='green')+
  geom_function(data=subset(NdXFI, P== "NY"), fun=~17.66*exp(-0.0008*.x),color='green')+
  geom_function(data=subset(NdXFI, P== "WI"), fun=~11.62*exp(0.0002*.x),color='green')+
  geom_function(data=subset(NdYSI, P== "NY"), fun=~4.97*exp(-0.0018*.x),color='blue')+
  geom_function(data=subset(NdYSI, P== "KS"), fun=~4.95*exp(0.0019*.x),color='blue')+
  geom_function(data=subset(NdYSI, P== "WI"), fun=~1.72*exp(0.0024*.x),color='blue')+
  geom_function(data=subset(NdYFI, P== "NY"), fun=~20.25*exp(-0.0004*.x),color='purple')+
  geom_function(data=subset(NdYFI, P== "WI"), fun=~17.04*exp(-0.0000*.x),color='purple')


print(ICPcomboplot)

ggsave("ICPcomboplot.jpg", plot = ICPcomboplot, width = 8, height = 6, dpi = 300)
```
#IWG CP N:C plot
```{r}
NdXSI1$predictedCP <- predict(modNICPFQXS1, newdata = NdXSI1, re.form = NA)
NdXFI$predictedCP <- predict(modNICPFQXF1, newdata = NdXFI, re.form = NA)
NdYSI$predictedCP <- predict(modNICPFQYS1, newdata = NdYSI, re.form = NA)
NdYFI$predictedCP <- predict(modNICPFQYF1, newdata = NdYFI, re.form = NA)

# Layer all the plots together!
colors <- c("Year 1 Summer Harvest" = "red", 
            "Year 1 Fall Harvest" = "green", 
            "Year 2 Summer Harvest" = "blue", 
            "Year 2 Fall Harvest" = "purple")
legend_order <- c("Year 2 Fall Harvest")
NdYFI$P <- factor(NdYFI$P, levels = desired_order)


max(NdYFI$IWGCP)
IWGCPcomboplotNC <- ggplot() +
  geom_point(data =NdYFI, aes(x = N, y = IWGCP, color = "Year 2 Fall Harvest", shape= CROP)) +
  labs(x = "N-Rate (kg ha-1)", y = "Total CP",
    color = "Harvest", shape = "Cropping System") +
  scale_x_continuous(breaks = c(0, 40, 80, 120, 160)) +
  ylim(0, 25) +
  scale_color_manual(values = colors, limits = legend_order)+
  scale_shape_manual(values = c(4, 25),labels = c("Intercropped", "Monoculture IWG") )+
   geom_function(data=subset(NdYFI, C== "intercrop"), fun=~19.07*exp(-0.0003*.x),color='purple', linetype = "solid")+
     geom_function(data=subset(NdYFI, C== "monoculture"), fun=~15.31*exp(-0.0007*.x),color='purple', linetype = "dashed")+
  geom_line(aes(x = c(0, 0), y = c(0, 0), linetype = "Intercropped")) +
  geom_line(aes(x = c(0, 0), y = c(0, 0), linetype = "Monoculture IWG"))+
  scale_linetype_manual(name = "Cropping System", values = c("solid", "dashed"), labels = c("Intercropped", "Monoculture IWG")) +
  guides(linetype = guide_legend(override.aes = list(color = 'black'), title= "Line Type"))
  

print(IWGCPcomboplotNC)

ggsave("IWGCPcomboplotNC.jpg", plot =IWGCPcomboplotNC, width = 8, height = 6, dpi = 300)
```
#IWG CP E:C plots (XS and YS)
```{r}
#XS
max(NdXSI1$predictedCP)
exp(2.502587)
ICPXSemmsPC <- emmeans(modNICPFQXS1, ~ P*C, type = "response") # Obtain estimated marginal means (excluding N)
emms_df <- as.data.frame(ICPXSemmsPC)
cld_dataICPXSPC <- cld(ICPXSemmsPC, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataICPXSPC)
merged_df <- merge(emms_df, cld_df,by = c("P", "C"))
custom_labels <- c("Intercrop",  "Monoculture IWG")
custom_colors <- c("darkmagenta", "cyan") 
ICPXSPC<-ggplot(NdXSI1, aes(x = P, y = exp(predictedCP), color = C)) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7) +
  labs(x = "Environment", y = "IWG Crude Protein") +
  geom_point(data = emms_df, aes(x = P, y = response), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 2)+
  scale_color_manual(name = "Cropping System", labels = custom_labels,values = custom_colors)+
     ggtitle("Year 1 Fall")+
  theme(plot.title = element_text(hjust = 0.5))+
   guides(color = "none")+
  scale_y_continuous(breaks = c(2, 4,6,8,10,12), limits = c(0, 13))

print(ICPXSPC)

#YS
ICPYSemmsPC <- emmeans(modNICPFQYS1, ~ P*C, type = "response") # Obtain estimated marginal means (excluding N)
emms_df <- as.data.frame(ICPYSemmsPC)
cld_dataICPYSPC <- cld(ICPYSemmsPC, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataICPYSPC)
merged_df <- merge(emms_df, cld_df,by = c("P", "C"))
custom_labels <- c("Intercrop",  "Monoculture IWG")
custom_colors <- c("darkmagenta", "cyan") 
ICPYSPC<-ggplot(NdYSI, aes(x = P, y = exp(predictedCP), color = C)) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7) +
  labs(x = "Environment", y = "IWG Crude Protein") +
  geom_point(data = emms_df, aes(x = P, y = response), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 2)+
  scale_color_manual(name = "Cropping System", labels = custom_labels,values = custom_colors)+
     ggtitle("Year 2 Fall")+
  theme(plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(breaks = c(2, 4,6,8,10,12), limits = c(0, 13))

print(ICPYSPC)


ICPEC<-grid.arrange(ICPXSPC, ICPYSPC, ncol = 2)
ggsave("ICPEC.jpg", plot = ICPEC, width =12, height = 6, dpi = 350)
```
#IWG CP forage C plot (XF)
```{r}
custom_labels <- c("Intercrop", "Monoculture IWG")
custom_colors <- c("darkmagenta", "cyan") 
NXFICPemmsC <- emmeans(modNICPFQXF1, ~ C, type = "response") 
emms_df <- as.data.frame(NXFICPemmsC)
cld_dataNXFICPC <- cld(NXFICPemmsC, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataNXFICPC)
merged_df <- merge(emms_df, cld_df,by = c("C"))
ICPXFC<-ggplot(NdXFI, aes(x = C, y = exp(predictedCP), color= C)) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7) +
  labs(x = "Cropping System", y = "IWG CP") +
  ggtitle("Year 1 Fall")+
  geom_point(data = emms_df, aes(x = C, y = response), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = C, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = C, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 1.8)+
  scale_color_manual(name = "Cropping System", labels = custom_labels,values = custom_colors)

print(ICPXFC)
ggsave("ICPXFC.jpg", plot = ICPXFC, width = 8, height = 6, dpi = 300)
```


#example
```{r}
#log(g)= 123 + 23N
#g= exp(123) * log(23N) 

#write about it as a % increase (see blue notes)
#intercept= value at 0.. 
#use backtransformed equation
#figure out how * affects interpretatioin of equation... 
```


#IWG RFV forage quality year 1 summer 
```{r}
modNIRFVFQXS<-lmer(IWGRFV~ N*P*C + (1|Rep), data=NdXSI)
anova(modNIRFVFQXS)
#Check Assumptions
NIRFVFQXS_resid<-resid(modNIRFVFQXS)
qqnorm(NIRFVFQXS_resid)
qqline(NIRFVFQXS_resid)
plot(modNIRFVFQXS)
#Try log 
modNIRFVFQXS1<-lmer(log(IWGRFV)~ N*P*C + (1|Rep), data=NdXSI)
summary(modNIRFVFQXS1)
anova(modNIRFVFQXS1)
NIRFVFQXS_resid1<-resid(modNIRFVFQXS1)
qqnorm(NIRFVFQXS_resid1)
qqline(NIRFVFQXS_resid1)
plot(modNIRFVFQXS1)

#Pairwise N
N_levels <- c(0, 40, 80, 120, 160)
emmsN <- emmeans(modNIRFVFQXS1, specs = ~ N, at = list(N = N_levels), type = "response")
cld_dataNIRFVFQXS1N <- cld(emmsN, Letters=custom_letters) # Create compact letter display
cld_dataNIRFVFQXS1N$response <- format(cld_dataNIRFVFQXS1N$response, digits = 5)
rownames(cld_dataNIRFVFQXS1N) <- NULL
cld_dataNIRFVFQXS1N<- cld_dataNIRFVFQXS1N %>%
  select(N, response, .group)
colnames(cld_dataNIRFVFQXS1N) <- c("N","IWG RFV", "Group")
cld_dataNIRFVFQXS1N  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise P:C
emmsPC <- emmeans(modNIRFVFQXS1, specs = ~ P*C, type = "response")
cld_dataNIRFVFQXS1PC<- cld(emmsPC, Letters=custom_letters) # Create compact letter display
cld_dataNIRFVFQXS1PC$response <- format(cld_dataNIRFVFQXS1PC$response, digits = 5)
rownames(cld_dataNIRFVFQXS1PC) <- NULL
cld_dataNIRFVFQXS1PC<- cld_dataNIRFVFQXS1PC %>%
  select( P, C, response, .group)
colnames(cld_dataNIRFVFQXS1PC) <- c( "Site","Cropping System", "IWG RFV", "Group")
cld_dataNIRFVFQXS1PC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

#This gives us the slope for each interactions as well as a P value indicating significance level for that slope
emtrends_result<-emtrends(modNIRFVFQXS1,~ P*C, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  desired_order_P <- c("MN", "NY", "KS", "WI")
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
  #view(emtrends_df)
emtrends_result<-emtrends(modNIRFVFQXS1,~ P, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  desired_order_P <- c("MN", "NY", "KS", "WI")
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
  #view(emtrends_df)
emtrends_result<-emtrends(modNIRFVFQXS1,~ C, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  #view(emtrends_df)
  
  #EQUATION tables JUST N 
emtrends_result<-emtrends(modNIRFVFQXS1,~ 1, var= "N", infer=TRUE)
emtrends_df <- as.data.frame(emtrends_result)
emmeans_results<-emmeans(modNIRFVFQXS1, ~1, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
emtrends_df <- emtrends_df %>% mutate(key = 1)
emmeans_df <- emmeans_df %>% mutate(key = 1)
merged_df <- inner_join(emtrends_df, emmeans_df, by = "key")%>%
  select(emmean, N.trend, SE.x)
view(merged_df)
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
view(new_df)
```
#IWG RFV forage quality year 1 fall 
```{r}
modNIRFVFQXF<-lmer(IWGRFV~ N*P*C + (1|Rep), data=NdXFI)
anova(modNIRFVFQXF)
#Check Assumptions
NIRFVFQXF_resid<-resid(modNIRFVFQXF)
qqnorm(NIRFVFQXF_resid)
qqline(NIRFVFQXF_resid)
plot(modNIRFVFQXF)
#Try log 
modNIRFVFQXF1<-lmer(log(IWGRFV)~ N*P*C + (1|Rep), data=NdXFI)
anova(modNIRFVFQXF1)
NIRFVFQXF_resid1<-resid(modNIRFVFQXF1)
qqnorm(NIRFVFQXF_resid1)
qqline(NIRFVFQXF_resid1)
plot(modNIRFVFQXF1)

#Pairwise C
emmsC <- emmeans(modNIRFVFQXF1, specs = ~ C, type = "response")
cld_dataNIRFVFQXF1C <- cld(emmsC, Letters=custom_letters) # Create compact letter display
cld_dataNIRFVFQXF1C$response <- format(cld_dataNIRFVFQXF1C$response, digits = 5)
rownames(cld_dataNIRFVFQXF1C) <- NULL
cld_dataNIRFVFQXF1C<- cld_dataNIRFVFQXF1C %>%
  select(C, response, .group)
colnames(cld_dataNIRFVFQXF1C) <- c("Cropping System","IWG RFV", "Group")
cld_dataNIRFVFQXF1C  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise N:P
N_levels <- c(0, 40, 80, 120, 160)
emmsNP <- emmeans(modNIRFVFQXF1, specs = ~ N*P, at = list(N = N_levels), type = "response")
cld_dataNIRFVFQXF1NP<- cld(emmsNP, Letters=custom_letters) # Create compact letter display
cld_dataNIRFVFQXF1NP$response <- format(cld_dataNIRFVFQXF1NP$response, digits = 5)
rownames(cld_dataNIRFVFQXF1NP) <- NULL
cld_dataNIRFVFQXF1NP<- cld_dataNIRFVFQXF1NP %>%
  select(N, P, response, .group)
colnames(cld_dataNIRFVFQXF1NP) <- c("N", "Site","IWG RFV", "Group")
cld_dataNIRFVFQXF1NP  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

#This gives us the slope for each interactions as well as a P value indicating significance level for that slope
emtrends_result<-emtrends(modNIRFVFQXF1,~ P*C, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  desired_order_P <- c("MN", "NY", "KS", "WI")
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
  #view(emtrends_df)
emtrends_result<-emtrends(modNIRFVFQXF1,~ P, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  desired_order_P <- c("MN", "NY", "KS", "WI")
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
  #view(emtrends_df)
emtrends_result<-emtrends(modNIRFVFQXF1,~ C, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  #view(emtrends_df)
  
  #equations table N:P
  emtrends_result<-emtrends(modNIRFVFQXF1,~ P, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  desired_order_P <- c("MN", "NY", "KS", "WI")
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
emmeans_results<-emmeans(modNIRFVFQXF1, ~P, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
merged_df <- emtrends_df %>%
  inner_join(emmeans_df, by = c("P")) %>%
  select(P, emmean, N.trend, SE.x)
view(merged_df)
merged_df$P <- factor(merged_df$P, levels = c("MN", "NY", "KS", "WI"))  # Preferred order for P
# Create a new data frame with the calculated column
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
sorted_df <- new_df %>%
  arrange(P)
view(sorted_df)
```
#IWG RFV forage quality year 2 summer 
```{r}
modNIRFVFQYS<-lmer(IWGRFV~ N*P*C + (1|Rep), data=NdYSI)
anova(modNIRFVFQYS)
#Check Assumptions
NIRFVFQYS_resid<-resid(modNIRFVFQYS)
qqnorm(NIRFVFQYS_resid)
qqline(NIRFVFQYS_resid)
plot(modNIRFVFQYS)
#Try log 
modNIRFVFQYS1<-lmer(log(IWGRFV)~ N*P*C + (1|Rep), data=NdYSI)
summary(modNIRFVFQYS1)
anova(modNIRFVFQYS1)
NIRFVFQYS_resid1<-resid(modNIRFVFQYS1)
qqnorm(NIRFVFQYS_resid1)
qqline(NIRFVFQYS_resid1)
plot(modNIRFVFQYS1)

#Pairwise N
N_levels <- c(0, 40, 80, 120, 160)
emmsN <- emmeans(modNIRFVFQYS1, specs = ~ N, at = list(N = N_levels), type = "response")
cld_dataNIRFVFQYS1N <- cld(emmsN, Letters=custom_letters) # Create compact letter display
cld_dataNIRFVFQYS1N$response <- format(cld_dataNIRFVFQYS1N$response, digits = 5)
rownames(cld_dataNIRFVFQYS1N) <- NULL
cld_dataNIRFVFQYS1N<- cld_dataNIRFVFQYS1N %>%
  select(N, response, .group)
colnames(cld_dataNIRFVFQYS1N) <- c("N","IWG RFV", "Group")
cld_dataNIRFVFQYS1N  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise P:C
emmsPC <- emmeans(modNIRFVFQYS1, specs = ~ P*C, type = "response")
cld_dataNIRFVFQYS1PC<- cld(emmsPC, Letters=custom_letters) # Create compact letter display
cld_dataNIRFVFQYS1PC$response <- format(cld_dataNIRFVFQYS1PC$response, digits = 5)
rownames(cld_dataNIRFVFQYS1PC) <- NULL
cld_dataNIRFVFQYS1PC<- cld_dataNIRFVFQYS1PC %>%
  select( P, C, response, .group)
colnames(cld_dataNIRFVFQYS1PC) <- c( "Site","Cropping System", "IWG RFV", "Group")
cld_dataNIRFVFQYS1PC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

#EQUATION tables JUST N 
emtrends_result<-emtrends(modNIRFVFQYS1,~ 1, var= "N", infer=TRUE)
emtrends_df <- as.data.frame(emtrends_result)
emmeans_results<-emmeans(modNIRFVFQYS1, ~1, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
emtrends_df <- emtrends_df %>% mutate(key = 1)
emmeans_df <- emmeans_df %>% mutate(key = 1)
merged_df <- inner_join(emtrends_df, emmeans_df, by = "key")%>%
  select(emmean, N.trend, SE.x)
view(merged_df)
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
view(new_df)
```
#IWG RFV forage quality year 2 fall 
```{r}
modNIRFVFQYF<-lmer(IWGRFV~ N*P*C + (1|Rep), data=NdYFI)
anova(modNIRFVFQYF)
#Check Assumptions
NIRFVFQYF_resid<-resid(modNIRFVFQYF)
qqnorm(NIRFVFQYF_resid)
qqline(NIRFVFQYF_resid)
plot(modNIRFVFQYF)
#Try log 
modNIRFVFQYF1<-lmer(log(IWGRFV)~ N*P*C + (1|Rep), data=NdYFI)
summary(modNIRFVFQYF1)
anova(modNIRFVFQYF1)
NIRFVFQYF_resid1<-resid(modNIRFVFQYF1)
qqnorm(NIRFVFQYF_resid1)
qqline(NIRFVFQYF_resid1)
plot(modNIRFVFQYF1)

#Pairwise N
N_levels <- c(0, 40, 80, 120, 160)
emmsN <- emmeans(modNIRFVFQYF1, specs = ~ N, at = list(N = N_levels), type = "response")
cld_dataNIRFVFQYF1N <- cld(emmsN, Letters=custom_letters) # Create compact letter display
cld_dataNIRFVFQYF1N$response <- format(cld_dataNIRFVFQYF1N$response, digits = 5)
rownames(cld_dataNIRFVFQYF1N) <- NULL
cld_dataNIRFVFQYF1N<- cld_dataNIRFVFQYF1N %>%
  select(N, response, .group)
colnames(cld_dataNIRFVFQYF1N) <- c("N","IWG RFV", "Group")
cld_dataNIRFVFQYF1N  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise P:C
emmsPC <- emmeans(modNIRFVFQYF1, specs = ~ P*C, type = "response")
cld_dataNIRFVFQYF1PC<- cld(emmsPC, Letters=custom_letters) # Create compact letter display
cld_dataNIRFVFQYF1PC$response <- format(cld_dataNIRFVFQYF1PC$response, digits = 5)
rownames(cld_dataNIRFVFQYF1PC) <- NULL
cld_dataNIRFVFQYF1PC<- cld_dataNIRFVFQYF1PC %>%
  select( P, C, response, .group)
colnames(cld_dataNIRFVFQYF1PC) <- c( "Site","Cropping System", "IWG RFV", "Group")
cld_dataNIRFVFQYF1PC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

#EQUATION tables JUST N 
emtrends_result<-emtrends(modNIRFVFQYF1,~ 1, var= "N", infer=TRUE)
emtrends_df <- as.data.frame(emtrends_result)
emmeans_results<-emmeans(modNIRFVFQYF1, ~1, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
emtrends_df <- emtrends_df %>% mutate(key = 1)
emmeans_df <- emmeans_df %>% mutate(key = 1)
merged_df <- inner_join(emtrends_df, emmeans_df, by = "key")%>%
  select(emmean, N.trend, SE.x)
view(merged_df)
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
view(new_df)
```
#IWG RFV combo plot N:E
```{r}
NdXSI$predictedRFV <- predict(modNIRFVFQXS1, newdata = NdXSI, re.form = NA)
NdXFI$predictedRFV <- predict(modNIRFVFQXF1, newdata = NdXFI, re.form = NA)
NdYSI$predictedRFV <- predict(modNIRFVFQYS1, newdata = NdYSI, re.form = NA)
NdYFI$predictedRFV <- predict(modNIRFVFQYF1, newdata = NdYFI, re.form = NA)

# Layer all the plots together!
colors <- c("Year 1 Summer Harvest" = "red", 
            "Year 1 Fall Harvest" = "green", 
            "Year 2 Summer Harvest" = "blue", 
            "Year 2 Fall Harvest" = "purple")
legend_order <- c("Year 1 Fall Harvest")
NdXFA$P <- factor(NdXFA$P, levels = desired_order)

max(NdXSI$IWGRFV)
max(NdXFI$IWGRFV)
max(NdYSI$IWGRFV)
max(NdYFI$IWGRFV)
IRFVcomboplot <- ggplot() +
  geom_point(data = NdXFI, aes(x = N, y = IWGRFV, color = "Year 1 Fall Harvest", shape= C)) +
  labs(x = "N-Rate (kg ha-1)", y = "IWG RFV",
    color = "Harvest", shape = "Cropping System") +
  scale_x_continuous(breaks = c(0, 40, 80, 120, 160)) +
  ylim(50, 140) +
  facet_wrap(~P, scales = "free", ncol = 2) +
  scale_color_manual(values = colors, limits = legend_order)+
  scale_shape_manual(values = c(4, 25),labels = c("Intercropped", "Monoculture IWG") )+
  geom_function(data=subset(NdXFI, P== "MN"), fun=~100.16*exp(0.0001*.x),color='green')+
  geom_function(data=subset(NdXFI, P== "NY"), fun=~123.39*exp(-0.0005*.x),color='green')+
  geom_function(data=subset(NdXFI, P== "WI"), fun=~104.16*exp(0.0003*.x),color='green')


print(IRFVcomboplot)

ggsave("IRFVcomboplot.jpg", plot = IRFVcomboplot, width = 8, height = 6, dpi = 300)
```
#IWG RFV E:C plots (XS and YS and YF)
```{r}
#XS
max(NdXSI$predictedRFV)
exp(4.446889)
IRFVXSemmsPC <- emmeans(modNIRFVFQXS1, ~ P*C, type = "response") # Obtain estimated marginal means (excluding N)
emms_df <- as.data.frame(IRFVXSemmsPC)
cld_dataIRFVXSPC <- cld(IRFVXSemmsPC, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataIRFVXSPC)
merged_df <- merge(emms_df, cld_df,by = c("P", "C"))
custom_labels <- c("Intercrop",  "Monoculture IWG")
custom_colors <- c("darkmagenta", "cyan") 
IRFVXSPC<-ggplot(NdXSI, aes(x = P, y = exp(predictedRFV), color = C)) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7) +
  labs(x = "Environment", y = "IWG Relative Feed Value") +
  geom_point(data = emms_df, aes(x = P, y = response), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 1.5)+
  scale_color_manual(name = "Cropping System", labels = custom_labels,values = custom_colors)+
     ggtitle("Year 1 Fall")+
  theme(plot.title = element_text(hjust = 0.5))+
   guides(color = "none")+
  scale_y_continuous(breaks = c(20,40,60,80,100), limits = c(55, 115))

print(IRFVXSPC)

#YS
IRFVYSemmsPC <- emmeans(modNIRFVFQYS1, ~ P*C, type = "response") # Obtain estimated marginal means (excluding N)
emms_df <- as.data.frame(IRFVYSemmsPC)
cld_dataIRFVYSPC <- cld(IRFVYSemmsPC, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataIRFVYSPC)
merged_df <- merge(emms_df, cld_df,by = c("P", "C"))
custom_labels <- c("Intercrop",  "Monoculture IWG")
custom_colors <- c("darkmagenta", "cyan") 
IRFVYSPC<-ggplot(NdYSI, aes(x = P, y = exp(predictedRFV), color = C)) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7) +
  labs(x = "Environment", y = "IWG Relative Feed Value") +
  geom_point(data = emms_df, aes(x = P, y = response), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 1.5)+
  scale_color_manual(name = "Cropping System", labels = custom_labels,values = custom_colors)+
     ggtitle("Year 2 Summer")+
  theme(plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(breaks = c(20,40,60,80,100), limits = c(55, 115))

print(IRFVYSPC)

#YF
max(NdYFI$predictedRFV)
exp(4.720487)
IRFVYFemmsPC <- emmeans(modNIRFVFQYF1, ~ P*C, type = "response") # Obtain estimated marginal means (excluding N)
emms_df <- as.data.frame(IRFVYFemmsPC)
cld_dataIRFVYFPC <- cld(IRFVYFemmsPC, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataIRFVYFPC)
merged_df <- merge(emms_df, cld_df,by = c("P", "C"))
custom_labels <- c("Intercrop",  "Monoculture IWG")
custom_colors <- c("darkmagenta", "cyan") 
IRFVYFPC<-ggplot(NdYFI, aes(x = P, y = exp(predictedRFV), color = C)) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7) +
  labs(x = "Environment", y = "IWG Relative Feed Value") +
  geom_point(data = emms_df, aes(x = P, y = response), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 1.5)+
  scale_color_manual(name = "Cropping System", labels = custom_labels,values = custom_colors)+
     ggtitle("Year 2 Fall")+
  theme(plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(breaks = c(20,40,60,80,100), limits = c(55, 115))

print(IRFVYFPC)

IRFVEC<-grid.arrange(IRFVXSPC, IRFVYSPC, IRFVYFPC, ncol = 2)
ggsave("IRFVEC.jpg", plot = IRFVEC, width =12, height = 8, dpi = 350)
```
#IWG RFV forage C plot (XF)
```{r}
custom_labels <- c("Intercrop", "Monoculture IWG")
custom_colors <- c("darkmagenta", "cyan") 
NXFIRFVemmsC <- emmeans(modNIRFVFQXF1, ~ C, type = "response") 
emms_df <- as.data.frame(NXFIRFVemmsC)
cld_dataNXFIRFVC <- cld(NXFIRFVemmsC, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataNXFIRFVC)
merged_df <- merge(emms_df, cld_df,by = c("C"))
IRFVXFC<-ggplot(NdXFI, aes(x = C, y = exp(predictedRFV), color= C)) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7) +
  labs(x = "Cropping System", y = "IWG RFV") +
  ggtitle("Year 1 Fall")+
  geom_point(data = emms_df, aes(x = C, y = response), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = C, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = C, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 1.8)+
  scale_color_manual(name = "Cropping System", labels = custom_labels,values = custom_colors)

print(IRFVXFC)
ggsave("IRFVXFC.jpg", plot = IRFVXFC, width = 8, height = 6, dpi = 300)
```
#IWG RFV plots N (XS, YS, YF)
```{r}
#XS
max(NdXSI$IWGRFV)
IRFVplotNXS <- ggplot() +
  geom_point(data = NdXSI, aes(x = N, y = IWGRFV), color= "black") +
  labs(x = "N-Rate (kg ha-1)", y = "IWG RFV",
    color = "Harvest") +
  scale_x_continuous(breaks = c(0, 40, 80, 120, 160)) +
  ylim(0, 125) +
  geom_function(data=NdXSI, fun=~72.21*exp(0.0005*.x),color='red')+
  ggtitle("Year 1 Summer")
print(IRFVplotNXS)

NdXSI$IWGRFV

#YS
max(NdYSI$IWGRFV)
IRFVplotNYS <- ggplot() +
  geom_point(data = NdYSI, aes(x = N, y = IWGRFV), color= "black") +
  labs(x = "N-Rate (kg ha-1)", y = "IWG RFV",
    color = "Harvest") +
  scale_x_continuous(breaks = c(0, 40, 80, 120, 160)) +
  ylim(0, 125) +
  geom_function(data=NdYSI, fun=~72.10*exp(-0.0002*.x),color='red')+
  ggtitle("Year 2 Summer")
print(IRFVplotNYS)

#YF
max(NdYFI$IWGRFV)
IRFVplotNYF <- ggplot() +
  geom_point(data = NdYFI, aes(x = N, y = IWGRFV), color= "black") +
  labs(x = "N-Rate (kg ha-1)", y = "IWG RFV",
    color = "Harvest") +
  scale_x_continuous(breaks = c(0, 40, 80, 120, 160)) +
  ylim(0, 125) +
  geom_function(data=NdYFI, fun=~107.91*exp(-0.0003*.x),color='red')+
  ggtitle("Year 2 Fall")
print(IRFVplotNYF)

IRFVNplot<-grid.arrange(IRFVplotNXS,IRFVplotNYS, IRFVplotNYF, ncol = 2)
ggsave("IRFVNplot.jpg", plot = IRFVNplot, width = 8, height = 6, dpi = 300)
```

#ALF CP forage quality year 1 summer 
```{r}
modNACPFQXS<-lmer(ALFCP~ N*P*C + (1|Rep), data=NdXSA)
anova(modNACPFQXS)
#Check Assumptions
NACPFQXS_resid<-resid(modNACPFQXS)
qqnorm(NACPFQXS_resid)
qqline(NACPFQXS_resid)
plot(modNACPFQXS)
#Try log 
modNACPFQXS1<-lmer(log(ALFCP)~ N*P*C + (1|Rep), data=NdXSA)
anova(modNACPFQXS1)
NACPFQXS_resid1<-resid(modNACPFQXS1)
qqnorm(NACPFQXS_resid1)
qqline(NACPFQXS_resid1)
plot(modNACPFQXS1)

#Pairwise N:P:C
N_levels <- c(0, 40, 80, 120, 160)
emmsNPC <- emmeans(modNACPFQXS1, specs = ~ N*P*C, at = list(N = N_levels), type = "response")
cld_dataNACPFQXS1NPC <- cld(emmsNPC, Letters=custom_letters) # Create compact letter display
cld_dataNACPFQXS1NPC$response <- format(cld_dataNACPFQXS1NPC$response, digits = 5)
rownames(cld_dataNACPFQXS1NPC) <- NULL
cld_dataNACPFQXS1NPC<- cld_dataNACPFQXS1NPC %>%
  select( N, P, C, response, .group)
colnames(cld_dataNACPFQXS1NPC) <- c( "N", "Site","Cropping System", "IWG RFV", "Group")
cld_dataNACPFQXS1NPC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

#This gives us the slope for each interactions as well as a P value indicating significance level for that slope
emtrends_result<-emtrends(modNACPFQXS1,~ P*C, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  desired_order_P <- c("MN", "NY", "KS", "WI")
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
  #view(emtrends_df)
emtrends_result<-emtrends(modNACPFQXS1,~ P, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  desired_order_P <- c("MN", "NY", "KS", "WI")
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
  view(emtrends_df)
emtrends_result<-emtrends(modNACPFQXS1,~ C, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  #view(emtrends_df)
  
  #emmeans for intercepts! via erika
emtrends_result<-emtrends(modNACPFQXS1,~ P*C, var= "N", infer=TRUE)
emtrends_df <- as.data.frame(emtrends_result)
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
emmeans_results<-emmeans(modNACPFQXS1, ~P*C, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
merged_df <- emtrends_df %>%
  inner_join(emmeans_df, by = c("P", "C")) %>%
  select(P, C, emmean, N.trend, SE.x)
view(merged_df)
merged_df$P <- factor(merged_df$P, levels = c("MN", "NY", "KS", "WI"))  # Preferred order for P
merged_df$CROP <- factor(merged_df$C, levels = c("intercrop", "monoculture"))  # Preferred order for CROP
# Create a new data frame with the calculated column
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
sorted_df <- new_df %>%
  arrange(P, C)
view(sorted_df)
```
#ALF CP forage quality year 1 fall 
```{r}
modNACPFQXF<-lmer(ALFCP~ N*P*C + (1|Rep), data=NdXFA)
anova(modNACPFQXF)
#Check Assumptions
NACPFQXF_resid<-resid(modNACPFQXF)
qqnorm(NACPFQXF_resid)
qqline(NACPFQXF_resid)
plot(modNACPFQXF)
#Try log 
modNACPFQXF1<-lmer(log(ALFCP)~ N*P*C + (1|Rep), data=NdXFA)
anova(modNACPFQXF1)
NACPFQXF_resid1<-resid(modNACPFQXF1)
qqnorm(NACPFQXF_resid1)
qqline(NACPFQXF_resid1)
plot(modNACPFQXF1)

#Pairwise P
emmsP <- emmeans(modNACPFQXF1, specs = ~ P, type = "response")
cld_dataNACPFQXF1P <- cld(emmsP, Letters=custom_letters) # Create compact letter display
cld_dataNACPFQXF1P $response <- format(cld_dataNACPFQXF1P $response, digits = 5)
rownames(cld_dataNACPFQXF1P ) <- NULL
cld_dataNACPFQXF1P <- cld_dataNACPFQXF1P  %>%
  select( P, response, .group)
colnames(cld_dataNACPFQXF1P ) <- c( "Site", "IWG RFV", "Group")
cld_dataNACPFQXF1P   |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise N:C
emmsNC <- emmeans(modNACPFQXF1, specs = ~ N*C, at=list(N = N_levels), type = "response")
cld_dataNACPFQXF1NC <- cld(emmsNC, Letters=custom_letters) # Create compact letter display
cld_dataNACPFQXF1NC$response <- format(cld_dataNACPFQXF1NC$response, digits = 5)
rownames(cld_dataNACPFQXF1NC) <- NULL
cld_dataNACPFQXF1NC<- cld_dataNACPFQXF1NC %>%
  select( N, C, response, .group)
colnames(cld_dataNACPFQXF1NC) <- c( "N", "Cropping System", "IWG RFV", "Group")
cld_dataNACPFQXF1NC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

#slope 
emtrends_result<-emtrends(modNACPFQXF1,~ C, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  #view(emtrends_df)
  
  #EQUATION tables N:C
emtrends_result<-emtrends(modNACPFQXF1,~ C, var= "N", infer=TRUE)
emtrends_df <- as.data.frame(emtrends_result)
emmeans_results<-emmeans(modNACPFQXF1, ~C, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
merged_df <- emtrends_df %>%
  inner_join(emmeans_df, by = c( "C")) %>%
  select(C, emmean, N.trend, SE.x)
view(merged_df)
merged_df$C <- factor(merged_df$C, levels = c("intercrop", "monoculture"))  # Preferred order for CROP
# Create a new data frame with the calculated column
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
sorted_df <- new_df %>%
  arrange( C)
view(sorted_df)
```
#ALF CP forage quality year 2 summer 
```{r}
modNACPFQYS<-lmer(ALFCP~ N*P*C + (1|Rep), data=NdYSA)
anova(modNACPFQYS)
#Check Assumptions
NACPFQYS_resid<-resid(modNACPFQYS)
qqnorm(NACPFQYS_resid)
qqline(NACPFQYS_resid)
plot(modNACPFQYS)
#Try log 
modNACPFQYS1<-lmer(log(ALFCP)~ N*P*C + (1|Rep), data=NdYSA)
anova(modNACPFQYS1)
NACPFQYS_resid1<-resid(modNACPFQYS1)
qqnorm(NACPFQYS_resid1)
qqline(NACPFQYS_resid1)
plot(modNACPFQYS1)

#Pairwise P
emmsP <- emmeans(modNACPFQYS1, specs = ~ P, type = "response")
cld_dataNACPFQYS1P <- cld(emmsP, Letters=custom_letters) # Create compact letter display
cld_dataNACPFQYS1P $response <- format(cld_dataNACPFQYS1P $response, digits = 5)
rownames(cld_dataNACPFQYS1P ) <- NULL
cld_dataNACPFQYS1P <- cld_dataNACPFQYS1P  %>%
  select( P, response, .group)
colnames(cld_dataNACPFQYS1P ) <- c( "Site", "IWG RFV", "Group")
cld_dataNACPFQYS1P   |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)


```
#ALF CP forage quality year 2 fall 
```{r}
modNACPFQYF<-lmer(ALFCP~ N*P*C + (1|Rep), data=NdYFA)
anova(modNACPFQYF)
#Check Assumptions
NACPFQYF_resid<-resid(modNACPFQYF)
qqnorm(NACPFQYF_resid)
qqline(NACPFQYF_resid)
plot(modNACPFQYF)
#Try log 
modNACPFQYF1<-lmer(log(ALFCP)~ N*P*C + (1|Rep), data=NdYFA)
anova(modNACPFQYF1)
NACPFQYF_resid1<-resid(modNACPFQYF1)
qqnorm(NACPFQYF_resid1)
qqline(NACPFQYF_resid1)
plot(modNACPFQYF1)

#Pairwise P
emmsP <- emmeans(modNACPFQYF1, specs = ~ P, type = "response")
cld_dataNACPFQYF1P <- cld(emmsP, Letters=custom_letters) # Create compact letter display
cld_dataNACPFQYF1P $response <- format(cld_dataNACPFQYF1P $response, digits = 5)
rownames(cld_dataNACPFQYF1P ) <- NULL
cld_dataNACPFQYF1P <- cld_dataNACPFQYF1P  %>%
  select( P, response, .group)
colnames(cld_dataNACPFQYF1P ) <- c( "Site", "IWG RFV", "Group")
cld_dataNACPFQYF1P   |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
```
#ALF CP combo plot N:E:C
```{r}
NdXSA$predictedCP <- predict(modNACPFQXS1, newdata = NdXSA, re.form = NA)
NdXFA$predictedCP <- predict(modNACPFQXF1, newdata = NdXFA, re.form = NA)
NdYSA$predictedCP <- predict(modNACPFQYS1, newdata = NdYSA, re.form = NA)
NdYFA$predictedCP <- predict(modNACPFQYF1, newdata = NdYFA, re.form = NA)

# Layer all the plots together!
colors <- c("Year 1 Summer Harvest" = "red", 
            "Year 1 Fall Harvest" = "green", 
            "Year 2 Summer Harvest" = "blue", 
            "Year 2 Fall Harvest" = "purple")
legend_order <- c("Year 1 Summer Harvest")
NdXSA$P <- factor(NdXSA$P, levels = desired_order)

max(NdXSA$ALFCP)
max(NdXFA$ALFCP)
max(NdYSA$ALFCP)
max(NdYFA$ALFCP)
ACPcomboplot <- ggplot() +
  geom_line(data = NdXSA, aes(N, exp(predictedCP), color = "Year 1 Summer Harvest", linetype= C)) +
  geom_point(data = NdXSA, aes(x = N, y = ALFCP, color = "Year 1 Summer Harvest", shape= C)) +
  labs(x = "N-Rate (kg ha-1)", y = "Alfalfa CP",
    color = "Harvest", 
    linetype = "Line Type", shape = "Cropping System") +
  scale_x_continuous(breaks = c(0, 40, 80, 120, 160)) +
  ylim(0, 26) +
  facet_wrap(~P, scales = "free", ncol = 2) +
  scale_color_manual(values = colors, limits = legend_order)+
  scale_shape_manual(values = c(4, 20),labels = c("Intercropped", "Monoculture Alfalfa") )


print(ACPcomboplot)

ggsave("ACPcomboplot.jpg", plot = ACPcomboplot, width = 8, height = 6, dpi = 300)
```
#ALF CP combo plot N:C
```{r}
NdXSA$predictedCP <- predict(modNACPFQXS1, newdata = NdXSA, re.form = NA)
NdXFA$predictedCP <- predict(modNACPFQXF1, newdata = NdXFA, re.form = NA)
NdYSA$predictedCP <- predict(modNACPFQYS1, newdata = NdYSA, re.form = NA)
NdYFA$predictedCP <- predict(modNACPFQYF1, newdata = NdYFA, re.form = NA)

# Layer all the plots together!
colors <- c("Year 1 Summer Harvest" = "red", 
            "Year 1 Fall Harvest" = "green", 
            "Year 2 Summer Harvest" = "blue", 
            "Year 2 Fall Harvest" = "purple")
legend_order <- c("Year 1 Fall Harvest")
NdXFA$P <- factor(NdXFA$P, levels = desired_order)

max(NdXSA$ALFCP)
max(NdXFA$ALFCP)
max(NdYSA$ALFCP)
max(NdYFA$ALFCP)
ACPcomboplotNC <- ggplot() +
  geom_point(data = NdXFA, aes(x = N, y = ALFCP, color = "Year 1 Fall Harvest", shape= C)) +
  labs(x = "N-Rate (kg ha-1)", y = "Alfalfa CP",
    color = "Harvest", 
    linetype = "Cropping System", shape = "Cropping System") +
  scale_x_continuous(breaks = c(0, 40, 80, 120, 160)) +
  ylim(0, 25) +
  scale_color_manual(values = colors, limits = legend_order)+
  scale_shape_manual(values = c(4, 20),labels = c("Intercropped", "Monoculture Alfalfa") )+
   geom_function(data=subset(NdXFA, C== "intercrop"), fun=~20.23*exp(0.0002*.x),color='green', linetype= "solid")+
  geom_function(data=subset(NdXFA, C== "monoculture"), fun=~19.43*exp(-0.0001*.x),color='green', linetype= "dotted")+
  geom_line(aes(x = c(0, 0), y = c(0, 0), linetype = "Intercropped")) +
  geom_line(aes(x = c(0, 0), y = c(0, 0), linetype = "Monoculture Alfalfa"))+
  scale_linetype_manual(name = "Cropping System", values = c("solid", "dashed"), labels = c("Intercropped", "Monoculture Alfalfa")) +
  guides(linetype = guide_legend(override.aes = list(color = 'black'), title= "Line Type"))


print(ACPcomboplotNC)

ggsave("ACPcomboplotNC.jpg", plot = ACPcomboplotNC, width = 8, height = 6, dpi = 300)
```
#Alf CP E plots (XF, YS, YF)
```{r}
#XF 
NACPXFemmsP <- emmeans(modNACPFQXF1, ~ P, type = "response") 
emms_df <- as.data.frame(NACPXFemmsP)
cld_dataNACPXFP <- cld(NACPXFemmsP, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataNACPXFP)
merged_df <- merge(emms_df, cld_df,by = c("P"))
ACPXFE<-ggplot(NdXFA, aes(x = P, y = exp(predictedCP))) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7, color="darkgreen") +
  labs(x = "Environment", y = "Alfalfa CP") +
  geom_point(data = emms_df, aes(x = P, y = response), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 1.8)+
  ggtitle("Year 1 Fall")+
  scale_y_continuous(breaks = c(10,15,20,25), limits = c(7, 25))

print(ACPXFE)


#YS 
NACPYSemmsP <- emmeans(modNACPFQYS1, ~ P, type = "response") 
emms_df <- as.data.frame(NACPYSemmsP)
cld_dataNACPYSP <- cld(NACPYSemmsP, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataNACPYSP)
merged_df <- merge(emms_df, cld_df,by = c("P"))
ACPYSE<-ggplot(NdYSA, aes(x = P, y = exp(predictedCP))) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7, color="darkgreen") +
  labs(x = "Environment", y = "Alfalfa CP") +
  geom_point(data = emms_df, aes(x = P, y = response), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 1.8)+
  ggtitle("Year 2 Summer")+
  scale_y_continuous(breaks = c(10,15,20,25), limits = c(7, 25))

print(ACPYSE)

#YF 
NACPYFemmsP <- emmeans(modNACPFQYF1, ~ P, type = "response") 
emms_df <- as.data.frame(NACPYFemmsP)
cld_dataNACPYFP <- cld(NACPYFemmsP, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataNACPYFP)
merged_df <- merge(emms_df, cld_df,by = c("P"))
ACPYFE<-ggplot(NdYFA, aes(x = P, y = exp(predictedCP))) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7, color="darkgreen") +
  labs(x = "Environment", y = "Alfalfa CP") +
  geom_point(data = emms_df, aes(x = P, y = response), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 1.8)+
ggtitle("Year 2 Fall")+
  scale_y_continuous(breaks = c(10,15,20,25), limits = c(7, 25))

print(ACPYFE)

ACPE<-grid.arrange(ACPXFE, ACPYSE, ACPYFE, ncol = 2)
ggsave("ACPE.jpg", plot = ACPE, width = 8, height = 6, dpi = 300)
```


#ALF RFV forage quality year 1 summer 
```{r}
modNARFVFQXS<-lmer(ALFRFV~ N*P*C + (1|Rep), data=NdXSA)
anova(modNARFVFQXS)
#Check Assumptions
NARFVFQXS_resid<-resid(modNARFVFQXS)
qqnorm(NARFVFQXS_resid)
qqline(NARFVFQXS_resid)
plot(modNARFVFQXS)
#Try log 
modNARFVFQXS1<-lmer(log(ALFRFV)~ N*P*C + (1|Rep), data=NdXSA)
anova(modNARFVFQXS1)
NARFVFQXS_resid1<-resid(modNARFVFQXS1)
qqnorm(NARFVFQXS_resid1)
qqline(NARFVFQXS_resid1)
plot(modNARFVFQXS1)

#Pairwise N:P:C
N_levels <- c(0, 40, 80, 120, 160)
emmsNPC <- emmeans(modNARFVFQXS1, specs = ~ N*P*C, at = list(N = N_levels), type = "response")
cld_dataNARFVFQXS1NPC <- cld(emmsNPC, Letters=custom_letters) # Create compact letter display
cld_dataNARFVFQXS1NPC$response <- format(cld_dataNARFVFQXS1NPC$response, digits = 5)
rownames(cld_dataNARFVFQXS1NPC) <- NULL
cld_dataNARFVFQXS1NPC<- cld_dataNARFVFQXS1NPC %>%
  select( N, P, C, response, .group)
colnames(cld_dataNARFVFQXS1NPC) <- c( "N", "Site","Cropping System", "IWG RFV", "Group")
cld_dataNARFVFQXS1NPC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

#This gives us the slope for each interactions as well as a P value indicating significance level for that slope
emtrends_result<-emtrends(modNARFVFQXS1,~ P*C, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  desired_order_P <- c("MN", "NY", "KS", "WI")
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
  #view(emtrends_df)
emtrends_result<-emtrends(modNARFVFQXS1,~ P, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  desired_order_P <- c("MN", "NY", "KS", "WI")
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
  #view(emtrends_df)
emtrends_result<-emtrends(modNARFVFQXS1,~ C, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  #view(emtrends_df)
  
  #emmeans for intercepts! via erika
emtrends_result<-emtrends(modNARFVFQXS1,~ P*C, var= "N", infer=TRUE)
emtrends_df <- as.data.frame(emtrends_result)
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
emmeans_results<-emmeans(modNARFVFQXS1, ~P*C, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
merged_df <- emtrends_df %>%
  inner_join(emmeans_df, by = c("P", "C")) %>%
  select(P, C, emmean, N.trend, SE.x)
view(merged_df)
merged_df$P <- factor(merged_df$P, levels = c("MN", "NY", "KS", "WI"))  # Preferred order for P
merged_df$CROP <- factor(merged_df$C, levels = c("intercrop", "monoculture"))  # Preferred order for CROP
# Create a new data frame with the calculated column
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
sorted_df <- new_df %>%
  arrange(P, C)
view(sorted_df)
```
#ALF RFV forage quality year 1 fall 
```{r}
modNARFVFQXF<-lmer(ALFRFV~ N*P*C + (1|Rep), data=NdXFA)
anova(modNARFVFQXF)
#Check Assumptions
NARFVFQXF_resid<-resid(modNARFVFQXF)
qqnorm(NARFVFQXF_resid)
qqline(NARFVFQXF_resid)
plot(modNARFVFQXF)
#Try log 
modNARFVFQXF1<-lmer(log(ALFRFV)~ N*P*C + (1|Rep), data=NdXFA)
anova(modNARFVFQXF1)
NARFVFQXF_resid1<-resid(modNARFVFQXF1)
qqnorm(NARFVFQXF_resid1)
qqline(NARFVFQXF_resid1)
plot(modNARFVFQXF1)

#Pairwise P:C
emmsPC <- emmeans(modNARFVFQXF1, specs = ~ P*C, type = "response")
cld_dataNARFVFQXF1PC <- cld(emmsPC, Letters=custom_letters) # Create compact letter display
cld_dataNARFVFQXF1PC$response <- format(cld_dataNARFVFQXF1PC$response, digits = 5)
rownames(cld_dataNARFVFQXF1PC) <- NULL
cld_dataNARFVFQXF1PC<- cld_dataNARFVFQXF1PC %>%
  select( P, C, response, .group)
colnames(cld_dataNARFVFQXF1PC) <- c( "Site","Cropping System", "IWG RFV", "Group")
cld_dataNARFVFQXF1PC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
```
#ALF RFV forage quality year 2 summer 
```{r}
modNARFVFQYS<-lmer(ALFRFV~ N*P*C + (1|Rep), data=NdYSA)
anova(modNARFVFQYS)
#Check Assumptions
NARFVFQYS_resid<-resid(modNARFVFQYS)
qqnorm(NARFVFQYS_resid)
qqline(NARFVFQYS_resid)
plot(modNARFVFQYS)
#Try log 
modNARFVFQYS1<-lmer(log(ALFRFV)~ N*P*C + (1|Rep), data=NdYSA)
anova(modNARFVFQYS1)
NARFVFQYS_resid1<-resid(modNARFVFQYS1)
qqnorm(NARFVFQYS_resid1)
qqline(NARFVFQYS_resid1)
plot(modNARFVFQYS1)

#Pairwise P
emmsP <- emmeans(modNARFVFQYS1, specs = ~ P, type = "response")
cld_dataNARFVFQYS1P <- cld(emmsP, Letters=custom_letters) # Create compact letter display
cld_dataNARFVFQYS1P$response <- format(cld_dataNARFVFQYS1P$response, digits = 5)
rownames(cld_dataNARFVFQYS1P) <- NULL
cld_dataNARFVFQYS1P<- cld_dataNARFVFQYS1P %>%
  select( P, response, .group)
colnames(cld_dataNARFVFQYS1P) <- c( "Site", "IWG RFV", "Group")
cld_dataNARFVFQYS1P  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
```
#ALF RFV forage quality year 2 fall 
```{r}
modNARFVFQYF<-lmer(ALFRFV~ N*P*C + (1|Rep), data=NdYFA)
anova(modNARFVFQYF)
#Check Assumptions
NARFVFQYF_resid<-resid(modNARFVFQYF)
qqnorm(NARFVFQYF_resid)
qqline(NARFVFQYF_resid)
plot(modNARFVFQYF)
#Try log 
modNARFVFQYF1<-lmer(log(ALFRFV)~ N*P*C + (1|Rep), data=NdYFA)
anova(modNARFVFQYF1)
NARFVFQYF_resid1<-resid(modNARFVFQYF1)
qqnorm(NARFVFQYF_resid1)
qqline(NARFVFQYF_resid1)
plot(modNARFVFQYF1)

#Pairwise N:C
N_levels <- c(0, 40, 80, 120, 160)
emmsNC <- emmeans(modNICPFQXS1, specs = ~ N*C, at = list(N = N_levels), type = "response")
cld_dataNICPFQXS1NC <- cld(emmsNC, Letters=custom_letters) # Create compact letter display
cld_dataNICPFQXS1NC$response <- format(cld_dataNICPFQXS1NC$response, digits = 5)
rownames(cld_dataNICPFQXS1NC) <- NULL
cld_dataNICPFQXS1NC<- cld_dataNICPFQXS1NC %>%
  select( N, C, response, .group)
colnames(cld_dataNICPFQXS1NC) <- c( "N","Cropping System", "IWG RFV", "Group")
cld_dataNICPFQXS1NC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

#Slope stuff
emtrends_result<-emtrends(modNARFVFQYF1,~ C, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  #view(emtrends_df)
  
    #EQUATION tables N:C
emtrends_result<-emtrends(modNARFVFQYF1,~ C, var= "N", infer=TRUE)
emtrends_df <- as.data.frame(emtrends_result)
emmeans_results<-emmeans(modNARFVFQYF1, ~C, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
merged_df <- emtrends_df %>%
  inner_join(emmeans_df, by = c( "C")) %>%
  select(C, emmean, N.trend, SE.x)
view(merged_df)
merged_df$C <- factor(merged_df$C, levels = c("intercrop", "monoculture"))  # Preferred order for CROP
# Create a new data frame with the calculated column
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
sorted_df <- new_df %>%
  arrange( C)
view(sorted_df)
```
#ALF RFV combo plot N:E:C
```{r}
NdXSA$predictedRFV <- predict(modNARFVFQXS1, newdata = NdXSA, re.form = NA)
NdXFA$predictedRFV <- predict(modNARFVFQXF1, newdata = NdXFA, re.form = NA)
NdYSA$predictedRFV <- predict(modNARFVFQYS1, newdata = NdYSA, re.form = NA)
NdYFA$predictedRFV <- predict(modNARFVFQYF1, newdata = NdYFA, re.form = NA)

# Layer all the plots together!
colors <- c("Year 1 Summer Harvest" = "red", 
            "Year 1 Fall Harvest" = "green", 
            "Year 2 Summer Harvest" = "blue", 
            "Year 2 Fall Harvest" = "purple")
legend_order <- c("Year 1 Summer Harvest")
NdXSA$P <- factor(NdXSA$P, levels = desired_order)

max(NdXSA$ALFRFV)
max(NdXFA$ALFRFV)
max(NdYSA$ALFRFV)
max(NdYFA$ALFRFV)
ARFVcomboplot <- ggplot() +
  geom_line(data = NdXSA, aes(N, exp(predictedRFV), color = "Year 1 Summer Harvest", linetype= C)) +
  geom_point(data = NdXSA, aes(x = N, y = ALFRFV, color = "Year 1 Summer Harvest", shape= C)) +
  labs(x = "N-Rate (kg ha-1)", y = "Alfalfa RFV",
    color = "Harvest", 
    linetype = "Line Type", shape = "Cropping System") +
  scale_x_continuous(breaks = c(0, 40, 80, 120, 160)) +
  ylim(50, 210) +
  facet_wrap(~P, scales = "free", ncol = 2) +
  scale_color_manual(values = colors, limits = legend_order)+
  scale_shape_manual(values = c(4, 20),labels = c("Intercropped", "Monoculture Alfalfa"))

print(ARFVcomboplot)

ggsave("ARFVcomboplot.jpg", plot = ARFVcomboplot, width = 8, height = 6, dpi = 300)
```
#ALF RFV combo plot N:C
```{r}
NdXSA$predictedRFV <- predict(modNARFVFQXS1, newdata = NdXSA, re.form = NA)
NdXFA$predictedRFV <- predict(modNARFVFQXF1, newdata = NdXFA, re.form = NA)
NdYSA$predictedRFV <- predict(modNARFVFQYS1, newdata = NdYSA, re.form = NA)
NdYFA$predictedRFV <- predict(modNARFVFQYF1, newdata = NdYFA, re.form = NA)

# Layer all the plots together!
colors <- c("Year 1 Summer Harvest" = "red", 
            "Year 1 Fall Harvest" = "green", 
            "Year 2 Summer Harvest" = "blue", 
            "Year 2 Fall Harvest" = "purple")
legend_order <- c("Year 2 Fall Harvest")
NdYFA$P <- factor(NdYFA$P, levels = desired_order)

max(NdXSA$ALFRFV)
max(NdXFA$ALFRFV)
max(NdYSA$ALFRFV)
max(NdYFA$ALFRFV)
ARFVcomboplotNC <- ggplot() +
  geom_point(data = NdYFA, aes(x = N, y = ALFRFV, color = "Year 2 Fall Harvest", shape= C)) +
  labs(x = "N-Rate (kg ha-1)", y = "Alfalfa RFV",
    color = "Harvest", 
    linetype = "Line Type", shape = "Cropping System") +
  scale_x_continuous(breaks = c(0, 40, 80, 120, 160)) +
  ylim(75, 210) +
  scale_color_manual(values = colors, limits = legend_order)+
  scale_shape_manual(values = c(4, 20),labels = c("Intercropped", "Monoculture Alfalfa"))+
     geom_function(data=subset(NdYFA, C== "intercrop"), fun=~149.83*exp(0.0007*.x),color='purple', linetype= "solid")+
  geom_function(data=subset(NdYFA, C== "monoculture"), fun=~143.79*exp(-0.0000*.x),color='purple', linetype= "dotted")+
  geom_line(aes(x = c(0, 0), y = c(0, 0), linetype = "Intercropped")) +
  geom_line(aes(x = c(0, 0), y = c(0, 0), linetype = "Monoculture Alfalfa"))+
  scale_linetype_manual(name = "Cropping System", values = c("solid", "dashed"), labels = c("Intercropped", "Monoculture Alfalfa")) +
  guides(linetype = guide_legend(override.aes = list(color = 'black'), title= "Line Type"))


print(ARFVcomboplotNC)

ggsave("ARFVcomboplotNC.jpg", plot = ARFVcomboplotNC, width = 8, height = 6, dpi = 300)
```
#Alfalfa RFV E:C plots (XF)
```{r}
#XF
ARFVXFemmsPC <- emmeans(modNARFVFQXF1, ~ P*C, type = "response") # Obtain estimated marginal means (excluding N)
emms_df <- as.data.frame(ARFVXFemmsPC)
cld_dataARFVXFPC <- cld(ARFVXFemmsPC, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataARFVXFPC)
merged_df <- merge(emms_df, cld_df,by = c("P", "C"))
custom_labels <- c("Intercrop",  "Monoculture Alfalfa")
custom_colors <- c("darkmagenta", "coral1") 
ARFVXFPC<-ggplot(NdXFA, aes(x = P, y = exp(predictedRFV), color = C)) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7) +
  labs(x = "Environment", y = "Alfalfa Relative Feed Value") +
  geom_point(data = emms_df, aes(x = P, y = response), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 2)+
  scale_color_manual(name = "Cropping System", labels = custom_labels,values = custom_colors)+
     ggtitle("Year 2 Fall")+
  theme(plot.title = element_text(hjust = 0.5))

print(ARFVXFPC)
ggsave("ARFVXFPC.jpg", plot = ARFVXFPC, width =12, height = 8, dpi = 350)
```
#Alf RFV E plots (YS )
```{r}
#YS 
NARFVYSemmsP <- emmeans(modNARFVFQYS1, ~ P, type = "response") 
emms_df <- as.data.frame(NARFVYSemmsP)
cld_dataNARFVYSP <- cld(NARFVYSemmsP, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataNARFVYSP)
merged_df <- merge(emms_df, cld_df,by = c("P"))
ARFVYSE<-ggplot(NdYSA, aes(x = P, y = exp(predictedRFV))) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7, color="darkgreen") +
  labs(x = "Environment", y = "Alfalfa RFV") +
  geom_point(data = emms_df, aes(x = P, y = response), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 1.8)+
  ggtitle("Year 2 Summer")

print(ARFVYSE)


ggsave("ARFVYSE.jpg", plot = ARFVYSE, width = 8, height = 6, dpi = 300)
```

#Total CP year 1 summer
```{r}
#REMOVE
#NdXSf1<-NdXSf[-48,]
modNTCPXS<-lmer(totCP~N*P*CROP + (1|Rep), data=NdXSf1)
anova(modNTCPXS)
#check assumptions 
NTCPXS_resid<-resid(modNTCPXS)
qqnorm(NTCPXS_resid)
qqline(NTCPXS_resid)
plot(modNTCPXS)
#try log 
#Remove annoying lines with 0 values 
modNTCPXS1<-lmer(log(totCP)~N*P*CROP + (1|Rep), data=NdXSf1)
NTCPXS_resid1<-resid(modNTCPXS1)
qqnorm(NTCPXS_resid1)
qqline(NTCPXS_resid1)
plot(modNTCPXS1)
summary(modNTCPXS1)

AICc(modNTCPXS)
AICc(modNTCPXS1)
AICc(modNTCPXF)
AICc(modNTCPXF1)
AICc(modNTCPYS)
AICc(modNTCPYS1)
AICc(modNTCPYF)
AICc(modNTCPYF1)

#Pairwise NPC
emmsNPC <- emmeans(modNTCPXS1, ~ N*P*CROP,at= list(N = N_levels)) 
cld_dataNTCPXSNPC <- cld(emmsNPC, Letters=custom_letters) # Create compact letter display
cld_dataNTCPXSNPC$response <- format(cld_dataNTCPXSNPC$emmean, digits = 5)
rownames(cld_dataNTCPXSNPC) <- NULL
cld_dataNTCPXSNPC<- cld_dataNTCPXSNPC %>%
  select(N, P, CROP, response, .group)
colnames(cld_dataNTCPXSNPC) <- c("N", "Site", "Cropping System", "Total CP", "Group")
cld_dataNTCPXSNPC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

#This gives us the slope for each interactions as well as a P value indicating significance level for that slope
emtrends_result<-emtrends(modNTCPXS1,~ P*CROP, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  desired_order_P <- c("MN", "NY", "KS", "WI")
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
  #view(emtrends_df)
emtrends(modNTCPXS,~ P, var= "N", infer=TRUE)
emtrends(modNTCPXS,~ CROP, var= "N", infer=TRUE)

#emmeans for intercepts! via erika
emtrends_result<-emtrends(modNTCPXS1,~ P*CROP, var= "N", infer=TRUE)
emtrends_df <- as.data.frame(emtrends_result)
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
emmeans_results<-emmeans(modNTCPXS1, ~P*CROP, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
merged_df <- emtrends_df %>%
  inner_join(emmeans_df, by = c("P", "CROP")) %>%
  select(P, CROP, emmean, N.trend, SE.x)
view(merged_df)
merged_df$P <- factor(merged_df$P, levels = c("MN", "NY", "KS", "WI"))  # Preferred order for P
merged_df$CROP <- factor(merged_df$CROP, levels = c("inter", "monoI","monoA"))  # Preferred order for CROP
# Create a new data frame with the calculated column
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
sorted_df <- new_df %>%
  arrange(P, CROP)
view(sorted_df)

summary(modNTCPXS1)
```
#maybe the regression equation code you're looking for? (didn't use but save for posterity)
```{r, eval=FALSE}
# Extract fixed effects coefficients
fixed_effects <- fixef(modNTCPXS)
# Get levels of categorical variables P and CROP
levels_P <- levels(NdXSf1$P)
levels_CROP <- levels(NdXSf1$CROP)
# Initialize an empty data frame to store the equations
equations_table <- data.frame(CROP = character(), P = character(), Equation = character(), stringsAsFactors = FALSE)

# Loop through each combination of P and CROP
for (p in levels_P) {
  for (crop in levels_CROP) {
    # Baseline intercept and slope
    intercept <- fixed_effects["(Intercept)"]
    slope <- fixed_effects["N"]
    
    # Add effects for P
    if (p != levels_P[1]) {
      intercept <- intercept + fixed_effects[paste0("P", p)]
      slope <- slope + fixed_effects[paste0("N:P", p)]
    }
    
    # Add effects for CROP
    if (crop != levels_CROP[1]) {
      intercept <- intercept + fixed_effects[paste0("CROP", crop)]
      slope <- slope + fixed_effects[paste0("N:CROP", crop)]
    }
    
    # Add interaction effects between P and CROP
    if (p != levels_P[1] & crop != levels_CROP[1]) {
      intercept <- intercept + fixed_effects[paste0("P", p, ":CROP", crop)]
      slope <- slope + fixed_effects[paste0("N:P", p, ":CROP", crop)]
    }
    
    # Construct the equation as a string
    equation <- paste0("log(totCP) = ", round(intercept, 4), " + ", round(slope, 4), " * N")
    
    # Add the equation to the table
    equations_table <- rbind(equations_table, data.frame(CROP = crop, P = p, Equation = equation, stringsAsFactors = FALSE))
  }
}

# Print the table
print(equations_table)
view(equations_table)
```

#Total CP year 1 fall
```{r}
modNTCPXF<-lmer(totCP~N*P*CROP + (1|Rep), data=NdXFf)
anova(modNTCPXF)
#check assumptions 
NTCPXF_resid<-resid(modNTCPXF)
qqnorm(NTCPXF_resid)
qqline(NTCPXF_resid)
plot(modNTCPXF)
#try log 
modNTCPXF1<-lmer(log(totCP)~N*P*CROP + (1|Rep), data=NdXFf)
NTCPXF_resid1<-resid(modNTCPXF1)
qqnorm(NTCPXF_resid1)
qqline(NTCPXF_resid1)
plot(modNTCPXF1)

#Pairwise N:C
N_levels <- c(0, 40, 80, 120, 160)
emmsNTCPXF <- emmeans(modNTCPXF1, specs = ~ N*CROP, at = list(N = N_levels), type = "response")
cld_dataNTCPXFNC <- cld(emmsNTCPXF, Letters=custom_letters) # Create compact letter display
cld_dataNTCPXFNC$response <- format(cld_dataNTCPXFNC$emmean, digits = 5)
cld_dataNTCPXFNC<- cld_dataNTCPXFNC %>%
  select(N, CROP, response, .group)
rownames(cld_dataNTCPXFNC) <- NULL
colnames(cld_dataNTCPXFNC) <- c("N", "Cropping System", "Total Forage (kg ha-1)", "Group")
cld_dataNTCPXFNC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise N:P
N_levels <- c(0, 40, 80, 120, 160)
emmsNTCPXF <- emmeans(modNTCPXF1, specs = ~ N*P, at = list(N = N_levels), type = "response")
cld_dataNTCPXFNP <- cld(emmsNTCPXF, Letters=custom_letters) # Create compact letter display
cld_dataNTCPXFNP$response <- format(cld_dataNTCPXFNP$emmean, digits = 5)
cld_dataNTCPXFNP<- cld_dataNTCPXFNP %>%
  select(N, P, response, .group)
rownames(cld_dataNTCPXFNP) <- NULL
colnames(cld_dataNTCPXFNP) <- c("N", "Site", "Total Forage (kg ha-1)", "Group")
cld_dataNTCPXFNP  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise P:C
emmsNTCPXF <- emmeans(modNTCPXF1, specs = ~ P*CROP,  type = "response")
cld_dataNTCPXFPC <- cld(emmsNTCPXF, Letters=custom_letters) # Create compact letter display
cld_dataNTCPXFPC$response <- format(cld_dataNTCPXFPC$response, digits = 5)
cld_dataNTCPXFPC<- cld_dataNTCPXFPC %>%
  select(P, CROP, response, .group)
rownames(cld_dataNTCPXFPC) <- NULL
colnames(cld_dataNTCPXFPC) <- c("Site", "Cropping System", "Total CP", "Group")
cld_dataNTCPXFPC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

#This gives us the slope for each interactions as well as a P value indicating significance level for that slope
emtrends(modNTCPXF1,~ P*CROP, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  desired_order_P <- c("MN", "NY", "KS", "WI")
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
  #view(emtrends_df)
emtrends_result<-emtrends(modNTCPXF1,~ P, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  desired_order_P <- c("MN", "NY", "KS", "WI")
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
  #view(emtrends_df)

  #equations table N:C
emtrends_result<-emtrends(modNTCPXF1,~ CROP, var= "N", infer=TRUE)
emtrends_df <- as.data.frame(emtrends_result)
emmeans_results<-emmeans(modNTCPXF1, ~CROP, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
merged_df <- emtrends_df %>%
  inner_join(emmeans_df, by = c( "CROP")) %>%
  select(CROP, emmean, N.trend, SE.x)
view(merged_df)
merged_df$CROP <- factor(merged_df$C, levels = c("inter", "monoI", "monoA"))  # Preferred order for CROP
# Create a new data frame with the calculated column
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
sorted_df <- new_df %>%
  arrange( CROP)
view(sorted_df)

 #equations table N:P
  emtrends_result<-emtrends(modNTCPXF1,~ P, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  desired_order_P <- c("MN", "NY", "KS", "WI")
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
emmeans_results<-emmeans(modNTCPXF1, ~P, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
merged_df <- emtrends_df %>%
  inner_join(emmeans_df, by = c("P")) %>%
  select(P, emmean, N.trend, SE.x)
view(merged_df)
merged_df$P <- factor(merged_df$P, levels = c("MN", "NY", "KS", "WI"))  # Preferred order for P
# Create a new data frame with the calculated column
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
sorted_df <- new_df %>%
  arrange(P)
view(sorted_df)
```
#Total CP year 2 summer
```{r}
modNTCPYS<-lmer(totCP~N*P*CROP + (1|Rep), data=NdYSf)
anova(modNTCPYS)
#check assumptions 
NTCPYS_resid<-resid(modNTCPYS)
qqnorm(NTCPYS_resid)
qqline(NTCPYS_resid)
plot(modNTCPYS)
#try log
modNTCPYS1<-lmer(log(totCP)~N*P*CROP + (1|Rep), data=NdYSf)
NTCPYS_resid1<-resid(modNTCPYS1)
qqnorm(NTCPYS_resid1)
qqline(NTCPYS_resid1)
plot(modNTCPYS1)

#Pairwise N:P
N_levels <- c(0, 40, 80, 120, 160)
emmsNTCPYS <- emmeans(modNTCPYS1, specs = ~ N*P, at = list(N = N_levels), type = "response")
cld_dataNTCPYSNP <- cld(emmsNTCPYS, Letters=custom_letters) # Create compact letter display
cld_dataNTCPYSNP$response <- format(cld_dataNTCPYSNP$emmean, digits = 5)
cld_dataNTCPYSNP<- cld_dataNTCPYSNP %>%
  select(N, P, response, .group)
rownames(cld_dataNTCPYSNP) <- NULL
colnames(cld_dataNTCPYSNP) <- c("N", "Site", "Total Forage (kg ha-1)", "Group")
cld_dataNTCPYSNP  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise N:C
N_levels <- c(0, 40, 80, 120, 160)
emmsNTCPYS <- emmeans(modNTCPYS1, specs = ~ N*CROP, at = list(N = N_levels), type = "response")
cld_dataNTCPYSNC <- cld(emmsNTCPYS, Letters=custom_letters) # Create compact letter display
cld_dataNTCPYSNC$response <- format(cld_dataNTCPYSNC$emmean, digits = 5)
cld_dataNTCPYSNC<- cld_dataNTCPYSNC %>%
  select(N, CROP, response, .group)
rownames(cld_dataNTCPYSNC) <- NULL
colnames(cld_dataNTCPYSNC) <- c("N", "Cropping System", "Total Forage (kg ha-1)", "Group")
cld_dataNTCPYSNC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

#This gives us the slope for each interactions as well as a P value indicating significance level for that slope
emtrends_result<-emtrends(modNTCPYS1,~ P*CROP, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  desired_order_P <- c("MN", "NY", "KS", "WI")
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
  #view(emtrends_df)
emtrends_result<-emtrends(modNTCPYS1,~ P, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  desired_order_P <- c("MN", "NY", "KS", "WI")
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
  #view(emtrends_df)
emtrends_result<-emtrends(modNTCPYS1,~ CROP, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  #view(emtrends_df)
  
  #equations table N:C
emtrends_result<-emtrends(modNTCPYS1,~ CROP, var= "N", infer=TRUE)
emtrends_df <- as.data.frame(emtrends_result)
emmeans_results<-emmeans(modNTCPYS1, ~CROP, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
merged_df <- emtrends_df %>%
  inner_join(emmeans_df, by = c( "CROP")) %>%
  select(CROP, emmean, N.trend, SE.x)
view(merged_df)
merged_df$CROP <- factor(merged_df$C, levels = c("inter", "monoI", "monoA"))  # Preferred order for CROP
# Create a new data frame with the calculated column
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
sorted_df <- new_df %>%
  arrange( CROP)
view(sorted_df)

 #equations table N:P
  emtrends_result<-emtrends(modNTCPYS1,~ P, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  desired_order_P <- c("MN", "NY", "KS", "WI")
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
emmeans_results<-emmeans(modNTCPYS1, ~P, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
merged_df <- emtrends_df %>%
  inner_join(emmeans_df, by = c("P")) %>%
  select(P, emmean, N.trend, SE.x)
view(merged_df)
merged_df$P <- factor(merged_df$P, levels = c("MN", "NY", "KS", "WI"))  # Preferred order for P
# Create a new data frame with the calculated column
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
sorted_df <- new_df %>%
  arrange(P)
view(sorted_df)
```
#Total CP year 2 Fall
```{r}
modNTCPYF<-lmer(totCP~N*P*CROP + (1|Rep), data=NdYFf)
anova(modNTCPYF)
#check assumptions 
NTCPYF_resid<-resid(modNTCPYF)
qqnorm(NTCPYF_resid)
qqline(NTCPYF_resid)
plot(modNTCPYF)
#try log
modNTCPYF1<-lmer(log(totCP)~N*P*CROP + (1|Rep), data=NdYFf)
NTCPYF_resid1<-resid(modNTCPYF1)
qqnorm(NTCPYF_resid1)
qqline(NTCPYF_resid1)
plot(modNTCPYF1)

#Pairwise N:C
N_levels <- c(0, 40, 80, 120, 160)
emmsNTCPYF <- emmeans(modNTCPYF1, specs = ~ N*CROP, at = list(N = N_levels), type = "response")
cld_dataNTCPYFNC <- cld(emmsNTCPYF, Letters=custom_letters) # Create compact letter display
cld_dataNTCPYFNC$response <- format(cld_dataNTCPYFNC$emmean, digits = 5)
cld_dataNTCPYFNC<- cld_dataNTCPYFNC %>%
  select(N, CROP, response, .group)
rownames(cld_dataNTCPYFNC) <- NULL
colnames(cld_dataNTCPYFNC) <- c("N", "Cropping System", "Total CP", "Group")
cld_dataNTCPYFNC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise P:C
emmsNTCPYF <- emmeans(modNTCPYF1, specs = ~ P*CROP,  type = "response")
cld_dataNTCPYFPC <- cld(emmsNTCPYF, Letters=custom_letters) # Create compact letter display
cld_dataNTCPYFPC$response <- format(cld_dataNTCPYFPC$response, digits = 5)
cld_dataNTCPYFPC<- cld_dataNTCPYFPC %>%
  select(P, CROP, response, .group)
rownames(cld_dataNTCPYFPC) <- NULL
colnames(cld_dataNTCPYFPC) <- c("Site", "Cropping System", "Total CP", "Group")
cld_dataNTCPYFPC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

  #equations table N:C
emtrends_result<-emtrends(modNTCPYF1,~ CROP, var= "N", infer=TRUE)
emtrends_df <- as.data.frame(emtrends_result)
emmeans_results<-emmeans(modNTCPYF1, ~CROP, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
merged_df <- emtrends_df %>%
  inner_join(emmeans_df, by = c( "CROP")) %>%
  select(CROP, emmean, N.trend, SE.x)
view(merged_df)
merged_df$CROP <- factor(merged_df$C, levels = c("inter", "monoI", "monoA"))  # Preferred order for CROP
# Create a new data frame with the calculated column
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
sorted_df <- new_df %>%
  arrange( CROP)
view(sorted_df)
```
#Total CP N:E:C plot
```{r}
NdXSf1$predictedCP <- predict(modNTCPXS1, newdata = NdXSf1, re.form = NA)
NdXFf$predictedCP <- predict(modNTCPXF1, newdata = NdXFf, re.form = NA)
NdYSf$predictedCP <- predict(modNTCPYS1, newdata = NdYSf, re.form = NA)
NdYFf$predictedCP <- predict(modNTCPYF1, newdata = NdYFf, re.form = NA)
desired_order <- c("MN", "NY", "KS", "WI")
NdYFf$P <- factor(NdYFf$P, levels = desired_order)
NdXSf1$P <- factor(NdXSf1$P, levels = desired_order)

# Layer all the plots together!
colors <- c("Year 1 Summer Harvest" = "red", 
            "Year 1 Fall Harvest" = "green", 
            "Year 2 Summer Harvest" = "blue", 
            "Year 2 Fall Harvest" = "purple")
legend_order <- c("Year 1 Summer Harvest")
NdXSf$P <- factor(NdXSf$P, levels = desired_order)


max(NdXSf1$totCP)
max(NdXFf$totCP)
max(NdYSf$totCP)
max(NdYFf$totCP)
TCPcomboplot <- ggplot() +
  geom_line(data = NdXSf1, aes(N, exp(predictedCP), color = "Year 1 Summer Harvest", linetype= CROP)) +
  geom_point(data =NdXSf1, aes(x = N, y = totCP, color = "Year 1 Summer Harvest", shape= CROP)) +
  labs(x = "N-Rate (kg ha-1)", y = "Total CP",
    color = "Harvest", 
    linetype = "Cropping System", shape = "Cropping System") +
  scale_x_continuous(breaks = c(0, 40, 80, 120, 160)) +
  ylim(0, 25) +
  facet_wrap(~P, scales = "free", ncol = 2) +
  scale_color_manual(values = colors, limits = legend_order)+
  scale_shape_manual(values = c(4, 20, 25),labels = c("Intercropped", "Monoculture Alfalfa", "Monoculture IWG") )+
  scale_linetype_manual(values = c("inter" = "solid", "monoA" = "dotted", "monoI" = "dashed"),labels = c("Intercropped", "Monoculture Alfalfa", "Monoculture IWG"))


print(TCPcomboplot)

ggsave("TCPcomboplot.jpg", plot = TCPcomboplot, width = 8, height = 6, dpi = 300)
```
#Total CP N:E plot
```{r}
NdXSf1$predictedCP <- predict(modNTCPXS1, newdata = NdXSf1, re.form = NA)
NdXFf$predictedCP <- predict(modNTCPXF1, newdata = NdXFf, re.form = NA)
NdYSf$predictedCP <- predict(modNTCPYS1, newdata = NdYSf, re.form = NA)
NdYFf$predictedCP <- predict(modNTCPYF1, newdata = NdYFf, re.form = NA)
desired_order <- c("MN", "NY", "KS", "WI")
NdYFf$P <- factor(NdYFf$P, levels = desired_order)
NdXSf1$P <- factor(NdXSf1$P, levels = desired_order)

# Layer all the plots together!
colors <- c("Year 1 Summer Harvest" = "red", 
            "Year 1 Fall Harvest" = "green", 
            "Year 2 Summer Harvest" = "blue", 
            "Year 2 Fall Harvest" = "purple")
legend_order <- c("Year 1 Fall Harvest", 
                  "Year 2 Summer Harvest")
NdXFf$P <- factor(NdXFf$P, levels = desired_order)


max(NdXSf1$totCP)
max(NdXFf$totCP)
max(NdYSf$totCP)
max(NdYFf$totCP)
desired_order <- c("MN", "NY", "KS", "WI")
TCPcomboplotNE <- ggplot() +
  geom_point(data = NdXFf, aes(x = N, y = totCP, color = "Year 1 Fall Harvest", shape= CROP)) +
  geom_point(data = NdYSf, aes(x = N, y = totCP, color = "Year 2 Summer Harvest", shape= CROP)) +
  labs(x = "N-Rate (kg ha-1)", y = "Total CP",
    color = "Harvest", shape = "Cropping System") +
  scale_x_continuous(breaks = c(0, 40, 80, 120, 160)) +
  ylim(0, 25) +
  facet_wrap(~P, scales = "free", ncol = 2) +
  scale_color_manual(values = colors, limits = legend_order)+
  scale_shape_manual(values = c(4, 20, 25),labels = c("Intercropped", "Monoculture Alfalfa", "Monoculture IWG") )+
  geom_function(data=subset(NdXFf, P== "MN"), fun=~18.67*exp(0.0000*.x),color='green')+
  geom_function(data=subset(NdXFf, P== "NY"), fun=~18.80*exp(-0.0005*.x),color='green')+
  geom_function(data=subset(NdXFf, P== "WI"), fun=~14.21*exp(0.0001*.x),color='green')+
  geom_function(data=subset(NdYSf, P== "NY"), fun=~9.05*exp(-0.0019*.x),color='blue')+
  geom_function(data=subset(NdYSf, P== "KS"), fun=~8.62*exp(0.0001*.x),color='blue')+
  geom_function(data=subset(NdYSf, P== "WI"), fun=~4.39*exp(0.0006*.x),color='blue')
  


print(TCPcomboplotNE)

ggsave("TCPcomboplotNE.jpg", plot = TCPcomboplot, width = 8, height = 6, dpi = 300)
```
#Total CP N:C plot
```{r}
NdXSf1$predictedCP <- predict(modNTCPXS1, newdata = NdXSf1, re.form = NA)
NdXFf$predictedCP <- predict(modNTCPXF1, newdata = NdXFf, re.form = NA)
NdYSf$predictedCP <- predict(modNTCPYS1, newdata = NdYSf, re.form = NA)
NdYFf$predictedCP <- predict(modNTCPYF1, newdata = NdYFf, re.form = NA)
desired_order <- c("MN", "NY", "KS", "WI")
NdYFf$P <- factor(NdYFf$P, levels = desired_order)
NdXSf1$P <- factor(NdXSf1$P, levels = desired_order)

# Layer all the plots together!
colors <- c("Year 1 Summer Harvest" = "red", 
            "Year 1 Fall Harvest" = "green", 
            "Year 2 Summer Harvest" = "blue", 
            "Year 2 Fall Harvest" = "purple")
legend_order <- c("Year 1 Fall Harvest", "Year 2 Summer Harvest", "Year 2 Fall Harvest")
NdXSf$P <- factor(NdXSf$P, levels = desired_order)
NdXFf$P <- factor(NdXFf$P, levels = desired_order)

max(NdXSf1$totCP)
max(NdXFf$totCP)
max(NdYSf$totCP)
max(NdYFf$totCP)
TCPcomboplotNC <- ggplot() +
  geom_point(data =NdXFf, aes(x = N, y = totCP, color = "Year 1 Fall Harvest", shape= CROP)) +
  geom_point(data =NdYSf, aes(x = N, y = totCP, color = "Year 2 Summer Harvest", shape= CROP)) +
  geom_point(data =NdYFf, aes(x = N, y = totCP, color = "Year 2 Fall Harvest", shape= CROP)) +
  labs(x = "N-Rate (kg ha-1)", y = "Total CP",
    color = "Harvest", shape = "Cropping System") +
  scale_x_continuous(breaks = c(0, 40, 80, 120, 160)) +
  ylim(0, 25) +
  scale_color_manual(values = colors, limits = legend_order)+
  scale_shape_manual(values = c(4, 20, 25),labels = c("Intercropped", "Monoculture Alfalfa", "Monoculture IWG") )+
  geom_function(data=subset(NdXFf, CROP== "inter"), fun=~18.66*exp(0.0002*.x),color='green', linetype = "solid")+
  geom_function(data=subset(NdXFf, CROP== "monoI"), fun=~17.63*exp(-0.0004*.x),color='green', linetype = "dashed")+
  geom_function(data=subset(NdXFf, CROP== "monoA"), fun=~19.43*exp(-0.0001*.x),color='green', linetype = "dotted")+
  geom_function(data=subset(NdYSf, CROP== "inter"), fun=~7.95*exp(-0.0020*.x),color='blue', linetype = "solid")+
  geom_function(data=subset(NdYSf, CROP== "monoI"), fun=~3.00*exp(0.0009*.x),color='blue', linetype = "dashed")+
  geom_function(data=subset(NdYSf, CROP== "monoA"), fun=~14.40*exp(-0.0001*.x),color='blue', linetype = "dotted")+
   geom_function(data=subset(NdYFf, CROP== "inter"), fun=~20.20*exp(-0.0000*.x),color='purple', linetype = "solid")+
   geom_function(data=subset(NdYFf, CROP== "monoI"), fun=~15.31*exp(-0.0007*.x),color='purple', linetype = "dashed")+
     geom_function(data=subset(NdYFf, CROP== "monoA"), fun=~20.72*exp(0.0001*.x),color='purple', linetype = "dotted")+
  geom_line(aes(x = c(0, 0), y = c(0, 0), linetype = "Intercropped")) +
  geom_line(aes(x = c(0, 0), y = c(0, 0), linetype = "Monoculture IWG"))+
   geom_line(aes(x = c(0, 0), y = c(0, 0), linetype = "Monoculture Alfalfa"))+
  scale_linetype_manual(name = "Cropping System", values = c("solid", "dashed", "dotted"), labels = c("Intercropped", "Monoculture Alfalfa","Monoculture IWG")) +
  guides(linetype = guide_legend(override.aes = list(color = 'black'), title= "Line Type"))
   

print(TCPcomboplotNC)

ggsave("TCPcomboplotNC.jpg", plot = TCPcomboplotNC, width = 8, height = 6, dpi = 300)
```
#Total CP E:C plots (XF and YF)
```{r}
#XF
TCPXFemmsPC <- emmeans(modNTCPXF1, ~ P*CROP, type = "response") # Obtain estimated marginal means (excluding N)
emms_df <- as.data.frame(TCPXFemmsPC)
cld_dataTCPXFPC <- cld(TCPXFemmsPC, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataTCPXFPC)
merged_df <- merge(emms_df, cld_df,by = c("P", "CROP"))
custom_labels <- c("Intercrop", "Monoculture Alfalfa", "Monoculture IWG")
custom_colors <- c("darkmagenta", "coral1", "cyan") 
TCPXFPC<-ggplot(NdXFf, aes(x = P, y = exp(predictedCP), color = CROP)) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7) +
  labs(x = "Environment", y = "Total CP") +
  geom_point(data = emms_df, aes(x = P, y = response), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 2)+
  scale_color_manual(name = "Cropping System", labels = custom_labels,values = custom_colors)+
     ggtitle("Year 1 Fall")+
  theme(plot.title = element_text(hjust = 0.5))+
   guides(color = "none")+
  scale_y_continuous(breaks = c(10,12.5, 15,17.5,20,22.5), limits = c(10, 25))

print(TCPXFPC)

#YF
TCPYFemmsPC <- emmeans(modNTCPYF1, ~ P*CROP, type = "response") # Obtain estimated marginal means (excluding N)
emms_df <- as.data.frame(TCPYFemmsPC)
cld_dataTCPYFPC <- cld(TCPYFemmsPC, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataTCPYFPC)
merged_df <- merge(emms_df, cld_df,by = c("P", "CROP"))
custom_labels <- c("Intercrop", "Monoculture Alfalfa", "Monoculture IWG")
custom_colors <- c("darkmagenta", "coral1", "cyan") 
TCPYFPC<-ggplot(NdYFf, aes(x = P, y = exp(predictedCP), color = CROP)) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7) +
  labs(x = "Environment", y = "Total CP") +
  geom_point(data = emms_df, aes(x = P, y = response), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 2)+
  scale_color_manual(name = "Cropping System", labels = custom_labels,values = custom_colors)+
     ggtitle("Year 2 Fall")+
  theme(plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(breaks = c(10,12.5, 15,17.5,20,22.5), limits = c(10, 25))
print(TCPYFPC)




TCPEC<-grid.arrange(TCPXFPC, TCPYFPC, ncol = 2)
ggsave("TCPEC.jpg", plot = TCPEC, width =12, height = 6, dpi = 350)
```


#Total RFV year 1 summer
```{r}
modNTRFVXS<-lmer(totRFV~N*P*CROP + (1|Rep), data=NdXSo)
anova(modNTRFVXS)
#check assumptions 
NTRFVXS_resid<-resid(modNTRFVXS)
qqnorm(NTRFVXS_resid)
qqline(NTRFVXS_resid)
plot(modNTRFVXS)
#try log
#Remove a row with a 0 result
modNTRFVXS1<-lmer(log(totRFV)~N*P*CROP + (1|Rep), data=NdXSo)
NTRFVXS_resid1<-resid(modNTRFVXS1)
qqnorm(NTRFVXS_resid1)
qqline(NTRFVXS_resid1)
plot(modNTRFVXS1)
anova(modNTRFVXS1)

#Pairwise P:C
emmsNTRFVXS <- emmeans(modNTRFVXS1, specs = ~ P*CROP,  type = "response")
cld_dataNTRFVXSPC <- cld(emmsNTRFVXS, Letters=custom_letters) # Create compact letter display
cld_dataNTRFVXSPC$response <- format(cld_dataNTRFVXSPC$response, digits = 5)
cld_dataNTRFVXSPC<- cld_dataNTRFVXSPC %>%
  select(P, CROP, response, .group)
rownames(cld_dataNTRFVXSPC) <- NULL
colnames(cld_dataNTRFVXSPC) <- c("Site", "Cropping System", "Total CP", "Group")
cld_dataNTRFVXSPC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

#slope stuff 
emtrends_result<-emtrends(modNTCPYF,~ CROP, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  #view(emtrends_df)
```
#Total RFV year 1 fall
```{r}
modNTRFVXF<-lmer(totRFV~N*P*CROP + (1|Rep), data=NdXFo)
anova(modNTRFVXF)
#check assumptions 
NTRFVXF_resid<-resid(modNTRFVXF)
qqnorm(NTRFVXF_resid)
qqline(NTRFVXF_resid)
plot(modNTRFVXF)
#try log 
modNTRFVXF1<-lmer(log(totRFV)~N*P*CROP + (1|Rep), data=NdXFo)
NTRFVXF_resid1<-resid(modNTRFVXF1)
qqnorm(NTRFVXF_resid1)
qqline(NTRFVXF_resid1)
plot(modNTRFVXF1)
anova(modNTRFVXF1)
#Pairwise P
emmsP <- emmeans(modNTRFVXF1, specs = ~ P, type = "response")
cld_dataNTRFVXF1P <- cld(emmsP, Letters=custom_letters) # Create compact letter display
cld_dataNTRFVXF1P $response <- format(cld_dataNTRFVXF1P $response, digits = 5)
rownames(cld_dataNTRFVXF1P ) <- NULL
cld_dataNTRFVXF1P <- cld_dataNTRFVXF1P  %>%
  select( P, response, .group)
colnames(cld_dataNTRFVXF1P ) <- c( "Site", "IWG RFV", "Group")
cld_dataNTRFVXF1P   |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise C
emmsC <- emmeans(modNTRFVXF1, specs = ~ CROP, type = "response")
cld_dataNTRFVXF1C <- cld(emmsC, Letters=custom_letters) # Create compact letter display
cld_dataNTRFVXF1C $response <- format(cld_dataNTRFVXF1C $response, digits = 5)
rownames(cld_dataNTRFVXF1C ) <- NULL
cld_dataNTRFVXF1C <- cld_dataNTRFVXF1C  %>%
  select( CROP, response, .group)
colnames(cld_dataNTRFVXF1C ) <- c( "Cropping System", "IWG RFV", "Group")
cld_dataNTRFVXF1C   |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
```
#Total RFV year 2 summer
```{r}
modNTRFVYS<-lmer(totRFV~N*P*CROP + (1|Rep), data=NdYSo)
anova(modNTRFVYS)
#check assumptions 
NTRFVYS_resid<-resid(modNTRFVYS)
qqnorm(NTRFVYS_resid)
qqline(NTRFVYS_resid)
plot(modNTRFVYS)
#try log. 
modNTRFVYS1<-lmer(log(totRFV)~N*P*CROP + (1|Rep), data=NdYSo)
NTRFVYS_resid1<-resid(modNTRFVYS1)
qqnorm(NTRFVYS_resid1)
qqline(NTRFVYS_resid1)
plot(modNTRFVYS1)
anova(modNTRFVYS1)

#Pairwise NPC
emmsNPC <- emmeans(modNTRFVYS1, ~ N*P*CROP,at= list(N = N_levels), type= "response") 
cld_dataNTRFVYSNPC <- cld(emmsNPC, Letters=custom_letters) # Create compact letter display
cld_dataNTRFVYSNPC$response <- format(cld_dataNTRFVYSNPC$response, digits = 5)
rownames(cld_dataNTRFVYSNPC) <- NULL
cld_dataNTRFVYSNPC<- cld_dataNTRFVYSNPC %>%
  select(N, P, CROP, response, .group)
colnames(cld_dataNTRFVYSNPC) <- c("N", "Site", "Cropping System", "Total RFV", "Group")
cld_dataNTRFVYSNPC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

#Pairwise N
emmsN <- emmeans(modNTRFVYS1, ~ N,at= list(N = N_levels), type= "response") 
cld_dataNTRFVYSN <- cld(emmsN, Letters=custom_letters) # Create compact letter display
cld_dataNTRFVYSN$response <- format(cld_dataNTRFVYSN$response, digits = 5)
rownames(cld_dataNTRFVYSN) <- NULL
cld_dataNTRFVYSN<- cld_dataNTRFVYSN %>%
  select(N, response, .group)
colnames(cld_dataNTRFVYSN) <- c("N", "Total RFV", "Group")
cld_dataNTRFVYSN  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

#This gives us the slope for each interactions as well as a P value indicating significance level for that slope
emtrends_result<-emtrends(modNTRFVYS1,~ P*CROP, var= "N", infer=TRUE)
  emtrends_df <- as.data.frame(emtrends_result)
  desired_order_P <- c("MN", "NY", "KS", "WI")
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
  #view(emtrends_df)

  summary(modNTRFVYS1)
  
  #emmeans for intercepts! via erika
emtrends_result<-emtrends(modNTRFVYS1,~ P*CROP, var= "N", infer=TRUE)
emtrends_df <- as.data.frame(emtrends_result)
  emtrends_df$P <- factor(emtrends_df$P, levels = desired_order_P)
emmeans_results<-emmeans(modNTRFVYS1, ~P*CROP, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
merged_df <- emtrends_df %>%
  inner_join(emmeans_df, by = c("P", "CROP")) %>%
  select(P, CROP, emmean, N.trend, SE.x)
view(merged_df)
merged_df$P <- factor(merged_df$P, levels = c("MN", "NY", "KS", "WI"))  # Preferred order for P
merged_df$CROP <- factor(merged_df$CROP, levels = c("inter", "monoI","monoA"))  # Preferred order for CROP
# Create a new data frame with the calculated column
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
sorted_df <- new_df %>%
  arrange(P, CROP)
view(sorted_df)
```
#Total RFV year 2 Fall
```{r}
modNTRFVYF<-lmer(totRFV~N*P*CROP + (1|Rep), data=NdYFo)
anova(modNTRFVYF)
#check assumptions 
NTRFVYF_resid<-resid(modNTRFVYF)
qqnorm(NTRFVYF_resid)
qqline(NTRFVYF_resid)
plot(modNTRFVYF)
#try log
modNTRFVYF1<-lmer(log(totRFV)~N*P*CROP + (1|Rep), data=NdYFo)
NTRFVYF_resid1<-resid(modNTRFVYF1)
qqnorm(NTRFVYF_resid1)
qqline(NTRFVYF_resid1)
plot(modNTRFVYF1)
#Pairwise C
emmsC <- emmeans(modNTRFVYF1, specs = ~ CROP, type = "response")
cld_dataNTRFVYF1C <- cld(emmsC, Letters=custom_letters) # Create compact letter display
cld_dataNTRFVYF1C $response <- format(cld_dataNTRFVYF1C $response, digits = 5)
rownames(cld_dataNTRFVYF1C ) <- NULL
cld_dataNTRFVYF1C <- cld_dataNTRFVYF1C  %>%
  select( CROP, response, .group)
colnames(cld_dataNTRFVYF1C ) <- c( "Cropping System", "IWG RFV", "Group")
cld_dataNTRFVYF1C   |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise P
emmsP <- emmeans(modNTRFVYF1, specs = ~ P, type = "response")
cld_dataNTRFVYF1P <- cld(emmsP, Letters=custom_letters) # Create compact letter display
cld_dataNTRFVYF1P $response <- format(cld_dataNTRFVYF1P$response, digits = 5)
rownames(cld_dataNTRFVYF1P ) <- NULL
cld_dataNTRFVYF1P <- cld_dataNTRFVYF1P  %>%
  select( P, response, .group)
colnames(cld_dataNTRFVYF1P ) <- c( "Site", "IWG RFV", "Group")
cld_dataNTRFVYF1P   |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
```

#Total RFV plot N:E:C
```{r}
NdXSo$predictedRFV <- predict(modNTRFVXS1, newdata = NdXSo, re.form = NA)
NdXFo$predictedRFV <- predict(modNTRFVXF1, newdata = NdXFo, re.form = NA)
NdYSo$predictedRFV <- predict(modNTRFVYS1, newdata = NdYSo, re.form = NA)
NdYFo$predictedRFV <- predict(modNTRFVYF1, newdata = NdYFo, re.form = NA)

# Layer all the plots together!
colors <- c("Year 1 Summer Harvest" = "red", 
            "Year 1 Fall Harvest" = "green", 
            "Year 2 Summer Harvest" = "blue", 
            "Year 2 Fall Harvest" = "purple")
legend_order <- c( "Year 2 Summer Harvest")
NdYSo$P <- factor(NdYSo$P, levels = desired_order)
max(NdXSo$totRFV)
max(NdXFo$totRFV)
max(NdYSo$totRFV)
max(NdYFo$totRFV)
TRFVcomboplot <- ggplot() +
  geom_line(data = NdYSo, aes(N, exp(predictedRFV), color = "Year 2 Summer Harvest", linetype= CROP)) +
  geom_point(data = NdYSo, aes(x = N, y = totRFV, color = "Year 2 Summer Harvest", shape= CROP)) +
  labs(x = "N-Rate (kg ha-1)", y = "Total RFV",
    color = "Harvest", 
    linetype = "Cropping System", shape = "Cropping System") +
  scale_x_continuous(breaks = c(0, 40, 80, 120, 160)) +
  ylim(0, 190) +
  facet_wrap(~P, scales = "free", ncol = 2) +
  scale_color_manual(values = colors, limits = legend_order)+
   scale_shape_manual(values = c(4, 20, 25),labels = c("Intercropped", "Monoculture Alfalfa", "Monoculture IWG") )+
  scale_linetype_manual(values = c("inter" = "solid", "monoA" = "dotted", "monoI" = "dashed"),labels = c("Intercropped", "Monoculture Alfalfa", "Monoculture IWG"))


print(TRFVcomboplot)

ggsave("TRFVcomboplot.jpg", plot = TRFVcomboplot, width = 8, height = 6, dpi = 300)
```
#Total RFV E:C plots (XS)
```{r}
#XS
TRFVXSemmsPC <- emmeans(modNTRFVXS1, ~ P*CROP, type = "response") # Obtain estimated marginal means (excluding N)
emms_df <- as.data.frame(TRFVXSemmsPC)
cld_dataTRFVXSPC <- cld(TRFVXSemmsPC, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataTRFVXSPC)
merged_df <- merge(emms_df, cld_df,by = c("P", "CROP"))
custom_labels <- c("Intercrop", "Monoculture Alfalfa", "Monoculture IWG")
custom_colors <- c("darkmagenta", "coral1", "cyan") 
TRFVXSPC<-ggplot(NdXSo, aes(x = P, y = exp(predictedRFV), color = CROP)) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7) +
  labs(x = "Environment", y = "Total RFV") +
  geom_point(data = emms_df, aes(x = P, y = response), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 2)+
  scale_color_manual(name = "Cropping System", labels = custom_labels,values = custom_colors)+
     ggtitle("Year 1 Summer")+
  theme(plot.title = element_text(hjust = 0.5))

print(TRFVXSPC)

ggsave("TRFVXSPC.jpg", plot = TRFVXSPC, width =12, height = 6, dpi = 350)
```
#Total RFV E plots (XF, YF)
```{r}
#XF 
NTRFVXFemmsP <- emmeans(modNTRFVXF1, ~ P, type = "response") 
emms_df <- as.data.frame(NTRFVXFemmsP)
cld_dataNTRFVXFP <- cld(NTRFVXFemmsP, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataNTRFVXFP)
merged_df <- merge(emms_df, cld_df,by = c("P"))
TRFVXFE<-ggplot(NdXFo, aes(x = P, y = exp(predictedRFV))) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7, color="darkgreen") +
  labs(x = "Environment", y = "Toal RFV") +
  geom_point(data = emms_df, aes(x = P, y = response), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 1.8)+
  ggtitle("Year 1 Fall")+
  scale_y_continuous(breaks = c(100, 120, 140, 160), limits = c(85, 160))

#YF 
NTRFVYFemmsP <- emmeans(modNTRFVYF1, ~ P, type = "response") 
emms_df <- as.data.frame(NTRFVYFemmsP)
cld_dataNTRFVYFP <- cld(NTRFVYFemmsP, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataNTRFVYFP)
merged_df <- merge(emms_df, cld_df,by = c("P"))
TRFVYFE<-ggplot(NdYFo, aes(x = P, y = exp(predictedRFV))) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7, color="darkgreen") +
  labs(x = "Environment", y = "Toal RFV") +
  geom_point(data = emms_df, aes(x = P, y = response), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 1.8)+
  ggtitle("Year 2 Fall")+
  scale_y_continuous(breaks = c(100, 120, 140, 160), limits = c(85, 160))

TRFVE<-grid.arrange(TRFVXFE, TRFVYFE, ncol = 2)
ggsave("TRFVE.jpg", plot = TRFVE, width =12, height = 6, dpi = 350)
```
#Total RFV C pots (XF, YF) 
```{r}
#XF
custom_labels <- c("Intercrop", "Monoculture Alfalfa","Monoculture IWG")
custom_colors <- c("darkmagenta","coral1", "cyan") 
NXFTRFVemmsC <- emmeans(modNTRFVXF1, ~ CROP, type = "response") 
emms_df <- as.data.frame(NXFTRFVemmsC)
cld_dataNXFTRFVC <- cld(NXFTRFVemmsC, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataNXFTRFVC)
merged_df <- merge(emms_df, cld_df,by = c("CROP"))
TRFVXFC<-ggplot(NdXFo, aes(x = CROP, y = exp(predictedRFV), color= CROP)) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7) +
  labs(x = "Cropping System", y = "Total RFV") +
  ggtitle("Year 1 Fall")+
  geom_point(data = emms_df, aes(x = CROP, y = response), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = CROP, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = CROP, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 1.8)+
  scale_color_manual(name = "Cropping System", labels = custom_labels,values = custom_colors)+
  scale_x_discrete(labels = custom_labels)+
  theme(legend.position = "none")+
  scale_y_continuous(breaks = c(100,120,140,160), limits = c(75, 160))

#YF
custom_labels <- c("Intercrop", "Monoculture Alfalfa","Monoculture IWG")
custom_colors <- c("darkmagenta","coral1", "cyan") 
NYFTRFVemmsC <- emmeans(modNTRFVYF1, ~ CROP, type = "response") 
emms_df <- as.data.frame(NYFTRFVemmsC)
cld_dataNYFTRFVC <- cld(NYFTRFVemmsC, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataNYFTRFVC)
merged_df <- merge(emms_df, cld_df,by = c("CROP"))
TRFVYFC<-ggplot(NdYFo, aes(x = CROP, y = exp(predictedRFV), color= CROP)) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7) +
  labs(x = "Cropping System", y = "Total RFV") +
  ggtitle("Year 2 Fall")+
  geom_point(data = emms_df, aes(x = CROP, y = response), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = CROP, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = CROP, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 1.8)+
  scale_color_manual(name = "Cropping System", labels = custom_labels,values = custom_colors)+
  scale_x_discrete(labels = custom_labels)+
  scale_y_continuous(breaks = c(100,120,140,160), limits = c(75, 160))

TRFVC<-grid.arrange(TRFVXFC, TRFVYFC, ncol = 2)
ggsave("TRFVC.jpg", plot = TRFVC, width =12, height = 6, dpi = 350)

```

#weed biomass~N*P*C? 

***

LER calculations 

# Nd SW 0 REMOVE ROWS 
```{r}
#get rid of 'Fill' to prevent a many-to-many join problem 
#NdZ<-Nd[-1,] 
#NdZ<-NdZ[-1,] 
#NdZ<-NdZ[-1,] 
#NdZ<-NdZ[-1,] 
#NdZ<-NdZ[-1,] 
#NdZ<-NdZ[-1,] 
#NdZ<-NdZ[-1,]

#IWG partial LER 
NdSW0IWGLER <- NdZ %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    PartialLERIWGSW0 = (PlotIWGDryKgHa[Treatment == 10]) / (PlotIWGDryKgHa[Treatment == 5])
  )
print(NdSW0IWGLER)

#Alf partial LER 
NdSW0ALFLER <- NdZ %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    PartialLERAlfSW0 = (PlotAlfDryKgHa[Treatment == 10]) / (PlotAlfDryKgHa[Treatment == 15])
  )

print(NdSW0ALFLER)

#Total LER 
NdSW0TotalLER <- NdZ %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    TotalLERSW0 = (PlotIWGDryKgHa[Treatment == 10]) / (PlotIWGDryKgHa[Treatment == 5]) + (PlotAlfDryKgHa[Treatment == 10]) / (PlotAlfDryKgHa[Treatment == 15])
  ) 

print(NdSW0TotalLER)

#Join together first two tables

LERresults1<-left_join(NdSW0IWGLER, NdSW0ALFLER, by = c("Rep", "P", "YearCode", "Harvest"))
print(LERresults1)

#join together new joined table and third table 

LERresultsNdSW0<-left_join(LERresults1, NdSW0TotalLER, by = c("Rep", "P", "YearCode", "Harvest"))
print(LERresultsNdSW0)


```
#Nd SW 40 
```{r}
NdSW40IWGLER <- Nd %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    PartialLERIWGSW40 = (PlotIWGDryKgHa[Treatment == 11]) / (PlotIWGDryKgHa[Treatment == 6])
  )

print(NdSW40IWGLER)

#Alf partial LER 
NdSW40ALFLER <- Nd %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    PartialLERAlfSW40 = (PlotAlfDryKgHa[Treatment == 11]) / (PlotAlfDryKgHa[Treatment == 16])
  )

print(NdSW40ALFLER)

#Total LER 
NdSW40TotalLER <- Nd %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    TotalLERSW40 = (PlotIWGDryKgHa[Treatment == 11]) / (PlotIWGDryKgHa[Treatment == 6]) + (PlotAlfDryKgHa[Treatment == 11]) / (PlotAlfDryKgHa[Treatment == 16])
  ) 

print(NdSW40TotalLER)

#Join together first two tables

LERresults2<-left_join(NdSW40IWGLER, NdSW40ALFLER, by = c("Rep", "P", "YearCode", "Harvest"))
print(LERresults2)

#join together new joined table and third table 

LERresultsNdSW40<-left_join(LERresults2, NdSW40TotalLER, by = c("Rep", "P", "YearCode", "Harvest"))
print(LERresultsNdSW40)
```
#Nd SW 80
```{r}
#IWG partial LER 
NdSW80IWGLER <- Nd %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    PartialLERIWGSW80 = (PlotIWGDryKgHa[Treatment == 12]) / (PlotIWGDryKgHa[Treatment == 7])
  )

print(NdSW80IWGLER)

#Alf partial LER 
NdSW80ALFLER <- Nd %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    PartialLERAlfSW80 = (PlotAlfDryKgHa[Treatment == 12]) / (PlotAlfDryKgHa[Treatment == 17])
  )

print(NdSW80ALFLER)

#Total LER 
NdSW80TotalLER <- Nd %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    TotalLERSW80 = (PlotIWGDryKgHa[Treatment == 12]) / (PlotIWGDryKgHa[Treatment == 7]) + (PlotAlfDryKgHa[Treatment == 12]) / (PlotAlfDryKgHa[Treatment == 17])
  ) 

print(NdSW80TotalLER)

#Join together first two tables

LERresults3<-left_join(NdSW80IWGLER, NdSW80ALFLER, by = c("Rep", "P", "YearCode", "Harvest"))
print(LERresults3)

#join together new joined table and third table 

LERresultsNdSW80<-left_join(LERresults3, NdSW80TotalLER, by = c("Rep", "P", "YearCode", "Harvest"))
print(LERresultsNdSW80)
```
#Nd SW 120
```{r}
#IWG partial LER 
NdSW120IWGLER <- Nd %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    PartialLERIWGSW120 = (PlotIWGDryKgHa[Treatment == 13]) / (PlotIWGDryKgHa[Treatment == 8])
  )

print(NdSW120IWGLER)

#Alf partial LER 
NdSW120ALFLER <- Nd %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    PartialLERAlfSW120 = (PlotAlfDryKgHa[Treatment == 13]) / (PlotAlfDryKgHa[Treatment == 18])
  )

print(NdSW120ALFLER)

#Total LER 
NdSW120TotalLER <- Nd %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    TotalLERSW120 = (PlotIWGDryKgHa[Treatment == 13]) / (PlotIWGDryKgHa[Treatment == 8]) + (PlotAlfDryKgHa[Treatment == 13]) / (PlotAlfDryKgHa[Treatment == 18])
  ) 

print(NdSW120TotalLER)

#Join together first two tables

LERresults4<-left_join(NdSW120IWGLER, NdSW120ALFLER, by = c("Rep", "P", "YearCode", "Harvest"))
print(LERresults4)

#join together new joined table and third table 

LERresultsNdSW120<-left_join(LERresults4, NdSW120TotalLER, by = c("Rep", "P", "YearCode", "Harvest"))
print(LERresultsNdSW120)

```
#Nd SW 160
```{r}
#IWG partial LER 
NdSW160IWGLER <- Nd %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    PartialLERIWGSW160= (PlotIWGDryKgHa[Treatment == 14]) / (PlotIWGDryKgHa[Treatment == 9])
  )

print(NdSW160IWGLER)


#Alf partial LER 
NdSW160ALFLER <- Nd %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    PartialLERAlfSW160 = (PlotAlfDryKgHa[Treatment == 14]) / (PlotAlfDryKgHa[Treatment == 19])
  )

print(NdSW160ALFLER)

#Total LER 
NdSW160TotalLER <- Nd %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    TotalLERSW160 = (PlotIWGDryKgHa[Treatment == 14]) / (PlotIWGDryKgHa[Treatment == 9]) + (PlotAlfDryKgHa[Treatment == 14]) / (PlotAlfDryKgHa[Treatment == 19])
  ) 

print(NdSW160TotalLER)

#Join together first two tables

LERresults5<-left_join(NdSW160IWGLER, NdSW160ALFLER, by = c("Rep", "P", "YearCode", "Harvest"))
print(LERresults5)

#join together new joined table and third table 

LERresultsNdSW160<-left_join(LERresults5, NdSW160TotalLER, by = c("Rep", "P", "YearCode", "Harvest"))
print(LERresultsNdSW160)
```
#merge all LER results into one data frame
```{r}
LERresults6<-left_join(LERresultsNdSW0, LERresultsNdSW40, by = c("Rep", "P", "YearCode", "Harvest"))
print(LERresults6)

LERresults7<-left_join(LERresults6, LERresultsNdSW80, by = c("Rep", "P", "YearCode", "Harvest"))
print(LERresults7)

LERresults8<-left_join(LERresults7, LERresultsNdSW120, by = c("Rep", "P", "YearCode", "Harvest"))
print(LERresults8)

LERresultsNdSWALL<-left_join(LERresults8, LERresultsNdSW160, by = c("Rep", "P", "YearCode", "Harvest"))
print(LERresultsNdSWALL)

```

#Rearrange dataframe
```{r}
LERresultsNdSWALL_long <- LERresultsNdSWALL %>%
  pivot_longer(cols = starts_with("PartialLER") | starts_with("TotalLER"),
               names_to = "Nrate",
               values_to = "LER")

# Display the result
print(LERresultsNdSWALL_long)
print(LERresultsNdSWALL)

#try to make the dataframe more usable

#cut off total and partial 
LERresultsNdSWALL_long$Type <- sub("^(Partial|Total)", "", LERresultsNdSWALL_long$Nrate)
LERresultsNdSWALL_long$tot_or_part <- sub("^(Partial|Total).*", "\\1", LERresultsNdSWALL_long$Nrate)
print(LERresultsNdSWALL_long)

#cut off LERIWGSW and LERAlfSW and LERSW
LERresultsNdSWALL_long$NRATE <- sub("^(LERIWGSW|LERAlfSW|LERSW)", "", LERresultsNdSWALL_long$Type)
LERresultsNdSWALL_long$PlotType <- sub("^(LERIWGSW|LERAlfSW|LERSW).*", "\\1", LERresultsNdSWALL_long$Type)
print(LERresultsNdSWALL_long)

#get rid of pesky NA results (caused by missing plots inherent in year 1 KS summer data)
LERresultsNdSWALL_longNONA<- na.omit(LERresultsNdSWALL_long)
print(LERresultsNdSWALL_longNONA)

LERresultsNdSWALL_longNONA$NRATE<-as.numeric(LERresultsNdSWALL_longNONA$NRATE)

#includes total and partial until it doesn't...used for some pairwise comparison thingy. 
LERResultsAllX<-LERresultsNdSWALL_longNONA[LERresultsNdSWALL_longNONA$YearCode == 'X',]
LERResultsAllY<-LERresultsNdSWALL_longNONA[LERresultsNdSWALL_longNONA$YearCode == 'Y',]
LERResultsAllXS<-LERResultsAllX[LERResultsAllX$Harvest == 'Summer',]
  LERResultsTotXS<-LERResultsAllXS[LERResultsAllXS$tot_or_part == 'Total',]
  LERResultsPartIWGXS<-LERResultsAllXS[LERResultsAllXS$tot_or_part == 'Partial' & LERResultsAllXS$PlotType == 'LERIWGSW' ,]
  LERResultsPartAlfXS<-LERResultsAllXS[LERResultsAllXS$tot_or_part == 'Partial' & LERResultsAllXS$PlotType == 'LERAlfSW' ,]
LERResultsAllXF<-LERResultsAllX[LERResultsAllX$Harvest == 'Fall',]
  LERResultsTotXF<-LERResultsAllXF[LERResultsAllXF$tot_or_part == 'Total',]
  LERResultsPartIWGXF<-LERResultsAllXF[LERResultsAllXF$tot_or_part == 'Partial' & LERResultsAllXF$PlotType == 'LERIWGSW' ,]
  LERResultsPartAlfXF<-LERResultsAllXF[LERResultsAllXF$tot_or_part == 'Partial' & LERResultsAllXF$PlotType == 'LERAlfSW' ,]
LERResultsAllYS<-LERResultsAllY[LERResultsAllY$Harvest == 'Summer',]
  LERResultsTotYS<-LERResultsAllYS[LERResultsAllYS$tot_or_part == 'Total',]
  LERResultsPartIWGYS<-LERResultsAllYS[LERResultsAllYS$tot_or_part == 'Partial' & LERResultsAllYS$PlotType == 'LERIWGSW' ,]
  LERResultsPartAlfYS<-LERResultsAllYS[LERResultsAllYS$tot_or_part == 'Partial' & LERResultsAllYS$PlotType == 'LERAlfSW' ,]
LERResultsAllYF<-LERResultsAllY[LERResultsAllY$Harvest == 'Fall',]
  LERResultsTotYF<-LERResultsAllYF[LERResultsAllYF$tot_or_part == 'Total',]
  LERResultsPartIWGYF<-LERResultsAllYF[LERResultsAllYF$tot_or_part == 'Partial' & LERResultsAllYF$PlotType == 'LERIWGSW' ,]
  LERResultsPartAlfYF<-LERResultsAllYF[LERResultsAllYF$tot_or_part == 'Partial' & LERResultsAllYF$PlotType == 'LERAlfSW' ,]

#okay now I should be able to split by total and partial
TotalLERresults<-LERresultsNdSWALL_longNONA[LERresultsNdSWALL_longNONA$tot_or_part == 'Total',]
print(TotalLERresults)
  TotLERX<-TotalLERresults[TotalLERresults$YearCode == 'X',]
  TotLERY<-TotalLERresults[TotalLERresults$YearCode == 'Y',]
  TotLERXS<-TotLERX[TotLERX$Harvest == 'Summer',]
  TotLERXF<-TotLERX[TotLERX$Harvest == 'Fall',]
  TotLERYS<-TotLERY[TotLERY$Harvest == 'Summer',]
  TotLERYF<-TotLERY[TotLERY$Harvest == 'Fall',]
IWGPartialLERresults<-LERresultsNdSWALL_longNONA[LERresultsNdSWALL_longNONA$PlotType == 'LERIWGSW',]
IWGPartialLERresults$NRATE<- as.numeric(IWGPartialLERresults$NRATE)
  IWGPLERX<-IWGPartialLERresults[IWGPartialLERresults$YearCode == 'X',]
  IWGPLERY<-IWGPartialLERresults[IWGPartialLERresults$YearCode == 'Y',]
  IWGPLERXS<-IWGPLERX[IWGPLERX$Harvest == 'Summer',]
  IWGPLERXF<-IWGPLERX[IWGPLERX$Harvest == 'Fall',]
  IWGPLERYS<-IWGPLERY[IWGPLERY$Harvest == 'Summer',]
  IWGPLERYF<-IWGPLERY[IWGPLERY$Harvest == 'Fall',]
AlfPartialLERresults<-LERresultsNdSWALL_longNONA[LERresultsNdSWALL_longNONA$PlotType == 'LERAlfSW',]
AlfPartialLERresults$NRATE<- as.numeric(AlfPartialLERresults$NRATE)
  AlfPLERX<-AlfPartialLERresults[AlfPartialLERresults$YearCode == 'X',]
  AlfPLERY<-AlfPartialLERresults[AlfPartialLERresults$YearCode == 'Y',]
  AlfPLERXS<-AlfPLERX[AlfPLERX$Harvest == 'Summer',]
  AlfPLERXF<-AlfPLERX[AlfPLERX$Harvest == 'Fall',]
  AlfPLERYS<-AlfPLERY[AlfPLERY$Harvest == 'Summer',]
  AlfPLERYF<-AlfPLERY[AlfPLERY$Harvest == 'Fall',]
```

#Check for outliers
```{r}
identify_outliers(TotalLERresults[, 6]) #19 outliers 
identify_outliers(IWGPartialLERresults[, 6]) #26 outliers
identify_outliers(AlfPartialLERresults[, 6]) #4 outliers 
```

#rename variables in dataframes to make life easier 
```{r}

# Function to add new columns to a dataframe
add_new_columns <- function(df) {
  df$N <- df$NRATE
  return(df)
}

# List of dataframes (replace these with your actual dataframes)
df_list <- list(TotLERXS, TotLERYS, TotLERXF, TotLERYF, IWGPLERXS, IWGPLERXF,IWGPLERYS,IWGPLERYF,  AlfPLERXS, AlfPLERXF,AlfPLERYS,AlfPLERYF)

# Apply the function to each dataframe in the list
df_list <- lapply(df_list, add_new_columns)

# Access the modified dataframes in df_list
TotLERXS <- df_list[[1]]
TotLERYS <- df_list[[2]]
TotLERXF <- df_list[[3]]
TotLERYF<- df_list[[4]]
IWGPLERXS<- df_list[[5]]
IWGPLERXF<- df_list[[6]]
IWGPLERYS<- df_list[[7]]
IWGPLERYF<- df_list[[8]]
AlfPLERXS<- df_list[[9]]
AlfPLERXF<- df_list[[10]]
AlfPLERYS<- df_list[[11]]
AlfPLERYF<- df_list[[12]]


```



#Year 1 summer total LERs model 
```{r}
TotLERXS$N<-TotLERXS$NRATE
TotLERXS$N<- as.numeric(TotLERXS$N)
#linear
modTotLERXS<-lmer(LER~N*P + (1|Rep), data= TotLERXS)
anova(modTotLERXS)
#check assumptions 
TotLERXS_resid<-resid(modTotLERXS)
qqnorm(TotLERXS_resid)
qqline(TotLERXS_resid)
plot(modTotLERXS)
#Logtransform
modTotLERXS1<-lmer(log(LER)~N*P + (1|Rep), data=TotLERXS)
anova(modTotLERXS1)
#check assumptions logtransform (makes BETTER?)
TotLERXS_resid1<-resid(modTotLERXS1)
qqnorm(TotLERXS_resid1)
qqline(TotLERXS_resid1)
plot(modTotLERXS1)

#Comparison plots
# Boxplot for Total LER
ggplot(TotLERXS, aes(x = P, y = LER, fill = as.factor(NRATE))) +
  geom_boxplot() +
  labs(title = "Total LER by Location and N Rate", x = "Location", y = "Total LER")+
  geom_abline(intercept = 1, slope = 0, color = "red", linetype = "dashed")
  

# Boxplot for I Partial LER
ggplot(IWGPLERXS, aes(x = P, y = LER, fill = as.factor(NRATE))) +
  geom_boxplot() +
  labs(title = "I Partial LER by Location and N Rate", x = "Location", y = "I Partial LER")+
  geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")

# Boxplot for A Partial LER
ggplot(AlfPLERXS, aes(x = P, y = LER, fill = as.factor(NRATE))) +
  geom_boxplot() +
  labs(title = "A Partial LER by Location and N Rate", x = "Location", y = "A Partial LER")+
  geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")

#linear plots by location
TotLERXS$predicted <- predict(modTotLERXS1, newdata = TotLERXS, re.form = NA)
ggplot(TotLERXS, aes(x = N, y = LER)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Total LER (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between Total LER and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(0, 2) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System") +  #legend for colors
  geom_abline(intercept = 1, slope = 0, color = "red", linetype = "dashed")
#TWO way emmeans
TotLERXS1emm <- compute_emmeansNXS2("modTotLERXS1")
seeee<-emmeans(modTotLERXS1, ~P,at = list(N = N_levels), type= "response")
#Pairwise N 
N_levels <- c(0, 40, 80, 120, 160)
emmsN <- emmeans(modTotLERXS1, specs = ~ N, at = list(N = N_levels), type = "response")
cld_dataNXSTLERN <- cld(emmsN, Letters=custom_letters) # Create compact letter display
cld_dataNXSTLERN $response <- format(cld_dataNXSTLERN $response, digits = 3)
cld_dataNXSTLERN$lower.CL <- format(cld_dataNXSTLERN$lower.CL, digits = 3)
cld_dataNXSTLERN$upper.CL <- format(cld_dataNXSTLERN$upper.CL, digits = 3)
rownames(cld_dataNXSTLERN ) <- NULL
cld_dataNXSTLERN <- cld_dataNXSTLERN  %>%
  select( N, response, lower.CL, upper.CL, .group)
colnames(cld_dataNXSTLERN ) <- c( "N", "TLER","l","h", "Group")
cld_dataNXSTLERN  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
```
#Year 1 fall total LERs model
```{r}
TotLERXF$NRATE<- as.numeric(TotLERXF$NRATE)
modTotLERXF<-lmer(LER~N*P + (1|Rep), data= TotLERXF)
anova(modTotLERXF)
summary(modTotLERXF)
#check assumptions 
TotLERXF_resid<-resid(modTotLERXF)
qqnorm(TotLERXF_resid)
qqline(TotLERXF_resid)
plot(modTotLERXF)
#Logtransform
modTotLERXF1<-lmer(log(LER)~N*P + (1|Rep), data=TotLERXF)
anova(modTotLERXF1)
#check assumptions logtransform (makes BETTER)
TotLERXF_resid1<-resid(modTotLERXF1)
qqnorm(TotLERXF_resid1)
qqline(TotLERXF_resid1)
plot(modTotLERXF1)


max(TotLERXF$LER)
#linear plots
TotLERXF$predicted <- predict(modTotLERXF1, newdata = TotLERXF, re.form = NA)
ggplot(TotLERXF, aes(x = N, y = LER)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Total LER (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between Total LER and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(0, 6.2) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")+  #legend for colors
geom_abline(intercept = 1, slope = 0, color = "red", linetype = "dashed")

#TWO way emmeans
TotLERXF1emm <- compute_emmeansNXF2("modTotLERXF1")

#Pairwise P
emmsP <- emmeans(modTotLERXF1, ~ P, type = "response") # Obtain estimated marginal means
cld_dataTLERXFP <- cld(emmsP, Letters=custom_letters) # Create compact letter display
cld_dataTLERXFP $response <- format(cld_dataTLERXFP $response, digits = 3)
cld_dataTLERXFP$lower.CL <- format(cld_dataTLERXFP$lower.CL, digits = 3)
cld_dataTLERXFP$upper.CL <- format(cld_dataTLERXFP$upper.CL, digits = 3)
rownames(cld_dataTLERXFP ) <- NULL
cld_dataTLERXFP <- cld_dataTLERXFP  %>%
  select( P, response, lower.CL, upper.CL, .group)
colnames(cld_dataTLERXFP ) <- c( "Site", "TLER","CI2.5%","CI97.5%", "Group")
cld_dataTLERXFP   |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise N 
N_levels <- c(0, 40, 80, 120, 160)
emmsN <- emmeans(modTotLERXF1, specs = ~ N, at = list(N = N_levels), type = "response")
cld_dataNXFTLERN <- cld(emmsN, Letters=custom_letters) # Create compact letter display
cld_dataNXFTLERN $response <- format(cld_dataNXFTLERN $response, digits = 3)
cld_dataNXFTLERN$lower.CL <- format(cld_dataNXFTLERN$lower.CL, digits = 3)
cld_dataNXFTLERN$upper.CL <- format(cld_dataNXFTLERN$upper.CL, digits = 3)
rownames(cld_dataNXFTLERN ) <- NULL
cld_dataNXFTLERN <- cld_dataNXFTLERN  %>%
  select( N, response, lower.CL, upper.CL, .group)
colnames(cld_dataNXFTLERN ) <- c( "N", "TLER","l","h", "Group")
cld_dataNXFTLERN  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

```
#Year 2 summer total LERs model
```{r}
TotLERYS$NRATE<- as.numeric(TotLERYS$NRATE)
modTotLERYS<-lmer(LER~N*P + (1|Rep), data= TotLERYS)
anova(modTotLERYS)
#check assumptions 
TotLERYS_resid<-resid(modTotLERYS)
qqnorm(TotLERYS_resid)
qqline(TotLERYS_resid)
plot(modTotLERYS)
#Logtransform
modTotLERYS1<-lmer(log(LER)~N*P + (1|Rep), data=TotLERYS)
anova(modTotLERYS1)
#check assumptions logtransform (makes BETTER?)
TotLERYS_resid1<-resid(modTotLERYS1)
qqnorm(TotLERYS_resid1)
qqline(TotLERYS_resid1)
plot(modTotLERYS1)

max(TotLERYS$LER)
#linear plots
TotLERYS$predicted <- predict(modTotLERYS1, newdata = TotLERYS, re.form = NA)
ggplot(TotLERYS, aes(x = N, y = LER)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Total LER (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between Total LER and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(0, 2.2) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")+  #legend for colors
  geom_abline(intercept = 1, slope = 0, color = "red", linetype = "dashed")

#TWO way emmeans
TotLERYS1emm <- compute_emmeansNYS2("modTotLERYS1")

#Pairwise P
emmsP <- emmeans(modTotLERYS1, ~ P, type = "response") # Obtain estimated marginal means
cld_dataTLERYSP <- cld(emmsP, Letters=custom_letters) # Create compact letter display
cld_dataTLERYSP $response <- format(cld_dataTLERYSP $response, digits = 3)
cld_dataTLERYSP$lower.CL <- format(cld_dataTLERYSP$lower.CL, digits = 3)
cld_dataTLERYSP$upper.CL <- format(cld_dataTLERYSP$upper.CL, digits = 3)
rownames(cld_dataTLERYSP ) <- NULL
cld_dataTLERYSP <- cld_dataTLERYSP  %>%
  select( P, response, lower.CL, upper.CL ,.group)
colnames(cld_dataTLERYSP ) <- c( "Site", "TLER", "l","h","Group")
cld_dataTLERYSP   |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise N
N_levels <- c(0, 40, 80, 120, 160)
emmsN <- emmeans(modTotLERYS1, specs = ~ N, at = list(N = N_levels), type = "response")
cld_dataTLERYSN <- cld(emmsN, Letters=custom_letters) # Create compact letter display
cld_dataTLERYSN $response <- format(cld_dataTLERYSN $response, digits = 3)
cld_dataTLERYSN$lower.CL <- format(cld_dataTLERYSN$lower.CL, digits = 3)
cld_dataTLERYSN$upper.CL <- format(cld_dataTLERYSN$upper.CL, digits = 3)
rownames(cld_dataTLERYSN ) <- NULL
cld_dataTLERYSN <- cld_dataTLERYSN  %>%
  select( N, response, lower.CL, upper.CL, .group)
colnames(cld_dataTLERYSN ) <- c( "N", "TLER","l","h", "Group")
cld_dataTLERYSN   |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

summary(modTotLERYS1)

#EQUATION tables JUST N 
emtrends_result<-emtrends(modTotLERYS1,~ 1, var= "N", infer=TRUE)
emtrends_df <- as.data.frame(emtrends_result)
emmeans_results<-emmeans(modTotLERYS1, ~1, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
emtrends_df <- emtrends_df %>% mutate(key = 1)
emmeans_df <- emmeans_df %>% mutate(key = 1)
merged_df <- inner_join(emtrends_df, emmeans_df, by = "key")%>%
  select(emmean, N.trend, SE.x)
view(merged_df)
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
view(new_df)
```
#Year 2 fall total LERs model
```{r}
TotLERYF$NRATE<- as.numeric(TotLERYF$NRATE)
modTotLERYF<-lmer(LER~N*P + (1|Rep), data= TotLERYF)
anova(modTotLERYF)
summary(modTotLERYF)
#check assumptions 
TotLERYF_resid<-resid(modTotLERYF)
qqnorm(TotLERYF_resid)
qqline(TotLERYF_resid)
plot(modTotLERYF)
#Logtransform
modTotLERYF1<-lmer(log(LER)~N*P + (1|Rep), data=TotLERYF)
anova(modTotLERYF1)
#check assumptions logtransform
TotLERYF_resid1<-resid(modTotLERYF1)
qqnorm(TotLERYF_resid1)
qqline(TotLERYF_resid1)
plot(modTotLERYF1)

max(TotLERYF$LER)
#linear plots
TotLERYF$predicted <- predict(modTotLERYF1, newdata = TotLERYF, re.form = NA)
ggplot(TotLERYF, aes(x = N, y = LER)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Total LER (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between Total LER and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(0, 6.9) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")+  #legend for colors
  geom_abline(intercept = 1, slope = 0, color = "red", linetype = "dashed")

#TWO way emmeans
TotLERYF1emm <- compute_emmeansNYF2("modTotLERYF1")

#Pairwise P
emmsP <- emmeans(modTotLERYF1, ~ P, type = "response") # Obtain estimated marginal means
cld_dataTLERYFP <- cld(emmsP, Letters=custom_letters) # Create compact letter display
cld_dataTLERYFP $response <- format(cld_dataTLERYFP $response, digits = 3)
cld_dataTLERYFP$lower.CL <- format(cld_dataTLERYFP$lower.CL, digits = 3)
cld_dataTLERYFP$upper.CL <- format(cld_dataTLERYFP$upper.CL, digits = 3)
rownames(cld_dataTLERYFP ) <- NULL
cld_dataTLERYFP <- cld_dataTLERYFP  %>%
  select( P, response, lower.CL, upper.CL, .group)
colnames(cld_dataTLERYFP ) <- c( "Site", "TLER","l","h", "Group")
cld_dataTLERYFP   |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise N 
N_levels <- c(0, 40, 80, 120, 160)
emmsN <- emmeans(modTotLERYF1, specs = ~ N, at = list(N = N_levels), type = "response")
cld_dataNYFTLERN <- cld(emmsN, Letters=custom_letters) # Create compact letter display
cld_dataNYFTLERN $response <- format(cld_dataNYFTLERN $response, digits = 3)
cld_dataNYFTLERN$lower.CL <- format(cld_dataNYFTLERN$lower.CL, digits = 3)
cld_dataNYFTLERN$upper.CL <- format(cld_dataNYFTLERN$upper.CL, digits = 3)
rownames(cld_dataNYFTLERN ) <- NULL
cld_dataNYFTLERN <- cld_dataNYFTLERN  %>%
  select( N, response, lower.CL, upper.CL, .group)
colnames(cld_dataNYFTLERN ) <- c( "N", "TLER","l","h", "Group")
cld_dataNYFTLERN  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
```
#TLER combo plot
```{r}
TotLERXS$predictedTLER <- predict(modTotLERXS1, newdata = TotLERXS, re.form = NA)
TotLERXF$predictedTLER <- predict(modTotLERXF1, newdata = TotLERXF, re.form = NA)
TotLERYS$predictedTLER <- predict(modTotLERYS1, newdata = TotLERYS, re.form = NA)
TotLERYF$predictedTLER <- predict(modTotLERYF1, newdata = TotLERYF, re.form = NA)

# Layer all the plots together!
colors <- c("Year 1 Summer Harvest" = "red", 
            "Year 1 Fall Harvest" = "green", 
            "Year 2 Summer Harvest" = "blue", 
            "Year 2 Fall Harvest" = "purple")
legend_order <- c("Year 1 Summer Harvest", "Year 1 Fall Harvest", 
                  "Year 2 Summer Harvest", "Year 2 Fall Harvest")
TotLERXS$P <- factor(TotLERXS$P, levels = desired_order)
max(TotLERXS$LER)
max(TotLERXF$LER)
max(TotLERYS$LER)
max(TotLERYF$LER)
TLERcomboplot <- ggplot() +
  geom_line(data = TotLERXS, aes(N, exp(predictedTLER), color = "Year 1 Summer Harvest")) +
  geom_point(data =TotLERXS, aes(x = N, y = LER, color = "Year 1 Summer Harvest")) +
  geom_line(data = TotLERXF, aes(N, exp(predictedTLER), color = "Year 1 Fall Harvest")) +
  geom_point(data = TotLERXF, aes(x = N, y = LER, color = "Year 1 Fall Harvest")) +
  geom_line(data = TotLERYS, aes(N, exp(predictedTLER), color = "Year 2 Summer Harvest")) +
  geom_point(data = TotLERYS, aes(x = N, y = LER, color = "Year 2 Summer Harvest")) +
  geom_line(data = TotLERYF, aes(N, exp(predictedTLER), color = "Year 2 Fall Harvest")) +
  geom_point(data = TotLERYF, aes(x = N, y = LER, color = "Year 2 Fall Harvest")) +
  labs(x = "N-Rate (kg ha-1)", y = "Total LER",
    color = "Harvest", 
    linetype = "Cropping System", shape = "Cropping System") +
  ggtitle("Relationship Between Total LER and N-rate") +
  scale_x_continuous(breaks = c(0, 40, 80, 120, 160)) +
  ylim(0, 7) +
  facet_wrap(~P, scales = "free", ncol = 2) +
  scale_color_manual(values = colors, limits = legend_order)+
  scale_shape_manual(values = c(4, 20))+
  geom_abline(intercept = 1, slope = 0, color = "red", linetype = "dashed")


print(TLERcomboplot)

ggsave("TLERcomboplot.jpg", plot = TLERcomboplot, width = 8, height = 6, dpi = 300)
```
#TLER E plots (XF, YS, YF)
```{r}
#XF 
NTLERXFemmsP <- emmeans(modTotLERXF1, ~ P, type = "response") 
emms_df <- as.data.frame(NTLERXFemmsP)
cld_dataNTLERXFP <- cld(NTLERXFemmsP, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataNTLERXFP)
merged_df <- merge(emms_df, cld_df,by = c("P"))
TLERXFE<-ggplot(TotLERXF, aes(x = P, y = exp(predicted))) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7, color="darkgreen") +
  labs(x = "Environment", y = "Total LER") +
  geom_point(data = emms_df, aes(x = P, y = response), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 1.8)+
  ggtitle("Year 1 Fall")+
  scale_y_continuous(breaks = c(1, 2, 3, 4,5), limits = c(0, 5))+
  geom_abline(intercept = 1, slope = 0, color = "red", linetype = "dashed")

print(TLERXFE)

#YS 
NTLERYSemmsP <- emmeans(modTotLERYS1, ~ P, type = "response") 
emms_df <- as.data.frame(NTLERYSemmsP)
cld_dataNTLERYSP <- cld(NTLERYSemmsP, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataNTLERYSP)
merged_df <- merge(emms_df, cld_df,by = c("P"))
TLERYSE<-ggplot(TotLERYS, aes(x = P, y = exp(predicted))) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7, color="darkgreen") +
  labs(x = "Environment", y = "Total LER") +
  geom_point(data = emms_df, aes(x = P, y = response), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 1.8)+
  ggtitle("Year 2 Summer")+
  scale_y_continuous(breaks = c(1, 2, 3, 4,5), limits = c(0, 5))+
  geom_abline(intercept = 1, slope = 0, color = "red", linetype = "dashed")

print(TLERYSE)

#YF 
NTLERYFemmsP <- emmeans(modTotLERYF1, ~ P, type = "response") 
emms_df <- as.data.frame(NTLERYFemmsP)
cld_dataNTLERYFP <- cld(NTLERYFemmsP, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataNTLERYFP)
merged_df <- merge(emms_df, cld_df,by = c("P"))
TLERYFE<-ggplot(TotLERYF, aes(x = P, y = exp(predicted))) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7, color="darkgreen") +
  labs(x = "Environment", y = "Total LER") +
  geom_point(data = emms_df, aes(x = P, y = response), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 1.8)+
ggtitle("Year 2 Fall")+
  scale_y_continuous(breaks = c(1, 2, 3, 4,5), limits = c(0, 5))+
  geom_abline(intercept = 1, slope = 0, color = "red", linetype = "dashed")

print(TLERYFE)

TLERE<-grid.arrange(TLERXFE, TLERYSE, TLERYFE, ncol = 2)
ggsave("TLERE.jpg", plot = TLERE, width = 8, height = 6, dpi = 300)
```
#TLER plot N (YS)
```{r}
# Layer all the plots together!
colors <- c("Year 1 Summer Harvest" = "red", 
            "Year 1 Fall Harvest" = "green", 
            "Year 2 Summer Harvest" = "blue", 
            "Year 2 Fall Harvest" = "purple")
legend_order <- c("Year 1 Summer Harvest")

max(TotLERYS$LER)
TLERplotN <- ggplot() +
  geom_point(data = TotLERYS, aes(x = N, y = LER), color= "blue") +
  labs(x = "N-Rate (kg ha-1)", y = "LER",
    color = "Harvest") +
  scale_x_continuous(breaks = c(0, 40, 80, 120, 160)) +
  ylim(0, 2.2) +
  geom_function(data=TotLERYS, fun=~1.36*exp(-0.0017*.x),color='blue')+
  guides(
    shape = guide_legend(title = "Cropping System"))+
  geom_abline(intercept = 1, slope = 0, color = "red", linetype = "dashed")
print(TLERplotN)

ggsave("TLERplotN.jpg", plot = TLERplotN, width = 8, height = 6, dpi = 300)
```

#Year 1 summer partial IWG LERs model
```{r}
modIWGPLERXS<-lmer(LER~N*P + (1|Rep), data= IWGPLERXS)
anova(modIWGPLERXS)
#check assumptions 
IWGPLERXS_resid<-resid(modIWGPLERXS)
qqnorm(IWGPLERXS_resid)
qqline(IWGPLERXS_resid)
plot(modIWGPLERXS)
#Logtransform
modIWGPLERXS1<-lmer(log(LER)~N*P + (1|Rep), data=IWGPLERXS)
anova(modIWGPLERXS1)
#check assumptions logtransform (makes BETTER)
IWGPLERXS_resid1<-resid(modIWGPLERXS1)
qqnorm(IWGPLERXS_resid1)
qqline(IWGPLERXS_resid1)
plot(modIWGPLERXS1)


max(IWGPLERXS$LER)
#linear plots
IWGPLERXS$predicted <- predict(modIWGPLERXS1, newdata = IWGPLERXS, re.form = NA)
ggplot(IWGPLERXS, aes(x = N, y = LER)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "IWG Partial LER (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between IWG Partial LER and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(0, 1.3) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")+  #legend for colors
 geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")
#TWO way emmeans
IWGPLERXS1emm <- compute_emmeansNXS2("modIWGPLERXS1")
#pairwise N 
N_levels <- c(0, 40, 80, 120, 160)
emmsN <- emmeans(modIWGPLERXS1, specs = ~ N, at = list(N = N_levels), type = "response")
cld_dataNXSIPLERN <- cld(emmsN, Letters=custom_letters) # Create compact letter display
cld_dataNXSIPLERN $response <- format(cld_dataNXSIPLERN $response, digits = 2)
cld_dataNXSIPLERN $lower.CL <- format(cld_dataNXSIPLERN $lower.CL, digits = 2)
cld_dataNXSIPLERN $upper.CL <- format(cld_dataNXSIPLERN $upper.CL, digits = 3)
rownames(cld_dataNXSIPLERN ) <- NULL
cld_dataNXSIPLERN <- cld_dataNXSIPLERN  %>%
  select( N, response,lower.CL, upper.CL, .group)
colnames(cld_dataNXSIPLERN ) <- c( "N", "APLER","l","h", "Group")
cld_dataNXSIPLERN  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise P
emmsP <- emmeans(modIWGPLERXS1, specs = ~ P, type = "response")
cld_dataNXSIPLERNP <- cld(emmsP, Letters=custom_letters) # Create compact letter display
cld_dataNXSIPLERNP $response <- format(cld_dataNXSIPLERNP $response, digits = 3)
cld_dataNXSIPLERNP$lower.CL <- format(cld_dataNXSIPLERNP$lower.CL, digits = 3)
cld_dataNXSIPLERNP$upper.CL <- format(cld_dataNXSIPLERNP$upper.CL, digits = 3)
rownames(cld_dataNXSIPLERNP ) <- NULL
cld_dataNXSIPLERNP <- cld_dataNXSIPLERNP  %>%
  select( P, response, lower.CL,upper.CL, .group)
colnames(cld_dataNXSIPLERNP ) <- c( "Site", "IPLER", "l","h","Group")
cld_dataNXSIPLERNP  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
```

#Year 1 Fall partial IWG LERs model
```{r}
modIWGPLERXF<-lmer(LER~N*P + (1|Rep), data= IWGPLERXF)
anova(modIWGPLERXF)
summary(modIWGPLERXF)
#check assumptions 
IWGPLERXF_resid<-resid(modIWGPLERXF)
qqnorm(IWGPLERXF_resid)
qqline(IWGPLERXF_resid)
plot(modIWGPLERXF)
#Logtransform
modIWGPLERXF1<-lmer(log(LER)~N*P + (1|Rep), data=IWGPLERXF)
anova(modIWGPLERXF1)
#check assumptions logtransform (makes BETTER)
IWGPLERXF_resid1<-resid(modIWGPLERXF1)
qqnorm(IWGPLERXF_resid1)
qqline(IWGPLERXF_resid1)
plot(modIWGPLERXF1)


max(IWGPLERXF$LER)
#plots
IWGPLERXF$predicted <- predict(modIWGPLERXF1, newdata = IWGPLERXF, re.form = NA)
ggplot(IWGPLERXF, aes(x = N, y = LER)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "IWG Partial LER (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between IWG Partial LER and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(0, 5.3) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")+
  geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")#legend for colors

#TWO way emmeans
IWGPLERXF1emm <- compute_emmeansNXF2("modIWGPLERXF1")
#Pairwise P
emmsP <- emmeans(modIWGPLERXF1, specs = ~ P, type = "response")
cld_dataNXFIPLERNP <- cld(emmsP, Letters=custom_letters) # Create compact letter display
cld_dataNXFIPLERNP $response <- format(cld_dataNXFIPLERNP $response, digits = 3)
cld_dataNXFIPLERNP$lower.CL <- format(cld_dataNXFIPLERNP$lower.CL, digits = 3)
cld_dataNXFIPLERNP$upper.CL <- format(cld_dataNXFIPLERNP$upper.CL, digits = 3)
rownames(cld_dataNXFIPLERNP ) <- NULL
cld_dataNXFIPLERNP <- cld_dataNXFIPLERNP  %>%
  select( P, response,lower.CL, upper.CL, .group)
colnames(cld_dataNXFIPLERNP ) <- c( "Site", "IPLER","l","h", "Group")
cld_dataNXFIPLERNP  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#pairwise N 
N_levels <- c(0, 40, 80, 120, 160)
emmsN <- emmeans(modIWGPLERXF1, specs = ~ N, at = list(N = N_levels), type = "response")
cld_dataNXFIPLERN <- cld(emmsN, Letters=custom_letters) # Create compact letter display
cld_dataNXFIPLERN $response <- format(cld_dataNXFIPLERN $response, digits = 2)
cld_dataNXFIPLERN $lower.CL <- format(cld_dataNXFIPLERN $lower.CL, digits = 2)
cld_dataNXFIPLERN $upper.CL <- format(cld_dataNXFIPLERN $upper.CL, digits = 3)
rownames(cld_dataNXFIPLERN ) <- NULL
cld_dataNXFIPLERN <- cld_dataNXFIPLERN  %>%
  select( N, response,lower.CL, upper.CL, .group)
colnames(cld_dataNXFIPLERN ) <- c( "N", "APLER","l","h", "Group")
cld_dataNXFIPLERN  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
```

#Year 2 summer partial IWG LERs model
```{r}
modIWGPLERYS<-lmer(LER~N*P + (1|Rep), data= IWGPLERYS)
anova(modIWGPLERYS)
#check assumptions 
IWGPLERYS_resid<-resid(modIWGPLERYS)
qqnorm(IWGPLERYS_resid)
qqline(IWGPLERYS_resid)
plot(modIWGPLERYS)
#Logtransform
modIWGPLERYS1<-lmer(log(LER)~N*P + (1|Rep), data=IWGPLERYS)
anova(modIWGPLERYS1)
#check assumptions logtransform (makes it not much different)
IWGPLERYS_resid1<-resid(modIWGPLERYS1)
qqnorm(IWGPLERYS_resid1)
qqline(IWGPLERYS_resid1)
plot(modIWGPLERYS1)

max(IWGPLERYS$LER)
#plots
IWGPLERYS$predicted <- predict(modIWGPLERYS1, newdata = IWGPLERYS, re.form = NA)
ggplot(IWGPLERYS, aes(x = N, y = LER)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "IWG Partial LER (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between IWG Partial LER and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(0, 1.5) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")+  #legend for colors
geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")

#TWO way emmeans
IWGPLERYS1emm <- compute_emmeansNYS2("modIWGPLERYS1")
#pairwise N 
N_levels <- c(0, 40, 80, 120, 160)
emmsN <- emmeans(modIWGPLERYS1, specs = ~ N, at = list(N = N_levels), type = "response")
cld_dataNYSIPLERN <- cld(emmsN, Letters=custom_letters) # Create compact letter display
cld_dataNYSIPLERN $response <- format(cld_dataNYSIPLERN $response, digits = 2)
cld_dataNYSIPLERN $lower.CL <- format(cld_dataNYSIPLERN $lower.CL, digits = 2)
cld_dataNYSIPLERN $upper.CL <- format(cld_dataNYSIPLERN $upper.CL, digits = 3)
rownames(cld_dataNYSIPLERN ) <- NULL
cld_dataNYSIPLERN <- cld_dataNYSIPLERN  %>%
  select( N, response,lower.CL, upper.CL, .group)
colnames(cld_dataNYSIPLERN ) <- c( "N", "APLER","l","h", "Group")
cld_dataNYSIPLERN  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
```

#Year 2 Fall partial IWG LERs model
```{r}
modIWGPLERYF<-lmer(LER~N*P + (1|Rep), data= IWGPLERYF)
anova(modIWGPLERYF)
summary(modIWGPLERYF)
#check assumptions 
IWGPLERYF_resid<-resid(modIWGPLERYF)
qqnorm(IWGPLERYF_resid)
qqline(IWGPLERYF_resid)
plot(modIWGPLERYF)
#Logtransform
modIWGPLERYF1<-lmer(log(LER)~N*P + (1|Rep), data=IWGPLERYF)
anova(modIWGPLERYF1)
#check assumptions logtransform (makes it better?)
IWGPLERYF_resid1<-resid(modIWGPLERYF1)
qqnorm(IWGPLERYF_resid1)
qqline(IWGPLERYF_resid1)
plot(modIWGPLERYF1)

max(IWGPLERYF$LER)
#plots
IWGPLERYF$predicted <- predict(modIWGPLERYF1, newdata = IWGPLERYF, re.form = NA)
ggplot(IWGPLERYF, aes(x = N, y = LER)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "IWG Partial LER (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between IWG Partial LER and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(0, 5.4) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")+  #legend for colors
  geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")

#TWO way emmeans
IWGPLERYF1emm <- compute_emmeansNYF2("modIWGPLERYF1")
#Pairwise N
N_levels <- c(0, 40, 80, 120, 160)
emmsN <- emmeans(modIWGPLERYF1, specs = ~ N, at = list(N = N_levels), type = "response")
cld_dataNYFIPLERN <- cld(emmsN, Letters=custom_letters) # Create compact letter display
cld_dataNYFIPLERN $response <- format(cld_dataNYFIPLERN $response, digits = 3)
cld_dataNYFIPLERN$lower.CL <- format(cld_dataNYFIPLERN$lower.CL, digits = 3)
cld_dataNYFIPLERN$upper.CL <- format(cld_dataNYFIPLERN$upper.CL, digits = 3)
rownames(cld_dataNYFIPLERN ) <- NULL
cld_dataNYFIPLERN <- cld_dataNYFIPLERN  %>%
  select( N, response, lower.CL, upper.CL, .group)
colnames(cld_dataNYFIPLERN ) <- c( "N", "IPLER","l","h", "Group")
cld_dataNYFIPLERN  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise P
emmsP <- emmeans(modIWGPLERYF1, specs = ~ P, type = "response")
cld_dataNYFIPLERP <- cld(emmsP, Letters=custom_letters) # Create compact letter display
cld_dataNYFIPLERP $response <- format(cld_dataNYFIPLERP $response, digits = 3)
cld_dataNYFIPLERP$lower.CL <- format(cld_dataNYFIPLERP$lower.CL, digits = 3)
cld_dataNYFIPLERP$upper.CL <- format(cld_dataNYFIPLERP$upper.CL, digits = 3)
rownames(cld_dataNYFIPLERP ) <- NULL
cld_dataNYFIPLERP <- cld_dataNYFIPLERP  %>%
  select( P, response, lower.CL, upper.CL ,.group)
colnames(cld_dataNYFIPLERP ) <- c( "Site", "IPLER","l","h", "Group")
cld_dataNYFIPLERP  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

summary(modIWGPLERYF1)

#EQUATION tables JUST N 
emtrends_result<-emtrends(modIWGPLERYF1,~ 1, var= "N", infer=TRUE)
emtrends_df <- as.data.frame(emtrends_result)
emmeans_results<-emmeans(modIWGPLERYF1, ~1, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
emtrends_df <- emtrends_df %>% mutate(key = 1)
emmeans_df <- emmeans_df %>% mutate(key = 1)
merged_df <- inner_join(emtrends_df, emmeans_df, by = "key")%>%
  select(emmean, N.trend, SE.x)
view(merged_df)
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
view(new_df)
```

#IWG PLER combo plot 
```{r}
IWGPLERXS$predictedIPLER <- predict(modIWGPLERXS1, newdata = IWGPLERXS, re.form = NA)
IWGPLERXF$predictedIPLER <- predict(modIWGPLERXF1, newdata = IWGPLERXF, re.form = NA)
IWGPLERYS$predictedIPLER <- predict(modIWGPLERYS1, newdata = IWGPLERYS, re.form = NA)
IWGPLERYF$predictedIPLER <- predict(modIWGPLERYF1, newdata = IWGPLERYF, re.form = NA)

# Layer all the plots together!
colors <- c("Year 1 Summer Harvest" = "red", 
            "Year 1 Fall Harvest" = "green", 
            "Year 2 Summer Harvest" = "blue", 
            "Year 2 Fall Harvest" = "purple")
legend_order <- c("Year 1 Summer Harvest", "Year 1 Fall Harvest", 
                  "Year 2 Summer Harvest", "Year 2 Fall Harvest")
IWGPLERXS$P <- factor(IWGPLERXS$P, levels = desired_order)
max(IWGPLERXS$LER)
max(IWGPLERXF$LER)
max(IWGPLERYS$LER)
max(IWGPLERYF$LER)
IPLERcomboplot <- ggplot() +
  geom_line(data = IWGPLERXS, aes(N, exp(predictedIPLER), color = "Year 1 Summer Harvest")) +
  geom_point(data =IWGPLERXS, aes(x = N, y = LER, color = "Year 1 Summer Harvest")) +
  geom_line(data = IWGPLERXF, aes(N, exp(predictedIPLER), color = "Year 1 Fall Harvest")) +
  geom_point(data = IWGPLERXF, aes(x = N, y = LER, color = "Year 1 Fall Harvest")) +
  geom_line(data = IWGPLERYS, aes(N, exp(predictedIPLER), color = "Year 2 Summer Harvest")) +
  geom_point(data = IWGPLERYS, aes(x = N, y = LER, color = "Year 2 Summer Harvest")) +
  geom_line(data = IWGPLERYF, aes(N, exp(predictedIPLER), color = "Year 2 Fall Harvest")) +
  geom_point(data = IWGPLERYF, aes(x = N, y = LER, color = "Year 2 Fall Harvest")) +
  labs(x = "N-Rate (kg ha-1)", y = "IWG PLER",
    color = "Harvest", 
    linetype = "Cropping System", shape = "Cropping System") +
  ggtitle("Relationship Between IWG PLER and N-rate") +
  scale_x_continuous(breaks = c(0, 40, 80, 120, 160)) +
  ylim(0, 5.5) +
  facet_wrap(~P, scales = "free", ncol = 2) +
  scale_color_manual(values = colors, limits = legend_order)+
  scale_shape_manual(values = c(4, 20))+
  geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")


print(IPLERcomboplot)

ggsave("IPLERcomboplot.jpg", plot = IPLERcomboplot, width = 8, height = 6, dpi = 300)
```
#IPLER E plots (XS, XF, YF)
```{r}
#YS 
NIPLERXSemmsP <- emmeans(modIWGPLERXS1, ~ P, type = "response") 
emms_df <- as.data.frame(NIPLERXSemmsP)
cld_dataNIPLERXSP <- cld(NIPLERXSemmsP, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataNIPLERXSP)
merged_df <- merge(emms_df, cld_df,by = c("P"))
IPLERXSE<-ggplot(IWGPLERXS, aes(x = P, y = exp(predicted))) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7, color="darkgreen") +
  labs(x = "Environment", y = "IWG PLER") +
  geom_point(data = emms_df, aes(x = P, y = response), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 1.8)+
  ggtitle("Year 1 Summer")+
  scale_y_continuous(breaks = c(0.5, 1, 1.5, 2,2.5,3), limits = c(0, 3.2))+
  geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")

print(IPLERXSE)


#XF 
NIPLERXFemmsP <- emmeans(modIWGPLERXF1, ~ P, type = "response") 
emms_df <- as.data.frame(NIPLERXFemmsP)
cld_dataNIPLERXFP <- cld(NIPLERXFemmsP, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataNIPLERXFP)
merged_df <- merge(emms_df, cld_df,by = c("P"))
IPLERXFE<-ggplot(IWGPLERXF, aes(x = P, y = exp(predicted))) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7, color="darkgreen") +
  labs(x = "Environment", y = "IWG PLER") +
  geom_point(data = emms_df, aes(x = P, y = response), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 1.8)+
  ggtitle("Year 1 Fall")+
  scale_y_continuous(breaks = c(0.5, 1, 1.5, 2,2.5,3), limits = c(0, 3.2))+
  geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")

print(IPLERXFE)

#YF 
NIPLERYFemmsP <- emmeans(modIWGPLERYF1, ~ P, type = "response") 
emms_df <- as.data.frame(NIPLERYFemmsP)
cld_dataNIPLERYFP <- cld(NIPLERYFemmsP, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataNIPLERYFP)
merged_df <- merge(emms_df, cld_df,by = c("P"))
IPLERYFE<-ggplot(IWGPLERYF, aes(x = P, y = exp(predicted))) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7, color="darkgreen") +
  labs(x = "Environment", y = "IWG PLER") +
  geom_point(data = emms_df, aes(x = P, y = response), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 1.8)+
ggtitle("Year 2 Fall")+
  scale_y_continuous(breaks = c(0.5, 1, 1.5, 2,2.5,3), limits = c(0, 3.2))+
  geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")

print(IPLERYFE)

IPLERE<-grid.arrange(IPLERXSE, IPLERXFE, IPLERYFE, ncol = 2)
ggsave("IPLERE.jpg", plot = IPLERE, width = 8, height = 6, dpi = 300)
```
#IPLER plot N (YF)
```{r}
# Layer all the plots together!
colors <- c("Year 1 Summer Harvest" = "red", 
            "Year 1 Fall Harvest" = "green", 
            "Year 2 Summer Harvest" = "blue", 
            "Year 2 Fall Harvest" = "purple")
legend_order <- c("Year 1 Summer Harvest")

max(IWGPLERYF$LER)
IPLERplotN <- ggplot() +
  geom_point(data = IWGPLERYF, aes(x = N, y = LER), color= "purple") +
  labs(x = "N-Rate (kg ha-1)", y = "IWG PLER",
    color = "Harvest") +
  scale_x_continuous(breaks = c(0, 40, 80, 120, 160)) +
  ylim(0, 5.5) +
  geom_function(data=IWGPLERYF, fun=~1.32*exp(0.0022*.x),color='purple')+
  geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")
print(IPLERplotN)

ggsave("IPLERplotN.jpg", plot = IPLERplotN, width = 8, height = 6, dpi = 300)
```

#Year 1 summer partial ALF LERs model
```{r}
modAlfPLERXS<-lmer(LER~N*P + (1|Rep), data= AlfPLERXS)
anova(modAlfPLERXS)
summary(modAlfPLERXS)
#check assumptions 
AlfPLERXS_resid<-resid(modAlfPLERXS)
qqnorm(AlfPLERXS_resid)
qqline(AlfPLERXS_resid)
plot(modAlfPLERXS)
#Logtransform
modAlfPLERXS1<-lmer(log(LER)~N*P + (1|Rep), AlfPLERXS)
anova(modAlfPLERXS1)
#check assumptions logtransform (makes not much different)
AlfPLERXS_resid1<-resid(modAlfPLERXS1)
qqnorm(AlfPLERXS_resid1)
qqline(AlfPLERXS_resid1)
plot(modAlfPLERXS1)

max(AlfPLERXS$LER)
#plots
AlfPLERXS$predicted <- predict(modAlfPLERXS1, newdata = AlfPLERXS, re.form = NA)
APLERXSplot<-ggplot(AlfPLERXS, aes(x = N, y = LER)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Alf Partial LER (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between Alf Partial LER and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(0, 1.4) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")+
  geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")#legend for colors

#TWO way emmeans
AlfPLERXS1emm <- compute_emmeansNXS2("modAlfPLERXS1")

#pairwise N 
N_levels <- c(0, 40, 80, 120, 160)
emmsN <- emmeans(modAlfPLERXS1, specs = ~ N, at = list(N = N_levels), type = "response")
cld_dataNXSAPLERN <- cld(emmsN, Letters=custom_letters) # Create compact letter display
cld_dataNXSAPLERN $response <- format(cld_dataNXSAPLERN $response, digits = 2)
cld_dataNXSAPLERN $lower.CL <- format(cld_dataNXSAPLERN $lower.CL, digits = 2)
cld_dataNXSAPLERN $upper.CL <- format(cld_dataNXSAPLERN $upper.CL, digits = 3)
rownames(cld_dataNXSAPLERN ) <- NULL
cld_dataNXSAPLERN <- cld_dataNXSAPLERN  %>%
  select( N, response,lower.CL, upper.CL, .group)
colnames(cld_dataNXSAPLERN ) <- c( "N", "APLER","l","h", "Group")
cld_dataNXSAPLERN  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise P
emmsP <- emmeans(modAlfPLERXS1, specs = ~ P, type = "response")
cld_dataNXSAPLERP <- cld(emmsP, Letters=custom_letters) # Create compact letter display
cld_dataNXSAPLERP $response <- format(cld_dataNXSAPLERP $response, digits = 2)
cld_dataNXSAPLERP$lower.CL <- format(cld_dataNXSAPLERP$lower.CL, digits = 2)
cld_dataNXSAPLERP$upper.CL <- format(cld_dataNXSAPLERP$upper.CL, digits = 3)
rownames(cld_dataNXSAPLERP ) <- NULL
cld_dataNXSAPLERP <- cld_dataNXSAPLERP  %>%
  select( P, response, lower.CL, upper.CL, .group)
colnames(cld_dataNXSAPLERP ) <- c( "Site", "APLER","l","h", "Group")
cld_dataNXSAPLERP  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
```

#Year 1 Fall partial Alf LERs model
```{r}
modAlfPLERXF<-lmer(LER~N*P + (1|Rep), data= AlfPLERXF)
anova(modAlfPLERXF)
summary(modAlfPLERXF)
#check assumptions 
AlfPLERXF_resid<-resid(modAlfPLERXF)
qqnorm(AlfPLERXF_resid)
qqline(AlfPLERXF_resid)
plot(modAlfPLERXF)
#Logtransform
modAlfPLERXF1<-lmer(log(LER)~N*P + (1|Rep), AlfPLERXF)
anova(modAlfPLERXF1)
#check assumptions logtransform (makes Better)
AlfPLERXF_resid1<-resid(modAlfPLERXF1)
qqnorm(AlfPLERXF_resid1)
qqline(AlfPLERXF_resid1)
plot(modAlfPLERXF1)

max(AlfPLERXF$LER)
#plots
AlfPLERXF$predicted <- predict(modAlfPLERXF1, newdata = AlfPLERXF, re.form = NA)
APLERXFplot<-ggplot(AlfPLERXF, aes(x = N, y = LER)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Alf Partial LER (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between Alf Partial LER and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(0, 3.7) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")+
  geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")#legend for colors

#TWO way emmeans
AlfPLERXF1emm <- compute_emmeansNXF2("modAlfPLERXF1")
#pairwise N 
N_levels <- c(0, 40, 80, 120, 160)
emmsN <- emmeans(modAlfPLERXF1, specs = ~ N, at = list(N = N_levels), type = "response")
cld_dataNXFAPLERN <- cld(emmsN, Letters=custom_letters) # Create compact letter display
cld_dataNXFAPLERN $response <- format(cld_dataNXFAPLERN $response, digits = 2)
cld_dataNXFAPLERN $lower.CL <- format(cld_dataNXFAPLERN $lower.CL, digits = 2)
cld_dataNXFAPLERN $upper.CL <- format(cld_dataNXFAPLERN $upper.CL, digits = 3)
rownames(cld_dataNXFAPLERN ) <- NULL
cld_dataNXFAPLERN <- cld_dataNXFAPLERN  %>%
  select( N, response,lower.CL, upper.CL, .group)
colnames(cld_dataNXFAPLERN ) <- c( "N", "APLER","l","h", "Group")
cld_dataNXFAPLERN  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise P
emmsP <- emmeans(modAlfPLERXF1, specs = ~ P, type = "response")
cld_dataNXFAPLERP <- cld(emmsP, Letters=custom_letters) # Create compact letter display
cld_dataNXFAPLERP $response <- format(cld_dataNXFAPLERP $response, digits = 2)
cld_dataNXFAPLERP$lower.CL <- format(cld_dataNXFAPLERP$lower.CL, digits = 2)
cld_dataNXFAPLERP$upper.CL <- format(cld_dataNXFAPLERP$upper.CL, digits = 3)
rownames(cld_dataNXFAPLERP ) <- NULL
cld_dataNXFAPLERP <- cld_dataNXFAPLERP  %>%
  select( P, response, lower.CL,upper.CL,.group)
colnames(cld_dataNXFAPLERP ) <- c( "Site", "APLER","l","h", "Group")
cld_dataNXFAPLERP  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
```

#Year 2 summer partial Alf LERs model  
```{r}
modAlfPLERYS<-lmer(LER~N*P + (1|Rep), data= AlfPLERYS)
anova(modAlfPLERYS)
summary(modAlfPLERYS)
#check assumptions 
AlfPLERYS_resid<-resid(modAlfPLERYS)
qqnorm(AlfPLERYS_resid)
qqline(AlfPLERYS_resid)
plot(modAlfPLERYS)
#Logtransform
modAlfPLERYS1<-lmer(log(LER)~N*P + (1|Rep), AlfPLERYS)
anova(modAlfPLERYS1)
#check assumptions logtransform 
AlfPLERYS_resid1<-resid(modAlfPLERYS1)
qqnorm(AlfPLERYS_resid1)
qqline(AlfPLERYS_resid1)
plot(modAlfPLERYS1)

max(AlfPLERYS$LER)
#plots
AlfPLERYS$predicted <- predict(modAlfPLERYS1, newdata = AlfPLERYS, re.form = NA)
APLERYSplot<-ggplot(AlfPLERYS, aes(x = N, y = LER)) +
    geom_point() + geom_line(aes(N, exp(predicted)), color = "blue")+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Alf Partial LER (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between Alf Partial LER and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(0, 1.3) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")+
  geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")#legend for colors

#TWO way emmeans
AlfPLERYS1emm <- compute_emmeansNYS2("modAlfPLERYS1")
#Pairwise N
N_levels <- c(0, 40, 80, 120, 160)
emmsN <- emmeans(modAlfPLERYS1, specs = ~ N, at = list(N = N_levels), type = "response")
cld_dataNYSAPLERN <- cld(emmsN, Letters=custom_letters) # Create compact letter display
cld_dataNYSAPLERN $response <- format(cld_dataNYSAPLERN $response, digits = 2)
cld_dataNYSAPLERN $lower.CL <- format(cld_dataNYSAPLERN $lower.CL, digits = 2)
cld_dataNYSAPLERN $upper.CL <- format(cld_dataNYSAPLERN $upper.CL, digits = 3)
rownames(cld_dataNYSAPLERN ) <- NULL
cld_dataNYSAPLERN <- cld_dataNYSAPLERN  %>%
  select( N, response,lower.CL,upper.CL, .group)
colnames(cld_dataNYSAPLERN ) <- c( "N", "APLER","l","h", "Group")
cld_dataNYSAPLERN  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

summary(modAlfPLERYS1)

#EQUATION tables JUST N 
emtrends_result<-emtrends(modAlfPLERYS1,~ 1, var= "N", infer=TRUE)
emtrends_df <- as.data.frame(emtrends_result)
emmeans_results<-emmeans(modAlfPLERYS1, ~1, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
emtrends_df <- emtrends_df %>% mutate(key = 1)
emmeans_df <- emmeans_df %>% mutate(key = 1)
merged_df <- inner_join(emtrends_df, emmeans_df, by = "key")%>%
  select(emmean, N.trend, SE.x)
view(merged_df)
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
view(new_df)

```

#Year 2 Fall partial Alf LERs model
```{r}
modAlfPLERYF<-lmer(LER~N*P + (1|Rep), data= AlfPLERYF)
anova(modAlfPLERYF)
#check assumptions 
AlfPLERYF_resid<-resid(modAlfPLERYF)
qqnorm(AlfPLERYF_resid)
qqline(AlfPLERYF_resid)
plot(modAlfPLERYF)
#Logtransform
modAlfPLERYF1<-lmer(log(LER)~N*P + (1|Rep),data= AlfPLERYF)
anova(modAlfPLERYF1)
#check assumptions logtransform (makes BETTER)
AlfPLERYF_resid1<-resid(modAlfPLERYF1)
qqnorm(AlfPLERYF_resid1)
qqline(AlfPLERYF_resid1)
plot(modAlfPLERYF1)

max(AlfPLERYF$LER)
#plots
AlfPLERYF$predicted <- predict(modAlfPLERYF1, newdata = AlfPLERYF, re.form = NA)
APLERYFplot<-ggplot(AlfPLERYF, aes(x = N, y = LER)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Alf Partial LER (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between Alf Partial LER and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(0, 2.1) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")+
  geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")#legend for colors

#TWO way emmeans
AlfPLERYF1emm <- compute_emmeansNYF2("modAlfPLERYF1")
#Pariwsie N 
emmsN <- emmeans(modAlfPLERYF1, specs = ~ N, at = list(N = N_levels), type = "response")
cld_dataNYFAPLERN <- cld(emmsN, Letters=custom_letters) # Create compact letter display
cld_dataNYFAPLERN $response <- format(cld_dataNYFAPLERN $response, digits = 2)
cld_dataNYFAPLERN $lower.CL <- format(cld_dataNYFAPLERN $lower.CL, digits = 2)
cld_dataNYFAPLERN $upper.CL <- format(cld_dataNYFAPLERN $upper.CL, digits = 3)
rownames(cld_dataNYFAPLERN ) <- NULL
cld_dataNYFAPLERN <- cld_dataNYFAPLERN  %>%
  select( N, response,lower.CL, upper.CL, .group)
colnames(cld_dataNYFAPLERN ) <- c( "N", "APLER","l","h", "Group")
cld_dataNYFAPLERN  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

summary(modAlfPLERYF1)

#EQUATION tables JUST N 
emtrends_result<-emtrends(modAlfPLERYF1,~ 1, var= "N", infer=TRUE)
emtrends_df <- as.data.frame(emtrends_result)
emmeans_results<-emmeans(modAlfPLERYF1, ~1, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
emtrends_df <- emtrends_df %>% mutate(key = 1)
emmeans_df <- emmeans_df %>% mutate(key = 1)
merged_df <- inner_join(emtrends_df, emmeans_df, by = "key")%>%
  select(emmean, N.trend, SE.x)
view(merged_df)
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
view(new_df)
```

#Alf PLER combo plot
```{r}
AlfPLERXS$predictedAPLER <- predict(modAlfPLERXS1, newdata = AlfPLERXS, re.form = NA)
AlfPLERXF$predictedAPLER <- predict(modAlfPLERXF1, newdata = AlfPLERXF, re.form = NA)
AlfPLERYS$predictedAPLER <- predict(modAlfPLERYS1, newdata = AlfPLERYS, re.form = NA)
AlfPLERYF$predictedAPLER <- predict(modAlfPLERYF1, newdata = AlfPLERYF, re.form = NA)

# Layer all the plots together!
colors <- c("Year 1 Summer Harvest" = "red", 
            "Year 1 Fall Harvest" = "green", 
            "Year 2 Summer Harvest" = "blue", 
            "Year 2 Fall Harvest" = "purple")
legend_order <- c("Year 1 Summer Harvest", "Year 1 Fall Harvest", 
                  "Year 2 Summer Harvest", "Year 2 Fall Harvest")
AlfPLERXS$P <- factor(AlfPLERXS$P, levels = desired_order)
max(AlfPLERXS$LER)
max(AlfPLERXF$LER)
max(AlfPLERYS$LER)
max(AlfPLERYF$LER)
APLERcomboplot <- ggplot() +
  geom_line(data = AlfPLERXS, aes(N, exp(predictedAPLER), color = "Year 1 Summer Harvest")) +
  geom_point(data =AlfPLERXS, aes(x = N, y = LER, color = "Year 1 Summer Harvest")) +
  geom_line(data = AlfPLERXF, aes(N, exp(predictedAPLER), color = "Year 1 Fall Harvest")) +
  geom_point(data = AlfPLERXF, aes(x = N, y = LER, color = "Year 1 Fall Harvest")) +
  geom_line(data = AlfPLERYS, aes(N, exp(predictedAPLER), color = "Year 2 Summer Harvest")) +
  geom_point(data = AlfPLERYS, aes(x = N, y = LER, color = "Year 2 Summer Harvest")) +
  geom_line(data = AlfPLERYF, aes(N, exp(predictedAPLER), color = "Year 2 Fall Harvest")) +
  geom_point(data = AlfPLERYF, aes(x = N, y = LER, color = "Year 2 Fall Harvest")) +
  labs(x = "N-Rate (kg ha-1)", y = "Alfalfa PLER",
    color = "Harvest", 
    linetype = "Cropping System", shape = "Cropping System") +
  ggtitle("Relationship Between Alfalfa PLER and N-rate") +
  scale_x_continuous(breaks = c(0, 40, 80, 120, 160)) +
  ylim(0, 3.7) +
  facet_wrap(~P, scales = "free", ncol = 2) +
  scale_color_manual(values = colors, limits = legend_order)+
  scale_shape_manual(values = c(4, 20))+
  geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")


print(APLERcomboplot)

ggsave("APLERcomboplot.jpg", plot = APLERcomboplot, width = 8, height = 6, dpi = 300)
```
#APLER E plots (XS, XF)
```{r}
#XS 
NAPLERXSemmsP <- emmeans(modAlfPLERXS1, ~ P, type = "response") 
emms_df <- as.data.frame(NAPLERXSemmsP)
cld_dataNAPLERXSP <- cld(NAPLERXSemmsP, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataNAPLERXSP)
merged_df <- merge(emms_df, cld_df,by = c("P"))
APLERXSE<-ggplot(AlfPLERXS, aes(x = P, y = exp(predicted))) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7, color="darkgreen") +
  labs(x = "Environment", y = "Alfalfa PLER") +
  geom_point(data = emms_df, aes(x = P, y = response), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 1.8)+
  ggtitle("Year 1 Summer")+
  scale_y_continuous(breaks = c(0.5,0.75,1,1.25,1.5), limits = c(0, 1.55))+
  geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")

print(APLERXSE)


#XF 
NAPLERXFemmsP <- emmeans(modAlfPLERXF1, ~ P, type = "response") 
emms_df <- as.data.frame(NAPLERXFemmsP)
cld_dataNAPLERXFP <- cld(NAPLERXFemmsP, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataNAPLERXFP)
merged_df <- merge(emms_df, cld_df,by = c("P"))
APLERXFE<-ggplot(AlfPLERXF, aes(x = P, y = exp(predicted))) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7, color="darkgreen") +
  labs(x = "Environment", y = "Alfalfa PLER") +
  geom_point(data = emms_df, aes(x = P, y = response), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 1.8)+
  ggtitle("Year 1 Fall")+
  scale_y_continuous(breaks = c(0.5,0.75,1,1.25,1.5), limits = c(0, 1.55))+
  geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")

print(APLERXFE)


APLERE<-grid.arrange(APLERXSE, APLERXFE, ncol = 2)
ggsave("APLERE.jpg", plot = APLERE, width = 8, height = 6, dpi = 300)
```
#APLER plots N (YS, YF)
```{r}
#YS
max(AlfPLERYS$LER)
APLERplotNYS <- ggplot() +
  geom_point(data = AlfPLERYS, aes(x = N, y = LER), color= "blue") +
  labs(x = "N-Rate (kg ha-1)", y = "Alfalfa PLER",
    color = "Harvest") +
  scale_x_continuous(breaks = c(0, 40, 80, 120, 160)) +
  ylim(0, 2.1) +
  geom_function(data=AlfPLERYS, fun=~0.62*exp(-0.0046*.x),color='blue')+
  geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")+
  ggtitle("Year 2 Summer")
print(APLERplotNYS)

#YF
max(AlfPLERYF$LER)
APLERplotNYF <- ggplot() +
  geom_point(data = AlfPLERYF, aes(x = N, y = LER), color= "purple") +
  labs(x = "N-Rate (kg ha-1)", y = "Alfalfa PLER",
    color = "Harvest") +
  scale_x_continuous(breaks = c(0, 40, 80, 120, 160)) +
  ylim(0, 2.1) +
  ggtitle("Year 2 Fall")+
  geom_function(data=AlfPLERYF, fun=~1.17*exp(-0.0030*.x),color='purple')+
  geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")
print(APLERplotNYF)

APLERNplot<-grid.arrange(APLERplotNYS, APLERplotNYF, ncol = 2)
ggsave("APLERNplot.jpg", plot = APLERNplot, width = 8, height = 6, dpi = 300)
```

#make PrPLERs
```{r}
#so the proportional LER would be like is the PLER of IWG in the TLER is 0.7 and the TLER is 1.2 so its just the PLER over the TLER and 0.7/1.2=0.58 and then for alfalfa it would be 0.5/1.2= 0.4166 and thats the like percent makeup of TLER

ILERresultsNdSWALL_longNONA<-LERresultsNdSWALL_longNONA[LERresultsNdSWALL_longNONA$PlotType != "LERAlfSW",]
ALERresultsNdSWALL_longNONA<-LERresultsNdSWALL_longNONA[LERresultsNdSWALL_longNONA$PlotType != "LERIWGSW",]

#IWG PrPLER
IPrPLER <- ILERresultsNdSWALL_longNONA %>%
  group_by(Rep, P, YearCode, Harvest, NRATE) %>%
  reframe(
    IPrPLER= (LER[tot_or_part == "Partial"]) / (LER[tot_or_part == "Total"]))
#Alf PrPLER 
APrPLER <- ALERresultsNdSWALL_longNONA %>%
  group_by(Rep, P, YearCode, Harvest, NRATE) %>%
  reframe(
    APrPLER= (LER[tot_or_part == "Partial"]) / (LER[tot_or_part == "Total"]))
#put IWG and Alf PrPLERs into same frame 
PrPLER <- merge(APrPLER, IPrPLER, by = c("Rep", "P", "YearCode", "Harvest", "NRATE"), all = TRUE)
PrPLER$N<-PrPLER$NRATE
PrPLERX<-PrPLER[PrPLER$YearCode == "X",]
PrPLERY<-PrPLER[PrPLER$YearCode == "Y",]
PrPLERXS<-PrPLERX[PrPLERX$Harvest == "Summer",]
PrPLERXF<-PrPLERX[PrPLERX$Harvest == "Fall",]
PrPLERYS<-PrPLERY[PrPLERY$Harvest == "Summer",]
PrPLERYF<-PrPLERY[PrPLERY$Harvest == "Fall",]
```

#IWG PrPLER models 
```{r}
#model by nrate XS
modIPrPLERXS<-lmer(IPrPLER~N*P + (1|Rep), data = PrPLERXS )
anova(modIPrPLERXS)
#check assumptions 
IPrPLERXS_resid<-resid(modIPrPLERXS)
qqnorm(IPrPLERXS_resid)
qqline(IPrPLERXS_resid)
plot(modIPrPLERXS)
#Logtransform
modIPrPLERXS1<-lmer(log(IPrPLER)~N*P + (1|Rep), data = PrPLERXS )
summary(modIPrPLERXS1)
anova(modIPrPLERXS1)
#check assumptions logtransform (makes BETTER)
IPrPLERXS_resid1<-resid(modIPrPLERXS1)
qqnorm(IPrPLERXS_resid1)
qqline(IPrPLERXS_resid1)
plot(modIPrPLERXS1)
#TWO way emmeans
IPrPLERXS1emm <- compute_emmeansNXS2("modIPrPLERXS1")
#Pairwise P
emmsP <- emmeans(modIPrPLERXS1, specs = ~ P, type = "response")
cld_dataNXSIPrPLERP <- cld(emmsP, Letters=custom_letters) # Create compact letter display
cld_dataNXSIPrPLERP $response <- format(cld_dataNXSIPrPLERP $response, digits = 3)
cld_dataNXSIPrPLERP$lower.CL <- format(cld_dataNXSIPrPLERP$lower.CL, digits = 3)
cld_dataNXSIPrPLERP$upper.CL <- format(cld_dataNXSIPrPLERP$upper.CL, digits = 3)
rownames(cld_dataNXSIPrPLERP ) <- NULL
cld_dataNXSIPrPLERP <- cld_dataNXSIPrPLERP  %>%
  select( P, response, lower.CL, upper.CL, .group)
colnames(cld_dataNXSIPrPLERP ) <- c( "Site", "TLER","l","h", "Group")
cld_dataNXSIPrPLERP   |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise N
N_levels <- c(0, 40, 80, 120, 160)
emmsN <- emmeans(modIPrPLERXS1, specs = ~ N, at = list(N = N_levels), type = "response")
cld_dataNXSIPrPLERN <- cld(emmsN, Letters=custom_letters) # Create compact letter display
cld_dataNXSIPrPLERN $response <- format(cld_dataNXSIPrPLERN $response, digits = 3)
cld_dataNXSIPrPLERN$lower.CL <- format(cld_dataNXSIPrPLERN$lower.CL, digits = 3)
cld_dataNXSIPrPLERN$upper.CL <- format(cld_dataNXSIPrPLERN$upper.CL, digits = 3)
rownames(cld_dataNXSIPrPLERN ) <- NULL
cld_dataNXSIPrPLERN <- cld_dataNXSIPrPLERN  %>%
  select( N, response, lower.CL, upper.CL, .group)
colnames(cld_dataNXSIPrPLERN ) <- c( "N", "TLER","l","h", "Group")
cld_dataNXSIPrPLERN   |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

#model by nrate XF
modIPrPLERXF<-lmer(IPrPLER~N*P + (1|Rep), data = PrPLERXF )
anova(modIPrPLERXF)
#check assumptions 
IPrPLERXF_resid<-resid(modIPrPLERXF)
qqnorm(IPrPLERXF_resid)
qqline(IPrPLERXF_resid)
plot(modIPrPLERXF)
#Logtransform
modIPrPLERXF1<-lmer(log(IPrPLER)~N*P + (1|Rep), data = PrPLERXF )
anova(modIPrPLERXF1)
#check assumptions logtransform (makes BETTER)
IPrPLERXF_resid1<-resid(modIPrPLERXF1)
qqnorm(IPrPLERXF_resid1)
qqline(IPrPLERXF_resid1)
plot(modIPrPLERXF1)
#TWO way emmeans
IPrPLERXF1emm <- compute_emmeansNXF2("modIPrPLERXF1")
#Pairwise P
emmsP <- emmeans(modIPrPLERXF1, specs = ~ P, type = "response")
cld_dataNXFIPrPLERP <- cld(emmsP, Letters=custom_letters) # Create compact letter display
cld_dataNXFIPrPLERP $response <- format(cld_dataNXFIPrPLERP $response, digits = 3)
cld_dataNXFIPrPLERP$lower.CL <- format(cld_dataNXFIPrPLERP$lower.CL, digits = 3)
cld_dataNXFIPrPLERP$upper.CL <- format(cld_dataNXFIPrPLERP$upper.CL, digits = 3)
rownames(cld_dataNXFIPrPLERP ) <- NULL
cld_dataNXFIPrPLERP <- cld_dataNXFIPrPLERP  %>%
  select( P, response, lower.CL, upper.CL, .group)
colnames(cld_dataNXFIPrPLERP ) <- c( "Site", "TLER","l","h", "Group")
cld_dataNXFIPrPLERP   |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise N
N_levels <- c(0, 40, 80, 120, 160)
emmsN <- emmeans(modIPrPLERXF1, specs = ~ N, at = list(N = N_levels), type = "response")
cld_dataNXFIPrPLERN <- cld(emmsN, Letters=custom_letters) # Create compact letter display
cld_dataNXFIPrPLERN $response <- format(cld_dataNXFIPrPLERN $response, digits = 3)
cld_dataNXFIPrPLERN$lower.CL <- format(cld_dataNXFIPrPLERN$lower.CL, digits = 3)
cld_dataNXFIPrPLERN$upper.CL <- format(cld_dataNXFIPrPLERN$upper.CL, digits = 3)
rownames(cld_dataNXFIPrPLERN ) <- NULL
cld_dataNXFIPrPLERN <- cld_dataNXFIPrPLERN  %>%
  select( N, response, lower.CL, upper.CL, .group)
colnames(cld_dataNXFIPrPLERN ) <- c( "N", "TLER","l","h", "Group")
cld_dataNXFIPrPLERN   |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

#model by nrate YS
modIPrPLERYS<-lmer(IPrPLER~N*P + (1|Rep), data = PrPLERYS )
anova(modIPrPLERYS)
#check assumptions 
IPrPLERYS_resid<-resid(modIPrPLERYS)
qqnorm(IPrPLERYS_resid)
qqline(IPrPLERYS_resid)
plot(modIPrPLERYS)
#Logtransform
modIPrPLERYS1<-lmer(log(IPrPLER)~N*P + (1|Rep), data = PrPLERYS )
summary(modIPrPLERYS1)
anova(modIPrPLERYS1)
#check assumptions logtransform (makes BETTER)
IPrPLERYS_resid1<-resid(modIPrPLERYS1)
qqnorm(IPrPLERYS_resid1)
qqline(IPrPLERYS_resid1)
plot(modIPrPLERYS1)
#TWO way emmeans
IPrPLERYS1emm <- compute_emmeansNYS2("modIPrPLERYS1")
#Pairwise N
N_levels <- c(0, 40, 80, 120, 160)
emmsN <- emmeans(modIPrPLERYS1, specs = ~ N, at = list(N = N_levels), type = "response")
cld_dataNYSIPrPLERN <- cld(emmsN, Letters=custom_letters) # Create compact letter display
cld_dataNYSIPrPLERN $response <- format(cld_dataNYSIPrPLERN $response, digits = 3)
cld_dataNYSIPrPLERN$lower.CL <- format(cld_dataNYSIPrPLERN$lower.CL, digits = 3)
cld_dataNYSIPrPLERN$upper.CL <- format(cld_dataNYSIPrPLERN$upper.CL, digits = 3)
rownames(cld_dataNYSIPrPLERN ) <- NULL
cld_dataNYSIPrPLERN <- cld_dataNYSIPrPLERN  %>%
  select( N, response, lower.CL, upper.CL, .group)
colnames(cld_dataNYSIPrPLERN ) <- c( "N", "TLER","l","h", "Group")
cld_dataNYSIPrPLERN   |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#EQUATION tables JUST N 
emtrends_result<-emtrends(modIPrPLERYS1,~ 1, var= "N", infer=TRUE)
emtrends_df <- as.data.frame(emtrends_result)
emmeans_results<-emmeans(modIPrPLERYS1, ~1, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
emtrends_df <- emtrends_df %>% mutate(key = 1)
emmeans_df <- emmeans_df %>% mutate(key = 1)
merged_df <- inner_join(emtrends_df, emmeans_df, by = "key")%>%
  select(emmean, N.trend, SE.x)
view(merged_df)
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
view(new_df)

#model by nrate YF
modIPrPLERYF<-lmer(IPrPLER~N*P + (1|Rep), data = PrPLERYF )
anova(modIPrPLERYF)
#check assumptions 
IPrPLERYF_resid<-resid(modIPrPLERYF)
qqnorm(IPrPLERYF_resid)
qqline(IPrPLERYF_resid)
plot(modIPrPLERYF)
#Logtransform
modIPrPLERYF1<-lmer(log(IPrPLER)~N*P + (1|Rep), data = PrPLERYF )
summary(modIPrPLERYF1)
anova(modIPrPLERYF1)
#check assumptions logtransform (makes BETTER)
IPrPLERYF_resid1<-resid(modIPrPLERYF1)
qqnorm(IPrPLERYF_resid1)
qqline(IPrPLERYF_resid1)
plot(modIPrPLERYF1)
#TWO way emmeans
IPrPLERYF1emm <- compute_emmeansNYF2("modIPrPLERYF1")
#Pairwise N
N_levels <- c(0, 40, 80, 120, 160)
emmsN <- emmeans(modIPrPLERYF1, specs = ~ N, at = list(N = N_levels), type = "response")
cld_dataNYFIPrPLERN <- cld(emmsN, Letters=custom_letters) # Create compact letter display
cld_dataNYFIPrPLERN $response <- format(cld_dataNYFIPrPLERN $response, digits = 3)
cld_dataNYFIPrPLERN$lower.CL <- format(cld_dataNYFIPrPLERN$lower.CL, digits = 3)
cld_dataNYFIPrPLERN$upper.CL <- format(cld_dataNYFIPrPLERN$upper.CL, digits = 3)
rownames(cld_dataNYFIPrPLERN ) <- NULL
cld_dataNYFIPrPLERN <- cld_dataNYFIPrPLERN  %>%
  select( N, response, lower.CL, upper.CL, .group)
colnames(cld_dataNYFIPrPLERN ) <- c( "N", "TLER","l","h", "Group")
cld_dataNYFIPrPLERN   |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise P
emmsP <- emmeans(modIPrPLERYF1, specs = ~ P, type = "response")
cld_dataNYFIPrPLERP <- cld(emmsP, Letters=custom_letters) # Create compact letter display
cld_dataNYFIPrPLERP $response <- format(cld_dataNYFIPrPLERP $response, digits = 3)
cld_dataNYFIPrPLERP$lower.CL <- format(cld_dataNYFIPrPLERP$lower.CL, digits = 3)
cld_dataNYFIPrPLERP$upper.CL <- format(cld_dataNYFIPrPLERP$upper.CL, digits = 3)
rownames(cld_dataNYFIPrPLERP ) <- NULL
cld_dataNYFIPrPLERP <- cld_dataNYFIPrPLERP  %>%
  select( P, response, lower.CL, upper.CL, .group)
colnames(cld_dataNYFIPrPLERP ) <- c( "Site", "TLER","l","h", "Group")
cld_dataNYFIPrPLERP   |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#EQUATION tables JUST N 
emtrends_result<-emtrends(modIPrPLERYF1,~ 1, var= "N", infer=TRUE)
emtrends_df <- as.data.frame(emtrends_result)
emmeans_results<-emmeans(modIPrPLERYF1, ~1, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
emtrends_df <- emtrends_df %>% mutate(key = 1)
emmeans_df <- emmeans_df %>% mutate(key = 1)
merged_df <- inner_join(emtrends_df, emmeans_df, by = "key")%>%
  select(emmean, N.trend, SE.x)
view(merged_df)
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
view(new_df)
```
#IWG PrPLER E plots (XS, XF, YF)
```{r}
#XS 
PrPLERXS$predicted <- predict(modIPrPLERXS1, newdata = PrPLERXS, re.form = NA)
NIPrPLERXSemmsP <- emmeans(modIPrPLERXS1, ~ P, type = "response") 
emms_df <- as.data.frame(NIPrPLERXSemmsP)
cld_dataNIPrPLERXSP <- cld(NIPrPLERXSemmsP, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataNIPrPLERXSP)
merged_df <- merge(emms_df, cld_df,by = c("P"))
IPrPLERXSE<-ggplot(PrPLERXS, aes(x = P, y = exp(predicted))) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7, color="darkgreen") +
  labs(x = "Environment", y = "IWG PrPLER") +
  geom_point(data = emms_df, aes(x = P, y = response), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 1.8)+
  ggtitle("Year 1 Summer")+
  scale_y_continuous(breaks = c(0.25, 0.5, 0.75, 1), limits = c(0, 1))+
  geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")

print(IPrPLERXSE)


#XF 
PrPLERXF$predicted <- predict(modIPrPLERXF1, newdata = PrPLERXF, re.form = NA)
NIPrPLERXFemmsP <- emmeans(modIPrPLERXF1, ~ P, type = "response") 
emms_df <- as.data.frame(NIPrPLERXFemmsP)
cld_dataNIPrPLERXFP <- cld(NIPrPLERXFemmsP, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataNIPrPLERXFP)
merged_df <- merge(emms_df, cld_df,by = c("P"))
IPrPLERXFE<-ggplot(PrPLERXF, aes(x = P, y = exp(predicted))) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7, color="darkgreen") +
  labs(x = "Environment", y = "IWG PrPLER") +
  geom_point(data = emms_df, aes(x = P, y = response), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 1.8)+
  ggtitle("Year 1 Fall")+
  scale_y_continuous(breaks = c(0.25, 0.5, 0.75, 1), limits = c(0, 1))+
  geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")

#YF 
PrPLERYF$predicted <- predict(modIPrPLERYF1, newdata = PrPLERYF, re.form = NA)
NIPrPLERYFemmsP <- emmeans(modIPrPLERYF1, ~ P, type = "response") 
emms_df <- as.data.frame(NIPrPLERYFemmsP)
cld_dataNIPrPLERYFP <- cld(NIPrPLERYFemmsP, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataNIPrPLERYFP)
merged_df <- merge(emms_df, cld_df,by = c("P"))
IPrPLERYFE<-ggplot(PrPLERYF, aes(x = P, y = exp(predicted))) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7, color="darkgreen") +
  labs(x = "Environment", y = "IWG PrPLER") +
  geom_point(data = emms_df, aes(x = P, y = response), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 1.8)+
  ggtitle("Year 2 Fall")+
  scale_y_continuous(breaks = c(0.25, 0.5, 0.75, 1), limits = c(0, 1))+
  geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")

IPrPLERE<-grid.arrange(IPrPLERXSE,IPrPLERXFE,IPrPLERYFE, ncol = 2)
ggsave("IPrPLERE.jpg", plot = IPrPLERE, width = 8, height = 6, dpi = 300)
```
#IWG PrPLER plots N (YS, YF)
```{r}
#YS
max(PrPLERYS$IPrPLER)
IPrPLERplotNYS <- ggplot() +
  geom_point(data = PrPLERYS, aes(x = N, y = IPrPLER), color= "blue") +
  labs(x = "N-Rate (kg ha-1)", y = "IWG PrPLER",
    color = "Harvest") +
  scale_x_continuous(breaks = c(0, 40, 80, 120, 160)) +
  ylim(0, 1) +
  geom_function(data=PrPLERYS, fun=~0.50*exp(0.0019*.x),color='blue')+
  geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")+
  ggtitle("Year 2 Summer")
print(IPrPLERplotNYS)

#YF
max(PrPLERYF$IPrPLER)
IPrPLERplotNYF <- ggplot() +
  geom_point(data = PrPLERYF, aes(x = N, y = IPrPLER), color= "purple") +
  labs(x = "N-Rate (kg ha-1)", y = "IWG PrPLER",
    color = "Harvest") +
  scale_x_continuous(breaks = c(0, 40, 80, 120, 160)) +
  ylim(0, 1) +
  geom_function(data=PrPLERYF, fun=~0.51*exp(0.0020*.x),color='purple')+
  geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")+
  ggtitle("Year 2 Fall")
print(IPrPLERplotNYF)

IPrPLERNplot<-grid.arrange(IPrPLERplotNYS,IPrPLERplotNYF, ncol = 2)
ggsave("IPrPLERNplot.jpg", plot = IPrPLERNplot, width = 8, height = 6, dpi = 300)
```

#Alf PrPLER models 
```{r}
#model by nrate XS
modAPrPLERXS<-lmer(APrPLER~N*P + (1|Rep), data = PrPLERXS )
anova(modAPrPLERXS)
#check assumptions 
APrPLERXS_resid<-resid(modAPrPLERXS)
qqnorm(APrPLERXS_resid)
qqline(APrPLERXS_resid)
plot(modAPrPLERXS)
#Logtransform
modAPrPLERXS1<-lmer(log(APrPLER)~N*P + (1|Rep), data = PrPLERXS )
anova(modAPrPLERXS1)
#check assumptions logtransform (makes BETTER)
APrPLERXS_resid1<-resid(modAPrPLERXS1)
qqnorm(APrPLERXS_resid1)
qqline(APrPLERXS_resid1)
plot(modAPrPLERXS1)
#TWO way emmeans
APrPLERXS1emm <- compute_emmeansNXS2("modAPrPLERXS1")
#Pairwise P
emmsP <- emmeans(modAPrPLERXS1, specs = ~ P, type = "response")
cld_dataNXSAPrPLERP <- cld(emmsP, Letters=custom_letters) # Create compact letter display
cld_dataNXSAPrPLERP  $response <- format(cld_dataNXSAPrPLERP  $response, digits = 3)
cld_dataNXSAPrPLERP $lower.CL <- format(cld_dataNXSAPrPLERP $lower.CL, digits = 3)
cld_dataNXSAPrPLERP $upper.CL <- format(cld_dataNXSAPrPLERP $upper.CL, digits = 3)
rownames(cld_dataNXSAPrPLERP  ) <- NULL
cld_dataNXSAPrPLERP  <- cld_dataNXSAPrPLERP   %>%
  select( P, response, lower.CL, upper.CL, .group)
colnames(cld_dataNXSAPrPLERP  ) <- c( "Site", "TLER","l","h", "Group")
cld_dataNXSAPrPLERP    |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise N
N_levels <- c(0, 40, 80, 120, 160)
emmsN <- emmeans(modAPrPLERXS1, specs = ~ N, at = list(N = N_levels), type = "response")
cld_dataNXSAPrPLERN <- cld(emmsN, Letters=custom_letters) # Create compact letter display
cld_dataNXSAPrPLERN  $response <- format(cld_dataNXSAPrPLERN  $response, digits = 3)
cld_dataNXSAPrPLERN $lower.CL <- format(cld_dataNXSAPrPLERN $lower.CL, digits = 3)
cld_dataNXSAPrPLERN $upper.CL <- format(cld_dataNXSAPrPLERN $upper.CL, digits = 3)
rownames(cld_dataNXSAPrPLERN  ) <- NULL
cld_dataNXSAPrPLERN  <- cld_dataNXSAPrPLERN   %>%
  select( N, response, lower.CL, upper.CL, .group)
colnames(cld_dataNXSAPrPLERN  ) <- c( "N", "TLER","l","h", "Group")
cld_dataNXSAPrPLERN    |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

#model by nrate XF
modAPrPLERXF<-lmer(APrPLER~N*P + (1|Rep), data = PrPLERXF )
anova(modAPrPLERXF)
#check assumptions 
APrPLERXF_resid<-resid(modAPrPLERXF)
qqnorm(APrPLERXF_resid)
qqline(APrPLERXF_resid)
plot(modAPrPLERXF)
#Logtransform
modAPrPLERXF1<-lmer(log(APrPLER)~N*P + (1|Rep), data = PrPLERXF )
anova(modAPrPLERXF1)
#check assumptions logtransform (makes BETTER)
APrPLERXF_resid1<-resid(modAPrPLERXF1)
qqnorm(APrPLERXF_resid1)
qqline(APrPLERXF_resid1)
plot(modAPrPLERXF1)
#TWO way emmeans
APrPLERXF1emm <- compute_emmeansNXF2("modAPrPLERXF1")
#Pairwise P
emmsP <- emmeans(modAPrPLERXF1, specs = ~ P, type = "response")
cld_dataNXFAPrPLERP <- cld(emmsP, Letters=custom_letters) # Create compact letter display
cld_dataNXFAPrPLERP  $response <- format(cld_dataNXFAPrPLERP  $response, digits = 3)
cld_dataNXFAPrPLERP $lower.CL <- format(cld_dataNXFAPrPLERP $lower.CL, digits = 3)
cld_dataNXFAPrPLERP $upper.CL <- format(cld_dataNXFAPrPLERP $upper.CL, digits = 3)
rownames(cld_dataNXFAPrPLERP  ) <- NULL
cld_dataNXFAPrPLERP  <- cld_dataNXFAPrPLERP   %>%
  select( P, response, lower.CL, upper.CL, .group)
colnames(cld_dataNXFAPrPLERP  ) <- c( "Site", "TLER","l","h", "Group")
cld_dataNXFAPrPLERP    |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise N
N_levels <- c(0, 40, 80, 120, 160)
emmsN <- emmeans(modAPrPLERXF1, specs = ~ N, at = list(N = N_levels), type = "response")
cld_dataNXFAPrPLERN <- cld(emmsN, Letters=custom_letters) # Create compact letter display
cld_dataNXFAPrPLERN  $response <- format(cld_dataNXFAPrPLERN  $response, digits = 3)
cld_dataNXFAPrPLERN $lower.CL <- format(cld_dataNXFAPrPLERN $lower.CL, digits = 3)
cld_dataNXFAPrPLERN $upper.CL <- format(cld_dataNXFAPrPLERN $upper.CL, digits = 3)
rownames(cld_dataNXFAPrPLERN  ) <- NULL
cld_dataNXFAPrPLERN  <- cld_dataNXFAPrPLERN   %>%
  select( N, response, lower.CL, upper.CL, .group)
colnames(cld_dataNXFAPrPLERN  ) <- c( "N", "TLER","l","h", "Group")
cld_dataNXFAPrPLERN    |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

#model by nrate YS
modAPrPLERYS<-lmer(APrPLER~N*P + (1|Rep), data = PrPLERYS )
anova(modAPrPLERYS)
#check assumptions 
APrPLERYS_resid<-resid(modAPrPLERYS)
qqnorm(APrPLERYS_resid)
qqline(APrPLERYS_resid)
plot(modAPrPLERYS)
#Logtransform
modAPrPLERYS1<-lmer(log(APrPLER)~N*P + (1|Rep), data = PrPLERYS )
summary(modAPrPLERYS1)
anova(modAPrPLERYS1)
#check assumptions logtransform (makes BETTER)
APrPLERYS_resid1<-resid(modAPrPLERYS1)
qqnorm(APrPLERYS_resid1)
qqline(APrPLERYS_resid1)
plot(modAPrPLERYS1)
#TWO way emmeans
APrPLERYS1emm <- compute_emmeansNYS2("modAPrPLERYS1")
#Pairwise N
N_levels <- c(0, 40, 80, 120, 160)
emmsN <- emmeans(modAPrPLERYS1, specs = ~ N, at = list(N = N_levels), type = "response")
cld_dataNYSAPrPLERN <- cld(emmsN, Letters=custom_letters) # Create compact letter display
cld_dataNYSAPrPLERN  $response <- format(cld_dataNYSAPrPLERN  $response, digits = 3)
cld_dataNYSAPrPLERN $lower.CL <- format(cld_dataNYSAPrPLERN $lower.CL, digits = 3)
cld_dataNYSAPrPLERN $upper.CL <- format(cld_dataNYSAPrPLERN $upper.CL, digits = 3)
rownames(cld_dataNYSAPrPLERN  ) <- NULL
cld_dataNYSAPrPLERN  <- cld_dataNYSAPrPLERN   %>%
  select( N, response, lower.CL, upper.CL, .group)
colnames(cld_dataNYSAPrPLERN  ) <- c( "N", "TLER","l","h", "Group")
cld_dataNYSAPrPLERN    |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#EQUATION tables JUST N 
emtrends_result<-emtrends(modAPrPLERYS1,~ 1, var= "N", infer=TRUE)
emtrends_df <- as.data.frame(emtrends_result)
emmeans_results<-emmeans(modAPrPLERYS1, ~1, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
emtrends_df <- emtrends_df %>% mutate(key = 1)
emmeans_df <- emmeans_df %>% mutate(key = 1)
merged_df <- inner_join(emtrends_df, emmeans_df, by = "key")%>%
  select(emmean, N.trend, SE.x)
view(merged_df)
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
view(new_df)


#model by nrate YF
modAPrPLERYF<-lmer(APrPLER~N*P + (1|Rep), data = PrPLERYF )
anova(modAPrPLERYF)
#check assumptions 
APrPLERYF_resid<-resid(modAPrPLERYF)
qqnorm(APrPLERYF_resid)
qqline(APrPLERYF_resid)
plot(modAPrPLERYF)
#Logtransform
modAPrPLERYF1<-lmer(log(APrPLER)~N*P + (1|Rep), data = PrPLERYF )
summary(modAPrPLERYF1)
anova(modAPrPLERYF1)
#check assumptions logtransform (makes BETTER)
APrPLERYF_resid1<-resid(modAPrPLERYF1)
qqnorm(APrPLERYF_resid1)
qqline(APrPLERYF_resid1)
plot(modAPrPLERYF1)
#TWO way emmeans
APrPLERYF1emm <- compute_emmeansNYF2("modAPrPLERYF1")
#Pairwise P
emmsP <- emmeans(modAPrPLERYF1, specs = ~ P, type = "response")
cld_dataNYFAPrPLERP <- cld(emmsP, Letters=custom_letters) # Create compact letter display
cld_dataNYFAPrPLERP  $response <- format(cld_dataNYFAPrPLERP  $response, digits = 3)
cld_dataNYFAPrPLERP $lower.CL <- format(cld_dataNYFAPrPLERP $lower.CL, digits = 3)
cld_dataNYFAPrPLERP $upper.CL <- format(cld_dataNYFAPrPLERP $upper.CL, digits = 3)
rownames(cld_dataNYFAPrPLERP  ) <- NULL
cld_dataNYFAPrPLERP  <- cld_dataNYFAPrPLERP   %>%
  select( P, response, lower.CL, upper.CL, .group)
colnames(cld_dataNYFAPrPLERP  ) <- c( "Site", "TLER","l","h", "Group")
cld_dataNYFAPrPLERP    |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise N
N_levels <- c(0, 40, 80, 120, 160)
emmsN <- emmeans(modAPrPLERYF1, specs = ~ N, at = list(N = N_levels), type = "response")
cld_dataNYFAPrPLERN <- cld(emmsN, Letters=custom_letters) # Create compact letter display
cld_dataNYFAPrPLERN  $response <- format(cld_dataNYFAPrPLERN  $response, digits = 3)
cld_dataNYFAPrPLERN $lower.CL <- format(cld_dataNYFAPrPLERN $lower.CL, digits = 3)
cld_dataNYFAPrPLERN $upper.CL <- format(cld_dataNYFAPrPLERN $upper.CL, digits = 3)
rownames(cld_dataNYFAPrPLERN  ) <- NULL
cld_dataNYFAPrPLERN  <- cld_dataNYFAPrPLERN   %>%
  select( N, response, lower.CL, upper.CL, .group)
colnames(cld_dataNYFAPrPLERN  ) <- c( "N", "TLER","l","h", "Group")
cld_dataNYFAPrPLERN    |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#EQUATION tables JUST N 
emtrends_result<-emtrends(modAPrPLERYF1,~ 1, var= "N", infer=TRUE)
emtrends_df <- as.data.frame(emtrends_result)
emmeans_results<-emmeans(modAPrPLERYF1, ~1, at=list(N=0))
emmeans_df <- as.data.frame(emmeans_results)
emtrends_df <- emtrends_df %>% mutate(key = 1)
emmeans_df <- emmeans_df %>% mutate(key = 1)
merged_df <- inner_join(emtrends_df, emmeans_df, by = "key")%>%
  select(emmean, N.trend, SE.x)
view(merged_df)
new_df <- merged_df %>%
  mutate(equation = sprintf("=%.2f*e(%.4fN)", exp(emmean), N.trend),  SE.x = sprintf("%.4f", SE.x),  percent_change = sprintf("%.2f%%", (exp(N.trend) - 1) * 100))%>%
  select(-emmean, -N.trend)
view(new_df)
```
#Alf PrPLER E plots (XS, XF, YF)
```{r}
#XS 
PrPLERXS$predicted <- predict(modAPrPLERXS1, newdata = PrPLERXS, re.form = NA)
NAPrPLERXSemmsP <- emmeans(modAPrPLERXS1, ~ P, type = "response") 
emms_df <- as.data.frame(NAPrPLERXSemmsP)
cld_dataNAPrPLERXSP <- cld(NAPrPLERXSemmsP, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataNAPrPLERXSP)
merged_df <- merge(emms_df, cld_df,by = c("P"))
APrPLERXSE<-ggplot(PrPLERXS, aes(x = P, y = exp(predicted))) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7, color="darkgreen") +
  labs(x = "Environment", y = "Alfalfa PrPLER") +
  geom_point(data = emms_df, aes(x = P, y = response), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 1.8)+
  ggtitle("Year 1 Summer")+
  scale_y_continuous(breaks =c(0.25, 0.5, 0.75, 1), limits = c(0, 1))+
  geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")

print(APrPLERXSE)


#XF 
PrPLERXF$predicted <- predict(modAPrPLERXF1, newdata = PrPLERXF, re.form = NA)
NAPrPLERXFemmsP <- emmeans(modAPrPLERXF1, ~ P, type = "response") 
emms_df <- as.data.frame(NAPrPLERXFemmsP)
cld_dataNAPrPLERXFP <- cld(NAPrPLERXFemmsP, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataNAPrPLERXFP)
merged_df <- merge(emms_df, cld_df,by = c("P"))
APrPLERXFE<-ggplot(PrPLERXF, aes(x = P, y = exp(predicted))) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7, color="darkgreen") +
  labs(x = "Environment", y = "Alfalfa PrPLER") +
  geom_point(data = emms_df, aes(x = P, y = response), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 1.8)+
  ggtitle("Year 1 Fall")+
  scale_y_continuous(breaks = c(0.25, 0.5, 0.75, 1), limits = c(0, 1))+
  geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")

#YF 
PrPLERYF$predicted <- predict(modAPrPLERYF1, newdata = PrPLERYF, re.form = NA)
NAPrPLERYFemmsP <- emmeans(modAPrPLERYF1, ~ P, type = "response") 
emms_df <- as.data.frame(NAPrPLERYFemmsP)
cld_dataNAPrPLERYFP <- cld(NAPrPLERYFemmsP, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataNAPrPLERYFP)
merged_df <- merge(emms_df, cld_df,by = c("P"))
APrPLERYFE<-ggplot(PrPLERYF, aes(x = P, y = exp(predicted))) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7, color="darkgreen") +
  labs(x = "Environment", y = "Alfalfa PrPLER") +
  geom_point(data = emms_df, aes(x = P, y = response), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 1.8)+
  ggtitle("Year 2 Fall")+
  scale_y_continuous(breaks = c(0.25, 0.5, 0.75, 1), limits = c(0, 1))+
  geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")

APrPLERE<-grid.arrange(APrPLERXSE,APrPLERXFE,APrPLERYFE, ncol = 2)
ggsave("APrPLERE.jpg", plot = APrPLERE, width = 8, height = 6, dpi = 300)

IPrPLERE<-grid.arrange(IPrPLERXSE,IPrPLERXFE,IPrPLERYFE, ncol = 2)
ggsave("IPrPLERE.jpg", plot = IPrPLERE, width = 8, height = 6, dpi = 300)


```
#Alf PrPLER plots N (YS, YF)
```{r}
#YS
max(PrPLERYS$APrPLER)
APrPLERplotNYS <- ggplot() +
  geom_point(data = PrPLERYS, aes(x = N, y = APrPLER), color= "blue") +
  labs(x = "N-Rate (kg ha-1)", y = "Alfalfa PrPLER",
    color = "Harvest") +
  scale_x_continuous(breaks = c(0, 40, 80, 120, 160)) +
  ylim(0, 1) +
  geom_function(data=PrPLERYS, fun=~0.46*exp(-0.0028*.x),color='blue')+
  geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")+
  ggtitle("Year 2 Summer")
print(APrPLERplotNYS)

#YF
max(PrPLERYF$APrPLER)
APrPLERplotNYF <- ggplot() +
  geom_point(data = PrPLERYF, aes(x = N, y = APrPLER), color= "purple") +
  labs(x = "N-Rate (kg ha-1)", y = "Alfalfa PrPLER",
    color = "Harvest") +
  scale_x_continuous(breaks = c(0, 40, 80, 120, 160)) +
  ylim(0, 1) +
  geom_function(data=PrPLERYF, fun=~0.45*exp(-0.0031*.x),color='purple')+
  geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")+
  ggtitle("Year 2 Fall")
print(APrPLERplotNYF)

APrPLERNplot<-grid.arrange(APrPLERplotNYS,APrPLERplotNYF, ncol = 2)
ggsave("APrPLERNplot.jpg", plot = APrPLERNplot, width = 8, height = 6, dpi = 300)
```

#stacked bar graphs of PLER in TLER
```{r}
#get mean TLER and PLER aross reps for stacked bar graphs 
meanacrossrepsLER <- LERresultsNdSWALL_longNONA %>%
  group_by(P, YearCode, Harvest, NRATE, tot_or_part, PlotType) %>%
  reframe(meanLER = mean(LER, na.rm = TRUE))
meanacrossrepsPLER<-meanacrossrepsLER[meanacrossrepsLER$PlotType != "LERSW",]
meanacrossrepsPLER$NRATE<-as.factor(meanacrossrepsPLER$NRATE)

# Create the stacked bar plot XS 
meanacrossrepsLERX<-meanacrossrepsPLER[meanacrossrepsPLER$YearCode == "X",]
meanacrossrepsLERXS<-meanacrossrepsLERX[meanacrossrepsLERX$Harvest == "Summer",]
PrPLERXSplot<-ggplot(meanacrossrepsLERXS, aes(fill = PlotType, y = meanLER, x = NRATE)) +
  geom_bar(stat = "identity", position = "stack")+
  facet_wrap(~P, scales = "free",ncol=2)+
  labs(y = "LER", x= "N Rate")+
  scale_fill_discrete(name = "Crop", labels = c("Alfalfa", "IWG"))+
  scale_y_continuous(limits = c(0, 1.5))+
  ggtitle("Proportion of IWG and Alfalfa in TLER, Year 1 Summer")
ggsave("PrPLERXSplot.jpg", plot = PrPLERXSplot, width = 8, height = 6, dpi = 300)


# Create the stacked bar plot XF 
meanacrossrepsLERX<-meanacrossrepsPLER[meanacrossrepsPLER$YearCode == "X",]
meanacrossrepsLERXF<-meanacrossrepsLERX[meanacrossrepsLERX$Harvest == "Fall",]
PrPLERXFplot<-ggplot(meanacrossrepsLERXF, aes(fill = PlotType, y = meanLER, x = NRATE)) +
  geom_bar(stat = "identity", position = "stack")+
  facet_wrap(~P, scales = "free",ncol=2)+
  labs(y = "LER")+
  scale_fill_discrete(name = "Crop", labels = c("Alfalfa", "IWG"))+
   scale_y_continuous(limits = c(0, 4))+
  ggtitle("Proportion of IWG and Alfalfa in TLER, Year 1 Fall")
ggsave("PrPLERXFplot.jpg", plot = PrPLERXFplot, width = 8, height = 6, dpi = 300)

# Create the stacked bar plot YS 
meanacrossrepsLERY<-meanacrossrepsPLER[meanacrossrepsPLER$YearCode == "Y",]
meanacrossrepsLERYS<-meanacrossrepsLERY[meanacrossrepsLERY$Harvest == "Summer",]
PrPLERYSplot<-ggplot(meanacrossrepsLERYS, aes(fill = PlotType, y = meanLER, x = NRATE)) +
  geom_bar(stat = "identity", position = "stack")+
  facet_wrap(~P, scales = "free",ncol=2)+
  labs(y = "LER")+
  scale_fill_discrete(name = "Crop", labels = c("Alfalfa", "IWG"))+
   scale_y_continuous(limits = c(0, 2))+
  ggtitle("Proportion of IWG and Alfalfa in TLER, Year 2 Summer")
ggsave("PrPLERYSplot.jpg", plot = PrPLERYSplot, width = 8, height = 6, dpi = 300)

# Create the stacked bar plot YF 
meanacrossrepsLERY<-meanacrossrepsPLER[meanacrossrepsPLER$YearCode == "Y",]
meanacrossrepsLERYF<-meanacrossrepsLERY[meanacrossrepsLERY$Harvest == "Fall",]
PrPLERYFplot<-ggplot(meanacrossrepsLERYF, aes(fill = PlotType, y = meanLER, x = NRATE)) +
  geom_bar(stat = "identity", position = "stack")+
  facet_wrap(~P, scales = "free",ncol=2)+
  labs(y = "LER")+
  scale_fill_discrete(name = "Crop", labels = c("Alfalfa", "IWG"))+
   scale_y_continuous(limits = c(0, 4.5))+
  ggtitle("Proportion of IWG and Alfalfa in TLER, Year 2 Fall")
ggsave("PrPLERYFplot.jpg", plot = PrPLERYFplot, width = 8, height = 6, dpi = 300)

```

***
Grain PLER NEED TO UPDATE ALL OF THIS 

#GPLER year 1 math (missing NY rep 2 for some reason but i dont think I can be bothered... I THINK ITS BECAUSE YOU took out 208...)
```{r}
#0 
NdSW0GLER <- NdXSIG %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    PartialLERGSW0 = (G[Treatment == 10]) / (G[Treatment == 5])
  )
NdSW0GLER<-NdSW0GLER[NdSW0GLER$Harvest == "Summer",]
print(NdSW0GLER)

#40
NdSW40GLER <- NdXSIG %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    PartialLERGSW40 = (G[Treatment == 11]) / (G[Treatment == 6])
  )
NdSW40GLER<-NdSW40GLER[NdSW40GLER$Harvest == "Summer",]
print(NdSW40GLER)

#80
NdSW80GLER <- NdXSIG %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    PartialLERGSW80 = (G[Treatment == 12]) / (G[Treatment == 7])
  )
NdSW80GLER<-NdSW80GLER[NdSW80GLER$Harvest == "Summer",]
print(NdSW80GLER)

#120
NdSW120GLER <- NdXSIG %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    PartialLERGSW120 = (G[Treatment == 13]) / (G[Treatment == 8])
  )
NdSW120GLER<-NdSW120GLER[NdSW120GLER$Harvest == "Summer",]
print(NdSW120GLER)

#160
NdSW160GLER <- NdXSIG %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    PartialLERGSW160= (G[Treatment == 14]) / (G[Treatment == 9])
  )
NdSW160GLER<-NdSW160GLER[NdSW160GLER$Harvest == "Summer",]
print(NdSW160GLER)

#merge dataframes 
GLER1<-left_join(NdSW0GLER, NdSW40GLER, by = c("Rep", "P", "YearCode", "Harvest"))
print(GLER1)
GLER2<-left_join(GLER1, NdSW80GLER, by = c("Rep", "P", "YearCode", "Harvest"))
print(GLER2)
GLER3<-left_join(GLER2, NdSW120GLER, by = c("Rep", "P", "YearCode", "Harvest"))
print(GLER3)
GLER4<-left_join(GLER3, NdSW160GLER, by = c("Rep", "P", "YearCode", "Harvest"))
print(GLER4)

#rearrange dataframe 
GLER4 <- GLER4 %>%
  pivot_longer(cols = starts_with("PartialLER") | starts_with("TotalLER"),
               names_to = "Nrate",
               values_to = "LER")

#cut off total and partial 
GLER4$Type <- sub("^(Partial|Total)", "", GLER4$Nrate)
GLER4$tot_or_part <- sub("^(Partial|Total).*", "\\1", GLER4$Nrate)
print(GLER4)

#cut off LERIWGSW and LERAlfSW and LERSW
GLER4$NRATE <- sub("^(LERGSW|LERAlfSW|LERSW)", "", GLER4$Type)
GLER4$PlotType <- sub("^(LERGSW|LERAlfSW|LERSW).*", "\\1", GLER4$Type)
print(GLER4)
GLER4$N<-as.numeric(GLER4$NRATE)

#get rid of pesky NA results (caused by missing plots inherent in year 1 KS summer data)
GLERX<- na.omit(GLER4)
print(GLERX)
```

#Grain PLER year 1 model (use PLER to see if there is interaction between Cropping system and Nrate and yield)
```{r}
NdXSIG
GLERX$P<-as.factor(GLERX$P)
as.numeric(GLERX$N)
as.numeric(GLERX$LER)
#linear
modGPLERX<-lmer(LER~N*P + (1|Rep), data= GLERX)
anova(modGPLERX)
#check assumptions
GPLERX_resid<-resid(modGPLERX)
qqnorm(GPLERX_resid)
qqline(GPLERX_resid)
plot(modGPLERX)
#Logtransform
modGPLERX1<-lmer(log(LER)~N*P + (1|Rep), data=GLERX)
anova(modGPLERX1)
#check assumptions logtransform (makes BETTER!)
GPLERX_resid1<-resid(modGPLERX1)
qqnorm(GPLERX_resid1)
qqline(GPLERX_resid1)
plot(modGPLERX1)

#Comparison plots

# Boxplot for I Partial LER
ggplot(GLERX, aes(x = P, y = LER, fill = as.factor(N))) +
  geom_boxplot() +
  labs(title = "Year 1 Grain Partial LER by Location and N Rate", x = "Location", y = "Grain Partial LER")+
  geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")

max(GLERX$LER)
#plots
GLERX$predicted <- predict(modGPLERX1, newdata = GLERX, re.form = NA)
ggplot(GLERX, aes(x = N, y = LER)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Grain Partial LER (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between Year 1 Grain Partial LER and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(0, 7.1) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")+
  geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")#legend for colors

#TWO way emmeans
GPLERX1emm <- compute_emmeansNXS2("modGPLERX1")

#Pairwise comparison P 
emmsNGPLERP <- emmeans(modGPLERX1, specs= ~ P,  type= "response")
cld_dataNGPLERX1P <- cld(emmsNGPLERP, Letters=custom_letters)
cld_dataNGPLERX1P $response <- format(cld_dataNGPLERX1P $response, digits = 2)
cld_dataNGPLERX1P $lower.CL <- format(cld_dataNGPLERX1P $lower.CL, digits = 2)
cld_dataNGPLERX1P $upper.CL <- format(cld_dataNGPLERX1P $upper.CL, digits = 3)
rownames(cld_dataNGPLERX1P ) <- NULL
cld_dataNGPLERX1P<- cld_dataNGPLERX1P  %>%
  select( P, response,lower.CL, upper.CL, .group)
colnames(cld_dataNGPLERX1P ) <- c( "Site", "GPLER","l","h", "Group")
cld_dataNGPLERX1P  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

#Pairwise comparison N 
N_levels <- c(0, 40, 80, 120, 160)
emmsNGPLERN <- emmeans(modGPLERX1, specs= ~ N, at= list(N = N_levels), type= "response")
cld_dataNGPLERX1N <- cld(emmsNGPLERN, Letters=custom_letters)
cld_dataNGPLERX1N $response <- format(cld_dataNGPLERX1N $response, digits = 2)
cld_dataNGPLERX1N $lower.CL <- format(cld_dataNGPLERX1N $lower.CL, digits = 2)
cld_dataNGPLERX1N $upper.CL <- format(cld_dataNGPLERX1N $upper.CL, digits = 3)
rownames(cld_dataNGPLERX1N ) <- NULL
cld_dataNGPLERX1N <- cld_dataNGPLERX1N  %>%
  select( N, response,lower.CL, upper.CL, .group)
colnames(cld_dataNGPLERX1N ) <- c( "N", "APLER","l","h", "Group")
cld_dataNGPLERX1N  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

```

#GPLER year 2 math (why is rep 2 also missing from year 2? oh because adjusted is made from year 1 and 208 was missing from the beginning of all this analysis for year 1 etc etc etc... ugh. I'm not going to fix it unless it becomes a problem.)
```{r}
#0 
NdSW0GLERY <- DATA32 %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    PartialLERGSW0 = (GAdjY[Treatment == 10]) / (GAdjY[Treatment == 5])
  )

#40
NdSW40GLERY <- DATA32 %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    PartialLERGSW40 = (GAdjY[Treatment == 11]) / (GAdjY[Treatment == 6])
  )

#80
NdSW80GLERY <- DATA32 %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    PartialLERGSW80 = (GAdjY[Treatment == 12]) / (GAdjY[Treatment == 7])
  )

#120
NdSW120GLERY <- DATA32 %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    PartialLERGSW120 = (GAdjY[Treatment == 13]) / (GAdjY[Treatment == 8])
  )

#160
NdSW160GLERY <- DATA32 %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    PartialLERGSW160= (GAdjY[Treatment == 14]) / (GAdjY[Treatment == 9])
  )

#merge dataframes 
GLER1<-left_join(NdSW0GLERY, NdSW40GLERY, by = c("Rep", "P", "YearCode", "Harvest"))
print(GLER1)
GLER2<-left_join(GLER1, NdSW80GLERY, by = c("Rep", "P", "YearCode", "Harvest"))
print(GLER2)
GLER3<-left_join(GLER2, NdSW120GLERY, by = c("Rep", "P", "YearCode", "Harvest"))
print(GLER3)
GLER4<-left_join(GLER3, NdSW160GLERY, by = c("Rep", "P", "YearCode", "Harvest"))
print(GLER4)

#rearrange dataframe 
GLER4 <- GLER4 %>%
  pivot_longer(cols = starts_with("PartialLER") | starts_with("TotalLER"),
               names_to = "Nrate",
               values_to = "LER")

#cut off total and partial 
GLER4$Type <- sub("^(Partial|Total)", "", GLER4$Nrate)
GLER4$tot_or_part <- sub("^(Partial|Total).*", "\\1", GLER4$Nrate)
print(GLER4)

#cut off LERIWGSW and LERAlfSW and LERSW
GLER4$NRATE <- sub("^(LERGSW|LERAlfSW|LERSW)", "", GLER4$Type)
GLER4$PlotType <- sub("^(LERGSW|LERAlfSW|LERSW).*", "\\1", GLER4$Type)
print(GLER4)
GLER4$N<-as.numeric(GLER4$NRATE)

#get rid of pesky NA results (caused by missing plots inherent in year 1 KS summer data)
GLERY<- na.omit(GLER4)
print(GLERY)
```

#Grain PLER year 2 model 
```{r}
GLERY$P<-as.factor(GLERY$P)
as.numeric(GLERY$N)
as.numeric(GLERY$LER)
#linear
modGPLERY<-lmer(LER~N*P + (1|Rep), data= GLERY)
anova(modGPLERY)
#check assumptions
GPLERY_resid<-resid(modGPLERY)
qqnorm(GPLERY_resid)
qqline(GPLERY_resid)
plot(modGPLERY)
#Logtransform
modGPLERY1<-lmer(log(LER)~N*P + (1|Rep), data=GLERY)
anova(modGPLERY1)
#check assumptions logtransform (makes BETTER!)
GPLERY_resid1<-resid(modGPLERY1)
qqnorm(GPLERY_resid1)
qqline(GPLERY_resid1)
plot(modGPLERY1)

#Comparison plots

# Boxplot for I Partial LER
ggplot(GLERY, aes(x = P, y = LER, fill = as.factor(N))) +
  geom_boxplot() +
  labs(title = "Year 2 Grain Partial LER by Location and N Rate", x = "Location", y = "Grain Partial LER")

max(GLERY$LER)
#plots
GLERY$predicted <- predict(modGPLERY1, newdata = GLERY, re.form = NA)
ggplot(GLERY, aes(x = N, y = LER)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Grain Partial LER (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between year 2 Grain Partial LER and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(0, 7.1) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")+
  geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")#legend for colors

#Pairwise P
emmsP <- emmeans(modGPLERY1, specs = ~ P, type = "response")
cld_dataNGPLERYP <- cld(emmsP) # Create compact letter display
cld_dataNGPLERYP $response <- format(cld_dataNGPLERYP $response, digits = 2)
cld_dataNGPLERYP $lower.CL <- format(cld_dataNGPLERYP $lower.CL, digits = 2)
cld_dataNGPLERYP $upper.CL <- format(cld_dataNGPLERYP $upper.CL, digits = 3)
rownames(cld_dataNGPLERYP ) <- NULL
cld_dataNGPLERYP <- cld_dataNGPLERYP  %>%
  select( P, response,lower.CL, upper.CL, .group)
colnames(cld_dataNGPLERYP ) <- c( "Site", "APLER","l","h", "Group")
cld_dataNGPLERYP  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise comparison N 
N_levels <- c(0, 40, 80, 120, 160)
emmsNGPLERN <- emmeans(modGPLERY1, specs= ~ N, at= list(N = N_levels), type= "response")
cld_dataNGPLERY1N <- cld(emmsNGPLERN, Letters=custom_letters)
cld_dataNGPLERY1N $response <- format(cld_dataNGPLERY1N $response, digits = 2)
cld_dataNGPLERY1N $lower.CL <- format(cld_dataNGPLERY1N $lower.CL, digits = 2)
cld_dataNGPLERY1N $upper.CL <- format(cld_dataNGPLERY1N $upper.CL, digits = 3)
rownames(cld_dataNGPLERY1N ) <- NULL
cld_dataNGPLERY1N <- cld_dataNGPLERY1N  %>%
  select( N, response,lower.CL, upper.CL, .group)
colnames(cld_dataNGPLERY1N ) <- c( "N", "APLER","l","h", "Group")
cld_dataNGPLERY1N  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
```

#Grain PLER combo plot
```{r}
# Layer all the plots together!
colors <- c("Year 1 Summer Harvest" = "red", 
            "Year 1 Fall Harvest" = "green", 
            "Year 2 Summer Harvest" = "blue", 
            "Year 2 Fall Harvest" = "purple")
legend_order2 <- c("Year 1 Summer Harvest", 
                  "Year 2 Summer Harvest")
GLERX$P <- factor(GLERX$P, levels = desired_order)
max(GLERX$LER)
max(GLERY$LER)
GPLERcomboplot <- ggplot() +
  geom_line(data = GLERX, aes(N, exp(predicted), color = "Year 1 Summer Harvest")) +
  geom_point(data =GLERX, aes(x = N, y = LER, color = "Year 1 Summer Harvest")) +
  geom_line(data = GLERY, aes(N, exp(predicted), color = "Year 2 Summer Harvest")) +
  geom_point(data = GLERY, aes(x = N, y = LER, color = "Year 2 Summer Harvest")) +
  labs(x = "N-Rate (kg ha-1)", y = "Grain PLER",
    color = "Harvest", 
    linetype = "Cropping System", shape = "Cropping System") +
  ggtitle("Relationship Between Grain PLER and N-rate") +
  scale_x_continuous(breaks = c(0, 40, 80, 120, 160)) +
  ylim(0, 7.1) +
  facet_wrap(~P, scales = "free", ncol = 2) +
  scale_color_manual(values = colors, limits = legend_order2)+
  scale_shape_manual(values = c(4, 20))+
  geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")


print(GPLERcomboplot)

ggsave("GPLERcomboplot.jpg", plot = GPLERcomboplot, width = 8, height = 6, dpi = 300)
```
***
Nrate Relative yield stuff

#GPLER E plot (Y)
```{r}
NGLERYemmsP <- emmeans(modGPLERY1, ~ P, type = "response") 
emms_df <- as.data.frame(NGLERYemmsP)
cld_dataNGLERYP <- cld(NGLERYemmsP, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataNGLERYP)
merged_df <- merge(emms_df, cld_df,by = c("P"))
GLERE<-ggplot(GLERY, aes(x = P, y = exp(predicted))) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7, color="darkgreen") +
  labs(x = "Environment", y = "Grain PLER") +
  geom_point(data = emms_df, aes(x = P, y = response), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 1.8)

print(GLERE)
ggsave("GLERE.jpg", plot = GLERE, width = 8, height = 6, dpi = 300)
```

#Grain year 1 relative yields
```{r}
#0
NGRY0 <- NdXSIG %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    GRelativeYield0 = (G[Treatment == 10]) / (G[Treatment == 5]))
#40
NGRY40 <- NdXSIG %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    GRelativeYield40 = (G[Treatment == 10]) / (G[Treatment == 6]))
#80
NGRY80 <- NdXSIG %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    GRelativeYield80 = (G[Treatment == 10]) / (G[Treatment == 7]))
#120
NGRY120 <- NdXSIG %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    GRelativeYield120 = (G[Treatment == 10]) / (G[Treatment == 8]))
#160
NGRY160 <- NdXSIG %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    GRelativeYield160 = (G[Treatment == 10]) / (G[Treatment == 9]))
#Join together all the tables
NGRY<-left_join(NGRY0, NGRY40, by = c("Rep", "P", "YearCode", "Harvest"))
NGRY<-left_join(NGRY, NGRY80, by = c("Rep", "P", "YearCode", "Harvest"))
NGRY<-left_join(NGRY, NGRY120, by = c("Rep", "P", "YearCode", "Harvest"))
NGRY<-left_join(NGRY, NGRY160, by = c("Rep", "P", "YearCode", "Harvest"))
print(NGRY)

# Reshape the data from wide to long format
NGRY_long <- NGRY %>%
  pivot_longer(cols = starts_with("GRelativeYield"),
               names_to = "N_rate",
               values_to = "GRelativeYield") %>%
  separate(N_rate, into = c("N_rate", "N"), sep = "GRelativeYield") %>%
  mutate(N = as.numeric(N))

#models 
#year 1 grain RY
modGRYX<-lmer(GRelativeYield~N*P + (1|Rep), data=NGRY_long)
anova(modGRYX)
#check assumptions 
GRYX_resid<-resid(modGRYX)
qqnorm(GRYX_resid)
qqline(GRYX_resid)
plot(modGRYX)
#Logtransform
modGRYX1<-lmer(log(GRelativeYield)~N*P + (1|Rep), data=NGRY_long)
anova(modGRYX1)
#check LOG assumptions 
GRYX_resid1<-resid(modGRYX1)
qqnorm(GRYX_resid1)
qqline(GRYX_resid1)
plot(modGRYX1)

# Create box plots: 
# Define the order of factor levels and Convert N to a factor with specified levels
factor_levels <- c("0", "40", "80", "120", "160")
NGRY_long$N <- factor(NGRY_long$N, levels = factor_levels)
NGRY_long$P <- factor(NGRY_long$P, levels = desired_order)
GRYXcomboplot<-ggplot(NGRY_long, aes(x = N, y = GRelativeYield)) +
  geom_boxplot() +
  facet_wrap(~P, scales = "free_y",ncol=2) +
  labs(x = "N Rate", y = "Relative Yield") +
  theme_minimal()+
  scale_x_discrete(breaks = c(0, 40, 80, 120, 160))+
  geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")+
  ggtitle("Year 1 Grain Relative Yield")+
    coord_cartesian(ylim = c(NA, NA))
ggsave("GRYXcomboplot.jpg", plot = GRYXcomboplot, width = 8, height = 6, dpi = 300)

#Pairwise comparisons
#Pairwise N
N_levels <- c(0, 40, 80, 120, 160)
emmsN <- emmeans(modGRYX1, specs = ~ N, at = list(N = N_levels), type = "response")
cld_dataGRYXN <- cld(emmsN) # Create compact letter display
cld_dataGRYXN  $response <- format(cld_dataGRYXN  $response, digits = 3)
cld_dataGRYXN $lower.CL <- format(cld_dataGRYXN $lower.CL, digits = 3)
cld_dataGRYXN $upper.CL <- format(cld_dataGRYXN $upper.CL, digits = 3)
rownames(cld_dataGRYXN  ) <- NULL
cld_dataGRYXN  <- cld_dataGRYXN   %>%
  select( N, response, lower.CL, upper.CL, .group)
colnames(cld_dataGRYXN  ) <- c( "N", "TLER","l","h", "Group")
cld_dataGRYXN    |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise P
emmsP <- emmeans(modGRYX1, specs = ~ P, type = "response")
cld_dataGRYXP <- cld(emmsP) # Create compact letter display
cld_dataGRYXP  $response <- format(cld_dataGRYXP  $response, digits = 3)
cld_dataGRYXP $lower.CL <- format(cld_dataGRYXP $lower.CL, digits = 3)
cld_dataGRYXP $upper.CL <- format(cld_dataGRYXP $upper.CL, digits = 3)
rownames(cld_dataGRYXP  ) <- NULL
cld_dataGRYXP  <- cld_dataGRYXP   %>%
  select( P, response, lower.CL, upper.CL, .group)
colnames(cld_dataGRYXP  ) <- c( "Site", "GRY","l","h", "Group")
cld_dataGRYXP    |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
```

#Grain year 2 relative yields
```{r}
#0
NYGRY0 <- DATA32 %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    GRelativeYield0 = (GAdjY[Treatment == 10]) / (GAdjY[Treatment == 5]))
#40
NYGRY40 <- DATA32 %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    GRelativeYield40 = (GAdjY[Treatment == 10]) / (GAdjY[Treatment == 6]))
#80
NYGRY80 <- DATA32 %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    GRelativeYield80 = (GAdjY[Treatment == 10]) / (GAdjY[Treatment == 7]))
#120
NYGRY120 <- DATA32 %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    GRelativeYield120 = (GAdjY[Treatment == 10]) / (GAdjY[Treatment == 8]))
#160
NYGRY160 <- DATA32 %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    GRelativeYield160 = (GAdjY[Treatment == 10]) / (GAdjY[Treatment == 9]))
#Join together all the tables
NYGRY<-left_join(NYGRY0, NYGRY40, by = c("Rep", "P", "YearCode", "Harvest"))
NYGRY<-left_join(NYGRY, NYGRY80, by = c("Rep", "P", "YearCode", "Harvest"))
NYGRY<-left_join(NYGRY, NYGRY120, by = c("Rep", "P", "YearCode", "Harvest"))
NYGRY<-left_join(NYGRY, NYGRY160, by = c("Rep", "P", "YearCode", "Harvest"))
print(NYGRY)

# Reshape the data from wide to long format
NGRY_longY <- NYGRY %>%
  pivot_longer(cols = starts_with("GRelativeYield"),
               names_to = "N_rate",
               values_to = "GRelativeYield") %>%
  separate(N_rate, into = c("N_rate", "N"), sep = "GRelativeYield") %>%
  mutate(N = as.numeric(N))

#models 
#year 1 grain RY
modGRYY<-lmer(GRelativeYield~N*P + (1|Rep), data=NGRY_longY)
anova(modGRYY)
#check assumptions 
GRYY_resid<-resid(modGRYY)
qqnorm(GRYY_resid)
qqline(GRYY_resid)
plot(modGRYY)
#Logtransform
modGRYY1<-lmer(log(GRelativeYield)~N*P + (1|Rep), data=NGRY_longY)
anova(modGRYY1)
#check LOG assumptions 
GRYY_resid1<-resid(modGRYY1)
qqnorm(GRYY_resid1)
qqline(GRYY_resid1)
plot(modGRYY1)

# Create box plots: 
# Define the order of factor levels and Convert N to a factor with specified levels
factor_levels <- c("0", "40", "80", "120", "160")
NGRY_longY$N <- factor(NGRY_longY$N, levels = factor_levels)
NGRY_longY$P<-factor(NGRY_longY$P, levels = desired_order)
GRYYcomboplot<-ggplot(NGRY_longY, aes(x = N, y = GRelativeYield)) +
  geom_boxplot() +
  facet_wrap(~P, scales = "free",ncol=2) +
  labs(x = "N Rate", y = "Relative Yield") +
  theme_minimal()+
  scale_x_discrete(breaks = c(0, 40, 80, 120, 160))+
  geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")+
  ggtitle("Year 2 Grain Relative Yield")+
    coord_cartesian(ylim = c(NA, NA))

ggsave("GRYYcomboplot.jpg", plot = GRYYcomboplot, width = 8, height = 6, dpi = 300)

#Pairwise comparisons
#Pairwise N
N_levels <- c(0, 40, 80, 120, 160)
emmsN <- emmeans(modGRYY1, specs = ~ N, at = list(N = N_levels), type = "response")
cld_dataGRYYN <- cld(emmsN, Letters=custom_letters) # Create compact letter display
cld_dataGRYYN  $response <- format(cld_dataGRYYN  $response, digits = 3)
cld_dataGRYYN $lower.CL <- format(cld_dataGRYYN $lower.CL, digits = 3)
cld_dataGRYYN $upper.CL <- format(cld_dataGRYYN $upper.CL, digits = 3)
rownames(cld_dataGRYYN  ) <- NULL
cld_dataGRYYN  <- cld_dataGRYYN   %>%
  select( N, response, lower.CL, upper.CL, .group)
colnames(cld_dataGRYYN  ) <- c( "N", "TLER","l","h", "Group")
cld_dataGRYYN    |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise N:P
emmsNP <- emmeans(modGRYY1, specs = ~ N:P, at = list(N = N_levels), type = "response")
cld_dataGRYYNP <- cld(emmsNP, Letters=custom_letters) # Create compact letter display
cld_dataGRYYNP  $response <- format(cld_dataGRYYNP  $response, digits = 3)
cld_dataGRYYNP $lower.CL <- format(cld_dataGRYYNP $lower.CL, digits = 3)
cld_dataGRYYNP $upper.CL <- format(cld_dataGRYYNP $upper.CL, digits = 3)
rownames(cld_dataGRYYNP  ) <- NULL
cld_dataGRYYNP  <- cld_dataGRYYNP   %>%
  select( N, P, response, lower.CL, upper.CL, .group)
colnames(cld_dataGRYYNP  ) <- c( "N", "Site", "TLER","l","h", "Group")
cld_dataGRYYNP    |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
```

#combo GRY boxplot 
```{r}
# Combine the data frames and create a new column to distinguish the years
NGRY_longY$Year <- "Year 2"
NGRY_long$Year <- "Year 1"
combined_data <- rbind(NGRY_longY, NGRY_long)

colors3<-c("Year 1" = "red", 
            "Year 2" = "blue")
# Convert N to a factor for proper ordering on the x-axis
combined_data$N <- factor(combined_data$N, levels = c("0", "40", "80", "120", "160"))

# Plotting both boxplots together with dodge positioning
GRYcomboplot <- ggplot(combined_data, aes(x = N, y = GRelativeYield, fill = Year)) +
  geom_boxplot(position = position_dodge(width = 0.75)) +
  labs(x = "N Rate", y = "Relative Yield") +
  scale_x_discrete(breaks = c("0", "40", "80", "120", "160")) +
  geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed") +
  ggtitle("Grain Relative Yield") +
  scale_fill_manual(values = colors3)+
  theme_minimal()+
  facet_wrap(~P, scales = "free", ncol = 2)

# Display the combined plot
print(GRYcomboplot)

ggsave("GRYcomboplot .jpg", plot = GRYcomboplot , width = 8, height = 6, dpi = 300)
```

#Total forage compared to IWG monoculture XS XF YS YF relative yields 
```{r}
#0
NTFIRY0 <- Nd %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    TFIRelativeYield0 = (PlotTotForageKgHa[Treatment == 10]) / (PlotTotForageKgHa[Treatment == 5]))
#40
NTFIRY40 <- Nd %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    TFIRelativeYield40 = (PlotTotForageKgHa[Treatment == 10]) / (PlotTotForageKgHa[Treatment == 6]))
#80
NTFIRY80 <- Nd %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    TFIRelativeYield80 = (PlotTotForageKgHa[Treatment == 10]) / (PlotTotForageKgHa[Treatment == 7]))
#120
NTFIRY120 <- Nd %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    TFIRelativeYield120 = (PlotTotForageKgHa[Treatment == 10]) / (PlotTotForageKgHa[Treatment == 8]))
#160
NTFIRY160 <- Nd %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    TFIRelativeYield160 = (PlotTotForageKgHa[Treatment == 10]) / (PlotTotForageKgHa[Treatment == 9]))
#Join together all the tables
NTFIRY<-left_join(NTFIRY0, NTFIRY40, by = c("Rep", "P", "YearCode", "Harvest"))
NTFIRY<-left_join(NTFIRY, NTFIRY80, by = c("Rep", "P", "YearCode", "Harvest"))
NTFIRY<-left_join(NTFIRY, NTFIRY120, by = c("Rep", "P", "YearCode", "Harvest"))
NTFIRY<-left_join(NTFIRY, NTFIRY160, by = c("Rep", "P", "YearCode", "Harvest"))
print(NTFIRY)
#boxplots
# Reshape the data from wide to long format
NTFIRY_long <- NTFIRY %>%
  pivot_longer(cols = starts_with("TFIRelativeYield"),
               names_to = "N_rate",
               values_to = "TFIRelativeYield") %>%
  separate(N_rate, into = c("N_rate", "N"), sep = "TFIRelativeYield") %>%
  mutate(N = as.numeric(N))
#split apart by year-harvest 
NTFIRYX<-NTFIRY_long[NTFIRY_long$YearCode== "X",]
NTFIRYY<-NTFIRY_long[NTFIRY_long$YearCode== "Y",]
NTFIRYXS<-NTFIRYX[NTFIRYX$Harvest== "Summer",]
NTFIRYXF<-NTFIRYX[NTFIRYX$Harvest== "Fall",]
NTFIRYYS<-NTFIRYY[NTFIRYY$Harvest== "Summer",]
NTFIRYYF<-NTFIRYY[NTFIRYY$Harvest== "Fall",]

class(NTFIRYXS$N)
#models 
#year 1 summer TFI RY
{
modTFIRYXS<-lmer(TFIRelativeYield~N*P + (1|Rep), data=NTFIRYXS)
anova(modTFIRYXS)
#check assumptions 
TFIRYXS_resid<-resid(modTFIRYXS)
qqnorm(TFIRYXS_resid)
qqline(TFIRYXS_resid)
plot(modTFIRYXS)
#Logtransform
modTFIRYXS1<-lmer(log(TFIRelativeYield)~N*P + (1|Rep), data=NTFIRYXS)
anova(modTFIRYXS1)
#check LOG assumptions 
TFIRYXS_resid1<-resid(modTFIRYXS1)
qqnorm(TFIRYXS_resid1)
qqline(TFIRYXS_resid1)
plot(modTFIRYXS1)}
class(NTFIRYXS$N)
#Pairwise N:P
N_levels <- c(0, 40, 80, 120, 160)
emmsNP <- emmeans(modTFIRYXS1, specs = ~ N*P, at = list(N = N_levels), type = "response")
cld_dataNTFIRYXSNP <- cld(emmsNP, Letters=custom_letters) # Create compact letter display
cld_dataNTFIRYXSNP  $response <- format(cld_dataNTFIRYXSNP  $response, digits = 3)
cld_dataNTFIRYXSNP $lower.CL <- format(cld_dataNTFIRYXSNP $lower.CL, digits = 3)
cld_dataNTFIRYXSNP $upper.CL <- format(cld_dataNTFIRYXSNP $upper.CL, digits = 3)
rownames(cld_dataNTFIRYXSNP  ) <- NULL
cld_dataNTFIRYXSNP  <- cld_dataNTFIRYXSNP   %>%
  select( N, P, response, lower.CL, upper.CL, .group)
colnames(cld_dataNTFIRYXSNP  ) <- c( "N", "Site", "TIFRY","l","h", "Group")
cld_dataNTFIRYXSNP    |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

#year 1 Fall TFI RY
{modTFIRYXF<-lmer(TFIRelativeYield~N*P + (1|Rep), data=NTFIRYXF)
anova(modTFIRYXF)
#check assumptions 
TFIRYXF_resid<-resid(modTFIRYXF)
qqnorm(TFIRYXF_resid)
qqline(TFIRYXF_resid)
plot(modTFIRYXF)
#Logtransform
modTFIRYXF1<-lmer(log(TFIRelativeYield)~N*P + (1|Rep), data=NTFIRYXF)
anova(modTFIRYXF1)
NTFIRYXF$N<-as.numeric(NTFIRYXF$N)
modTFIRYXF1<-lmer(log(TFIRelativeYield)~N*P + (1|Rep), data=NTFIRYXF)
anova(modTFIRYXF1)
#check LOG assumptions 
TFIRYXF_resid1<-resid(modTFIRYXF1)
qqnorm(TFIRYXF_resid1)
qqline(TFIRYXF_resid1)
plot(modTFIRYXF1)}
#Pairwise N
N_levels <- c(0, 40, 80, 120, 160)
emmsN <- emmeans(modTFIRYXF1, specs = ~ N, at = list(N = N_levels), type = "response")
cld_dataNTFIRYXFN <- cld(emmsN, Letters=custom_letters) # Create compact letter display
cld_dataNTFIRYXFN  $response <- format(cld_dataNTFIRYXFN  $response, digits = 3)
cld_dataNTFIRYXFN $lower.CL <- format(cld_dataNTFIRYXFN $lower.CL, digits = 3)
cld_dataNTFIRYXFN $upper.CL <- format(cld_dataNTFIRYXFN $upper.CL, digits = 3)
rownames(cld_dataNTFIRYXFN  ) <- NULL
cld_dataNTFIRYXFN  <- cld_dataNTFIRYXFN   %>%
  select( N, response, lower.CL, upper.CL, .group)
colnames(cld_dataNTFIRYXFN  ) <- c( "N", "TIFRY","l","h", "Group")
cld_dataNTFIRYXFN    |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise P
emmsP <- emmeans(modTFIRYXF1, specs = ~ P, type = "response")
cld_dataNTFIRYXFP <- cld(emmsP, Letters=custom_letters) # Create compact letter display
cld_dataNTFIRYXFP   $response <- format(cld_dataNTFIRYXFP   $response, digits = 3)
cld_dataNTFIRYXFP  $lower.CL <- format(cld_dataNTFIRYXFP  $lower.CL, digits = 3)
cld_dataNTFIRYXFP  $upper.CL <- format(cld_dataNTFIRYXFP  $upper.CL, digits = 3)
rownames(cld_dataNTFIRYXFP   ) <- NULL
cld_dataNTFIRYXFP   <- cld_dataNTFIRYXFP    %>%
  select( P, response, lower.CL, upper.CL, .group)
colnames(cld_dataNTFIRYXFP   ) <- c( "Site", "TIFRY","l","h", "Group")
cld_dataNTFIRYXFP     |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

#year 2 summer TFI RY
{modTFIRYYS<-lmer(TFIRelativeYield~N*P + (1|Rep), data=NTFIRYYS)
anova(modTFIRYYS)
#check assumptions 
TFIRYYS_resid<-resid(modTFIRYYS)
qqnorm(TFIRYYS_resid)
qqline(TFIRYYS_resid)
plot(modTFIRYYS)
#Logtransform
modTFIRYYS1<-lmer(log(TFIRelativeYield)~N*P + (1|Rep), data=NTFIRYYS)
anova(modTFIRYYS1)
#check LOG assumptions 
TFIRYYS_resid1<-resid(modTFIRYYS1)
qqnorm(TFIRYYS_resid1)
qqline(TFIRYYS_resid1)
plot(modTFIRYYS1)}
#Pairwise N:P
N_levels <- c(0, 40, 80, 120, 160)
emmsNP <- emmeans(modTFIRYYS1, specs = ~ N*P, at = list(N = N_levels), type = "response")
cld_dataNTFIRYYSNP <- cld(emmsNP, Letters=custom_letters) # Create compact letter display
cld_dataNTFIRYYSNP  $response <- format(cld_dataNTFIRYYSNP  $response, digits = 3)
cld_dataNTFIRYYSNP $lower.CL <- format(cld_dataNTFIRYYSNP $lower.CL, digits = 3)
cld_dataNTFIRYYSNP $upper.CL <- format(cld_dataNTFIRYYSNP $upper.CL, digits = 3)
rownames(cld_dataNTFIRYYSNP  ) <- NULL
cld_dataNTFIRYYSNP  <- cld_dataNTFIRYYSNP   %>%
  select( N, P, response, lower.CL, upper.CL, .group)
colnames(cld_dataNTFIRYYSNP  ) <- c( "N", "Site", "TIFRY","l","h", "Group")
cld_dataNTFIRYYSNP    |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

#year 2 Fall TFI RY
{modTFIRYYF<-lmer(TFIRelativeYield~N*P + (1|Rep), data=NTFIRYYF)
anova(modTFIRYYF)
#check assumptions 
TFIRYYF_resid<-resid(modTFIRYYF)
qqnorm(TFIRYYF_resid)
qqline(TFIRYYF_resid)
plot(modTFIRYYF)
#Logtransform
modTFIRYYF1<-lmer(log(TFIRelativeYield)~N*P + (1|Rep), data=NTFIRYYF)
anova(modTFIRYYF1)
#check LOG assumptions 
TFIRYYF_resid1<-resid(modTFIRYYF1)
qqnorm(TFIRYYF_resid1)
qqline(TFIRYYF_resid1)
plot(modTFIRYYF1)}
#Pairwise P
emmsP <- emmeans(modTFIRYYF1, ~ P, type = "response") # Obtain estimated marginal means
cld_dataTFIRYYFP <- cld(emmsP, Letters=custom_letters) # Create compact letter display
cld_dataTFIRYYFP  $response <- format(cld_dataTFIRYYFP  $response, digits = 3)
cld_dataTFIRYYFP $lower.CL <- format(cld_dataTFIRYYFP $lower.CL, digits = 3)
cld_dataTFIRYYFP $upper.CL <- format(cld_dataTFIRYYFP $upper.CL, digits = 3)
rownames(cld_dataTFIRYYFP  ) <- NULL
cld_dataTFIRYYFP  <- cld_dataTFIRYYFP   %>%
  select( P, response, lower.CL, upper.CL, .group)
colnames(cld_dataTFIRYYFP  ) <- c( "Site", "TIFRY","l","h", "Group")
cld_dataTFIRYYFP    |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)


# Create box plots: 
# Define the order of factor levels and Convert N to a factor with specified levels
factor_levels <- c("0", "40", "80", "120", "160")
NTFIRYXS$N <- factor(NTFIRYXS$N, levels = factor_levels)
NTFIRYYS$N <- factor(NTFIRYYS$N, levels = factor_levels)
NTFIRYXF$N <- factor(NTFIRYXF$N, levels = factor_levels)
NTFIRYYF$N <- factor(NTFIRYYF$N, levels = factor_levels)
#year 1 summer 
ggplot(NTFIRYXS, aes(x = N, y = TFIRelativeYield)) +
  geom_boxplot() +
  facet_wrap(~P, scales = "free_y",ncol=2) +
  labs(x = "N Rate", y = "Relative Yield") +
  theme_minimal()+
   scale_x_discrete(breaks = c(0, 40, 80, 120, 160))+
    geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")+
  ggtitle("Year 1 Summer Total Forage Yield Relative to IWG monoculture")+
  ylim(0.25, 2.75) 
#year 1 fall 
ggplot(NTFIRYXF, aes(x = N, y = TFIRelativeYield)) +
  geom_boxplot() +
  facet_wrap(~P, scales = "free_y",ncol=2) +
  labs(x = "N Rate", y = "Relative Yield") +
  theme_minimal()+
   scale_x_discrete(breaks = c(0, 40, 80, 120, 160))+
    geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")+
    ggtitle("Year 1 Fall Total Forage Yield Relative to IWG monoculture")+
  ylim(0.5, NA)
#year 2 summer 
ggplot(NTFIRYYS, aes(x = N, y = TFIRelativeYield)) +
  geom_boxplot() +
  facet_wrap(~P, scales = "free_y",ncol=2) +
  labs(x = "N Rate", y = "Relative Yield") +
  theme_minimal()+
   scale_x_discrete(breaks = c(0, 40, 80, 120, 160))+
    geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")+
    ggtitle("Year 2 Summer Total Forage Yield Relative to IWG monoculture")+
  ylim(0.5, NA)
#year 2 Fall 
ggplot(NTFIRYYF, aes(x = N, y = TFIRelativeYield)) +
  geom_boxplot() +
  facet_wrap(~P, scales = "free_y",ncol=2) +
  labs(x = "N Rate", y = "Relative Yield") +
  theme_minimal()+
   scale_x_discrete(breaks = c(0, 40, 80, 120, 160))+
    geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")+
    ggtitle("Year 2 Fall Total Forage Yield Relative to IWG monoculture")+
  ylim(0.5, NA)
```
#TFIRY combo boxplots summer and fall 
```{r}
# Combine the data frames and create a new column to distinguish the years
NTFIRYXS$Year<-"Year 1 Summer"
NTFIRYXF$Year<-"Year 1 Fall"
NTFIRYYS$Year<-"Year 2 Summer"
NTFIRYYF$Year<-"Year 2 Fall"

combined_dataTFIRY <- rbind(NTFIRYXS, NTFIRYXF,NTFIRYYS,NTFIRYYF)

colors2 <- c("Year 1 Summer" = "red", 
            "Year 1 Fall" = "green", 
            "Year 2 Summer" = "blue", 
            "Year 2 Fall" = "purple")
legend_order3 <- c("Year 1 Summer", "Year 1 Fall", 
                  "Year 2 Summer", "Year 2 Fall")
combined_dataTFIRY$P <- factor(combined_dataTFIRY$P, levels = desired_order)

# Convert N to a factor for proper ordering on the x-axis
combined_dataTFIRY $N <- factor(combined_dataTFIRY $N, levels = c("0", "40", "80", "120", "160"))

# Plotting both boxplots together with dodge positioning
TFIRYcomboplot <- ggplot(combined_dataTFIRY, aes(x = N, y = TFIRelativeYield, fill = Year)) +
  geom_boxplot(position = position_dodge(width = 0.75)) +
  labs(x = "N Rate", y = "Relative Yield") +
  scale_x_discrete(breaks = c("0", "40", "80", "120", "160")) +
  geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed") +
  ggtitle("Grain Relative Yield") +
  coord_cartesian(ylim = c(NA, NA)) +
  scale_fill_manual(values = colors2, limits = legend_order3)+
  facet_wrap(~P, scales = "free", ncol = 2)

# Display the combined plot
print(TFIRYcomboplot)

ggsave("TFIRYcomboplot .jpg", plot = TFIRYcomboplot , width = 8, height = 6, dpi = 300)
```
#TFIRY combo boxplots summer 
```{r}
# Combine the data frames and create a new column to distinguish the years
NTFIRYXS$Year<-"Year 1 Summer"
NTFIRYYS$Year<-"Year 2 Summer"

combined_dataTFIRYS <- rbind(NTFIRYXS,NTFIRYYS)

colors3 <- c("Year 1 Summer" = "red",
            "Year 2 Summer" = "blue")
legend_order4 <- c("Year 1 Summer", 
                  "Year 2 Summer")
combined_dataTFIRYS$P <- factor(combined_dataTFIRYS$P, levels = desired_order)

# Convert N to a factor for proper ordering on the x-axis
combined_dataTFIRYS$N <- factor(combined_dataTFIRYS$N, levels = c("0", "40", "80", "120", "160"))

# Plotting both boxplots together with dodge positioning
max(combined_dataTFIRYS$TFIRelativeYield)
TFIRYcomboplotS <- ggplot(combined_dataTFIRYS, aes(x = N, y = TFIRelativeYield, fill = Year)) +
  geom_boxplot(position = position_dodge(width = 0.75)) +
  labs(x = "N Rate", y = "Relative Yield") +
  scale_x_discrete(breaks = c("0", "40", "80", "120", "160")) +
  geom_abline(intercept = 1, slope = 0, color = "red", linetype = "dashed") +
  ggtitle("Total Forage: IWG monoculture Relative Yield, Summer") +
  coord_cartesian(ylim = c(NA, NA)) +
  scale_fill_manual(values = colors3, limits = legend_order4)+
  facet_wrap(~P, scales = "free", ncol = 2)+
  ylim(0.25,2.7)


# Display the combined plot
print(TFIRYcomboplotS)

ggsave("TFIRYcomboplotS .jpg", plot = TFIRYcomboplotS , width = 8, height = 6, dpi = 300)
```
#TFIRY combo boxplots fall
```{r}
# Combine the data frames and create a new column to distinguish the years
NTFIRYXF$Year<-"Year 1 Fall"
NTFIRYYF$Year<-"Year 2 Fall"

combined_dataTFIRYF <- rbind(NTFIRYXF,NTFIRYYF)

colors4 <- c("Year 1 Fall" = "green",
            "Year 2 Fall" = "purple")
legend_order5 <- c("Year 1 Fall", 
                  "Year 2 Fall")
combined_dataTFIRYF$P <- factor(combined_dataTFIRYF$P, levels = desired_order)

# Convert N to a factor for proper ordering on the x-axis
combined_dataTFIRYF$N <- factor(combined_dataTFIRYF$N, levels = c("0", "40", "80", "120", "160"))

# Plotting both boxplots together with dodge positioning
max(combined_dataTFIRYF$TFIRelativeYield)
TFIRYcomboplotF <- ggplot(combined_dataTFIRYF, aes(x = N, y = TFIRelativeYield, fill = Year)) +
  geom_boxplot(position = position_dodge(width = 0.75)) +
  labs(x = "N Rate", y = "Relative Yield") +
  scale_x_discrete(breaks = c("0", "40", "80", "120", "160")) +
  geom_abline(intercept = 1, slope = 0, color = "red", linetype = "dashed") +
  ggtitle("Total Forage: IWG monoculture Relative Yield, Fall") +
  coord_cartesian(ylim = c(NA, NA)) +
  scale_fill_manual(values = colors4, limits = legend_order5)+
  facet_wrap(~P, scales = "free", ncol = 2)+
  ylim(0.25,29)


# Display the combined plot
print(TFIRYcomboplotF)

ggsave("TFIRYcomboplotF .jpg", plot = TFIRYcomboplotF , width = 8, height = 6, dpi = 300)
```


#Total forage compared to Alf monoculture XS XF YS YF relative yields 
```{r}
#0
NTFARY0 <- Nd %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    TFARelativeYield0 = (PlotTotForageKgHa[Treatment == 10]) / (PlotTotForageKgHa[Treatment == 15]))
#40
NTFARY40 <- Nd %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    TFARelativeYield40 = (PlotTotForageKgHa[Treatment == 10]) / (PlotTotForageKgHa[Treatment == 16]))
#80
NTFARY80 <- Nd %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    TFARelativeYield80 = (PlotTotForageKgHa[Treatment == 10]) / (PlotTotForageKgHa[Treatment == 17]))
#120
NTFARY120 <- Nd %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    TFARelativeYield120 = (PlotTotForageKgHa[Treatment == 10]) / (PlotTotForageKgHa[Treatment == 18]))
#160
NTFARY160 <- Nd %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    TFARelativeYield160 = (PlotTotForageKgHa[Treatment == 10]) / (PlotTotForageKgHa[Treatment == 19]))
#Join together all the tables
NTFARY<-left_join(NTFARY0, NTFARY40, by = c("Rep", "P", "YearCode", "Harvest"))
NTFARY<-left_join(NTFARY, NTFARY80, by = c("Rep", "P", "YearCode", "Harvest"))
NTFARY<-left_join(NTFARY, NTFARY120, by = c("Rep", "P", "YearCode", "Harvest"))
NTFARY<-left_join(NTFARY, NTFARY160, by = c("Rep", "P", "YearCode", "Harvest"))
print(NTFARY)
#boxplots
# Reshape the data from wide to long format
NTFARY_long <- NTFARY %>%
  pivot_longer(cols = starts_with("TFARelativeYield"),
               names_to = "N_rate",
               values_to = "TFARelativeYield") %>%
  separate(N_rate, into = c("N_rate", "N"), sep = "TFARelativeYield") %>%
  mutate(N = as.numeric(N))
#split apart by year-harvest 
NTFARYX<-NTFARY_long[NTFARY_long$YearCode== "X",]
NTFARYY<-NTFARY_long[NTFARY_long$YearCode== "Y",]
NTFARYXS<-NTFARYX[NTFARYX$Harvest== "Summer",]
NTFARYXF<-NTFARYX[NTFARYX$Harvest== "Fall",]
NTFARYYS<-NTFARYY[NTFARYY$Harvest== "Summer",]
NTFARYYF<-NTFARYY[NTFARYY$Harvest== "Fall",] 
#models 
#year 1 summer TFA RY
modTFARYXS<-lmer(TFARelativeYield~N*P + (1|Rep), data=NTFARYXS)
anova(modTFARYXS)
#check assumptions 
TFARYXS_resid<-resid(modTFARYXS)
qqnorm(TFARYXS_resid)
qqline(TFARYXS_resid)
plot(modTFARYXS)
#Logtransform
modTFARYXS1<-lmer(log(TFARelativeYield)~N*P + (1|Rep), data=NTFARYXS)
anova(modTFARYXS1)
class(NTFARYXS$N)
NTFARYXS$N<-as.numeric(NTFARYXS$N)
modTFARYXS1<-lmer(log(TFARelativeYield)~N*P + (1|Rep), data=NTFARYXS)
anova(modTFARYXS1)
#check LOG assumptions 
TFARYXS_resid1<-resid(modTFARYXS1)
qqnorm(TFARYXS_resid1)
qqline(TFARYXS_resid1)
plot(modTFARYXS1)
#Pairwise N 
N_levels <- c(0, 40, 80, 120, 160)
emmsN <- emmeans(modTFARYXS1, specs = ~ N, at = list(N = N_levels), type = "response")
cld_dataNTFARYXSN <- cld(emmsN, Letters=custom_letters) # Create compact letter display
cld_dataNTFARYXSN  $response <- format(cld_dataNTFARYXSN  $response, digits = 3)
cld_dataNTFARYXSN $lower.CL <- format(cld_dataNTFARYXSN $lower.CL, digits = 3)
cld_dataNTFARYXSN $upper.CL <- format(cld_dataNTFARYXSN $upper.CL, digits = 3)
rownames(cld_dataNTFARYXSN  ) <- NULL
cld_dataNTFARYXSN  <- cld_dataNTFARYXSN   %>%
  select( N, response, lower.CL, upper.CL, .group)
colnames(cld_dataNTFARYXSN  ) <- c( "N", "TFARY","l","h", "Group")
cld_dataNTFARYXSN    |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

#year 1 Fall TFA RY
modTFARYXF<-lmer(TFARelativeYield~N*P + (1|Rep), data=NTFARYXF)
anova(modTFARYXF)
#check assumptions 
TFARYXF_resid<-resid(modTFARYXF)
qqnorm(TFARYXF_resid)
qqline(TFARYXF_resid)
plot(modTFARYXF)
#Logtransform
modTFARYXF1<-lmer(log(TFARelativeYield)~N*P + (1|Rep), data=NTFARYXF)
anova(modTFARYXF1)
#check LOG assumptions 
TFARYXF_resid1<-resid(modTFARYXF1)
qqnorm(TFARYXF_resid1)
qqline(TFARYXF_resid1)
plot(modTFARYXF1)
#Pairwise P
emmsP <- emmeans(modTFARYXF, ~ P, type = "response") # Obtain estimated marginal means
cld_dataTFARYXFP <- cld(emmsP, Letters=custom_letters) # Create compact letter display
cld_dataTFARYXFP   $response <- format(cld_dataTFARYXFP   $emmean, digits = 3)
cld_dataTFARYXFP  $lower.CL <- format(cld_dataTFARYXFP  $lower.CL, digits = 3)
cld_dataTFARYXFP  $upper.CL <- format(cld_dataTFARYXFP  $upper.CL, digits = 3)
rownames(cld_dataTFARYXFP   ) <- NULL
cld_dataTFARYXFP   <- cld_dataTFARYXFP    %>%
  select( P, response, lower.CL, upper.CL, .group)
colnames(cld_dataTFARYXFP   ) <- c( "Site", "TFARY","l","h", "Group")
cld_dataTFARYXFP     |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise N 
N_levels <- c(0, 40, 80, 120, 160)
emmsN <- emmeans(modTFARYXF1, specs = ~ N, at = list(N = N_levels), type = "response")
cld_dataNTFARYXFN <- cld(emmsN, Letters=custom_letters) # Create compact letter display
cld_dataNTFARYXFN  $response <- format(cld_dataNTFARYXFN  $response, digits = 3)
cld_dataNTFARYXFN $lower.CL <- format(cld_dataNTFARYXFN $lower.CL, digits = 3)
cld_dataNTFARYXFN $upper.CL <- format(cld_dataNTFARYXFN $upper.CL, digits = 3)
rownames(cld_dataNTFARYXFN  ) <- NULL
cld_dataNTFARYXFN  <- cld_dataNTFARYXFN   %>%
  select( N, response, lower.CL, upper.CL, .group)
colnames(cld_dataNTFARYXFN  ) <- c( "N", "TFARY","l","h", "Group")
cld_dataNTFARYXFN    |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)


#year 2 summer TFA RY
modTFARYYS<-lmer(TFARelativeYield~N*P + (1|Rep), data=NTFARYYS)
anova(modTFARYYS)
#check assumptions 
TFARYYS_resid<-resid(modTFARYYS)
qqnorm(TFARYYS_resid)
qqline(TFARYYS_resid)
plot(modTFARYYS)
#Logtransform
modTFARYYS1<-lmer(log(TFARelativeYield)~N*P + (1|Rep), data=NTFARYYS)
anova(modTFARYYS1)
#check LOG assumptions 
TFARYYS_resid1<-resid(modTFARYYS1)
qqnorm(TFARYYS_resid1)
qqline(TFARYYS_resid1)
plot(modTFARYYS1)
#Pairwise N:P
N_levels <- c(0, 40, 80, 120, 160)
emmsNP <- emmeans(modTFARYYS1, specs = ~ N*P, at = list(N = N_levels), type = "response")
cld_dataNTFARYYSNP <- cld(emmsNP, Letters=custom_letters) # Create compact letter display
cld_dataNTFARYYSNP  $response <- format(cld_dataNTFARYYSNP  $response, digits = 3)
cld_dataNTFARYYSNP $lower.CL <- format(cld_dataNTFARYYSNP $lower.CL, digits = 3)
cld_dataNTFARYYSNP $upper.CL <- format(cld_dataNTFARYYSNP $upper.CL, digits = 3)
rownames(cld_dataNTFARYYSNP  ) <- NULL
cld_dataNTFARYYSNP  <- cld_dataNTFARYYSNP   %>%
  select( N, P, response, lower.CL, upper.CL, .group)
colnames(cld_dataNTFARYYSNP  ) <- c( "N", "Site", "TFARY","l","h", "Group")
cld_dataNTFARYYSNP    |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)


#year 2 Fall TFA RY
modTFARYYF<-lmer(TFARelativeYield~N*P + (1|Rep), data=NTFARYYF)
anova(modTFARYYF)
#check assumptions 
TFARYYF_resid<-resid(modTFARYYF)
qqnorm(TFARYYF_resid)
qqline(TFARYYF_resid)
plot(modTFARYYF)
#Logtransform
modTFARYYF1<-lmer(log(TFARelativeYield)~N*P + (1|Rep), data=NTFARYYF)
anova(modTFARYYF1)
#check LOG assumptions 
TFARYYF_resid1<-resid(modTFARYYF1)
qqnorm(TFARYYF_resid1)
qqline(TFARYYF_resid1)
plot(modTFARYYF1)
#Pairwise N 
N_levels <- c(0, 40, 80, 120, 160)
emmsN <- emmeans(modTFARYYF1, specs = ~ N, at = list(N = N_levels), type = "response")
cld_dataNTFARYYFN <- cld(emmsN, Letters=custom_letters) # Create compact letter display
cld_dataNTFARYYFN  $response <- format(cld_dataNTFARYYFN  $response, digits = 3)
cld_dataNTFARYYFN $lower.CL <- format(cld_dataNTFARYYFN $lower.CL, digits = 3)
cld_dataNTFARYYFN $upper.CL <- format(cld_dataNTFARYYFN $upper.CL, digits = 3)
rownames(cld_dataNTFARYYFN  ) <- NULL
cld_dataNTFARYYFN  <- cld_dataNTFARYYFN   %>%
  select( N, response, lower.CL, upper.CL, .group)
colnames(cld_dataNTFARYYFN  ) <- c( "N", "TFARY","l","h", "Group")
cld_dataNTFARYYFN    |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)


# Create box plots: 
# Define the order of factor levels and Convert N to a factor with specified levels
factor_levels <- c("0", "40", "80", "120", "160")
NTFARYXS$N <- factor(NTFARYXS$N, levels = factor_levels)
NTFARYYS$N <- factor(NTFARYYS$N, levels = factor_levels)
NTFARYXF$N <- factor(NTFARYXF$N, levels = factor_levels)
NTFARYYF$N <- factor(NTFARYYF$N, levels = factor_levels)
#year 1 summer 
ggplot(NTFARYXS, aes(x = N, y = TFARelativeYield)) +
  geom_boxplot() +
  facet_wrap(~P, scales = "free_y",ncol=2) +
  labs(x = "N Rate", y = "Relative Yield") +
  theme_minimal()+
   scale_x_discrete(breaks = c(0, 40, 80, 120, 160))+
    geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")+
    ggtitle("Year 1 Summer Total Forage Yield Relative to Alf monoculture")+
  ylim(0.25, 2.75) 
#year 1 fall 
ggplot(NTFARYXF, aes(x = N, y = TFARelativeYield)) +
  geom_boxplot() +
  facet_wrap(~P, scales = "free_y",ncol=2) +
  labs(x = "N Rate", y = "Relative Yield") +
  theme_minimal()+
   scale_x_discrete(breaks = c(0, 40, 80, 120, 160))+
    geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")+
  ggtitle("Year 1 Fall Total Forage Yield Relative to Alf monoculture")+
  ylim(0.5, NA)
#year 2 summer 
ggplot(NTFARYYS, aes(x = N, y = TFARelativeYield)) +
  geom_boxplot() +
  facet_wrap(~P, scales = "free_y",ncol=2) +
  labs(x = "N Rate", y = "Relative Yield") +
  theme_minimal()+
   scale_x_discrete(breaks = c(0, 40, 80, 120, 160))+
    geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")+
  ggtitle("Year 2 Summer Total Forage Yield Relative to Alf monoculture")+
  ylim(0.5, NA)
#year 2 Fall 
ggplot(NTFARYYF, aes(x = N, y = TFARelativeYield)) +
  geom_boxplot() +
  facet_wrap(~P, scales = "free_y",ncol=2) +
  labs(x = "N Rate", y = "Relative Yield") +
  theme_minimal()+
   scale_x_discrete(breaks = c(0, 40, 80, 120, 160))+
    geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")+
  ggtitle("Year 2 Fall Total Forage Yield Relative to Alf monoculture")+
  ylim(0.5, NA)
```
#TFARY combo boxplots summer 
```{r}
# Combine the data frames and create a new column to distinguish the years
NTFARYXS$Year<-"Year 1 Summer"
NTFARYYS$Year<-"Year 2 Summer"

combined_dataTFARYS <- rbind(NTFARYXS,NTFARYYS)

colors3 <- c("Year 1 Summer" = "red",
            "Year 2 Summer" = "blue")
legend_order4 <- c("Year 1 Summer", 
                  "Year 2 Summer")
combined_dataTFARYS$P <- factor(combined_dataTFARYS$P, levels = desired_order)

# Convert N to a factor for proper ordering on the x-axis
combined_dataTFARYS$N <- factor(combined_dataTFARYS$N, levels = c("0", "40", "80", "120", "160"))

# Plotting both boxplots together with dodge positioning
max(combined_dataTFARYS$TFARelativeYield)
TFARYcomboplotS <- ggplot(combined_dataTFARYS, aes(x = N, y = TFARelativeYield, fill = Year)) +
  geom_boxplot(position = position_dodge(width = 0.75)) +
  labs(x = "N Rate", y = "Relative Yield") +
  scale_x_discrete(breaks = c("0", "40", "80", "120", "160")) +
  geom_abline(intercept = 1, slope = 0, color = "red", linetype = "dashed") +
  ggtitle("Total Forage: Alfalfa monoculture Relative Yield, Summer") +
  coord_cartesian(ylim = c(NA, NA)) +
  scale_fill_manual(values = colors3, limits = legend_order4)+
  facet_wrap(~P, scales = "free", ncol = 2)+
  ylim(0.25,2.7)


# Display the combined plot
print(TFARYcomboplotS)

ggsave("TFARYcomboplotS .jpg", plot = TFARYcomboplotS , width = 8, height = 6, dpi = 300)
```
#TFARY combo boxplots fall
```{r}
# Combine the data frames and create a new column to distinguish the years
NTFARYXF$Year<-"Year 1 Fall"
NTFARYYF$Year<-"Year 2 Fall"

combined_dataTFARYF <- rbind(NTFARYXF,NTFARYYF)

colors4 <- c("Year 1 Fall" = "green",
            "Year 2 Fall" = "purple")
legend_order5 <- c("Year 1 Fall", 
                  "Year 2 Fall")
combined_dataTFARYF$P <- factor(combined_dataTFARYF$P, levels = desired_order)

# Convert N to a factor for proper ordering on the x-axis
combined_dataTFARYF$N <- factor(combined_dataTFARYF$N, levels = c("0", "40", "80", "120", "160"))

# Plotting both boxplots together with dodge positioning
max(combined_dataTFARYF$TFARelativeYield)
TFARYcomboplotF <- ggplot(combined_dataTFARYF, aes(x = N, y = TFARelativeYield, fill = Year)) +
  geom_boxplot(position = position_dodge(width = 0.75)) +
  labs(x = "N Rate", y = "Relative Yield") +
  scale_x_discrete(breaks = c("0", "40", "80", "120", "160")) +
  geom_abline(intercept = 1, slope = 0, color = "red", linetype = "dashed") +
  ggtitle("Total Forage: Alfalfa monoculture Relative Yield, Fall") +
  coord_cartesian(ylim = c(NA, NA)) +
  scale_fill_manual(values = colors4, limits = legend_order5)+
  facet_wrap(~P, scales = "free", ncol = 2)+
  ylim(0.25,4.7)


# Display the combined plot
print(TFARYcomboplotF)

ggsave("TFARYcomboplotF .jpg", plot = TFARYcomboplotF , width = 8, height = 6, dpi = 300)
```


#ALF forage XS XF YS YF relative yields 
```{r}
#0
NARY0 <- Nd %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    ARelativeYield0 = (PlotAlfDryKgHa[Treatment == 10]) / (PlotAlfDryKgHa[Treatment == 15]))
#40
NARY40 <- Nd %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    ARelativeYield40 = (PlotAlfDryKgHa[Treatment == 10]) / (PlotAlfDryKgHa[Treatment == 16]))
#80
NARY80 <- Nd %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    ARelativeYield80 = (PlotAlfDryKgHa[Treatment == 10]) / (PlotAlfDryKgHa[Treatment == 17]))
#120
NARY120 <- Nd %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    ARelativeYield120 = (PlotAlfDryKgHa[Treatment == 10]) / (PlotAlfDryKgHa[Treatment == 18]))
#160
NARY160 <- Nd %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    ARelativeYield160 = (PlotAlfDryKgHa[Treatment == 10]) / (PlotAlfDryKgHa[Treatment == 19]))
#Join together all the tables
NARY<-left_join(NARY0, NARY40, by = c("Rep", "P", "YearCode", "Harvest"))
NARY<-left_join(NARY, NARY80, by = c("Rep", "P", "YearCode", "Harvest"))
NARY<-left_join(NARY, NARY120, by = c("Rep", "P", "YearCode", "Harvest"))
NARY<-left_join(NARY, NARY160, by = c("Rep", "P", "YearCode", "Harvest"))
print(NARY)
#boxplots
# Reshape the data from wide to long format
NARY_long <- NARY %>%
  pivot_longer(cols = starts_with("ARelativeYield"),
               names_to = "N_rate",
               values_to = "ARelativeYield") %>%
  separate(N_rate, into = c("N_rate", "N"), sep = "ARelativeYield") %>%
  mutate(N = as.numeric(N))
#split apart by year-harvest 
NARYX<-NARY_long[NARY_long$YearCode== "X",]
NARYY<-NARY_long[NARY_long$YearCode== "Y",]
NARYXS<-NARYX[NARYX$Harvest== "Summer",]
NARYXF<-NARYX[NARYX$Harvest== "Fall",]
NARYYS<-NARYY[NARYY$Harvest== "Summer",]
NARYYF<-NARYY[NARYY$Harvest== "Fall",] 

#models 
#year 1 summer Alf RY
modARYXS<-lmer(ARelativeYield~N*P + (1|Rep), data=NARYXS)
anova(modARYXS)
#check assumptions 
ARYXS_resid<-resid(modARYXS)
qqnorm(ARYXS_resid)
qqline(ARYXS_resid)
plot(modARYXS)
#Logtransform
modARYXS1<-lmer(log(ARelativeYield)~N*P + (1|Rep), data=NARYXS)
anova(modARYXS1)
#check LOG assumptions 
ARYXS_resid1<-resid(modARYXS1)
qqnorm(ARYXS_resid1)
qqline(ARYXS_resid1)
plot(modARYXS1)
#Pairwise P
emmsP <- emmeans(modARYXS1, specs = ~ P, type = "response")
cld_dataNARYXSP <- cld(emmsP, Letters=custom_letters) # Create compact letter display
cld_dataNARYXSP$response <- format(cld_dataNARYXSP  $response, digits = 3)
cld_dataNARYXSP $lower.CL <- format(cld_dataNARYXSP $lower.CL, digits = 3)
cld_dataNARYXSP $upper.CL <- format(cld_dataNARYXSP $upper.CL, digits = 3)
rownames(cld_dataNARYXSP  ) <- NULL
cld_dataNARYXSP  <- cld_dataNARYXSP   %>%
  select( P, response, lower.CL, upper.CL, .group)
colnames(cld_dataNARYXSP  ) <- c( "Site", "Alfalfa RY","l","h", "Group")
cld_dataNARYXSP    |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise N
N_levels <- c(0, 40, 80, 120, 160)
emmsN <- emmeans(modARYXS1, specs = ~ N, at = list(N = N_levels), type = "response")
cld_dataNARYXSN <- cld(emmsN, Letters=custom_letters) # Create compact letter display
cld_dataNARYXSN$response <- format(cld_dataNARYXSN  $response, digits = 3)
cld_dataNARYXSN $lower.CL <- format(cld_dataNARYXSN $lower.CL, digits = 3)
cld_dataNARYXSN $upper.CL <- format(cld_dataNARYXSN $upper.CL, digits = 3)
rownames(cld_dataNARYXSN  ) <- NULL
cld_dataNARYXSN  <- cld_dataNARYXSN   %>%
  select( N, response, lower.CL, upper.CL, .group)
colnames(cld_dataNARYXSN  ) <- c( "N", "Alfalfa RY","l","h", "Group")
cld_dataNARYXSN    |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

#year 1 Fall A RY
modARYXF<-lmer(ARelativeYield~N*P + (1|Rep), data=NARYXF)
anova(modARYXF)
#check assumptions 
ARYXF_resid<-resid(modARYXF)
qqnorm(ARYXF_resid)
qqline(ARYXF_resid)
plot(modARYXF)
#Logtransform
modARYXF1<-lmer(log(ARelativeYield)~N*P + (1|Rep), data=NARYXF)
anova(modARYXF1)
#check LOG assumptions 
ARYXF_resid1<-resid(modARYXF1)
qqnorm(ARYXF_resid1)
qqline(ARYXF_resid1)
plot(modARYXF1)
#Pairwise P
emmsP <- emmeans(modARYXF1, specs = ~ P, type = "response")
cld_dataNARYXFP <- cld(emmsP) # Create compact letter display
cld_dataNARYXFP$response <- format(cld_dataNARYXFP  $response, digits = 3)
cld_dataNARYXFP $lower.CL <- format(cld_dataNARYXFP $lower.CL, digits = 3)
cld_dataNARYXFP $upper.CL <- format(cld_dataNARYXFP $upper.CL, digits = 3)
rownames(cld_dataNARYXFP  ) <- NULL
cld_dataNARYXFP  <- cld_dataNARYXFP   %>%
  select( P, response, lower.CL, upper.CL, .group)
colnames(cld_dataNARYXFP  ) <- c( "Site", "Alfalfa RY","l","h", "Group")
cld_dataNARYXFP    |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise N
N_levels <- c(0, 40, 80, 120, 160)
emmsN <- emmeans(modARYXF1, specs = ~ N, at = list(N = N_levels), type = "response")
cld_dataNARYXFN <- cld(emmsN, Letters=custom_letters) # Create compact letter display
cld_dataNARYXFN$response <- format(cld_dataNARYXFN  $response, digits = 3)
cld_dataNARYXFN $lower.CL <- format(cld_dataNARYXFN $lower.CL, digits = 3)
cld_dataNARYXFN $upper.CL <- format(cld_dataNARYXFN $upper.CL, digits = 3)
rownames(cld_dataNARYXFN  ) <- NULL
cld_dataNARYXFN  <- cld_dataNARYXFN   %>%
  select( N, response, lower.CL, upper.CL, .group)
colnames(cld_dataNARYXFN  ) <- c( "N", "Alfalfa RY","l","h", "Group")
cld_dataNARYXFN    |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)


#year 2 summer Alf RY
modARYYS<-lmer(ARelativeYield~N*P + (1|Rep), data=NARYYS)
anova(modARYYS)
#check assumptions 
ARYYS_resid<-resid(modARYYS)
qqnorm(ARYYS_resid)
qqline(ARYYS_resid)
plot(modARYYS)
#Logtransform
modARYYS1<-lmer(log(ARelativeYield)~N*P + (1|Rep), data=NARYYS)
anova(modARYYS1)
#check LOG assumptions 
ARYYS_resid1<-resid(modARYYS1)
qqnorm(ARYYS_resid1)
qqline(ARYYS_resid1)
plot(modARYYS1)
#Pairwise N:P
N_levels <- c(0, 40, 80, 120, 160)
emmsNP <- emmeans(modARYYS1, specs = ~ N*P, at = list(N = N_levels), type = "response")
cld_dataNARYYSNP <- cld(emmsNP, Letters=custom_letters) # Create compact letter display
cld_dataNARYYSNP$response <- format(cld_dataNARYYSNP  $response, digits = 3)
cld_dataNARYYSNP $lower.CL <- format(cld_dataNARYYSNP $lower.CL, digits = 3)
cld_dataNARYYSNP $upper.CL <- format(cld_dataNARYYSNP $upper.CL, digits = 3)
rownames(cld_dataNARYYSNP  ) <- NULL
cld_dataNARYYSNP  <- cld_dataNARYYSNP   %>%
  select( N, P, response, lower.CL, upper.CL, .group)
colnames(cld_dataNARYYSNP  ) <- c( "N", "Site", "Alfalfa RY","l","h", "Group")
cld_dataNARYYSNP    |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)


#year 2 Fall A RY
modARYYF<-lmer(ARelativeYield~N*P + (1|Rep), data=NARYYF)
anova(modARYYF)
#check assumptions 
ARYYF_resid<-resid(modARYYF)
qqnorm(ARYYF_resid)
qqline(ARYYF_resid)
plot(modARYYF)
#Logtransform
modARYYF1<-lmer(log(ARelativeYield)~N*P + (1|Rep), data=NARYYF)
anova(modARYYF1)
#check LOG assumptions 
ARYYF_resid1<-resid(modARYYF1)
qqnorm(ARYYF_resid1)
qqline(ARYYF_resid1)
plot(modARYYF1)
#Pairwise N
N_levels <- c(0, 40, 80, 120, 160)
emmsN <- emmeans(modARYYF1, specs = ~ N, at = list(N = N_levels), type = "response")
cld_dataNARYYFN <- cld(emmsN, Letters=custom_letters) # Create compact letter display
cld_dataNARYYFN$response <- format(cld_dataNARYYFN  $response, digits = 3)
cld_dataNARYYFN $lower.CL <- format(cld_dataNARYYFN $lower.CL, digits = 3)
cld_dataNARYYFN $upper.CL <- format(cld_dataNARYYFN $upper.CL, digits = 3)
rownames(cld_dataNARYYFN  ) <- NULL
cld_dataNARYYFN  <- cld_dataNARYYFN   %>%
  select( N, response, lower.CL, upper.CL, .group)
colnames(cld_dataNARYYFN  ) <- c( "N", "Alfalfa RY","l","h", "Group")
cld_dataNARYYFN    |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

# Create box plots: 
# Define the order of factor levels and Convert N to a factor with specified levels
factor_levels <- c("0", "40", "80", "120", "160")
NARYXS$N <- factor(NARYXS$N, levels = factor_levels)
NARYYS$N <- factor(NARYYS$N, levels = factor_levels)
NARYXF$N <- factor(NARYXF$N, levels = factor_levels)
NARYYF$N <- factor(NARYYF$N, levels = factor_levels)
#year 1 summer 
ggplot(NARYXS, aes(x = N, y = ARelativeYield)) +
  geom_boxplot() +
  facet_wrap(~P, scales = "free_y",ncol=2) +
  labs(x = "N Rate", y = "Relative Yield") +
  theme_minimal()+
   scale_x_discrete(breaks = c(0, 40, 80, 120, 160))+
    geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")+
   ggtitle("Year 1 Summer Alf Forage Relative Yield")+
   coord_cartesian(ylim = c(NA, NA)) 
#year 1 fall 
ggplot(NARYXF, aes(x = N, y = ARelativeYield)) +
  geom_boxplot() +
  facet_wrap(~P, scales = "free_y",ncol=2) +
  labs(x = "N Rate", y = "Relative Yield") +
  theme_minimal()+
   scale_x_discrete(breaks = c(0, 40, 80, 120, 160))+
    geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")+
      ggtitle("Year 1 Fall Alf Forage Relative Yield")+
    coord_cartesian(ylim = c(0.5, NA)) 
#year 2 summer 
ggplot(NARYYS, aes(x = N, y = ARelativeYield)) +
  geom_boxplot() +
  facet_wrap(~P, scales = "free_y",ncol=2) +
  labs(x = "N Rate", y = "Relative Yield") +
  theme_minimal()+
   scale_x_discrete(breaks = c(0, 40, 80, 120, 160))+
    geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")+
   ggtitle("Year 2 Summer Alf Forage Relative Yield")+
    coord_cartesian(ylim = c(.2, NA)) 
#year 2 Fall 
ggplot(NARYYF, aes(x = N, y = ARelativeYield)) +
  geom_boxplot() +
  facet_wrap(~P, scales = "free_y",ncol=2) +
  labs(x = "N Rate", y = "Relative Yield") +
  theme_minimal()+
   scale_x_discrete(breaks = c(0, 40, 80, 120, 160))+
    geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")+
   ggtitle("Year 2 Fall Alf Forage Relative Yield")+
    coord_cartesian(ylim = c(0.5, NA)) 
```
#ARFY combo boxplots
```{r}
# Combine the data frames and create a new column to distinguish the years
NARYXS$Year<-"Year 1 Summer"
NARYXF$Year<-"Year 1 Fall"
NARYYS$Year<-"Year 2 Summer"
NARYYF$Year<-"Year 2 Fall"

colors2 <- c("Year 1 Summer" = "red", 
            "Year 1 Fall" = "green", 
            "Year 2 Summer" = "blue", 
            "Year 2 Fall" = "purple")
legend_order7 <- c("Year 1 Summer", "Year 1 Fall", 
                  "Year 2 Summer", "Year 2 Fall")

combined_dataARY <- rbind(NARYXS,NARYXF,NARYYS, NARYYF)

combined_dataARY$P <- factor(combined_dataARY$P, levels = desired_order)

# Convert N to a factor for proper ordering on the x-axis
combined_dataARY$N <- factor(combined_dataARY$N, levels = c("0", "40", "80", "120", "160"))

# Plotting both boxplots together with dodge positioning
max(combined_dataARY$ARelativeYield)
min(combined_dataARY$ARelativeYield)
ARYcomboplot <- ggplot(combined_dataARY, aes(x = N, y = ARelativeYield, fill = Year)) +
  geom_boxplot(position = position_dodge(width = 0.75)) +
  labs(x = "N Rate", y = "Relative Yield") +
  scale_x_discrete(breaks = c("0", "40", "80", "120", "160")) +
  geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed") +
  ggtitle("Alfalfa Relative Yield, Summer") +
  coord_cartesian(ylim = c(NA, NA)) +
  scale_fill_manual(values = colors2, limits = legend_order7)+
  facet_wrap(~P, scales = "free", ncol = 2)+
  ylim(0,2.51)


# Display the combined plot
print(ARYcomboplot)

ggsave("ARYcomboplot.jpg", plot = ARYcomboplot  , width = 8, height = 6, dpi = 300)
```

#IWG forage XS XF YS YF relative yields 
```{r}
#0
NIRY0 <- Nd %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    IRelativeYield0 = (PlotIWGDryKgHa[Treatment == 10]) / (PlotIWGDryKgHa[Treatment == 5]))
#40
NIRY40 <- Nd %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    IRelativeYield40 = (PlotIWGDryKgHa[Treatment == 10]) / (PlotIWGDryKgHa[Treatment == 6]))
#80
NIRY80 <- Nd %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    IRelativeYield80 = (PlotIWGDryKgHa[Treatment == 10]) / (PlotIWGDryKgHa[Treatment == 7]))
#120
NIRY120 <- Nd %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    IRelativeYield120 = (PlotIWGDryKgHa[Treatment == 10]) / (PlotIWGDryKgHa[Treatment == 8]))
#160
NIRY160 <- Nd %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    IRelativeYield160 = (PlotIWGDryKgHa[Treatment == 10]) / (PlotIWGDryKgHa[Treatment == 9]))
#Join together all the tables
NIRY<-left_join(NIRY0, NIRY40, by = c("Rep", "P", "YearCode", "Harvest"))
NIRY<-left_join(NIRY, NIRY80, by = c("Rep", "P", "YearCode", "Harvest"))
NIRY<-left_join(NIRY, NIRY120, by = c("Rep", "P", "YearCode", "Harvest"))
NIRY<-left_join(NIRY, NIRY160, by = c("Rep", "P", "YearCode", "Harvest"))
print(NIRY)
#boxplots
# Reshape the data from wide to long format
NIRY_long <- NIRY %>%
  pivot_longer(cols = starts_with("IRelativeYield"),
               names_to = "N_rate",
               values_to = "IRelativeYield") %>%
  separate(N_rate, into = c("N_rate", "N"), sep = "IRelativeYield") %>%
  mutate(N = as.numeric(N))
#split apart by year-harvest 
NIRYX<-NIRY_long[NIRY_long$YearCode== "X",]
NIRYY<-NIRY_long[NIRY_long$YearCode== "Y",]
NIRYXS<-NIRYX[NIRYX$Harvest== "Summer",]
NIRYXF<-NIRYX[NIRYX$Harvest== "Fall",]
NIRYYS<-NIRYY[NIRYY$Harvest== "Summer",]
NIRYYF<-NIRYY[NIRYY$Harvest== "Fall",] 

#models 
#year 1 summer IWG RY
modIRYXS<-lmer(IRelativeYield~N*P + (1|Rep), data=NIRYXS)
anova(modIRYXS)
#check assumptions 
IRYXS_resid<-resid(modIRYXS)
qqnorm(IRYXS_resid)
qqline(IRYXS_resid)
plot(modIRYXS)
#Logtransform
modIRYXS1<-lmer(log(IRelativeYield)~N*P + (1|Rep), data=NIRYXS)
anova(modIRYXS1)
#check LOG assumptions 
IRYXS_resid1<-resid(modIRYXS1)
qqnorm(IRYXS_resid1)
qqline(IRYXS_resid1)
plot(modIRYXS1)
#Pairwise N:P
N_levels <- c(0, 40, 80, 120, 160)
emmsNP <- emmeans(modIRYXS1, specs = ~ N*P, at = list(N = N_levels), type = "response")
cld_dataNIRYXSNP <- cld(emmsNP, Letters=custom_letters) # Create compact letter display
cld_dataNIRYXSNP$response <- format(cld_dataNIRYXSNP  $response, digits = 3)
cld_dataNIRYXSNP $lower.CL <- format(cld_dataNIRYXSNP $lower.CL, digits = 3)
cld_dataNIRYXSNP $upper.CL <- format(cld_dataNIRYXSNP $upper.CL, digits = 3)
rownames(cld_dataNIRYXSNP  ) <- NULL
cld_dataNIRYXSNP  <- cld_dataNIRYXSNP   %>%
  select( N, P, response, lower.CL, upper.CL, .group)
colnames(cld_dataNIRYXSNP  ) <- c( "N", "Site", "TFARY","l","h", "Group")
cld_dataNIRYXSNP    |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

#year 1 Fall I RY
modIRYXF<-lmer(IRelativeYield~N*P + (1|Rep), data=NIRYXF)
anova(modIRYXF)
#check assumptions 
IRYXF_resid<-resid(modIRYXF)
qqnorm(IRYXF_resid)
qqline(IRYXF_resid)
plot(modIRYXF)
#Logtransform
modIRYXF1<-lmer(log(IRelativeYield)~N*P + (1|Rep), data=NIRYXF)
anova(modIRYXF1)
#check LOG assumptions 
IRYXF_resid1<-resid(modIRYXF1)
qqnorm(IRYXF_resid1)
qqline(IRYXF_resid1)
plot(modIRYXF1)
#Pairwise N
N_levels <- c(0, 40, 80, 120, 160)
emmsN <- emmeans(modIRYXF1, specs = ~ N, at = list(N = N_levels), type = "response")
cld_dataNIRYXFN <- cld(emmsN, Letters=custom_letters) # Create compact letter display
cld_dataNIRYXFN$response <- format(cld_dataNIRYXFN  $response, digits = 3)
cld_dataNIRYXFN $lower.CL <- format(cld_dataNIRYXFN $lower.CL, digits = 3)
cld_dataNIRYXFN $upper.CL <- format(cld_dataNIRYXFN $upper.CL, digits = 3)
rownames(cld_dataNIRYXFN  ) <- NULL
cld_dataNIRYXFN  <- cld_dataNIRYXFN   %>%
  select( N,  response, lower.CL, upper.CL, .group)
colnames(cld_dataNIRYXFN  ) <- c( "N", "TFARY","l","h", "Group")
cld_dataNIRYXFN    |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise P
emmsP <- emmeans(modIRYXF1, specs = ~ P, type = "response")
cld_dataNIRYXFP <- cld(emmsP, Letters=custom_letters) # Create compact letter display
cld_dataNIRYXFP$response <- format(cld_dataNIRYXFP  $response, digits = 3)
cld_dataNIRYXFP $lower.CL <- format(cld_dataNIRYXFP $lower.CL, digits = 3)
cld_dataNIRYXFP $upper.CL <- format(cld_dataNIRYXFP $upper.CL, digits = 3)
rownames(cld_dataNIRYXFP  ) <- NULL
cld_dataNIRYXFP  <- cld_dataNIRYXFP   %>%
  select( P,  response, lower.CL, upper.CL, .group)
colnames(cld_dataNIRYXFP  ) <- c( "Site", "TFARY","l","h", "Group")
cld_dataNIRYXFP    |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)


#year 2 summer IWG RY
modIRYYS<-lmer(IRelativeYield~N*P + (1|Rep), data=NIRYYS)
anova(modIRYYS)
#check assumptions 
IRYYS_resid<-resid(modIRYYS)
qqnorm(IRYYS_resid)
qqline(IRYYS_resid)
plot(modIRYYS)
#Logtransform
modIRYYS1<-lmer(log(IRelativeYield)~N*P + (1|Rep), data=NIRYYS)
anova(modIRYYS1)
#check LOG assumptions 
IRYYS_resid1<-resid(modIRYYS1)
qqnorm(IRYYS_resid1)
qqline(IRYYS_resid1)
plot(modIRYYS1)
#Pairwise N:P
N_levels <- c(0, 40, 80, 120, 160)
emmsNP <- emmeans(modIRYYS1, specs = ~ N*P, at = list(N = N_levels), type = "response")
cld_dataNIRYYSNP <- cld(emmsNP, Letters=custom_letters) # Create compact letter display
cld_dataNIRYYSNP$response <- format(cld_dataNIRYYSNP  $response, digits = 3)
cld_dataNIRYYSNP $lower.CL <- format(cld_dataNIRYYSNP $lower.CL, digits = 3)
cld_dataNIRYYSNP $upper.CL <- format(cld_dataNIRYYSNP $upper.CL, digits = 3)
rownames(cld_dataNIRYYSNP  ) <- NULL
cld_dataNIRYYSNP  <- cld_dataNIRYYSNP   %>%
  select( N, P, response, lower.CL, upper.CL, .group)
colnames(cld_dataNIRYYSNP  ) <- c( "N", "Site", "TFARY","l","h", "Group")
cld_dataNIRYYSNP    |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)


#year 2 Fall I RY
modIRYYF<-lmer(IRelativeYield~N*P + (1|Rep), data=NIRYYF)
anova(modIRYYF)
#check assumptions 
IRYYF_resid<-resid(modIRYYF)
qqnorm(IRYYF_resid)
qqline(IRYYF_resid)
plot(modIRYYF)
#Logtransform
modIRYYF1<-lmer(log(IRelativeYield)~N*P + (1|Rep), data=NIRYYF)
anova(modIRYYF1)
#check LOG assumptions 
IRYYF_resid1<-resid(modIRYYF1)
qqnorm(IRYYF_resid1)
qqline(IRYYF_resid1)
plot(modIRYYF1)
#Pairwise P
emmsP <- emmeans(modIRYYF1, specs = ~ P, type = "response")
cld_dataNIRYYFP <- cld(emmsP, Letters=custom_letters) # Create compact letter display
cld_dataNIRYYFP$response <- format(cld_dataNIRYYFP  $response, digits = 3)
cld_dataNIRYYFP $lower.CL <- format(cld_dataNIRYYFP $lower.CL, digits = 3)
cld_dataNIRYYFP $upper.CL <- format(cld_dataNIRYYFP $upper.CL, digits = 3)
rownames(cld_dataNIRYYFP  ) <- NULL
cld_dataNIRYYFP  <- cld_dataNIRYYFP   %>%
  select( P,  response, lower.CL, upper.CL, .group)
colnames(cld_dataNIRYYFP  ) <- c( "Site", "TFARY","l","h", "Group")
cld_dataNIRYYFP    |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise N
N_levels <- c(0, 40, 80, 120, 160)
emmsN <- emmeans(modIRYYF1, specs = ~ N, at = list(N = N_levels), type = "response")
cld_dataNIRYYFN <- cld(emmsN, Letters=custom_letters) # Create compact letter display
cld_dataNIRYYFN$response <- format(cld_dataNIRYYFN  $response, digits = 3)
cld_dataNIRYYFN $lower.CL <- format(cld_dataNIRYYFN $lower.CL, digits = 3)
cld_dataNIRYYFN $upper.CL <- format(cld_dataNIRYYFN $upper.CL, digits = 3)
rownames(cld_dataNIRYYFN  ) <- NULL
cld_dataNIRYYFN  <- cld_dataNIRYYFN   %>%
  select( N, response, lower.CL, upper.CL, .group)
colnames(cld_dataNIRYYFN  ) <- c( "N", "TFIRY","l","h", "Group")
cld_dataNIRYYFN    |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

# Create box plots: 
# Define the order of factor levels and Convert N to a factor with specified levels
factor_levels <- c("0", "40", "80", "120", "160")
NIRYXS$N <- factor(NIRYXS$N, levels = factor_levels)
NIRYYS$N <- factor(NIRYYS$N, levels = factor_levels)
NIRYXF$N <- factor(NIRYXF$N, levels = factor_levels)
NIRYYF$N <- factor(NIRYYF$N, levels = factor_levels)
#year 1 summer 
ggplot(NIRYXS, aes(x = N, y = IRelativeYield)) +
  geom_boxplot() +
  facet_wrap(~P, scales = "free_y",ncol=2) +
  labs(x = "N Rate", y = "Relative Yield") +
  theme_minimal()+
   scale_x_discrete(breaks = c(0, 40, 80, 120, 160))+
    geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")+
   ggtitle("Year 1 Summer IWG Forage Relative Yield")+
   coord_cartesian(ylim = c(NA, NA)) 
#year 1 fall 
ggplot(NIRYXF, aes(x = N, y = IRelativeYield)) +
  geom_boxplot() +
  facet_wrap(~P, scales = "free_y",ncol=2) +
  labs(x = "N Rate", y = "Relative Yield") +
  theme_minimal()+
   scale_x_discrete(breaks = c(0, 40, 80, 120, 160))+
    geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")+
   ggtitle("Year 1 Fall IWG Forage Relative Yield")+
    coord_cartesian(ylim = c(NA, NA)) 
#year 2 summer 
ggplot(NIRYYS, aes(x = N, y = IRelativeYield)) +
  geom_boxplot() +
  facet_wrap(~P, scales = "free_y",ncol=2) +
  labs(x = "N Rate", y = "Relative Yield") +
  theme_minimal()+
   scale_x_discrete(breaks = c(0, 40, 80, 120, 160))+
    geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")+
   ggtitle("Year 2 Summer IWG Forage Relative Yield")+
    coord_cartesian(ylim = c(.2, NA)) 
#year 2 Fall 
ggplot(NIRYYF, aes(x = N, y = IRelativeYield)) +
  geom_boxplot() +
  facet_wrap(~P, scales = "free_y",ncol=2) +
  labs(x = "N Rate", y = "Relative Yield") +
  theme_minimal()+
   scale_x_discrete(breaks = c(0, 40, 80, 120, 160))+
    geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")+
   ggtitle("Year 2 Fall IWG Forage Relative Yield")+
    coord_cartesian(ylim = c(0.5, NA)) 
```
#IRFY combo boxplots
```{r}
# Combine the data frames and create a new column to distinguish the years
NIRYXS$Year<-"Year 1 Summer"
NIRYXF$Year<-"Year 1 Fall"
NIRYYS$Year<-"Year 2 Summer"
NIRYYF$Year<-"Year 2 Fall"

colors2 <- c("Year 1 Summer" = "red", 
            "Year 1 Fall" = "green", 
            "Year 2 Summer" = "blue", 
            "Year 2 Fall" = "purple")
legend_order7 <- c("Year 1 Summer", "Year 1 Fall", 
                  "Year 2 Summer", "Year 2 Fall")

combined_dataIRY <- rbind(NIRYXS,NIRYXF,NIRYYS, NIRYYF)

combined_dataIRY$P <- factor(combined_dataIRY$P, levels = desired_order)

# Convert N to a factor for proper ordering on the x-axis
combined_dataIRY$N <- factor(combined_dataIRY$N, levels = c("0", "40", "80", "120", "160"))

# Plotting both boxplots together with dodge positioning
max(combined_dataIRY$IRelativeYield)
min(combined_dataIRY$IRelativeYield)
IRYcomboplot <- ggplot(combined_dataIRY, aes(x = N, y = IRelativeYield, fill = Year)) +
  geom_boxplot(position = position_dodge(width = 0.75)) +
  labs(x = "N Rate", y = "Relative Yield") +
  scale_x_discrete(breaks = c("0", "40", "80", "120", "160")) +
  geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed") +
  ggtitle("IWG Relative Yield, Summer") +
  coord_cartesian(ylim = c(NA, NA)) +
  scale_fill_manual(values = colors2, limits = legend_order7)+
  facet_wrap(~P, scales = "free", ncol = 2)+
  ylim(0,4.2)


# Display the combined plot
print(IRYcomboplot)

ggsave("IRYcomboplot.jpg", plot = IRYcomboplot  , width = 8, height = 6, dpi = 300)
```

***
changes across years stuff (did not do grain deltas)

#N Forage yields changes across years
```{r}
#Total Forage Delta Reframe 
NdnoMN<-Nd[Nd$P != 'MN',]
NTFDeltaPercent <- NdnoMN %>%
  group_by(Rep, P, Harvest, N, C) %>%
  reframe(DeltaTFP = ((PlotTotForageKgHa[YearCode == 'Y']-PlotTotForageKgHa[YearCode == 'X'])/abs(PlotTotForageKgHa[YearCode == 'X']))*100)
print(NTFDeltaPercent)

#IWG Forage Delta Reframe
NdnoMNI<-NdnoMN[NdnoMN$Crop1 != "Shockwave",]
NIBDeltaP <- NdnoMNI %>%
  group_by(Rep, P, Harvest, N, C) %>%
  reframe(DeltaIBP = ((PlotIWGDryKgHa[YearCode == 'Y']-PlotIWGDryKgHa[YearCode == 'X'])/abs(PlotIWGDryKgHa[YearCode == 'X']))*100)
print(NIBDeltaP)

#Alf Forage Delta Reframe 
NdnoMNA<-NdnoMN[NdnoMN$Crop1 != "IWG",]
NABDeltaP <- NdnoMNA %>%
  group_by(Rep, P, Harvest, N, C) %>%
  reframe(DeltaABP = ((PlotAlfDryKgHa[YearCode == 'Y']-PlotAlfDryKgHa[YearCode == 'X'])/abs(PlotAlfDryKgHa[YearCode == 'X']))*100)
print(NABDeltaP)
```
#N LER changes across years
```{r, eval=FALSE}
#Total LER reframe
TotalLERresultsnoMN<-TotalLERresults[TotalLERresults$P != "MN",]
TotalLERresultsnoMN$N<-TotalLERresultsnoMN$NRATE
TotalLERresultsnoMN$N<-as.numeric(TotalLERresultsnoMN$N)
NTLERDeltaP <- TotalLERresultsnoMN %>%
  group_by(Rep, P, Harvest, N) %>%
  reframe(DeltaTLER = ((LER[YearCode == 'Y']-LER[YearCode == 'X'])/abs(LER[YearCode == 'X']))*100)
print(NTLERDeltaP)

#IWG PLER reframe 
IWGPartialLERresultsnoMN<-IWGPartialLERresults[IWGPartialLERresults$P !="MN",]
IWGPartialLERresultsnoMN$N<-IWGPartialLERresultsnoMN$NRATE
IWGPartialLERresultsnoMN$N<-as.numeric(IWGPartialLERresultsnoMN$N)
NIPLERDeltaP <- IWGPartialLERresultsnoMN %>%
  group_by(Rep, P, Harvest, N) %>%
  reframe(DeltaIPLER = ((LER[YearCode == 'Y']-LER[YearCode == 'X'])/abs(LER[YearCode == 'X']))*100)
print(NIPLERDeltaP)

#Alf PLER reframe 
AlfPartialLERresultsnoMN<-AlfPartialLERresults[AlfPartialLERresults$P != "MN",]
AlfPartialLERresultsnoMN$N<-AlfPartialLERresultsnoMN$NRATE
AlfPartialLERresultsnoMN$N<-as.numeric(AlfPartialLERresultsnoMN$N)
NAPLERDeltaP <- AlfPartialLERresultsnoMN %>%
  group_by(Rep, P, Harvest, N) %>%
  reframe(DeltaAPLER = ((LER[YearCode == 'Y']-LER[YearCode == 'X'])/abs(LER[YearCode == 'X']))*100)
print(NAPLERDeltaP)

#IWG PrPLER reframe 
NIPrPLERDeltaP <- PrPLERnoMN %>%
  group_by(Rep, P, Harvest, N) %>%
  reframe(DeltaIPrPLER = ((IPrPLER[YearCode == 'Y']-IPrPLER[YearCode == 'X'])/abs(IPrPLER[YearCode == 'X']))*100)
print(NIPrPLERDeltaP)

#ALF PrPLER reframe 
NAPrPLERDeltaP <- PrPLERnoMN %>%
  group_by(Rep, P, Harvest, N) %>%
  reframe(DeltaAPrPLER = ((APrPLER[YearCode == 'Y']-APrPLER[YearCode == 'X'])/abs(APrPLER[YearCode == 'X']))*100)
print(NAPrPLERDeltaP)

```

#N IWG fq changes across years 
```{r}
#IWG CP Delta Reframe 
NICPDeltaP <- NdnoMNI %>%
  group_by(Rep, P, Harvest, N, C) %>%
  reframe(DeltaICPP = ((IWGCP[YearCode == 'Y']-IWGCP[YearCode == 'X'])/abs(IWGCP[YearCode == 'X']))*100)
print(NICPDeltaP)

#IWG RFV Delta Reframe: NRFVIdf
NRFVIdfnoMn<-NRFVIdf[NRFVIdf$P != "MN",]
NIRFVDeltaP <-NRFVIdfnoMn%>%
  group_by(Rep, P, N, CROP, Harvest) %>%
  reframe(DeltaIRFVP = ((IWGRFV[YearCode == 'Y']-IWGRFV[YearCode == 'X'])/abs(IWGRFV[YearCode == 'X']))*100)
print(NIRFVDeltaP)
```

#N Alf fq changes across years 
```{r}
#ALF CP Delta Reframe 
NACPDeltaP <- NdnoMNA %>%
  group_by(Rep, P, Harvest, N, C) %>%
  reframe(DeltaACPP = ((ALFCP[YearCode == 'Y']-ALFCP[YearCode == 'X'])/abs(ALFCP[YearCode == 'X']))*100)
print(NACPDeltaP)

#ALF RFV Delta Reframe: NRFVAdf
NRFVAdfnoMn<-NRFVAdf[NRFVAdf$P != "MN",]
NARFVDeltaP <-NRFVAdfnoMn%>%
  group_by(Rep, P, N, CROP, Harvest) %>%
  reframe(DeltaARFVP = ((ALFRFV[YearCode == 'Y']-ALFRFV[YearCode == 'X'])/abs(ALFRFV[YearCode == 'X']))*100)
print(NARFVDeltaP)
```
#RY changes across years 
```{r}
#TF IWG RY Delta Reframe 
NTFIRYDeltaP <- NTFIRY_long %>%
  group_by(Rep, P, Harvest, N) %>%
  reframe(DeltaTFIRY = ((TFIRelativeYield[YearCode == 'Y']-TFIRelativeYield[YearCode == 'X'])/abs(TFIRelativeYield[YearCode == 'X']))*100)
print(NTFIRYDeltaP)

#TF Alf RY Delta Reframe 
NTFARYDeltaP <- NTFARY_long %>%
  group_by(Rep, P, Harvest, N) %>%
  reframe(DeltaTFARY = ((TFARelativeYield[YearCode == 'Y']-TFARelativeYield[YearCode == 'X'])/abs(TFARelativeYield[YearCode == 'X']))*100)
print(NTFARYDeltaP)

#Alf RYDelta Reframe 
NARYDeltaP <- NARY_long %>%
  group_by(Rep, P, Harvest, N) %>%
  reframe(DeltaARY = ((ARelativeYield[YearCode == 'Y']-ARelativeYield[YearCode == 'X'])/abs(ARelativeYield[YearCode == 'X']))*100)
print(NARYDeltaP)

#IWG RY Summer Delta Reframe 
NIRYDeltaP <- NIRY_long %>%
  group_by(Rep, P, Harvest, N) %>%
  reframe(DeltaIRY = ((IRelativeYield[YearCode == 'Y']-IRelativeYield[YearCode == 'X'])/abs(IRelativeYield[YearCode == 'X']))*100)
print(NIRYDeltaP)
```



#N forage yields delta means tables
```{r}
#Total forage delta means table 
mean_by_treatmentNTF <- NTFDeltaPercent %>%
  dplyr::group_by(P, Harvest, N, C) %>%
  dplyr::summarise(MeanTFDeltaPercent = mean(DeltaTFP, na.rm = TRUE))
print(mean_by_treatmentNTF)

#IWG forage delta means table 
mean_by_treatmentNI <- NIBDeltaP  %>%
  dplyr::group_by(P, Harvest, N, C) %>%
  dplyr::summarise(MeanIBDeltaPercent = mean(DeltaIBP, na.rm = TRUE))
print(mean_by_treatmentNI)

#ALf forage delta means table 
mean_by_treatmentNA <- NABDeltaP  %>%
  dplyr::group_by(P, Harvest, N, C) %>%
  dplyr::summarise(MeanABDeltaPercent = mean(DeltaABP, na.rm = TRUE))
print(mean_by_treatmentNA)
```
#N LER delta means tables 
```{r}
#APLER
mean_by_treatmentNAPLER <- NAPLERDeltaP  %>%
  dplyr::group_by(P, Harvest, N) %>%
  dplyr::summarise(MeanAPLERDeltaPercent = mean(DeltaAPLER, na.rm = TRUE))
print(mean_by_treatmentNAPLER)
#IPLER
mean_by_treatmentNIPLER <- NIPLERDeltaP  %>%
  dplyr::group_by(P, Harvest, N) %>%
  dplyr::summarise(MeanIPLERDeltaPercent = mean(DeltaIPLER, na.rm = TRUE))
print(mean_by_treatmentNIPLER)
#TLER
mean_by_treatmentNTLER <- NTLERDeltaP  %>%
  dplyr::group_by(P, Harvest, N) %>%
  dplyr::summarise(MeanTLERDeltaPercent = mean(DeltaTLER, na.rm = TRUE))
print(mean_by_treatmentNTLER)
#IPrPLER
mean_by_treatmentNIPrPLER <- NIPrPLERDeltaP  %>%
  dplyr::group_by(P, Harvest, N) %>%
  dplyr::summarise(MeanIPrPLERDeltaPercent = mean(DeltaIPrPLER, na.rm = TRUE))
print(mean_by_treatmentNIPrPLER)
#APrPLER
mean_by_treatmentNAPrPLER <- NAPrPLERDeltaP  %>%
  dplyr::group_by(P, Harvest, N) %>%
  dplyr::summarise(MeanAPrPLERDeltaPercent = mean(DeltaAPrPLER, na.rm = TRUE))
print(mean_by_treatmentNAPrPLER)
```
#N IWG FQ delta means tables 
```{r}
#IWG CP
mean_by_treatmentNICP <- NICPDeltaP  %>%
  dplyr::group_by(P, Harvest, N) %>%
  dplyr::summarise(MeanICPDeltaPercent = mean(DeltaICPP, na.rm = TRUE))
print(mean_by_treatmentNICP)
#IWG RFV 
mean_by_treatmentNIRFV <- NIRFVDeltaP  %>%
  dplyr::group_by(P, Harvest, N) %>%
  dplyr::summarise(MeanIRFVDeltaPercent = mean(DeltaIRFVP, na.rm = TRUE))
print(mean_by_treatmentNIRFV)
```
#N Alf FQ delta means tables
```{r}
#Alf CP
mean_by_treatmentNACP <- NACPDeltaP  %>%
  dplyr::group_by(P, Harvest, N) %>%
  dplyr::summarise(MeanACPDeltaPercent = mean(DeltaACPP, na.rm = TRUE))
print(mean_by_treatmentNACP)
#Alf RFV 
mean_by_treatmentNARFV <- NARFVDeltaP  %>%
  dplyr::group_by(P, Harvest, N) %>%
  dplyr::summarise(MeanARFVDeltaPercent = mean(DeltaARFVP, na.rm = TRUE))
print(mean_by_treatmentNARFV)
```
#RY delta means tables 
```{r}
#TFIRY 
mean_by_treatmentNTFIRY <- NTFIRYDeltaP  %>%
  dplyr::group_by(P, Harvest, N) %>%
  dplyr::summarise(MeanTFIRYDeltaPercent = mean(DeltaTFIRY, na.rm = TRUE))
print(mean_by_treatmentNTFIRY)
#TFARY
mean_by_treatmentNTFARY <- NTFARYDeltaP  %>%
  dplyr::group_by(P, Harvest, N) %>%
  dplyr::summarise(MeanTFARYDeltaPercent = mean(DeltaTFARY, na.rm = TRUE))
print(mean_by_treatmentNTFARY)

#I RY
mean_by_treatmentNIRY <- NIRYDeltaP  %>%
  dplyr::group_by(P, Harvest, N) %>%
  dplyr::summarise(MeanIRYDeltaPercent = mean(DeltaIRY, na.rm = TRUE))
print(mean_by_treatmentNIRY)

#A RY 
mean_by_treatmentNARY <- NARYDeltaP  %>%
  dplyr::group_by(P, Harvest, N) %>%
  dplyr::summarise(MeanARYDeltaPercent = mean(DeltaARY, na.rm = TRUE))
print(mean_by_treatmentNARY)

```

***
Nrate paper anova tables stuff 

#mean values across reps for table 
```{r}
#Grain
# Calculate the mean for each treatment excluding NA and 0 values
mean_by_treatmentNG <- Nd %>%
  dplyr::group_by(P, N, YearCode, Harvest, C) %>%
  dplyr::summarise(MeanGrainYield = mean(G, na.rm = TRUE))
print(mean_by_treatmentNG)

#Total forage 
mean_by_treatmentNTF <- Nd %>%
  dplyr::group_by(P, N, YearCode, Harvest, C) %>%
  dplyr::summarise(MeanTotalForage = mean(PlotTotForageKgHa, na.rm = TRUE))
print(mean_by_treatmentNTF)

#IWG biomass 
mean_by_treatmentNIB <- Nd %>%
 dplyr::group_by(P, N, YearCode, Harvest, C) %>%
  dplyr::summarise(MeanIWGBiomass = mean(PlotIWGDryKgHa, na.rm = TRUE))
print(mean_by_treatmentNIB)

#Alf Biomass
mean_by_treatmentNAB <- Nd %>%
  dplyr::group_by(P, N, YearCode, Harvest, C) %>%
  dplyr::summarise(MeanAlfBiomass = mean(PlotAlfDryKgHa, na.rm = TRUE))
print(mean_by_treatmentNAB)

#Total LER 
mean_by_treatmentNTL <- TotalLERresults %>%
  dplyr::group_by(P, NRATE, YearCode, Harvest) %>%
  dplyr::summarise(MeanTotalLER = mean(LER, na.rm = TRUE))
print(mean_by_treatmentNTL)

#IWG partial LER 
mean_by_treatmentNIL <- IWGPartialLERresults %>%
  dplyr::group_by(P, NRATE, YearCode, Harvest) %>%
  dplyr::summarise(MeanIWGPartialLER = mean(LER, na.rm = TRUE))
print(mean_by_treatmentNIL)

#Alf partial LER
mean_by_treatmentNAL <- AlfPartialLERresults %>%
  dplyr::group_by(P, NRATE, YearCode, Harvest) %>%
  dplyr::summarise(MeanAlfPartialLER = mean(LER, na.rm = TRUE))
print(mean_by_treatmentNAL)

#quality stuff?
```

#building consolidated tables of mean values  
```{r}
#Build a table for mean yield results for all years, locations, harvests, cropping systems 
NdBigMeansTable <- left_join(mean_by_treatmentNG, 
                              mean_by_treatmentNTF, 
                              by = c( "P", "YearCode", "Harvest", "N",  "C")) %>%
                  left_join(mean_by_treatmentNIB, by = c("P", "YearCode", "Harvest", "N",  "C")) %>%
                  left_join(mean_by_treatmentNAB, by = c("P", "YearCode", "Harvest", "N",  "C")) 
print(NdBigMeansTable)

 NdBigMeansTable %>%
  gt(rowname_col = "Harvest", groupname_col = "YearCode")

library("kableExtra")

NdBigMeansTableX<-NdBigMeansTable[NdBigMeansTable$YearCode=="X",]
NdBigMeansTableY<-NdBigMeansTable[NdBigMeansTable$YearCode=="Y",]

#pretty theme 
table_meansX<- NdBigMeansTableX  %>%
  kbl(caption = "Recreating booktabs style table") %>%
  kable_classic(full_width = F, html_font = "Cambria")

table_meansY<- NdBigMeansTableY %>%
  kbl(caption = "Recreating booktabs style table") %>%
  kable_classic(full_width = F, html_font = "Cambria")


```


#Total forage anovas 
```{r}
Year1SummerTotalForageYield<-modNXST1
Year1FallTotalForageYield<-modNXFT1
Year2SummerTotalForageYield<-modNYST1
Year2FallTotalForageYield<-modNYFT1


my_modelsTF <- c(Year1SummerTotalForageYield,Year1FallTotalForageYield,Year2SummerTotalForageYield,Year2FallTotalForageYield)
anovasTF <- purrr::map(my_modelsTF, ~anova(.))
names(anovasTF) <- c("Year 1 Summer", "Year 1 Fall", "Year 2 Summer", "Year 2 Fall")


# Function to format p-values as stars
format_p_value <- function(p_val) {
  stars <- ifelse(p_val < 0.001, "***", ifelse(p_val < 0.01, "**", ifelse(p_val < 0.05, "*", "")))
  return(stars)
}

# Apply the function to your ANOVA results
TF_stars_tibble <- map(anovasTF, as_tibble, rownames="term") %>%
  bind_rows(.id = "model") %>%
  mutate(stars = map_chr(`Pr(>F)`, format_p_value))%>%
  mutate(term = ifelse(term == "CROP", "C", term)) %>%
  mutate(term = ifelse(term == "P", "E", term)) %>%
  mutate(term = ifelse(term == "N:P", "N:E", term))%>%
  mutate(term = ifelse(term == "N:CROP", "N:C", term))%>%
  mutate(term = ifelse(term == "N:P:CROP", "N:E:C", term))%>%
  mutate(term = ifelse(term == "P:CROP", "E:C", term))

# Print the tibble
print(TF_stars_tibble)

TF_stars <-TF_stars_tibble |> 
  select(model, term, stars) |>
  pivot_wider(names_from = term, values_from = stars)

gt_TF <- gt(TF_stars)

library(webshot)
library(webshot2)
library(gt)
gt_TF  |> gtsave("gt_TF .png")
```
#IWG forage anovas 
```{r}
Year1SummerIWGForageYield<-modNXSI1
Year1FallIWGForageYield<-modNXFI1
Year2SummerIWGForageYield<-modNYSI1
Year2FallIWGForageYield<-modNYFI1

my_modelsI <- c(Year1SummerIWGForageYield,Year1FallIWGForageYield,Year2SummerIWGForageYield,Year2FallIWGForageYield)
anovasI <- purrr::map(my_modelsI, ~anova(.))
names(anovasI) <- c("Year 1 Summer", "Year 1 Fall", "Year 2 Summer", "Year 2 Fall")


# Function to format p-values as stars
format_p_value <- function(p_val) {
  stars <- ifelse(p_val < 0.001, "***", ifelse(p_val < 0.01, "**", ifelse(p_val < 0.05, "*", "")))
  return(stars)
}

# Apply the function to your ANOVA results
I_stars_tibble <- map(anovasI, as_tibble, rownames="term") %>%
  bind_rows(.id = "model") %>%
  mutate(stars = map_chr(`Pr(>F)`, format_p_value))%>%
  mutate(term = ifelse(term == "P", "E", term)) %>%
  mutate(term = ifelse(term == "N:P", "N:E", term))%>%
  mutate(term = ifelse(term == "N:P:C", "N:E:C", term))%>%
  mutate(term = ifelse(term == "P:C", "E:C", term))

# Print the tibble
print(I_stars_tibble)

I_stars <-I_stars_tibble |> 
  select(model, term, stars) |>
  pivot_wider(names_from = term, values_from = stars)

gt_I <- gt(I_stars)
gt_I  |> gtsave("gt_I .png", expand = 10)
```
#ALF forage anovas 
```{r}
Year1SummerAlfForageYield<-modNXSA1
Year1FallAlfForageYield<-modNXFA1
Year2SummerAlfForageYield<-modNYSA1
Year2FallAlfForageYield<-modNYFA1

my_modelsA <- c(Year1SummerAlfForageYield,Year1FallAlfForageYield,Year2SummerAlfForageYield,Year2FallAlfForageYield)
anovasA <- purrr::map(my_modelsA, ~anova(.))
names(anovasA) <- c("Year 1 Summer", "Year 1 Fall", "Year 2 Summer", "Year 2 Fall")


# Function to format p-values as stars
format_p_value <- function(p_val) {
  stars <- ifelse(p_val < 0.001, "***", ifelse(p_val < 0.01, "**", ifelse(p_val < 0.05, "*", "")))
  return(stars)
}

# Apply the function to your ANOVA results
A_stars_tibble <- map(anovasA, as_tibble, rownames="term") %>%
  bind_rows(.id = "model") %>%
  mutate(stars = map_chr(`Pr(>F)`, format_p_value))%>%
  mutate(term = ifelse(term == "P", "E", term)) %>%
  mutate(term = ifelse(term == "N:P", "N:E", term))%>%
  mutate(term = ifelse(term == "N:P:C", "N:E:C", term))%>%
  mutate(term = ifelse(term == "P:C", "E:C", term))

# Print the tibble
print(A_stars_tibble)

A_stars <-A_stars_tibble |> 
  select(model, term, stars) |>
  pivot_wider(names_from = term, values_from = stars)

gt_A <- gt(A_stars)

library(webshot2)
library(gt)
gt_A  |> gtsave("gt_A .png", expand = 10)
```
#all forage anovas easy print
```{r}
gt_TF
gt_I
gt_A
```

#TLER anovas
```{r}
Year1SummerTotalLER<-modTotLERXS1
Year1FallTotalLER<-modTotLERXF1
Year2SummerTotalLER<-modTotLERYS1
Year2FallTotalLER<-modTotLERYF1

my_modelsTLER <- c(Year1SummerTotalLER,Year1FallTotalLER,Year2SummerTotalLER,Year2FallTotalLER)
anovasTLER <- purrr::map(my_modelsTLER, ~anova(.))
names(anovasTLER) <- c("Year 1 Summer", "Year 1 Fall", "Year 2 Summer", "Year 2 Fall")


# Function to format p-values as stars
format_p_value <- function(p_val) {
  stars <- ifelse(p_val < 0.001, "***", ifelse(p_val < 0.01, "**", ifelse(p_val < 0.05, "*", "")))
  return(stars)
}

# Apply the function to your ANOVA results
TLER_stars_tibble <- map(anovasTLER, as_tibble, rownames="term") %>%
  bind_rows(.id = "model") %>%
  mutate(stars = map_chr(`Pr(>F)`, format_p_value))%>%
  mutate(term = ifelse(term == "P", "E", term)) %>%
  mutate(term = ifelse(term == "N:P", "N:E", term))

# Print the tibble
print(TLER_stars_tibble)

TLER_stars <-TLER_stars_tibble |> 
  select(model, term, stars) |>
  pivot_wider(names_from = term, values_from = stars)

gt_TLER <- gt(TLER_stars)
gt_TLER  |> gtsave("gt_TLER .png", expand = 10)


```
#IPLER anovas
```{r}
Year1SummerIWGPartialLER<-modIWGPLERXS1
Year1FallIWGPartialLER<-modIWGPLERXF1
Year2SummerIWGPartialLER<-modIWGPLERYS1
Year2FallIWGPartialLER<-modIWGPLERYF1

my_modelsIPLER <- c(Year1SummerIWGPartialLER,Year1FallIWGPartialLER,Year2SummerIWGPartialLER,Year2FallIWGPartialLER)
anovasIPLER <- purrr::map(my_modelsIPLER, ~anova(.))
names(anovasIPLER) <- c("Year 1 Summer", "Year 1 Fall", "Year 2 Summer", "Year 2 Fall")


# Function to format p-values as stars
format_p_value <- function(p_val) {
  stars <- ifelse(p_val < 0.001, "***", ifelse(p_val < 0.01, "**", ifelse(p_val < 0.05, "*", "")))
  return(stars)
}

# Apply the function to your ANOVA results
IPLER_stars_tibble <- map(anovasIPLER, as_tibble, rownames="term") %>%
  bind_rows(.id = "model") %>%
  mutate(stars = map_chr(`Pr(>F)`, format_p_value))%>%
  mutate(term = ifelse(term == "P", "E", term)) %>%
  mutate(term = ifelse(term == "N:P", "N:E", term))

# Print the tibble
print(IPLER_stars_tibble)

IPLER_stars <-IPLER_stars_tibble |> 
  select(model, term, stars) |>
  pivot_wider(names_from = term, values_from = stars)

gt_IPLER <- gt(IPLER_stars)
gt_IPLER  |> gtsave("gt_IPLER .png", expand = 10)


```
#APLER anovas
```{r}
Year1SummerAlfPartialLER<-modAlfPLERXS1
Year1FallAlfPartialLER<-modAlfPLERXF1
Year2SummerAlfPartialLER<-modAlfPLERYS1
Year2FallAlfPartialLER<-modAlfPLERYF1

my_modelsAPLER <- c(Year1SummerAlfPartialLER,Year1FallAlfPartialLER,Year2SummerAlfPartialLER,Year2FallAlfPartialLER)
anovasAPLER <- purrr::map(my_modelsAPLER, ~anova(.))
names(anovasAPLER) <- c("Year 1 Summer", "Year 1 Fall", "Year 2 Summer", "Year 2 Fall")


# Function to format p-values as stars
format_p_value <- function(p_val) {
  stars <- ifelse(p_val < 0.001, "***", ifelse(p_val < 0.01, "**", ifelse(p_val < 0.05, "*", "")))
  return(stars)
}

# Apply the function to your ANOVA results
APLER_stars_tibble <- map(anovasAPLER, as_tibble, rownames="term") %>%
  bind_rows(.id = "model") %>%
  mutate(stars = map_chr(`Pr(>F)`, format_p_value))%>%
  mutate(term = ifelse(term == "P", "E", term)) %>%
  mutate(term = ifelse(term == "N:P", "N:E", term))

# Print the tibble
print(APLER_stars_tibble)

APLER_stars <-APLER_stars_tibble |> 
  select(model, term, stars) |>
  pivot_wider(names_from = term, values_from = stars)

gt_APLER <- gt(APLER_stars)
gt_APLER  |> gtsave("gt_APLER .png", expand = 10)

```
#IPrPLER anovas
```{r}
Year1SummerIWGPrPLER<-modIPrPLERXS
Year1FallIWGPrPLER<-modIPrPLERXF1
Year2SummerIWGPrPLER<-modIPrPLERYS1
Year2FallIWGPrPLER<-modIPrPLERYF1

my_modelsIPrPLER <- c(Year1SummerIWGPrPLER,Year1FallIWGPrPLER,Year2SummerIWGPrPLER,Year2FallIWGPrPLER)
anovasIPrPLER <- purrr::map(my_modelsIPrPLER, ~anova(.))
names(anovasIPrPLER) <- c("Year 1 Summer", "Year 1 Fall", "Year 2 Summer", "Year 2 Fall")


# Function to format p-values as stars
format_p_value <- function(p_val) {
  stars <- ifelse(p_val < 0.001, "***", ifelse(p_val < 0.01, "**", ifelse(p_val < 0.05, "*", "")))
  return(stars)
}

# Apply the function to your ANOVA results
IPrPLER_stars_tibble <- map(anovasIPrPLER, as_tibble, rownames="term") %>%
  bind_rows(.id = "model") %>%
  mutate(stars = map_chr(`Pr(>F)`, format_p_value))%>%
  mutate(term = ifelse(term == "P", "E", term)) %>%
  mutate(term = ifelse(term == "N:P", "N:E", term))

# Print the tibble
print(IPrPLER_stars_tibble)

IPrPLER_stars <-IPrPLER_stars_tibble |> 
  select(model, term, stars) |>
  pivot_wider(names_from = term, values_from = stars)

gt_IPrPLER <- gt(IPrPLER_stars)
gt_IPrPLER  |> gtsave("gt_IPrPLER .png", expand = 10)
```
#APrPLER anovas
```{r}
Year1SummerAlfPrPLER<-modAPrPLERXS
Year1FallAlfPrPLER<-modAPrPLERXF1
Year2SummerAlfPrPLER<-modAPrPLERYS1
Year2FallAlfPrPLER<-modAPrPLERYF1

my_modelsAPrPLER <- c(Year1SummerAlfPrPLER,Year1FallAlfPrPLER,Year2SummerAlfPrPLER,Year2FallAlfPrPLER)
anovasAPrPLER <- purrr::map(my_modelsAPrPLER, ~anova(.))
names(anovasAPrPLER) <- c("Year 1 Summer", "Year 1 Fall", "Year 2 Summer", "Year 2 Fall")


# Function to format p-values as stars
format_p_value <- function(p_val) {
  stars <- ifelse(p_val < 0.001, "***", ifelse(p_val < 0.01, "**", ifelse(p_val < 0.05, "*", "")))
  return(stars)
}

# Apply the function to your ANOVA results
APrPLER_stars_tibble <- map(anovasAPrPLER, as_tibble, rownames="term") %>%
  bind_rows(.id = "model") %>%
  mutate(stars = map_chr(`Pr(>F)`, format_p_value))%>%
  mutate(term = ifelse(term == "P", "E", term)) %>%
  mutate(term = ifelse(term == "N:P", "N:E", term))

# Print the tibble
print(APrPLER_stars_tibble)

APrPLER_stars <-APrPLER_stars_tibble |> 
  select(model, term, stars) |>
  pivot_wider(names_from = term, values_from = stars)

gt_APrPLER <- gt(APrPLER_stars)
gt_APrPLER  |> gtsave("gt_APrPLER .png", expand = 10)
```
#GPLER anovas 
```{r}
modGPLERY1

my_modelsGPLER <- c(modGPLERX1, modGPLERY1)
anovasGPLER <- purrr::map(my_modelsGPLER, ~anova(.))
names(anovasGPLER) <- c("Year 1", "Year 2")


# Function to format p-values as stars
format_p_value <- function(p_val) {
  stars <- ifelse(p_val < 0.001, "***", ifelse(p_val < 0.01, "**", ifelse(p_val < 0.05, "*", "")))
  return(stars)
}

# Apply the function to your ANOVA results
GPLER_stars_tibble <- map(anovasGPLER, as_tibble, rownames="term") %>%
  bind_rows(.id = "model") %>%
  mutate(stars = map_chr(`Pr(>F)`, format_p_value))%>%
  mutate(term = ifelse(term == "P", "E", term)) %>%
  mutate(term = ifelse(term == "N:P", "N:E", term))

# Print the tibble
print(GPLER_stars_tibble)

GPLER_stars <-GPLER_stars_tibble |> 
  select(model, term, stars) |>
  pivot_wider(names_from = term, values_from = stars)

gt_GPLER <- gt(GPLER_stars)
gt_GPLER  |> gtsave("gt_GPLER .png", expand = 10)
```
#all LER anovas easy print
```{r}
gt_TLER
gt_IPLER
gt_APLER
gt_IPrPLER
gt_APrPLER
gt_GPLER
```


#TFIRY anovas
```{r}
Year1SummerTFIRY<-modTFIRYXS1
Year1FALLTFIRY<-modTFIRYXF1
Year2SummerTFIRY<-modTFIRYYS1
Year2FallGrainTFIRY<-modTFIRYYF1

my_modelsTFIRY <- c(modTFIRYXS1, modTFIRYXF1, modTFIRYYS1, modTFIRYYF1)
anovasTFIRY <- purrr::map(my_modelsTFIRY, ~anova(.))
names(anovasTFIRY) <- c("Year 1 Summer", "Year 1 Fall", "Year 2 Summer", "Year 2 Fall")


# Function to format p-values as stars
format_p_value <- function(p_val) {
  stars <- ifelse(p_val < 0.001, "***", ifelse(p_val < 0.01, "**", ifelse(p_val < 0.05, "*", "")))
  return(stars)
}

# Apply the function to your ANOVA results
TFIRY_stars_tibble <- map(anovasTFIRY, as_tibble, rownames="term") %>%
  bind_rows(.id = "model") %>%
  mutate(stars = map_chr(`Pr(>F)`, format_p_value))%>%
  mutate(term = ifelse(term == "P", "E", term)) %>%
  mutate(term = ifelse(term == "N:P", "N:E", term))

# Print the tibble
print(TFIRY_stars_tibble)

TFIRY_stars <-TFIRY_stars_tibble |> 
  select(model, term, stars) |>
  pivot_wider(names_from = term, values_from = stars)

gt_TFIRY <- gt(TFIRY_stars)
```
#TFARY anovas
```{r}
Year1SummerTFARY<-modTFARYXS1
Year1FALLTFARY<-modTFARYXF1
Year2SummerTFARY<-modTFARYYS1
Year2FallGrainTFARY<-modTFARYYF1

my_modelsTFARY <- c(modTFARYXS1, modTFARYXF1, modTFARYYS1, modTFARYYF1)
anovasTFARY <- purrr::map(my_modelsTFARY, ~anova(.))
names(anovasTFARY) <- c("Year 1 Summer", "Year 1 Fall", "Year 2 Summer", "Year 2 Fall")


# Function to format p-values as stars
format_p_value <- function(p_val) {
  stars <- ifelse(p_val < 0.001, "***", ifelse(p_val < 0.01, "**", ifelse(p_val < 0.05, "*", "")))
  return(stars)
}

# Apply the function to your ANOVA results
TFARY_stars_tibble <- map(anovasTFARY, as_tibble, rownames="term") %>%
  bind_rows(.id = "model") %>%
  mutate(stars = map_chr(`Pr(>F)`, format_p_value))%>%
  mutate(term = ifelse(term == "P", "E", term)) %>%
  mutate(term = ifelse(term == "N:P", "N:E", term))

# Print the tibble
print(TFARY_stars_tibble)

TFARY_stars <-TFARY_stars_tibble |> 
  select(model, term, stars) |>
  pivot_wider(names_from = term, values_from = stars)

gt_TFARY <- gt(TFARY_stars)
```
#ARY anovas
```{r}
Year1SummerARY<-modARYXS1
Year1FALLARY<-modARYXF1
Year2SummerARY<-modARYYS1
Year2FallGrainARY<-modARYYF1

my_modelsARY <- c(modARYXS1, modARYXF1, modARYYS1, modARYYF1)
anovasARY <- purrr::map(my_modelsARY, ~anova(.))
names(anovasARY) <- c("Year 1 Summer", "Year 1 Fall", "Year 2 Summer", "Year 2 Fall")


# Function to format p-values as stars
format_p_value <- function(p_val) {
  stars <- ifelse(p_val < 0.001, "***", ifelse(p_val < 0.01, "**", ifelse(p_val < 0.05, "*", "")))
  return(stars)
}

# Apply the function to your ANOVA results
ARY_stars_tibble <- map(anovasARY, as_tibble, rownames="term") %>%
  bind_rows(.id = "model") %>%
  mutate(stars = map_chr(`Pr(>F)`, format_p_value))%>%
  mutate(term = ifelse(term == "P", "E", term)) %>%
  mutate(term = ifelse(term == "N:P", "N:E", term))

# Print the tibble
print(ARY_stars_tibble)

ARY_stars <-ARY_stars_tibble |> 
  select(model, term, stars) |>
  pivot_wider(names_from = term, values_from = stars)

gt_ARY <- gt(ARY_stars)
```
#IRYanovas
```{r}
my_modelsIRY <- c(modIRYXS1, modIRYXF1, modIRYYS1, modIRYYF1)
anovasIRY <- purrr::map(my_modelsIRY, ~anova(.))
names(anovasIRY) <- c("Year 1 Summer", "Year 1 Fall", "Year 2 Summer", "Year 2 Fall")


# Function to format p-values as stars
format_p_value <- function(p_val) {
  stars <- ifelse(p_val < 0.001, "***", ifelse(p_val < 0.01, "**", ifelse(p_val < 0.05, "*", "")))
  return(stars)
}

# Apply the function to your ANOVA results
IRY_stars_tibble <- map(anovasIRY, as_tibble, rownames="term") %>%
  bind_rows(.id = "model") %>%
  mutate(stars = map_chr(`Pr(>F)`, format_p_value))%>%
  mutate(term = ifelse(term == "P", "E", term)) %>%
  mutate(term = ifelse(term == "N:P", "N:E", term))

# Print the tibble
print(IRY_stars_tibble)

IRY_stars <-IRY_stars_tibble |> 
  select(model, term, stars) |>
  pivot_wider(names_from = term, values_from = stars)

gt_IRY <- gt(IRY_stars)
```
#Grain RY anovas
```{r}
modGRYX1
my_modelsGRY <- c(modGRYX1, modGRYY1)
anovasGRY <- purrr::map(my_modelsGRY, ~anova(.))
names(anovasGRY) <- c("Year 1", "Year 2")


# Function to format p-values as stars
format_p_value <- function(p_val) {
  stars <- ifelse(p_val < 0.001, "***", ifelse(p_val < 0.01, "**", ifelse(p_val < 0.05, "*", "")))
  return(stars)
}

# Apply the function to your ANOVA results
GRY_stars_tibble <- map(anovasGRY, as_tibble, rownames="term") %>%
  bind_rows(.id = "model") %>%
  mutate(stars = map_chr(`Pr(>F)`, format_p_value))%>%
  mutate(term = ifelse(term == "P", "E", term)) %>%
  mutate(term = ifelse(term == "N:P", "N:E", term))

# Print the tibble
print(GRY_stars_tibble)

GRY_stars <-GRY_stars_tibble |> 
  select(model, term, stars) |>
  pivot_wider(names_from = term, values_from = stars)

gt_GRY <- gt(GRY_stars)
```

#RY anovas easy print
```{r}
gt_GRY
gt_TFIRY
gt_TFARY
gt_IRY
gt_ARY

gt_GRY  |> gtsave("gt_GRY .png", expand = 10)
gt_TFIRY  |> gtsave("gt_TFIRY .png", expand = 10)
gt_TFARY  |> gtsave("gt_TFARY .png", expand = 10)
gt_IRY  |> gtsave("gt_IRY .png", expand = 10)
gt_ARY  |> gtsave("gt_ARY .png", expand = 10)
```


#IWG CP anovas 
```{r}
my_modelsNICP <- c(modNICPFQXS1, modNICPFQXF1, modNICPFQYS1, modNICPFQYF1)
anovasNICP <- purrr::map(my_modelsNICP, ~anova(.))
names(anovasNICP) <- c("Year 1 Summer", "Year 1 Fall",  "Year 2 Summer", "Year 2 Fall")


# Function to format p-values as stars
format_p_value <- function(p_val) {
  stars <- ifelse(p_val < 0.001, "***", ifelse(p_val < 0.01, "**", ifelse(p_val < 0.05, "*", "")))
  return(stars)
}

# Apply the function to your ANOVA results
NICP_stars_tibble <- map(anovasNICP, as_tibble, rownames="term") %>%
  bind_rows(.id = "model") %>%
  mutate(stars = map_chr(`Pr(>F)`, format_p_value))

NICP_stars_tibble <- NICP_stars_tibble %>%
  mutate(term = ifelse(term == "P", "E", term)) %>%
  mutate(term = ifelse(term == "N:P", "N:E", term))%>%
  mutate(term = ifelse(term == "P:C", "E:C", term))%>%
  mutate(term = ifelse(term == "N:P:C", "N:E:C", term))

# Print the tibble
print(NICP_stars_tibble)

NICP_stars <-NICP_stars_tibble |> 
  select(model, term, stars) |>
  pivot_wider(names_from = term, values_from = stars)

gt_NICP <- gt(NICP_stars)
```
#IWG RFV anovas 
```{r}
my_modelsNIRFV <- c(modNIRFVFQXS1, modNIRFVFQXF1, modNIRFVFQYS1, modNIRFVFQYF1)
anovasNIRFV <- purrr::map(my_modelsNIRFV, ~anova(.))
names(anovasNIRFV) <- c("Year 1 Summer", "Year 1 Fall",  "Year 2 Summer", "Year 2 Fall")


# Function to format p-values as stars
format_p_value <- function(p_val) {
  stars <- ifelse(p_val < 0.001, "***", ifelse(p_val < 0.01, "**", ifelse(p_val < 0.05, "*", "")))
  return(stars)
}

# Apply the function to your ANOVA results
NIRFV_stars_tibble <- map(anovasNIRFV, as_tibble, rownames="term") %>%
  bind_rows(.id = "model") %>%
  mutate(stars = map_chr(`Pr(>F)`, format_p_value))

NIRFV_stars_tibble <- NIRFV_stars_tibble %>%
  mutate(term = ifelse(term == "P", "E", term)) %>%
  mutate(term = ifelse(term == "N:P", "N:E", term))%>%
  mutate(term = ifelse(term == "P:C", "E:C", term))%>%
  mutate(term = ifelse(term == "N:P:C", "N:E:C", term))

# Print the tibble
print(NIRFV_stars_tibble)

NIRFV_stars <-NIRFV_stars_tibble |> 
  select(model, term, stars) |>
  pivot_wider(names_from = term, values_from = stars)

gt_NIRFV <- gt(NIRFV_stars)
```
#Alf CP anovas 
```{r}
my_modelsNACP <- c(modNACPFQXS1, modNACPFQXF1, modNACPFQYS1, modNACPFQYF1)
anovasNACP <- purrr::map(my_modelsNACP, ~anova(.))
names(anovasNACP) <- c("Year 1 Summer", "Year 1 Fall",  "Year 2 Summer", "Year 2 Fall")


# Function to format p-values as stars
format_p_value <- function(p_val) {
  stars <- ifelse(p_val < 0.001, "***", ifelse(p_val < 0.01, "**", ifelse(p_val < 0.05, "*", "")))
  return(stars)
}

# Apply the function to your ANOVA results
NACP_stars_tibble <- map(anovasNACP, as_tibble, rownames="term") %>%
  bind_rows(.id = "model") %>%
  mutate(stars = map_chr(`Pr(>F)`, format_p_value))

NACP_stars_tibble <- NACP_stars_tibble %>%
  mutate(term = ifelse(term == "P", "E", term)) %>%
  mutate(term = ifelse(term == "N:P", "N:E", term))%>%
  mutate(term = ifelse(term == "P:C", "E:C", term))%>%
  mutate(term = ifelse(term == "N:P:C", "N:E:C", term))

# Print the tibble
print(NACP_stars_tibble)

NACP_stars <-NACP_stars_tibble |> 
  select(model, term, stars) |>
  pivot_wider(names_from = term, values_from = stars)

gt_NACP <- gt(NACP_stars)
```
#Alf RFV anovas 
```{r}
my_modelsNARFV <- c(modNARFVFQXS1, modNARFVFQXF1, modNARFVFQYS1, modNARFVFQYF1)
anovasNARFV <- purrr::map(my_modelsNARFV, ~anova(.))
names(anovasNARFV) <- c("Year 1 Summer", "Year 1 Fall",  "Year 2 Summer", "Year 2 Fall")


# Function to format p-values as stars
format_p_value <- function(p_val) {
  stars <- ifelse(p_val < 0.001, "***", ifelse(p_val < 0.01, "**", ifelse(p_val < 0.05, "*", "")))
  return(stars)
}

# Apply the function to your ANOVA results
NARFV_stars_tibble <- map(anovasNARFV, as_tibble, rownames="term") %>%
  bind_rows(.id = "model") %>%
  mutate(stars = map_chr(`Pr(>F)`, format_p_value))

NARFV_stars_tibble <- NARFV_stars_tibble %>%
  mutate(term = ifelse(term == "P", "E", term)) %>%
  mutate(term = ifelse(term == "N:P", "N:E", term))%>%
  mutate(term = ifelse(term == "P:C", "E:C", term))%>%
  mutate(term = ifelse(term == "N:P:C", "N:E:C", term))

# Print the tibble
print(NARFV_stars_tibble)

NARFV_stars <-NARFV_stars_tibble |> 
  select(model, term, stars) |>
  pivot_wider(names_from = term, values_from = stars)

gt_NARFV <- gt(NARFV_stars)

```
#Total CP anovas 
```{r}
modNTCPXS
my_modelsNTCP <- c(modNTCPXS,modNTCPXF,modNTCPYS,modNTCPYF)
anovasNTCP <- purrr::map(my_modelsNTCP, ~anova(.))
names(anovasNTCP) <- c("Year 1 Summer", "Year 1 Fall",  "Year 2 Summer", "Year 2 Fall")


# Function to format p-values as stars
format_p_value <- function(p_val) {
  stars <- ifelse(p_val < 0.001, "***", ifelse(p_val < 0.01, "**", ifelse(p_val < 0.05, "*", "")))
  return(stars)
}

# Apply the function to your ANOVA results
NTCP_stars_tibble <- map(anovasNTCP, as_tibble, rownames="term") %>%
  bind_rows(.id = "model") %>%
  mutate(stars = map_chr(`Pr(>F)`, format_p_value))

NTCP_stars_tibble <- NTCP_stars_tibble %>%
mutate(term = ifelse(term == "CROP", "C", term)) %>%
  mutate(term = ifelse(term == "P", "E", term)) %>%
  mutate(term = ifelse(term == "N:P", "N:E", term))%>%
  mutate(term = ifelse(term == "N:CROP", "N:C", term))%>%
  mutate(term = ifelse(term == "N:P:CROP", "N:E:C", term))%>%
  mutate(term = ifelse(term == "P:CROP", "E:C", term))

# Print the tibble
print(NTCP_stars_tibble)

NTCP_stars <-NTCP_stars_tibble |> 
  select(model, term, stars) |>
  pivot_wider(names_from = term, values_from = stars)

gt_NTCP <- gt(NTCP_stars)
```
#Total RFV anovas 
```{r}
my_modelsNTRFV <- c(modNTRFVXS1,modNTRFVXF1,modNTRFVYS1,modNTRFVYF1)
anovasNTRFV <- purrr::map(my_modelsNTRFV, ~anova(.))
names(anovasNTRFV) <- c("Year 1 Summer", "Year 1 Fall",  "Year 2 Summer", "Year 2 Fall")


# Function to format p-values as stars
format_p_value <- function(p_val) {
  stars <- ifelse(p_val < 0.001, "***", ifelse(p_val < 0.01, "**", ifelse(p_val < 0.05, "*", "")))
  return(stars)
}

# Apply the function to your ANOVA results
NTRFV_stars_tibble <- map(anovasNTRFV, as_tibble, rownames="term") %>%
  bind_rows(.id = "model") %>%
  mutate(stars = map_chr(`Pr(>F)`, format_p_value))

NTRFV_stars_tibble <- NTRFV_stars_tibble %>%
mutate(term = ifelse(term == "CROP", "C", term)) %>%
  mutate(term = ifelse(term == "P", "E", term)) %>%
  mutate(term = ifelse(term == "N:P", "N:E", term))%>%
  mutate(term = ifelse(term == "N:CROP", "N:C", term))%>%
  mutate(term = ifelse(term == "N:P:CROP", "N:E:C", term))%>%
  mutate(term = ifelse(term == "P:CROP", "E:C", term))

# Print the tibble
print(NTRFV_stars_tibble)

NTRFV_stars <-NTRFV_stars_tibble |> 
  select(model, term, stars) |>
  pivot_wider(names_from = term, values_from = stars)

gt_NTRFV <- gt(NTRFV_stars)
```
#Forage quality anovas easy print 
```{r}
gt_NICP
gt_NIRFV
gt_NACP
gt_NARFV
gt_NTCP
gt_NTRFV

gt_NICP  |> gtsave("gt_NICP .png", expand = 10)
gt_NIRFV  |> gtsave("gt_NIRFV .png", expand = 10)
gt_NACP  |> gtsave("gt_NACP .png", expand = 10)
gt_NARFV  |> gtsave("gt_NARFV .png", expand = 10)
gt_NTCP  |> gtsave("gt_NTCP .png", expand = 10)
gt_NTRFV  |> gtsave("gt_NTRFV .png", expand = 10)
```

#Grain anovas 
```{r}
my_modelsNG <- c(modNXG1, modNYG1, modNYGadj1)
anovasNG <- purrr::map(my_modelsNG, ~anova(.))
names(anovasNG) <- c("Year 1", "Year 2 (unadjusted)",  "Year 2 (adjusted with year 1 data)")


# Function to format p-values as stars
format_p_value <- function(p_val) {
  stars <- ifelse(p_val < 0.001, "***", ifelse(p_val < 0.01, "**", ifelse(p_val < 0.05, "*", "")))
  return(stars)
}

# Apply the function to your ANOVA results
NG_stars_tibble <- map(anovasNG, as_tibble, rownames="term") %>%
  bind_rows(.id = "model") %>%
  mutate(stars = map_chr(`Pr(>F)`, format_p_value))

NG_stars_tibble <- NG_stars_tibble %>%
  mutate(term = ifelse(term == "P", "E", term)) %>%
  mutate(term = ifelse(term == "N:P", "N:E", term))%>%
  mutate(term = ifelse(term == "P:C", "E:C", term))%>%
  mutate(term = ifelse(term == "N:P:C", "N:E:C", term))

# Print the tibble
print(NG_stars_tibble)

NG_stars <-NG_stars_tibble |> 
  select(model, term, stars) |>
  pivot_wider(names_from = term, values_from = stars)

gt_NG <- gt(NG_stars)

gt_NG |> gtsave("gt_NG.png", expand = 10)
```

#Forage yields ~NPC emmeans GOOD tables
```{r, eval= FALSE}
#TF
NXST1emm%>%
  select(-SE, -df)
NXFT1emm%>%
  select(-SE, -df)
NYST1emm%>%
  select(-SE, -df)
NYFT1emm%>%
  select(-SE, -df)
emmNT <- bind_rows(
  NXST1emm %>% select(N, P, C, response, lower.CL, upper.CL),
  NXFT1emm %>% select(N,P, C, response, lower.CL, upper.CL),
  NYST1emm %>% select(N,P, C, response, lower.CL, upper.CL),
  NYFT1emm %>% select(N,P, C, response, lower.CL, upper.CL),
  .id = "OriginalTable")
emmNT <- emmNT %>%
  arrange(OriginalTable, N, P, C)
colnames(emmNT)[colnames(emmNT) == "response"]<-"emmean"
emmNT <- emmNT  %>%
  mutate(Harvest = case_when(
    OriginalTable == 1 ~ "Year 1 Summer",
    OriginalTable == 2 ~ "Year 1 Fall",
    OriginalTable == 3 ~ "Year 2 Summer",
    OriginalTable == 4 ~ "Year 2 Fall",
    TRUE ~ as.character(OriginalTable)  # Default case if none of the conditions match
  ))
emmNT  <- emmNT  %>%
  select(-OriginalTable)
emmNT   <- emmNT  %>%
 select(Harvest, N, P, C, emmean, lower.CL, upper.CL)
colnames(emmNT ) <- c("Harvest",  "NRate", "Location", "CroppingSystem", "emmean", "CI.2.5", "CI.97.5")
emmNT  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)|> 
  collapse_rows(columns = 1:5, valign = "top") |>
  add_header_above(c("Total Forage Yield" = 7))

#I
NXSI1emm%>%
  select(-SE, -df)
NXFI1emm%>%
  select(-SE, -df)
NYSI1emm%>%
  select(-SE, -df)
NYFI1emm%>%
  select(-SE, -df)
emmNI <- bind_rows(
  NXSI1emm %>% select(N, P, C, response, lower.CL, upper.CL),
  NXFI1emm %>% select(N,P, C, response, lower.CL, upper.CL),
  NYSI1emm %>% select(N,P, C, response, lower.CL, upper.CL),
  NYFI1emm %>% select(N,P, C, response, lower.CL, upper.CL),
  .id = "OriginalTable")
emmNI <- emmNI %>%
  arrange(OriginalTable, N, P, C)
colnames(emmNI)[colnames(emmNI) == "response"]<-"emmean"
emmNI <- emmNI  %>%
  mutate(Harvest = case_when(
    OriginalTable == 1 ~ "Year 1 Summer",
    OriginalTable == 2 ~ "Year 1 Fall",
    OriginalTable == 3 ~ "Year 2 Summer",
    OriginalTable == 4 ~ "Year 2 Fall",
    TRUE ~ as.character(OriginalTable)  # Default case if none of the conditions match
  ))
emmNI  <- emmNI  %>%
  select(-OriginalTable)
emmNI   <- emmNI  %>%
 select(Harvest, N, P, C, emmean, lower.CL, upper.CL)
colnames(emmNI ) <- c("Harvest",  "NRate", "Location", "CroppingSystem", "emmean", "CI.2.5", "CI.97.5")
emmNI  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)|> 
  collapse_rows(columns = 1:5, valign = "top") |>
  add_header_above(c("IWG Forage Yield" = 7))

#A
NXSA1emm%>%
  select(-SE, -df)
NXFA1emm%>%
  select(-SE, -df)
NYSA1emm%>%
  select(-SE, -df)
NYFA1emm%>%
  select(-SE, -df)
emmNA <- bind_rows(
  NXSA1emm %>% select(N, P, C, response, lower.CL, upper.CL),
  NXFA1emm %>% select(N,P, C, response, lower.CL, upper.CL),
  NYSA1emm %>% select(N,P, C, response, lower.CL, upper.CL),
  NYFA1emm %>% select(N,P, C, response, lower.CL, upper.CL),
  .id = "OriginalTable")
emmNA <- emmNA %>%
  arrange(OriginalTable, N, P, C)
colnames(emmNA)[colnames(emmNA) == "response"]<-"emmean"
emmNA <- emmNA  %>%
  mutate(Harvest = case_when(
    OriginalTable == 1 ~ "Year 1 Summer",
    OriginalTable == 2 ~ "Year 1 Fall",
    OriginalTable == 3 ~ "Year 2 Summer",
    OriginalTable == 4 ~ "Year 2 Fall",
    TRUE ~ as.character(OriginalTable)  # Default case if none of the conditions match
  ))
emmNA  <- emmNA  %>%
  select(-OriginalTable)
emmNA   <- emmNA  %>%
 select(Harvest, N, P, C, emmean, lower.CL, upper.CL)
colnames(emmNA ) <- c("Harvest",  "NRate", "Location", "CroppingSystem", "emmean", "CI.2.5", "CI.97.5")
emmNA  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)|> 
  collapse_rows(columns = 1:5, valign = "top") |>
  add_header_above(c("Alfalfa Forage Yield" = 7))


```
#Total forage ~N emmeans table GOOD TABLE 
```{r, eval= FALSE}
cld_dataNXSTN%>%
  select(-SE, -df)
cld_dataNXFTN%>%
  select(-SE, -df)
cld_dataNYSTN%>%
  select(-SE, -df)
cld_dataNYFTN%>%
  select(-SE, -df)

cldNTFN <- bind_rows(
  cld_dataNXSTN %>% select(N, response, lower.CL, upper.CL, .group),
  cld_dataNXFTN %>% select(N, response, lower.CL, upper.CL, .group),
  cld_dataNYSTN %>% select(N, response, lower.CL, upper.CL, .group),
  cld_dataNYFTN %>% select(N, response, lower.CL, upper.CL, .group),
  .id = "OriginalTable")
cldNTFN <- cldNTFN %>%
  arrange(OriginalTable, N)
colnames(cldNTFN)[colnames(cldNTFN) == "response"] <- "TF_yield_emmean"
cldNTFN  <- cldNTFN  %>%
  mutate(Harvest = case_when(
    OriginalTable == 1 ~ "Year 1 Summer",
    OriginalTable == 2 ~ "Year 1 Fall",
    OriginalTable == 3 ~ "Year 2 Summer",
    OriginalTable == 4 ~ "Year 2 Fall",
    TRUE ~ as.character(OriginalTable)  # Default case if none of the conditions match
  ))
cldNTFN  <- cldNTFN  %>%
  select(-OriginalTable)

cldNTFN  <- cldNTFN  %>%
  select(Harvest,N, TF_yield_emmean, lower.CL, upper.CL, .group)
colnames(cldNTFN) <- c("Harvest", "N Rate", "Total Forage Yield emmean", "CI.2.5", "CI.97.5", "Group")

cldNTFN |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)|> 
  collapse_rows(columns = 1:5, valign = "top")
```
#Total forage ~P emmeans table
```{r, eval= FALSE}
cld_dataNXSTP%>%
  select(-SE, -df)
cld_dataNXFTP%>%
  select(-SE, -df)
cld_dataNYSTP%>%
  select(-SE, -df)
cld_dataNYFTP%>%
  select(-SE, -df)

cldNTFN <- bind_rows(
  cld_dataNXSTN %>% select(N, response, lower.CL, upper.CL, .group),
  cld_dataNXFTN %>% select(N, response, lower.CL, upper.CL, .group),
  cld_dataNYSTN %>% select(N, response, lower.CL, upper.CL, .group),
  cld_dataNYFTN %>% select(N, response, lower.CL, upper.CL, .group),
  .id = "OriginalTable")
cldNTFN <- cldNTFN %>%
  arrange(OriginalTable, N)
colnames(cldNTFN)[colnames(cldNTFN) == "response"] <- "TF_yield_emmean"
cldNTFN  <- cldNTFN  %>%
  mutate(Harvest = case_when(
    OriginalTable == 1 ~ "Year 1 Summer",
    OriginalTable == 2 ~ "Year 1 Fall",
    OriginalTable == 3 ~ "Year 2 Summer",
    OriginalTable == 4 ~ "Year 2 Fall",
    TRUE ~ as.character(OriginalTable)  # Default case if none of the conditions match
  ))
cldNTFN  <- cldNTFN  %>%
  select(-OriginalTable)

cldNTFN  <- cldNTFN  %>%
  select(Harvest,N, TF_yield_emmean, lower.CL, upper.CL, .group)
colnames(cldNTFN) <- c("Harvest", "N Rate", "Total Forage Yield emmean", "CI.2.5", "CI.97.5", "Group")

cldNTFN |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)|> 
  collapse_rows(columns = 1:5, valign = "top")
```


***

Variety paper data stuff 

#making emmeans functions 
```{r}
# Define a 3 WAY function for year 1 summer
compute_emmeansVXS <- function(model_name) {
  # Get the model object using the provided name
  mod <- get(model_name)
  # Compute estimated marginal means
  emm <- emmeans(mod, specs = ~ V*P*C)
  emm <- update(emm, type = "response")
  # Summarize the results
  summary_emm <- summary(emm)
  # Convert to data frame
  emm_df <- as.data.frame(summary_emm)
  # Add additional columns
  emm_df <- emm_df %>%
    mutate(Year = "1", Harvest = "Summer")
  return(emm_df)}

# Define a 3 WAY  function for year 1 fall
compute_emmeansVXF <- function(model_name) {
  # Get the model object using the provided name
  mod <- get(model_name)
  # Compute estimated marginal means
  emm <- emmeans(mod, specs = ~ V*P*C)
  emm <- update(emm, type = "response")
  # Summarize the results
  summary_emm <- summary(emm)
  # Convert to data frame
  emm_df <- as.data.frame(summary_emm)
  # Add additional columns
  emm_df <- emm_df %>%
    mutate(Year = "1", Harvest = "Fall")
  return(emm_df)}

# Define a 3 WAY  function for year 2 Summer
compute_emmeansVYS <- function(model_name) {
  # Get the model object using the provided name
  mod <- get(model_name)
  # Compute estimated marginal means
  emm <- emmeans(mod, specs = ~ V*P*C)
  emm <- update(emm, type = "response")
  # Summarize the results
  summary_emm <- summary(emm)
  # Convert to data frame
  emm_df <- as.data.frame(summary_emm)
  # Add additional columns
  emm_df <- emm_df %>%
    mutate(Year = "2", Harvest = "Summer")
  return(emm_df)}

# Define a 3 WAY function for year 2 Fall
compute_emmeansVYF <- function(model_name) {
  # Get the model object using the provided name
  mod <- get(model_name)
  # Compute estimated marginal means
  emm <- emmeans(mod, specs = ~ V*P*C)
  emm <- update(emm, type = "response")
  # Summarize the results
  summary_emm <- summary(emm)
  # Convert to data frame
  emm_df <- as.data.frame(summary_emm)
  # Add additional columns
  emm_df <- emm_df %>%
    mutate(Year = "2", Harvest = "Fall")
  return(emm_df)}

# Define a VP function for year 1 summer
compute_emmeansVXS2 <- function(model_name) {
  # Get the model object using the provided name
  mod <- get(model_name)
  # Compute estimated marginal means
  emm <- emmeans(mod, specs = ~ V*P)
  emm <- update(emm, type = "response")
  # Summarize the results
  summary_emm <- summary(emm)
  # Convert to data frame
  emm_df <- as.data.frame(summary_emm)
  # Add additional columns
  emm_df <- emm_df %>%
    mutate(Year = "1", Harvest = "Summer")
  return(emm_df)}

# Define a VP  function for year 1 fall
compute_emmeansVXF2 <- function(model_name) {
  # Get the model object using the provided name
  mod <- get(model_name)
  # Compute estimated marginal means
  emm <- emmeans(mod, specs = ~ V*P)
  emm <- update(emm, type = "response")
  # Summarize the results
  summary_emm <- summary(emm)
  # Convert to data frame
  emm_df <- as.data.frame(summary_emm)
  # Add additional columns
  emm_df <- emm_df %>%
    mutate(Year = "1", Harvest = "Fall")
  return(emm_df)}

# Define a VP  function for year 2 Summer
compute_emmeansVYS2 <- function(model_name) {
  # Get the model object using the provided name
  mod <- get(model_name)
  # Compute estimated marginal means
  emm <- emmeans(mod, specs = ~ V*P)
  emm <- update(emm, type = "response")
  # Summarize the results
  summary_emm <- summary(emm)
  # Convert to data frame
  emm_df <- as.data.frame(summary_emm)
  # Add additional columns
  emm_df <- emm_df %>%
    mutate(Year = "2", Harvest = "Summer")
  return(emm_df)}

# Define a vP function for year 2 Fall
compute_emmeansVYF2 <- function(model_name) {
  # Get the model object using the provided name
  mod <- get(model_name)
  # Compute estimated marginal means
  emm <- emmeans(mod, specs = ~ V*P)
  emm <- update(emm, type = "response")
  # Summarize the results
  summary_emm <- summary(emm)
  # Convert to data frame
  emm_df <- as.data.frame(summary_emm)
  # Add additional columns
  emm_df <- emm_df %>%
    mutate(Year = "2", Harvest = "Fall")
  return(emm_df)}

```

#checking if there is an interaction effect b/w variety and nitrogen (run Response~Var*Nrate*P)
```{r}
#Grain year 1
modIntVXG<-lmer(G~V*N*P + (1|Rep), data=VdXSI)
anova(modIntVXG)
#Grain year 2 
modIntVYG<-lmer(G~V*N*P + (1|Rep), data=VdYSI)
anova(modIntVYG)
#Total forage year 1 summer
modIntVXST<-lmer(PlotTotForageKgHa~V*N*P + (1|Rep), data=VdXS)
anova(modIntVXST)
#Total forage year 1 fall
modIntVXFT<-lmer(PlotTotForageKgHa~V*N*P + (1|Rep), data=VdXF)
anova(modIntVXFT)
#Total forage year 2 summer (ISSINGULAR if you include P)
modIntVYST<-lmer(PlotTotForageKgHa~V*N + (1|Rep), data=VdYS)
anova(modIntVYST)
#Total forage year 2 fall
modIntVYFT<-lmer(PlotTotForageKgHa~V*N*P + (1|Rep), data=VdYF)
anova(modIntVYFT)
#IWG forage year 1 summer
modIntVXSI<-lmer(PlotIWGDryKgHa~V*N*P + (1|Rep), data=VdXSI)
anova(modIntVXSI)
#IWG forage year 1 fall (ISSINGULAR if you include P)
modIntVXFI<-lmer(PlotIWGDryKgHa~V*N + (1|Rep), data=VdXFI)
anova(modIntVXFI)
#IWG forage year 2 summer (ISSINGULAR if you include P)
modIntVYSI<-lmer(PlotIWGDryKgHa~V*N + (1|Rep), data=VdYSI)
anova(modIntVYSI)
#IWG forage year 2 fall
modIntVYFI<-lmer(PlotIWGDryKgHa~V*N*P + (1|Rep), data=VdYFI)
anova(modIntVYFI)
#Alf forage year 1 summer
modIntVXSA<-lmer(PlotAlfDryKgHa~V*N*P + (1|Rep), data=VdXSA)
anova(modIntVXSA)
#Alf forage year 1 fall
modIntVXFA<-lmer(PlotAlfDryKgHa~V*N*P + (1|Rep), data=VdXFA)
anova(modIntVXFA)
#Alf forage year 2 summer (ISSINGULAR if you include P)
modIntVYSA<-lmer(PlotAlfDryKgHa~V*N + (1|Rep), data=VdYSA)
anova(modIntVYSA)
#Alf forage year 2 fall (ISSINGULAR if you include P)
modIntVYFA<-lmer(PlotAlfDryKgHa~V*N + (1|Rep), data=VdYFA)
anova(modIntVYFA)

#Above here, there is NO interaction effect between V and N. 

#IWG forage quality year 1 summer 
#IWG forage quality year 1 fall 
#IWG forage quality year 2 summer 
#IWG forage quality year 2 fall 
#ALF forage quality year 1 summer 
#ALF forage quality year 1 fall 
#ALF forage quality year 2 summer 
#ALF forage quality year 2 fall

```
#Variety data isolation for trying analysis with monocultures
```{r}
#reclaiming Vd80 as both 80 and 0 nrates without having to change all the data sources.
Vd80<-data2[data2$NRate != "40" & data2$NRate != "120" & data2$NRate != "160",]

#remove Alf monoculture plots
Vd80I<-Vd80[Vd80$Crop1 != "Shockwave",]
Vd80I<-Vd80I[Vd80I$Crop1 != "Higest",]
Vd80I<-Vd80I[Vd80I$Crop1 != "WL",]

#remove IWG monoculture plots 
Vd80noI<- Vd80[Vd80$Crop1 != "IWG",]

#remove all monoculture plots 
V80inter<-Vd80[Vd80$C != "monoculture",]
V80interX<-V80inter[V80inter$YearCode == "X",]
V80interY<-V80inter[V80inter$YearCode == "Y",]
V80interXS<-V80interX[V80interX$Harvest == "Summer",]
V80interXF<-V80interX[V80interX$Harvest == "Fall",]
V80interYS<-V80interY[V80interY$Harvest == "Summer",]
V80interYF<-V80interY[V80interY$Harvest == "Fall",]

#Variety Year isolation
V80X<-Vd80[Vd80$YearCode == "X",]
V80Y<-Vd80[Vd80$YearCode == "Y",]

#Variety Harvest isolation 
V80XS<-V80X[V80X$Harvest == "Summer",]
V80XF<-V80X[V80X$Harvest == "Fall",]

V80YS<-V80Y[V80Y$Harvest == "Summer",]
V80YF<-V80Y[V80Y$Harvest == "Fall",]

#Variety IWG vs ALF isolation 
V80XSI<-V80XS[V80XS$Crop1 != "Shockwave" ,] 
V80XSI<-V80XSI[V80XSI$Crop1 != "Higest" ,] 
V80XSI<-V80XSI[V80XSI$Crop1 != "WL" ,] 
V80XSA<-V80XS[V80XS$Crop1 != "IWG",]

V80XFI<-V80XF[V80XF$Crop1 != "Shockwave" ,]
V80XFI<-V80XFI[V80XFI$Crop1 != "Higest" ,]
V80XFI<-V80XFI[V80XFI$Crop1 != "WL" ,]
V80XFA<-V80XF[V80XF$Crop1 != "IWG",]

V80YSI<-V80YS[V80YS$Crop1 != "Shockwave" ,]
V80YSI<-V80YSI[V80YSI$Crop1 != "Higest" ,]
V80YSI<-V80YSI[V80YSI$Crop1 != "WL" ,]
V80YSA<-V80YS[V80YS$Crop1 != "IWG",]

V80YFI<-V80YF[V80YF$Crop1 != "Shockwave" ,]
V80YFI<-V80YFI[V80YFI$Crop1 != "Higest" ,]
V80YFI<-V80YFI[V80YFI$Crop1 != "WL" ,]
V80YFA<-V80YF[V80YF$Crop1 != "IWG",]
```
#V Grain PLER math year 1 
```{r}
Vd80IS<-Vd80I[Vd80I$Harvest == "Summer",]
Vd80IS$G<-as.numeric(Vd80IS$G)

#Shockwave
  #80
V80GLERSW <- Vd80IS %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    PartialLERG = (G[Treatment == 12]) / (G[Treatment == 7]))
V80GLERSW <- V80GLERSW %>%
  mutate(Variety = "Shockwave")
print(V80GLERSW)
  #0
V0GLERSW <- Vd80IS %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    PartialLERG = (G[Treatment == 10]) / (G[Treatment == 5]))
V0GLERSW <- V0GLERSW %>%
  mutate(Variety = "Shockwave")
print(V0GLERSW)

#Higest
  #80
V80GLERH <- Vd80IS %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    PartialLERG = (G[Treatment == 2]) / (G[Treatment == 7]))
V80GLERH <- V80GLERH %>%
  mutate(Variety = "Higest")
print(V80GLERH)
  #0
V0GLERH <- Vd80IS %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    PartialLERG = (G[Treatment == 1]) / (G[Treatment == 5]))
V0GLERH <- V0GLERH %>%
  mutate(Variety = "Higest")
print(V0GLERH)

#WL
  #80
V80GLERWL <- Vd80IS %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    PartialLERG = (G[Treatment == 21]) / (G[Treatment == 7]))
V80GLERWL <- V80GLERWL %>%
  mutate(Variety = "WL")
print(V80GLERWL)
  #0
V0GLERWL <- Vd80IS %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    PartialLERG = (G[Treatment == 20]) / (G[Treatment == 5]))
V0GLERWL <- V0GLERWL %>%
  mutate(Variety = "WL")
print(V0GLERWL)

#combine tibbles 
V80GPLER <- bind_rows(
  V80GLERSW %>% select(Rep, P, YearCode, Harvest, Variety, PartialLERG),
  V80GLERH %>% select(Rep, P, YearCode, Harvest, Variety, PartialLERG),
  V80GLERWL %>% select(Rep, P, YearCode, Harvest, Variety, PartialLERG),
  V0GLERSW %>% select(Rep, P, YearCode, Harvest, Variety, PartialLERG),
  V0GLERH %>% select(Rep, P, YearCode, Harvest, Variety, PartialLERG),
  V0GLERWL %>% select(Rep, P, YearCode, Harvest, Variety, PartialLERG)
)
V80GPLER  <- na.omit(V80GPLER)
print(V80GPLER)


#fixing the MN situation 
#X2023MNGrainDeHulledKgHa is where the MN X grain data is.. maybe just do its bits seperately and then join them into the tibble at the end?? 
Vd80ISmn<-Vd80IS[Vd80IS$Location == "MN",]
Vd80ISmn$Gr<-Vd80ISmn$X2023MNGrainDeHulledKgHa

#Shockwave
  #80
V80GLERSWmn <- Vd80ISmn %>%
  group_by(Rep,YearCode, Harvest) %>%
  reframe(
    PartialLERG = (Gr[Treatment == 12]) / (Gr[Treatment == 7]))
V80GLERSWmn <- V80GLERSWmn %>%
  mutate(Variety = "Shockwave")
  #0
V0GLERSWmn <- Vd80ISmn %>%
  group_by(Rep,YearCode, Harvest) %>%
  reframe(
    PartialLERG = (Gr[Treatment == 10]) / (Gr[Treatment == 5]))
V0GLERSWmn <- V0GLERSWmn %>%
  mutate(Variety = "Shockwave")

#Higest
  #80
V80GLERHmn <- Vd80ISmn %>%
  group_by(Rep, YearCode, Harvest) %>%
  reframe(
    PartialLERG = (Gr[Treatment == 2]) / (Gr[Treatment == 7]))
V80GLERHmn <- V80GLERHmn %>%
  mutate(Variety = "Higest")
  #0
V0GLERHmn <- Vd80ISmn %>%
  group_by(Rep,YearCode, Harvest) %>%
  reframe(
    PartialLERG = (Gr[Treatment == 1]) / (Gr[Treatment == 5]))
V0GLERHmn <- V0GLERHmn %>%
  mutate(Variety = "Higest")

#WL
  #80
V80GLERWLmn <- Vd80ISmn %>%
  group_by(Rep,YearCode, Harvest) %>%
  reframe(
    PartialLERG = (Gr[Treatment == 21]) / (Gr[Treatment == 7]))
V80GLERWLmn <- V80GLERWLmn %>%
  mutate(Variety = "WL")
  #0
V0GLERWLmn <- Vd80ISmn %>%
  group_by(Rep,YearCode, Harvest) %>%
  reframe(
    PartialLERG = (Gr[Treatment == 20]) / (Gr[Treatment == 5]))
V0GLERWLmn <- V0GLERWLmn %>%
  mutate(Variety = "WL")

#combine tibbles 
V80GPLERmn <- bind_rows(
  V80GLERSWmn %>% select(Rep, YearCode, Harvest, Variety, PartialLERG),
  V80GLERHmn %>% select(Rep, YearCode, Harvest, Variety, PartialLERG),
  V80GLERWLmn %>% select(Rep, YearCode, Harvest, Variety, PartialLERG),
  V0GLERSWmn %>% select(Rep, YearCode, Harvest, Variety, PartialLERG),
  V0GLERHmn %>% select(Rep, YearCode, Harvest, Variety, PartialLERG),
  V0GLERWLmn %>% select(Rep, YearCode, Harvest, Variety, PartialLERG)
)
V80GPLERmn  <- na.omit(V80GPLERmn)
V80GPLERmn<- V80GPLERmn %>%
  mutate(P= "MN")

V80GPLER <- bind_rows(
  V80GPLER %>% select(Rep, P, YearCode, Harvest, Variety, PartialLERG),
  V80GPLERmn %>% select(Rep, P, YearCode, Harvest, Variety, PartialLERG))


```

#V Grain PLER math year 2 (adjusted values)
```{r}
DATA31$GAdjY<-as.numeric(DATA31$GAdjY)
#Shockwave
  #80
V80GLERSWY <- DATA31 %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    PartialLERG = (GAdjY[Treatment == 12]) / (GAdjY[Treatment == 7]))
print(V80GLERSWY)
V80GLERSWY <- V80GLERSWY %>%
  mutate(Variety = "Shockwave")
print(V80GLERSWY)
  #0
V0GLERSWY <- DATA31 %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    PartialLERG = (GAdjY[Treatment == 10]) / (GAdjY[Treatment == 5]))
V0GLERSWY <- V0GLERSWY %>%
  mutate(Variety = "Shockwave")
print(V0GLERSWY)

#Higest
  #80
V80GLERHY <- DATA31 %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    PartialLERG = (GAdjY[Treatment == 2]) / (GAdjY[Treatment == 7]))
V80GLERHY <- V80GLERHY %>%
  mutate(Variety = "Higest")
print(V80GLERHY)
  #0
V0GLERHY <- DATA31 %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    PartialLERG = (GAdjY[Treatment == 1]) / (GAdjY[Treatment == 5]))
V0GLERHY <- V0GLERHY %>%
  mutate(Variety = "Higest")
print(V0GLERHY)

#WL
  #80
V80GLERWLY <- DATA31 %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    PartialLERG = (GAdjY[Treatment == 21]) / (GAdjY[Treatment == 7]))
V80GLERWLY <- V80GLERWLY %>%
  mutate(Variety = "WL")
print(V80GLERWLY)
  #0
V0GLERWLY <- DATA31 %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    PartialLERG = (GAdjY[Treatment == 20]) / (GAdjY[Treatment == 5]))
V0GLERWLY <- V0GLERWLY %>%
  mutate(Variety = "WL")
print(V0GLERWLY)

#combine tibbles 
V80GPLERY <- bind_rows(
  V80GLERSWY %>% select(Rep, P, YearCode, Harvest, Variety, PartialLERG),
  V80GLERHY %>% select(Rep, P, YearCode, Harvest, Variety, PartialLERG),
  V80GLERWLY %>% select(Rep, P, YearCode, Harvest, Variety, PartialLERG),
  V0GLERSWY %>% select(Rep, P, YearCode, Harvest, Variety, PartialLERG),
  V0GLERHY %>% select(Rep, P, YearCode, Harvest, Variety, PartialLERG),
  V0GLERWLY %>% select(Rep, P, YearCode, Harvest, Variety, PartialLERG)
)
#V80GPLERY  <- na.omit(V80GPLERY)
print(V80GPLERY)

```
#V Grain PLER math year 2 (unadjusted values)
```{r}
Vd80IS$PlotThreshedGrainKgHa<-as.numeric(Vd80IS$PlotThreshedGrainKgHa)
Vd80ISY<-Vd80IS[Vd80IS$YearCode == "Y",]
#Shockwave
  #80
V80GLERSWY2 <- Vd80ISY %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    PartialLERG = (PlotThreshedGrainKgHa[Treatment == 12]) / (PlotThreshedGrainKgHa[Treatment == 7]))
print(V80GLERSWY2)
V80GLERSWY2 <- V80GLERSWY2 %>%
  mutate(Variety = "Shockwave")
  #0
V0GLERSWY2 <- Vd80ISY %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    PartialLERG = (PlotThreshedGrainKgHa[Treatment == 10]) / (PlotThreshedGrainKgHa[Treatment == 5]))
V0GLERSWY2 <- V0GLERSWY2 %>%
  mutate(Variety = "Shockwave")

#Higest
  #80
V80GLERHY2 <- Vd80ISY %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    PartialLERG = (PlotThreshedGrainKgHa[Treatment == 2]) / (PlotThreshedGrainKgHa[Treatment == 7]))
V80GLERHY2 <- V80GLERHY2 %>%
  mutate(Variety = "Higest")
  #0
V0GLERHY2 <- Vd80ISY %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    PartialLERG = (PlotThreshedGrainKgHa[Treatment == 1]) / (PlotThreshedGrainKgHa[Treatment == 5]))
V0GLERHY2 <- V0GLERHY2 %>%
  mutate(Variety = "Higest")

#WL
  #80
V80GLERWLY2 <- Vd80ISY %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    PartialLERG = (PlotThreshedGrainKgHa[Treatment == 21]) / (PlotThreshedGrainKgHa[Treatment == 7]))
V80GLERWLY2 <- V80GLERWLY2 %>%
  mutate(Variety = "WL")

  #0
V0GLERWLY2 <- Vd80ISY %>%
  group_by(Rep, P, YearCode, Harvest) %>%
  reframe(
    PartialLERG = (PlotThreshedGrainKgHa[Treatment == 20]) / (PlotThreshedGrainKgHa[Treatment == 5]))
V0GLERWLY2 <- V0GLERWLY2 %>%
  mutate(Variety = "WL")

#combine tibbles 
V80GPLERY2 <- bind_rows(
  V80GLERSWY2 %>% select(Rep, P, YearCode, Harvest, Variety, PartialLERG),
  V80GLERHY2 %>% select(Rep, P, YearCode, Harvest, Variety, PartialLERG),
  V80GLERWLY2 %>% select(Rep, P, YearCode, Harvest, Variety, PartialLERG),
  V0GLERSWY2 %>% select(Rep, P, YearCode, Harvest, Variety, PartialLERG),
  V0GLERHY2 %>% select(Rep, P, YearCode, Harvest, Variety, PartialLERG),
  V0GLERWLY2 %>% select(Rep, P, YearCode, Harvest, Variety, PartialLERG)
)
V80GPLERY2  <- na.omit(V80GPLERY2)
print(V80GPLERY2)

```

# V Alf PLER math 
```{r}
#Shockwave
  #80
V80ALERSW <- Vd80 %>%
  group_by(Rep, P, YearCode, Harvest, N) %>%
  reframe(
    PartialLERA = (PlotAlfDryKgHa[Treatment == 12]) / (PlotAlfDryKgHa[Treatment == 17]))
V80ALERSW <- V80ALERSW %>%
  mutate(Variety = "Shockwave")
print(V80ALERSW)
  #0
V0ALERSW <- Vd80 %>%
  group_by(Rep, P, YearCode, Harvest, N) %>%
  reframe(
    PartialLERA = (PlotAlfDryKgHa[Treatment == 10]) / (PlotAlfDryKgHa[Treatment == 15]))
V0ALERSW <- V0ALERSW %>%
  mutate(Variety = "Shockwave")
print(V0ALERSW)

#Higest
  #80
V80ALERH <- Vd80 %>%
  group_by(Rep, P, YearCode, Harvest, N) %>%
  reframe(
    PartialLERA = (PlotAlfDryKgHa[Treatment == 2]) / (PlotAlfDryKgHa[Treatment == 4]))
V80ALERH <- V80ALERH %>%
  mutate(Variety = "Higest")
print(V80ALERH)
  #0
V0ALERH <- Vd80 %>%
  group_by(Rep, P, YearCode, Harvest, N) %>%
  reframe(
    PartialLERA = (PlotAlfDryKgHa[Treatment == 1]) / (PlotAlfDryKgHa[Treatment == 3]))
V0ALERH <- V0ALERH %>%
  mutate(Variety = "Higest")
print(V0ALERH)

#WL
  #80
V80ALERWL <- Vd80 %>%
  group_by(Rep, P, YearCode, Harvest, N) %>%
  reframe(
    PartialLERA = (PlotAlfDryKgHa[Treatment == 21]) / (PlotAlfDryKgHa[Treatment == 23]))
V80ALERWL <- V80ALERWL %>%
  mutate(Variety = "WL")
print(V80ALERWL)
  #0
V0ALERWL <- Vd80 %>%
  group_by(Rep, P, YearCode, Harvest, N) %>%
  reframe(
    PartialLERA = (PlotAlfDryKgHa[Treatment == 20]) / (PlotAlfDryKgHa[Treatment == 22]))
V0ALERWL <- V0ALERWL %>%
  mutate(Variety = "WL")
print(V0ALERWL)

#combine tibbles 
V80APLER <- bind_rows(
  V80ALERSW %>% select(Rep, P, YearCode, Harvest, Variety, PartialLERA, N),
  V80ALERH %>% select(Rep, P, YearCode, Harvest, Variety, PartialLERA, N),
  V80ALERWL %>% select(Rep, P, YearCode, Harvest, Variety, PartialLERA, N), 
  V0ALERSW %>% select(Rep, P, YearCode, Harvest, Variety, PartialLERA, N),
  V0ALERH %>% select(Rep, P, YearCode, Harvest, Variety, PartialLERA, N),
  V0ALERWL %>% select(Rep, P, YearCode, Harvest, Variety, PartialLERA, N)
)
V80APLER  <- na.omit(V80APLER )
V80APLER <- V80APLER %>%
  mutate(type = "Partial")
print(V80APLER)
```
# V IWG PLER math
```{r}
#Shockwave
  #80
V80ILERSW <- Vd80 %>%
  group_by(Rep, P, YearCode, Harvest, N) %>%
  reframe(
    PartialLERI = (PlotIWGDryKgHa[Treatment == 12]) / (PlotIWGDryKgHa[Treatment == 7]))
V80ILERSW <- V80ILERSW %>%
  mutate(Variety = "Shockwave")
print(V80ILERSW)
  #0
V0ILERSW <- Vd80 %>%
  group_by(Rep, P, YearCode, Harvest, N) %>%
  reframe(
    PartialLERI = (PlotIWGDryKgHa[Treatment == 10]) / (PlotIWGDryKgHa[Treatment == 5]))
V0ILERSW <- V0ILERSW %>%
  mutate(Variety = "Shockwave")
print(V0ILERSW)
print(V80ILERSW)

#Higest
  #80
V80ILERH <- Vd80 %>%
  group_by(Rep, P, YearCode, Harvest, N) %>%
  reframe(
    PartialLERI = (PlotIWGDryKgHa[Treatment == 2]) / (PlotIWGDryKgHa[Treatment == 7]))
V80ILERH <- V80ILERH %>%
  mutate(Variety = "Higest")
print(V80ILERH)
  #0
V0ILERH <- Vd80 %>%
  group_by(Rep, P, YearCode, Harvest, N) %>%
  reframe(
    PartialLERI = (PlotIWGDryKgHa[Treatment == 1]) / (PlotIWGDryKgHa[Treatment == 5]))
V0ILERH <- V0ILERH %>%
  mutate(Variety = "Higest")
print(V0ILERH)

#WL
  #80
V80ILERWL <- Vd80 %>%
  group_by(Rep, P, YearCode, Harvest, N) %>%
  reframe(
    PartialLERI = (PlotIWGDryKgHa[Treatment == 21]) / (PlotIWGDryKgHa[Treatment == 7]))
V80ILERWL <- V80ILERWL %>%
  mutate(Variety = "WL")
print(V80ILERWL)
  #0
V0ILERWL <- Vd80 %>%
  group_by(Rep, P, YearCode, Harvest, N) %>%
  reframe(
    PartialLERI = (PlotIWGDryKgHa[Treatment == 20]) / (PlotIWGDryKgHa[Treatment == 5]))
V0ILERWL <- V0ILERWL %>%
  mutate(Variety = "WL")
print(V0ILERWL)

#combine tibbles 
V80IPLER <- bind_rows(
  V80ILERSW %>% select(Rep, P, YearCode, Harvest, Variety, PartialLERI, N),
  V80ILERH %>% select(Rep, P, YearCode, Harvest, Variety, PartialLERI, N),
  V80ILERWL %>% select(Rep, P, YearCode, Harvest, Variety, PartialLERI, N),
  V0ILERSW %>% select(Rep, P, YearCode, Harvest, Variety, PartialLERI, N),
  V0ILERH %>% select(Rep, P, YearCode, Harvest, Variety, PartialLERI, N),
  V0ILERWL %>% select(Rep, P, YearCode, Harvest, Variety, PartialLERI, N)
)
V80IPLER  <- na.omit(V80IPLER )
V80IPLER <- V80IPLER %>%
  mutate(type = "Partial")
print(V80IPLER)
```
#V TLER math 
```{r}
#SW
  #80
VSW80TLER <- Vd80 %>%
  group_by(Rep, P, YearCode, Harvest, N) %>%
  reframe(
    TLER= (PlotIWGDryKgHa[Treatment == 12]) / (PlotIWGDryKgHa[Treatment == 7]) + (PlotAlfDryKgHa[Treatment == 12]) / (PlotAlfDryKgHa[Treatment == 17])) 
VSW80TLER <- VSW80TLER %>%
  mutate(Variety = "Shockwave")
  #0
VSW0TLER <- Vd80 %>%
  group_by(Rep, P, YearCode, Harvest, N) %>%
  reframe(
    TLER = (PlotIWGDryKgHa[Treatment == 10]) / (PlotIWGDryKgHa[Treatment == 5]) + (PlotAlfDryKgHa[Treatment == 10]) / (PlotAlfDryKgHa[Treatment == 15])) 
VSW0TLER <- VSW0TLER %>%
  mutate(Variety = "Shockwave")
#Highest
  #80
VH80TLER <- Vd80 %>%
  group_by(Rep, P, YearCode, Harvest, N) %>%
  reframe(
    TLER= (PlotIWGDryKgHa[Treatment == 2]) / (PlotIWGDryKgHa[Treatment == 7]) + (PlotAlfDryKgHa[Treatment == 2]) / (PlotAlfDryKgHa[Treatment == 4])) 
VH80TLER <- VH80TLER %>%
  mutate(Variety = "Higest")
  #0
VH0TLER <- Vd80 %>%
  group_by(Rep, P, YearCode, Harvest, N) %>%
  reframe(
    TLER = (PlotIWGDryKgHa[Treatment == 1]) / (PlotIWGDryKgHa[Treatment == 5]) + (PlotAlfDryKgHa[Treatment == 1]) / (PlotAlfDryKgHa[Treatment == 3])) 
VH0TLER <- VH0TLER %>%
  mutate(Variety = "Higest")
#WL
  #80
VWL80TLER <- Vd80 %>%
  group_by(Rep, P, YearCode, Harvest, N) %>%
  reframe(
    TLER= (PlotIWGDryKgHa[Treatment == 21]) / (PlotIWGDryKgHa[Treatment == 7]) + (PlotAlfDryKgHa[Treatment == 21]) / (PlotAlfDryKgHa[Treatment == 23])) 
VWL80TLER <- VWL80TLER %>%
  mutate(Variety = "WL")
  #0
VWL0TLER <- Vd80 %>%
  group_by(Rep, P, YearCode, Harvest, N) %>%
  reframe(
    TLER = (PlotIWGDryKgHa[Treatment == 20]) / (PlotIWGDryKgHa[Treatment == 5]) + (PlotAlfDryKgHa[Treatment == 20]) / (PlotAlfDryKgHa[Treatment == 22])) 
VWL0TLER <- VWL0TLER %>%
  mutate(Variety = "WL")

#combine tibbles 
V80TLER <- bind_rows(
  VSW80TLER %>% select(Rep, P, YearCode, Harvest, Variety, TLER, N),
VSW0TLER %>% select(Rep, P, YearCode, Harvest, Variety, TLER, N),
  VH80TLER %>% select(Rep, P, YearCode, Harvest, Variety, TLER, N),
  VH0TLER %>% select(Rep, P, YearCode, Harvest, Variety, TLER, N),
  VWL80TLER %>% select(Rep, P, YearCode, Harvest, Variety, TLER, N),
 VWL0TLER %>% select(Rep, P, YearCode, Harvest, Variety, TLER, N)
)
V80TLER   <- na.omit(V80TLER)
V80TLER <- V80TLER %>%
  mutate(type = "Total")
print(V80TLER)
```
#V PrPLER math 
```{r, eval= FALSE}
#I couldnt figure this out for the life of me. mismatched number of rows trying to join dataframes so I can calculate the PrPLERs from the preexisiting PLERs and TLER.

  
  
  V80IPrPLER <-merge(V80IPLER,V80TLER,  by= "N","Rep","P","YearCode","Harvest","Variety", all=TRUE)
V80APrPLER <- bind_rows(V80APLER,V80TLER)

```
#RFV math 
```{r}
#IWG
V80inter$IWGRFV<-((88.9 - (0.779 * V80inter$IWGADF)) * (120 / V80inter$IWGaNDF) ) / 1.29

V80interXS$IWGRFV<-((88.9 - (0.779 * V80interXS$IWGADF)) * (120 / V80interXS$IWGaNDF) ) / 1.29
V80interXF$IWGRFV<-((88.9 - (0.779 * V80interXF$IWGADF)) * (120 / V80interXF$IWGaNDF) ) / 1.29
V80interYS$IWGRFV<-((88.9 - (0.779 * V80interYS$IWGADF)) * (120 / V80interYS$IWGaNDF) ) / 1.29
V80interYF$IWGRFV<-((88.9 - (0.779 * V80interYF$IWGADF)) * (120 / V80interYF$IWGaNDF) ) / 1.29

#REMOVE outliers KSY314I
#V80interYS<-V80interYS[-65,]

#Alf 
Vd80noI$ALFaNDF<-as.numeric(Vd80noI$ALFaNDF)

Vd80noI$ALFRFV<-((88.9 - (0.779 * Vd80noI$ALFADF)) * (120 / Vd80noI$ALFaNDF) ) / 1.29

Vd80noIX<-Vd80noI[Vd80noI$YearCode == "X",]
Vd80noIY<-Vd80noI[Vd80noI$YearCode == "Y",]
Vd80noIXS<-Vd80noIX[Vd80noIX$Harvest == "Summer",]
Vd80noIXF<-Vd80noIX[Vd80noIX$Harvest == "Fall",]
Vd80noIYS<-Vd80noIY[Vd80noIY$Harvest == "Summer",]
Vd80noIYF<-Vd80noIY[Vd80noIY$Harvest == "Fall",]

#REMOVE outliers KSX202A missing, KSX209A
Vd80noIXS<-Vd80noIXS[-107,]
Vd80noIXS<-Vd80noIXS[-108,]

#REMOVE outliers NYS212A, NYS215A, NYS217A, NYS219A, NYS220A, NYS223A, NYS304A
#Vd80noIYS<-Vd80noIYS[-20,]
#Vd80noIYS<-Vd80noIYS[-20,]
#Vd80noIYS<-Vd80noIYS[-20,]
#Vd80noIYS<-Vd80noIYS[-20,]
#Vd80noIYS<-Vd80noIYS[-20,]
#Vd80noIYS<-Vd80noIYS[-22,]
```

***
variety paper model stuff


#V Alf year 1 summer WITH C
```{r}
modV80XSA<-lmer(PlotAlfDryKgHa~V*P*C + (1|Rep), data=V80XSA)
anova(modV80XSA)
#Check Assumptions
V80XSA_resid<-resid(modV80XSA)
qqnorm(V80XSA_resid)
qqline(V80XSA_resid)
plot(modV80XSA)
#Log transform
modV80XSA1<-lmer(log(PlotAlfDryKgHa)~V*P*C + (1|Rep), data=V80XSA)
anova(modV80XSA1)
#check assumptions logtransform
V80XSA_resid1<-resid(modV80XSA1)
qqnorm(V80XSA_resid1)
qqline(V80XSA_resid1)
plot(modV80XSA1)

#three way emmeans 
V80XSA1emm <- compute_emmeansVXS("modV80XSA1")
#Pairwise V
emmsV <- emmeans(modV80XSA1, specs = ~ V, type = "response")
cld_dataV80XSAV <- cld(emmsV, Letters=custom_letters) # Create compact letter display
cld_dataV80XSAV$response <- format(cld_dataV80XSAV$response, digits = 5)
cld_dataV80XSAV<- cld_dataV80XSAV %>%
  select(V, response, .group)
rownames(cld_dataV80XSAV) <- NULL
colnames(cld_dataV80XSAV) <- c("Variety", "IWG RFV", "Group")
cld_dataV80XSAV  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise P:C
emmsPC <- emmeans(modV80XSA1, specs = ~ P*C, type = "response")
cld_dataV80XSAPC <- cld(emmsPC, Letters=custom_letters) # Create compact letter display
cld_dataV80XSAPC$response <- format(cld_dataV80XSAPC$response, digits = 5)
cld_dataV80XSAPC<- cld_dataV80XSAPC %>%
  select(P, C, response, .group)
rownames(cld_dataV80XSAPC) <- NULL
colnames(cld_dataV80XSAPC) <- c("Site", "Cropping System", "IWG RFV", "Group")
cld_dataV80XSAPC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)




min(V80XSA$PlotAlfDryKgHa)
max(V80XSA$PlotAlfDryKgHa)
#Box Plots
emms <- emmeans(modV80XSA, ~ V:P:C)
cld_data <- cld(emms, Letters=custom_letters)
ggplot(V80XSA, aes(x = V, y = PlotAlfDryKgHa, color = C)) +
  geom_boxplot() +
  labs(x = "Variety", y = "Alf Forage Yield") +
  ggtitle("Box Plots of Alf Forage Yield by Variety and Location") + 
  facet_wrap(~P, scales = "free_y", ncol = 2) + 
  ylim(890, 10500) +
  geom_text(data = as.data.frame(cld_data), aes(label = .group, x = V, y = 10400))

emmsV <- emmeans(modV80XSA, ~ V)
cld_dataV <- cld(emmsV, Letters=custom_letters)
ggplot(V80XSA, aes(x = V, y = PlotAlfDryKgHa)) +
  geom_boxplot() +
  labs(x = "Variety", y = "Alf Forage Yield") +
  ggtitle("Box Plots of Alf Forage Yield by Variety and Location") + 
  facet_wrap(~P, scales = "free_y", ncol = 2) + 
  ylim(890, 10500) +
  geom_text(data = as.data.frame(cld_dataV), aes(label = .group, x = V, y = 10400))

emmsVC <- emmeans(modV80XSA, ~ V:C)
cld_dataVC <- cld(emmsVC, Letters=custom_letters)
ggplot(V80XSA, aes(x = V, y = PlotAlfDryKgHa, color = C)) +
  geom_boxplot() +
  labs(x = "Variety", y = "Alf Forage Yield") +
  ggtitle("Box Plots of Alf Forage Yield by Variety and Location") + 
  facet_wrap(~P, scales = "free_y", ncol = 2) + 
  ylim(890, 10500) +
  geom_text(data = as.data.frame(cld_dataVC), aes(label = .group, x = V, y = 10400))
```
#V alf year 1 fall with C
```{r}
modV80XFA<-lmer(PlotAlfDryKgHa~V*P*C + (1|Rep), data=V80XFA)
anova(modV80XFA)
#Check Assumptions
V80XFA_resid<-resid(modV80XFA)
qqnorm(V80XFA_resid)
qqline(V80XFA_resid)
plot(modV80XFA)
#Log transform
modV80XFA1<-lmer(log(PlotAlfDryKgHa)~V*P*C + (1|Rep), data=V80XFA)
anova(modV80XFA1)
#check assumptions logtransform
V80XFA_resid1<-resid(modV80XFA1)
qqnorm(V80XFA_resid1)
qqline(V80XFA_resid1)
plot(modV80XFA1)

#three way emmeans 
V80XFA1emm <- compute_emmeansVXF("modV80XFA1")
#Pairwise V
emmsV <- emmeans(modV80XFA1, specs = ~ V, type = "response")
cld_dataV80XFAV <- cld(emmsV, Letters=custom_letters) # Create compact letter display
cld_dataV80XFAV$response <- format(cld_dataV80XFAV$response, digits = 4)
cld_dataV80XFAV<- cld_dataV80XFAV %>%
  select(V, response, .group)
rownames(cld_dataV80XFAV) <- NULL
colnames(cld_dataV80XFAV) <- c("Variety", "IWG RFV", "Group")
cld_dataV80XFAV  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise P:C
emmsPC <- emmeans(modV80XFA1, specs = ~ P*C, type = "response")
cld_dataV80XFAPC <- cld(emmsPC, Letters=custom_letters) # Create compact letter display
cld_dataV80XFAPC$response <- format(cld_dataV80XFAPC$response, digits = 4)
cld_dataV80XFAPC<- cld_dataV80XFAPC %>%
  select(P, C, response, .group)
rownames(cld_dataV80XFAPC) <- NULL
colnames(cld_dataV80XFAPC) <- c("Site", "Cropping System", "IWG RFV", "Group")
cld_dataV80XFAPC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)


min(V80XFA$PlotAlfDryKgHa)
max(V80XFA$PlotAlfDryKgHa)
#Box Plots
emms <- emmeans(modV80XFA, ~ V:P:C)
cld_data <- cld(emms, Letters=custom_letters)
ggplot(V80XFA, aes(x = V, y = PlotAlfDryKgHa, color = C)) +
  geom_boxplot() +
  labs(x = "Variety", y = "Alf Forage Yield") +
  ggtitle("Box Plots of Alf Forage Yield by Variety and Location") + 
  facet_wrap(~P, scales = "free_y", ncol = 2) + 
  ylim(90, 3300) +
  geom_text(data = as.data.frame(cld_data), aes(label = .group, x = V, y = 3200))
```
#V alf year 2 summer with C
```{r}
modV80YSA<-lmer(PlotAlfDryKgHa~V*P*C + (1|Rep), data=V80YSA)
anova(modV80YSA)
#Check Assumptions
V80YSA_resid<-resid(modV80YSA)
qqnorm(V80YSA_resid)
qqline(V80YSA_resid)
plot(modV80YSA)
#Log transform
modV80YSA1<-lmer(log(PlotAlfDryKgHa)~V*P*C + (1|Rep), data=V80YSA)
anova(modV80YSA1)
#check assumptions logtransform
V80YSA_resid1<-resid(modV80YSA1)
qqnorm(V80YSA_resid1)
qqline(V80YSA_resid1)
plot(modV80YSA1)

#three way emmeans 
V80YSA1emm <- compute_emmeansVYS("modV80YSA1")
#Pairwise P:C
emmsPC <- emmeans(modV80YSA1, specs = ~ P*C, type = "response")
cld_dataV80YSAPC <- cld(emmsPC, Letters=custom_letters) # Create compact letter display
cld_dataV80YSAPC$response <- format(cld_dataV80YSAPC$response, digits = 4)
cld_dataV80YSAPC<- cld_dataV80YSAPC %>%
  select(P, C, response, .group)
rownames(cld_dataV80YSAPC) <- NULL
colnames(cld_dataV80YSAPC) <- c("Site", "Cropping System", "IWG RFV", "Group")
cld_dataV80YSAPC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

min(V80YSA$PlotAlfDryKgHa)
max(V80YSA$PlotAlfDryKgHa)
#Box Plots
emms <- emmeans(modV80YSA, ~ V:P:C)
cld_data <- cld(emms, Letters=custom_letters)
ggplot(V80YSA, aes(x = V, y = PlotAlfDryKgHa, color = C)) +
  geom_boxplot() +
  labs(x = "Variety", y = "Alf Forage Yield") +
  ggtitle("Box Plots of Alf Forage Yield by Variety and Location") + 
  facet_wrap(~P, scales = "free_y", ncol = 2) + 
  ylim(200, 6000) +
  geom_text(data = as.data.frame(cld_data), aes(label = .group, x = V, y = 5900))
```
#V alf year 2 fall with C
```{r}
modV80YFA<-lmer(PlotAlfDryKgHa~V*P*C + (1|Rep), data=V80YFA)
anova(modV80YFA)
#Check Assumptions
V80YFA_resid<-resid(modV80YFA)
qqnorm(V80YFA_resid)
qqline(V80YFA_resid)
plot(modV80YFA)
#Log transform
modV80YFA1<-lmer(log(PlotAlfDryKgHa)~V*P*C + (1|Rep), data=V80YFA)
anova(modV80YFA1)
#check assumptions logtransform
V80YFA_resid1<-resid(modV80YFA1)
qqnorm(V80YFA_resid1)
qqline(V80YFA_resid1)
plot(modV80YFA1)

#three way emmeans 
V80YFA1emm <- compute_emmeansVYF("modV80YFA1")
#Pairwise P:C
emmsPC <- emmeans(modV80YFA1, specs = ~ P*C, type = "response")
cld_dataV80YFAPC <- cld(emmsPC, Letters=custom_letters) # Create compact letter display
cld_dataV80YFAPC$response <- format(cld_dataV80YFAPC$response, digits = 5)
cld_dataV80YFAPC<- cld_dataV80YFAPC %>%
  select(P, C, response, .group)
rownames(cld_dataV80YFAPC) <- NULL
colnames(cld_dataV80YFAPC) <- c("Site", "Cropping System", "IWG RFV", "Group")
cld_dataV80YFAPC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)


min(V80YFA$PlotAlfDryKgHa)
max(V80YFA$PlotAlfDryKgHa)
#Box Plots
emms <- emmeans(modV80YFA, ~ V:P:C)
cld_data <- cld(emms, Letters=custom_letters)
ggplot(V80YFA, aes(x = V, y = PlotAlfDryKgHa, color = C)) +
  geom_boxplot() +
  labs(x = "Variety", y = "Alf Forage Yield") +
  ggtitle("Box Plots of Alf Forage Yield by Variety and Location") + 
  facet_wrap(~P, scales = "free_y", ncol = 2) + 
  ylim(600, 2700) +
  geom_text(data = as.data.frame(cld_data), aes(label = .group, x = V, y = 2600))
```

#V alf forage yield combo plots..
```{r}
V80XSA$Year<-"Year 1 Summer"
V80XFA$Year<-"Year 1 Fall"
V80YSA$Year<-"Year 2 Summer"
V80YFA$Year<-"Year 2 Fall"

colorsP<-c("MN"="gold", "NY"="red", "KS"="purple", "WI"="white")

combined_dataVA <- rbind(V80XSA,V80XFA,V80YSA,V80YFA)
desired_orderY <- c("Year 1 Summer", "Year 1 Fall", "Year 2 Summer", "Year 2 Fall")

combined_dataVA$Year <- factor(combined_dataVA$Year, levels = desired_orderY)
combined_dataVA$P <- factor(combined_dataVA$P, levels = desired_order)

max(combined_dataVA$PlotAlfDryKgHa)
min(combined_dataVA$PlotAlfDryKgHa)
combined_dataVA$C <- as.factor(combined_dataVA$C)
VAcomboplot <- ggplot(combined_dataVA, aes(x = V, y = PlotAlfDryKgHa, fill = P)) +
  geom_boxplot(position = position_dodge(width = 0.75)) +
  labs(x = "Variety", y = "Total forage yield (kg ha-1)") +
  ggtitle("Total Forage Yield") +
  coord_cartesian(ylim = c(NA, NA)) +
  scale_fill_manual(values = colorsP)+
  facet_wrap(~Year, scales = "free", ncol = 2)+
  ylim(0,11000)


# Display the combined plot
print(VAcomboplot)

ggsave("VAcomboplot.jpg", plot = VAcomboplot  , width = 8, height = 6, dpi = 300)
```


#V Total forage year 1 summer WITH C
```{r}
#need to take out IWG mono plots 
V80XS1<-V80XS[V80XS$Crop1 != "IWG",]
#add cropping system back in to model 
modV80XSTF<-lmer(PlotTotForageKgHa~V*P*C + (1|Rep), data=V80XS1)
anova(modV80XSTF)
#Check Assumptions
V80XSTF_resid<-resid(modV80XSTF)
qqnorm(V80XSTF_resid)
qqline(V80XSTF_resid)
plot(modV80XSTF)
#Logtransform
modV80XSTF1<-lmer(log(PlotTotForageKgHa)~V*P*C + (1|Rep), data=V80XS1)
anova(modV80XSTF1)
#check assumptions logtransform (makes BETTER)
V80XSTF_resid1<-resid(modV80XSTF1)
qqnorm(V80XSTF_resid1)
qqline(V80XSTF_resid1)
plot(modV80XSTF1)

#three way emmeans 
V80XSTF1emm <- compute_emmeansVXS("modV80XSTF1")
#Pairwise V
emmsV <- emmeans(modV80XSTF1, specs = ~ V, type = "response")
cld_dataV80XSTFV <- cld(emmsV, Letters=custom_letters) # Create compact letter display
cld_dataV80XSTFV$response <- format(cld_dataV80XSTFV$response, digits = 5)
cld_dataV80XSTFV<- cld_dataV80XSTFV %>%
  select(V, response, .group)
rownames(cld_dataV80XSTFV) <- NULL
colnames(cld_dataV80XSTFV) <- c("Variety", "Total Forage Yield", "Group")
cld_dataV80XSTFV  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise P:C
emmsPC <- emmeans(modV80XSTF1, specs = ~ P*C, type = "response")
cld_dataV80XSTFPC <- cld(emmsPC, Letters=custom_letters) # Create compact letter display
cld_dataV80XSTFPC$response <- format(cld_dataV80XSTFPC$response, digits = 5)
cld_dataV80XSTFPC<- cld_dataV80XSTFPC %>%
  select(P, C, response, .group)
rownames(cld_dataV80XSTFPC) <- NULL
colnames(cld_dataV80XSTFPC) <- c("Site", "Cropping System", "Total Forage Yield", "Group")
cld_dataV80XSTFPC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)



min(V80XS1$PlotTotForageKgHa)
max(V80XS1$PlotTotForageKgHa)
#Box Plots
emms <- emmeans(modV80XSTF, ~ V:P:C)
cld_data <- cld(emms, Letters=custom_letters)
ggplot(V80XS1, aes(x = V, y = PlotTotForageKgHa, color = C)) +
  geom_boxplot() +
  labs(x = "Variety", y = "Alf Forage Yield") +
  ggtitle("Box Plots of Alf Forage Yield by Variety and Location") + 
  facet_wrap(~P, scales = "free_y", ncol = 2) + 
  ylim(1700, 12000) +
  geom_text(data = as.data.frame(cld_data), aes(label = .group, x = V, y = 11000))

#Box Plots
emmsVC <- emmeans(modV80XSTF, ~ V:C)
cld_dataVC <- cld(emmsVC, Letters=custom_letters)
ggplot(V80XS1, aes(x = V, y = PlotTotForageKgHa, color = C)) +
  geom_boxplot() +
  labs(x = "Variety", y = "Alf Forage Yield") +
  ggtitle("Box Plots of Alf Forage Yield by Variety and Location") + 
  facet_wrap(~P, scales = "free_y", ncol = 2) + 
  ylim(1700, 12000) +
  geom_text(data = as.data.frame(cld_dataVC), aes(label = .group, x = V, y = 11000))
```
#V Total forage year 1 fall with C
```{r}
#need to take out IWG mono plots 
V80XF1<-V80XF[V80XF$Crop1 != "IWG",]
#add cropping system back in to model 
modV80XFTF<-lmer(PlotTotForageKgHa~V*P*C + (1|Rep), data=V80XF1)
anova(modV80XFTF)
#Check Assumptions
V80XFTF_resid<-resid(modV80XFTF)
qqnorm(V80XFTF_resid)
qqline(V80XFTF_resid)
plot(modV80XFTF)
#Logtransform
modV80XFTF1<-lmer(log(PlotTotForageKgHa)~V*P*C + (1|Rep), data=V80XF1)
anova(modV80XFTF1)
#check assumptions logtransform (makes BETTER)
V80XFTF_resid1<-resid(modV80XFTF1)
qqnorm(V80XFTF_resid1)
qqline(V80XFTF_resid1)
plot(modV80XFTF1)

#three way emmeans 
V80XFTF1emm <- compute_emmeansVXF("modV80XFTF1")
#Pairwise V
emmsV <- emmeans(modV80XFTF1, specs = ~ V, type = "response")
cld_dataV80XFTFV <- cld(emmsV, Letters=custom_letters) # Create compact letter display
cld_dataV80XFTFV$response <- format(cld_dataV80XFTFV$response, digits = 4)
cld_dataV80XFTFV<- cld_dataV80XFTFV %>%
  select(V, response, .group)
rownames(cld_dataV80XFTFV) <- NULL
colnames(cld_dataV80XFTFV) <- c("Variety", "Total Forage Yield", "Group")
cld_dataV80XFTFV  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise P:C
emmsPC <- emmeans(modV80XFTF1, specs = ~ P*C, type = "response")
cld_dataV80XFTFPC <- cld(emmsPC, Letters=custom_letters) # Create compact letter display
cld_dataV80XFTFPC$response <- format(cld_dataV80XFTFPC$response, digits = 4)
cld_dataV80XFTFPC<- cld_dataV80XFTFPC %>%
  select(P, C, response, .group)
rownames(cld_dataV80XFTFPC) <- NULL
colnames(cld_dataV80XFTFPC) <- c("Site", "Cropping System", "Total Forage Yield", "Group")
cld_dataV80XFTFPC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
```
#V Total forage year 2 summer with C
```{r}
#need to take out IWG mono plots 
V80YS1<-V80YS[V80YS$Crop1 != "IWG",]
#add cropping system back in to model 
modV80YSTF<-lmer(PlotTotForageKgHa~V*P*C + (1|Rep), data=V80YS1)
anova(modV80YSTF)
#Check Assumptions
V80YSTF_resid<-resid(modV80YSTF)
qqnorm(V80YSTF_resid)
qqline(V80YSTF_resid)
plot(modV80YSTF)
#Logtransform
modV80YSTF1<-lmer(log(PlotTotForageKgHa)~V*P*C + (1|Rep), data=V80YS1)
anova(modV80YSTF1)
#check assumptions logtransform (makes BETTER)
V80YSTF_resid1<-resid(modV80YSTF1)
qqnorm(V80YSTF_resid1)
qqline(V80YSTF_resid1)
plot(modV80YSTF1)

#three way emmeans 
V80YSTF1emm <- compute_emmeansVYS("modV80YSTF1")
#Pairwise P:C
emmsPC <- emmeans(modV80YSTF1, specs = ~ P*C, type = "response")
cld_dataV80YSTFPC <- cld(emmsPC, Letters=custom_letters) # Create compact letter display
cld_dataV80YSTFPC$response <- format(cld_dataV80YSTFPC$response, digits = 5)
cld_dataV80YSTFPC<- cld_dataV80YSTFPC %>%
  select(P, C, response, .group)
rownames(cld_dataV80YSTFPC) <- NULL
colnames(cld_dataV80YSTFPC) <- c("Site", "Cropping System", "Total Forage Yield", "Group")
cld_dataV80YSTFPC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
```
#V Total forage year 2 fall with C
```{r}
#need to take out IWG mono plots 
V80YF1<-V80YF[V80YF$Crop1 != "IWG",]
#add cropping sYStem back in to model 
modV80YFTF<-lmer(PlotTotForageKgHa~V*P*C + (1|Rep), data=V80YF1)
anova(modV80YFTF)
#Check Assumptions
V80YFTF_resid<-resid(modV80YFTF)
qqnorm(V80YFTF_resid)
qqline(V80YFTF_resid)
plot(modV80YFTF)
#Logtransform
modV80YFTF1<-lmer(log(PlotTotForageKgHa)~V*P*C + (1|Rep), data=V80YF1)
anova(modV80YFTF1)
V80YFTF_resid1<-resid(modV80YFTF1)
qqnorm(V80YFTF_resid1)
qqline(V80YFTF_resid1)
plot(modV80YFTF1)

#three way emmeans 
V80YFTF1emm <- compute_emmeansVYF("modV80YFTF1")
#Pairwise P:C
emmsPC <- emmeans(modV80YFTF1, specs = ~ P*C, type = "response")
cld_dataV80YFTFPC <- cld(emmsPC, Letters=custom_letters) # Create compact letter display
cld_dataV80YFTFPC$response <- format(cld_dataV80YFTFPC$response, digits = 5)
cld_dataV80YFTFPC<- cld_dataV80YFTFPC %>%
  select(P, C, response, .group)
rownames(cld_dataV80YFTFPC) <- NULL
colnames(cld_dataV80YFTFPC) <- c("Site", "Cropping System", "Total Forage Yield", "Group")
cld_dataV80YFTFPC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
```

#V TF COMBO PLOTS
```{r}
V80XS1$Year<-"Year 1 Summer"
V80XF1$Year<-"Year 1 Fall"
V80YS1$Year<-"Year 2 Summer"
V80YF1$Year<-"Year 2 Fall"

colorsP<-c("MN"="gold", "NY"="red", "KS"="purple", "WI"="white")

combined_dataVTF <- rbind(V80XS1,V80XF1,V80YS1,V80YF1)
desired_orderY <- c("Year 1 Summer", "Year 1 Fall", "Year 2 Summer", "Year 2 Fall")

combined_dataVTF$Year <- factor(combined_dataVTF$Year, levels = desired_orderY)
combined_dataVTF$P <- factor(combined_dataVTF$P, levels = desired_order)

max(combined_dataVTF$PlotTotForageKgHa)
min(combined_dataVTF$PlotTotForageKgHa)
VTFcomboplot <- ggplot(combined_dataVTF, aes(x = V, y = PlotTotForageKgHa, fill = P)) +
  geom_boxplot(position = position_dodge(width = 0.75)) +
  labs(x = "Variety", y = "Total forage yield (kg ha-1)") +
  ggtitle("Total Forage Yield") +
  coord_cartesian(ylim = c(NA, NA)) +
  scale_fill_manual(values = colorsP)+
  facet_wrap(~Year, scales = "free", ncol = 2)+
  ylim(0,11300)


# Display the combined plot
print(VTFcomboplot)

ggsave("VTFcomboplot.jpg", plot = VTFcomboplot  , width = 8, height = 6, dpi = 300)
```

#adding year 1 mn grain to the G column because they were actually dehulled instead of imaged for using the equation 
```{r}
V80XSAnoMN<-V80XSA[V80XSA$Location != "MN",]
V80XSAMN<-V80XSA[V80XSA$Location == "MN",]
V80XSAMN$G<-V80XSAMN$X2023MNGrainDeHulledKgHa
V80XSAplusMN<-rbind(V80XSAnoMN, V80XSAMN)
```
#V grain yield just in intercrop (1S)
```{r}
V80XSAInt<-V80XSA[V80XSA$C == "intercrop",]
modV80XSGI<-lmer(G~V*P + (1|Rep), data=V80XSAInt)
anova(modV80XSGI)
#Check Assumptions
V80XSGI_resid<-resid(modV80XSGI)
qqnorm(V80XSGI_resid)
qqline(V80XSGI_resid)
plot(modV80YFA)
#Log transform
modV80XSGI1<-lmer(log(G)~V*P + (1|Rep), data=V80XSAInt)
anova(modV80XSGI1)
#check assumptions logtransform
V80XSGI_resid1<-resid(modV80XSGI1)
qqnorm(V80XSGI_resid1)
qqline(V80XSGI_resid1)
plot(modV80XSGI1)

#add MN back in because data was missing MN...
V80XSAplusMNInt<-V80XSAplusMN[V80XSAplusMN$C == "intercrop",]
modV80XSGI12<-lmer(log(G)~V*P + (1|Rep), data=V80XSAplusMNInt)
anova(modV80XSGI12)

#Pairwise P
emmsP <- emmeans(modV80XSGI12, specs = ~ P, type = "response")
cld_dataV80XSGIP <- cld(emmsP, Letters=custom_letters) # Create compact letter display
cld_dataV80XSGIP$response <- format(cld_dataV80XSGIP$response, digits = 5)
cld_dataV80XSGIP<- cld_dataV80XSGIP %>%
  select(P, response, .group)
rownames(cld_dataV80XSGIP) <- NULL
colnames(cld_dataV80XSGIP) <- c("Site",  "Grain Yield", "Group")
cld_dataV80XSGIP  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

```
#V grain yield just in intercrop (2S)
```{r}
VGYdata<-DATA3[DATA3$NRate != '40' & DATA3$NRate != '120' & DATA3$NRate != '160',]
VGYdata<-VGYdata[VGYdata$C == 'intercrop',]

modV80YSGI<-lmer(GAdjY~V*P + (1|Rep), data=VGYdata)
anova(modV80YSGI)
#Check Assumptions
V80YSGI_resid<-resid(modV80YSGI)
qqnorm(V80YSGI_resid)
qqline(V80YSGI_resid)
plot(modV80YFA)
#Log transform
modV80YSGI1<-lmer(log(GAdjY)~V*P + (1|Rep), data=VGYdata)
anova(modV80YSGI1)
#check assumptions logtransform
V80YSGI_resid1<-resid(modV80YSGI1)
qqnorm(V80YSGI_resid1)
qqline(V80YSGI_resid1)
plot(modV80YSGI1)


#Pairwise P
emmsP <- emmeans(modV80YSGI1, specs = ~ P, type = "response")
cld_dataV80YSGIP <- cld(emmsP, Letters=custom_letters) # Create compact letter display
cld_dataV80YSGIP$response <- format(cld_dataV80YSGIP$response, digits = 5)
cld_dataV80YSGIP<- cld_dataV80YSGIP %>%
  select(P, response, .group)
rownames(cld_dataV80YSGIP) <- NULL
colnames(cld_dataV80YSGIP) <- c("Site",  "Grain Yield", "Group")
cld_dataV80YSGIP  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

```


#V IWG yield just in intercrop (1S)
```{r}
V80XSAInt<-V80XSA[V80XSA$C == "intercrop",]

modV80XSII<-lmer(PlotIWGDryKgHa~V*P + (1|Rep), data=V80XSAInt)
anova(modV80XSII)
#Check Assumptions
V80XSII_resid<-resid(modV80XSII)
qqnorm(V80XSII_resid)
qqline(V80XSII_resid)
plot(modV80YFA)
#Log transform
modV80XSII1<-lmer(log(PlotIWGDryKgHa)~V*P + (1|Rep), data=V80XSAInt)
anova(modV80XSII1)
#check assumptions logtransform
V80XSII_resid1<-resid(modV80XSII1)
qqnorm(V80XSII_resid1)
qqline(V80XSII_resid1)
plot(modV80XSII1)

#Pairwise P
emmsP <- emmeans(modV80XSII1, specs = ~ P, type = "response")
cld_dataV80XSIIP <- cld(emmsP, Letters=custom_letters) # Create compact letter display
cld_dataV80XSIIP$response <- format(cld_dataV80XSIIP$response, digits = 5)
cld_dataV80XSIIP<- cld_dataV80XSIIP %>%
  select(P, response, .group)
rownames(cld_dataV80XSIIP) <- NULL
colnames(cld_dataV80XSIIP) <- c("Site",  "IWG Forage Yield", "Group")
cld_dataV80XSIIP  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

```
#V IWG yield just in intercrop (1F)
```{r}
V80XFAInt<-V80XFA[V80XFA$C == "intercrop",]

modV80XFII<-lmer(PlotIWGDryKgHa~V*P + (1|Rep), data=V80XFAInt)
anova(modV80XFII)
#Check Assumptions
V80XFII_resid<-resid(modV80XFII)
qqnorm(V80XFII_resid)
qqline(V80XFII_resid)
plot(modV80YFA)
#Log transform
modV80XFII1<-lmer(log(PlotIWGDryKgHa)~V*P + (1|Rep), data=V80XFAInt)
anova(modV80XFII1)
#check assumptions logtransform
V80XFII_resid1<-resid(modV80XFII1)
qqnorm(V80XFII_resid1)
qqline(V80XFII_resid1)
plot(modV80XFII1)

#Pairwise P
emmsP <- emmeans(modV80XFII1, specs = ~ P, type = "response")
cld_dataV80XFIIP <- cld(emmsP, Letters=custom_letters) # Create compact letter display
cld_dataV80XFIIP$response <- format(cld_dataV80XFIIP$response, digits = 5)
cld_dataV80XFIIP<- cld_dataV80XFIIP %>%
  select(P, response, .group)
rownames(cld_dataV80XFIIP) <- NULL
colnames(cld_dataV80XFIIP) <- c("Site",  "IWG Forage Yield", "Group")
cld_dataV80XFIIP  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

```
#V IWG yield just in intercrop (2S)
```{r}
V80YSAInt<-V80YSA[V80YSA$C == "intercrop",]

modV80YSII<-lmer(PlotIWGDryKgHa~V*P + (1|Rep), data=V80YSAInt)
anova(modV80YSII)
#Check Assumptions
V80YSII_resid<-resid(modV80YSII)
qqnorm(V80YSII_resid)
qqline(V80YSII_resid)
plot(modV80YFA)
#Log transform
modV80YSII1<-lmer(log(PlotIWGDryKgHa)~V*P + (1|Rep), data=V80YSAInt)
anova(modV80YSII1)
#check assumptions logtransform
V80YSII_resid1<-resid(modV80YSII1)
qqnorm(V80YSII_resid1)
qqline(V80YSII_resid1)
plot(modV80YSII1)

#Pairwise P
emmsP <- emmeans(modV80YSII1, specs = ~ P, type = "response")
cld_dataV80YSIIP <- cld(emmsP, Letters=custom_letters) # Create compact letter display
cld_dataV80YSIIP$response <- format(cld_dataV80YSIIP$response, digits = 5)
cld_dataV80YSIIP<- cld_dataV80YSIIP %>%
  select(P, response, .group)
rownames(cld_dataV80YSIIP) <- NULL
colnames(cld_dataV80YSIIP) <- c("Site",  "IWG Forage Yield", "Group")
cld_dataV80YSIIP  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

```
#V IWG yield just in intercrop (2F)
```{r}
V80YFAInt<-V80YFA[V80YFA$C == "intercrop",]

modV80YFII<-lmer(PlotIWGDryKgHa~V*P + (1|Rep), data=V80YFAInt)
anova(modV80YFII)
#Check Assumptions
V80YFII_resid<-resid(modV80YFII)
qqnorm(V80YFII_resid)
qqline(V80YFII_resid)
plot(modV80YFA)
#Log transform
modV80YFII1<-lmer(log(PlotIWGDryKgHa)~V*P + (1|Rep), data=V80YFAInt)
anova(modV80YFII1)
#check assumptions logtransform
V80YFII_resid1<-resid(modV80YFII1)
qqnorm(V80YFII_resid1)
qqline(V80YFII_resid1)
plot(modV80YFII1)

```

#V Grain PLER year 1 model (use PLER to see if there is interaction between Cropping system and Nrate and yield)
```{r}
V80GPLERX<-V80GPLER[V80GPLER$YearCode == "X",]
V80GPLERX$P<-as.factor(V80GPLERX$P)
V80GPLERX$V<-as.factor(V80GPLERX$Variety)
V80GPLERX$LER<-as.numeric(V80GPLERX$PartialLERG)

#linear
modV80GPLERX<-lmer(LER~V*P + (1|Rep), data= V80GPLERX)
anova(modV80GPLERX)
#Check Assumptions
V80GPLERX_resid<-resid(modV80GPLERX)
qqnorm(V80GPLERX_resid)
qqline(V80GPLERX_resid)
plot(modV80GPLERX)
#Logtransform
modV80GPLERX1<-lmer(log(LER)~V*P + (1|Rep), data= V80GPLERX)
anova(modV80GPLERX1)
#check assumptions logtransform (makes BETTER)
V80GPLERX_resid1<-resid(modV80GPLERX1)
qqnorm(V80GPLERX_resid1)
qqline(V80GPLERX_resid1)
plot(modV80GPLERX1)

#two way emmeans 
V80GPLERX1emm <- compute_emmeansVXS2("modV80GPLERX1")

min(V80GPLERX$LER)
max(V80GPLERX$LER)
#box plots
emms <- emmeans(modV80GPLERX1, ~ P*V) # Obtain estimated marginal means 
cld_dataV80GPLERXpv <- cld(emms, Letters=custom_letters) # Create compact letter display
ggplot(V80GPLERX, aes(x = V, y = LER, fill= P)) +
  geom_boxplot() +
  labs(x = "Variety", y = "Grain Partial LER (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between Grain Partial LER and Variety") +  # Add a title
  ylim(0, 5.3) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System") +  #legend for colors
  geom_text(data = as.data.frame(cld_dataV80GPLERXpv), aes(label = .group, x = V, y = 5.2))+
  geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")

#pairwise comparisons
#pairwise comparisons? 
emmsVGXP <- emmeans(modV80GPLERX1, ~ P, type = "response")
cld_dataVGXP <- cld(emmsVGXP, Letters=custom_letters)
cld_dataVGXP$response <- format(cld_dataVGXP$response, digits = 2)
cld_dataVGXP$lower.CL <- format(cld_dataVGXP$lower.CL, digits = 2)
cld_dataVGXP$upper.CL <- format(cld_dataVGXP$upper.CL, digits = 2)
cld_dataVGXP<- cld_dataVGXP %>%
  select(P, response, lower.CL, upper.CL, .group)
rownames(cld_dataVGXP) <- NULL
colnames(cld_dataVGXP) <- c("Site",  "GPLER", "CI2.5%","CI97.5%", "Group")
cld_dataVGXP  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#V pairwise
emmsVGXV <- emmeans(modV80GPLERX1, ~ V, type = "response")
cld_dataVGXV <- cld(emmsVGXV, Letters=custom_letters)
cld_dataVGXV$response <- format(cld_dataVGXV$response, digits = 2)
cld_dataVGXV$lower.CL <- format(cld_dataVGXV$lower.CL, digits = 2)
cld_dataVGXV$upper.CL <- format(cld_dataVGXV$upper.CL, digits = 2)
cld_dataVGXV<- cld_dataVGXV %>%
  select(V, response, lower.CL, upper.CL, .group)
rownames(cld_dataVGXV) <- NULL
colnames(cld_dataVGXV) <- c("Variety", "Total Forage Yield", "CI2.5%", "CI97.5%", "Group")
cld_dataVGXV  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
```
#V Grain year 2 pler (adjusted based on year 1 adjustments)
```{r}
V80GPLERY$P<-as.factor(V80GPLERY$P)
V80GPLERY$V<-as.factor(V80GPLERY$Variety)
V80GPLERY$LER<-as.numeric(V80GPLERY$PartialLERG)
#linear
modV80GPLERY<-lmer(LER~V*P + (1|Rep), data= V80GPLERY)
anova(modV80GPLERY)
#Check Assumptions
V80GPLERY_resid<-resid(modV80GPLERY)
qqnorm(V80GPLERY_resid)
qqline(V80GPLERY_resid)
plot(modV80GPLERY)
#Logtransform
modV80GPLERY1<-lmer(log(LER)~V*P + (1|Rep), data= V80GPLERY)
anova(modV80GPLERY1)
#check assumptions logtransform (makes BETTER)
V80GPLERY_resid1<-resid(modV80GPLERY1)
qqnorm(V80GPLERY_resid1)
qqline(V80GPLERY_resid1)
plot(modV80GPLERY1)

#two way emmeans 
V80GPLERY1emm <- compute_emmeansVYS2("modV80GPLERY1")

min(V80GPLERY$LER)
max(V80GPLERY$LER)
#box plots
emms <- emmeans(modV80GPLERY1, ~ P*V) # Obtain estimated marginal means 
cld_dataV80GPLERYpv <- cld(emms, Letters=custom_letters) # Create compact letter display
ggplot(V80GPLERY, aes(x = V, y = LER, fill= P)) +
  geom_boxplot() +
  labs(x = "Variety", y = "Grain Partial LER (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between Grain Partial LER and Variety") +  # Add a title
  ylim(0, 5.3) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System") +  #legend for colors
  geom_text(data = as.data.frame(cld_dataV80GPLERYpv), aes(label = .group, x = V, y = 5.2))+
  geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")

#pairwise comparisons 
emmsVGYadjP <- emmeans(modV80GPLERY1, ~ P, type = "response")
cld_dataVGYadjP <- cld(emmsVGYadjP, Letters=custom_letters)
cld_dataVGYadjP$response <- format(cld_dataVGYadjP$response, digits = 2)
cld_dataVGYadjP$lower.CL <- format(cld_dataVGYadjP$lower.CL, digits = 2)
cld_dataVGYadjP$upper.CL <- format(cld_dataVGYadjP$upper.CL, digits = 2)
cld_dataVGYadjP<- cld_dataVGYadjP %>%
  select(P, response, lower.CL, upper.CL ,.group)
rownames(cld_dataVGYadjP) <- NULL
colnames(cld_dataVGYadjP) <- c("Site",  "GPLER","CI2.5%","CI97.5%", "Group")
cld_dataVGYadjP  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#V pairwise
emmsVGYV <- emmeans(modV80GPLERY1, ~ V, type = "response")
cld_dataVGYV <- cld(emmsVGYV, Letters=custom_letters)
cld_dataVGYV$response <- format(cld_dataVGYV$response, digits = 2)
cld_dataVGYV$lower.CL <- format(cld_dataVGYV$lower.CL, digits = 2)
cld_dataVGYV$upper.CL <- format(cld_dataVGYV$upper.CL, digits = 3)
cld_dataVGYV<- cld_dataVGYV %>%
  select(V, response, lower.CL, upper.CL, .group)
rownames(cld_dataVGYV) <- NULL
colnames(cld_dataVGYV) <- c("Variety", "Total Forage Yield", "CI2.5%", "CI97.5%", "Group")
cld_dataVGYV  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
```
#V grain year 2 pler (unadjusted)
```{r}
V80GPLERY2$P<-as.factor(V80GPLERY2$P)
V80GPLERY2$V<-as.factor(V80GPLERY2$Variety)
V80GPLERY2$LER<-as.numeric(V80GPLERY2$PartialLERG)
#linear
modV80GPLERY2<-lmer(LER~V*P + (1|Rep), data= V80GPLERY2)
anova(modV80GPLERY2)
#Check Assumptions
V80GPLERY2_resid<-resid(modV80GPLERY2)
qqnorm(V80GPLERY2_resid)
qqline(V80GPLERY2_resid)
plot(modV80GPLERY2)
#Logtransform
modV80GPLERY21<-lmer(log(LER)~V*P + (1|Rep), data= V80GPLERY2)
anova(modV80GPLERY21)
#check assumptions logtransform (makes BETTER)
V80GPLERY2_resid1<-resid(modV80GPLERY21)
qqnorm(V80GPLERY2_resid1)
qqline(V80GPLERY2_resid1)
plot(modV80GPLERY21)

#see if there are rank differences between adjusted and non adjusted 
#Pairwise V:P
emmsVPG <- emmeans(modV80GPLERY21, specs = ~ V*P, type = "response")
cld_dataV80GPLERY21VP <- cld(emmsVPG, Letters=custom_letters) # Create compact letter display
emmsVPGadj <- emmeans(modV80GPLERY1, specs = ~ V*P, type = "response")
cld_dataV80GPLERY1VPadj <- cld(emmsVPGadj, Letters=custom_letters) # Create compact letter display
```
#V GPLER COMBO PLOT
```{r}
V80GPLERX$Year<-"Year 1"
V80GPLERY$Year<-"Year 2"

colorsP<-c("MN"="gold", "NY"="red", "KS"="purple", "WI"="white")

combined_dataVGPLER <- rbind(V80GPLERX, V80GPLERY)
desired_orderY2 <- c("Year 1","Year 2")

combined_dataVGPLER$Year <- factor(combined_dataVGPLER$Year, levels = desired_orderY2)
combined_dataVGPLER$P <- factor(combined_dataVGPLER$P, levels = desired_order)

max(combined_dataVGPLER$LER)
min(combined_dataVGPLER$LER)
VGPLERcomboplot <- ggplot(combined_dataVGPLER, aes(x = V, y = LER, fill = P)) +
  geom_boxplot(position = position_dodge(width = 0.75)) +
  labs(x = "Variety", y = "GPLER") +
  ggtitle("GPLER") +
  coord_cartesian(ylim = c(NA, NA)) +
  scale_fill_manual(values = colorsP) +
  facet_wrap(~Year, scales = "free", ncol = 2) +
  ylim(0, 5.3)+
geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")

# Display the combined plot
print(VGPLERcomboplot)

ggsave("VGPLERcomboplot.jpg", plot = VGPLERcomboplot  , width = 8, height = 6, dpi = 300)
```

#V GPLER redone plots
```{r}
#X
V80GPLERX$predicted <- predict(modV80GPLERX1, newdata =V80GPLERX, re.form = NA)
VGPLERXemms <- emmeans(modV80GPLERX1, ~ P, type = "response")
emms_df <- as.data.frame(VGPLERXemms)
cld_dataVGPLERX <- cld(VGPLERXemms, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataVGPLERX)
merged_df <- merge(emms_df, cld_df,by = c("P"))
VGPLERXP<-ggplot(V80GPLERX, aes(x = P, y = exp(predicted), color = Variety)) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7) +
  labs(x = "Environment", y = "Grain PLER") +
  geom_point(data = emms_df, aes(x = P, y = response, color=Variety), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 2)+
     ggtitle("Year 1")+
   guides(color = "none")+
  scale_y_continuous(breaks = c(0.5,1,1.5,2), limits = c(0, 2))+
       geom_abline(intercept = 1, slope = 0, color = "red", linetype = "dashed")

#Y
V80GPLERY$predicted <- predict(modV80GPLERY1, newdata = V80GPLERY, re.form = NA)
VGPLERYemms <- emmeans(modV80GPLERY1, ~ P, type = "response")
emms_df <- as.data.frame(VGPLERYemms)
cld_dataVGPLERY <- cld(VGPLERYemms, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataVGPLERY)
merged_df <- merge(emms_df, cld_df,by = c("P"))
VGPLERYP<-ggplot(V80GPLERY, aes(x = P, y = exp(predicted), color = Variety)) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7) +
  labs(x = "Environment", y = "Grain PLER") +
  geom_point(data = emms_df, aes(x = P, y = response, color=Variety), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 2)+
     ggtitle("Year 2")+
   guides(color = "none")+
  scale_y_continuous(breaks = c(0.5,1,1.5,2), limits = c(0, 2))+
       geom_abline(intercept = 1, slope = 0, color = "red", linetype = "dashed")

         
VGPLERP<-grid.arrange(VGPLERXP,VGPLERYP, ncol = 2)
ggsave("VGPLERP.jpg", plot = VGPLERP, width =12, height = 8, dpi = 350)
```

#V IWG PLER year 1 Summer model 
```{r}
V80IPLER$P<-as.factor(V80IPLER$P)
V80IPLER$V<-as.factor(V80IPLER$Variety)
V80IPLER$LER<-as.numeric(V80IPLER$PartialLERI)
V80IPLERX<-V80IPLER[V80IPLER$YearCode == "X",]
V80IPLERXS<-V80IPLERX[V80IPLERX$Harvest == "Summer",]

#linear
modV80IPLERXS<-lmer(LER~V*P + (1|Rep), data= V80IPLERXS)
anova(modV80IPLERXS)
#Check Assumptions
V80IPLERXS_resid<-resid(modV80IPLERXS)
qqnorm(V80IPLERXS_resid)
qqline(V80IPLERXS_resid)
plot(modV80IPLERXS)
#Logtransform
modV80IPLERXS1<-lmer(log(LER)~V*P + (1|Rep), data= V80IPLERXS)
anova(modV80IPLERXS1)
#check assumptions logtransform (makes BETTER)
V80IPLERXS_resid1<-resid(modV80IPLERXS1)
qqnorm(V80IPLERXS_resid1)
qqline(V80IPLERXS_resid1)
plot(modV80IPLERXS1)

#two way emmeans 
V80IPLERXS1emm <- compute_emmeansVXS2("modV80IPLERXS1")
#Pairwise P
emmsP <- emmeans(modV80IPLERXS1, specs = ~ P, type = "response")
cld_dataV80IPLERXSP <- cld(emmsP, Letters=custom_letters) # Create compact letter display

min(V80IPLERXS$LER)
max(V80IPLERXS$LER)
#box plots
ggplot(V80IPLERXS, aes(x = V, y = LER, fill= P)) +
  geom_boxplot() +
  labs(x = "Variety", y = "IWG Partial LER (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between IWG Partial LER and Variety") +  # Add a title
  ylim(0, 1.4) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System") +
  geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")#legend for colors

#Pairwise P
emmsp <- emmeans(modV80IPLERXS1, ~ P, type= "response") # Obtain estimated marginal means 
cld_dataV80IPLERXSp <- cld(emmsp, Letters=custom_letters) # Create compact letter display
cld_dataV80IPLERXSP$response <- format(cld_dataV80IPLERXSP$response, digits = 2)
cld_dataV80IPLERXSP$lower.CL <- format(cld_dataV80IPLERXSP$lower.CL, digits = 2)
cld_dataV80IPLERXSP$upper.CL <- format(cld_dataV80IPLERXSP$upper.CL, digits = 2)
cld_dataV80IPLERXSP<- cld_dataV80IPLERXSP %>%
  select(P, response,lower.CL, upper.CL, .group)
rownames(cld_dataV80IPLERXSP) <- NULL
colnames(cld_dataV80IPLERXSP) <- c("Site", "IPLER", "CI2.5%", "CI97.5%", "Group")
cld_dataV80IPLERXSP  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise V
emmsV <- emmeans(modV80IPLERXS1, ~ V, type= "response") # Obtain estimated marginal means 
cld_dataV80IPLERXSV <- cld(emmsV, Letters=custom_letters) # Create compact letter display
cld_dataV80IPLERXSV$response <- format(cld_dataV80IPLERXSV$response, digits = 2)
cld_dataV80IPLERXSV$lower.CL <- format(cld_dataV80IPLERXSV$lower.CL, digits = 2)
cld_dataV80IPLERXSV$upper.CL <- format(cld_dataV80IPLERXSV$upper.CL, digits = 2)
cld_dataV80IPLERXSV<- cld_dataV80IPLERXSV %>%
  select(V, response, lower.CL, upper.CL, .group)
rownames(cld_dataV80IPLERXSV) <- NULL
colnames(cld_dataV80IPLERXSV) <- c("Variety", "IPLER", "CI2.5%", "CI97.5%", "Group")
cld_dataV80IPLERXSV  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
```
#V IWG pler year 1 fall
```{r}
V80IPLER$P<-as.factor(V80IPLER$P)
V80IPLER$V<-as.factor(V80IPLER$Variety)
V80IPLER$LER<-as.numeric(V80IPLER$PartialLERI)
V80IPLERX<-V80IPLER[V80IPLER$YearCode == "X",]
V80IPLERXF<-V80IPLERX[V80IPLERX$Harvest == "Fall",]
#linear
modV80IPLERXF<-lmer(LER~V*P + (1|Rep), data= V80IPLERXF)
anova(modV80IPLERXF)
#Check Assumptions
V80IPLERXF_resid<-resid(modV80IPLERXF)
qqnorm(V80IPLERXF_resid)
qqline(V80IPLERXF_resid)
plot(modV80IPLERXF)
#Logtransform
modV80IPLERXF1<-lmer(log(LER)~V*P + (1|Rep), data= V80IPLERXF)
anova(modV80IPLERXF1)
#check assumptions logtransform (makes BETTER)
V80IPLERXF_resid1<-resid(modV80IPLERXF1)
qqnorm(V80IPLERXF_resid1)
qqline(V80IPLERXF_resid1)
plot(modV80IPLERXF1)
#two way emmeans 
V80IPLERXF1emm <- compute_emmeansVXF2("modV80IPLERXF1")
#Pairwise P
emmsP <- emmeans(modV80IPLERXF1, specs = ~ P, type = "response")
cld_dataV80IPLERXFP <- cld(emmsP, Letters=custom_letters)# Create compact letter display

min(V80IPLERXF$LER)
max(V80IPLERXF$LER)
#box plots
ggplot(V80IPLERXF, aes(x = V, y = LER, fill= P)) +
  geom_boxplot() +
  labs(x = "Variety", y = "IWG Partial LER (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between IWG Partial LER and Variety") +  # Add a title
  ylim(0, 8.83) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors

#Pairwise P
emmsp <- emmeans(modV80IPLERXF1, ~ P, type= "response") # Obtain estimated marginal means 
cld_dataV80IPLERXFP <- cld(emmsp, Letters=custom_letters) # Create compact letter display
cld_dataV80IPLERXFP$response <- format(cld_dataV80IPLERXFP$response, digits = 2)
cld_dataV80IPLERXFP$lower.CL <- format(cld_dataV80IPLERXFP$lower.CL, digits = 2)
cld_dataV80IPLERXFP$upper.CL <- format(cld_dataV80IPLERXFP$upper.CL, digits = 2)
cld_dataV80IPLERXFP<- cld_dataV80IPLERXFP %>%
  select(P, response,lower.CL, upper.CL, .group)
rownames(cld_dataV80IPLERXFP) <- NULL
colnames(cld_dataV80IPLERXFP) <- c("Site", "IPLER", "CI2.5%", "CI97.5%", "Group")
cld_dataV80IPLERXFP  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise v
emmsV <- emmeans(modV80IPLERXF1, ~ V, type= "response") # Obtain estimated marginal means 
cld_dataV80IPLERXFV<- cld(emmsV, Letters=custom_letters) # Create compact letter display
cld_dataV80IPLERXFV$response <- format(cld_dataV80IPLERXFV$response, digits = 2)
cld_dataV80IPLERXFV$lower.CL <- format(cld_dataV80IPLERXFV$lower.CL, digits = 2)
cld_dataV80IPLERXFV$upper.CL <- format(cld_dataV80IPLERXFV$upper.CL, digits = 3)
cld_dataV80IPLERXFV<- cld_dataV80IPLERXFV %>%
  select(V, response, lower.CL, upper.CL, .group)
rownames(cld_dataV80IPLERXFV) <- NULL
colnames(cld_dataV80IPLERXFV) <- c("Variety", "IPLER", "CI2.5%", "CI97.5%", "Group")
cld_dataV80IPLERXFV  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
```
#V IWG pler year 2 summer 
```{r}
V80IPLER$P<-as.factor(V80IPLER$P)
V80IPLER$V<-as.factor(V80IPLER$Variety)
V80IPLER$LER<-as.numeric(V80IPLER$PartialLERI)
V80IPLERY<-V80IPLER[V80IPLER$YearCode == "Y",]
V80IPLERYS<-V80IPLERY[V80IPLERY$Harvest == "Summer",]

#linear
modV80IPLERYS<-lmer(LER~V*P + (1|Rep), data= V80IPLERYS)
anova(modV80IPLERYS)
#Check Assumptions
V80IPLERYS_resid<-resid(modV80IPLERYS)
qqnorm(V80IPLERYS_resid)
qqline(V80IPLERYS_resid)
plot(modV80IPLERYS)
#Logtransform
modV80IPLERYS1<-lmer(log(LER)~V*P + (1|Rep), data= V80IPLERYS)
anova(modV80IPLERYS1)
#check assumptions logtransform (makes BETTER)
V80IPLERYS_resid1<-resid(modV80IPLERYS1)
qqnorm(V80IPLERYS_resid1)
qqline(V80IPLERYS_resid1)
plot(modV80IPLERYS1)

#two way emmeans 
V80IPLERYS1emm <- compute_emmeansVYS2("modV80IPLERYS1")

min(V80IPLERYS$LER)
max(V80IPLERYS$LER)
#box plots
ggplot(V80IPLERYS, aes(x = V, y = LER, fill= P)) +
  geom_boxplot() +
  labs(x = "Variety", y = "IWG Partial LER (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between IWG Partial LER and Variety") +  # Add a title
  ylim(0, 1.5) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")+
  geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")#legend for colors
#PAIRWISE V
emmsV <- emmeans(modV80IPLERYS1, ~ V, type= "response") # Obtain estimated marginal means 
cld_dataV80IPLERYSV<- cld(emmsV, Letters=custom_letters) # Create compact letter display
cld_dataV80IPLERYSV$response <- format(cld_dataV80IPLERYSV$response, digits = 2)
cld_dataV80IPLERYSV$lower.CL <- format(cld_dataV80IPLERYSV$lower.CL, digits = 2)
cld_dataV80IPLERYSV$upper.CL <- format(cld_dataV80IPLERYSV$upper.CL, digits = 2)
cld_dataV80IPLERYSV<- cld_dataV80IPLERYSV %>%
  select(V, response, lower.CL, upper.CL, .group)
rownames(cld_dataV80IPLERYSV) <- NULL
colnames(cld_dataV80IPLERYSV) <- c("Variety", "IPLER", "CI2.5%", "CI97.5%", "Group")
cld_dataV80IPLERYSV  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
```
#V IWG pler year 2 fall 
```{r}
V80IPLER$P<-as.factor(V80IPLER$P)
V80IPLER$V<-as.factor(V80IPLER$Variety)
V80IPLER$LER<-as.numeric(V80IPLER$PartialLERI)
V80IPLERY<-V80IPLER[V80IPLER$YearCode == "Y",]
V80IPLERYF<-V80IPLERY[V80IPLERY$Harvest == "Fall",]

#linear
modV80IPLERYF<-lmer(LER~V*P + (1|Rep), data= V80IPLERYF)
anova(modV80IPLERYF)
#Check Assumptions
V80IPLERYF_resid<-resid(modV80IPLERYF)
qqnorm(V80IPLERYF_resid)
qqline(V80IPLERYF_resid)
plot(modV80IPLERYF)
#Logtransform
modV80IPLERYF1<-lmer(log(LER)~V*P + (1|Rep), data= V80IPLERYF)
anova(modV80IPLERYF1)
#check assumptions logtransform (makes BETTER)
V80IPLERYF_resid1<-resid(modV80IPLERYF1)
qqnorm(V80IPLERYF_resid1)
qqline(V80IPLERYF_resid1)
plot(modV80IPLERYF1)

#two way emmeans 
V80IPLERYF1emm <- compute_emmeansVYS2("modV80IPLERYF1")
#Pairwise P
emmsP <- emmeans(modV80IPLERYF1, specs = ~ P, type = "response")
cld_dataV80IPLERYFP <- cld(emmsP, Letters=custom_letters)# Create compact letter display
cld_dataV80IPLERYFP$response <- format(cld_dataV80IPLERYFP$response, digits = 2)
cld_dataV80IPLERYFP$lower.CL <- format(cld_dataV80IPLERYFP$lower.CL, digits = 2)
cld_dataV80IPLERYFP$upper.CL <- format(cld_dataV80IPLERYFP$upper.CL, digits = 2)
cld_dataV80IPLERYFP<- cld_dataV80IPLERYFP %>%
  select(P, response,lower.CL, upper.CL, .group)
rownames(cld_dataV80IPLERYFP) <- NULL
colnames(cld_dataV80IPLERYFP) <- c("Site", "IPLER", "CI2.5%", "CI97.5%", "Group")
cld_dataV80IPLERYFP  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

min(V80IPLERYF$LER)
max(V80IPLERYF$LER)
#box plots
ggplot(V80IPLERYF, aes(x = V, y = LER, fill= P)) +
  geom_boxplot() +
  labs(x = "Variety", y = "IWG Partial LER (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between IWG Partial LER and Variety") +  # Add a title
  ylim(0, 5.4) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System") +
geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")#legend for colors

#PAIRWISE V
emmsV <- emmeans(modV80IPLERYF1, ~ V, type= "response") # Obtain estimated marginal means 
cld_dataV80IPLERYFV<- cld(emmsV, Letters=custom_letters) # Create compact letter display
cld_dataV80IPLERYFV$response <- format(cld_dataV80IPLERYFV$response, digits = 3)
cld_dataV80IPLERYFV$lower.CL <- format(cld_dataV80IPLERYFV$lower.CL, digits = 3)
cld_dataV80IPLERYFV$upper.CL <- format(cld_dataV80IPLERYFV$upper.CL, digits = 3)
cld_dataV80IPLERYFV<- cld_dataV80IPLERYFV %>%
  select(V, response, lower.CL, upper.CL, .group)
rownames(cld_dataV80IPLERYFV) <- NULL
colnames(cld_dataV80IPLERYFV) <- c("Variety", "IPLER", "CI2.5%", "CI97.5%", "Group")
cld_dataV80IPLERYFV  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
```

#V IPLER COMBO PLOT summer 
```{r}
V80IPLERXS$Year<-"Year 1 Summer"
V80IPLERYS$Year<-"Year 2 Summer"

desired_orderY3<-c("Year 1 Summer", "Year 2 Summer")

colorsP<-c("MN"="gold", "NY"="red", "KS"="purple", "WI"="white")

combined_dataVIPLERS <- rbind(V80IPLERXS,V80IPLERYS)

combined_dataVIPLERS$Year <- factor(combined_dataVIPLERS$Year, levels = desired_orderY3)
combined_dataVIPLERS$P <- factor(combined_dataVIPLERS$P, levels = desired_order)

max(combined_dataVIPLERS$LER)
min(combined_dataVIPLERS$LER)
VIPLERcomboplotS <- ggplot(combined_dataVIPLERS, aes(x = V, y = LER, fill = P)) +
  geom_boxplot(position = position_dodge(width = 0.75)) +
  labs(x = "Variety", y = "IPLER") +
  ggtitle("IPLER") +
  coord_cartesian(ylim = c(NA, NA)) +
  scale_fill_manual(values = colorsP) +
  facet_wrap(~Year, scales = "free", ncol = 2) +
  ylim(0, 1.5)+
geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")

# Display the combined plot
print(VIPLERcomboplotS)

ggsave("VIPLERcomboplotS.jpg", plot = VIPLERcomboplotS  , width = 8, height = 6, dpi = 300)
```
#V IPLER COMBO PLOT fall 
```{r}
V80IPLERXF$Year<-"Year 1 Fall"
V80IPLERYF$Year<-"Year 2 Fall"

desired_orderY4<-c("Year 1 Fall", "Year 2 Fall")

colorsP<-c("MN"="gold", "NY"="red", "KS"="purple", "WI"="white")

combined_dataVIPLERF <- rbind(V80IPLERXF,V80IPLERYF)

combined_dataVIPLERF$Year <- factor(combined_dataVIPLERF$Year, levels = desired_orderY4)
combined_dataVIPLERF$P <- factor(combined_dataVIPLERF$P, levels = desired_order)

max(combined_dataVIPLERF$LER)
min(combined_dataVIPLERF$LER)
VIPLERcomboplotF <- ggplot(combined_dataVIPLERF, aes(x = V, y = LER, fill = P)) +
  geom_boxplot(position = position_dodge(width = 0.75)) +
  labs(x = "Variety", y = "IPLER") +
  ggtitle("IPLER") +
  coord_cartesian(ylim = c(NA, NA)) +
  scale_fill_manual(values = colorsP) +
  facet_wrap(~Year, scales = "free", ncol = 2) +
  ylim(0, 8.9)+
geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")

# Display the combined plot
print(VIPLERcomboplotF)

ggsave("VIPLERcomboplotF.jpg", plot = VIPLERcomboplotF  , width = 8, height = 6, dpi = 300)
```

#V IPLER redone plots 
```{r}
#XS
V80IPLERXS$predicted <- predict(modV80IPLERXS1, newdata = V80IPLERXS, re.form = NA)
VIPLERXSemms <- emmeans(modV80IPLERXS1, ~ P, type = "response")
emms_df <- as.data.frame(VIPLERXSemms)
cld_dataVIPLERXS <- cld(VIPLERXSemms, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataVIPLERXS)
merged_df <- merge(emms_df, cld_df,by = c("P"))
VIPLERXSP<-ggplot(V80IPLERXS, aes(x = P, y = exp(predicted), color = Variety)) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7) +
  labs(x = "Environment", y = "IWG PLER") +
  geom_point(data = emms_df, aes(x = P, y = response, color=Variety), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 2)+
     ggtitle("Year 1 Summer")+
   guides(color = "none")+
  scale_y_continuous(breaks = c(0.25,0.5,0.75,1), limits = c(0, 1.1))+
       geom_abline(intercept = 1, slope = 0, color = "red", linetype = "dashed")

#XF
V80IPLERXF$predicted <- predict(modV80IPLERXF1, newdata = V80IPLERXF, re.form = NA)
VIPLERXFemms <- emmeans(modV80IPLERXF1, ~ P, type = "response")
emms_df <- as.data.frame(VIPLERXFemms)
cld_dataVIPLERXF <- cld(VIPLERXFemms, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataVIPLERXF)
merged_df <- merge(emms_df, cld_df,by = c("P"))
VIPLERXFP<-ggplot(V80IPLERXF, aes(x = P, y = exp(predicted), color = Variety)) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7) +
  labs(x = "Environment", y = "IWG PLER") +
  geom_point(data = emms_df, aes(x = P, y = response, color=Variety), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 2)+
     ggtitle("Year 1 Fall")+
   guides(color = "none")+
  scale_y_continuous(breaks = c(0.5,1,1.5, 2,2.5,3), limits = c(0, 3.1))+
       geom_abline(intercept = 1, slope = 0, color = "red", linetype = "dashed")

#YS
V80IPLERYS$predicted <- predict(modV80IPLERYS1, newdata = V80IPLERYS, re.form = NA)
VIPLERYSemms <- emmeans(modV80IPLERYS1, ~ P, type = "response")
emms_df <- as.data.frame(VIPLERYSemms)
cld_dataVIPLERYS <- cld(VIPLERYSemms, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataVIPLERYS)
merged_df <- merge(emms_df, cld_df,by = c("P"))
VIPLERYSP<-ggplot(V80IPLERYS, aes(x = P, y = exp(predicted), color = Variety)) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7) +
  labs(x = "Environment", y = "IWG PLER") +
  geom_point(data = emms_df, aes(x = P, y = response, color=Variety), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 2)+
     ggtitle("Year 2 Summer")+
   guides(color = "none")+
  scale_y_continuous(breaks = c(0.25,0.5,0.75,1), limits = c(0, 1.1))+
       geom_abline(intercept = 1, slope = 0, color = "red", linetype = "dashed")
     
 #YF
V80IPLERYF$predicted <- predict(modV80IPLERYF1, newdata = V80IPLERYF, re.form = NA)
VIPLERYFemms <- emmeans(modV80IPLERYF1, ~ P, type = "response")
emms_df <- as.data.frame(VIPLERYFemms)
cld_dataVIPLERYF <- cld(VIPLERYFemms, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataVIPLERYF)
merged_df <- merge(emms_df, cld_df,by = c("P"))
VIPLERYFP<-ggplot(V80IPLERYF, aes(x = P, y = exp(predicted), color = Variety)) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7) +
  labs(x = "Environment", y = "IWG PLER") +
  geom_point(data = emms_df, aes(x = P, y = response, color=Variety), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 2)+
     ggtitle("Year 2 Fall")+
  scale_y_continuous(breaks = c(0.5,1,1.5, 2,2.5,3), limits = c(0, 3.1))+
       geom_abline(intercept = 1, slope = 0, color = "red", linetype = "dashed")
         
VIPLERP<-grid.arrange(VIPLERXSP,VIPLERXFP,VIPLERYSP,VIPLERYFP, ncol = 2)
ggsave("VIPLERP.jpg", plot = VIPLERP, width =12, height = 8, dpi = 350)
```

#V Alf PLER year 1 summer  
```{r}
V80APLER$P<-as.factor(V80APLER$P)
V80APLER$V<-as.factor(V80APLER$Variety)
V80APLER$LER<-as.numeric(V80APLER$PartialLERA)
V80APLERX<-V80APLER[V80APLER$YearCode == "X",]
V80APLERXS<-V80APLERX[V80APLERX$Harvest == "Summer",]

#linear
modV80APLERXS<-lmer(LER~V*P + (1|Rep), data= V80APLERXS)
anova(modV80APLERXS)
#Check Assumptions
V80APLERXS_resid<-resid(modV80APLERXS)
qqnorm(V80APLERXS_resid)
qqline(V80APLERXS_resid)
plot(modV80APLERXS)
#Logtransform
modV80APLERXS1<-lmer(log(LER)~V*P + (1|Rep), data= V80APLERXS)
anova(modV80APLERXS1)
#check assumptions logtransform (makes BETTER)
V80APLERXS_resid1<-resid(modV80APLERXS1)
qqnorm(V80APLERXS_resid1)
qqline(V80APLERXS_resid1)
plot(modV80APLERXS1)


min(V80APLERXS$LER)
max(V80APLERXS$LER)
ggplot(V80APLERXS, aes(x = V, y = LER, fill= P)) +
  geom_boxplot() +
  labs(x = "Variety", y = "Alf Partial LER (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between Alf Partial LER and Variety") +  # Add a title
  ylim(0, 1.4) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System") +
geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")

#Pairwise P
emmsP <- emmeans(modV80APLERXS1, specs = ~ P, type = "response")
cld_dataV80APLERXS1P <- cld(emmsP, Letters=custom_letters) # Create compact letter display
cld_dataV80APLERXS1P$response <- format(cld_dataV80APLERXS1P$response, digits = 2)
cld_dataV80APLERXS1P$lower.CL <- format(cld_dataV80APLERXS1P$lower.CL, digits = 2)
cld_dataV80APLERXS1P$upper.CL <- format(cld_dataV80APLERXS1P$upper.CL, digits = 2)
cld_dataV80APLERXS1P<- cld_dataV80APLERXS1P %>%
  select(P, response,lower.CL, upper.CL, .group)
rownames(cld_dataV80APLERXS1P) <- NULL
colnames(cld_dataV80APLERXS1P) <- c("Site", "APLER","CI2.5%", "CI97.5%","Group")
cld_dataV80APLERXS1P  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#PAIRWISE V
emmsV <- emmeans(modV80APLERXS1, ~ V, type= "response") # Obtain estimated marginal means 
cld_dataV80APLERXSV<- cld(emmsV, Letters=custom_letters) # Create compact letter display
cld_dataV80APLERXSV$response <- format(cld_dataV80APLERXSV$response, digits = 2)
cld_dataV80APLERXSV$lower.CL <- format(cld_dataV80APLERXSV$lower.CL, digits = 2)
cld_dataV80APLERXSV$upper.CL <- format(cld_dataV80APLERXSV$upper.CL, digits = 2)
cld_dataV80APLERXSV<- cld_dataV80APLERXSV %>%
  select(V, response, lower.CL, upper.CL, .group)
rownames(cld_dataV80APLERXSV) <- NULL
colnames(cld_dataV80APLERXSV) <- c("Variety", "APLER", "CI2.5%", "CI97.5%", "Group")
cld_dataV80APLERXSV  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)


```
#V Alf PLER year 1 fall  
```{r}
V80APLERXF<-V80APLERX[V80APLERX$Harvest == "Fall",]
#linear
modV80APLERXF<-lmer(LER~V*P + (1|Rep), data= V80APLERXF)
anova(modV80APLERXF)
#Check Assumptions
V80APLERXF_resid<-resid(modV80APLERXF)
qqnorm(V80APLERXF_resid)
qqline(V80APLERXF_resid)
plot(modV80APLERXF)
#Logtransform
modV80APLERXF1<-lmer(log(LER)~V*P + (1|Rep), data= V80APLERXF)
anova(modV80APLERXF1)
#check assumptions logtransform (makes BETTER)
V80APLERXF_resid1<-resid(modV80APLERXF1)
qqnorm(V80APLERXF_resid1)
qqline(V80APLERXF_resid1)
plot(modV80APLERXF1)


min(V80APLERXF$LER)
max(V80APLERXF$LER)
ggplot(V80APLERXF, aes(x = V, y = LER, fill= P)) +
  geom_boxplot() +
  labs(x = "Variety", y = "Alf Partial LER (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between Alf Partial LER and Variety") +  # Add a title
  ylim(0, 2) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System") +
geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")
#Pairwise P
emmsP <- emmeans(modV80APLERXF1, specs = ~ P, type = "response")
cld_dataV80APLERXF1P <- cld(emmsP, Letters=custom_letters) # Create compact letter display
cld_dataV80APLERXF1P$response <- format(cld_dataV80APLERXF1P$response, digits = 2)
cld_dataV80APLERXF1P$lower.CL <- format(cld_dataV80APLERXF1P$lower.CL, digits = 2)
cld_dataV80APLERXF1P$upper.CL <- format(cld_dataV80APLERXF1P$upper.CL, digits = 2)
cld_dataV80APLERXF1P<- cld_dataV80APLERXF1P %>%
  select(P, response,lower.CL, upper.CL, .group)
rownames(cld_dataV80APLERXF1P) <- NULL
colnames(cld_dataV80APLERXF1P) <- c("Site", "APLER","CI2.5%", "CI97.5%","Group")
cld_dataV80APLERXF1P  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

#PAIRWISE V
emmsV <- emmeans(modV80APLERXF1, ~ V, type= "response") # Obtain estimated marginal means 
cld_dataV80APLERXFV<- cld(emmsV, Letters=custom_letters) # Create compact letter display
cld_dataV80APLERXFV$response <- format(cld_dataV80APLERXFV$response, digits = 2)
cld_dataV80APLERXFV$lower.CL <- format(cld_dataV80APLERXFV$lower.CL, digits = 2)
cld_dataV80APLERXFV$upper.CL <- format(cld_dataV80APLERXFV$upper.CL, digits = 2)
cld_dataV80APLERXFV<- cld_dataV80APLERXFV %>%
  select(V, response, lower.CL, upper.CL, .group)
rownames(cld_dataV80APLERXFV) <- NULL
colnames(cld_dataV80APLERXFV) <- c("Variety", "APLER", "CI2.5%", "CI97.5%", "Group")
cld_dataV80APLERXFV  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
```
#V Alf PLER year 2 summer  
```{r}
V80APLERY<-V80APLER[V80APLER$YearCode == "Y",]
V80APLERYS<-V80APLERY[V80APLERY$Harvest == "Summer",]

#linear
modV80APLERYS<-lmer(LER~V*P + (1|Rep), data= V80APLERYS)
anova(modV80APLERYS)
#Check Assumptions
V80APLERYS_resid<-resid(modV80APLERYS)
qqnorm(V80APLERYS_resid)
qqline(V80APLERYS_resid)
plot(modV80APLERYS)
#Logtransform
modV80APLERYS1<-lmer(log(LER)~V*P + (1|Rep), data= V80APLERYS)
anova(modV80APLERYS1)
#check assumptions logtransform (makes BETTER)
V80APLERYS_resid1<-resid(modV80APLERYS1)
qqnorm(V80APLERYS_resid1)
qqline(V80APLERYS_resid1)
plot(modV80APLERYS1)

min(V80APLERYS$LER)
max(V80APLERYS$LER)
ggplot(V80APLERYS, aes(x = V, y = LER, fill= P)) +
  geom_boxplot() +
  labs(x = "Variety", y = "Alf Partial LER (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between Alf Partial LER and Variety") +  # Add a title
  ylim(0, 2) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System") +
geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")

#Pairwise P
emmsP <- emmeans(modV80APLERYS1, specs = ~ P, type = "response")
cld_dataV80APLERYS1P <- cld(emmsP, Letters=custom_letters) # Create compact letter display
cld_dataV80APLERYS1P$response <- format(cld_dataV80APLERYS1P$response, digits = 2)
cld_dataV80APLERYS1P$lower.CL <- format(cld_dataV80APLERYS1P$lower.CL, digits = 2)
cld_dataV80APLERYS1P$upper.CL <- format(cld_dataV80APLERYS1P$upper.CL, digits = 2)
cld_dataV80APLERYS1P<- cld_dataV80APLERYS1P %>%
  select(P, response,lower.CL, upper.CL, .group)
rownames(cld_dataV80APLERYS1P) <- NULL
colnames(cld_dataV80APLERYS1P) <- c("Site", "APLER","CI2.5%", "CI97.5%", "Group")
cld_dataV80APLERYS1P  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

#PAIRWISE V
emmsV <- emmeans(modV80APLERYS1, ~ V, type= "response") # Obtain estimated marginal means 
cld_dataV80APLERYSV<- cld(emmsV, Letters=custom_letters) # Create compact letter display
cld_dataV80APLERYSV$response <- format(cld_dataV80APLERYSV$response, digits = 2)
cld_dataV80APLERYSV$lower.CL <- format(cld_dataV80APLERYSV$lower.CL, digits = 2)
cld_dataV80APLERYSV$upper.CL <- format(cld_dataV80APLERYSV$upper.CL, digits = 2)
cld_dataV80APLERYSV<- cld_dataV80APLERYSV %>%
  select(V, response, lower.CL, upper.CL, .group)
rownames(cld_dataV80APLERYSV) <- NULL
colnames(cld_dataV80APLERYSV) <- c("Variety", "APLER", "CI2.5%", "CI97.5%", "Group")
cld_dataV80APLERYSV  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

```
#V Alf PLER year 2 fall  
```{r}
V80APLERYF<-V80APLERY[V80APLERY$Harvest == "Fall",]
#linear
modV80APLERYF<-lmer(LER~V*P + (1|Rep), data= V80APLERYF)
anova(modV80APLERYF)
#Check Assumptions
V80APLERYF_resid<-resid(modV80APLERYF)
qqnorm(V80APLERYF_resid)
qqline(V80APLERYF_resid)
plot(modV80APLERYF)
#Logtransform
modV80APLERYF1<-lmer(log(LER)~V*P + (1|Rep), data= V80APLERYF)
anova(modV80APLERYF1)
#check assumptions logtransform (makes BETTER)
V80APLERYF_resid1<-resid(modV80APLERYF1)
qqnorm(V80APLERYF_resid1)
qqline(V80APLERYF_resid1)
plot(modV80APLERYF1)


min(V80APLERYF$LER)
max(V80APLERYF$LER)
ggplot(V80APLERYF, aes(x = V, y = LER, fill= P)) +
  geom_boxplot() +
  labs(x = "Variety", y = "Alf Partial LER (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between Alf Partial LER and Variety") +  # Add a title
  ylim(0.4, 2.4) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System") +
geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")

#Pairwise P
emmsP <- emmeans(modV80APLERYF1, specs = ~ P, type = "response")
cld_dataV80APLERYF1P <- cld(emmsP, Letters=custom_letters) # Create compact letter display
cld_dataV80APLERYF1P$response <- format(cld_dataV80APLERYF1P$response, digits = 2)
cld_dataV80APLERYF1P$lower.CL <- format(cld_dataV80APLERYF1P$lower.CL, digits = 2)
cld_dataV80APLERYF1P$upper.CL <- format(cld_dataV80APLERYF1P$upper.CL, digits = 3)
cld_dataV80APLERYF1P<- cld_dataV80APLERYF1P %>%
  select(P, response, lower.CL, upper.CL, .group)
rownames(cld_dataV80APLERYF1P) <- NULL
colnames(cld_dataV80APLERYF1P) <- c("Site", "APLER", "CI2.5%", "CI97.5%", "Group")
cld_dataV80APLERYF1P  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#PAIRWISE V
emmsV <- emmeans(modV80APLERYF1, ~ V, type= "response") # Obtain estimated marginal means 
cld_dataV80APLERYFV<- cld(emmsV, Letters=custom_letters) # Create compact letter display
cld_dataV80APLERYFV$response <- format(cld_dataV80APLERYFV$response, digits = 2)
cld_dataV80APLERYFV$lower.CL <- format(cld_dataV80APLERYFV$lower.CL, digits = 2)
cld_dataV80APLERYFV$upper.CL <- format(cld_dataV80APLERYFV$upper.CL, digits = 3)
cld_dataV80APLERYFV<- cld_dataV80APLERYFV %>%
  select(V, response, lower.CL, upper.CL, .group)
rownames(cld_dataV80APLERYFV) <- NULL
colnames(cld_dataV80APLERYFV) <- c("Variety", "APLER", "CI2.5%", "CI97.5%", "Group")
cld_dataV80APLERYFV  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
```
#V APLER combo plot
```{r}
V80APLERXS$Year<-"Year 1 Summer"
V80APLERXF$Year<-"Year 1 Fall"
V80APLERYS$Year<-"Year 2 Summer"
V80APLERYF$Year<-"Year 2 Fall"


colorsP<-c("MN"="gold", "NY"="red", "KS"="purple", "WI"="white")

combined_dataVAPLER <- rbind(V80APLERXS,V80APLERXF,V80APLERYS,V80APLERYF)

combined_dataVAPLER$Year <- factor(combined_dataVAPLER$Year, levels = desired_orderY)
combined_dataVAPLER$P <- factor(combined_dataVAPLER$P, levels = desired_order)

max(combined_dataVAPLER$LER)
min(combined_dataVAPLER$LER)
VAPLERcomboplot <- ggplot(combined_dataVAPLER, aes(x = V, y = LER, fill = P)) +
  geom_boxplot(position = position_dodge(width = 0.75)) +
  labs(x = "Variety", y = "APLER") +
  ggtitle("APLER") +
  coord_cartesian(ylim = c(NA, NA)) +
  scale_fill_manual(values = colorsP) +
  facet_wrap(~Year, scales = "free", ncol = 2) +
  ylim(0, 2.6)+
geom_abline(intercept = 0.5, slope = 0, color = "red", linetype = "dashed")

# Display the combined plot
print(VAPLERcomboplot)

ggsave("VAPLERcomboplot.jpg", plot = VAPLERcomboplot  , width = 8, height = 6, dpi = 300)
```

#V APLER redone plots 
```{r}
#XS
V80APLERXS$predicted <- predict(modV80APLERXS1, newdata = V80APLERXS, re.form = NA)
VAPLERXSemms <- emmeans(modV80APLERXS1, ~ P, type = "response")
emms_df <- as.data.frame(VAPLERXSemms)
cld_dataVAPLERXS <- cld(VAPLERXSemms, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataVAPLERXS)
merged_df <- merge(emms_df, cld_df,by = c("P"))
VAPLERXSP<-ggplot(V80APLERXS, aes(x = P, y = exp(predicted), color = Variety)) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7) +
  labs(x = "Environment", y = "Alfalfa PLER") +
  geom_point(data = emms_df, aes(x = P, y = response, color=Variety), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 2)+
     ggtitle("Year 1 Summer")+
   guides(color = "none")+
  scale_y_continuous(breaks = c(0.5,1,1.5), limits = c(0, 1.5))+
       geom_abline(intercept = 1, slope = 0, color = "red", linetype = "dashed")

#XF
V80APLERXF$predicted <- predict(modV80APLERXF1, newdata = V80APLERXF, re.form = NA)
VAPLERXFemms <- emmeans(modV80APLERXF1, ~ P, type = "response")
emms_df <- as.data.frame(VAPLERXFemms)
cld_dataVAPLERXF <- cld(VAPLERXFemms, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataVAPLERXF)
merged_df <- merge(emms_df, cld_df,by = c("P"))
VAPLERXFP<-ggplot(V80APLERXF, aes(x = P, y = exp(predicted), color = Variety)) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7) +
  labs(x = "Environment", y = "Alfalfa PLER") +
  geom_point(data = emms_df, aes(x = P, y = response, color=Variety), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 2)+
     ggtitle("Year 1 Fall")+
   guides(color = "none")+
  scale_y_continuous(breaks = c(0.5,1,1.5), limits = c(0, 1.5))+
       geom_abline(intercept = 1, slope = 0, color = "red", linetype = "dashed")

#YS
V80APLERYS$predicted <- predict(modV80APLERYS1, newdata = V80APLERYS, re.form = NA)
VAPLERYSemms <- emmeans(modV80APLERYS1, ~ P, type = "response")
emms_df <- as.data.frame(VAPLERYSemms)
cld_dataVAPLERYS <- cld(VAPLERYSemms, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataVAPLERYS)
merged_df <- merge(emms_df, cld_df,by = c("P"))
VAPLERYSP<-ggplot(V80APLERYS, aes(x = P, y = exp(predicted), color = Variety)) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7) +
  labs(x = "Environment", y = "Alfalfa PLER") +
  geom_point(data = emms_df, aes(x = P, y = response, color=Variety), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 2)+
     ggtitle("Year 2 Summer")+
   guides(color = "none")+
  scale_y_continuous(breaks = c(0.5,1,1.5), limits = c(0, 1.5))+
       geom_abline(intercept = 1, slope = 0, color = "red", linetype = "dashed")
     
 #YF
V80APLERYF$predicted <- predict(modV80APLERYF1, newdata = V80APLERYF, re.form = NA)
VAPLERYFemms <- emmeans(modV80APLERYF1, ~ P, type = "response")
emms_df <- as.data.frame(VAPLERYFemms)
cld_dataVAPLERYF <- cld(VAPLERYFemms, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataVAPLERYF)
merged_df <- merge(emms_df, cld_df,by = c("P"))
VAPLERYFP<-ggplot(V80APLERYF, aes(x = P, y = exp(predicted), color = Variety)) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7) +
  labs(x = "Environment", y = "Alfalfa PLER") +
  geom_point(data = emms_df, aes(x = P, y = response, color=Variety), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 2)+
     ggtitle("Year 2 Fall")+
  scale_y_continuous(breaks = c(0.5,1,1.5), limits = c(0, 1.5))+
       geom_abline(intercept = 1, slope = 0, color = "red", linetype = "dashed")
         
VAPLERP<-grid.arrange(VAPLERXSP,VAPLERXFP,VAPLERYSP,VAPLERYFP, ncol = 2)
ggsave("VAPLERP.jpg", plot = VAPLERP, width =12, height = 8, dpi = 350)
```

#V TLER year 1 summer
```{r}
V80TLER$P<-as.factor(V80TLER$P)
V80TLER$V<-as.factor(V80TLER$Variety)
V80TLER$LER<-as.numeric(V80TLER$TLER)
V80TLERX<-V80TLER[V80TLER$YearCode == "X",]
V80TLERXS<-V80TLERX[V80TLERX$Harvest == "Summer",]

#linear
modV80TLERXS<-lmer(LER~V*P + (1|Rep), data= V80TLERXS)
anova(modV80TLERXS)
#Check Assumptions
V80TLERXS_resid<-resid(modV80TLERXS)
qqnorm(V80TLERXS_resid)
qqline(V80TLERXS_resid)
plot(modV80TLERXS)
#Logtransform
modV80TLERXS1<-lmer(log(LER)~V*P + (1|Rep), data= V80TLERXS)
anova(modV80TLERXS1)
#check assumptions logtransform (makes BETTER)
V80TLERXS_resid1<-resid(modV80TLERXS1)
qqnorm(V80TLERXS_resid1)
qqline(V80TLERXS_resid1)
plot(modV80TLERXS1)

mean(V80TLERXS$LER)

min(V80TLERXS$LER)
max(V80TLERXS$LER)
ggplot(V80TLERXS, aes(x = V, y = LER, fill= P)) +
  geom_boxplot() +
  labs(x = "Variety", y = "Total Forage LER (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between Total Forage LER and Variety") +  # Add a title
  ylim(0.5, 3.4) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System") +
geom_abline(intercept = 1, slope = 0, color = "red", linetype = "dashed")

#PAIRWISE V
emmsV <- emmeans(modV80TLERXS1, ~ V, type= "response") # Obtain estimated marginal means 
cld_dataV80TLERXS1V<- cld(emmsV, Letters=custom_letters) # Create compact letter display
cld_dataV80TLERXS1V$response <- format(cld_dataV80TLERXS1V$response, digits = 3)
cld_dataV80TLERXS1V$lower.CL <- format(cld_dataV80TLERXS1V$lower.CL, digits = 2)
cld_dataV80TLERXS1V$upper.CL <- format(cld_dataV80TLERXS1V$upper.CL, digits = 3)
cld_dataV80TLERXS1V<- cld_dataV80TLERXS1V %>%
  select(V, response, lower.CL, upper.CL, .group)
rownames(cld_dataV80TLERXS1V) <- NULL
colnames(cld_dataV80TLERXS1V) <- c("Variety", "TLER", "CI2.5%", "CI97.5%", "Group")
cld_dataV80TLERXS1V  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
```
#V TLER year 1 fall
```{r}
V80TLERXF<-V80TLERX[V80TLERX$Harvest == "Fall",]

#linear
modV80TLERXF<-lmer(LER~V*P + (1|Rep), data= V80TLERXF)
anova(modV80TLERXF)
#Check Assumptions
V80TLERXF_resid<-resid(modV80TLERXF)
qqnorm(V80TLERXF_resid)
qqline(V80TLERXF_resid)
plot(modV80TLERXF)
#Logtransform
modV80TLERXF1<-lmer(log(LER)~V*P + (1|Rep), data= V80TLERXF)
anova(modV80TLERXF1)
#check assumptions logtransform (makes BETTER)
V80TLERXF_resid1<-resid(modV80TLERXF1)
qqnorm(V80TLERXF_resid1)
qqline(V80TLERXF_resid1)
plot(modV80TLERXF1)

min(V80TLERXF$LER)
max(V80TLERXF$LER)
ggplot(V80TLERXF, aes(x = V, y = LER, fill= P)) +
  geom_boxplot() +
  labs(x = "Variety", y = "Total Forage LER (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between Total Forage LER and Variety") +  # Add a title
  ylim(0.5, 9.6) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System") +
geom_abline(intercept = 1, slope = 0, color = "red", linetype = "dashed")

#Pairwise P
emmsP <- emmeans(modV80TLERXF1, specs = ~ P, type = "response")
cld_dataV80TLERXF1P <- cld(emmsP, Letters=custom_letters) # Create compact letter display
cld_dataV80TLERXF1P$response <- format(cld_dataV80TLERXF1P$response, digits = 3)
cld_dataV80TLERXF1P$lower.CL <- format(cld_dataV80TLERXF1P$lower.CL, digits = 3)
cld_dataV80TLERXF1P$upper.CL <- format(cld_dataV80TLERXF1P$upper.CL, digits = 3)
cld_dataV80TLERXF1P<- cld_dataV80TLERXF1P %>%
  select(P, response,lower.CL, upper.CL, .group)
rownames(cld_dataV80TLERXF1P) <- NULL
colnames(cld_dataV80TLERXF1P) <- c("Site", "TLER","CI2.5%", "CI97.5%","Group")
cld_dataV80TLERXF1P  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#PAIRWISE V
emmsV <- emmeans(modV80TLERXF1, ~ V, type= "response") # Obtain estimated marginal means 
cld_dataV80TLERXF1V<- cld(emmsV, Letters=custom_letters) # Create compact letter display
cld_dataV80TLERXF1V$response <- format(cld_dataV80TLERXF1V$response, digits = 3)
cld_dataV80TLERXF1V$lower.CL <- format(cld_dataV80TLERXF1V$lower.CL, digits = 3)
cld_dataV80TLERXF1V$upper.CL <- format(cld_dataV80TLERXF1V$upper.CL, digits = 3)
cld_dataV80TLERXF1V<- cld_dataV80TLERXF1V %>%
  select(V, response, lower.CL, upper.CL, .group)
rownames(cld_dataV80TLERXF1V) <- NULL
colnames(cld_dataV80TLERXF1V) <- c("Variety", "TLER", "CI2.5%", "CI97.5%", "Group")
cld_dataV80TLERXF1V  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
```
#V TLER year 2 summer
```{r}
V80TLERY<-V80TLER[V80TLER$YearCode == "Y",]
V80TLERYS<-V80TLERY[V80TLERY$Harvest == "Summer",]

#linear
modV80TLERYS<-lmer(LER~V*P + (1|Rep), data= V80TLERYS)
anova(modV80TLERYS)
#Check Assumptions
V80TLERYS_resid<-resid(modV80TLERYS)
qqnorm(V80TLERYS_resid)
qqline(V80TLERYS_resid)
plot(modV80TLERYS)
#Logtransform
modV80TLERYS1<-lmer(log(LER)~V*P + (1|Rep), data= V80TLERYS)
anova(modV80TLERYS1)
#check assumptions logtransform (makes BETTER)
V80TLERYS_resid1<-resid(modV80TLERYS1)
qqnorm(V80TLERYS_resid1)
qqline(V80TLERYS_resid1)
plot(modV80TLERYS1)

min(V80TLERYS$LER)
max(V80TLERYS$LER)
ggplot(V80TLERYS, aes(x = V, y = LER, fill= P)) +
  geom_boxplot() +
  labs(x = "Variety", y = "Total Forage LER (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between Total Forage LER and Variety") +  # Add a title
  ylim(0.5, 2.6) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System") +
geom_abline(intercept = 1, slope = 0, color = "red", linetype = "dashed")

#Pairwise P
emmsP <- emmeans(modV80TLERYS1, specs = ~ P, type = "response")
cld_dataV80TLERYS1P <- cld(emmsP, Letters=custom_letters) # Create compact letter display
cld_dataV80TLERYS1P$response <- format(cld_dataV80TLERYS1P$response, digits = 2)
cld_dataV80TLERYS1P$lower.CL <- format(cld_dataV80TLERYS1P$lower.CL, digits = 2)
cld_dataV80TLERYS1P$upper.CL <- format(cld_dataV80TLERYS1P$upper.CL, digits = 3)
cld_dataV80TLERYS1P<- cld_dataV80TLERYS1P %>%
  select(P, response, lower.CL, upper.CL,.group)
rownames(cld_dataV80TLERYS1P) <- NULL
colnames(cld_dataV80TLERYS1P) <- c("Site", "TLER","CI2.5%", "CI97.5%","Group")
cld_dataV80TLERYS1P  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#PAIRWISE V
emmsV <- emmeans(modV80TLERYS1, ~ V, type= "response") # Obtain estimated marginal means 
cld_dataV80TLERYS1V<- cld(emmsV, Letters=custom_letters) # Create compact letter display
cld_dataV80TLERYS1V$response <- format(cld_dataV80TLERYS1V$response, digits = 3)
cld_dataV80TLERYS1V$lower.CL <- format(cld_dataV80TLERYS1V$lower.CL, digits = 3)
cld_dataV80TLERYS1V$upper.CL <- format(cld_dataV80TLERYS1V$upper.CL, digits = 3)
cld_dataV80TLERYS1V<- cld_dataV80TLERYS1V %>%
  select(V, response, lower.CL, upper.CL, .group)
rownames(cld_dataV80TLERYS1V) <- NULL
colnames(cld_dataV80TLERYS1V) <- c("Variety", "TLER", "CI2.5%", "CI97.5%", "Group")
cld_dataV80TLERYS1V  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
```
#V TLER year 2 fall
```{r}
V80TLERYF<-V80TLERY[V80TLERY$Harvest == "Fall",]
V80TLER
#linear
modV80TLERYF<-lmer(LER~V*P + (1|Rep), data= V80TLERYF)
anova(modV80TLERYF)
#Check Assumptions
V80TLERYF_resid<-resid(modV80TLERYF)
qqnorm(V80TLERYF_resid)
qqline(V80TLERYF_resid)
plot(modV80TLERYF)
#Logtransform
modV80TLERYF1<-lmer(log(LER)~V*P + (1|Rep), data= V80TLERYF)
anova(modV80TLERYF1)
#check assumptions logtransform (makes BETTER)
V80TLERYF_resid1<-resid(modV80TLERYF1)
qqnorm(V80TLERYF_resid1)
qqline(V80TLERYF_resid1)
plot(modV80TLERYF1)

min(V80TLERYF$LER)
max(V80TLERYF$LER)
ggplot(V80TLERYF, aes(x = V, y = LER, fill= P)) +
  geom_boxplot() +
  labs(x = "Variety", y = "Total Forage LER (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between Total Forage LER and Variety") +  # Add a title
  ylim(1, 6.9) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System") +
geom_abline(intercept = 1, slope = 0, color = "red", linetype = "dashed")

#Pairwise P
emmsP <- emmeans(modV80TLERYF1, specs = ~ P, type = "response")
cld_dataV80TLERYF1P <- cld(emmsP, Letters=custom_letters) # Create compact letter display
cld_dataV80TLERYF1P$response <- format(cld_dataV80TLERYF1P$response, digits = 3)
cld_dataV80TLERYF1P$lower.CL <- format(cld_dataV80TLERYF1P$lower.CL, digits = 3)
cld_dataV80TLERYF1P$upper.CL <- format(cld_dataV80TLERYF1P$upper.CL, digits = 3)
cld_dataV80TLERYF1P<- cld_dataV80TLERYF1P %>%
  select(P, response, lower.CL, upper.CL,.group)
rownames(cld_dataV80TLERYF1P) <- NULL
colnames(cld_dataV80TLERYF1P) <- c("Site", "TLER","CI2.5%", "CI97.5%","Group")
cld_dataV80TLERYF1P  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#PAIRWISE V
emmsV <- emmeans(modV80TLERYF1, ~ V, type= "response") # Obtain estimated marginal means 
cld_dataV80TLERYF1V<- cld(emmsV, Letters=custom_letters) # Create compact letter display
cld_dataV80TLERYF1V$response <- format(cld_dataV80TLERYF1V$response, digits = 3)
cld_dataV80TLERYF1V$lower.CL <- format(cld_dataV80TLERYF1V$lower.CL, digits = 3)
cld_dataV80TLERYF1V$upper.CL <- format(cld_dataV80TLERYF1V$upper.CL, digits = 3)
cld_dataV80TLERYF1V<- cld_dataV80TLERYF1V %>%
  select(V, response, lower.CL, upper.CL, .group)
rownames(cld_dataV80TLERYF1V) <- NULL
colnames(cld_dataV80TLERYF1V) <- c("Variety", "TLER", "CI2.5%", "CI97.5%", "Group")
cld_dataV80TLERYF1V  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
```
#VTLER combo plots Summer
```{r}
V80TLERXS$Year<-"Year 1 Summer"
V80TLERYS$Year<-"Year 2 Summer"


colorsP<-c("MN"="gold", "NY"="red", "KS"="purple", "WI"="white")

combined_dataVTLERS <- rbind(V80TLERXS,V80TLERYS)

combined_dataVTLERS$Year <- factor(combined_dataVTLERS$Year, levels = desired_orderY3)
combined_dataVTLERS$P <- factor(combined_dataVTLERS$P, levels = desired_order)

max(combined_dataVTLERS$LER)
min(combined_dataVTLERS$LER)
VTLERcomboplotS <- ggplot(combined_dataVTLERS, aes(x = V, y = LER, fill = P)) +
  geom_boxplot(position = position_dodge(width = 0.75)) +
  labs(x = "Variety", y = "TLER") +
  ggtitle("TLER") +
  coord_cartesian(ylim = c(NA, NA)) +
  scale_fill_manual(values = colorsP) +
  facet_wrap(~Year, scales = "free", ncol = 2) +
  ylim(0, 3.5) +
geom_abline(intercept = 1, slope = 0, color = "red", linetype = "dashed")


# Display the combined plot
print(VTLERcomboplotS)

ggsave("VTLERcomboplotS.jpg", plot = VTLERcomboplotS  , width = 8, height = 6, dpi = 300)
```
#VTLER combo plots Summer NEW (XF, YS, YF)
```{r}
#XS
V80TLERXS$predicted <- predict(modV80TLERXS1, newdata = V80TLERXS, re.form = NA)
VTLERXSemms <- emmeans(modV80TLERXS1, ~ P, type = "response")
emms_df <- as.data.frame(VTLERXSemms)
cld_dataVTLERXS <- cld(VTLERXSemms, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataVTLERXS)
merged_df <- merge(emms_df, cld_df,by = c("P"))
VTLERXSP<-ggplot(V80TLERXS, aes(x = P, y = exp(predicted), color = Variety)) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7) +
  labs(x = "Environment", y = "Total LER") +
  geom_point(data = emms_df, aes(x = P, y = response, color=Variety), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 2)+
     ggtitle("Year 1 Summer")+
   guides(color = "none")+
  scale_y_continuous(breaks = c(1,1.5, 2,2.5,3,3.5,4), limits = c(.75, 4.16))+
       geom_abline(intercept = 1, slope = 0, color = "red", linetype = "dashed")

#XF
V80TLERXF$predicted <- predict(modV80TLERXF1, newdata = V80TLERXF, re.form = NA)
VTLERXFemms <- emmeans(modV80TLERXF1, ~ P, type = "response")
emms_df <- as.data.frame(VTLERXFemms)
cld_dataVTLERXF <- cld(VTLERXFemms, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataVTLERXF)
merged_df <- merge(emms_df, cld_df,by = c("P"))
VTLERXFP<-ggplot(V80TLERXF, aes(x = P, y = exp(predicted), color = Variety)) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7) +
  labs(x = "Environment", y = "Total LER") +
  geom_point(data = emms_df, aes(x = P, y = response, color=Variety), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 2)+
     ggtitle("Year 1 Fall")+
   guides(color = "none")+
  scale_y_continuous(breaks = c(1,1.5, 2,2.5,3,3.5,4), limits = c(.75, 4.16))+
       geom_abline(intercept = 1, slope = 0, color = "red", linetype = "dashed")

#YS
V80TLERYS$predicted <- predict(modV80TLERYS1, newdata = V80TLERYS, re.form = NA)
VTLERYSemms <- emmeans(modV80TLERYS1, ~ P, type = "response")
emms_df <- as.data.frame(VTLERYSemms)
cld_dataVTLERYS <- cld(VTLERYSemms, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataVTLERYS)
merged_df <- merge(emms_df, cld_df,by = c("P"))
VTLERYSP<-ggplot(V80TLERYS, aes(x = P, y = exp(predicted), color = Variety)) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7) +
  labs(x = "Environment", y = "Total LER") +
  geom_point(data = emms_df, aes(x = P, y = response, color=Variety), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 2)+
     ggtitle("Year 2 Summer")+
   guides(color = "none")+
  scale_y_continuous(breaks = c(1,1.5, 2,2.5,3,3.5,4), limits = c(.75, 4.16))+
       geom_abline(intercept = 1, slope = 0, color = "red", linetype = "dashed")
     
 #YF
V80TLERYF$predicted <- predict(modV80TLERYF1, newdata = V80TLERYF, re.form = NA)
VTLERYFemms <- emmeans(modV80TLERYF1, ~ P, type = "response")
emms_df <- as.data.frame(VTLERYFemms)
cld_dataVTLERYF <- cld(VTLERYFemms, Letters=custom_letters)
cld_df <-as.data.frame(cld_dataVTLERYF)
merged_df <- merge(emms_df, cld_df,by = c("P"))
VTLERYFP<-ggplot(V80TLERYF, aes(x = P, y = exp(predicted), color = Variety)) +
  geom_jitter(width = 0.2, height = 0, size = 3, alpha = 0.7) +
  labs(x = "Environment", y = "Total LER") +
  geom_point(data = emms_df, aes(x = P, y = response, color=Variety), 
             size = 4, shape = 18, color = "black")+ 
  geom_errorbar(data = emms_df, aes(x = P, ymin = lower.CL, ymax = upper.CL), 
                width = 0.2, color = "black", inherit.aes = FALSE) +
  geom_text(data = merged_df, aes(x = P, y = response.x, label = .group), 
            color = "black", vjust = 0, hjust = 2)+
     ggtitle("Year 2 Fall")+
  scale_y_continuous(breaks = c(1,1.5, 2,2.5,3,3.5,4), limits = c(.75, 4.16))+
       geom_abline(intercept = 1, slope = 0, color = "red", linetype = "dashed")
         
VTLERP<-grid.arrange(VTLERXSP,VTLERXFP,VTLERYSP,VTLERYFP, ncol = 2)
ggsave("VTLERP.jpg", plot = VTLERP, width =12, height = 8, dpi = 350)
```


#VTLER combo plots Fall
```{r}
V80TLERXF$Year<-"Year 1 Fall"
V80TLERYF$Year<-"Year 2 Fall"


colorsP<-c("MN"="gold", "NY"="red", "KS"="purple", "WI"="white")

combined_dataVTLERF <- rbind(V80TLERXF,V80TLERYF)

combined_dataVTLERF$Year <- factor(combined_dataVTLERF$Year, levels = desired_orderY4)
combined_dataVTLERF$P <- factor(combined_dataVTLERF$P, levels = desired_order)

max(combined_dataVTLERF$LER)
min(combined_dataVTLERF$LER)
VTLERcomboplotF <- ggplot(combined_dataVTLERF, aes(x = V, y = LER, fill = P)) +
  geom_boxplot(position = position_dodge(width = 0.75)) +
  labs(x = "Variety", y = "TLER") +
  ggtitle("TLER") +
  coord_cartesian(ylim = c(NA, NA)) +
  scale_fill_manual(values = colorsP) +
  facet_wrap(~Year, scales = "free", ncol = 2) +
  ylim(0, 9.6) +
geom_abline(intercept = 1, slope = 0, color = "red", linetype = "dashed")


# Display the combined plot
print(VTLERcomboplotF)

ggsave("VTLERcomboplotF.jpg", plot = VTLERcomboplotF  , width = 8, height = 6, dpi = 300)
```

***

V forage quality stuff 


#V making proportion stuff for total FQ CP and RFV 
```{r}
#NEEDS TO JUST BE INTERCROPPED PLOTS BUT LIKE ALSO NEED TO COMPARE INTERCROP TO MONOCULTURE SOO LIKE .... WUT 

#Dataframes for IWG V80interXS
#Dataframes for ALF Vd80noIXS

#make proportions
V80interXS$propI<-((V80interXS$PlotIWGDryKgHa)/(V80interXS$PlotTotForageKgHa))
V80interXF$propI<-((V80interXF$PlotIWGDryKgHa)/(V80interXF$PlotTotForageKgHa))
V80interYS$propI<-((V80interYS$PlotIWGDryKgHa)/(V80interYS$PlotTotForageKgHa))
V80interYF$propI<-((V80interYF$PlotIWGDryKgHa)/(V80interYF$PlotTotForageKgHa))

Vd80noIXS$propA<-((Vd80noIXS$PlotAlfDryKgHa)/(Vd80noIXS$PlotTotForageKgHa))
Vd80noIXF$propA<-((Vd80noIXF$PlotAlfDryKgHa)/(Vd80noIXF$PlotTotForageKgHa))
Vd80noIYS$propA<-((Vd80noIYS$PlotAlfDryKgHa)/(Vd80noIYS$PlotTotForageKgHa))
Vd80noIYF$propA<-((Vd80noIYF$PlotAlfDryKgHa)/(Vd80noIYF$PlotTotForageKgHa))

#make adjusted CP values 
V80interXS$propCPI<-(V80interXS$IWGCP)*(V80interXS$propI)
V80interXF$propCPI<-(V80interXF$IWGCP)*(V80interXF$propI)
V80interYS$propCPI<-(V80interYS$IWGCP)*(V80interYS$propI)
V80interYF$propCPI<-(V80interYF$IWGCP)*(V80interYF$propI)

Vd80noIXS$propCPA<-(Vd80noIXS$ALFCP)*(Vd80noIXS$propA)
Vd80noIXF$propCPA<-(Vd80noIXF$ALFCP)*(Vd80noIXF$propA)
Vd80noIYS$propCPA<-(Vd80noIYS$ALFCP)*(Vd80noIYS$propA)
Vd80noIYF$propCPA<-(Vd80noIYF$ALFCP)*(Vd80noIYF$propA)

#Somehow make CP totals
  #XS
VXSj<- V80interXS %>%
  select(propCPI, N, P, C, V, Plot, Harvest, YearCode, Rep)
VXSk<- Vd80noIXS %>%
  select(propCPA, N, P, C, V, Plot, Harvest, YearCode, Rep)
VXSf<- merge(VXSj, VXSk, by = c("N", "P", "C","V", "Plot", "Harvest", "YearCode", "Rep"), all = TRUE)
VXSf[is.na(VXSf)] <- 0
VXSf$totCP<-((VXSf$propCPI)+(VXSf$propCPA))
  #XF
VXFj<- V80interXF %>%
  select(propCPI, N, P, C, V, Plot, Harvest, YearCode, Rep)
VXFk<- Vd80noIXF %>%
  select(propCPA, N, P, C, V, Plot, Harvest, YearCode, Rep)
VXFf<- merge(VXFj, VXFk, by = c("N", "P", "C", "V","Plot", "Harvest", "YearCode", "Rep"), all = TRUE)
VXFf[is.na(VXFf)] <- 0
VXFf$totCP<-((VXFf$propCPI)+(VXFf$propCPA))
  #YS
VYSj<- V80interYS %>%
  select(propCPI, N, P, C,V, Plot, Harvest, YearCode, Rep)
VYSk<- Vd80noIYS %>%
  select(propCPA, N, P, C,V, Plot, Harvest, YearCode, Rep)
VYSf<- merge(VYSj, VYSk, by = c("N", "P", "C","V", "Plot", "Harvest", "YearCode", "Rep"), all = TRUE)
VYSf[is.na(VYSf)] <- 0
VYSf$totCP<-((VYSf$propCPI)+(VYSf$propCPA))
  #YF
VYFj<- V80interYF %>%
  select(propCPI, N, P, C,V, Plot, Harvest, YearCode, Rep)
VYFk<- Vd80noIYF %>%
  select(propCPA, N, P, C,V, Plot, Harvest, YearCode, Rep)
VYFf<- merge(VYFj, VYFk, by = c("N", "P", "C","V", "Plot", "Harvest", "YearCode", "Rep"), all = TRUE)
VYFf[is.na(VYFf)] <- 0
VYFf$totCP<-((VYFf$propCPI)+(VYFf$propCPA))

#make adjusted RFV values 
V80interXS$propRFVI<-(V80interXS$IWGRFV)*(V80interXS$propI)
V80interXF$propRFVI<-(V80interXF$IWGRFV)*(V80interXF$propI)
V80interYS$propRFVI<-(V80interYS$IWGRFV)*(V80interYS$propI)
V80interYF$propRFVI<-(V80interYF$IWGRFV)*(V80interYF$propI)

Vd80noIXS$propRFVA<-(Vd80noIXS$ALFRFV)*(Vd80noIXS$propA)
Vd80noIXF$propRFVA<-(Vd80noIXF$ALFRFV)*(Vd80noIXF$propA)
Vd80noIYS$propRFVA<-(Vd80noIYS$ALFRFV)*(Vd80noIYS$propA)
Vd80noIYF$propRFVA<-(Vd80noIYF$ALFRFV)*(Vd80noIYF$propA)

#Somehow make RFV totals
  #XS
VXSm<- V80interXS %>%
  select(propRFVI, N, P, C,V, Plot, Harvest, YearCode, Rep)
VXSn<- Vd80noIXS %>%
  select(propRFVA, N, P, C,V, Plot, Harvest, YearCode, Rep)
VXSo<- merge(VXSm, VXSn, by = c("N", "P", "C", "V", "Plot", "Harvest", "YearCode", "Rep"), all = TRUE)
VXSo[is.na(VXSo)] <- 0
VXSo$totRFV<-((VXSo$propRFVI)+(VXSo$propRFVA))
  #XF
VXFm<- V80interXF %>%
  select(propRFVI, N, P, C,V, Plot, Harvest, YearCode, Rep)
VXFn<- Vd80noIXF %>%
  select(propRFVA, N, P, C,V, Plot, Harvest, YearCode, Rep)
VXFo<- merge(VXFm, VXFn, by = c("N", "P", "C", "V","Plot", "Harvest", "YearCode", "Rep"), all = TRUE)
VXFo[is.na(VXFo)] <- 0
VXFo$totRFV<-((VXFo$propRFVI)+(VXFo$propRFVA))
  #YS
VYSm<- V80interYS %>%
  select(propRFVI, N, P, C,V, Plot, Harvest, YearCode, Rep)
VYSn<- Vd80noIYS %>%
  select(propRFVA, N, P, C,V, Plot, Harvest, YearCode, Rep)
VYSo<- merge(VYSm, VYSn, by = c("N", "P", "C", "V","Plot", "Harvest", "YearCode", "Rep"), all = TRUE)
VYSo[is.na(VYSo)] <- 0
VYSo$totRFV<-((VYSo$propRFVI)+(VYSo$propRFVA))
  #YF
VYFm<- V80interYF %>%
  select(propRFVI, N, P, C,V, Plot, Harvest, YearCode, Rep)
VYFn<- Vd80noIYF %>%
  select(propRFVA, N, P, C,V, Plot, Harvest, YearCode, Rep)
VYFo<- merge(VYFm, VYFn, by = c("N", "P", "C","V", "Plot", "Harvest", "YearCode", "Rep"), all = TRUE)
VYFo[is.na(VYFo)] <- 0
VYFo$totRFV<-((VYFo$propRFVI)+(VYFo$propRFVA))

```

#V IWG CP forage quality year 1 summer 
```{r}
modVICPFQXS<-lmer(IWGCP~V*P + (1|Rep), data=V80interXS)
#check assumptions 
VICPFQXS_resid<-resid(modVICPFQXS)
qqnorm(VICPFQXS_resid)
qqline(VICPFQXS_resid)
plot(modVICPFQXS)
#try log 
modVICPFQXS1<-lmer(log(IWGCP)~V*P + (1|Rep), data=V80interXS)
VICPFQXS_resid1<-resid(modVICPFQXS1)
qqnorm(VICPFQXS_resid1)
qqline(VICPFQXS_resid1)
plot(modVICPFQXS1)
anova(modVICPFQXS1)
#Pairwise P
emmsP <- emmeans(modVICPFQXS1, specs = ~ P, type = "response")
cld_dataVICPFQXS1P <- cld(emmsP, Letters=custom_letters) # Create compact letter display
cld_dataVICPFQXS1P$response <- format(cld_dataVICPFQXS1P$response, digits = 3)
cld_dataVICPFQXS1P<- cld_dataVICPFQXS1P %>%
  select(P, response, .group)
rownames(cld_dataVICPFQXS1P) <- NULL
colnames(cld_dataVICPFQXS1P) <- c("Site", "IWG CP", "Group")
cld_dataVICPFQXS1P  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

```
#V IWG CP forage quality year 1 FALL
```{r}
modVICPFQXF<-lmer(IWGCP~V*P + (1|Rep), data=V80interXF)
#check assumptions 
VICPFQXF_resid<-resid(modVICPFQXF)
qqnorm(VICPFQXF_resid)
qqline(VICPFQXF_resid)
plot(modVICPFQXF)
#try log 
modVICPFQXF1<-lmer(log(IWGCP)~V*P + (1|Rep), data=V80interXF)
VICPFQXF_resid1<-resid(modVICPFQXF1)
qqnorm(VICPFQXF_resid1)
qqline(VICPFQXF_resid1)
plot(modVICPFQXF1)
#Pairwise P
emmsP <- emmeans(modVICPFQXF1, specs = ~ P, type = "response")
cld_dataVICPFQXF1P <- cld(emmsP, Letters=custom_letters) # Create compact letter display
cld_dataVICPFQXF1P$response <- format(cld_dataVICPFQXF1P$response, digits = 4)
cld_dataVICPFQXF1P<- cld_dataVICPFQXF1P %>%
  select(P, response, .group)
rownames(cld_dataVICPFQXF1P) <- NULL
colnames(cld_dataVICPFQXF1P) <- c("Site", "IWG CP", "Group")
cld_dataVICPFQXF1P  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
```
#V IWG CP forage quality year 2 summer
```{r}
modVICPFQYS<-lmer(IWGCP~V*P + (1|Rep), data=V80interYS)
#check assumptions 
VICPFQYS_resid<-resid(modVICPFQYS)
qqnorm(VICPFQYS_resid)
qqline(VICPFQYS_resid)
plot(modVICPFQYS)
#try log 
modVICPFQYS1<-lmer(log(IWGCP)~V*P + (1|Rep), data=V80interYS)
VICPFQYS_resid1<-resid(modVICPFQYS1)
qqnorm(VICPFQYS_resid1)
qqline(VICPFQYS_resid1)
plot(modVICPFQYS1)
#Pairwise P
emmsP <- emmeans(modVICPFQYS1, specs = ~ P, type = "response")
cld_dataVICPFQYS1P <- cld(emmsP, Letters=custom_letters) # Create compact letter display
cld_dataVICPFQYS1P$response <- format(cld_dataVICPFQYS1P$response, digits = 3)
cld_dataVICPFQYS1P<- cld_dataVICPFQYS1P %>%
  select(P, response, .group)
rownames(cld_dataVICPFQYS1P) <- NULL
colnames(cld_dataVICPFQYS1P) <- c("Site", "IWG CP", "Group")
cld_dataVICPFQYS1P  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
```
#V IWG CP forage quality year 2 fall
```{r}
modVICPFQYF<-lmer(IWGCP~V*P + (1|Rep), data=V80interYF)
#check assumptions 
VICPFQYF_resid<-resid(modVICPFQYF)
qqnorm(VICPFQYF_resid)
qqline(VICPFQYF_resid)
plot(modVICPFQYF)
#try log 
modVICPFQYF1<-lmer(log(IWGCP)~V*P + (1|Rep), data=V80interYF)
VICPFQYF_resid1<-resid(modVICPFQYF1)
qqnorm(VICPFQYF_resid1)
qqline(VICPFQYF_resid1)
plot(modVICPFQYF1)
```
#V IWG CP combo plots
```{r}
V80interXS$Year<-"Year 1 Summer"
V80interXF$Year<-"Year 1 Fall"
V80interYS$Year<-"Year 2 Summer"
V80interYF$Year<-"Year 2 Fall"


colorsP<-c("MN"="gold", "NY"="red", "KS"="purple", "WI"="white")

combined_dataVICP <- rbind(V80interXS,V80interXF,V80interYS,V80interYF)


combined_dataVICP$Year <- factor(combined_dataVICP$Year, levels = desired_orderY)
combined_dataVICP$P <- factor(combined_dataVICP$P, levels = desired_order)

max(combined_dataVICP$IWGCP)
min(combined_dataVICP$IWGCP)
VICPcomboplot <- ggplot(combined_dataVICP, aes(x = V, y = IWGCP, fill = P)) +
  geom_boxplot(position = position_dodge(width = 0.75)) +
  labs(x = "Variety", y = "IWG CP") +
  ggtitle("IWG CP") +
  coord_cartesian(ylim = c(NA, NA)) +
  scale_fill_manual(values = colorsP) +
  facet_wrap(~Year, scales = "free", ncol = 2) +
  ylim(0, 25)

# Display the combined plot
print(VICPcomboplot)

ggsave("VICPcomboplot.jpg", plot = VICPcomboplot  , width = 8, height = 6, dpi = 300)
```

#V IWG RFV forage quality year 1 summer
```{r}
modVIRFVFQXS<-lmer(IWGRFV~V*P + (1|Rep), data=V80interXS)
#check assumptions 
VIRFVFQXS_resid<-resid(modVIRFVFQXS)
qqnorm(VIRFVFQXS_resid)
qqline(VIRFVFQXS_resid)
plot(modVIRFVFQXS)
#try log 
modVIRFVFQXS1<-lmer(log(IWGRFV)~V*P + (1|Rep), data=V80interXS)
VIRFVFQXS_resid1<-resid(modVIRFVFQXS1)
qqnorm(VIRFVFQXS_resid1)
qqline(VIRFVFQXS_resid1)
plot(modVIRFVFQXS1)
#Pairwise P
emmsP <- emmeans(modVIRFVFQXS1, specs = ~ P, type = "response")
cld_dataVIRFVFQXS1P <- cld(emmsP, Letters=custom_letters) # Create compact letter display
cld_dataVIRFVFQXS1P$response <- format(cld_dataVIRFVFQXS1P$response, digits = 4)
cld_dataVIRFVFQXS1P<- cld_dataVIRFVFQXS1P %>%
  select(P, response, .group)
rownames(cld_dataVIRFVFQXS1P) <- NULL
colnames(cld_dataVIRFVFQXS1P) <- c("Site", "IWG RFV", "Group")
cld_dataVIRFVFQXS1P  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
```
#V IWG RFV forage quality year 1 fall
```{r}
modVIRFVFQXF<-lmer(IWGRFV~V*P + (1|Rep), data=V80interXF)
#check assumptions 
VIRFVFQXF_resid<-resid(modVIRFVFQXF)
qqnorm(VIRFVFQXF_resid)
qqline(VIRFVFQXF_resid)
plot(modVIRFVFQXF)
#try log 
modVIRFVFQXF1<-lmer(log(IWGRFV)~V*P + (1|Rep), data=V80interXF)
VIRFVFQXF_resid1<-resid(modVIRFVFQXF1)
qqnorm(VIRFVFQXF_resid1)
qqline(VIRFVFQXF_resid1)
plot(modVIRFVFQXF1)
#Pairwise P
emmsP <- emmeans(modVIRFVFQXF1, specs = ~ P, type = "response")
cld_dataVIRFVFQXF1P <- cld(emmsP, Letters=custom_letters) # Create compact letter display
cld_dataVIRFVFQXF1P$response <- format(cld_dataVIRFVFQXF1P$response, digits = 4)
cld_dataVIRFVFQXF1P<- cld_dataVIRFVFQXF1P %>%
  select(P, response, .group)
rownames(cld_dataVIRFVFQXF1P) <- NULL
colnames(cld_dataVIRFVFQXF1P) <- c("Site", "IWG RFV", "Group")
cld_dataVIRFVFQXF1P  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
```
#V IWG RFV forage quality year 2 summer
```{r}
modVIRFVFQYS<-lmer(IWGRFV~V*P + (1|Rep), data=V80interYS)
#check assumptions 
VIRFVFQYS_resid<-resid(modVIRFVFQYS)
qqnorm(VIRFVFQYS_resid)
qqline(VIRFVFQYS_resid)
plot(modVIRFVFQYS)
#try log 
modVIRFVFQYS1<-lmer(log(IWGRFV)~V*P + (1|Rep), data=V80interYS)
VIRFVFQYS_resid1<-resid(modVIRFVFQYS1)
qqnorm(VIRFVFQYS_resid1)
qqline(VIRFVFQYS_resid1)
plot(modVIRFVFQYS1)
#Pairwise P
emmsP <- emmeans(modVIRFVFQYS1, specs = ~ P, type = "response")
cld_dataVIRFVFQYS1P <- cld(emmsP, Letters=custom_letters) # Create compact letter display
cld_dataVIRFVFQYS1P$response <- format(cld_dataVIRFVFQYS1P$response, digits = 4)
cld_dataVIRFVFQYS1P<- cld_dataVIRFVFQYS1P %>%
  select(P, response, .group)
rownames(cld_dataVIRFVFQYS1P) <- NULL
colnames(cld_dataVIRFVFQYS1P) <- c("Site", "IWG RFV", "Group")
cld_dataVIRFVFQYS1P  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
```
#V IWG RFV forage quality year 2 fall
```{r}
modVIRFVFQYF<-lmer(IWGRFV~V*P + (1|Rep), data=V80interYF)
#check assumptions 
VIRFVFQYF_resid<-resid(modVIRFVFQYF)
qqnorm(VIRFVFQYF_resid)
qqline(VIRFVFQYF_resid)
plot(modVIRFVFQYF)
#try log 
modVIRFVFQYF1<-lmer(log(IWGRFV)~V*P + (1|Rep), data=V80interYF)
VIRFVFQYF_resid1<-resid(modVIRFVFQYF1)
qqnorm(VIRFVFQYF_resid1)
qqline(VIRFVFQYF_resid1)
plot(modVIRFVFQYF1)
```
#V IWG RFV combo plots
```{r}
V80interXS$Year<-"Year 1 Summer"
V80interXF$Year<-"Year 1 Fall"
V80interYS$Year<-"Year 2 Summer"
V80interYF$Year<-"Year 2 Fall"


colorsP<-c("MN"="gold", "NY"="red", "KS"="purple", "WI"="white")

combined_dataVIRFV <- rbind(V80interXS,V80interXF,V80interYS,V80interYF)


combined_dataVIRFV$Year <- factor(combined_dataVIRFV$Year, levels = desired_orderY)
combined_dataVIRFV$P <- factor(combined_dataVIRFV$P, levels = desired_order)

max(combined_dataVIRFV$IWGRFV)
min(combined_dataVIRFV$IWGRFV)
VIRFVcomboplot <- ggplot(combined_dataVIRFV, aes(x = V, y = IWGRFV, fill = P)) +
  geom_boxplot(position = position_dodge(width = 0.75)) +
  labs(x = "Variety", y = "IWG RFV") +
  ggtitle("IWG RFV") +
  coord_cartesian(ylim = c(NA, NA)) +
  scale_fill_manual(values = colorsP) +
  facet_wrap(~Year, scales = "free", ncol = 2) +
  ylim(50, 180)

# Display the combined plot
print(VIRFVcomboplot)

ggsave("VIRFVcomboplot.jpg", plot = VIRFVcomboplot  , width = 8, height = 6, dpi = 300)
```

#V Alf CP forage quality year 1 summer
```{r}
modVACPFQXS<-lmer(ALFCP~V*P*C + (1|Rep), data=Vd80noIXS)
#check assumptions
VACPFQXS_resid<-resid(modVACPFQXS)
qqnorm(VACPFQXS_resid)
qqline(VACPFQXS_resid)
plot(modVACPFQXS)
#try log
modVACPFQXS1<-lmer(log(ALFCP)~V*P*C + (1|Rep), data=Vd80noIXS)
VACPFQXS_resid1<-resid(modVACPFQXS1)
qqnorm(VACPFQXS_resid1)
qqline(VACPFQXS_resid1)
plot(modVACPFQXS1)
#Pairwise P:C
emmsPC <- emmeans(modVACPFQXS1, specs = ~ P*C, type = "response")
cld_dataVACPFQXS1PC <- cld(emmsPC, Letters=custom_letters) # Create compact letter display
cld_dataVACPFQXS1PC$response <- format(cld_dataVACPFQXS1PC$response, digits = 4)
cld_dataVACPFQXS1PC<- cld_dataVACPFQXS1PC %>%
  select(P,C, response, .group)
rownames(cld_dataVACPFQXS1PC) <- NULL
colnames(cld_dataVACPFQXS1PC) <- c("Site","Cropping System", "Alfalfa CP", "Group")
cld_dataVACPFQXS1PC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
```
#V Alf CP forage quality year 1 fall
```{r}
modVACPFQXF<-lmer(ALFCP~V*P*C + (1|Rep), data=Vd80noIXF)
#check assumptions
VACPFQXF_resid<-resid(modVACPFQXF)
qqnorm(VACPFQXF_resid)
qqline(VACPFQXF_resid)
plot(modVACPFQXF)
#try log
modVACPFQXF1<-lmer(log(ALFCP)~V*P*C + (1|Rep), data=Vd80noIXF)
VACPFQXF_resid1<-resid(modVACPFQXF1)
qqnorm(VACPFQXF_resid1)
qqline(VACPFQXF_resid1)
plot(modVACPFQXF1)

#Pairwise P:C
emmsPC <- emmeans(modVACPFQXF1, specs = ~ P*C, type = "response")
cld_dataVACPFQXF1PC <- cld(emmsPC, Letters=custom_letters) # Create compact letter display
cld_dataVACPFQXF1PC$response <- format(cld_dataVACPFQXF1PC$response, digits = 4)
cld_dataVACPFQXF1PC<- cld_dataVACPFQXF1PC %>%
  select(P,C, response, .group)
rownames(cld_dataVACPFQXF1PC) <- NULL
colnames(cld_dataVACPFQXF1PC) <- c("Site","Cropping System", "Alfalfa CP", "Group")
cld_dataVACPFQXF1PC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
```
#V Alf CP forage quality year 2 summer
```{r}
modVACPFQYS<-lmer(ALFCP~V*P*C + (1|Rep), data=Vd80noIYS)
#check assumptions
VACPFQYS_resid<-resid(modVACPFQYS)
qqnorm(VACPFQYS_resid)
qqline(VACPFQYS_resid)
plot(modVACPFQYS)
#try log
modVACPFQYS1<-lmer(log(ALFCP)~V*P*C + (1|Rep), data=Vd80noIYS)
VACPFQYS_resid1<-resid(modVACPFQYS1)
qqnorm(VACPFQYS_resid1)
qqline(VACPFQYS_resid1)
plot(modVACPFQYS1)

#Pairwise P:C
emmsPC <- emmeans(modVACPFQYS1, specs = ~ P*C, type = "response")
cld_dataVACPFQYS1PC <- cld(emmsPC, Letters=custom_letters) # Create compact letter display
cld_dataVACPFQYS1PC$response <- format(cld_dataVACPFQYS1PC$response, digits = 4)
cld_dataVACPFQYS1PC<- cld_dataVACPFQYS1PC %>%
  select(P,C, response, .group)
rownames(cld_dataVACPFQYS1PC) <- NULL
colnames(cld_dataVACPFQYS1PC) <- c("Site","Cropping System", "Alfalfa CP", "Group")
cld_dataVACPFQYS1PC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
```
#V Alf CP forage quality year 2 fall
```{r}
modVACPFQYF<-lmer(ALFCP~V*P*C + (1|Rep), data=Vd80noIYF)
#check assumptions
VACPFQYF_resid<-resid(modVACPFQYF)
qqnorm(VACPFQYF_resid)
qqline(VACPFQYF_resid)
plot(modVACPFQYF)
#try log
modVACPFQYF1<-lmer(log(ALFCP)~V*P*C + (1|Rep), data=Vd80noIYF)
VACPFQYF_resid1<-resid(modVACPFQYF1)
qqnorm(VACPFQYF_resid1)
qqline(VACPFQYF_resid1)
plot(modVACPFQYF1)
#Pairwise P
emmsP <- emmeans(modVACPFQYF1, specs = ~ P, type = "response")
cld_dataVACPFQYF1P <- cld(emmsP, Letters=custom_letters) # Create compact letter display
cld_dataVACPFQYF1P$response <- format(cld_dataVACPFQYF1P$response, digits = 4)
cld_dataVACPFQYF1P<- cld_dataVACPFQYF1P %>%
  select(P, response, .group)
rownames(cld_dataVACPFQYF1P) <- NULL
colnames(cld_dataVACPFQYF1P) <- c("Site", "Alfalfa CP", "Group")
cld_dataVACPFQYF1P  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
```
#V Alf CP combo plots
```{r}
Vd80noIXS$Year<-"Year 1 Summer"
Vd80noIXF$Year<-"Year 1 Fall"
Vd80noIYS$Year<-"Year 2 Summer"
Vd80noIYF$Year<-"Year 2 Fall"


colorsP<-c("MN"="gold", "NY"="red", "KS"="purple", "WI"="white")

combined_dataVACP <- rbind(Vd80noIXS,Vd80noIXF,Vd80noIYS,Vd80noIYF)


combined_dataVACP$Year <- factor(combined_dataVACP$Year, levels = desired_orderY)
combined_dataVACP$P <- factor(combined_dataVACP$P, levels = desired_order)

max(combined_dataVACP$ALFCP)
min(combined_dataVACP$ALFCP)
VACPcomboplot <- ggplot(combined_dataVACP, aes(x = V, y = ALFCP, fill = P)) +
  geom_boxplot(position = position_dodge(width = 0.75)) +
  labs(x = "Variety", y = "Alfalfa CP") +
  ggtitle("Alfalfa CP") +
  coord_cartesian(ylim = c(NA, NA)) +
  scale_fill_manual(values = colorsP) +
  facet_wrap(~Year, scales = "free", ncol = 2) +
  ylim(5, 26)

# Display the combined plot
print(VACPcomboplot)

ggsave("VACPcomboplot.jpg", plot = VACPcomboplot  , width = 8, height = 6, dpi = 300)
```

#V Alf RFV forage quality year 1 summer
```{r}
modVARFVFQXS<-lmer(ALFRFV~V*P*C + (1|Rep), data=Vd80noIXS)
#check assumptions
VARFVFQXS_resid<-resid(modVARFVFQXS)
qqnorm(VARFVFQXS_resid)
qqline(VARFVFQXS_resid)
plot(modVARFVFQXS)
#try log
modVARFVFQXS1<-lmer(log(ALFRFV)~V*P*C + (1|Rep), data=Vd80noIXS)
VARFVFQXS_resid1<-resid(modVARFVFQXS1)
qqnorm(VARFVFQXS_resid1)
qqline(VARFVFQXS_resid1)
plot(modVARFVFQXS1)

#Pairwise P:C
emmsPC <- emmeans(modVARFVFQXS1, specs = ~ P*C, type = "response")
cld_dataVARFVFQXS1PC <- cld(emmsPC, Letters=custom_letters) # Create compact letter display
cld_dataVARFVFQXS1PC$response <- format(cld_dataVARFVFQXS1PC$response, digits = 3)
cld_dataVARFVFQXS1PC<- cld_dataVARFVFQXS1PC %>%
  select(P,C, response, .group)
rownames(cld_dataVARFVFQXS1PC) <- NULL
colnames(cld_dataVARFVFQXS1PC) <- c("Site","Cropping System", "Total RFV", "Group")
cld_dataVARFVFQXS1PC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
```
#V Alf RFV forage quality year 1 fall
```{r}
modVARFVFQXF<-lmer(ALFRFV~V*P*C + (1|Rep), data=Vd80noIXF)
#check assumptions
VARFVFQXF_resid<-resid(modVARFVFQXF)
qqnorm(VARFVFQXF_resid)
qqline(VARFVFQXF_resid)
plot(modVARFVFQXF)
#try log
modVARFVFQXF1<-lmer(log(ALFRFV)~V*P*C + (1|Rep), data=Vd80noIXF)
VARFVFQXF_resid1<-resid(modVARFVFQXF1)
qqnorm(VARFVFQXF_resid1)
qqline(VARFVFQXF_resid1)
plot(modVARFVFQXF1)
#Pairwise P:C
emmsPC <- emmeans(modVARFVFQXF1, specs = ~ P*C, type = "response")
cld_dataVARFVFQXF1PC <- cld(emmsPC, Letters=custom_letters) # Create compact letter display
cld_dataVARFVFQXF1PC$response <- format(cld_dataVARFVFQXF1PC$response, digits = 4)
cld_dataVARFVFQXF1PC<- cld_dataVARFVFQXF1PC %>%
  select(P,C, response, .group)
rownames(cld_dataVARFVFQXF1PC) <- NULL
colnames(cld_dataVARFVFQXF1PC) <- c("Site","Cropping System", "Total RFV", "Group")
cld_dataVARFVFQXF1PC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
```
#V Alf RFV forage quality year 2 summer
```{r}
modVARFVFQYS<-lmer(ALFRFV~V*P*C + (1|Rep), data=Vd80noIYS)
#check assumptions
VARFVFQYS_resid<-resid(modVARFVFQYS)
qqnorm(VARFVFQYS_resid)
qqline(VARFVFQYS_resid)
plot(modVARFVFQYS)
#try log
modVARFVFQYS1<-lmer(log(ALFRFV)~V*P*C + (1|Rep), data=Vd80noIYS)
VARFVFQYS_resid1<-resid(modVARFVFQYS1)
qqnorm(VARFVFQYS_resid1)
qqline(VARFVFQYS_resid1)
plot(modVARFVFQYS1)
#Pairwise P:C
emmsPC <- emmeans(modVARFVFQYS1, specs = ~ P*C, type = "response")
cld_dataVARFVFQYS1PC <- cld(emmsPC, Letters=custom_letters) # Create compact letter display
cld_dataVARFVFQYS1PC$response <- format(cld_dataVARFVFQYS1PC$response, digits = 4)
cld_dataVARFVFQYS1PC<- cld_dataVARFVFQYS1PC %>%
  select(P,C, response, .group)
rownames(cld_dataVARFVFQYS1PC) <- NULL
colnames(cld_dataVARFVFQYS1PC) <- c("Site","Cropping System", "Total RFV", "Group")
cld_dataVARFVFQYS1PC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
```
#V Alf RFV forage quality year 2 fall
```{r}
modVARFVFQYF<-lmer(ALFRFV~V*P*C + (1|Rep), data=Vd80noIYF)
#check assumptions
VARFVFQYF_resid<-resid(modVARFVFQYF)
qqnorm(VARFVFQYF_resid)
qqline(VARFVFQYF_resid)
plot(modVARFVFQYF)
#try log
modVARFVFQYF1<-lmer(log(ALFRFV)~V*P*C + (1|Rep), data=Vd80noIYF)
VARFVFQYF_resid1<-resid(modVARFVFQYF1)
qqnorm(VARFVFQYF_resid1)
qqline(VARFVFQYF_resid1)
plot(modVARFVFQYF1)
#Pairwise P
emmsP <- emmeans(modVARFVFQYF1, specs = ~ P, type = "response")
cld_dataVARFVFQYF1P <- cld(emmsP, Letters=custom_letters) # Create compact letter display
cld_dataVARFVFQYF1P$response <- format(cld_dataVARFVFQYF1P$response, digits = 4)
cld_dataVARFVFQYF1P<- cld_dataVARFVFQYF1P %>%
  select(P, response, .group)
rownames(cld_dataVARFVFQYF1P) <- NULL
colnames(cld_dataVARFVFQYF1P) <- c("Site", "Total RFV", "Group")
cld_dataVARFVFQYF1P  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise C
emmsC<- emmeans(modVARFVFQYF1, specs = ~ C, type = "response")
cld_dataVARFVFQYF1C <- cld(emmsC, Letters=custom_letters) # Create compact letter display
cld_dataVARFVFQYF1C$response <- format(cld_dataVARFVFQYF1C$response, digits = 4)
cld_dataVARFVFQYF1C<- cld_dataVARFVFQYF1C %>%
  select(C, response, .group)
rownames(cld_dataVARFVFQYF1C) <- NULL
colnames(cld_dataVARFVFQYF1C) <- c("Cropping System", "Alfalfa RFV", "Group")
cld_dataVARFVFQYF1C  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
```
#V Alf RFV combo plots
```{r}
Vd80noIXS$Year<-"Year 1 Summer"
Vd80noIXF$Year<-"Year 1 Fall"
Vd80noIYS$Year<-"Year 2 Summer"
Vd80noIYF$Year<-"Year 2 Fall"


colorsP<-c("MN"="gold", "NY"="red", "KS"="purple", "WI"="white")

combined_dataVARFV <- rbind(Vd80noIXS,Vd80noIXF,Vd80noIYS,Vd80noIYF)


combined_dataVARFV$Year <- factor(combined_dataVARFV$Year, levels = desired_orderY)
combined_dataVARFV$P <- factor(combined_dataVARFV$P, levels = desired_order)

max(combined_dataVARFV$ALFRFV)
min(combined_dataVARFV$ALFRFV)
VARFVcomboplot <- ggplot(combined_dataVARFV, aes(x = V, y = ALFRFV, fill = P)) +
  geom_boxplot(position = position_dodge(width = 0.75)) +
  labs(x = "Variety", y = "Alfalfa RFV") +
  ggtitle("Alfalfa RFV") +
  coord_cartesian(ylim = c(NA, NA)) +
  scale_fill_manual(values = colorsP) +
  facet_wrap(~Year, scales = "free", ncol = 2) +
  ylim(50, 205)

# Display the combined plot
print(VARFVcomboplot)

ggsave("VARFVcomboplot.jpg", plot = VARFVcomboplot  , width = 8, height = 6, dpi = 300)
```

#V total CP year 1 summer
```{r}
modVTCPXS<-lmer(totCP~V*P*C + (1|Rep), data=VXSf)
#check assumptions 
VTCPXS_resid<-resid(modVTCPXS)
qqnorm(VTCPXS_resid)
qqline(VTCPXS_resid)
plot(modVTCPXS)
#try log 
modVTCPXS1<-lmer(log(totCP)~V*P*C + (1|Rep), data=VXSf)
VTCPXS_resid1<-resid(modVTCPXS1)
qqnorm(VTCPXS_resid1)
qqline(VTCPXS_resid1)
plot(modVTCPXS1)
#Pairwise P:C
emmsPC <- emmeans(modVTCPXS1, specs = ~ P*C, type = "response")
cld_dataVTCPXS1PC <- cld(emmsPC, Letters=custom_letters) # Create compact letter display
cld_dataVTCPXS1PC$response <- format(cld_dataVTCPXS1PC$response, digits = 3)
cld_dataVTCPXS1PC<- cld_dataVTCPXS1PC %>%
  select(P,C, response, .group)
rownames(cld_dataVTCPXS1PC) <- NULL
colnames(cld_dataVTCPXS1PC) <- c("Site","Cropping System", "Total CP", "Group")
cld_dataVTCPXS1PC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
```
#V total CP year 1 Fall
```{r}
modVTCPXF<-lmer(totCP~V*P*C + (1|Rep), data=VXFf)
#check assumptions 
VTCPXF_resid<-resid(modVTCPXF)
qqnorm(VTCPXF_resid)
qqline(VTCPXF_resid)
plot(modVTCPXF)
#try log 
modVTCPXF1<-lmer(log(totCP)~V*P*C + (1|Rep), data=VXFf)
VTCPXF_resid1<-resid(modVTCPXF1)
qqnorm(VTCPXF_resid1)
qqline(VTCPXF_resid1)
plot(modVTCPXF1)
#Pairwise P:C
emmsPC <- emmeans(modVTCPXF1, specs = ~ P*C, type = "response")
cld_dataVTCPXF1PC <- cld(emmsPC, Letters=custom_letters) # Create compact letter display
cld_dataVTCPXF1PC$response <- format(cld_dataVTCPXF1PC$response, digits = 3)
cld_dataVTCPXF1PC<- cld_dataVTCPXF1PC %>%
  select(P,C, response, .group)
rownames(cld_dataVTCPXF1PC) <- NULL
colnames(cld_dataVTCPXF1PC) <- c("Site","Cropping System", "Total CP", "Group")
cld_dataVTCPXF1PC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
```
#V total CP year 2 Summer
```{r}
modVTCPYS<-lmer(totCP~V*P*C + (1|Rep), data=VYSf)
#check assumptions 
VTCPYS_resid<-resid(modVTCPYS)
qqnorm(VTCPYS_resid)
qqline(VTCPYS_resid)
plot(modVTCPYS)
#try log 
modVTCPYS1<-lmer(log(totCP)~V*P*C + (1|Rep), data=VYSf)
VTCPYS_resid1<-resid(modVTCPYS1)
qqnorm(VTCPYS_resid1)
qqline(VTCPYS_resid1)
plot(modVTCPYS1)

#Pairwise P
emmsP <- emmeans(modVTCPYS1, specs = ~ P, type = "response")
cld_dataVTCPYS1P <- cld(emmsP, Letters=custom_letters) # Create compact letter display
cld_dataVTCPYS1P$response <- format(cld_dataVTCPYS1P$response, digits = 5)
cld_dataVTCPYS1P<- cld_dataVTCPYS1P %>%
  select(P, response, .group)
rownames(cld_dataVTCPYS1P) <- NULL
colnames(cld_dataVTCPYS1P) <- c("Site", "Total CP", "Group")
cld_dataVTCPYS1P  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
#Pairwise C
emmsC <- emmeans(modVTCPYS1, specs = ~ C, type = "response")
cld_dataVTCPYS1C <- cld(emmsC, Letters=custom_letters) # Create compact letter display
cld_dataVTCPYS1C$response <- format(cld_dataVTCPYS1C$response, digits = 3)
cld_dataVTCPYS1C<- cld_dataVTCPYS1C %>%
  select(C, response, .group)
rownames(cld_dataVTCPYS1C) <- NULL
colnames(cld_dataVTCPYS1C) <- c("Cropping System", "Total CP", "Group")
cld_dataVTCPYS1C  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
```
#V total CP year 2 fall
```{r}
modVTCPYF<-lmer(totCP~V*P*C + (1|Rep), data=VYFf)
#check assumptions 
VTCPYF_resid<-resid(modVTCPYF)
qqnorm(VTCPYF_resid)
qqline(VTCPYF_resid)
plot(modVTCPYF)
#try log 
modVTCPYF1<-lmer(log(totCP)~V*P*C + (1|Rep), data=VYFf)
VTCPYF_resid1<-resid(modVTCPYF1)
qqnorm(VTCPYF_resid1)
qqline(VTCPYF_resid1)
plot(modVTCPYF1)
#Pairwise P:C
emmsPC <- emmeans(modVTCPYF1, specs = ~ P*C, type = "response")
cld_dataVTCPYF1PC <- cld(emmsPC, Letters=custom_letters) # Create compact letter display
cld_dataVTCPYF1PC$response <- format(cld_dataVTCPYF1PC$response, digits = 3)
cld_dataVTCPYF1PC<- cld_dataVTCPYF1PC %>%
  select(P,C, response, .group)
rownames(cld_dataVTCPYF1PC) <- NULL
colnames(cld_dataVTCPYF1PC) <- c("Site","Cropping System", "Total CP", "Group")
cld_dataVTCPYF1PC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
```

#V total CP combo plots
```{r}
VXSf$Year<-"Year 1 Summer"
VXFf$Year<-"Year 1 Fall"
VYSf$Year<-"Year 2 Summer"
VYFf$Year<-"Year 2 Fall"


colorsP<-c("MN"="gold", "NY"="red", "KS"="purple", "WI"="white")

combined_dataVTCP <- rbind(VXSf,VXFf,VYSf,VYFf)


combined_dataVTCP$Year <- factor(combined_dataVTCP$Year, levels = desired_orderY)
combined_dataVTCP$P <- factor(combined_dataVTCP$P, levels = desired_order)

max(combined_dataVTCP$totCP)
min(combined_dataVTCP$totCP)
VTCPcomboplot <- ggplot(combined_dataVTCP, aes(x = V, y = totCP, fill = P)) +
  geom_boxplot(position = position_dodge(width = 0.75)) +
  labs(x = "Variety", y = "Total CP") +
  ggtitle("Total CP") +
  coord_cartesian(ylim = c(NA, NA)) +
  scale_fill_manual(values = colorsP) +
  facet_wrap(~Year, scales = "free", ncol = 2) +
  ylim(0, 26)

# Display the combined plot
print(VTCPcomboplot)

ggsave("VTCPcomboplot.jpg", plot = VTCPcomboplot  , width = 8, height = 6, dpi = 300)
```

#V total RFV year 1 summer
```{r}
modVTRFVXS<-lmer(totRFV~V*P*C + (1|Rep), data=VXSo)
#check assumptions 
VTRFVXS_resid<-resid(modVTRFVXS)
qqnorm(VTRFVXS_resid)
qqline(VTRFVXS_resid)
plot(modVTRFVXS)
#try log 
modVTRFVXS1<-lmer(log(totRFV)~V*P*C + (1|Rep), data=VXSo)
VTRFVXS_resid1<-resid(modVTRFVXS1)
qqnorm(VTRFVXS_resid1)
qqline(VTRFVXS_resid1)
plot(modVTRFVXS1)
#Pairwise P:C
emmsPC<- emmeans(modVTRFVXS1, specs = ~P*C, type = "response")
cld_dataVTRFVXS1PC <- cld(emmsPC, Letters=custom_letters) # Create compact letter display
cld_dataVTRFVXS1PC$response <- format(cld_dataVTRFVXS1PC$response, digits = 5)
cld_dataVTRFVXS1PC<- cld_dataVTRFVXS1PC %>%
  select(P, C, response, .group)
rownames(cld_dataVTRFVXS1PC) <- NULL
colnames(cld_dataVTRFVXS1PC) <- c("Site", "Cropping System", "Total RFV", "Group")
cld_dataVTRFVXS1PC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
```
#V total RFV year 1 Fall
```{r}
modVTRFVXF<-lmer(totRFV~V*P*C + (1|Rep), data=VXFo)
#check assumptions 
VTRFVXF_resid<-resid(modVTRFVXF)
qqnorm(VTRFVXF_resid)
qqline(VTRFVXF_resid)
plot(modVTRFVXF)
#try log 
modVTRFVXF1<-lmer(log(totRFV)~V*P*C + (1|Rep), data=VXFo)
VTRFVXF_resid1<-resid(modVTRFVXF1)
qqnorm(VTRFVXF_resid1)
qqline(VTRFVXF_resid1)
plot(modVTRFVXF1)

#Pairwise P
emmsP <- emmeans(modVTRFVXF1, specs = ~ P, type = "response")
cld_dataVTRFVXF1P <- cld(emmsP, Letters=custom_letters) # Create compact letter display
cld_dataVTRFVXF1P$response <- format(cld_dataVTRFVXF1P$response, digits = 5)
cld_dataVTRFVXF1P<- cld_dataVTRFVXF1P %>%
  select(P, response, .group)
rownames(cld_dataVTRFVXF1P) <- NULL
colnames(cld_dataVTRFVXF1P) <- c("Site", "Total RFV", "Group")
cld_dataVTRFVXF1P  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)
```
#V total RFV year 2 Summer
```{r}
modVTRFVYS<-lmer(totRFV~V*P*C + (1|Rep), data=VYSo)
#check assumptions 
VTRFVYS_resid<-resid(modVTRFVYS)
qqnorm(VTRFVYS_resid)
qqline(VTRFVYS_resid)
plot(modVTRFVYS)
#try log 
modVTRFVYS1<-lmer(log(totRFV)~V*P*C + (1|Rep), data=VYSo)
VTRFVYS_resid1<-resid(modVTRFVYS1)
qqnorm(VTRFVYS_resid1)
qqline(VTRFVYS_resid1)
plot(modVTRFVYS1)
#Pairwise P:C
emmsPC<- emmeans(modVTRFVYS1, specs = ~P*C, type = "response")
cld_dataVTRFVYS1PC <- cld(emmsPC, Letters= custom_letters ) # Create compact letter display
cld_dataVTRFVYS1PC$response <- format(cld_dataVTRFVYS1PC$response, digits = 5)
cld_dataVTRFVYS1PC<- cld_dataVTRFVYS1PC %>%
  select(P, C, response, .group)
rownames(cld_dataVTRFVYS1PC) <- NULL
colnames(cld_dataVTRFVYS1PC) <- c("Site", "Cropping System", "Total RFV", "Group")
cld_dataVTRFVYS1PC  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

custom_letters <- c("a", "b", "c", "d")  # Customize the letters as needed
#cld_results <- cld(model, Letters = custom_letters)
```

#V total RFV year 2 fall
```{r}
modVTRFVYF<-lmer(totRFV~V*P*C + (1|Rep), data=VYFo)
#check assumptions 
VTRFVYF_resid<-resid(modVTRFVYF)
qqnorm(VTRFVYF_resid)
qqline(VTRFVYF_resid)
plot(modVTRFVYF)
#try log 
modVTRFVYF1<-lmer(log(totRFV)~V*P*C + (1|Rep), data=VYFo)
VTRFVYF_resid1<-resid(modVTRFVYF1)
qqnorm(VTRFVYF_resid1)
qqline(VTRFVYF_resid1)
plot(modVTRFVYF1)

#Pairwise P
emmsP<- emmeans(modVTRFVYF1, specs = ~P, type = "response")
cld_dataVTRFVYF1P <- cld(emmsP, Letters=custom_letters) # Create compact letter display
cld_dataVTRFVYF1P$response <- format(cld_dataVTRFVYF1P$response, digits = 5)
cld_dataVTRFVYF1P<- cld_dataVTRFVYF1P %>%
  select(P, response, .group)
rownames(cld_dataVTRFVYF1P) <- NULL
colnames(cld_dataVTRFVYF1P) <- c("Site", "Total RFV", "Group")
cld_dataVTRFVYF1P  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

#Pairwise C
emmsC<- emmeans(modVTRFVYF1, specs = ~C, type = "response")
cld_dataVTRFVYF1C <- cld(emmsC, Letters=custom_letters) # Create compact letter display
cld_dataVTRFVYF1C$response <- format(cld_dataVTRFVYF1C$response, digits = 5)
cld_dataVTRFVYF1C<- cld_dataVTRFVYF1C %>%
  select(C, response, .group)
rownames(cld_dataVTRFVYF1C) <- NULL
colnames(cld_dataVTRFVYF1C) <- c("Cropping System", "Total RFV", "Group")
cld_dataVTRFVYF1C  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)

```


***

variety mean values and change across years 
#V total RFV combo plots
```{r}
VXSo$Year<-"Year 1 Summer"
VXFo$Year<-"Year 1 Fall"
VYSo$Year<-"Year 2 Summer"
VYFo$Year<-"Year 2 Fall"


colorsP<-c("MN"="gold", "NY"="red", "KS"="purple", "WI"="white")

combined_dataVTRFV <- rbind(VXSo,VXFo,VYSo,VYFo)


combined_dataVTRFV$Year <- factor(combined_dataVTRFV$Year, levels = desired_orderY)
combined_dataVTRFV$P <- factor(combined_dataVTRFV$P, levels = desired_order)

max(combined_dataVTRFV$totRFV)
min(combined_dataVTRFV$totRFV)
VTRFVcomboplot <- ggplot(combined_dataVTRFV, aes(x = V, y = totRFV, fill = P)) +
  geom_boxplot(position = position_dodge(width = 0.75)) +
  labs(x = "Variety", y = "Total RFV") +
  ggtitle("Total RFV") +
  coord_cartesian(ylim = c(NA, NA)) +
  scale_fill_manual(values = colorsP) +
  facet_wrap(~Year, scales = "free", ncol = 2) +
  ylim(25, 205)

# Display the combined plot
print(VTRFVcomboplot)

ggsave("VTRFVcomboplot.jpg", plot = VTRFVcomboplot  , width = 8, height = 6, dpi = 300)
```

#mean values across reps for table
```{r}
#Grain yield 
# Calculate the mean for each treatment excluding NA and 0 values
Vd80IS<-Vd80I[Vd80I$Harvest == 'Summer',]
mean_by_treatmentVG <- Vd80IS %>%
  dplyr::group_by(P, V, YearCode, C) %>%
  dplyr::summarise(MeanGrainYield = mean(G, na.rm = TRUE))
print(mean_by_treatmentVG)

#Grain PLER 
mean_by_treatmentVGPLER <- V80GPLER %>%
  dplyr::group_by(P, Variety, YearCode, Harvest) %>%
  dplyr::summarise(MeanGrainPLER = mean(PartialLERG, na.rm = TRUE))
print(mean_by_treatmentVGPLER)

#Total forage yield
mean_by_treatmentVTF <- Vd80noI %>%
  dplyr::group_by(P, V, YearCode, Harvest, C) %>%
  dplyr::summarise(MeanTotalForage = mean(PlotTotForageKgHa, na.rm = TRUE))
print(mean_by_treatmentVTF)

#IWG biomass yield 
mean_by_treatmentVIB <- Vd80I %>%
  dplyr::group_by(P, V, YearCode, Harvest) %>%
  dplyr::summarise(MeanIWGBiomass = mean(PlotIWGDryKgHa, na.rm = TRUE))
print(mean_by_treatmentVIB)

#IWG PLER 
mean_by_treatmentVIPLER <- V80IPLER %>%
  dplyr::group_by(P, Variety, YearCode, Harvest) %>%
  dplyr::summarise(MeanIWGPLER = mean(PartialLERI, na.rm = TRUE))
print(mean_by_treatmentVIPLER)

#Alf Biomass yield 
mean_by_treatmentVAB <- Vd80noI %>%
  dplyr::group_by(P, V, YearCode, Harvest, C) %>%
  dplyr::summarise(MeanAlfBiomass = mean(PlotAlfDryKgHa, na.rm = TRUE))
print(mean_by_treatmentVAB)

#ALF forage quality CP (currently NA's due to missing year 2 data)
mean_by_treatmentVACP <- Vd80noI %>%
  dplyr::group_by(P, V, YearCode, Harvest, C) %>%
  dplyr::summarise(MeanALFCP= mean(ALFCP, na.rm = TRUE))
print(mean_by_treatmentVACP)

#ALF forage quality RFV 
mean_by_treatmentVARFV <- Vd80noI %>%
  dplyr::group_by(P, V, YearCode, Harvest, C) %>%
  dplyr::summarise(MeanALFRFV= mean(ALFRFV, na.rm = TRUE))
print(mean_by_treatmentVARFV)

#IWG forage quality CP
mean_by_treatmentVICP<- V80inter %>%
  dplyr::group_by(P, V, YearCode, Harvest) %>%
  dplyr::summarise(MeanIWGCP= mean(IWGCP, na.rm = TRUE))
print(mean_by_treatmentVICP)

#IWG forage quality RFV 
mean_by_treatmentVIRFV <- V80inter %>%
  dplyr::group_by(P, V, YearCode, Harvest) %>%
  dplyr::summarise(MeanIWGRFV= mean(IWGRFV, na.rm = TRUE))
print(mean_by_treatmentVIRFV)

```

#V yield changes across years
```{r}
Vd80noInoMN<-Vd80noI[Vd80noI$Location != "MN",]

#Alf Forage Reframe 
VABDeltaP<- Vd80noInoMN %>%
  group_by(Rep, P, Harvest, V, C) %>%
  reframe(DeltaABP = ((PlotAlfDryKgHa[YearCode == 'Y'] - PlotAlfDryKgHa[YearCode == 'X'])/abs(PlotAlfDryKgHa[YearCode =='X']))*100)
print(VABDeltaP)

#Total Forage Reframe 
VTFDeltaP <- Vd80noInoMN %>%
  group_by(Rep, P, Harvest, V, C) %>%
  reframe(DeltaTFP = ((PlotTotForageKgHa[YearCode == 'Y'] - PlotTotForageKgHa[YearCode == 'X'])/abs(PlotTotForageKgHa[YearCode =='X']))*100)
print(VTFDeltaP)


```
#V LER changes across years
```{r}
#IWG PLER Reframe
VIPLERDeltaP <- V80IPLER %>%
  group_by(Rep, P, Harvest, V) %>%
  reframe(DeltaIPLERBP = ((PartialLERI[YearCode == 'Y'] - PartialLERI[YearCode == 'X'])/abs(PartialLERI[YearCode =='X']))*100)
print(VIPLERDeltaP)

#ALF PLER REFRAME
VAPLERDeltaP <- V80APLER %>%
  group_by(Rep, P, Harvest, V) %>%
  reframe(DeltaAPLERBP = ((PartialLERA[YearCode == 'Y'] - PartialLERA[YearCode == 'X'])/abs(PartialLERA[YearCode =='X']))*100)
print(VAPLERDeltaP)

#Total LER reframe 
VTLERDeltaP <- V80TLER %>%
  group_by(Rep, P, Harvest, V) %>%
  reframe(DeltaTLERBP = ((TLER[YearCode == 'Y'] - TLER[YearCode == 'X'])/abs(TLER[YearCode =='X']))*100)
print(VTLERDeltaP)
```
#V IWG FQ changes across years 
```{r}
#IWG CP Reframe 
VICPDeltaP <- V80inter %>%
  group_by(Rep, P, Harvest, V) %>%
  reframe(DeltaICPP = ((IWGCP[YearCode == 'Y'] - IWGCP[YearCode == 'X'])/abs(IWGCP[YearCode =='X']))*100)
print(VICPDeltaP)

#IWG RFV Reframe 
VIRFVDeltaP <- V80inter %>%
  group_by(Rep, P, Harvest, V) %>%
  reframe(DeltaIRFVP = ((IWGRFV[YearCode == 'Y'] - IWGRFV[YearCode == 'X'])/abs(IWGRFV[YearCode =='X']))*100)
print(VIRFVDeltaP)

```
#V Alf FQ changes across years 
```{r}
#Alf CP Reframe 
VACPDeltaP <- Vd80noInoMN %>%
  group_by(Rep, P, Harvest, V, C) %>%
  reframe(DeltaACPP = ((ALFCP[YearCode == 'Y'] - ALFCP[YearCode == 'X'])/abs(ALFCP[YearCode =='X']))*100)
print(VACPDeltaP)

#Alf RFV Reframe 
VARFVDeltaP <- Vd80noInoMN %>%
  group_by(Rep, P, Harvest, V, C) %>%
  reframe(DeltaARFVP = ((ALFRFV[YearCode == 'Y'] - ALFRFV[YearCode == 'X'])/abs(ALFRFV[YearCode =='X']))*100)
print(VARFVDeltaP)
```

#V forage yield delta mean table
```{r}
#Alf 
mean_by_treatmentVABP <-VABDeltaP %>%
  dplyr::group_by(P, Harvest, V) %>%
  dplyr::summarise(MeanABPDeltaPercent = mean(DeltaABP, na.rm = TRUE))
print(mean_by_treatmentVABP)
#total forage 
mean_by_treatmentVTFP <-VTFDeltaP %>%
  dplyr::group_by(P, Harvest, V) %>%
  dplyr::summarise(MeanTFPDeltaPercent = mean(DeltaTFP, na.rm = TRUE))
print(mean_by_treatmentVTFP)
```
#V LER delta means table 
```{r}
#IPLER
mean_by_treatmentVIPLER <-VIPLERDeltaP  %>%
  dplyr::group_by(P, Harvest, V) %>%
  dplyr::summarise(MeanIPLERDeltaPercent = mean(DeltaIPLERBP, na.rm = TRUE))
print(mean_by_treatmentVIPLER)
#APLER
mean_by_treatmentVAPLER <-VAPLERDeltaP  %>%
  dplyr::group_by(P, Harvest, V) %>%
  dplyr::summarise(MeanAPLERDeltaPercent = mean(DeltaAPLERBP, na.rm = TRUE))
print(mean_by_treatmentVAPLER)
#TLER
mean_by_treatmentVTLER <-VTLERDeltaP  %>%
  dplyr::group_by(P, Harvest, V) %>%
  dplyr::summarise(MeanTLERDeltaPercent = mean(DeltaTLERBP, na.rm = TRUE))
print(mean_by_treatmentVTLER)
```
#V IWG FQ delta means table
```{r}
#CP
mean_by_treatmentVICP <-VICPDeltaP  %>%
  dplyr::group_by(P, Harvest, V) %>%
  dplyr::summarise(MeanICPDeltaPercent = mean(DeltaICPP, na.rm = TRUE))
print(mean_by_treatmentVICP)
#RFV
mean_by_treatmentVIRFV <-VIRFVDeltaP  %>%
  dplyr::group_by(P, Harvest, V) %>%
  dplyr::summarise(MeanIRFVDeltaPercent = mean(DeltaIRFVP, na.rm = TRUE))
print(mean_by_treatmentVIRFV)
```
#V Alf FQ delta means table 
```{r}
#CP
mean_by_treatmentVACP <-VACPDeltaP  %>%
  dplyr::group_by(P, Harvest, V) %>%
  dplyr::summarise(MeanACPDeltaPercent = mean(DeltaACPP, na.rm = TRUE))
print(mean_by_treatmentVACP)
#RFV
mean_by_treatmentVARFV <-VARFVDeltaP  %>%
  dplyr::group_by(P, Harvest, V) %>%
  dplyr::summarise(MeanARFVDeltaPercent = mean(DeltaARFVP, na.rm = TRUE))
print(mean_by_treatmentVARFV)
```


****
Variety tables stuff



#V Alf forage yield anovas table 
```{r}
my_modelsVAY <- c(modV80XSA1, modV80XFA1, modV80YSA1, modV80YFA1)
anovasVAY <- purrr::map(my_modelsVAY, ~anova(.))
names(anovasVAY) <- c("Year 1 Summer", "Year 1 Fall", "Year 2 Summer", "Year 2 Fall")

library(dplyr)
library(tidyr)
library(gt)

# Function to format p-values as stars
format_p_value <- function(p_val) {
  stars <- ifelse(p_val < 0.001, "***", ifelse(p_val < 0.01, "**", ifelse(p_val < 0.05, "*", "")))
  return(stars)
}
# Apply the function to your ANOVA results
VAY_stars_tibble <- map(anovasVAY, as_tibble, rownames="term") %>%
  bind_rows(.id = "model") %>%
  mutate(stars = map_chr(`Pr(>F)`, format_p_value))%>%
mutate(term = ifelse(term == "V", "G", term)) %>%
mutate(term = ifelse(term == "P", "E", term)) %>%
mutate(term = ifelse(term == "V:P", "G:E", term))%>%
mutate(term = ifelse(term == "V:C", "G:C", term))%>%
mutate(term = ifelse(term == "P:C", "E:C", term))%>%
mutate(term = ifelse(term == "V:P:C", "G:E:C", term))

# Print the tibble
print(VAY_stars_tibble)

VAY_stars <-VAY_stars_tibble |> 
  select(model, term, stars) |>
  pivot_wider(names_from = term, values_from = stars)

gt_VAY <- gt(VAY_stars)
gt_VAY  |> gtsave("gt_VAY .png", expand = 10)
```

#V Total forage yield anovas table 
```{r}
my_modelsVTF <- c(modV80XSTF1, modV80XFTF1, modV80YSTF1, modV80YFTF1)
anovasVTF <- purrr::map(my_modelsVTF, ~anova(.))
names(anovasVTF) <- c("Year 1 Summer", "Year 1 Fall", "Year 2 Summer", "Year 2 Fall")

library(dplyr)
library(tidyr)
library(gt)

# Function to format p-values as stars
format_p_value <- function(p_val) {
  stars <- ifelse(p_val < 0.001, "***", ifelse(p_val < 0.01, "**", ifelse(p_val < 0.05, "*", "")))
  return(stars)
}

# Apply the function to your ANOVA results
VTF_stars_tibble <- map(anovasVTF, as_tibble, rownames="term") %>%
  bind_rows(.id = "model") %>%
  mutate(stars = map_chr(`Pr(>F)`, format_p_value))%>%
mutate(term = ifelse(term == "V", "G", term)) %>%
mutate(term = ifelse(term == "P", "E", term)) %>%
mutate(term = ifelse(term == "V:P", "G:E", term))%>%
mutate(term = ifelse(term == "V:C", "G:C", term))%>%
mutate(term = ifelse(term == "P:C", "E:C", term))%>%
mutate(term = ifelse(term == "V:P:C", "G:E:C", term))

# Print the tibble
print(VTF_stars_tibble)

VTF_stars <-VTF_stars_tibble |> 
  select(model, term, stars) |>
  pivot_wider(names_from = term, values_from = stars)

gt_VTF <- gt(VTF_stars)
gt_VTF  |> gtsave("gt_VTF .png", expand = 10)
```

#IWG PLER anovas table 
```{r}
my_modelsVIPLER <- c(modV80IPLERXS1, modV80IPLERXF1, modV80IPLERYS1, modV80IPLERYF1)
anovasVIPLER <- purrr::map(my_modelsVIPLER, ~anova(.))
names(anovasVIPLER) <- c("Year 1 Summer", "Year 1 Fall", "Year 2 Summer", "Year 2 Fall")

library(dplyr)
library(tidyr)
library(gt)

# Function to format p-values as stars
format_p_value <- function(p_val) {
  stars <- ifelse(p_val < 0.001, "***", ifelse(p_val < 0.01, "**", ifelse(p_val < 0.05, "*", "")))
  return(stars)
}

# Apply the function to your ANOVA results
VIPLER_stars_tibble <- map(anovasVIPLER, as_tibble, rownames="term") %>%
  bind_rows(.id = "model") %>%
  mutate(stars = map_chr(`Pr(>F)`, format_p_value))%>%
mutate(term = ifelse(term == "V", "G", term)) %>%
mutate(term = ifelse(term == "P", "E", term)) %>%
mutate(term = ifelse(term == "V:P", "G:E", term))

# Print the tibble
print(VIPLER_stars_tibble)

VIPLER_stars <-VIPLER_stars_tibble |> 
  select(model, term, stars) |>
  pivot_wider(names_from = term, values_from = stars)

gt_VIPLER <- gt(VIPLER_stars)
gt_VIPLER  |> gtsave("gt_VIPLER .png", expand = 10)
```

#V ALF PLER anovas table 
```{r}
my_modelsVAPLER <- c(modV80APLERXS1, modV80APLERXF1, modV80APLERYS1, modV80APLERYF1)
anovasVAPLER <- purrr::map(my_modelsVAPLER, ~anova(.))
names(anovasVAPLER) <- c("Year 1 Summer", "Year 1 Fall", "Year 2 Summer", "Year 2 Fall")

library(dplyr)
library(tidyr)
library(gt)

# Function to format p-values as stars
format_p_value <- function(p_val) {
  stars <- ifelse(p_val < 0.001, "***", ifelse(p_val < 0.01, "**", ifelse(p_val < 0.05, "*", "")))
  return(stars)
}

# Apply the function to your ANOVA results
VAPLER_stars_tibble <- map(anovasVAPLER, as_tibble, rownames="term") %>%
  bind_rows(.id = "model") %>%
  mutate(stars = map_chr(`Pr(>F)`, format_p_value))%>%
mutate(term = ifelse(term == "V", "G", term)) %>%
mutate(term = ifelse(term == "P", "E", term)) %>%
mutate(term = ifelse(term == "V:P", "G:E", term))

# Print the tibble
print(VAPLER_stars_tibble)

VAPLER_stars <-VAPLER_stars_tibble |> 
  select(model, term, stars) |>
  pivot_wider(names_from = term, values_from = stars)

gt_VAPLER <- gt(VAPLER_stars)
gt_VAPLER  |> gtsave("gt_VAPLER .png", expand = 10)
```

#V TLER anovas table 
```{r}
my_modelsVTLER <- c(modV80TLERXS1, modV80TLERXF1, modV80TLERYS1, modV80TLERYF1)
anovasVTLER <- purrr::map(my_modelsVTLER, ~anova(.))
names(anovasVTLER) <- c("Year 1 Summer", "Year 1 Fall", "Year 2 Summer", "Year 2 Fall")

library(dplyr)
library(tidyr)
library(gt)

# Function to format p-values as stars
format_p_value <- function(p_val) {
  stars <- ifelse(p_val < 0.001, "***", ifelse(p_val < 0.01, "**", ifelse(p_val < 0.05, "*", "")))
  return(stars)
}

# Apply the function to your ANOVA results
VTLER_stars_tibble <- map(anovasVTLER, as_tibble, rownames="term") %>%
  bind_rows(.id = "model") %>%
  mutate(stars = map_chr(`Pr(>F)`, format_p_value))%>%
mutate(term = ifelse(term == "V", "G", term)) %>%
mutate(term = ifelse(term == "P", "E", term)) %>%
mutate(term = ifelse(term == "V:P", "G:E", term))

# Print the tibble
print(VTLER_stars_tibble)

VTLER_stars <-VTLER_stars_tibble |> 
  select(model, term, stars) |>
  pivot_wider(names_from = term, values_from = stars)

gt_VTLER <- gt(VTLER_stars)
gt_VTLER  |> gtsave("gt_VTLER .png", expand = 10)
```
#V IPrPLER anovas table 
#V APrPLER anovas table 


#IWG CP anovas table 
```{r}
my_modelsVICP <- c(modVICPFQXS1, modVICPFQXF1, modVICPFQYS1, modVICPFQYF1)
anovasVICP <- purrr::map(my_modelsVICP, ~anova(.))
names(anovasVICP) <- c("Year 1 Summer", "Year 1 Fall", "Year 2 Summer", "Year 2 Fall")

library(dplyr)
library(tidyr)
library(gt)

# Function to format p-values as stars
format_p_value <- function(p_val) {
  stars <- ifelse(p_val < 0.001, "***", ifelse(p_val < 0.01, "**", ifelse(p_val < 0.05, "*", "")))
  return(stars)
}

# Apply the function to your ANOVA results
VICP_stars_tibble <- map(anovasVICP, as_tibble, rownames="term") %>%
  bind_rows(.id = "model") %>%
  mutate(stars = map_chr(`Pr(>F)`, format_p_value))%>%
mutate(term = ifelse(term == "V", "G", term)) %>%
mutate(term = ifelse(term == "P", "E", term)) %>%
mutate(term = ifelse(term == "V:P", "G:E", term))

# Print the tibble
print(VICP_stars_tibble)

VICP_stars <-VICP_stars_tibble |> 
  select(model, term, stars) |>
  pivot_wider(names_from = term, values_from = stars)

gt_VICP <- gt(VICP_stars)
gt_VICP  |> gtsave("gt_VICP .png", expand = 10)
```
#IWG RFV anovas table 
```{r}
my_modelsVIRFV <- c(modVIRFVFQXS1, modVIRFVFQXF1, modVIRFVFQYS1, modVIRFVFQYF1)
anovasVIRFV <- purrr::map(my_modelsVIRFV, ~anova(.))
names(anovasVIRFV) <- c("Year 1 Summer", "Year 1 Fall", "Year 2 Summer", "Year 2 Fall")

library(dplyr)
library(tidyr)
library(gt)

# Function to format p-values as stars
format_p_value <- function(p_val) {
  stars <- ifelse(p_val < 0.001, "***", ifelse(p_val < 0.01, "**", ifelse(p_val < 0.05, "*", "")))
  return(stars)
}

# Apply the function to your ANOVA results
VIRFV_stars_tibble <- map(anovasVIRFV, as_tibble, rownames="term") %>%
  bind_rows(.id = "model") %>%
  mutate(stars = map_chr(`Pr(>F)`, format_p_value))%>%
mutate(term = ifelse(term == "V", "G", term)) %>%
mutate(term = ifelse(term == "P", "E", term)) %>%
mutate(term = ifelse(term == "V:P", "G:E", term))

# Print the tibble
print(VIRFV_stars_tibble)

VIRFV_stars <-VIRFV_stars_tibble |> 
  select(model, term, stars) |>
  pivot_wider(names_from = term, values_from = stars)

gt_VIRFV <- gt(VIRFV_stars)
gt_VIRFV  |> gtsave("gt_VIRFV .png", expand = 10)
```
#Alf CP anovas table 
```{r}
my_modelsVACP <- c(modVACPFQXS1, modVACPFQXF1, modVACPFQYS1, modVACPFQYF1)
anovasVACP <- purrr::map(my_modelsVACP, ~anova(.))
names(anovasVACP) <- c("Year 1 Summer", "Year 1 Fall", "Year 2 Summer", "Year 2 Fall")

library(dplyr)
library(tidyr)
library(gt)

# Function to format p-values as stars
format_p_value <- function(p_val) {
  stars <- ifelse(p_val < 0.001, "***", ifelse(p_val < 0.01, "**", ifelse(p_val < 0.05, "*", "")))
  return(stars)
}

# Apply the function to your ANOVA results
VACP_stars_tibble <- map(anovasVACP, as_tibble, rownames="term") %>%
  bind_rows(.id = "model") %>%
  mutate(stars = map_chr(`Pr(>F)`, format_p_value))%>%
mutate(term = ifelse(term == "V", "G", term)) %>%
mutate(term = ifelse(term == "P", "E", term)) %>%
mutate(term = ifelse(term == "V:P", "G:E", term))%>%
mutate(term = ifelse(term == "V:C", "G:C", term))%>%
mutate(term = ifelse(term == "P:C", "E:C", term))%>%
mutate(term = ifelse(term == "V:P:C", "G:E:C", term))

# Print the tibble
print(VACP_stars_tibble)

VACP_stars <-VACP_stars_tibble |> 
  select(model, term, stars) |>
  pivot_wider(names_from = term, values_from = stars)

gt_VACP <- gt(VACP_stars)
gt_VACP  |> gtsave("gt_VACP .png", expand = 10)
```
#Alf RFV anovas table 
```{r}
my_modelsVARFV <- c(modVARFVFQXS1, modVARFVFQXF1, modVARFVFQYS1, modVARFVFQYF1)
anovasVARFV <- purrr::map(my_modelsVARFV, ~anova(.))
names(anovasVARFV) <- c("Year 1 Summer", "Year 1 Fall", "Year 2 Summer", "Year 2 Fall")

library(dplyr)
library(tidyr)
library(gt)

# Function to format p-values as stars
format_p_value <- function(p_val) {
  stars <- ifelse(p_val < 0.001, "***", ifelse(p_val < 0.01, "**", ifelse(p_val < 0.05, "*", "")))
  return(stars)
}

# Apply the function to your ANOVA results
VARFV_stars_tibble <- map(anovasVARFV, as_tibble, rownames="term") %>%
  bind_rows(.id = "model") %>%
  mutate(stars = map_chr(`Pr(>F)`, format_p_value))%>%
mutate(term = ifelse(term == "V", "G", term)) %>%
mutate(term = ifelse(term == "P", "E", term)) %>%
mutate(term = ifelse(term == "V:P", "G:E", term))%>%
mutate(term = ifelse(term == "V:C", "G:C", term))%>%
mutate(term = ifelse(term == "P:C", "E:C", term))%>%
mutate(term = ifelse(term == "V:P:C", "G:E:C", term))

# Print the tibble
print(VARFV_stars_tibble)

VARFV_stars <-VARFV_stars_tibble |> 
  select(model, term, stars) |>
  pivot_wider(names_from = term, values_from = stars)

gt_VARFV <- gt(VARFV_stars)
gt_VARFV  |> gtsave("gt_VARFV.png", expand = 10)
```
#Total CP anovas table 
```{r}
my_modelsVTCP <- c(modVTCPXS1, modVTCPXF1, modVTCPYS1, modVTCPYF1)
anovasVTCP <- purrr::map(my_modelsVTCP, ~anova(.))
names(anovasVTCP) <- c("Year 1 Summer", "Year 1 Fall", "Year 2 Summer", "Year 2 Fall")

# Function to format p-values as stars
format_p_value <- function(p_val) {
  stars <- ifelse(p_val < 0.001, "***", ifelse(p_val < 0.01, "**", ifelse(p_val < 0.05, "*", "")))
  return(stars)
}

# Apply the function to your ANOVA results
VTCP_stars_tibble <- map(anovasVTCP, as_tibble, rownames="term") %>%
  bind_rows(.id = "model") %>%
  mutate(stars = map_chr(`Pr(>F)`, format_p_value))%>%
mutate(term = ifelse(term == "V", "G", term)) %>%
mutate(term = ifelse(term == "P", "E", term)) %>%
mutate(term = ifelse(term == "V:P", "G:E", term))%>%
mutate(term = ifelse(term == "V:C", "G:C", term))%>%
mutate(term = ifelse(term == "P:C", "E:C", term))%>%
mutate(term = ifelse(term == "V:P:C", "G:E:C", term))

# Print the tibble
print(VTCP_stars_tibble)

VTCP_stars <-VTCP_stars_tibble |> 
  select(model, term, stars) |>
  pivot_wider(names_from = term, values_from = stars)

gt_VTCP <- gt(VTCP_stars)
gt_VTCP  |> gtsave("gt_VTCP.png", expand = 10)
```
#Total RFV anovas table 
```{r}
my_modelsVTRFV <- c(modVTRFVXS1, modVTRFVXF1, modVTRFVYS1, modVTRFVYF1)
anovasVTRFV <- purrr::map(my_modelsVTRFV, ~anova(.))
names(anovasVTRFV) <- c("Year 1 Summer", "Year 1 Fall", "Year 2 Summer", "Year 2 Fall")

# Function to format p-values as stars
format_p_value <- function(p_val) {
  stars <- ifelse(p_val < 0.001, "***", ifelse(p_val < 0.01, "**", ifelse(p_val < 0.05, "*", "")))
  return(stars)
}

# Apply the function to your ANOVA results
VTRFV_stars_tibble <- map(anovasVTRFV, as_tibble, rownames="term") %>%
  bind_rows(.id = "model") %>%
  mutate(stars = map_chr(`Pr(>F)`, format_p_value))%>%
mutate(term = ifelse(term == "V", "G", term)) %>%
mutate(term = ifelse(term == "P", "E", term)) %>%
mutate(term = ifelse(term == "V:P", "G:E", term))%>%
mutate(term = ifelse(term == "V:C", "G:C", term))%>%
mutate(term = ifelse(term == "P:C", "E:C", term))%>%
mutate(term = ifelse(term == "V:P:C", "G:E:C", term))

# Print the tibble
print(VTRFV_stars_tibble)

VTRFV_stars <-VTRFV_stars_tibble |> 
  select(model, term, stars) |>
  pivot_wider(names_from = term, values_from = stars)

gt_VTRFV <- gt(VTRFV_stars)
gt_VTRFV |> gtsave("gt_VTRFV.png", expand = 10)
```
#easy print all V FQ tables 
```{r}
gt_VICP
gt_VIRFV
gt_VACP
gt_VARFV
gt_VTCP
gt_VTRFV
```
#Grain anova tables 
```{r}
my_modelsVG <- c(modV80GPLERX1, modV80GPLERY1, modV80GPLERY21)
anovasVG <- purrr::map(my_modelsVG, ~anova(.))
names(anovasVG) <- c("Year 1", "Year 2 (unadjusted)", "Year 2 (adjusted based on year 1 values)")

library(dplyr)
library(tidyr)
library(gt)

# Function to format p-values as stars
format_p_value <- function(p_val) {
  stars <- ifelse(p_val < 0.001, "***", ifelse(p_val < 0.01, "**", ifelse(p_val < 0.05, "*", "")))
  return(stars)
}

# Apply the function to your ANOVA results
VG_stars_tibble <- map(anovasVG, as_tibble, rownames="term") %>%
  bind_rows(.id = "model") %>%
  mutate(stars = map_chr(`Pr(>F)`, format_p_value))%>%
mutate(term = ifelse(term == "V", "G", term)) %>%
mutate(term = ifelse(term == "P", "E", term)) %>%
mutate(term = ifelse(term == "V:P", "G:E", term))

# Print the tibble
print(VG_stars_tibble)

VG_stars <-VG_stars_tibble |> 
  select(model, term, stars) |>
  pivot_wider(names_from = term, values_from = stars)

gt_VG <- gt(VG_stars)
gt_VG  |> gtsave("gt_VG.png", expand = 10)
```



***
Looking for Outliers in important variables 

Nrate Paper 

#Grain (outliers may change after updating to dehulled weight)
```{r}
identify_outliers(NdXSIG[, 155]) #2 outliers.. OK
identify_outliers(DATA31[, 157]) #2 outliers..OK 
```
#Total Forage NO OUTLIERS
```{r}
identify_outliers(NdXS[,41])#0 outliers
identify_outliers(NdXF[,41]) #0 outliers 
identify_outliers(NdYS[,41]) #0 outliers 
identify_outliers(NdYF[,41]) #0 outliers 
```
#IWG forage
```{r}
identify_outliers(NdXSI[, 29]) #0 outliers 
identify_outliers(NdXFI[, 29]) #11 outliers... 2 'extreme'.. ALL 11 IN MONOCULTURE IWG
  plot(NdXFI$N, NdXFI$PlotIWGDryKgHa)
identify_outliers(NdYSI[, 29]) #1 outliers 
 plot(NdYSI$N, NdYSI$PlotIWGDryKgHa)
identify_outliers(NdYFI[, 29]) #2 outliers ... look kinda big on scatterplot but not extreme
 plot(NdYFI$N, NdYFI$PlotIWGDryKgHa)
```
#Alf forage NO OUTLIERS
```{r}
identify_outliers(NdXSA[, 40]) #0 outliers 
identify_outliers(NdXFA[, 40]) #0 outliers 
identify_outliers(NdYSA[, 40]) #0 outliers 
identify_outliers(NdYFA[, 40]) #0 outliers 
```

#IWG forage quality CP and RFV
```{r}
#CP
identify_outliers(NdXSI[, 78]) #0 outliers
identify_outliers(NdXFI[, 78]) #0 outliers 
identify_outliers(NdYSI[, 78]) #4 outliers CHECK ON
plot(NdYSI$IWGCP, NdYSI$N)
identify_outliers(NdYFI[, 78]) #0 outliers 

#RFV
identify_outliers(NdXSI[, 158]) #1 outliers
plot(NdYSI$IWGRFV, NdYSI$N)
identify_outliers(NdXFI[, 158]) #0 outliers 
identify_outliers(NdYSI[, 158]) #0 outliers
identify_outliers(NdYFI[, 158]) #0 outliers 
```

#Alf forage quality 
```{r}
#CP
identify_outliers(NdXSA[, 96]) #6 outliers
identify_outliers(NdXFA[, 96]) #0 outliers 
identify_outliers(NdYSA[, 96]) #3 outliers CHECK ON
plot(NdYSA$ALFCP, NdYSA$N)
identify_outliers(NdYFA[, 96]) #0 outliers 

#RFV
identify_outliers(NdXSA[, 158]) #1 outliers
plot(NdXSA$ALFRFV, NdXSA$N)
identify_outliers(NdXFA[, 158]) #1 outliers 
plot(NdXFA$ALFRFV, NdXFA$N)
identify_outliers(NdYSA[, 158]) #8 outliers
plot(NdYSA$ALFRFV, NdYSA$N)
identify_outliers(NdYFA[, 158]) #4 outliers 
plot(NdYFA$ALFRFV, NdYFA$N)
```
#Weeds? Heights?

Variety Paper 

#Total Forage 
```{r}
identify_outliers(V80XS1[,41])#0 outliers
identify_outliers(V80XF1[,41]) #0 outliers 
identify_outliers(V80YS1[,41]) #0 outliers 
identify_outliers(V80YF1[,41]) #2 outliers 
  plot(V80YF1$V, V80YF1$PlotTotForageKgHa)
```
#Alf forage
```{r}
identify_outliers(V80XSA[, 40]) #3 outliers 
identify_outliers(V80XFA[, 40]) #0 outliers 
identify_outliers(V80YSA[, 40]) #0 outliers 
  plot(VYSA$V, VYSA$PlotAlfDryKgHa)
   plot(VYSA$P, VYSA$PlotAlfDryKgHa)
identify_outliers(V80YFA[, 40]) #1 outliers 
  plot(VYFA$V, VYFA$PlotAlfDryKgHa)
   plot(VYFA$P, VYFA$PlotAlfDryKgHa)
```
#IWG PLER
```{r}
identify_outliers(V80IPLERXS[, 10]) #4 outliers 
identify_outliers(V80IPLERXF[, 10]) #9...5 are extreme...
  plot(V80IPLERXF$V, V80IPLERXF$LER)
identify_outliers(V80IPLERYS[, 10]) #3 outliers 
identify_outliers(V80IPLERYF[, 10]) #1 outliers  
plot(VYFI$P, VYFI$PlotIWGDryKgHa)
   plot(VYFI$V, VYFI$PlotIWGDryKgHa)
```
#Alf PLER #TO DO
```{r}
identify_outliers(V80APLERXS[, 10]) #1...is extreme 
identify_outliers(V80APLERXF[, 10]) #0
identify_outliers(V80APLERYS[, 10]) #1
identify_outliers(V80APLERYF[, 10]) #2
```
#Grain PLER 
```{r}
identify_outliers(V80GPLERX[, 8]) #3 outliers.. 2 are extreme! 
identify_outliers(V80GPLERY[, 8]) #1 outliers 
```
#IWG forage quality 
```{r}
#CP
identify_outliers(V80interXS[, 78]) # outliers
identify_outliers(V80interXF[, 78]) # outliers
identify_outliers(V80interYS[, 78]) #4 outliers
identify_outliers(V80interYF[, 78]) #2 outliers EXTREME

#RFV
identify_outliers(V80interXS[, 157]) #2 outliers
identify_outliers(V80interXF[, 157]) #0 outliers
identify_outliers(V80interYS[, 157]) #0 outliers
identify_outliers(V80interYF[, 157]) #2 outliers EXTREME

```
#Alf forage quality 
```{r}
#CP
identify_outliers(V80interXS[, 96]) #2 outliers
identify_outliers(V80interXF[, 96]) #3 outliers
identify_outliers(V80interYS[, 96]) #2 outliers
identify_outliers(V80interYF[, 96]) #0 outliers

#RFV
identify_outliers(V80interXS[, 157]) #2 outliers
identify_outliers(V80interXF[, 157]) #0 outliers
identify_outliers(V80interYS[, 157]) #0 outliers
identify_outliers(V80interYF[, 157]) #2 outliers EXTREME
```

#Weeds? Heights?

*********
#grateful citation printer! 
```{r}
cite_packages(pkgs = "Session", out.dir = getwd())
```



*******
Things I probably don't need 

#Variety data isolation: for models.. just one Nrate (80N)
```{r, eval= FALSE}
#80 N rate isolation
VE<-Vd[Vd$N == "80",]

#Variety Year isolation
VX<-VE[VE$YearCode == "X",]
VY<-VE[VE$YearCode == "Y",]

#Variety Harvest isolation 
VXS<-VX[VX$Harvest == "Summer",]
VXF<-VX[VX$Harvest == "Fall",]

VYS<-VY[VY$Harvest == "Summer",]
VYF<-VY[VY$Harvest == "Fall",]

#Variety IWG vs ALF isolation 
VXSI<-VXS[VXS$Crop1 != "Shockwave" & VXS$Crop1 != "WL" & VXS$Crop1 != "Higest" ,] 
VXSA<-VXS[VXS$Crop1 != "IWG",]

VXFI<-VXF[VXF$Crop1 != "Shockwave" & VXF$Crop1 != "WL" & VXF$Crop1 != "Higest" ,]
VXFA<-VXF[VXF$Crop1 != "IWG",]

VYSI<-VYS[VYS$Crop1 != "Shockwave" & VYS$Crop1 != "WL" & VYS$Crop1 != "Higest" ,]
VYSA<-VYS[VYS$Crop1 != "IWG",]

VYFI<-VYF[VYF$Crop1 != "Shockwave" & VYF$Crop1 != "WL" & VYF$Crop1 != "Higest" ,]
VYFA<-VYF[VYF$Crop1 != "IWG",]
```

Nrate
#V IWG CP forage quality year 1 summer different dataset
```{r, eval=FALSE}
#view(Vd80justinterXS) and view(V80interXS) are different datasets...
#just keeping this here incase your switching to the V80inter datasets backfires and past you was correct to fo Vd80justinter
Vd80justinterXS<-Vd80noIXS[Vd80noIXS$second_value == "IWG",]
modVICPFQXS<-lmer(IWGCP~V*P + (1|Rep), data=Vd80justinterXS)
#check assumptions 
VICPFQXS_resid<-resid(modVICPFQXS)
qqnorm(VICPFQXS_resid)
qqline(VICPFQXS_resid)
plot(modVICPFQXS)
#try log 
modVICPFQXS1<-lmer(log(IWGCP)~V*P + (1|Rep), data=Vd80justinterXS)
VICPFQXS_resid1<-resid(modVICPFQXS1)
qqnorm(VICPFQXS_resid1)
qqline(VICPFQXS_resid1)
plot(modVICPFQXS1)
anova(modVICPFQXS1)
```
#year 1 summer yields combined anovas table 
```{r, eval= FALSE}
Year1GrainYield<-modNXG1
Year1SummerTotalForageYield<-modNXST1
Year1SummerIWGForageYield<-modNXSI1
Year1SummerAlfForageYield<-modNXSA1
Year1SummerTotalLER<-modTotLERXS1
Year1SummerIWGPartialLER<-modIWGPLERXS1
Year1SummerAlfPartialLER<-modAlfPLERXS1
Year1SummerGrainRelativeYield<-modGRYX1
Year1SummerTotalForageIWGRelativeYield<-modTFIRYXS1
Year1SummerTotalForageAlfRelativeYield<-modTFARYXS1
Year1SummerAlfRelativeYield<-modARYXS1
Year1SummerIWGRelativeYield<-modIRYXS1
Year1GrainPartialLER<-modGPLERX1
Year1SummerIWGPrPLER<-modIPrPLERXS
Year1SummerAlfPrPLER<-modAPrPLERXS


my_modelsXS <- c(Year1GrainYield, Year1SummerTotalForageYield,Year1SummerIWGForageYield, Year1SummerAlfForageYield, Year1GrainPartialLER, Year1SummerTotalLER,Year1SummerIWGPartialLER,Year1SummerAlfPartialLER,  Year1SummerGrainRelativeYield,Year1SummerTotalForageIWGRelativeYield,Year1SummerTotalForageAlfRelativeYield,Year1SummerAlfRelativeYield,Year1SummerIWGRelativeYield, Year1SummerIWGPrPLER, Year1SummerAlfPrPLER)
anovasXS <- purrr::map(my_modelsXS, ~anova(.))
names(anovasXS) <- c("Grain Yield", "Total Forage Yield","IWG Forage Yield", "Alf Forage Yield", "Grain Partial LER", "Total LER","IWG Partial LER", "Alf Partial LER", "Grain Relative Yield","Total Forage IWG Relative Yield","Total Forage Alf Relative Yield","Alf Relative Yield","IWG Relative Yield", "IWG Proportional Partial LER", "Alf Proportional Partial LER")


# Function to format p-values as stars
format_p_value <- function(p_val) {
  stars <- ifelse(p_val < 0.001, "***", ifelse(p_val < 0.01, "**", ifelse(p_val < 0.05, "*", "")))
  return(stars)
}

# Apply the function to your ANOVA results
XS_stars_tibble <- map(anovasXS, as_tibble, rownames="term") %>%
  bind_rows(.id = "model") %>%
  mutate(stars = map_chr(`Pr(>F)`, format_p_value))

# Print the tibble
print(XS_stars_tibble)

XS_stars <- XS_stars_tibble |> 
  select(model, term, stars) |>
  pivot_wider(names_from = term, values_from = stars)

gt_XS <- gt(XS_stars)
gt_XS <- gt_XS |>
  tab_header(
    title = "Year 1 Summer Significance of Variables and Interactions by Model"
  )
print(gt_XS)
library(webshot2)
gtsave(gt_XS,"gttable.docx")
```
#year 2 summer yields combined anovas table  
```{r, eval= FALSE}
Year2GrainYield<-modNYG1
Year2SummerTotalForageYield<-modNYST1
Year2SummerIWGForageYield<-modNYSI1
Year2SummerAlfForageYield<-modNYSA1
Year2SummerTotalLER<-modTotLERYS1
Year2SummerIWGPartialLER<-modIWGPLERYS1
Year2SummerAlfPartialLER<-modAlfPLERYS1
Year2GrainPartialLER<-modGPLERY1
Year2SummerGrainRelativeYield<-modGRYY
Year2SummerTotalForageIWGRelativeYield<-modTFIRYYS1
Year2SummerTotalForageAlfRelativeYield<-modTFARYYS1
Year2SummerAlfRelativeYield<-modARYYS1
Year2SummerIWGRelativeYield<-modIRYYS1
#Year2GrainPartialLER<-modGPLERY
Year2SummerIWGPrPLER<-modIPrPLERYS
Year2SummerAlfPrPLER<-modAPrPLERYS

my_modelsYS <- c(Year2GrainYield, Year2SummerTotalForageYield,Year2SummerIWGForageYield, Year2SummerAlfForageYield,Year2SummerTotalLER,Year2SummerIWGPartialLER,Year2SummerAlfPartialLER, Year2GrainPartialLER, Year2SummerGrainRelativeYield,Year2SummerTotalForageIWGRelativeYield,Year2SummerTotalForageAlfRelativeYield,Year2SummerAlfRelativeYield,Year2SummerIWGRelativeYield, Year2SummerIWGPrPLER, Year2SummerAlfPrPLER)
anovasYS <- purrr::map(my_modelsYS, ~anova(.))
names(anovasYS) <- c("Grain Yield", "Total Forage Yield","IWG Forage Yield", "Alf Forage Yield", "Total LER","IWG Partial LER", "Alf Partial LER", "Year 2 Grain Partial LER", "Grain Relative Yield","Total Forage IWG Relative Yield","Total Forage Alf Relative Yield","Alf Relative Yield","IWG Relative Yield", "IWG Proportional Partial LER", "Alf Proportional Partial LER")

YS_stars_tibble <- map(anovasYS, as_tibble, rownames="term") |> 
  bind_rows(.id = "model") |> 
  mutate(stars = map_chr(`Pr(>F)`, format_p_value))
print(YS_stars_tibble)

YS_stars <- YS_stars_tibble |> 
  select(model, term, stars) |>
  pivot_wider(names_from = term, values_from = stars)

gt_YS <- gt(YS_stars)
gt_YS <- gt_YS |>
  tab_header(
    title = "Year 2 Summer Significance of Variables and Interactions by Model"
  )
print(gt_YS)
library(webshot2)
gtsave(gt_YS,"gttable.docx")

```
#year 1 fall yields combined anovas table  
```{r, eval= FALSE}
Year1FallTotalForageYield<-modNXFT1
Year1FallIWGForageYield<-modNXFI1
Year1FallAlfForageYield<-modNXFA1
Year1FallTotalLER<-modTotLERYF1
Year1FallIWGPartialLER<-modIWGPLERXF1
Year1FallAlfPartialLER<-modAlfPLERXF1
Year1FallTotalForageIWGRelativeYield<-modTFIRYXF1
Year1FallTotalForageAlfRelativeYield<-modTFARYXF1
Year1FallAlfRelativeYield<-modARYXF1
Year1FallIWGRelativeYield<-modIRYXF1
Year1FallIWGPrPLER<-modIPrPLERXF
Year1FallAlfPrPLER<-modAPrPLERXF

my_modelsXF <- c(Year1FallTotalForageYield,Year1FallIWGForageYield, Year1FallAlfForageYield, Year1FallTotalLER,Year1FallIWGPartialLER, Year1FallAlfPartialLER, Year1FallTotalForageIWGRelativeYield,Year1FallTotalForageAlfRelativeYield,Year1FallAlfRelativeYield,Year1FallIWGRelativeYield, Year1FallIWGPrPLER, Year1FallAlfPrPLER)
anovasXF <- purrr::map(my_modelsXF, ~anova(.))
names(anovasXF) <- c("Total Forage Yield","IWG Forage Yield", "Alf Forage Yield", "Total LER","IWG Partial LER", "Alf Partial LER", "Total Forage IWG Relative Yield","Total Forage Alf Relative Yield","Alf Relative Yield","IWG Relative Yield", "IWG Proportional Partial LER", "Alf Proportional Partial LER")

XF_stars_tibble <- map(anovasXF, as_tibble, rownames="term") |> 
  bind_rows(.id = "model") |> 
  mutate(stars = map_chr(`Pr(>F)`, format_p_value))
print(XF_stars_tibble)

XF_stars <- XF_stars_tibble |> 
  select(model, term, stars) |>
  pivot_wider(names_from = term, values_from = stars)

gt_XF <- gt(XF_stars)
gt_XF <- gt_XF |>
  tab_header(
    title = "Year 1 Fall Significance of Variables and Interactions by Model"
  )
print(gt_XF)
library(webshot2)
gtsave(gt_XF,"gttable.docx")

```
#year 2 fall yields combined anovas table 
```{r, eval= FALSE}
Year2FallTotalForageYield<-modNYFT1
Year2FallIWGForageYield<-modNYFI1
Year2FallAlfForageYield<-modNYFA1
Year2FallTotalLER<-modTotLERYF1
Year2FallIWGPartialLER<-modIWGPLERYF1
Year2FallAlfPartialLER<-modAlfPLERYF1
Year2FallTotalForageIWGRelativeYield<-modTFIRYYF1
Year2FallTotalForageAlfRelativeYield<-modTFARYYF1
Year2FallAlfRelativeYield<-modARYYF1
Year2FallIWGRelativeYield<-modIRYYF1
Year2FallIWGPrPLER<-modIPrPLERYF
Year2FallAlfPrPLER<-modAPrPLERYF

my_modelsYF <- c(Year2FallTotalForageYield,Year2FallIWGForageYield, Year2FallAlfForageYield,Year2FallTotalLER,Year2FallIWGPartialLER, Year2FallAlfPartialLER, Year2FallTotalForageIWGRelativeYield,Year2FallTotalForageAlfRelativeYield,Year2FallAlfRelativeYield,Year2FallIWGRelativeYield, Year2FallIWGPrPLER, Year2FallAlfPrPLER)
anovasYF <- purrr::map(my_modelsYF, ~anova(.))
names(anovasYF) <- c("Total Forage Yield","IWG Forage Yield", "Alf Forage Yield", "Total LER","IWG Partial LER", "Alf Partial LER","Total Forage IWG Relative Yield","Total Forage Alf Relative Yield","Alf Relative Yield","IWG Relative Yield", "IWG Proportional Partial LER", "Alf Proportional Partial LER")

YF_stars_tibble <- map(anovasYF, as_tibble, rownames="term") |> 
  bind_rows(.id = "model") |> 
  mutate(stars = map_chr(`Pr(>F)`, format_p_value))
print(YF_stars_tibble)

YF_stars <- YF_stars_tibble |> 
  select(model, term, stars) |>
  pivot_wider(names_from = term, values_from = stars)

gt_YF <- gt(YF_stars)
gt_YF <- gt_YF |>
  tab_header(
    title = "Year 2 Fall Significance of Variables and Interactions by Model"
  )
print(gt_YF)
library(webshot2)
gtsave(gt_YF,"gttable.docx")
```
#change across years Summer combined anovas tables  
```{r, eval= FALSE}
DeltaGrainYield<-modNGDP
DeltaSummerTotalForageYield<-modNTFDPS
DeltaSummerIWGForageYield<-modNIBDPS
DeltaSummerAlfForageYield<-modNABDPS
#DeltaSummerIWGCP<-modNICPDPS
#DeltaSummerIWGRFV<-modNIRFVDPS
#DeltaSummerAlfCP<-modNACPDPS
#DeltaSummerAlfRFV<-modNARFVDPS

DeltaSummerTotalLER<-modNTLERPS
DeltaSummerIWGPLER<-modNIPLERPS
DeltaSummerAlfPLER<-modNAPLERPS
DeltaGrainPLER<-modGPLERDeltaP
DeltaGrainRelativeYield<-modNGRYDP
DeltaSummerTotalForageIWGRelativeYield<-modNTFIRYDPS
DeltaSummerTotalForageAlfRelativeYield<-modNTFARYDPS
DeltaSummerIWGForageRelativeYield<-modNIRYDPS
DeltaSummerAlfForageRelativeYield<-modNARYDPS
DeltaSummerIWGPrPLER<-modNIPrPLERDPS
DeltaSummerAlfPrPLER<-modNAPrPLERDPS

my_modelsDelta <- c(DeltaGrainYield,DeltaSummerTotalForageYield,DeltaSummerIWGForageYield,DeltaSummerAlfForageYield,DeltaSummerTotalLER,DeltaSummerIWGPLER,DeltaSummerAlfPLER,DeltaGrainPLER,DeltaGrainRelativeYield,DeltaSummerTotalForageIWGRelativeYield,DeltaSummerTotalForageAlfRelativeYield,DeltaSummerIWGForageRelativeYield,DeltaSummerAlfForageRelativeYield, DeltaSummerIWGPrPLER, DeltaSummerAlfPrPLER)
anovasDelta <- purrr::map(my_modelsDelta, ~anova(.))
names(anovasDelta) <- c("Grain Yield","Total Forage Yield","IWG Forage Yield","Alf Forage Yield", "Total LER","IWG PLER","Alf PLER", "Grain PLER", "Grain Relative Yield", "Total Forage IWG Relative Yield","Total Forage Alf Relative Yield","IWG Forage Relative Yield","Alf Forage Relative Yield", "IWG Proportional Partial LER", "Alf Proportional Partial LER")

Delta_stars_tibble <- map(anovasDelta, as_tibble, rownames="term") |> 
  bind_rows(.id = "model") |> 
  mutate(stars = map_chr(`Pr(>F)`, format_p_value))
print(Delta_stars_tibble) 

Delta_stars <- Delta_stars_tibble |> 
  select(model, term, stars) |>
  pivot_wider(names_from = term, values_from = stars)

gt_DeltaS <- gt(Delta_stars)
gt_DeltaS <- gt_DeltaS |>
  tab_header(
    title = "Summer Delta Significance of Variables and Interactions by Model"
  )
print(gt_Delta)
library(webshot2)
gtsave(gt_Delta,"gttable.docx")


```
#change across years Fall combined anovas tables 
```{r, eval= FALSE}
DeltaFallTotalForageYield<-modNTFDPF
DeltaFallIWGForageYield<-modNIBDPF
DeltaFallAlfForageYield<-modNABDPF
#DeltaFallIWGCP<-modNICPDPF
#DeltaFallIWGRFV<-modNIRFVDPF
#DeltaFallAlfCP<-modNACPDPF
#DeltaFallAlfRFV<-modNARFVDPF

DeltaFallTotalLER<-modNTLERPF
DeltaFallIWGPLER<-modNIPLERPF
DeltaFallAlfPLER<-modNAPLERPF
DeltaFallTotalForageIWGRelativeYield<-modNTFIRYDPF
DeltaFallTotalForageAlfRelativeYield<-modNTFARYDPF
DeltaFallIWGForageRelativeYield<-modNIRYDPF
DeltaFallAlfForageRelativeYield<-modNARYDPF
DeltaFallIWGPrPLER<-modNIPrPLERDPF
DeltaFallAlfPrPLER<-modNAPrPLERDPF

my_modelsDeltaF <- c(DeltaFallTotalForageYield,DeltaFallIWGForageYield,DeltaFallAlfForageYield,DeltaFallTotalLER,DeltaFallIWGPLER,DeltaFallAlfPLER,DeltaFallTotalForageIWGRelativeYield,DeltaFallTotalForageAlfRelativeYield,DeltaFallIWGForageRelativeYield,DeltaFallAlfForageRelativeYield, DeltaFallIWGPrPLER, DeltaFallAlfPrPLER)
anovasDelta <- purrr::map(my_modelsDeltaF, ~anova(.))
names(anovasDelta) <- c("Total Forage Yield","IWG Forage Yield","Alf Forage Yield", "Total LER","IWG PLER","Alf PLER", "Total Forage IWG Relative Yield", "Total Forage Alf Relative Yield","IWG Forage Relative Yield", "Alf Forage Relative Yield", "IWG Proportional Partial LER", "Alf Proportional Partial LER")

Delta_stars_tibble <- map(anovasDelta, as_tibble, rownames="term") |> 
  bind_rows(.id = "model") |> 
  mutate(stars = map_chr(`Pr(>F)`, format_p_value))
print(Delta_stars_tibble) 

Delta_stars <- Delta_stars_tibble |> 
  select(model, term, stars) |>
  pivot_wider(names_from = term, values_from = stars)

gt_DeltaF <- gt(Delta_stars)
gt_DeltaF <- gt_DeltaF |>
  tab_header(
    title = "Fall Delta Significance of Variables and Interactions by Model"
  )
print(gt_DeltaF)


```


Variety
#ADD intercropped grain yield and intercropped IWG yield (non PLER) to anova tables?
#Variety Year 1 Summer Anova tables
```{r, eval= FALSE}
Year1SummerAlfForageYieldV<-modV80XSA1
Year1SummerTotalForageYieldV<-modV80XSTF1
Year1SummerGrainPLERV<-modV80GPLERX1
Year1SummerIWGPLERV<-modV80IPLERXS1
#Year1SummerAlfCPV<-VXSAmodel_ALFCP
#Year1SummerAlfRFVV<-VXSAmodel_ALFRFV
#Year1SummerIWGCPV<-VXSImodel_IWGCP
#Year1SummerIWGRFVV<-VXSImodel_IWGRFV


my_modelsVXS <- c(Year1SummerAlfForageYieldV,Year1SummerTotalForageYieldV,Year1SummerGrainPLERV,Year1SummerIWGPLERV,Year1SummerAlfCPV,Year1SummerAlfRFVV,Year1SummerIWGCPV,Year1SummerIWGRFVV)
anovasVXS <- purrr::map(my_modelsVXS, ~anova(.))
names(anovasVXS) <- c("Alf Forage Yield","Total Forage Yield","Grain PLER","IWG PLER","Alf CP","Alf RFV","IWG CP","IWG RFV")

library(dplyr)
library(tidyr)
library(gt)

# Function to format p-values as stars
format_p_value <- function(p_val) {
  stars <- ifelse(p_val < 0.001, "***", ifelse(p_val < 0.01, "**", ifelse(p_val < 0.05, "*", "")))
  return(stars)
}

# Extract and format p-values
p_values <- map_dfr(anovasVXS, ~ .x %>%
                      rownames_to_column("term") %>%
                      mutate(stars = map_chr(`Pr(>F)`, format_p_value)) %>%
                      select(term, stars) %>%
                      pivot_wider(names_from = term, values_from = stars),
                    .id = "Model")

# Create a table
gt_tableVXS <- gt(p_values) %>%
  tab_header(
    title = "V Year 1 Summer Significance of Variables and Interactions by Model"
  )

# Print the table
print(gt_tableVXS)
```
#Variety Year 2 Summer Anova tables
```{r, eval= FALSE}
library(purrr)
Year2SummerAlfForageYieldV<-modV80YSA1
Year2SummerTotalForageYieldV<-modV80YSTF1
#Year2SummerGrainPLERV<-modV80GPLERY
Year2SummerIWGPLERV<-modV80IPLERYS1
#Year2SummerAlfCPV<-VYSAmodel_ALFCP
#Year2SummerAlfRFVV<-VYSAmodel_ALFRFV
#Year2SummerIWGCPV<-VYSImodel_IWGCP
#Year2SummerIWGRFVV<-VYSImodel_IWGRFV

my_modelsVYS <- c(Year2SummerAlfForageYieldV,Year2SummerTotalForageYieldV,Year2SummerGrainPLERV,Year2SummerIWGPLERV)
anovasVYS <- purrr::map(my_modelsVYS, ~anova(.))
names(anovasVYS) <- c("Alf Forage Yield","Total Forage Yield","Grain PLER","IWG PLER")

# Function to format p-values as stars
format_p_value <- function(p_val) {
  stars <- ifelse(p_val < 0.001, "***", ifelse(p_val < 0.01, "**", ifelse(p_val < 0.05, "*", "")))
  return(stars)
}

# Extract and format p-values
p_values <- map_dfr(anovasVYS, ~ .x %>%
                      rownames_to_column("term") %>%
                      mutate(stars = map_chr(`Pr(>F)`, format_p_value)) %>%
                      select(term, stars) %>%
                      pivot_wider(names_from = term, values_from = stars),
                    .id = "Model")

# Create a table
gt_tableVYS <- gt(p_values) %>%
  tab_header(
    title = "V Year 2 Summer Significance of Variables and Interactions by Model"
  )

# Print the table
print(gt_tableVYS)
```
#Variety Year 1 Fall Anova tables
```{r, eval= FALSE}
Year1FallAlfForageYieldV<-modV80XFA1
Year1FallTotalForageYieldV<-modV80XFTF1
Year1FallIWGPLERV<-modV80IPLERXF1
Year1FallAlfCPV<-VXSAmodel_ALFCP
Year1FallAlfRFVV<-VXFAmodel_ALFRFV
Year1FallIWGCPV<-VXFImodel_IWGCP
Year1FallIWGRFVV<-VXFImodel_IWGRFV

my_modelsVXF <- c(Year1FallAlfForageYieldV,Year1FallTotalForageYieldV,Year1FallIWGPLERV,Year1FallAlfCPV,Year1FallAlfRFVV,Year1FallIWGCPV,Year1FallIWGRFVV)
anovasVXF <- purrr::map(my_modelsVXF, ~anova(.))
names(anovasVXF) <- c("Alf Forage Yield","Total Forage Yield","IWG PLER","Alf CP","Alf RFV","IWG CP","IWG RFV")

# Function to format p-values as stars
format_p_value <- function(p_val) {
  stars <- ifelse(p_val < 0.001, "***", ifelse(p_val < 0.01, "**", ifelse(p_val < 0.05, "*", "")))
  return(stars)
}

# Extract and format p-values
p_values <- map_dfr(anovasVXF, ~ .x %>%
                      rownames_to_column("term") %>%
                      mutate(stars = map_chr(`Pr(>F)`, format_p_value)) %>%
                      select(term, stars) %>%
                      pivot_wider(names_from = term, values_from = stars),
                    .id = "Model")

# Create a table
gt_tableVXF <- gt(p_values) %>%
  tab_header(
    title = "V Year 1 Fall Significance of Variables and Interactions by Model"
  )

# Print the table
print(gt_tableVXF)
```
#Variety Year 2 Fall Anova tables
```{r, eval= FALSE}
Year2FallAlfForageYieldV<-modV80YFA1
Year2FallTotalForageYieldV<-modV80YFTF1
Year2FallIWGPLERV<-modV80IPLERYF1
#Year2FallAlfCPV<-VYSAmodel_ALFCP
#Year2FallAlfRFVV<-VYFAmodel_ALFRFV
#Year2FallIWGCPV<-VYFImodel_IWGCP
#Year2FallIWGRFVV<-VYFImodel_IWGRFV

my_modelsVYF <- c(Year2FallAlfForageYieldV,Year2FallTotalForageYieldV,Year2FallIWGPLERV)
anovasVYF <- purrr::map(my_modelsVYF, ~anova(.))
names(anovasVYF) <- c("Alf Forage Yield","Total Forage Yield","IWG PLER")

# Function to format p-values as stars
format_p_value <- function(p_val) {
  stars <- ifelse(p_val < 0.001, "***", ifelse(p_val < 0.01, "**", ifelse(p_val < 0.05, "*", "")))
  return(stars)
}

# Extract and format p-values
p_values <- map_dfr(anovasVYF, ~ .x %>%
                      rownames_to_column("term") %>%
                      mutate(stars = map_chr(`Pr(>F)`, format_p_value)) %>%
                      select(term, stars) %>%
                      pivot_wider(names_from = term, values_from = stars),
                    .id = "Model")

# Create a table
gt_tableVYF <- gt(p_values) %>%
  tab_header(
    title = "V Year 2 Fall Significance of Variables and Interactions by Model"
  )

# Print the table
print(gt_tableVYF)
```
#variety Changes across years summer Anova tables 
```{r, eval= FALSE}
VDeltaSummerGrainPLER<-modVGPLERDP
VDeltaSummerTotalForageYield<-modVTFDPS
VDeltaSummerIWGPLER<-modVIBDPS
VDeltaSummerAlfForageYield<-modVABDPS
#VDeltaSummerAlfCP<-modVACPDPS
#VDeltaSummerAlfRFV<-modVARFVDPS
#VDeltaSummerIWGCP<-modVICPDPS
#VDeltaSummerIWGRFV<-modVIRFVDPS

my_modelsVDeltaS <- c(VDeltaSummerGrainPLER,VDeltaSummerTotalForageYield,VDeltaSummerIWGPLER,VDeltaSummerAlfForageYield)
anovasVDeltaS  <- purrr::map(my_modelsVDeltaS , ~anova(.))
names(anovasVDeltaS ) <- c("V Delta Grain PLER","V Delta Total Forage Yield","V Delta IWG PLER","V Delta Alf Forage Yield")

VDeltaS_stars_tibble <- map(anovasVDeltaS, as_tibble, rownames="term") |> 
  bind_rows(.id = "model") |> 
  mutate(stars = map_chr(`Pr(>F)`, format_p_value))
print(VDeltaS_stars_tibble)

VDeltaS_stars <- VDeltaS_stars_tibble |> 
  select(model, term, stars) |>
  pivot_wider(names_from = term, values_from = stars)

gt_VDeltaS  <- gt(VDeltaS_stars)
gt_VDeltaS  <- gt_VDeltaS |>
  tab_header(
    title = "Delta Summer Significance of Variables and Interactions by Model"
  )
print(gt_VDeltaS )
```
#variety Changes across years fall Anova tables 
```{r, eval= FALSE}
VDeltaFallTotalForageYield<-modVTFDPF
VDeltaFallIWGPLER<-modVIBDPF
VDeltaFallAlfForageYield<-modVABDPF
#VDeltaFallAlfCP<-modVACPDPF
#VDeltaFallAlfRFV<-modVARFVDPF
#VDeltaFallIWGCP<-modVICPDPF
#VDeltaFallIWGRFV<-modVIRFVDPF

my_modelsVDeltaF <- c(VDeltaFallTotalForageYield,VDeltaFallIWGPLER,VDeltaFallAlfForageYield)
anovasVDeltaF  <- purrr::map(my_modelsVDeltaF , ~anova(.))
names(anovasVDeltaF ) <- c("V Delta Total Forage Yield","V Detla IWG Forage Yield","V Delta Alf Forage Yield")

VDeltaF_stars_tibble <- map(anovasVDeltaF, as_tibble, rownames="term") |> 
  bind_rows(.id = "model") |> 
  mutate(stars = map_chr(`Pr(>F)`, format_p_value))
print(VDeltaF_stars_tibble)

VDeltaF_stars <- VDeltaF_stars_tibble |> 
  select(model, term, stars) |>
  pivot_wider(names_from = term, values_from = stars)

gt_VDeltaF  <- gt(VDeltaF_stars)
gt_VDeltaF  <- gt_VDeltaF |>
  tab_header(
    title = "Delta Fall Significance of Variables and Interactions by Model"
  )
print(gt_VDeltaF )


```



#N total forage changes across years (with models and plots)
```{r, eval=FALSE}
#Total Forage Delta Reframe 
NdnoMN<-Nd[Nd$P != 'MN',]
NTFDeltaPercent <- NdnoMN %>%
  group_by(Rep, P, Harvest, N, C) %>%
  reframe(DeltaTFP = ((PlotTotForageKgHa[YearCode == 'Y']-PlotTotForageKgHa[YearCode == 'X'])/abs(PlotTotForageKgHa[YearCode == 'X']))*100)
print(NTFDeltaPercent)
#Total Forage Delta model Summer as percent 
NTFDeltaPercentS<-NTFDeltaPercent[NTFDeltaPercent$Harvest == 'Summer',] 
modNTFDPS<-lmer(DeltaTFP~N*P*C + (1|Rep), data= NTFDeltaPercentS)
anova(modNTFDPS)
#check assumptions 
NTFDPS_resid<-resid(modNTFDPS)
qqnorm(NTFDPS_resid)
qqline(NTFDPS_resid)
plot(modNTFDPS)

max(NTFDeltaPercentS$DeltaTFP)
min(NTFDeltaPercentS$DeltaTFP)
#plots
NTFDeltaPercentS$predicted <- predict(modNTFDPS, newdata = NTFDeltaPercentS, re.form = NA)
ggplot(NTFDeltaPercentS, aes(x = N, y = DeltaTFP, color = C, group= C)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Percent Change in Total Forage Yield (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between Percent Change in Total Forage and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(-85, 73) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")+ 
   geom_abline( linetype = "solid", color = "red")

#Total Forage Delta model Fall as percent 
NTFDeltaPercentF<-NTFDeltaPercent[NTFDeltaPercent$Harvest == 'Fall',] 
modNTFDPF<-lmer(DeltaTFP~N*P *C+ (1|Rep), data= NTFDeltaPercentF)
anova(modNTFDPF)
#check assumptions 
NTFDPF_resid<-resid(modNTFDPF)
qqnorm(NTFDPF_resid)
qqline(NTFDPF_resid)
plot(modNTFDPF)

max(NTFDeltaPercentF$DeltaTFP)
min(NTFDeltaPercentF$DeltaTFP)
#plots
NTFDeltaPercentF$predicted <- predict(modNTFDPF, newdata = NTFDeltaPercentF, re.form = NA)
ggplot(NTFDeltaPercentF, aes(x = N, y = DeltaTFP, color = C, group= C)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Percent Change in Total Forage Yield (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between Percent Change in Total Forage Yield and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(-70, 1143) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors

```
#N IWG forage changes across years (with models and plots)
```{r, eval=FALSE}
#IWG Forage Delta Reframe
NdnoMNI<-NdnoMN[NdnoMN$Crop1 != "Shockwave",]
NIBDeltaP <- NdnoMNI %>%
  group_by(Rep, P, Harvest, N, C) %>%
  reframe(DeltaIBP = ((PlotIWGDryKgHa[YearCode == 'Y']-PlotIWGDryKgHa[YearCode == 'X'])/abs(PlotIWGDryKgHa[YearCode == 'X']))*100)
print(NIBDeltaP) 

#IWG Forage Delta model Summer as percent 
NIBDeltaPS<-NIBDeltaP[NIBDeltaP$Harvest == 'Summer',] 
modNIBDPS<-lmer(DeltaIBP~N*P*C + (1|Rep), data= NIBDeltaPS)
anova(modNIBDPS)
#check assumptions 
NIBDPS_resid<-resid(modNIBDPS)
qqnorm(NIBDPS_resid)
qqline(NIBDPS_resid)
plot(modNIBDPS)

max(NIBDeltaPS$DeltaIBP)
min(NIBDeltaPS$DeltaIBP)
#plots
NIBDeltaPS$predicted <- predict(modNIBDPS, newdata = NIBDeltaPS, re.form = NA)
ggplot(NIBDeltaPS, aes(x = N, y = DeltaIBP, color = C, group= C)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Percent Change in IWG Forage Yield (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between Percent Change in IWG Forage and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(-82, 202) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors

#IWG Forage model Fall as percent 
NIBDeltaPF<-NIBDeltaP[NIBDeltaP$Harvest == 'Fall',] 
modNIBDPF<-lmer(DeltaIBP~N*P*C + (1|Rep), data= NIBDeltaPF)
anova(modNIBDPF)
#check assumptions 
NIBDPF_resid<-resid(modNIBDPF)
qqnorm(NIBDPF_resid)
qqline(NIBDPF_resid)
plot(modNIBDPF)

max(NIBDeltaPF$DeltaIBP)
min(NIBDeltaPF$DeltaIBP)
#Plots
NIBDeltaPF$predicted <- predict(modNIBDPF, newdata = NIBDeltaPF, re.form = NA)
ggplot(NIBDeltaPF, aes(x = N, y = DeltaIBP, color = C, group= C)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Percent Change in IWG Forage Yield (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between Percent Change in IWG Forage and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(-56, 748) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors
```
#N ALF forage changes across years (with models and plots)
```{r, eval=FALSE}
#Alf Forage Delta Reframe 
NdnoMNA<-NdnoMN[NdnoMN$Crop1 != "IWG",]
NABDeltaP <- NdnoMNA %>%
  group_by(Rep, P, Harvest, N, C) %>%
  reframe(DeltaABP = ((PlotAlfDryKgHa[YearCode == 'Y']-PlotAlfDryKgHa[YearCode == 'X'])/abs(PlotAlfDryKgHa[YearCode == 'X']))*100)
print(NABDeltaP)
#Alf Forage Delta model Summer
NABDeltaPS<-NABDeltaP[NABDeltaP$Harvest == 'Summer',] 
modNABDPS<-lmer(DeltaABP~N*P*C + (1|Rep), data= NABDeltaPS)
anova(modNABDPS)
#check assumptions 
NABDPS_resid<-resid(modNABDPS)
qqnorm(NABDPS_resid)
qqline(NABDPS_resid)
plot(modNABDPS)

max(NABDeltaPS$DeltaABP)
min(NABDeltaPS$DeltaABP)
#plots
NABDeltaPS$predicted <- predict(modNABDPS, newdata = NABDeltaPS, re.form = NA)
ggplot(NABDeltaPS, aes(x = N, y = DeltaABP, color = C, group= C)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Percent Change in Alf Forage Yield (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between Percent Change in Alf Forage and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(-99, 170) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors

#Alf Forage Delta model Fall
NABDeltaPF<-NABDeltaP[NABDeltaP$Harvest == 'Fall',] 
modNABDPF<-lmer(DeltaABP~N*P*C + (1|Rep), data= NABDeltaPF)
anova(modNABDPF)
#check assumptions 
NABDPF_resid<-resid(modNABDPF)
qqnorm(NABDPF_resid)
qqline(NABDPF_resid)
plot(modNABDPF)

max(NABDeltaPF$DeltaABP)
min(NABDeltaPF$DeltaABP)
#plots
NABDeltaPF$predicted <- predict(modNABDPF, newdata = NABDeltaPF, re.form = NA)
ggplot(NABDeltaPF, aes(x = N, y = DeltaABP, color = C, group= C)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Percent Change in Alf Forage Yield (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between Percent Change in Alf Forage and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(-70, 1382) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors
```
#N LER changes across years (incl. PLER, with models and plots)
```{r, eval=FALSE}
#Total LER reframe
TotalLERresultsnoMN<-TotalLERresults[TotalLERresults$P != "MN",]
TotalLERresultsnoMN$N<-TotalLERresultsnoMN$NRATE
TotalLERresultsnoMN$N<-as.numeric(TotalLERresultsnoMN$N)
NTLERDeltaP <- TotalLERresultsnoMN %>%
  group_by(Rep, P, Harvest, N) %>%
  reframe(DeltaTLER = ((LER[YearCode == 'Y']-LER[YearCode == 'X'])/abs(LER[YearCode == 'X']))*100)
print(NTLERDeltaP)
#Summer Total LER as percent 
NTLERDeltaPS<-NTLERDeltaP[NTLERDeltaP$Harvest == "Summer",]
modNTLERPS<-lmer(DeltaTLER~N*P + (1|Rep), data= NTLERDeltaPS)
anova(modNTLERPS)
#check assumptions 
NTLERPS_resid<-resid(modNTLERPS)
qqnorm(NTLERPS_resid)
qqline(NTLERPS_resid)
plot(modNTLERPS)

max(NTLERDeltaPS$DeltaTLER)
min(NTLERDeltaPS$DeltaTLER)
#plots
NTLERDeltaPS$predicted <- predict(modNTLERPS, newdata = NTLERDeltaPS, re.form = NA)
ggplot(NTLERDeltaPS, aes(x = N, y = DeltaTLER)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Percent Change in Total LER (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between Percent Change in Total LER and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(-48, 143) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors

#Fall Total LER as percent 
NTLERDeltaPF<-NTLERDeltaP[NTLERDeltaP$Harvest == "Fall",]
modNTLERPF<-lmer(DeltaTLER~N*P + (1|Rep), data= NTLERDeltaPF)
anova(modNTLERPF)
#check assumptions 
NTLERPF_resid<-resid(modNTLERPF)
qqnorm(NTLERPF_resid)
qqline(NTLERPF_resid)
plot(modNTLERPF)

max(NTLERDeltaPF$DeltaTLER)
min(NTLERDeltaPF$DeltaTLER)
#plots
NTLERDeltaPF$predicted <- predict(modNTLERPF, newdata = NTLERDeltaPF, re.form = NA)
ggplot(NTLERDeltaPF, aes(x = N, y = DeltaTLER)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Percent Change in Total LER (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between Percent Change in Total LER and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(-66, 308) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors

#IWG PLER reframe 
IWGPartialLERresultsnoMN<-IWGPartialLERresults[IWGPartialLERresults$P !="MN",]
IWGPartialLERresultsnoMN$N<-IWGPartialLERresultsnoMN$NRATE
IWGPartialLERresultsnoMN$N<-as.numeric(IWGPartialLERresultsnoMN$N)
NIPLERDeltaP <- IWGPartialLERresultsnoMN %>%
  group_by(Rep, P, Harvest, N) %>%
  reframe(DeltaIPLER = ((LER[YearCode == 'Y']-LER[YearCode == 'X'])/abs(LER[YearCode == 'X']))*100)
print(NIPLERDeltaP)
#Summer IWG PLER
NIPLERDeltaPS<-NIPLERDeltaP[NIPLERDeltaP$Harvest=="Summer",]
modNIPLERPS<-lmer(DeltaIPLER~N*P + (1|Rep), data= NIPLERDeltaPS)
anova(modNIPLERPS)
#check assumptions 
NIPLERPS_resid<-resid(modNIPLERPS)
qqnorm(NIPLERPS_resid)
qqline(NIPLERPS_resid)
plot(modNIPLERPS)

max(NIPLERDeltaPS$DeltaIPLER)
min(NIPLERDeltaPS$DeltaIPLER)
#plots
NIPLERDeltaPS$predicted <- predict(modNIPLERPS, newdata = NIPLERDeltaPS, re.form = NA)
ggplot(NIPLERDeltaPS, aes(x = N, y = DeltaIPLER)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Percent Change in IWG PLER (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between Percent Change in IWG PLER and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(-31, 319) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors

#Fall IWG PLER
NIPLERDeltaPF<-NIPLERDeltaP[NIPLERDeltaP$Harvest=="Fall",]
modNIPLERPF<-lmer(DeltaIPLER~N*P + (1|Rep), data= NIPLERDeltaPF)
anova(modNIPLERPF)
#check assumptions 
NIPLERPF_resid<-resid(modNIPLERPF)
qqnorm(NIPLERPF_resid)
qqline(NIPLERPF_resid)
plot(modNIPLERPF)

max(NIPLERDeltaPF$DeltaIPLER)
min(NIPLERDeltaPF$DeltaIPLER)
#plots
NIPLERDeltaPF$predicted <- predict(modNIPLERPF, newdata = NIPLERDeltaPF, re.form = NA)
ggplot(NIPLERDeltaPF, aes(x = N, y = DeltaIPLER)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Percent Change in IWG PLER (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between Percent Change in IWG PLER and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(-86, 885) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors

#Alf PLER reframe 
AlfPartialLERresultsnoMN<-AlfPartialLERresults[AlfPartialLERresults$P != "MN",]
AlfPartialLERresultsnoMN$N<-AlfPartialLERresultsnoMN$NRATE
AlfPartialLERresultsnoMN$N<-as.numeric(AlfPartialLERresultsnoMN$N)
NAPLERDeltaP <- AlfPartialLERresultsnoMN %>%
  group_by(Rep, P, Harvest, N) %>%
  reframe(DeltaAPLER = ((LER[YearCode == 'Y']-LER[YearCode == 'X'])/abs(LER[YearCode == 'X']))*100)
print(NAPLERDeltaP)
#Summer Alf PLER
NAPLERDeltaPS<-NAPLERDeltaP[NAPLERDeltaP$Harvest =="Summer",]
modNAPLERPS<-lmer(DeltaAPLER~N*P + (1|Rep), data= NAPLERDeltaPS)
anova(modNAPLERPS)
#check assumptions 
NAPLERPS_resid<-resid(modNAPLERPS)
qqnorm(NAPLERPS_resid)
qqline(NAPLERPS_resid)
plot(modNAPLERPS)

max(NAPLERDeltaPS$DeltaAPLER)
min(NAPLERDeltaPS$DeltaAPLER)
#plots
NAPLERDeltaPS$predicted <- predict(modNAPLERPS, newdata = NAPLERDeltaPS, re.form = NA)
ggplot(NAPLERDeltaPS, aes(x = N, y = DeltaAPLER)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Percent Change in Alf PLER (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between Percent Change in Alf PLER and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(-95, 319) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors

#Fall Alf PLER 
NAPLERDeltaPF<-NAPLERDeltaP[NAPLERDeltaP$Harvest =="Fall",]
modNAPLERPF<-lmer(DeltaAPLER~N*P + (1|Rep), data= NAPLERDeltaPF)
anova(modNAPLERPF)
#check assumptions 
NAPLERPF_resid<-resid(modNAPLERPF)
qqnorm(NAPLERPF_resid)
qqline(NAPLERPF_resid)
plot(modNAPLERPF)

max(NAPLERDeltaPF$DeltaAPLER)
min(NAPLERDeltaPF$DeltaAPLER)
#plots
NAPLERDeltaPF$predicted <- predict(modNAPLERPF, newdata = NAPLERDeltaPF, re.form = NA)
ggplot(NAPLERDeltaPF, aes(x = N, y = DeltaAPLER)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Percent Change in Alf PLER (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between Percent Change in Alf PLER and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(-71, 119) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors

```
#N PrPLER changes across years (with models and plots)
```{r}
#PrPLER reframe
PrPLERnoMN<-PrPLER[PrPLER$P != "MN",]
PrPLERnoMN$N<-PrPLERnoMN$NRATE
PrPLERnoMN$N<-as.numeric(PrPLERnoMN$N)
#IWG PrPLER reframe 
NIPrPLERDeltaP <- PrPLERnoMN %>%
  group_by(Rep, P, Harvest, N) %>%
  reframe(DeltaIPrPLER = ((IPrPLER[YearCode == 'Y']-IPrPLER[YearCode == 'X'])/abs(IPrPLER[YearCode == 'X']))*100)
print(NIPrPLERDeltaP)
#Summer IWG PrPLER as percent 
NIPrPLERDeltaPS<-NIPrPLERDeltaP [NIPrPLERDeltaP $Harvest == "Summer",]
modNIPrPLERDPS<-lmer(DeltaIPrPLER~N*P + (1|Rep), data= NIPrPLERDeltaPS)
anova(modNIPrPLERDPS)
#check assumptions 
NIPrPLERDPS_resid<-resid(modNIPrPLERDPS)
qqnorm(NIPrPLERDPS_resid)
qqline(NIPrPLERDPS_resid)
plot(modNIPrPLERDPS)

#Fall IWG PrPLER as percent 
NIPrPLERDeltaPF<-NIPrPLERDeltaP [NIPrPLERDeltaP $Harvest == "Fall",]
modNIPrPLERDPF<-lmer(DeltaIPrPLER~N*P + (1|Rep), data= NIPrPLERDeltaPF)
anova(modNIPrPLERDPF)
#check assumptions 
NIPrPLERDPF_resid<-resid(modNIPrPLERDPF)
qqnorm(NIPrPLERDPF_resid)
qqline(NIPrPLERDPF_resid)
plot(modNIPrPLERDPF)

#ALF PrPLER reframe 
NAPrPLERDeltaP <- PrPLERnoMN %>%
  group_by(Rep, P, Harvest, N) %>%
  reframe(DeltaAPrPLER = ((APrPLER[YearCode == 'Y']-APrPLER[YearCode == 'X'])/abs(APrPLER[YearCode == 'X']))*100)
print(NAPrPLERDeltaP)
#Summer ALF PrPLER as percent 
NAPrPLERDeltaPS<-NAPrPLERDeltaP [NAPrPLERDeltaP $Harvest == "Summer",]
modNAPrPLERDPS<-lmer(DeltaAPrPLER~N*P + (1|Rep), data= NAPrPLERDeltaPS)
anova(modNAPrPLERDPS)
#check assumptions 
NAPrPLERDPS_resid<-resid(modNAPrPLERDPS)
qqnorm(NAPrPLERDPS_resid)
qqline(NAPrPLERDPS_resid)
plot(modNAPrPLERDPS)

#Fall ALF PrPLER as percent 
NAPrPLERDeltaPF<-NAPrPLERDeltaP [NAPrPLERDeltaP $Harvest == "Fall",]
modNAPrPLERDPF<-lmer(DeltaAPrPLER~N*P + (1|Rep), data= NAPrPLERDeltaPF)
anova(modNAPrPLERDPF)
#check assumptions 
NAPrPLERDPF_resid<-resid(modNAPrPLERDPF)
qqnorm(NAPrPLERDPF_resid)
qqline(NAPrPLERDPF_resid)
plot(modNAPrPLERDPF)


```

#N grain changes across years #cant interpret grain values until you have updated dehulled weights for 2023 (MN taken out because only one year of data thus far)
```{r, eval=FALSE}
#Grain reframe 
NGDelta <- NdSInoMN %>%
  group_by(Rep, P, Harvest, N, C) %>%
  reframe(DeltaG = G[YearCode == 'Y'] - G[YearCode == 'X'])
print(NGDelta)
#Grain model
modNGD<-lmer(DeltaG~N*P*C + (1|Rep), data= NGDelta)
anova(modNGD)
#Grain mean delta across reps (for interpretation)
mean_by_treatmentNGD <- NGDelta %>%
  group_by(P, N, Harvest, C) %>%
  summarise(MeanGrainYieldDelta = mean(DeltaG, na.rm = TRUE))
print(mean_by_treatmentNGD)


#Grain reframe as %
NGDeltaPercent <- NdSInoMN %>%
  group_by(Rep, P, Harvest, N, C) %>%
  reframe(Percent_of_Year_1_yield = ((G[YearCode == 'Y']-G[YearCode == 'X'])/abs(G[YearCode == 'X']))*100)
print(NGDeltaPercent)
#Grain delta as % model
modNGDP<-lmer(Percent_of_Year_1_yield~N*P*C + (1|Rep), data= NGDeltaPercent)
anova(modNGDP)
#check assumptions 
NGDP_resid<-resid(modNGDP)
qqnorm(NGDP_resid)
qqline(NGDP_resid)
plot(modNGDP)

max(NGDeltaPercent$Percent_of_Year_1_yield)
min(NGDeltaPercent$Percent_of_Year_1_yield)
#linear plots
NGDeltaPercent$predicted <- predict(modNGDP, newdata = NGDeltaPercent, re.form = NA)
ggplot(NGDeltaPercent, aes(x = N, y = Percent_of_Year_1_yield, color = C, group= C)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Percent Change in Grain Yield (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between Percent Change in Grain Yield and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(-91, 160) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors


#grain mean % across reps (for interpretation)
mean_by_treatmentNGDPercent <- NGDeltaPercent %>%
  group_by(P, N, Harvest, C) %>%
  summarise(MeanGrainYieldDelta = mean(Percent_of_Year_1_yield, na.rm = TRUE))
print(mean_by_treatmentNGDPercent)
```
#N IWG CP forage quality change across years (with models etc) 
```{r, eval= FALSE}
NdnoMNI$IWGCP<-as.numeric(NdnoMNI$IWGCP)
#IWG CP Delta Reframe 
NICPDeltaP <- NdnoMNI %>%
  group_by(Rep, P, Harvest, N, C) %>%
  reframe(DeltaICPP = ((IWGCP[YearCode == 'Y']-IWGCP[YearCode == 'X'])/abs(IWGCP[YearCode == 'X']))*100)
print(NICPDeltaP)
#IWGCP Delta model Summer
NICPDeltaPS<-NICPDeltaP[NICPDeltaP$Harvest == 'Summer',] 
modNICPDPS<-lmer(DeltaICPP~N*P*C + (1|Rep), data= NICPDeltaPS)
anova(modNICPDPS)
#check assumptions 
NICPDPS_resid<-resid(modNICPDPS)
qqnorm(NICPDPS_resid)
qqline(NICPDPS_resid)
plot(modNICPDPS)

max(NICPDeltaPS$DeltaICPP)
min(NICPDeltaPS$DeltaICPP)
#plots
NICPDeltaPS$predicted <- predict(modNICPDPS, newdata = NICPDeltaPS, re.form = NA)
ggplot(NICPDeltaPS, aes(x = N, y = DeltaICPP, color = C, group= C)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Percent Change in Alf Forage Yield (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between Percent Change in Alf Forage and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(NA, NA) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors

#IWG CP Delta model Fall
NICPDeltaPF<-NICPDeltaP[NICPDeltaP$Harvest == 'Fall',] 
modNICPDPF<-lmer(DeltaICPP~N*P*C + (1|Rep), data= NICPDeltaPF)
anova(modNICPDPF)
#check assumptions 
NICPDPF_resid<-resid(modNICPDPF)
qqnorm(NICPDPF_resid)
qqline(NICPDPF_resid)
plot(modNICPDPF)

max(NICPDeltaPF$DeltaICPP)
min(NICPDeltaPF$DeltaICPP)
#plots
NICPDeltaPF$predicted <- predict(modNICPDPF, newdata = NICPDeltaPF, re.form = NA)
ggplot(NICPDeltaPF, aes(x = N, y = DeltaICPP, color = C, group= C)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Percent Change in IWG CP (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between Percent Change in IWG CP and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(NA, NA) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors
```
#N IWG RFV forage quality change across years (with models etc)
```{r, eval= FALSE}
#IWG RFV Delta Reframe 
NIRFVDeltaP <- NdnoMNI %>%
  group_by(Rep, P, Harvest, N, C) %>%
  reframe(DeltaIRFVP = ((IWGRFV[YearCode == 'Y']-IWGRFV[YearCode == 'X'])/abs(IWGRFV[YearCode == 'X']))*100)
print(NIRFVDeltaP)
#IWGRFV Delta model Summer
NIRFVDeltaPS<-NIRFVDeltaP[NIRFVDeltaP$Harvest == 'Summer',] 
modNIRFVDPS<-lmer(DeltaIRFVP~N*P*C + (1|Rep), data= NIRFVDeltaPS)
anova(modNIRFVDPS)
#check assumptions 
NIRFVDPS_resid<-resid(modNIRFVDPS)
qqnorm(NIRFVDPS_resid)
qqline(NIRFVDPS_resid)
plot(modNIRFVDPS)

max(NIRFVDeltaPS$DeltaIRFVP)
min(NIRFVDeltaPS$DeltaIRFVP)
#plots
NIRFVDeltaPS$predicted <- predict(modNIRFVDPS, newdata = NIRFVDeltaPS, re.form = NA)
ggplot(NIRFVDeltaPS, aes(x = N, y = DeltaIRFVP, color = C, group= C)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Percent Change in Alf Forage Yield (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between Percent Change in Alf Forage and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(NA, NA) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors

#IWG RFV Delta model Fall
NIRFVDeltaPF<-NIRFVDeltaP[NIRFVDeltaP$Harvest == 'Fall',] 
modNIRFVDPF<-lmer(DeltaIRFVP~N*P*C + (1|Rep), data= NIRFVDeltaPF)
anova(modNIRFVDPF)
#check assumptions 
NIRFVDPF_resid<-resid(modNIRFVDPF)
qqnorm(NIRFVDPF_resid)
qqline(NIRFVDPF_resid)
plot(modNIRFVDPF)

max(NIRFVDeltaPF$DeltaIRFVP)
min(NIRFVDeltaPF$DeltaIRFVP)
#plots
NIRFVDeltaPF$predicted <- predict(modNIRFVDPF, newdata = NIRFVDeltaPF, re.form = NA)
ggplot(NIRFVDeltaPF, aes(x = N, y = DeltaIRFVP, color = C, group= C)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Percent Change in IWG RFV (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between Percent Change in IWG RFV and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(NA, NA) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors
```
#N Alf CP forage quality change across years (with models etc)
```{r, eval= FALSE}
NdnoMNI$ALFCP<-as.numeric(NdnoMNI$ALFCP)
#ALF CP Delta Reframe 
NACPDeltaP <- NdnoMNI %>%
  group_by(Rep, P, Harvest, N, C) %>%
  reframe(DeltaACPP = ((ALFCP[YearCode == 'Y']-ALFCP[YearCode == 'X'])/abs(ALFCP[YearCode == 'X']))*100)
print(NACPDeltaP)
#ALFCP Delta model Summer
NACPDeltaPS<-NACPDeltaP[NACPDeltaP$Harvest == 'Summer',] 
modNACPDPS<-lmer(DeltaACPP~N*P*C + (1|Rep), data= NACPDeltaPS)
anova(modNACPDPS)
#check assumptions 
NACPDPS_resid<-resid(modNACPDPS)
qqnorm(NACPDPS_resid)
qqline(NACPDPS_resid)
plot(modNACPDPS)

max(NACPDeltaPS$DeltaACPP)
min(NACPDeltaPS$DeltaACPP)
#plots
NACPDeltaPS$predicted <- predict(modNACPDPS, newdata = NACPDeltaPS, re.form = NA)
ggplot(NACPDeltaPS, aes(x = N, y = DeltaACPP, color = C, group= C)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Percent Change in Alf Forage Yield (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between Percent Change in Alf Forage and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(NA, NA) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors

#ALF CP Delta model Fall
NACPDeltaPF<-NACPDeltaP[NACPDeltaP$Harvest == 'Fall',] 
modNACPDPF<-lmer(DeltaACPP~N*P*C + (1|Rep), data= NACPDeltaPF)
anova(modNACPDPF)
#check assumptions 
NACPDPF_resid<-resid(modNACPDPF)
qqnorm(NACPDPF_resid)
qqline(NACPDPF_resid)
plot(modNACPDPF)

max(NACPDeltaPF$DeltaACPP)
min(NACPDeltaPF$DeltaACPP)
#plots
NACPDeltaPF$predicted <- predict(modNACPDPF, newdata = NACPDeltaPF, re.form = NA)
ggplot(NACPDeltaPF, aes(x = N, y = DeltaACPP, color = C, group= C)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Percent Change in ALF CP (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between Percent Change in ALF CP and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(NA, NA) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors
```
#N Alf RFV forage quality change across years (with models etc)
```{r, eval= FALSE}
NdnoMNI$ALFRFV<-as.numeric(NdnoMNI$ALFRFV)
#ALF RFV Delta Reframe 
NARFVDeltaP <- NdnoMNI %>%
  group_by(Rep, P, Harvest, N, C) %>%
  reframe(DeltaARFVP = ((ALFRFV[YearCode == 'Y']-ALFRFV[YearCode == 'X'])/abs(ALFRFV[YearCode == 'X']))*100)
print(NARFVDeltaP)
#ALFRFV Delta model Summer
NARFVDeltaPS<-NARFVDeltaP[NARFVDeltaP$Harvest == 'Summer',] 
modNARFVDPS<-lmer(DeltaARFVP~N*P*C + (1|Rep), data= NARFVDeltaPS)
anova(modNARFVDPS)
#check assumptions 
NARFVDPS_resid<-resid(modNARFVDPS)
qqnorm(NARFVDPS_resid)
qqline(NARFVDPS_resid)
plot(modNARFVDPS)

max(NARFVDeltaPS$DeltaARFVP)
min(NARFVDeltaPS$DeltaARFVP)
#plots
NARFVDeltaPS$predicted <- predict(modNARFVDPS, newdata = NARFVDeltaPS, re.form = NA)
ggplot(NARFVDeltaPS, aes(x = N, y = DeltaARFVP, color = C, group= C)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Percent Change in Alf Forage Yield (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between Percent Change in Alf Forage and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(NA, NA) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors

#ALF RFV Delta model Fall
NARFVDeltaPF<-NARFVDeltaP[NARFVDeltaP$Harvest == 'Fall',] 
modNARFVDPF<-lmer(DeltaARFVP~N*P*C + (1|Rep), data= NARFVDeltaPF)
anova(modNARFVDPF)
#check assumptions 
NARFVDPF_resid<-resid(modNARFVDPF)
qqnorm(NARFVDPF_resid)
qqline(NARFVDPF_resid)
plot(modNARFVDPF)

max(NARFVDeltaPF$DeltaARFVP)
min(NARFVDeltaPF$DeltaARFVP)
#plots
NARFVDeltaPF$predicted <- predict(modNARFVDPF, newdata = NARFVDeltaPF, re.form = NA)
ggplot(NARFVDeltaPF, aes(x = N, y = DeltaARFVP, color = C, group= C)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Percent Change in ALF RFV (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between Percent Change in ALF RFV and N-rate") +  # Add a title
scale_x_continuous(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  ylim(NA, NA) +
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors
```
#N Grain RY change across years (with models etc)
```{r, eval=FALSE}
NGRY_longS<-NGRY_long[NGRY_long$Harvest == "Summer",]
#Grain RY Delta Reframe 
NGRYDeltaP <- NGRY_longS %>%
  group_by(Rep, P, Harvest, N) %>%
  reframe(DeltaGRY = ((GRelativeYield[YearCode == 'Y']-GRelativeYield[YearCode == 'X'])/abs(GRelativeYield[YearCode == 'X']))*100)
print(NGRYDeltaP)
#Grain RY Delta model
modNGRYDP<-lmer(DeltaGRY ~N*P + (1|Rep), data= NGRYDeltaP)
anova(modNGRYDP)
#check assumptions 
NGRYDP_resid<-resid(modNGRYDP)
qqnorm(NGRYDP_resid)
qqline(NGRYDP_resid)
plot(modNGRYDP)

max(NGRYDeltaP$DeltaGRY)
min(NGRYDeltaP$DeltaGRY)
#Plots
NGRYDeltaP$predicted <- predict(modNGRYDP, newdata = NGRYDeltaP, re.form = NA)
ggplot(NGRYDeltaP, aes(x = N, y = DeltaGRY)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Percent Change in Grain Relative Yield (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between Percent Change in Grain Relative Yield and N-rate") +  # Add a title
scale_x_discrete(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors
```
#N Total forage compared to IWG RY change across years (S and F)(with models etc)
```{r, eval=FALSE}
#TF IWG RY Summer Delta Reframe 
NTFIRYDeltaP <- NTFIRY_long %>%
  group_by(Rep, P, Harvest, N) %>%
  reframe(DeltaTFIRY = ((TFIRelativeYield[YearCode == 'Y']-TFIRelativeYield[YearCode == 'X'])/abs(TFIRelativeYield[YearCode == 'X']))*100)
print(NTFIRYDeltaP)
#TF IWG RY SummerDelta model
NTFIRYDeltaPS<-NTFIRYDeltaP[NTFIRYDeltaP$Harvest == "Summer",]
modNTFIRYDPS<-lmer(DeltaTFIRY ~N*P + (1|Rep), data= NTFIRYDeltaPS)
anova(modNTFIRYDPS)
#check assumptions 
NTFIRYDPS_resid<-resid(modNTFIRYDPS)
qqnorm(NTFIRYDPS_resid)
qqline(NTFIRYDPS_resid)
plot(modNTFIRYDPS)

max(NTFIRYDeltaPS$DeltaTFIRY)
min(NTFIRYDeltaPS$DeltaTFIRY)
#linear plots
NTFIRYDeltaPS$predicted <- predict(modNTFIRYDPS, newdata = NTFIRYDeltaPS, re.form = NA)
ggplot(NTFIRYDeltaPS, aes(x = N, y = DeltaTFIRY)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Percent Change in Summer Total Forage (IWG) Relative Yield (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between Percent Change in Summer Total Forage (IWG) Relative Yield and N-rate") +  # Add a title
scale_x_discrete(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors

#TF IWG RY Fall Delta model
NTFIRYDeltaPF<-NTFIRYDeltaP[NTFIRYDeltaP$Harvest == "Fall",]
modNTFIRYDPF<-lmer(DeltaTFIRY ~N*P + (1|Rep), data= NTFIRYDeltaPF)
anova(modNTFIRYDPF)
#check assumptions 
NTFIRYDPF_resid<-resid(modNTFIRYDPF)
qqnorm(NTFIRYDPF_resid)
qqline(NTFIRYDPF_resid)
plot(modNTFIRYDPF)

max(NTFIRYDeltaPF$DeltaTFIRY)
min(NTFIRYDeltaPF$DeltaTFIRY)
#linear plots
NTFIRYDeltaPF$predicted <- predict(modNTFIRYDPF, newdata = NTFIRYDeltaPF, re.form = NA)
ggplot(NTFIRYDeltaPF, aes(x = N, y = DeltaTFIRY)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Percent Change in Fall Total Forage (IWG) Relative Yield (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between Percent Change in Fall Total Forage (IWG) Relative Yield and N-rate") +  # Add a title
scale_x_discrete(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors
```
#N Total forage compared to Alf RY change across years (S and F)(with models etc)
```{r, eval=FALSE}
#TF Alf RY Summer Delta Reframe 
NTFARYDeltaP <- NTFARY_long %>%
  group_by(Rep, P, Harvest, N) %>%
  reframe(DeltaTFARY = ((TFARelativeYield[YearCode == 'Y']-TFARelativeYield[YearCode == 'X'])/abs(TFARelativeYield[YearCode == 'X']))*100)
print(NTFARYDeltaP)
#TF Alf RY SummerDelta model
NTFARYDeltaPS<-NTFARYDeltaP[NTFARYDeltaP$Harvest == "Summer",]
modNTFARYDPS<-lmer(DeltaTFARY ~N*P + (1|Rep), data= NTFARYDeltaPS)
anova(modNTFARYDPS)
#check assumptions 
NTFARYDPS_resid<-resid(modNTFARYDPS)
qqnorm(NTFARYDPS_resid)
qqline(NTFARYDPS_resid)
plot(modNTFARYDPS)

max(NTFARYDeltaPS$DeltaTFARY)
min(NTFARYDeltaPS$DeltaTFARY)
#linear plots
NTFARYDeltaPS$predicted <- predict(modNTFARYDPS, newdata = NTFARYDeltaPS, re.form = NA)
ggplot(NTFARYDeltaPS, aes(x = N, y = DeltaTFARY)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Percent Change in Summer Total Forage (Alf) Relative Yield (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between Percent Change in Summer Total Forage (Alf) Relative Yield and N-rate") +  # Add a title
scale_x_discrete(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors

#TF Alf RY Fall Delta model
NTFARYDeltaPF<-NTFARYDeltaP[NTFARYDeltaP$Harvest == "Fall",]
modNTFARYDPF<-lmer(DeltaTFARY ~N*P + (1|Rep), data= NTFARYDeltaPF)
anova(modNTFARYDPF)
#check assumptions 
NTFARYDPF_resid<-resid(modNTFARYDPF)
qqnorm(NTFARYDPF_resid)
qqline(NTFARYDPF_resid)
plot(modNTFARYDPF)

max(NTFARYDeltaPF$DeltaTFARY)
min(NTFARYDeltaPF$DeltaTFARY)
#linear plots
NTFARYDeltaPF$predicted <- predict(modNTFARYDPF, newdata = NTFARYDeltaPF, re.form = NA)
ggplot(NTFARYDeltaPF, aes(x = N, y = DeltaTFARY)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Percent Change in Fall Total Forage (Alf) Relative Yield (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between Percent Change in Fall Total Forage (Alf) Relative Yield and N-rate") +  # Add a title
scale_x_discrete(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors
```
#N Alf forage RY change across years (S and F)(with models etc)
```{r, eval=FALSE}
#Alf RY Summer Delta Reframe 
NARYDeltaP <- NARY_long %>%
  group_by(Rep, P, Harvest, N) %>%
  reframe(DeltaARY = ((ARelativeYield[YearCode == 'Y']-ARelativeYield[YearCode == 'X'])/abs(ARelativeYield[YearCode == 'X']))*100)
print(NARYDeltaP)
#Alf RY SummerDelta model
NARYDeltaPS<-NARYDeltaP[NARYDeltaP$Harvest == "Summer",]
modNARYDPS<-lmer(DeltaARY ~N*P + (1|Rep), data= NARYDeltaPS)
anova(modNARYDPS)
#check assumptions 
NARYDPS_resid<-resid(modNARYDPS)
qqnorm(NARYDPS_resid)
qqline(NARYDPS_resid)
plot(modNARYDPS)

max(NARYDeltaPS$DeltaARY)
min(NARYDeltaPS$DeltaARY)
#linear plots
NARYDeltaPS$predicted <- predict(modNARYDPS, newdata = NARYDeltaPS, re.form = NA)
ggplot(NARYDeltaPS, aes(x = N, y = DeltaARY)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Percent Change in Summer Alf forage Relative Yield (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between Percent Change in Summer Alf forage Relative Yield and N-rate") +  # Add a title
scale_x_discrete(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors

#Alf RY Fall Delta model
NARYDeltaPF<-NARYDeltaP[NARYDeltaP$Harvest == "Fall",]
modNARYDPF<-lmer(DeltaARY ~N*P + (1|Rep), data= NARYDeltaPF)
anova(modNARYDPF)
#check assumptions 
NARYDPF_resid<-resid(modNARYDPF)
qqnorm(NARYDPF_resid)
qqline(NARYDPF_resid)
plot(modNARYDPF)

max(NARYDeltaPF$DeltaARY)
min(NARYDeltaPF$DeltaARY)
#linear plots
NARYDeltaPF$predicted <- predict(modNARYDPF, newdata = NARYDeltaPF, re.form = NA)
ggplot(NARYDeltaPF, aes(x = N, y = DeltaARY)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Percent Change in Fall Alf forage Relative Yield (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between Percent Change in Fall Alf forage Relative Yield and N-rate") +  # Add a title
scale_x_discrete(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors
```
#N IWG forage RY change across years (S and F)(with models etc)
```{r, eval=FALSE}
#IWG RY Summer Delta Reframe 
NIRYDeltaP <- NIRY_long %>%
  group_by(Rep, P, Harvest, N) %>%
  reframe(DeltaIRY = ((IRelativeYield[YearCode == 'Y']-IRelativeYield[YearCode == 'X'])/abs(IRelativeYield[YearCode == 'X']))*100)
print(NIRYDeltaP)
#IWG RY SummerDelta model
NIRYDeltaPS<-NIRYDeltaP[NIRYDeltaP$Harvest == "Summer",]
modNIRYDPS<-lmer(DeltaIRY ~N*P + (1|Rep), data= NIRYDeltaPS)
anova(modNIRYDPS)
#check assumptions 
NIRYDPS_resid<-resid(modNIRYDPS)
qqnorm(NIRYDPS_resid)
qqline(NIRYDPS_resid)
plot(modNIRYDPS)

max(NIRYDeltaPS$DeltaIRY)
min(NIRYDeltaPS$DeltaIRY)
#linear plots
NIRYDeltaPS$predicted <- predict(modNIRYDPS, newdata = NIRYDeltaPS, re.form = NA)
ggplot(NIRYDeltaPS, aes(x = N, y = DeltaIRY)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Percent Change in Summer IWG forage Relative Yield (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between Percent Change in Summer IWG forage Relative Yield and N-rate") +  # Add a title
scale_x_discrete(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors

#IWG RY Fall Delta model
NIRYDeltaPF<-NIRYDeltaP[NIRYDeltaP$Harvest == "Fall",]
modNIRYDPF<-lmer(DeltaIRY ~N*P + (1|Rep), data= NIRYDeltaPF)
anova(modNIRYDPF)
#check assumptions 
NIRYDPF_resid<-resid(modNIRYDPF)
qqnorm(NIRYDPF_resid)
qqline(NIRYDPF_resid)
plot(modNIRYDPF)

max(NIRYDeltaPF$DeltaIRY)
min(NIRYDeltaPF$DeltaIRY)
#linear plots
NIRYDeltaPF$predicted <- predict(modNIRYDPF, newdata = NIRYDeltaPF, re.form = NA)
ggplot(NIRYDeltaPF, aes(x = N, y = DeltaIRY)) +
    geom_point() + geom_line(aes(N, exp(predicted)))+ #regression through backtransformed predicted values
  labs(x = "N-Rate (Kg/ha)", y = "Percent Change in Fall IWG forage Relative Yield (Kg/ha)") +  # Label the axes
  ggtitle("Relationship between Percent Change in Fall IWG forage Relative Yield and N-rate") +  # Add a title
scale_x_discrete(breaks = c(0, 40, 80, 120, 160))+ #fix x axis scale
  facet_wrap(~P, scales = "free_y",ncol=2)+ #make it by location (remove to make it across locations)
  scale_color_discrete(name = "Cropping System")  #legend for colors
```

#V Grain changes across years in intercrop (MN taken out because only one year of data thus far) #can't interpret until 2023 dehulled yields are in (Prob don't need if going with PLER based model)
```{r, eval=FALSE}
VnoMN<-V80inter[V80inter$Location != 'MN',]
VnoMNS<-VnoMN[VnoMN$Harvest =="Summer",]
#REMOVE PLOTS a couple of missing grain yields from kansas
#VnoMNS<-VnoMNS[-62,]
#VnoMNS<-VnoMNS[-135,]
#grain reframe as percent
VGDeltaPercent <- VnoMNS %>%
  group_by(Rep, P, Harvest, V) %>%
  reframe(VPercent_of_year_1_yield = ((G[YearCode == 'Y'] - G[YearCode == 'X'])/abs(G[YearCode =='X']))*100)
print(VGDeltaPercent)
#grain delta as % model 
modVGDP<-lmer(VPercent_of_year_1_yield~V*P+ (1|Rep), data=VGDeltaPercent)
anova(modVGDP)
#check assumptions 
VGDP_resid<-resid(modVGDP)
qqnorm(VGDP_resid)
qqline(VGDP_resid)
plot(modVGDP)

min(VGDeltaPercent$VPercent_of_year_1_yield)
max(VGDeltaPercent$VPercent_of_year_1_yield)
#Box Plots
emms <- emmeans(modVGDP, ~ V:P)
cld_data <- cld(emms)
ggplot(VGDeltaPercent, aes(x = V, y = VPercent_of_year_1_yield, fill = P)) +
  geom_boxplot() +
  labs(x = "Variety", y = "Percent Change over time of Grain Yield") +
  ggtitle("Box Plots of Percent Change over time of Grain Yield by Variety and Location") + 
  facet_wrap(~P, scales = "free_y",ncol=2) + 
  ylim(-92,315) +
  geom_text(data = as.data.frame(cld_data), aes(label = .group, x = V, y = 91))+ 
   geom_abline( linetype = "solid", color = "red")

```
#V Grain PLER changes across years #can't interpret until 2023 dehulled yields are in 
```{r, eval=FALSE}
V80GPLER$V<-V80GPLER$Variety
#grain PLER reframe as percent
VGPLERDeltaPercent <- V80GPLER %>%
  group_by(Rep, P, Harvest, V) %>%
  reframe(VPercent_of_year_1_yield = ((PartialLERG[YearCode == 'Y'] - PartialLERG[YearCode == 'X'])/abs(PartialLERG[YearCode =='X']))*100)
print(VGPLERDeltaPercent)
#grain delta as % model 
modVGPLERDP<-lmer(VPercent_of_year_1_yield~V*P+ (1|Rep), data=VGPLERDeltaPercent)
anova(modVGPLERDP)
#check assumptions 
VGPLERDP_resid<-resid(modVGPLERDP)
qqnorm(VGPLERDP_resid)
qqline(VGPLERDP_resid)
plot(modVGPLERDP)

min(VGPLERDeltaPercent$VPercent_of_year_1_yield)
max(VGPLERDeltaPercent$VPercent_of_year_1_yield)
#Box Plots
emms <- emmeans(modVGPLERDP, ~ V:P)
cld_data <- cld(emms)
ggplot(VGPLERDeltaPercent, aes(x = V, y = VPercent_of_year_1_yield, fill = P)) +
  geom_boxplot() +
  labs(x = "Variety", y = "Percent Change over time of Grain PLER") +
  ggtitle("Box Plots of Percent Change over time of Grain PLER by Variety and Location") + 
  facet_wrap(~P, scales = "free_y",ncol=2) + 
  ylim(-73,719) +
  geom_text(data = as.data.frame(cld_data), aes(label = .group, x = V, y = 500))+ 
   geom_abline( linetype = "solid", color = "red")

```
#V Total forage changes across years (summer and fall) (With models etc)
```{r, eval=FALSE}
Vd80noInoMN<-Vd80noI[Vd80noI$Location != "MN",]
#Total Forage Reframe 
VTFDeltaP <- Vd80noInoMN %>%
  group_by(Rep, P, Harvest, V, C) %>%
  reframe(DeltaTFP = ((PlotTotForageKgHa[YearCode == 'Y'] - PlotTotForageKgHa[YearCode == 'X'])/abs(PlotTotForageKgHa[YearCode =='X']))*100)
print(VTFDeltaP)

#Total Forage model Summer as %
VTFDeltaPS<-VTFDeltaP[VTFDeltaP$Harvest == 'Summer',] 
modVTFDPS<-lmer(DeltaTFP~V*P*C + (1|Rep), data= VTFDeltaPS)
anova(modVTFDPS)
#check assumptions 
VTFDPS_resid<-resid(modVTFDPS)
qqnorm(VTFDPS_resid)
qqline(VTFDPS_resid)
plot(modVTFDPS)

min(VTFDeltaPS$DeltaTFP)
max(VTFDeltaPS$DeltaTFP)
#Box Plots
emms <- emmeans(modVTFDPS, ~ V:P)
cld_data <- cld(emms)
ggplot(VTFDeltaPS, aes(x = V, y =DeltaTFP, fill = P)) +
  geom_boxplot() +
  labs(x = "Variety", y = "Percent Change over time of Total Forage Yield") +
  ggtitle("Box Plots of Percent Change over time of Total Forage Yield by Variety and Location") + 
  facet_wrap(~P, scales = "free_y",ncol=2) + 
  ylim(-88, 132) +
  geom_text(data = as.data.frame(cld_data), aes(label = .group, x = V, y =120))+ 
   geom_abline( linetype = "solid", color = "red")

#Total Forage model Fall as %
VTFDeltaPF<-VTFDeltaP[VTFDeltaP$Harvest == 'Fall',] 
modVTFDPF<-lmer(DeltaTFP~V*P*C + (1|Rep), data= VTFDeltaPF)
anova(modVTFDPF)

min(VTFDeltaPF$DeltaTFP)
max(VTFDeltaPF$DeltaTFP)
#Box Plots
emms <- emmeans(modVTFDPF, ~ V:P)
cld_data <- cld(emms)
ggplot(VTFDeltaPF, aes(x = V, y =DeltaTFP, fill = P)) +
  geom_boxplot() +
  labs(x = "Variety", y = "Percent Change over time of Total Forage Yield") +
  ggtitle("Box Plots of Percent Change over time of Total Forage Yield by Variety and Location") + 
  facet_wrap(~P, scales = "free_y",ncol=2) + 
  ylim(-100, 1392) +
  geom_text(data = as.data.frame(cld_data), aes(label = .group, x = V, y = 840))+ 
   geom_abline( linetype = "solid", color = "red")
```
#V IWG yield changes across years in intercrop (summer and fall) (Prob don't need if going with PLER based model) (With models etc)
```{r, eval=FALSE}
#IWG Forage Reframe
VIBDeltaP <- VnoMN %>%
  group_by(Rep, P, Harvest, V) %>%
  reframe(DeltaIBP = ((PlotIWGDryKgHa[YearCode == 'Y'] - PlotIWGDryKgHa[YearCode == 'X'])/abs(PlotIWGDryKgHa[YearCode =='X']))*100)
print(VIBDeltaP)
#IWG Forage model Summer 
VIBDeltaPS<-VIBDeltaP[VIBDeltaP$Harvest == 'Summer',] 
modVIBDPS<-lmer(DeltaIBP~V*P  + (1|Rep), data= VIBDeltaPS)
anova(modVIBDPS)
#check assumptions 
VIBDPS_resid<-resid(modVIBDPS)
qqnorm(VIBDPS_resid)
qqline(VIBDPS_resid)
plot(modVIBDPS)

min(VIBDeltaPS$DeltaIBP)
max(VIBDeltaPS$DeltaIBP)
#Box Plots
emms <- emmeans(modVIBDPS, ~ V:P)
cld_data <- cld(emms)
ggplot(VIBDeltaPS, aes(x = V, y =DeltaIBP, fill = P)) +
  geom_boxplot() +
  labs(x = "Variety", y = "Percent Change over time of IWG Forage Yield") +
  ggtitle("Box Plots of Percent Change over time of IWG Forage Yield by Variety and Location") + 
  facet_wrap(~P, scales = "free_y",ncol=2) + 
  ylim(-91, 181) +
  geom_text(data = as.data.frame(cld_data), aes(label = .group, x = V, y = 170))+ 
   geom_abline( linetype = "solid", color = "red")

#IWG Forage model Fall 
VIBDeltaPF<-VIBDeltaP[VIBDeltaP$Harvest == 'Fall',] 
modVIBDPF<-lmer(DeltaIBP~V*P  + (1|Rep), data= VIBDeltaPF)
anova(modVIBDPF)
#check assumptions 
VIBDPF_resid<-resid(modVIBDPF)
qqnorm(VIBDPF_resid)
qqline(VIBDPF_resid)
plot(modVIBDPF)

min(VIBDeltaPF$DeltaIBP)
max(VIBDeltaPF$DeltaIBP)
#Box Plots
emms <- emmeans(modVIBDPF, ~ V:P)
cld_data <- cld(emms)
ggplot(VIBDeltaPF, aes(x = V, y =DeltaIBP, fill = P)) +
  geom_boxplot() +
  labs(x = "Variety", y = "Percent Change over time of IWG Forage Yield") +
  ggtitle("Box Plots of Percent Change over time of IWG Forage Yield by Variety and Location") + 
  facet_wrap(~P, scales = "free_y",ncol=2) + 
  ylim(-18, 750) +
  geom_text(data = as.data.frame(cld_data), aes(label = .group, x = V, y = 740))+ 
   geom_abline( linetype = "solid", color = "red")
```
#V IWG PLER changes across years (summer and fall) (With models etc)
```{r, eval= FALSE}
#IWG PLER Reframe
VIPLERDeltaP <- V80IPLER %>%
  group_by(Rep, P, Harvest, V) %>%
  reframe(DeltaIPLERBP = ((PartialLERI[YearCode == 'Y'] - PartialLERI[YearCode == 'X'])/abs(PartialLERI[YearCode =='X']))*100)
print(VIPLERDeltaP)
#IWG Forage model Summer
VIPLERDeltaPS<-VIPLERDeltaP[VIPLERDeltaP$Harvest == 'Summer',] 
modVIBDPS<-lmer(DeltaIPLERBP~V*P  + (1|Rep), data= VIPLERDeltaPS)
anova(modVIBDPS)
#check assumptions 
VIBDPS_resid<-resid(modVIBDPS)
qqnorm(VIBDPS_resid)
qqline(VIBDPS_resid)
plot(modVIBDPS)

min(VIPLERDeltaPS$DeltaIPLERBP)
max(VIPLERDeltaPS$DeltaIPLERBP)
#Box Plots
emms <- emmeans(modVIBDPS, ~ V:P)
cld_data <- cld(emms)
ggplot(VIPLERDeltaPS, aes(x = V, y =DeltaIPLERBP, fill = P)) +
  geom_boxplot() +
  labs(x = "Variety", y = "Percent Change over time of IWG PLER") +
  ggtitle("Box Plots of Percent Change over time of IWG PLER by Variety and Location") + 
  facet_wrap(~P, scales = "free_y",ncol=2) + 
  ylim(-64, 700) +
  geom_text(data = as.data.frame(cld_data), aes(label = .group, x = V, y = 500))

#IWG Forage model Fall 
VIPLERDeltaPF<-VIPLERDeltaP[VIPLERDeltaP$Harvest == 'Fall',] 
modVIBDPF<-lmer(DeltaIPLERBP~V*P  + (1|Rep), data= VIPLERDeltaPF)
anova(modVIBDPF)
#check assumptions 
VIBDPF_resid<-resid(modVIBDPF)
qqnorm(VIBDPF_resid)
qqline(VIBDPF_resid)
plot(modVIBDPF)

min(VIPLERDeltaPF$DeltaIPLERBP)
max(VIPLERDeltaPF$DeltaIPLERBP)
#Box Plots
emms <- emmeans(modVIBDPF, ~ V:P)
cld_data <- cld(emms)
ggplot(VIPLERDeltaPF, aes(x = V, y =DeltaIPLERBP, fill = P)) +
  geom_boxplot() +
  labs(x = "Variety", y = "Percent Change over time of IWG Forage Yield") +
  ggtitle("Box Plots of Percent Change over time of IWG Forage Yield by Variety and Location") + 
  facet_wrap(~P, scales = "free_y",ncol=2) + 
  ylim(-87, 885) +
  geom_text(data = as.data.frame(cld_data), aes(label = .group, x = V, y = 740))+ 
   geom_abline( linetype = "solid", color = "red")
```
# V Alf yield changes across years (summer and fall) (With models etc)
```{r, eval=FALSE}
#Alf Forage Reframe 
VABDeltaP<- Vd80noInoMN %>%
  group_by(Rep, P, Harvest, V, C) %>%
  reframe(DeltaABP = ((PlotAlfDryKgHa[YearCode == 'Y'] - PlotAlfDryKgHa[YearCode == 'X'])/abs(PlotAlfDryKgHa[YearCode =='X']))*100)
print(VABDeltaP)
#Alf Forage model Summer 
VABDeltaPS<-VABDeltaP[VABDeltaP$Harvest == 'Summer',] 
modVABDPS<-lmer(DeltaABP~V*P*C  + (1|Rep), data= VABDeltaPS)
anova(modVABDPS)
#check assumptions 
VABDPS_resid<-resid(modVABDPS)
qqnorm(VABDPS_resid)
qqline(VABDPS_resid)
plot(modVABDPS)

min(VABDeltaPS$DeltaABP)
max(VABDeltaPS$DeltaABP)
#Box Plots
emms <- emmeans(modVABDPS, ~ V:P)
cld_data <- cld(emms)
ggplot(VABDeltaPS, aes(x = V, y =DeltaABP, fill = P)) +
  geom_boxplot() +
  labs(x = "Variety", y = "Percent Change over time of Alf Forage Yield") +
  ggtitle("Box Plots of Percent Change over time of Alf Forage Yield by Variety and Location") + 
  facet_wrap(~P, scales = "free_y",ncol=2) + 
  ylim(-96, 170) +
  geom_text(data = as.data.frame(cld_data), aes(label = .group, x = V, y = 92))


#Alf Forage model Fall (IS SINGULAR unless you take away location, but location is ***)
VABDeltaPF<-VABDeltaP[VABDeltaP$Harvest == 'Fall',] 
modVABDPF<-lmer(DeltaABP~V*P*C  + (1|Rep), data= VABDeltaPF)
anova(modVABDPF)
#check assumptions 
VABDPF_resid<-resid(modVABDPF)
qqnorm(VABDPF_resid)
qqline(VABDPF_resid)
plot(modVABDPF)

min(VABDeltaPF$DeltaABP, na.rm = TRUE)
max(VABDeltaPF$DeltaABP, na.rm = TRUE)
#Box Plots
emms <- emmeans(modVABDPF, ~ V:P)
cld_data <- cld(emms)
ggplot(VABDeltaPF, aes(x = V, y =DeltaABP, fill = P)) +
  geom_boxplot() +
  labs(x = "Variety", y = "Percent Change over time of Alf Forage Yield") +
  ggtitle("Box Plots of Percent Change over time of Alf Forage Yield by Variety and Location") + 
  facet_wrap(~P, scales = "free_y",ncol=2) + 
  ylim(-68, 931) +
  geom_text(data = as.data.frame(cld_data), aes(label = .group, x = V, y = 920)) + 
   geom_abline( linetype = "solid", color = "red")
```
#V ALF Forage quality CP changes across years (With models etc)
```{r, eval= FALSE}
#Alf CP Reframe 
VACPDeltaP <- Vd80noInoMN %>%
  group_by(Rep, P, Harvest, V, C) %>%
  reframe(DeltaACPP = ((ALFCP[YearCode == 'Y'] - ALFCP[YearCode == 'X'])/abs(ALFCP[YearCode =='X']))*100)
print(VACPDeltaP)
#Alf Forage model Summer
VACPDeltaPS<-VACPDeltaP[VACPDeltaP$Harvest == 'Summer',] 
modVACPDPS<-lmer(DeltaACPP~V*P*C  + (1|Rep), data= VACPDeltaPS)
anova(modVACPDPS)
#check assumptions 
VACPDPS_resid<-resid(modVACPDPS)
qqnorm(VACPDPS_resid)
qqline(VACPDPS_resid)
plot(modVACPDPS)

min(VACPDeltaPS$DeltaACPP)
max(VACPDeltaPS$DeltaACPP)
#Box Plots
emms <- emmeans(modVACPDPS, ~ V:P)
cld_data <- cld(emms)
ggplot(VACPDeltaPS, aes(x = V, y =DeltaACPP, fill = P)) +
  geom_boxplot() +
  labs(x = "Variety", y = "Percent Change over time of Alf CP") +
  ggtitle("Box Plots of Percent Change over time of Alf CP by Variety and Location") + 
  facet_wrap(~P, scales = "free_y",ncol=2) + 
  ylim(-96, 170) +
  geom_text(data = as.data.frame(cld_data), aes(label = .group, x = V, y = 92))


#Alf Forage model Fall (IS SINGULAR unless you take away location, but location is ***)
VACPDeltaPF<-VACPDeltaP[VACPDeltaP$Harvest == 'Fall',] 
modVACPDPF<-lmer(DeltaACPP~V*P*C  + (1|Rep), data= VACPDeltaPF)
anova(modVACPDPF)
#check assumptions 
VACPDPF_resid<-resid(modVACPDPF)
qqnorm(VACPDPF_resid)
qqline(VACPDPF_resid)
plot(modVACPDPF)

min(VACPDeltaPF$DeltaACPP, na.rm = TRU)
max(VACPDeltaPF$DeltaACPP, na.rm = TRU)
#Box Plots
emms <- emmeans(modVACPDPF, ~ V:P)
cld_data <- cld(emms)
ggplot(VACPDeltaPF, aes(x = V, y =DeltaACPP, fill = P)) +
  geom_boxplot() +
  labs(x = "Variety", y = "Percent Change over time of Alf CP") +
  ggtitle("Box Plots of Percent Change over time of Alf CP by Variety and Location") + 
  facet_wrap(~P, scales = "free_y",ncol=2) + 
  ylim(-68, 931) +
  geom_text(data = as.data.frame(cld_data), aes(label = .group, x = V, y = 920)) + 
   geom_abline( linetype = "solid", color = "red")
```
#V ALF Forage quality RFV changes across years (With models etc)
```{r, eval= FALSE}
#Alf RFV Reframe 
VARFVDeltaP <- Vd80noInoMN %>%
  group_by(Rep, P, Harvest, V, C) %>%
  reframe(DeltaARFVP = ((ALFRFV[YearCode == 'Y'] - ALFRFV[YearCode == 'X'])/abs(ALFRFV[YearCode =='X']))*100)
print(VARFVDeltaP)
#Alf Forage model Summer 
VARFVDeltaPS<-VARFVDeltaP[VARFVDeltaP$Harvest == 'Summer',] 
modVARFVDPS<-lmer(DeltaARFVP~V*P*C  + (1|Rep), data= VARFVDeltaPS)
anova(modVARFVDPS)
#check assumptions 
VARFVDPS_resid<-resid(modVARFVDPS)
qqnorm(VARFVDPS_resid)
qqline(VARFVDPS_resid)
plot(modVARFVDPS)

min(VARFVDeltaPS$DeltaARFVP)
max(VARFVDeltaPS$DeltaARFVP)
#Box Plots
emms <- emmeans(modVARFVDPS, ~ V:P)
cld_data <- cld(emms)
ggplot(VARFVDeltaPS, aes(x = V, y =DeltaARFVP, fill = P)) +
  geom_boxplot() +
  labs(x = "Variety", y = "Percent Change over time of Alf RFV") +
  ggtitle("Box Plots of Percent Change over time of Alf RFV by Variety and Location") + 
  facet_wrap(~P, scales = "free_y",ncol=2) + 
  ylim(-96, 170) +
  geom_text(data = as.data.frame(cld_data), aes(label = .group, x = V, y = 92))


#Alf Forage model Fall (IS SINGULAR unless you take away location, but location is ***)
VARFVDeltaPF<-VARFVDeltaP[VARFVDeltaP$Harvest == 'Fall',] 
modVARFVDPF<-lmer(DeltaARFVP~V*P*C  + (1|Rep), data= VARFVDeltaPF)
anova(modVARFVDPF)
#check assumptions 
VARFVDPF_resid<-resid(modVARFVDPF)
qqnorm(VARFVDPF_resid)
qqline(VARFVDPF_resid)
plot(modVARFVDPF)

min(VARFVDeltaPF$DeltaARFVP, na.rm = TRU)
max(VARFVDeltaPF$DeltaARFVP, na.rm = TRU)
#Box Plots
emms <- emmeans(modVARFVDPF, ~ V:P)
cld_data <- cld(emms)
ggplot(VARFVDeltaPF, aes(x = V, y =DeltaARFVP, fill = P)) +
  geom_boxplot() +
  labs(x = "Variety", y = "Percent Change over time of Alf RFV") +
  ggtitle("Box Plots of Percent Change over time of Alf RFV by Variety and Location") + 
  facet_wrap(~P, scales = "free_y",ncol=2) + 
  ylim(-68, 931) +
  geom_text(data = as.data.frame(cld_data), aes(label = .group, x = V, y = 920)) + 
   geom_abline( linetype = "solid", color = "red")
```
#V IWG Forage quality CP changes across years (With models etc)
```{r, eval= FALSE}
#IWG CP Reframe 
VICPDeltaP <- V80inter %>%
  group_by(Rep, P, Harvest, V) %>%
  reframe(DeltaICPP = ((IWGCP[YearCode == 'Y'] - IWGCP[YearCode == 'X'])/abs(IWGCP[YearCode =='X']))*100)
print(VICPDeltaP)
#IWG Forage qual model Summer (IS SINGULAR unless you take away location, but location is ***)
VICPDeltaPS<-VICPDeltaP[VICPDeltaP$Harvest == 'Summer',] 
modVICPDPS<-lmer(DeltaICPP~V*P  + (1|Rep), data= VICPDeltaPS)
anova(modVICPDPS)
#check assumptions 
VICPDPS_resid<-resid(modVICPDPS)
qqnorm(VICPDPS_resid)
qqline(VICPDPS_resid)
plot(modVICPDPS)

min(VICPDeltaPS$DeltaICPP)
max(VICPDeltaPS$DeltaICPP)
#Box Plots
emms <- emmeans(modVICPDPS, ~ V:P)
cld_data <- cld(emms)
ggplot(VICPDeltaPS, aes(x = V, y =DeltaICPP, fill = P)) +
  geom_boxplot() +
  labs(x = "Variety", y = "Percent Change over time of IWG CP") +
  ggtitle("Box Plots of Percent Change over time of IWG CP by Variety and Location") + 
  facet_wrap(~P, scales = "free_y",ncol=2) + 
  ylim(-96, 170) +
  geom_text(data = as.data.frame(cld_data), aes(label = .group, x = V, y = 92))


#IWG Forage qual model Fall
VICPDeltaPF<-VICPDeltaP[VICPDeltaP$Harvest == 'Fall',] 
modVICPDPF<-lmer(DeltaICPP~V*P  + (1|Rep), data= VICPDeltaPF)
anova(modVICPDPF)
#check assumptions 
VICPDPF_resid<-resid(modVICPDPF)
qqnorm(VICPDPF_resid)
qqline(VICPDPF_resid)
plot(modVICPDPF)

min(VICPDeltaPF$DeltaICPP, na.rm = TRU)
max(VICPDeltaPF$DeltaICPP, na.rm = TRU)
#Box Plots
emms <- emmeans(modVICPDPF, ~ V:P)
cld_data <- cld(emms)
ggplot(VICPDeltaPF, aes(x = V, y =DeltaICPP, fill = P)) +
  geom_boxplot() +
  labs(x = "Variety", y = "Percent Change over time of IWG CP") +
  ggtitle("Box Plots of Percent Change over time of IWG CP by Variety and Location") + 
  facet_wrap(~P, scales = "free_y",ncol=2) + 
  ylim(-68, 931) +
  geom_text(data = as.data.frame(cld_data), aes(label = .group, x = V, y = 920)) + 
   geom_abline( linetype = "solid", color = "red")
```
#V IWG Forage quality RFV changes across years (With models etc)
```{r, eval= FALSE}
#IWG RFV Reframe 
VIRFVDeltaP <- V80inter %>%
  group_by(Rep, P, Harvest, V) %>%
  reframe(DeltaIRFVP = ((IWGRFV[YearCode == 'Y'] - IWGRFV[YearCode == 'X'])/abs(IWGRFV[YearCode =='X']))*100)
print(VIRFVDeltaP)
#IWG Forage qual model Summer (IS SINGULAR unless you take away location, but location is ***)
VIRFVDeltaPS<-VIRFVDeltaP[VIRFVDeltaP$Harvest == 'Summer',] 
modVIRFVDPS<-lmer(DeltaIRFVP~V*P  + (1|Rep), data= VIRFVDeltaPS)
anova(modVIRFVDPS)
#check assumptions 
VIRFVDPS_resid<-resid(modVIRFVDPS)
qqnorm(VIRFVDPS_resid)
qqline(VIRFVDPS_resid)
plot(modVIRFVDPS)

min(VIRFVDeltaPS$DeltaIRFVP)
max(VIRFVDeltaPS$DeltaIRFVP)
#Box Plots
emms <- emmeans(modVIRFVDPS, ~ V:P)
cld_data <- cld(emms)
ggplot(VIRFVDeltaPS, aes(x = V, y =DeltaIRFVP, fill = P)) +
  geom_boxplot() +
  labs(x = "Variety", y = "Percent Change over time of IWG RFV") +
  ggtitle("Box Plots of Percent Change over time of IWG RFV by Variety and Location") + 
  facet_wrap(~P, scales = "free_y",ncol=2) + 
  ylim(-96, 170) +
  geom_text(data = as.data.frame(cld_data), aes(label = .group, x = V, y = 92))


#IWG Forage qual model Fall 
VIRFVDeltaPF<-VIRFVDeltaP[VIRFVDeltaP$Harvest == 'Fall',] 
modVIRFVDPF<-lmer(DeltaIRFVP~V*P  + (1|Rep), data= VIRFVDeltaPF)
anova(modVIRFVDPF)
#check assumptions 
VIRFVDPF_resid<-resid(modVIRFVDPF)
qqnorm(VIRFVDPF_resid)
qqline(VIRFVDPF_resid)
plot(modVIRFVDPF)

min(VIRFVDeltaPF$DeltaIRFVP, na.rm = TRU)
max(VIRFVDeltaPF$DeltaIRFVP, na.rm = TRU)
#Box Plots
emms <- emmeans(modVIRFVDPF, ~ V:P)
cld_data <- cld(emms)
ggplot(VIRFVDeltaPF, aes(x = V, y =DeltaIRFVP, fill = P)) +
  geom_boxplot() +
  labs(x = "Variety", y = "Percent Change over time of IWG RFV") +
  ggtitle("Box Plots of Percent Change over time of IWG RFV by Variety and Location") + 
  facet_wrap(~P, scales = "free_y",ncol=2) + 
  ylim(-68, 931) +
  geom_text(data = as.data.frame(cld_data), aes(label = .group, x = V, y = 920)) + 
   geom_abline( linetype = "solid", color = "red")
```

#nrate anova tables
```{r, eval= FALSE}
gt_XS
gt_XF
gt_YS
gt_YF
gt_DeltaS
gt_DeltaF
```

#variety anova tables 
```{r, eval=FALSE}
gt_tableVXS
gt_tableVYS
gt_tableVXF
gt_tableVYF
gt_VDeltaS
gt_VDeltaF
```

#bigger pairwise tables if you want it back 
```{r, eval=FALSE}
#Pairwise N
N_levels <- c(0, 40, 80, 120, 160)
emmsNYST <- emmeans(modNYST1, specs = ~ N, at = list(N = N_levels), type = "response")
cld_dataNYSTN <- cld(emmsNYST, Letters=custom_letters) # Create compact letter display
cld_dataNYSTN<- cld_dataNYSTN %>%
  select( N, response, lower.CL, upper.CL, .group)
colnames(cld_dataNYSTN) <- c("N", "Total Forage (kg ha-1)", "CI 2.5%", "CI 97.5%", "Group")
cld_dataNYSTN  |> 
  data.frame() |> 
  kbl(align = "c") |> 
  kable_paper(full_width = F) |> 
  column_spec(1, bold = T)|> 
  collapse_rows(columns = 1:5, valign = "top")

print(cld_dataNYSTN, digits =5)
```

